/*!
betajs - v1.0.0 - 2015-01-14
Copyright (c) Oliver Friedmann,Victor Lingenthal
MIT Software License.
*/
var BetaJS=BetaJS||{};"undefined"!=typeof module&&"exports"in module&&(module.exports=BetaJS),BetaJS.Types={is_object:function(a){return"object"==typeof a},is_array:function(a){return"[object Array]"===Object.prototype.toString.call(a)},is_undefined:function(a){return"undefined"==typeof a},is_null:function(a){return null===a},is_none:function(a){return this.is_undefined(a)||this.is_null(a)},is_defined:function(a){return"undefined"!=typeof a},is_empty:function(a){if(this.is_none(a))return!0;if(this.is_array(a))return 0===a.length;if(this.is_object(a)){for(var b in a)return!1;return!0}return!1},is_string:function(a){return"string"==typeof a},is_function:function(a){return"function"==typeof a},is_boolean:function(a){return"boolean"==typeof a},compare:function(a,b){if(BetaJS.Types.is_boolean(a)&&BetaJS.Types.is_boolean(b))return a==b?0:a?1:-1;if(BetaJS.Types.is_array(a)&&BetaJS.Types.is_array(b)){for(var c=a.length,d=b.length,e=Math.min(c,d),f=0;e>f;++f){var g=this.compare(a[f],b[f]);if(0!==g)return g}return c==d?0:c>d?1:-1}return a.localeCompare(b)},parseBool:function(a){return this.is_boolean(a)?a:"true"==a?!0:"false"==a?!1:null},type_of:function(a){return this.is_array(a)?"array":typeof a},parseType:function(a,b){return BetaJS.Types.is_string(a)?(b=b.toLowerCase(),"bool"==b||"boolean"==b?this.parseBool(a):"int"==b||"integer"==b?parseInt(a,10):"date"==b||"time"==b||"datetime"==b?parseInt(a,10):a):a}},BetaJS.Strings={nl2br:function(a){return(a+"").replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,"$1<br />$2")},htmlentities:function(a){return(a+"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;")},JS_ESCAPES:{"'":"'","\\":"\\","\r":"r","\n":"n","	":"t","\u2028":"u2028","\u2029":"u2029"},JS_ESCAPER_REGEX:function(){return this.JS_ESCAPER_REGEX_CACHED||(this.JS_ESCAPER_REGEX_CACHED=new RegExp(BetaJS.Objs.keys(this.JS_ESCAPES).join("|"),"g")),this.JS_ESCAPER_REGEX_CACHED},js_escape:function(a){var b=this;return a.replace(this.JS_ESCAPER_REGEX(),function(a){return"\\"+b.JS_ESCAPES[a]})},starts_with:function(a,b){return a.substring(0,b.length)==b},ends_with:function(a,b){return-1!==a.indexOf(b,a.length-b.length)},strip_start:function(a,b){return this.starts_with(a,b)?a.substring(b.length):a},last_after:function(a,b){return a.substring(a.lastIndexOf(b)+b.length,a.length)},first_after:function(a,b){return a.substring(a.indexOf(b)+1,a.length)},EMAIL_ADDRESS_REGEX:/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/,is_email_address:function(a){return this.EMAIL_ADDRESS_REGEX.test(a)},STRIP_HTML_TAGS:["script","style","head"],STRIP_HTML_REGEX:/<\/?([a-z][a-z0-9]*)\b[^>]*>?/gi,STRIP_HTML_COMMENT_REGEX:/<![^>]*>/gi,strip_html:function(a){var b=a;for(i=0;i<this.STRIP_HTML_TAGS.length;++i)b=b.replace(new RegExp("<"+this.STRIP_HTML_TAGS[i]+".*</"+this.STRIP_HTML_TAGS[i]+">","i"),"");return b=b.replace(this.STRIP_HTML_REGEX,"").replace(this.STRIP_HTML_COMMENT_REGEX,"")},nltrim:function(a){var b=a.replace(/\t/g,"  ").split("\n"),c=null,d=0;for(d=0;d<b.length;++d){for(var e=0;e<b[d].length&&" "==b[d].charAt(e);)++e;e<b[d].length&&(c=null===c?e:Math.min(e,c))}for(d=0;d<b.length;++d)b[d]=b[d].substring(c);return b.join("\n").trim()},read_cookie_string:function(a,b){var c="; "+a,d=c.split("; "+b+"=");return 2==d.length?d.pop().split(";").shift():null},write_cookie_string:function(a,b,c){var d="; "+a,e=d.split("; "+b+"=");return 2==e.length&&(d=e[0]+e[1].substring(e[1].indexOf(";"))),b+"="+c+d},capitalize:function(a){return a.replace(/\w\S*/g,function(a){return a.charAt(0).toUpperCase()+a.substr(1).toLowerCase()})},email_get_name:function(a){a=a||"";var b=a.split("<");return a=b[0].trim(),!a&&b.length>1&&(b=b[1].split(">"),a=b[0].trim()),a=a.replace(/['"]/g,"").replace(/[\\._@]/g," "),this.capitalize(a)},email_get_email:function(a){a=a||"";var b=a.split("<");return a=b[0].trim(),b.length>1&&(b=b[1].split(">"),a=b[0].trim()),a=a.replace(/'/g,"").replace(/"/g,"").trim()},email_get_salutatory_name:function(a){return a=a||"",this.email_get_name(a).split(" ")[0]}},BetaJS.Functions={as_method:function(a,b){return function(){return a.apply(b,arguments)}},once:function(a){var b=!1,c=!1;return function(){return c?b:(c=!0,b=a.apply(this,arguments),a=null,b)}},getArguments:function(a,b){return Array.prototype.slice.call(a,b||0)},matchArgs:function(a,b,c){arguments.length<3&&(c=b,b=0);var d=b,e={};for(var f in c){var g=c[f];g===!0?g={required:!0}:"string"==typeof g&&(g={type:g}),g.required||g.type&&BetaJS.Types.type_of(a[d])==g.type?(e[f]=a[d],d++):g.def&&(e[f]=BetaJS.Types.is_function(g.def)?g.def(e):g.def)}return e},newClassFunc:function(a){return function(){function b(){return a.apply(this,c)}var c=arguments;return b.prototype=a.prototype,new b}},newClass:function(a){return this.newClassFunc(a).apply(this,BetaJS.Functions.getArguments(arguments,1))}},BetaJS.Async={eventually:function(a,b,c){var d=setTimeout(function(){clearTimeout(d),BetaJS.Types.is_array(b)||(c=b,b=[]),a.apply(c||this,b||[])},0)},eventuallyOnce:function(a,b,c){var d={func:a,params:b,context:c};for(var e in this.__eventuallyOnce)if(BetaJS.Comparators.listEqual(this.__eventuallyOnce[e],d))return;this.__eventuallyOnceIdx++;var f=this.__eventuallyOnceIdx;this.__eventuallyOnce[f]=d,this.eventually(function(){delete this.__eventuallyOnce[f],a.apply(c||this,b||[])},this)},__eventuallyOnce:{},__eventuallyOnceIdx:1},BetaJS.Scopes={base:function(a,b,c){if(!BetaJS.Types.is_string(a))return a;if(b)return b[a];try{if(window&&window[a])return window[a]}catch(d){}try{if(global&&global[a])return global[a]}catch(d){}try{if(module&&module.exports)return module.exports}catch(d){}if(!c)return null;try{if(window)return window[a]={},window[a]}catch(d){}try{if(global)return global[a]={},global[a]}catch(d){}try{if(module&&module.exports)return module.exports={},module.exports}catch(d){}return null},resolve:function(a,b){if(!BetaJS.Types.is_string(a))return a;for(var c=a.split("."),d=this.base(c[0],b),e=1;e<c.length;++e)d=d[c[e]];return d},touch:function(a,b){if(!BetaJS.Types.is_string(a))return a;for(var c=a.split("."),d=this.base(c[0],b,!0),e=1;e<c.length;++e)c[e]in d||(d[c[e]]={}),d=d[c[e]];return d},set:function(a,b,c){if(!BetaJS.Types.is_string(b))return b;for(var d=b.split("."),e=this.base(d[0],c,!0),f=1;f<d.length-1;++f)d[f]in e||(e[d[f]]={}),e=e[d[f]];return d.length>1&&(e[d[d.length-1]]=a),a}},BetaJS.Ids={__uniqueId:0,uniqueId:function(a){return(a||"")+this.__uniqueId++},objectId:function(a,b){return"undefined"!=typeof b?a.__cid=b:a.__cid||(a.__cid=this.uniqueId("cid_")),a.__cid}},BetaJS.Tokens={generate_token:function(a){a=a||16;for(var b="";b.length<a;)b+=Math.random().toString(36).substr(2);return b.substr(0,a)}},BetaJS.Objs={count:function(a){if(BetaJS.Types.is_array(a))return a.length;var b=0;for(var c in a)b++;return b},clone:function(a,b){return b&&0!==b?BetaJS.Types.is_array(a)?a.slice(0):BetaJS.Types.is_object(a)?this.extend({},a,b-1):a:a},acyclic_clone:function(a,b){if(null===a||!BetaJS.Types.is_object(a))return a;var c="__acyclic_cloned";if(a[c])return b||"CYCLE";a[c]=!0;var d={};for(var e in a)e!=c&&(d[e]=this.acyclic_clone(a[e],b));return delete a[c],d},extend:function(a,b,c){if(a=a||{},b)for(var d in b)a[d]=this.clone(b[d],c);return a},tree_extend:function(a,b,c){if(a=a||{},b)for(var d in b)a[d]=d in a&&BetaJS.Types.is_object(a[d])&&BetaJS.Types.is_object(b[d])?this.tree_extend(a[d],b[d],c):this.clone(b[d],c);return a},merge:function(a,b,c){a=a||{},b=b||{};var d={},e=BetaJS.Objs.extend(BetaJS.Objs.keys(a,!0),BetaJS.Objs.keys(b,!0));for(var f in e){var g=f in c?c[f]:"primary";"primary"==g||"secondary"==g?(f in b||f in a)&&(d[f]="primary"==g?f in b?b[f]:a[f]:f in a?a[f]:b[f]):BetaJS.Types.is_function(g)?d[f]=g(a[f],b[f]):BetaJS.Types.is_object(g)&&(d[f]=BetaJS.Objs.merge(a[f],b[f],g))}return d},tree_merge:function(a,b){a=a||{},b=b||{};var c={},d=BetaJS.Objs.extend(BetaJS.Objs.keys(a,!0),BetaJS.Objs.keys(b,!0));for(var e in d)c[e]=BetaJS.Types.is_object(b[e])&&a[e]?BetaJS.Objs.tree_merge(a[e],b[e]):e in b?b[e]:a[e];return c},keys:function(a,b){var c=null,d=null;if(BetaJS.Types.is_undefined(b)){c=[];for(d in a)c.push(d);return c}c={};for(d in a)c[d]=b;return c},map:function(a,b,c){var d=null;if(BetaJS.Types.is_array(a)){d=[];for(var e=0;e<a.length;++e)d.push(c?b.apply(c,[a[e],e]):b(a[e],e));return d}d={};for(var f in a)d[f]=c?b.apply(c,[a[f],f]):b(a[f],f);return d},values:function(a){var b=[];for(var c in a)b.push(a[c]);return b},filter:function(a,b,c){var d=null;if(BetaJS.Types.is_array(a)){d=[];for(var e=0;e<a.length;++e)(c?b.apply(c,[a[e],e]):b(a[e],e))&&d.push(a[e]);return d}d={};for(var f in a)(c?b.apply(c,[a[f],f]):b(a[f],f))&&(d[f]=a[f]);return d},equals:function(a,b,c){var d=null;if(c&&c>0){for(d in a)if(!d in b||!this.equals(a[d],b[d],c-1))return!1;for(d in b)if(!d in a)return!1;return!0}return a==b},iter:function(a,b,c){var d=null;if(BetaJS.Types.is_array(a)){for(var e=0;e<a.length;++e)if(d=c?b.apply(c,[a[e],e]):b(a[e],e),BetaJS.Types.is_defined(d)&&!d)return!1}else for(var f in a)if(d=c?b.apply(c,[a[f],f]):b(a[f],f),BetaJS.Types.is_defined(d)&&!d)return!1;return!0},intersect:function(a,b){var c={};for(var d in a)d in b&&(c[d]=a[d]);return c},contains_key:function(a,b){return BetaJS.Types.is_array(a)?BetaJS.Types.is_defined(a[b]):b in a},contains_value:function(a,b){if(BetaJS.Types.is_array(a)){for(var c=0;c<a.length;++c)if(a[c]===b)return!0}else for(var d in a)if(a[d]===b)return!0;return!1},exists:function(a,b,c){var d=!1;return BetaJS.Objs.iter(a,function(){return d=d||b.apply(this,arguments),!d},c),d},all:function(a,b,c){var d=!0;return BetaJS.Objs.iter(a,function(){return d=d&&b.apply(this,arguments)},c),d},objectify:function(a,b,c){var d={},e=BetaJS.Types.is_function(b);BetaJS.Types.is_undefined(b)&&(b=!0);for(var f=0;f<a.length;++f)d[a[f]]=e?b.apply(c||this,[a[f],f]):b;return d},peek:function(a){if(BetaJS.Types.is_array(a))return a.length>0?a[0]:null;for(var b in a)return a[b];return null},poll:function(a){if(BetaJS.Types.is_array(a))return a.shift();for(var b in a){var c=a[b];return delete a[b],c}return null},objectBy:function(){for(var a={},b=arguments.length/2,c=0;b>c;++c)a[arguments[2*c]]=arguments[2*c+1];return a},valueByIndex:function(a,b){if(b=b||0,BetaJS.Types.is_array(a))return a[b];for(var c in a){if(0===b)return a[c];b--}return null},keyByIndex:function(a,b){if(b=b||0,BetaJS.Types.is_array(a))return b;for(var c in a){if(0===b)return c;b--}return null},pairArrayToObject:function(a){for(var b={},c=0;c<a.length/2;c+=2)b[a[c]]=a[c+1];return b},pairsToObject:function(){for(var a={},b=0;b<arguments.length;++b)a[arguments[b][0]]=arguments[b][1];return a}},BetaJS.Class=function(){},BetaJS.Class.classname="Class",BetaJS.Class.extend=function(a,b,c,d){b=b||[],BetaJS.Types.is_array(b)||(b=[b]),c=c||[],BetaJS.Types.is_array(c)||(c=[c]),d=d||[],BetaJS.Types.is_array(d)||(d=[d]);var e,f=this;BetaJS.Objs.iter(b,function(a){a.hasOwnProperty("constructor")&&(e=a.constructor)});var g=BetaJS.Types.is_defined(e);BetaJS.Types.is_defined(e)||(e=function(){f.apply(this,arguments)}),BetaJS.Objs.extend(e,f),BetaJS.Objs.iter(c,function(a){BetaJS.Objs.extend(e,a)});var h={};if(f.__class_statics_keys)for(var i in f.__class_statics_keys)e[i]=BetaJS.Objs.clone(f[i],1);BetaJS.Objs.iter(d,function(a){BetaJS.Objs.extend(e,a),BetaJS.Objs.extend(h,BetaJS.Objs.keys(a,!0))}),f.__class_statics_keys&&BetaJS.Objs.extend(h,f.__class_statics_keys),e.__class_statics_keys=h,e.parent=f,e.children=[],e.extend=this.extend,f.children||(f.children=[]),f.children.push(e);var j=function(){};return j.prototype=f.prototype,e.prototype=new j,e.prototype.cls=e,e.classname=a,a&&BetaJS.Scopes.set(e,a),e.__notifications={},f.__notifications&&BetaJS.Objs.extend(e.__notifications,f.__notifications,1),BetaJS.Objs.iter(b,function(a){if(BetaJS.Objs.extend(e.prototype,a),"constructor"in a&&(e.prototype.constructor=a.constructor),a._notifications)for(var b in a._notifications)e.__notifications[b]||(e.__notifications[b]=[]),e.__notifications[b].push(a._notifications[b])}),delete e.prototype._notifications,g||(e.prototype.constructor=f.prototype.constructor),e},BetaJS.Class.prototype.constructor=function(){this._notify("construct")},BetaJS.Class.prototype.as_method=function(a){return BetaJS.Functions.as_method(this[a],this)},BetaJS.Class.prototype._auto_destroy=function(a){this.__auto_destroy_list||(this.__auto_destroy_list=[]);var b=a;BetaJS.Types.is_array(b)||(b=[b]);for(var c=0;c<b.length;++c)this.__auto_destroy_list.push(b[c]);return a},BetaJS.Class.prototype._notify=function(a){if(this.cls.__notifications){var b=Array.prototype.slice.call(arguments,1),c=this.cls.__notifications[a];if(c)for(var d in c){var e=BetaJS.Types.is_function(c[d])?c[d]:this[c[d]];if(!e)throw this.cls.classname+": Could not find "+a+" notification handler "+c[d];e.apply(this,b)}}},BetaJS.Class.prototype.destroy=function(){if(this._notify("destroy"),this.__auto_destroy_list)for(var a=0;a<this.__auto_destroy_list.length;++a)"destroy"in this.__auto_destroy_list[a]&&this.__auto_destroy_list[a].destroy();for(var b in this)delete this[b]},BetaJS.Class.prototype._inherited=function(a,b){return a.parent.prototype[b].apply(this,Array.prototype.slice.apply(arguments,[2]))},BetaJS.Class._inherited=function(a,b){return a.parent[b].apply(this,Array.prototype.slice.apply(arguments,[2]))},BetaJS.Class.prototype.instance_of=function(a){return this.cls.ancestor_of(a)},BetaJS.Class.prototype.__clsguid="e6b0ed30-80ee-4b28-af02-7d52430ba45f",BetaJS.Class.ancestor_of=function(a){return this==a||this!=BetaJS.Class&&this.parent.ancestor_of(a)},BetaJS.Class.is_instance_of=function(a){return a&&a.__clsguid==BetaJS.Class.prototype.__clsguid&&a.instance_of(this)},BetaJS.Class.prototype.cid=function(){return BetaJS.Ids.objectId(this)},BetaJS.Class.prototype.cls=BetaJS.Class,BetaJS.Class.__notifications={},BetaJS.Class.is_class_instance=function(a){return a&&BetaJS.Types.is_object(a)&&"_inherited"in a&&"cls"in a},BetaJS.Exceptions={ensure:function(a){return a&&BetaJS.Types.is_object(a)&&"instance_of"in a&&a.instance_of(BetaJS.Exceptions.Exception)?a:new BetaJS.Exceptions.NativeException(a)}},BetaJS.Class.extend("BetaJS.Exceptions.Exception",{constructor:function(a){this._inherited(BetaJS.Exceptions.Exception,"constructor"),this.__message=a},assert:function(a){if(!this.instance_of(a))throw this;return this},callstack:function(){for(var a=[],b=arguments.callee.caller;b;)a.push(b.toString()),b=b.caller;return a},callstack_to_string:function(){return this.callstack().join("\n")},message:function(){return this.__message},toString:function(){return this.message()},format:function(){return this.cls.classname+": "+this.toString()+"\n\nCall Stack:\n"+this.callstack_to_string()},json:function(){return{classname:this.cls.classname,message:this.message()}}},{ensure:function(a){return a=BetaJS.Exceptions.ensure(a),a.assert(this),a}}),BetaJS.Exceptions.Exception.extend("BetaJS.Exceptions.NativeException",{constructor:function(a){this._inherited(BetaJS.Exceptions.NativeException,"constructor",a?"toString"in a?a.toString():a:"null"),this.__object=a},object:function(){return this.__object}}),BetaJS.Class.extend("BetaJS.Lists.AbstractList",{_add:function(){},_remove:function(){},_get:function(){},_iterate:function(){},get_ident:function(a){var b=null;return this._iterate(function(c,d){return c==a?(b=d,!1):!0}),b},exists:function(a){return a&&null!==this.get_ident(a)},_ident_changed:function(){},constructor:function(a){this._inherited(BetaJS.Lists.AbstractList,"constructor"),this.__count=0,a&&BetaJS.Objs.iter(a,function(a){this.add(a)},this)},add:function(a){var b=this._add(a);return BetaJS.Types.is_defined(b)&&this.__count++,b},count:function(){return this.__count},clear:function(){this._iterate(function(a,b){return this.remove_by_ident(b),!0},this)},remove_by_ident:function(a){var b=this._remove(a);return BetaJS.Types.is_defined(b)&&this.__count--,b},remove:function(a){return this.remove_by_ident(this.get_ident(a))},remove_by_filter:function(a){this._iterate(function(b,c){return a(b)&&this.remove_by_ident(c),!0},this)},get:function(a){return this._get(a)},iterate:function(a,b){this._iterate(function(b,c){var d=a.apply(this,[b,c]);return BetaJS.Types.is_defined(d)?d:!0},b)},iterator:function(){return BetaJS.Iterators.ArrayIterator.byIterate(this.iterate,this)}}),BetaJS.Lists.AbstractList.extend("BetaJS.Lists.LinkedList",{constructor:function(a){this.__first=null,this.__last=null,this._inherited(BetaJS.Lists.LinkedList,"constructor",a)},_add:function(a){return this.__last={obj:a,prev:this.__last,next:null},this.__first?this.__last.prev.next=this.__last:this.__first=this.__last,this.__last},_remove:function(a){return a.next?a.next.prev=a.prev:this.__last=a.prev,a.prev?a.prev.next=a.next:this.__first=a.next,a.obj},_get:function(a){return a.obj},_iterate:function(a,b){for(var c=this.__first;c;){var d=c;if(c=c.next,!a.apply(b||this,[d.obj,d]))return}}}),BetaJS.Lists.AbstractList.extend("BetaJS.Lists.ObjectIdList",{constructor:function(a,b){this.__map={},this.__id_generator=b,this._inherited(BetaJS.Lists.ObjectIdList,"constructor",a)},_add:function(a){for(;;){var b=a.__cid;if(b||(b=this.__id_generator?BetaJS.Ids.objectId(a,this.__id_generator()):BetaJS.Ids.objectId(a),!this.__map[b]||!this.__id_generator))return this.__map[b]=a,b}return null},_remove:function(a){var b=this.__map[a];return delete this.__map[a],b},_get:function(a){return this.__map[a]},_iterate:function(a,b){for(var c in this.__map)a.apply(b||this,[this.__map[c],c])},get_ident:function(a){var b=BetaJS.Ids.objectId(a);return this.__map[b]?b:null}}),BetaJS.Lists.AbstractList.extend("BetaJS.Lists.ArrayList",{constructor:function(a,b){this.__idToIndex={},this.__items=[],b=b||{},"compare"in b&&(this._compare=b.compare),"get_ident"in b&&(this._get_ident=b.get_ident),this._inherited(BetaJS.Lists.ArrayList,"constructor",a)},set_compare:function(a){this._compare=a,a&&this.sort()},get_compare:function(){return this._compare},sort:function(a){if(a=a||this._compare){this.__items.sort(a);for(var b=0;b<this.__items.length;++b)this.__ident_changed(this.__items[b],b);this._sorted()}},_sorted:function(){},re_index:function(a){if(!this._compare)return a;for(var b=this.__items.length-1,c=this.__items[a],d=a;b>d&&this._compare(this.__items[d],this.__items[d+1])>0;)this.__items[d]=this.__items[d+1],this.__ident_changed(this.__items[d],d),this.__items[d+1]=c,++d;if(d==a)for(;d>0&&this._compare(this.__items[d],this.__items[d-1])<0;)this.__items[d]=this.__items[d-1],this.__ident_changed(this.__items[d],d),this.__items[d-1]=c,--d;return d!=a&&(this.__ident_changed(c,d),this._re_indexed(c)),d},_re_indexed:function(){},__objectId:function(a){return this._get_ident?this._get_ident(a):BetaJS.Ids.objectId(a)},_add:function(a){var b=this.__items.length;this.__items.push(a);var c=this.re_index(b);return this.__idToIndex[this.__objectId(a)]=c,c},_remove:function(a){for(var b=this.__items[a],c=a+1;c<this.__items.length;++c)this.__items[c-1]=this.__items[c],this.__ident_changed(this.__items[c-1],c-1);return this.__items.pop(),delete this.__idToIndex[this.__objectId(b)],b},_get:function(a){return this.__items[a]},_iterate:function(a,b){for(var c=BetaJS.Objs.clone(this.__items,1),d=0;d<c.length;++d)a.apply(b||this,[c[d],this.get_ident(c[d])])},__ident_changed:function(a,b){this.__idToIndex[this.__objectId(a)]=b,this._ident_changed(a,b)},get_ident:function(a){var b=this.__objectId(a);return b in this.__idToIndex?this.__idToIndex[b]:null},ident_by_id:function(a){return this.__idToIndex[a]}}),BetaJS.Iterators={ensure:function(a){return null===a?new BetaJS.Iterators.ArrayIterator([]):a.instance_of(BetaJS.Iterators.Iterator)?a:new BetaJS.Iterators.ArrayIterator(BetaJS.Types.is_array(a)?a:[a])}},BetaJS.Class.extend("BetaJS.Iterators.Iterator",{asArray:function(){for(var a=[];this.hasNext();)a.push(this.next());return a},asArrayDelegate:function(a){for(var b=[];this.hasNext();){var c=this.next();b.push(c[a].apply(c,BetaJS.Functions.getArguments(arguments,1)))}return b},iterate:function(a,b){for(;this.hasNext();)a.call(b||this,this.next())}}),BetaJS.Iterators.Iterator.extend("BetaJS.Iterators.ArrayIterator",{constructor:function(a){this._inherited(BetaJS.Iterators.ArrayIterator,"constructor"),this.__array=a,this.__i=0},hasNext:function(){return this.__i<this.__array.length},next:function(){var a=this.__array[this.__i];return this.__i++,a}},{byIterate:function(a,b){var c=[];return a.call(b||this,function(a){c.push(a)},this),new this(c)}}),BetaJS.Iterators.ArrayIterator.extend("BetaJS.Iterators.ObjectKeysIterator",{constructor:function(a){this._inherited(BetaJS.Iterators.ObjectKeysIterator,"constructor",BetaJS.Objs.keys(a))}}),BetaJS.Iterators.ArrayIterator.extend("BetaJS.Iterators.ObjectValuesIterator",{constructor:function(a){this._inherited(BetaJS.Iterators.ObjectValuesIterator,"constructor",BetaJS.Objs.values(a))}}),BetaJS.Iterators.Iterator.extend("BetaJS.Iterators.MappedIterator",{constructor:function(a,b,c){this._inherited(BetaJS.Iterators.MappedIterator,"constructor"),this.__iterator=a,this.__map=b,this.__context=c||this},hasNext:function(){return this.__iterator.hasNext()},next:function(){return this.hasNext()?this.__map.call(this.__context,this.__iterator.next()):null}}),BetaJS.Iterators.Iterator.extend("BetaJS.Iterators.FilteredIterator",{constructor:function(a,b,c){this._inherited(BetaJS.Iterators.FilteredIterator,"constructor"),this.__iterator=a,this.__filter=b,this.__context=c||this,this.__next=null},hasNext:function(){return this.__crawl(),null!==this.__next},next:function(){this.__crawl();var a=this.__next;return this.__next=null,a},__crawl:function(){for(;!this.__next&&this.__iterator.hasNext();){var a=this.__iterator.next();this.__filter_func(a)&&(this.__next=a)}},__filter_func:function(a){return this.__filter.apply(this.__context,[a])}}),BetaJS.Iterators.Iterator.extend("BetaJS.Iterators.SkipIterator",{constructor:function(a,b){for(this._inherited(BetaJS.Iterators.SkipIterator,"constructor"),this.__iterator=a;b>0;)a.next(),b--},hasNext:function(){return this.__iterator.hasNext()},next:function(){return this.__iterator.next()}}),BetaJS.Iterators.Iterator.extend("BetaJS.Iterators.LimitIterator",{constructor:function(a,b){this._inherited(BetaJS.Iterators.LimitIterator,"constructor"),this.__iterator=a,this.__limit=b},hasNext:function(){return this.__limit>0&&this.__iterator.hasNext()},next:function(){return this.__limit<=0?null:(this.__limit--,this.__iterator.next())}}),BetaJS.Iterators.Iterator.extend("BetaJS.Iterators.SortedIterator",{constructor:function(a,b){this._inherited(BetaJS.Iterators.SortedIterator,"constructor"),this.__array=a.asArray(),this.__array.sort(b),this.__i=0},hasNext:function(){return this.__i<this.__array.length},next:function(){var a=this.__array[this.__i];return this.__i++,a}}),BetaJS.Events={},BetaJS.Events.EVENT_SPLITTER=/\s+/,BetaJS.Events.EventsMixin={__create_event_object:function(a,b,c){c=c||{};var d={callback:a,context:b};return c.eventually&&(d.eventually=c.eventually),c.min_delay&&(d.min_delay=new BetaJS.Timers.Timer({delay:c.min_delay,once:!0,start:!1,context:this,fire:function(){d.max_delay&&d.max_delay.stop(),d.callback.apply(d.context||this,d.params)}})),c.max_delay&&(d.max_delay=new BetaJS.Timers.Timer({delay:c.max_delay,once:!0,start:!1,context:this,fire:function(){d.min_delay&&d.min_delay.stop(),d.callback.apply(d.context||this,d.params)}})),d},__destroy_event_object:function(a){a.min_delay&&a.min_delay.destroy(),a.max_delay&&a.max_delay.destroy()},__call_event_object:function(a,b){a.min_delay&&a.min_delay.restart(),a.max_delay&&a.max_delay.start(),a.min_delay||a.max_delay?a.params=b:a.eventually?BetaJS.Async.eventually(a.callback,b,a.context||this):a.callback.apply(a.context||this,b)},on:function(a,b,c,d){this.__events_mixin_events=this.__events_mixin_events||{},a=a.split(BetaJS.Events.EVENT_SPLITTER);for(var e;;){if(e=a.shift(),!e)break;this.__events_mixin_events[e]||this._notify("register_event",e),this.__events_mixin_events[e]=this.__events_mixin_events[e]||new BetaJS.Lists.LinkedList,this.__events_mixin_events[e].add(this.__create_event_object(b,c,d))}return this},off:function(a,b,c){if(this.__events_mixin_events=this.__events_mixin_events||{},a){a=a.split(BetaJS.Events.EVENT_SPLITTER);for(var d;;){if(d=a.shift(),!d)break;this.__events_mixin_events[d]&&(this.__events_mixin_events[d].remove_by_filter(function(a){var d=!(b&&a.callback!=b||c&&a.context!=c);return d&&this.__destroy_event_object&&this.__destroy_event_object(a),d}),0===this.__events_mixin_events[d].count()&&(this.__events_mixin_events[d].destroy(),delete this.__events_mixin_events[d],this._notify("unregister_event",d)))}}else for(d in this.__events_mixin_events)this.__events_mixin_events[d].remove_by_filter(function(a){var d=!(b&&a.callback!=b||c&&a.context!=c);return d&&this.__destroy_event_object&&this.__destroy_event_object(a),d}),0===this.__events_mixin_events[d].count()&&(this.__events_mixin_events[d].destroy(),delete this.__events_mixin_events[d],this._notify("unregister_event",d));return this},triggerAsync:function(){var a=this,b=BetaJS.Functions.getArguments(arguments),c=setTimeout(function(){clearTimeout(c),a.trigger.apply(a,b)},0)},trigger:function(a){var b=this;a=a.split(BetaJS.Events.EVENT_SPLITTER);var c,d=BetaJS.Functions.getArguments(arguments,1);if(!this.__events_mixin_events)return this;for(;;){if(c=a.shift(),!c)break;this.__events_mixin_events[c]&&this.__events_mixin_events[c].iterate(function(a){b.__call_event_object(a,d)}),this.__events_mixin_events&&"all"in this.__events_mixin_events&&this.__events_mixin_events.all.iterate(function(a){b.__call_event_object(a,[c].concat(d))})}return this},once:function(a,b,c,d){var e=this,f=BetaJS.Functions.once(function(){e.off(a,f),b.apply(this,arguments)});return f._callback=b,this.on(name,f,c,d)},delegateEvents:function(a,b,c,d){d=d||[],c=c?c+":":"",null===a?b.on("all",function(a){var b=BetaJS.Functions.getArguments(arguments,1);this.trigger.apply(this,[c+a].concat(d).concat(b))},this):(BetaJS.Types.is_array(a)||(a=[a]),BetaJS.Objs.iter(a,function(a){b.on(a,function(){var b=BetaJS.Functions.getArguments(arguments);this.trigger.apply(this,[c+a].concat(d).concat(b))},this)},this))}},BetaJS.Class.extend("BetaJS.Events.Events",BetaJS.Events.EventsMixin),BetaJS.Events.ListenMixin={_notifications:{destroy:"listenOff"},listenOn:function(a,b,c,d){this.__listen_mixin_listen||(this.__listen_mixin_listen={}),this.__listen_mixin_listen[BetaJS.Ids.objectId(a)]=a,a.on(b,c,this,d)},listenOnce:function(a,b,c,d){this.__listen_mixin_listen||(this.__listen_mixin_listen={}),this.__listen_mixin_listen[BetaJS.Ids.objectId(a)]=a,a.once(b,c,this,d)},listenOff:function(a,b,c){this.__listen_mixin_listen&&(a?(a.off(b,c,this),b||c||delete this.__listen_mixin_listen[BetaJS.Ids.objectId(a)]):BetaJS.Objs.iter(this.__listen_mixin_listen,function(a){a.off(b,c,this),b||c||delete this.__listen_mixin_listen[BetaJS.Ids.objectId(a)]},this))}},BetaJS.Class.extend("BetaJS.Events.Listen",BetaJS.Events.ListenMixin),BetaJS.Classes={},BetaJS.Classes.InvokerMixin={invoke_delegate:function(a,b){BetaJS.Types.is_array(b)||(b=[b]),a=this[a];for(var c=this,d=0;d<b.length;++d){var e=b[d];this[e]=function(b){return function(){var d=BetaJS.Functions.getArguments(arguments);return d.unshift(b),a.apply(c,d)}}.call(c,e)}}},BetaJS.Classes.AutoDestroyMixin={_notifications:{construct:"__initialize_auto_destroy",destroy:"__finalize_auto_destroy"},__initialize_auto_destroy:function(){this.__auto_destroy={}},__finalize_auto_destroy:function(){var a=this.__auto_destroy;this.__auto_destroy={},BetaJS.Objs.iter(a,function(a){a.unregister(this)},this)},register_auto_destroy:function(a){a.cid()in this.__auto_destroy||(this.__auto_destroy[a.cid()]=a,a.register(this),this._notify("register_auto_destroy",a))},unregister_auto_destroy:function(a){a.cid()in this.__auto_destroy&&(this._notify("unregister_auto_destroy",a),delete this.__auto_destroy[a.cid()],a.unregister(this),BetaJS.Types.is_empty(this.__auto_destroy)&&this.destroy())}},BetaJS.Class.extend("BetaJS.Classes.AutoDestroyObject",{constructor:function(){this._inherited(BetaJS.Classes.AutoDestroyObject,"constructor"),this.__objects={}},register:function(a){var b=BetaJS.Ids.objectId(a);b in this.__objects||(this.__objects[b]=a,a.register_auto_destroy(this))},unregister:function(a){var b=BetaJS.Ids.objectId(a);b in this.__objects&&(delete this.__objects[b],a.unregister_auto_destroy(this))},clear:function(){BetaJS.Objs.iter(this.__objects,function(a){this.unregister(a)},this)}}),BetaJS.Class.extend("BetaJS.Classes.ObjectCache",[BetaJS.Events.EventsMixin,{constructor:function(a){this._inherited(BetaJS.Classes.ObjectCache,"constructor"),this.__size="size"in a?a.size:null,this.__destroy_on_remove="destroy_on_remove"in a?a.destroy_on_remove:!0,this.__id_to_container={},this.__first=null,this.__last=null,this.__count=0},destroy:function(){this.clear(),this._inherited(BetaJS.Classes.ObjectCache,"destroy")},add:function(a){if(!this.get(a)){null!==this.__size&&this.__count>=this.__size&&this.__first&&this.remove(this.__first.object);var b={object:a,prev:this.__last,next:null};this.__id_to_container[BetaJS.Ids.objectId(a)]=b,this.__first?this.__last.next=b:this.__first=b,this.__last=b,this.__count++,this.trigger("cache",a)}},remove:function(a){BetaJS.Class.is_class_instance(a)&&(a=BetaJS.Ids.objectId(a));var b=this.__id_to_container[a];b&&(delete this.__id_to_container[a],b.next?b.next.prev=b.prev:this.__last=b.prev,b.prev?b.prev.next=b.next:this.__first=b.next,this.__count--,this.trigger("release",b.object),this.__destroy_on_remove&&b.object.destroy())},get:function(a){return BetaJS.Class.is_class_instance(a)&&(a=BetaJS.Ids.objectId(a)),this.__id_to_container[a]?this.__id_to_container[a].object:null},clear:function(){BetaJS.Objs.iter(this.__id_to_container,function(a){this.remove(a.object)},this)}}]),BetaJS.Classes.ModuleMixin={_notifications:{construct:function(){this.__modules={}},destroy:function(){BetaJS.Objs.iter(this.__modules,this.remove_module,this)}},add_module:function(a){a.cid()in this.__modules||(this.__modules[a.cid()]=a,a.register(this),this._notify("add_module",a))},remove_module:function(a){a.cid()in this.__modules&&(delete this.__modules[a.cid()],a.unregister(this),this._notify("remove_module",a))}},BetaJS.Class.extend("BetaJS.Classes.Module",{constructor:function(a){this._inherited(BetaJS.Classes.Module,"constructor"),this._objects={},this.__auto_destroy="auto_destroy"in a?a.auto_destroy:!0},destroy:function(){BetaJS.Objs.iter(this._objects,this.unregister,this),this._inherited(BetaJS.Classes.Module,"destroy")},register:function(a){var b=BetaJS.Ids.objectId(a);if(!(b in this._objects)){var c={};this._objects[b]={object:a,data:c},a.add_module(this),this._register(a,c)}},_register:function(){},unregister:function(a){var b=BetaJS.Ids.objectId(a);if(b in this._objects){var c=this._objects[b].data;this._unregister(a,c),delete this._objects[b],a.remove_module(this),"off"in a&&a.off(null,null,this),this.__auto_destroy&&BetaJS.Types.is_empty(this._objects)&&this.destroy()}},_unregister:function(){},_data:function(a){return this._objects[BetaJS.Ids.objectId(a)].data}},{__instance:null,singleton:function(){return this.__instance||(this.__instance=new this({auto_destroy:!1})),this.__instance}}),BetaJS.Classes.ObjectIdMixin={_notifications:{construct:"__register_object_id",destroy:"__unregister_object_id"},__object_id_scope:function(){return this.object_id_scope?this.object_id_scope:(BetaJS.Classes.ObjectIdScope||(BetaJS.Classes.ObjectIdScope=BetaJS.Objs.clone(BetaJS.Classes.ObjectIdScopeMixin,1)),BetaJS.Classes.ObjectIdScope)},__register_object_id:function(){var a=this.__object_id_scope();a.__objects[BetaJS.Ids.objectId(this)]=this},__unregister_object_id:function(){var a=this.__object_id_scope();delete a.__objects[BetaJS.Ids.objectId(this)]
}},BetaJS.Classes.ObjectIdScopeMixin={__objects:{},get:function(a){return this.__objects[a]}},BetaJS.Classes.HelperClassMixin={addHelper:function(a,b){var c=new a(this,b);return this.__helpers=this.__helpers||[],this.__helpers.push(this._auto_destroy(c)),c},_helper:function(a){this.__helpers=this.__helpers||[],BetaJS.Types.is_string(a)&&(a={method:a}),a=BetaJS.Objs.extend({fold_start:null,fold:function(a,b){return a||b}},a);for(var b=BetaJS.Functions.getArguments(arguments,1),c=a.async?BetaJS.Promise.create(a.fold_start):a.fold_start,d=0;d<this.__helpers.length;++d){var e=this.__helpers[d];a.method in e&&(c=a.async?BetaJS.Promise.func(a.fold,c,BetaJS.Promise.methodArgs(e,e[a.method],b)):a.fold(c,e[a.method].apply(e,b)))}return c}},BetaJS.Class.extend("BetaJS.Classes.IdGenerator",{generate:function(){}}),BetaJS.Classes.IdGenerator.extend("BetaJS.Classes.PrefixedIdGenerator",{constructor:function(a,b){this._inherited(BetaJS.Classes.PrefixedIdGenerator,"constructor"),this.__prefix=a,this.__generator=b},generate:function(){return this.__prefix+this.__generator.generate()}}),BetaJS.Classes.IdGenerator.extend("BetaJS.Classes.RandomIdGenerator",{constructor:function(a){this._inherited(BetaJS.Classes.PrefixedIdGenerator,"constructor"),this.__length=a||16},generate:function(){return BetaJS.Tokens.generate_token(this.__length)}}),BetaJS.Classes.IdGenerator.extend("BetaJS.Classes.ConsecutiveIdGenerator",{constructor:function(a){this._inherited(BetaJS.Classes.ConsecutiveIdGenerator,"constructor"),this.__current=a||0},generate:function(){return this.__current++,this.__current}}),BetaJS.Classes.IdGenerator.extend("BetaJS.Classes.TimedIdGenerator",{constructor:function(){this._inherited(BetaJS.Classes.TimedIdGenerator,"constructor"),this.__current=BetaJS.Time.now()-1},generate:function(){var a=BetaJS.Time.now();return this.__current=a>this.__current?a:this.__current+1,this.__current}}),BetaJS.Class.extend("BetaJS.Classes.PathResolver",{constructor:function(a){this._inherited(BetaJS.Classes.PathResolver,"constructor"),this._bindings=a||{}},extend:function(a,b){if(b)for(var c in a){for(var d=a[c],e=/\{([^}]+)\}/;;){var f=e.exec(d);if(!f)break;d=d.replace(e,b+"."+f[1])}this._bindings[b+"."+c]=d}else this._bindings=BetaJS.Objs.extend(this._bindings,a)},map:function(a){for(var b=[],c=0;c<a.length;++c)a[c]&&b.push(this.resolve(a[c]));return b},resolve:function(a){for(var b=/\{([^}]+)\}/;;){var c=b.exec(a);if(!c)return this.simplify(a);a=a.replace(b,this._bindings[c[1]])}return a},simplify:function(a){return a.replace(/[^\/]+\/\.\.\//,"").replace(/\/[^\/]+\/\.\./,"")}}),BetaJS.Class.extend("BetaJS.Classes.MultiDelegatable",{constructor:function(a,b){this._inherited(BetaJS.Classes.MultiDelegatable,"constructor"),BetaJS.Objs.iter(b,function(b){this[b]=function(){var c=arguments;return BetaJS.Objs.iter(a,function(a){a[b].apply(a,c)},this),this}},this)}}),BetaJS.Class.extend("BetaJS.Classes.ClassRegistry",{constructor:function(){this._inherited(BetaJS.Classes.ClassRegistry,"constructor"),this._classes={}},register:function(a,b){this._classes[a]=b},get:function(a){return this._classes[a]},create:function(a){var b=BetaJS.Functions.newClassFunc(this.get(a));return b.apply(this,BetaJS.Functions.getArguments(arguments,1))}}),BetaJS.Properties={},BetaJS.Properties.PropertiesMixin={_notifications:{construct:function(){this.__properties={data:{},watchers:{children:{},eventCount:0,parent:null,key:null},computed:{},bindings:{}}},destroy:function(){BetaJS.Objs.iter(this.__properties.bindings,function(a,b){this.unbind(b)},this),this.trigger("destroy")},register_event:function(a){BetaJS.Objs.iter(["change","unset","deepchange","deepunset","strongdeepchange","strongchange"],function(b){BetaJS.Strings.starts_with(a,b+":")&&this.__registerWatcher(BetaJS.Strings.strip_start(a,b+":"),b)},this)},unregister_event:function(a){BetaJS.Objs.iter(["change","unset","deepchange","deepunset","strongdeepchange","strongchange"],function(b){BetaJS.Strings.starts_with(a,b+":")&&this.__unregisterWatcher(BetaJS.Strings.strip_start(a,b+":"),b)},this)}},get:function(a){return BetaJS.Properties.Scopes.get(a,this.__properties.data)},_canSet:function(){return!0},_beforeSet:function(a,b){return b},_afterSet:function(){},has:function(a){return BetaJS.Properties.Scopes.has(a,this.__properties.data)},setAll:function(a){for(var b in a)this.set(b,a[b]);return this},keys:function(a){return BetaJS.Objs.keys(this.__properties.data,a)},data:function(){return this.__properties.data},getAll:function(){return BetaJS.Objs.clone(this.__properties.data,1)},__registerWatcher:function(a){for(var b=a?a.split("."):[],c=this.__properties.watchers,d=0;d<b.length;++d)b[d]in c.children||(c.children[b[d]]={parent:c,eventCount:0,children:{},key:b[d]}),c=c.children[b[d]];c.eventCount++},__unregisterWatcher:function(a){for(var b=a?a.split("."):[],c=this.__properties.watchers,d=0;d<b.length;++d)c&&(c=c.children[b[d]]);if(c)for(c.eventCount--;c.eventCount<=0&&BetaJS.Types.is_empty(c.children)&&c.parent;){var e=c.parent;delete e.children[c.key],c=e}},uncompute:function(a){return a in this.__properties.computed&&(BetaJS.Objs.iter(this.__properties.computed[a].dependencies,function(a){a.properties.off("change:"+a.key,null,a)},this),delete this.__properties.computed[a]),this},compute:function(a,b){function c(){if(!(f.ignore>0)){var c=BetaJS.Objs.map(e,function(a){return a.properties.get(a.key)});g.set(a,b.apply(d.context,c))}}var d=BetaJS.Functions.matchArgs(arguments,2,{setter:"function",context:{type:"object",def:this},dependencies:!0});this.uncompute(a);var e=[];BetaJS.Objs.iter(d.dependencies,function(a){e.push(BetaJS.Types.is_string(a)?{properties:this,key:a}:{properties:a[0],key:a[1]})},this);var f={ignore:0,func:b,context:d.context,setter:d.setter,dependencies:e};this.__properties.computed[a]=f;for(var g=this,h=0;h<e.length;++h)e[h].properties.on("change:"+e[h].key,function(){c()},e[h]);return c(),this},unbind:function(a,b){if(a in this.__properties.bindings){for(i=this.__properties.bindings[a].length-1;i>=0;--i){var c=this.__properties.bindings[a][i];b&&b!=c||(c.left&&c.properties.off(null,null,c),c.right&&this.off(null,null,c),this.__properties.bindings[a].splice(i,1),i--)}0===this.__properties.bindings[a].length&&delete this.__properties.bindings[a]}return this},bind:function(a,b,c){c=BetaJS.Objs.extend({secondKey:a,left:!0,right:!0,deep:!1},c);var d={key:c.secondKey,left:c.left,right:c.right,deep:c.deep,properties:b};if(this.__properties.bindings[a]=this.__properties.bindings[a]||[],this.__properties.bindings[a].push(d),d.left){var e=this;d.properties.on("strongchange:"+d.key,function(b){e.set(a,b)},d),d.properties.on("unset:"+d.key,function(){e.unset(a)},d),d.deep&&(d.properties.on("strongdeepchange:"+d.key,function(b,c,d){e.get(a?a+"."+d:d)===b?e.__setChanged(a?a+"."+d:d,b,c,!0):e.set(a?a+"."+d:d,b)},d),d.properties.on("deepunset:"+d.key,function(b,c){e.has(a?a+"."+c:c)?e.unset(a?a+"."+c:c):e.__unsetChanged(a?a+"."+c:c,b)},d)),d.right&&this.has(a)||this.set(a,d.properties.get(d.key))}return d.right&&(this.on("strongchange:"+a,function(a){d.properties.set(d.key,a)},d),this.on("unset:"+a,function(){d.properties.unset(d.key)},d),d.deep&&(this.on("strongdeepchange:"+a,function(a,b,c){d.properties.get(d.key?d.key+"."+c:c)===a?d.properties.__setChanged(d.key?d.key+"."+c:c,a,b,!0):d.properties.set(d.key?d.key+"."+c:c,a)},d),this.on("deepunset:"+a,function(a,b){d.properties.has(d.key?d.key+"."+b:b)?d.properties.unset(d.key?d.key+"."+b:b):d.properties.__unsetChanged(d.key?d.key+"."+b:b,a)},d)),(!d.left||this.has(a))&&d.properties.set(d.key,this.get(a))),d.properties.on("destroy",function(){this.unbind()},this),this},__unsetChanged:function(a,b){function c(a,b,d){BetaJS.Types.is_undefined(d)||(a.eventCount>0&&this.trigger("unset:"+b,d),BetaJS.Objs.iter(a.children,function(a,e){c.call(this,a,b?b+"."+e:e,d[e])},this))}this.trigger("unset",a,b);for(var d=a?a.split("."):[],e=this.__properties.watchers,f="",g=a,h=0;h<d.length;++h){if(e.eventCount>0&&this.trigger("deepunset:"+f,b,g),!(d[h]in e.children))return this;e=e.children[d[h]],f=f?f+"."+d[h]:d[h],g=BetaJS.Strings.first_after(g,".")}return c.call(this,e,a,b),this},__setChanged:function(a,b,c,d){function e(a,b,c,f){c!=f&&(a.eventCount>0&&(d||this.trigger("strongchange:"+b,c,f),this.trigger("change:"+b,c,f)),BetaJS.Objs.iter(a.children,function(a,d){e.call(this,a,b?b+"."+d:d,c[d],f[d])},this))}this.trigger("change",a,b,c),this._afterSet(a,b);for(var f=a?a.split("."):[],g=this.__properties.watchers,h="",i=a,j=0;j<f.length;++j){if(g.eventCount>0&&(d||this.trigger("strongdeepchange:"+h,b,c,i),this.trigger("deepchange:"+h,b,c,i)),!(f[j]in g.children))return;g=g.children[f[j]],h=h?h+"."+f[j]:f[j],i=BetaJS.Strings.first_after(i,".")}e.call(this,g,a,b,c)},unset:function(a){if(this.has(a)){var b=this.get(a);BetaJS.Properties.Scopes.unset(a,this.__properties.data),this.__unsetChanged(a,b)}return this},__properties_guid:"ec816b66-7284-43b1-a945-0600c6abfde3",set:function(a,b){if(BetaJS.Types.is_object(b)&&b&&b.guid==this.__properties_guid)return b.properties&&this.bind(a,b.properties,{secondKey:b.key}),b.func&&this.compute(a,b.func,b.dependencies),this;b=this._beforeSet(a,b);var c=this.get(a);return c!==b&&(BetaJS.Properties.Scopes.set(a,b,this.__properties.data),this.__setChanged(a,b,c)),this},binding:function(a){return{guid:this.__properties_guid,properties:this,key:a}},computed:function(a,b){return{guid:this.__properties_guid,func:a,dependencies:b}}},BetaJS.Class.extend("BetaJS.Properties.Properties",[BetaJS.Events.EventsMixin,BetaJS.Properties.PropertiesMixin,{constructor:function(a){this._inherited(BetaJS.Properties.Properties,"constructor"),a&&this.setAll(a)}}]),BetaJS.Properties.Scopes={has:function(a,b){for(var c=a?a.split("."):[],d=0;d<c.length;++d){if(!b||!BetaJS.Types.is_object(b))return!1;b=b[c[d]]}return BetaJS.Types.is_defined(b)},get:function(a,b){for(var c=a?a.split("."):[],d=0;d<c.length;++d){if(!b||!BetaJS.Types.is_object(b))return null;b=b[c[d]]}return b},set:function(a,b,c){if(a){for(var d=a.split("."),e=0;e<d.length-1;++e)d[e]in c&&BetaJS.Types.is_object(c[d[e]])||(c[d[e]]={}),c=c[d[e]];c[d[d.length-1]]=b}},unset:function(a,b){if(a){for(var c=a.split("."),d=0;d<c.length-1;++d){if(!b||!BetaJS.Types.is_object(b))return;b=b[c[d]]}delete b[c[c.length-1]]}},touch:function(a,b){if(!a)return b;for(var c=a.split("."),d=0;d<c.length;++d)c[d]in b&&BetaJS.Types.is_object(b)||(b[c[d]]={}),b=b[c[d]];return b[c[c.length-1]]}},BetaJS.Class.extend("BetaJS.Collections.Collection",[BetaJS.Events.EventsMixin,{constructor:function(a){this._inherited(BetaJS.Collections.Collection,"constructor"),a=a||{};var b={};"compare"in a&&(b.compare=a.compare),b.get_ident=BetaJS.Functions.as_method(this.get_ident,this),this.__data=new BetaJS.Lists.ArrayList([],b);var c=this;this.__data._ident_changed=function(a,b){c._index_changed(a,b)},this.__data._re_indexed=function(a){c._re_indexed(a)},this.__data._sorted=function(){c._sorted()},"objects"in a&&this.add_objects(a.objects)},get_ident:function(a){return BetaJS.Ids.objectId(a)},set_compare:function(a){this.__data.set_compare(a)},get_compare:function(){this.__data.get_compare()},destroy:function(){this.__data.iterate(function(a){"off"in a&&a.off(null,null,this)},this),this.__data.destroy(),this.trigger("destroy"),this._inherited(BetaJS.Collections.Collection,"destroy")},count:function(){return this.__data.count()},_index_changed:function(a,b){this.trigger("index",a,b)},_re_indexed:function(a){this.trigger("reindexed",a)},_sorted:function(){this.trigger("sorted")},_object_changed:function(a,b,c){this.trigger("update"),this.trigger("change",a,b,c),this.trigger("change:"+b,a,c),this.__data.re_index(this.getIndex(a))},add:function(a){if(BetaJS.Class.is_class_instance(a)||(a=new BetaJS.Properties.Properties(a)),this.exists(a))return null;var b=this.__data.add(a);return null!==b&&(this.trigger("add",a),this.trigger("update"),"on"in a&&a.on("change",function(b,c){this._object_changed(a,b,c)},this)),b},add_objects:function(a){var b=0;return BetaJS.Objs.iter(a,function(a){this.add(a)&&b++},this),b},exists:function(a){return this.__data.exists(a)},remove:function(a){if(!this.exists(a))return null;this.trigger("remove",a),this.trigger("update");var b=this.__data.remove(a);return"off"in a&&a.off(null,null,this),b},getByIndex:function(a){return this.__data.get(a)},getById:function(a){return this.__data.get(this.__data.ident_by_id(a))},getIndex:function(a){return this.__data.get_ident(a)},iterate:function(a,b){this.__data.iterate(a,b)},iterator:function(){return BetaJS.Iterators.ArrayIterator.byIterate(this.iterate,this)},clear:function(){this.iterate(function(a){this.remove(a)},this)}}]),BetaJS.Collections.Collection.extend("BetaJS.Collections.FilteredCollection",{constructor:function(a,b){this.__parent=a,b=b||{},delete b.objects,b.compare=b.compare||a.get_compare(),this._inherited(BetaJS.Collections.FilteredCollection,"constructor",b),"filter"in b&&(this.filter=b.filter),this.__parent.iterate(function(a){return this.add(a),!0},this),this.__parent.on("add",this.add,this),this.__parent.on("remove",this.remove,this)},filter:function(){return!0},_object_changed:function(a,b,c){this._inherited(BetaJS.Collections.FilteredCollection,"_object_changed",a,b,c),this.filter(a)||this.__selfRemove(a)},destroy:function(){this.__parent.off(null,null,this),this._inherited(BetaJS.Collections.FilteredCollection,"destroy")},__selfAdd:function(a){return this._inherited(BetaJS.Collections.FilteredCollection,"add",a)},add:function(a){if(this.exists(a)||!this.filter(a))return null;var b=this.__selfAdd(a);return this.__parent.add(a),b},__selfRemove:function(a){return this._inherited(BetaJS.Collections.FilteredCollection,"remove",a)},remove:function(a){if(!this.exists(a))return null;var b=this.__selfRemove(a);return b?this.__parent.remove(a):null}}),BetaJS.Comparators={byObject:function(a){return function(b,c){for(key in a){var d=0;if(d=BetaJS.Properties.Properties.is_class_instance(b)&&BetaJS.Properties.Properties.is_class_instance(c)?BetaJS.Comparators.byValue(b.get(key)||null,c.get(key)||null):BetaJS.Comparators.byValue(b[key]||null,c[key]||null),0!==d)return d*a[key]}return 0}},byValue:function(a,b){return BetaJS.Types.is_string(a)?a.localeCompare(b):b>a?-1:a>b?1:0},listEqual:function(a,b){if(BetaJS.Types.is_array(a)&&BetaJS.Types.is_array(b)){if(a.length!=b.length)return!1;for(var c=0;c<a.length;++c)if(a[c]!==b[c])return!1;return!0}if(BetaJS.Types.is_object(a)&&BetaJS.Types.is_object(b)){for(var d in a)if(b[d]!==a[d])return!1;for(d in b)if(!(d in a))return!1;return!0}return!1}},BetaJS.Sort={sort_object:function(a,b){var c=[];for(var d in a)c.push({key:d,value:a[d]});c.sort(function(a,c){return b(a.key,c.key,a.value,c.value)});for(var e={},f=0;f<c.length;++f)e[c[f].key]=c[f].value;return e},deep_sort:function(a,b){if(b=b||BetaJS.Comparators.byValue,BetaJS.Types.is_array(a)){for(var c=0;c<a.length;++c)a[c]=this.deep_sort(a[c],b);return a.sort(b)}if(BetaJS.Types.is_object(a)){for(var d in a)a[d]=this.deep_sort(a[d],b);return this.sort_object(a,b)}return a},dependency_sort:function(a,b,c,d){var e=BetaJS.Types.is_string(b)?function(a){return a[b]}:b,f=BetaJS.Types.is_string(c)?function(a){return a[c]}:c,g=BetaJS.Types.is_string(d)?function(a){return a[d]}:d,h=a.length,i=[],j={},k={},l=null;for(l=0;h>l;++l){k[l]=!0;var m=e(a[l],l);j[m]=l,i.push({before:{},after:{}})}for(l=0;h>l;++l)BetaJS.Objs.iter(f(a[l],l)||[],function(a){var b=j[a];BetaJS.Types.is_defined(b)&&(i[l].before[b]=!0,i[b].after[l]=!0)}),BetaJS.Objs.iter(g(a[l])||[],function(a){var b=j[a];BetaJS.Types.is_defined(b)&&(i[l].after[b]=!0,i[b].before[l]=!0)});for(var n=[];!BetaJS.Types.is_empty(k);)for(l in k)if(BetaJS.Types.is_empty(i[l].after)){delete k[l],n.push(a[l]);for(bef in i[l].before)delete i[bef].after[l]}return n}},BetaJS.Locales={__data:{},language:null,get:function(a){return this.language&&this.language+"."+a in this.__data?this.__data[this.language+"."+a]:a in this.__data?this.__data[a]:a},register:function(a,b){b=b?b+".":"";for(var c in a)this.__data[b+c]=a[c]},view:function(a){return{context:this,base:a,get:function(a){return this.context.get(this.base+"."+a)},base:function(a){return this.context.base(this.base+"."+a)}}}},BetaJS.Time={timezoneBias:function(a){return a===!0&&(a=(new Date).getTimezoneOffset()),("undefined"==typeof a||null===a||a===!1)&&(a=0),60*a*1e3},timeToDate:function(a,b){return new Date(a+this.timezoneBias(b))},dateToTime:function(a,b){return a.getTime()-this.timezoneBias(b)},timeToTimezoneBasedDate:function(a,b){return new Date(a-this.timezoneBias(b))},timezoneBasedDateToTime:function(a,b){return a.getTime()+this.timezoneBias(b)},__components:{year:{set:function(a,b){a.setUTCFullYear(b)},get:function(a){return a.getUTCFullYear()}},month:{set:function(a,b){a.setUTCMonth(b)},get:function(a){return a.getUTCMonth()}},day:{dependencies:{weekday:!0},set:function(a,b){a.setUTCDate(b+1)},get:function(a){return a.getUTCDate()-1},milliseconds:864e5},weekday:{dependencies:{day:!0,month:!0,year:!0},set:function(a,b){a.setUTCDate(a.getUTCDate()+b-a.getUTCDay())},get:function(a){return a.getUTCDay()}},hour:{set:function(a,b){a.setUTCHours(b)},get:function(a){return a.getUTCHours()},max:23,milliseconds:36e5},minute:{set:function(a,b){a.setUTCMinutes(b)},get:function(a){return a.getUTCMinutes()},max:59,milliseconds:6e4},second:{set:function(a,b){a.setUTCSeconds(b)},get:function(a){return a.getUTCSeconds()},max:59,milliseconds:1e3},millisecond:{set:function(a,b){a.setUTCMilliseconds(b)},get:function(a){return a.getUTCMilliseconds()},max:999,milliseconds:1}},decodeTime:function(a,b){var c=this.timeToTimezoneBasedDate(a,b),d={};for(var e in this.__components)d[e]=this.__components[e].get(c);return d},encodeTime:function(a,b){return this.updateTime(this.now(),a,b)},encodePeriod:function(a){return this.incrementTime(0,a)},updateTime:function(a,b,c){var d=this.timeToTimezoneBasedDate(a,c);for(var e in b)this.__components[e].set(d,b[e]);return this.timezoneBasedDateToTime(d,c)},now:function(a){return this.dateToTime(new Date,a)},incrementTime:function(a,b){var c=this.timeToDate(a);for(var d in b)this.__components[d].set(c,this.__components[d].get(c)+b[d]);return this.dateToTime(c)},floorTime:function(a,b,c){var d=this.timeToTimezoneBasedDate(a,c),e=!1;for(var f in this.__components){var g=this.__components[f];e=e||f==b,!e||g.dependencies&&g.dependencies[b]||g.set(d,0)}return this.timezoneBasedDateToTime(d,c)},ago:function(a,b){return this.now(b)-a},timeComponent:function(a,b,c){return Math[c||"floor"](a/this.__components[b].milliseconds)},timeModulo:function(a,b,c){return this.timeComponent(a,b,c)%(this.__components[b].max+1)},formatTimePeriod:function(a,b){b=b||{};for(var c=b.components||["day","hour","minute","second"],d="",e=0,f=0;f<c.length&&(d=c[f],!(e=this.timeComponent(a,d,b.round||"round")));++f);return e+" "+BetaJS.Locales.get(d+(1==e?"":"s"))},formatTime:function(a,b){var c=["hour","minute","second"];b=b||"hhh:mm:ss";for(var d={},e=0;e<c.length;++e){var f=c[e].charAt(0);d[f+f+f]=this.timeComponent(a,c[e],"floor");var g=this.timeModulo(a,c[e],"floor");d[f+f]=10>g?"0"+g:g,d[f]=g}for(var h in d)b=b.replace(h,d[h]);return b}},BetaJS.Class.extend("BetaJS.Timers.Timer",{constructor:function(a){this._inherited(BetaJS.Timers.Timer,"constructor"),a=BetaJS.Objs.extend({once:!1,start:!0,fire:null,context:this,destroy_on_fire:!1},a),this.__delay=a.delay,this.__destroy_on_fire=a.destroy_on_fire,this.__once=a.once,this.__fire=a.fire,this.__context=a.context,this.__started=!1,a.start&&this.start()},destroy:function(){this.stop(),this._inherited(BetaJS.Timers.Timer,"destroy")},fire:function(){this.__once&&(this.__started=!1),this.__fire&&this.__fire.apply(this.__context,[this]),this.__destroy_on_fire&&this.destroy()},stop:function(){this.__started&&(this.__once?clearTimeout(this.__timer):clearInterval(this.__timer),this.__started=!1)},start:function(){if(!this.__started){var a=this;this.__timer=this.__once?setTimeout(function(){a.fire()},this.__delay):setInterval(function(){a.fire()},this.__delay),this.__started=!0}},restart:function(){this.stop(),this.start()}}),BetaJS.Templates={tokenize:function(a){if(BetaJS.Types.is_array(a))return a;var b=[],c=0;return a.replace(BetaJS.Templates.SYNTAX_REGEX(),function(d,e,f,g,h){return h>c&&b.push({type:BetaJS.Templates.TOKEN_STRING,data:BetaJS.Strings.js_escape(a.slice(c,h))}),g&&b.push({type:BetaJS.Templates.TOKEN_CODE,data:g}),e&&b.push({type:BetaJS.Templates.TOKEN_EXPR,data:e}),f&&b.push({type:BetaJS.Templates.TOKEN_ESC,data:f}),c=h+d.length,d}),b},compile:function(a,b){BetaJS.Types.is_string(a)&&(a=this.tokenize(a)),b=b||{};for(var c=b.start_index||0,d=b.end_index||a.length,e="__p+='",f=c;d>f;++f)switch(a[f].type){case BetaJS.Templates.TOKEN_STRING:e+=a[f].data;break;case BetaJS.Templates.TOKEN_CODE:e+="';\n"+a[f].data+"\n__p+='";break;case BetaJS.Templates.TOKEN_EXPR:e+="'+\n((__t=("+a[f].data+"))==null?'':__t)+\n'";break;case BetaJS.Templates.TOKEN_ESC:e+="'+\n((__t=("+a[f].data+"))==null?'':BetaJS.Strings.htmlentities(__t))+\n'"}e+="';\n",e="with(obj||{}){\n"+e+"}\n",e="var __t,__p='',__j=Array.prototype.join,echo=function(){__p+=__j.call(arguments,'');};\n"+e+"return __p;\n";var g=new Function("obj",e),h=function(a){return g.call(this,a)};return h.source="function(obj){\n"+e+"}",h}},BetaJS.Templates.SYNTAX={OPEN:"{%",CLOSE:"%}",MODIFIER_CODE:"",MODIFIER_EXPR:"=",MODIFIER_ESC:"-"},BetaJS.Templates.SYNTAX_REGEX=function(){var a=BetaJS.Templates.SYNTAX;return BetaJS.Templates.SYNTAX_REGEX_CACHED||(BetaJS.Templates.SYNTAX_REGEX_CACHED=new RegExp(a.OPEN+a.MODIFIER_EXPR+"([\\s\\S]+?)"+a.CLOSE+"|"+a.OPEN+a.MODIFIER_ESC+"([\\s\\S]+?)"+a.CLOSE+"|"+a.OPEN+a.MODIFIER_CODE+"([\\s\\S]+?)"+a.CLOSE+"|$","g")),BetaJS.Templates.SYNTAX_REGEX_CACHED},BetaJS.Templates.TOKEN_STRING=1,BetaJS.Templates.TOKEN_CODE=2,BetaJS.Templates.TOKEN_EXPR=3,BetaJS.Templates.TOKEN_ESC=4,BetaJS.Class.extend("BetaJS.Templates.Template",{constructor:function(a){this._inherited(BetaJS.Templates.Template,"constructor"),this.__tokens=BetaJS.Templates.tokenize(a),this.__compiled=BetaJS.Templates.compile(this.__tokens)},evaluate:function(a){return this.__compiled.apply(this,[a])}},{bySelector:function(a){return new this(BetaJS.$(a).html())}}),BetaJS.JavaScript={STRING_SINGLE_QUOTATION_REGEX:/'[^']*'/g,STRING_DOUBLE_QUOTATION_REGEX:/"[^"]*"/g,IDENTIFIER_REGEX:/[a-zA-Z_][a-zA-Z_0-9]*/g,IDENTIFIER_SCOPE_REGEX:/[a-zA-Z_][a-zA-Z_0-9\.]*/g,RESERVED:BetaJS.Objs.objectify(["if","then","else","return","var"],!0),isReserved:function(a){return a in this.RESERVED},isIdentifier:function(a){return!this.isReserved(a)},removeStrings:function(a){return a.replace(this.STRING_SINGLE_QUOTATION_REGEX,"").replace(this.STRING_DOUBLE_QUOTATION_REGEX,"")},extractIdentifiers:function(a,b){var c=b?this.IDENTIFIER_SCOPE_REGEX:this.IDENTIFIER_REGEX;return a=this.removeStrings(a),BetaJS.Objs.filter(a.match(c),this.isIdentifier,this)}},BetaJS.Class.extend("BetaJS.States.Host",[BetaJS.Events.EventsMixin,{initialize:function(a,b){var c=BetaJS.Scopes.resolve(a),d=new c(this,b,{});d.start()},finalize:function(){this._state&&this._state.destroy(),this._state=null},destroy:function(){this.finalize(),this._inherited(BetaJS.States.Host,"destroy")},state:function(){return this._state},_start:function(a){this._stateEvent(a,"before_start"),this._state=a},_afterStart:function(a){this._stateEvent(a,"start")},_end:function(a){this._stateEvent(a,"end"),this._state=null},_afterEnd:function(a){this._stateEvent(a,"after_end")},_next:function(a){this._stateEvent(a,"next")},_afterNext:function(a){this._stateEvent(a,"after_next")},_can_transition_to:function(){return!0},_stateEvent:function(a,b){this.trigger("event",b,a.state_name(),a.description()),this.trigger(b,a.state_name(),a.description()),this.trigger(b+":"+a.state_name(),a.description())}}]),BetaJS.Class.extend("BetaJS.States.State",{_locals:[],_persistents:[],_white_list:null,constructor:function(a,b,c){this._inherited(BetaJS.States.State,"constructor"),this.host=a,this.transitionals=c,this._starting=!1,this._started=!1,this._stopped=!1,this._transitioning=!1,this.__next_state=null,this.__suspended=0,b=b||{},this._locals=BetaJS.Types.is_function(this._locals)?this._locals():this._locals;for(var d=0;d<this._locals.length;++d)this["_"+this._locals[d]]=b[this._locals[d]];for(this._persistents=BetaJS.Types.is_function(this._persistents)?this._persistents():this._persistents,d=0;d<this._persistents.length;++d)this["_"+this._persistents[d]]=b[this._persistents[d]]},state_name:function(){return BetaJS.Strings.last_after(this.cls.classname,".")},description:function(){return this.state_name()},start:function(){this._starting||(this._starting=!0,this.host._start(this),this._start(),this.host&&(this.host._afterStart(this),this._started=!0))},end:function(){this._stopped||(this._stopped=!0,this._end(),this.host._end(this),this.host._afterEnd(this),this.destroy())},eventualNext:function(a,b,c){this.suspend(),this.next(a,b,c),this.eventualResume()},next:function(a,b,c){if(this._starting&&!this._stopped&&!this.__next_state){var d=this.cls.classname,e=BetaJS.Scopes.resolve(d.substring(0,d.lastIndexOf("."))),f=e[a];b=b||{};for(var g=0;g<this._persistents.length;++g)this._persistents[g]in b||(b[this._persistents[g]]=this["_"+this._persistents[g]]);var h=new f(this.host,b,c);if(!this.can_transition_to(h))return void h.destroy();this._started||(this.host._afterStart(this),this._started=!0),this.__next_state=h,this._transitioning=!0,this._transition(),this.__suspended<=0&&this.__next()}},__next:function(){var a=this.host,b=this.__next_state;a._next(b),this.end(),b.start(),a._afterNext(b)},_transition:function(){},suspend:function(){this.__suspended++},eventualResume:function(){BetaJS.Async.eventually(this.resume,this)},resume:function(){this.__suspended--,0===this.__suspended&&!this._stopped&&this.__next_state&&this.__next()},can_transition_to:function(a){return this.host&&this.host._can_transition_to(a)&&this._can_transition_to(a)},_start:function(){},_end:function(){},_can_transition_to:function(a){return!BetaJS.Types.is_array(this._white_list)||BetaJS.Objs.contains_value(this._white_list,a.state_name())}}),BetaJS.Class.extend("BetaJS.States.CompetingComposite",{_register_host:function(a){this._hosts=this._hosts||[],this._hosts.push(this._auto_destroy(a))},other_hosts:function(a){return BetaJS.Objs.filter(this._hosts||[],function(b){return b!=a},this)},_next:function(a,b){for(var c=this.other_hosts(a),d=0;d<c.length;++d){var e=c[d],f=e.state();f.can_coexist_with(b)||f.retreat_against(b)}}}),BetaJS.States.Host.extend("BetaJS.States.CompetingHost",{constructor:function(a){this._inherited(BetaJS.States.CompetingHost,"constructor"),this._composite=a,a&&a._register_host(this)},composite:function(){return this._composite},_can_transition_to:function(a){if(!this._composite)return!0;for(var b=this._composite.other_hosts(this),c=0;c<b.length;++c){var d=b[c],e=d.state();if(!a.can_coexist_with(e)&&!a.can_prevail_against(e))return!1}return!0},_next:function(a){this._composite&&this._composite._next(this,a),this._inherited(BetaJS.States.CompetingHost,"_next",a)}}),BetaJS.States.State.extend("BetaJS.States.CompetingState",{can_coexist_with:function(){return!0},can_prevail_against:function(){return!1},retreat_against:function(){}}),BetaJS.Class.extend("BetaJS.Parser.Lexer",{constructor:function(a){this._inherited(BetaJS.Parser.Lexer,"constructor"),this.__patterns=[],BetaJS.Objs.iter(a,function(a,b){this.__patterns.push({regex:new RegExp("^"+b,"m"),data:BetaJS.Types.is_string(a)?{token:a}:a})},this)},lex:function(a){for(var b=[],c="",d=a;d;){for(var e=null,f=null,g=0;g<this.__patterns.length;++g)if(e=this.__patterns[g].regex.exec(d)){f=BetaJS.Objs.clone(this.__patterns[g].data,1);break}if(!e)throw new BetaJS.Parser.LexerException(c,d);if(c+=e[0],d=d.substring(e[0].length),f){for(var h in f)if(BetaJS.Types.is_string(f[h]))for(var i=0;i<e.length;++i)f[h]=f[h].replace("$"+i,e[i]);b.push(f)}}return b}}),BetaJS.Exceptions.Exception.extend("BetaJS.Parser.LexerException",{constructor:function(a,b){this._inherited(BetaJS.Parser.LexerException,"constructor","Lexer error: Unrecognized identifier at "+a.length+"."),this.__head=a,this.__tail=b}}),BetaJS.Trees={},BetaJS.Trees.TreeNavigator={nodeRoot:function(){},nodeId:function(){},nodeParent:function(){},nodeChildren:function(){},nodeWatch:function(){},nodeUnwatch:function(){},nodeData:function(){}},BetaJS.Class.extend("BetaJS.Trees.TreeQueryEngine",{constructor:function(a){this._inherited(BetaJS.Trees.TreeQueryEngine,"constructor"),this.__navigator=a,this.__lexer=this._auto_destroy(new BetaJS.Parser.Lexer({"<\\+":{token:"Up"},"<":{token:"Up",single:!0},">\\+":{token:"Down"},">":{token:"Down",single:!0},"\\[s*([a-zA-Z]+)s*=s*'([^']*)'s*\\]":{token:"Selector",key:"$1",value:"$2"},s:null}))},query:function(a,b){return new BetaJS.Trees.TreeQueryObject(this.__navigator,a,this.__lexer.lex(b))}}),BetaJS.Class.extend("BetaJS.Trees.TreeQueryObject",[BetaJS.Events.EventsMixin,{constructor:function(a,b,c){this._inherited(BetaJS.Trees.TreeQueryObject,"constructor"),this.__navigator=a,this.__node=b,this.__query=c,this.__result={},this.__partials={},this.__register(b,0,{}),this.__ids=0},destroy:function(){BetaJS.Objs.iter(this.__partials,function(a){BetaJS.Objs.iter(a.partials,function(b){this.__navigator.nodeUnwatch(a.node,null,b)},this)},this),this._inherited(BetaJS.Trees.TreeQueryObject,"destroy")},result:function(){var a=[];return BetaJS.Objs.iter(this.__result,function(b){a.push(b.node)}),a},__register:function(a,b){var c=this.__navigator.nodeId(a);this.__partials[c]||(this.__partials[c]={node:a,partials:{}});var d=this.__partials[c];this.__ids++;var e={owner:d,id:this.__ids,query_index_start:b,query_index_next:b,query_index_last:b,partial_match:!1,partial_final:b>=this.__query.length,partial_data:!1,partial_children:!1,partial_parent:!1,partial_star:!1,parent:null,deps:{}};d.partials[e.id]=e;for(var f=e.query_index_start;f<this.__query.length;++f){if("Selector"!=this.__query[f].token){"Up"==this.__query[f].token?e.partial_parent=!0:"Down"==this.__query[f].token&&(e.partial_children=!0),e.partial_star=!this.__query[f].single,e.partial_star||(e.query_index_next=f+1);break}e.partial_data=!0,e.query_index_next=f+1,e.partial_final=f+1==this.__query.length}e.query_index_last=e.partial_star?e.query_index_next+1:e.query_index_next;var g=this;return this.__navigator.nodeWatch(a,function(a,b){"data"==a&&e.partial_data&&g.__update(e),"remove"==a&&g.__unregisterPartial(e),"addChild"==a&&e.partial_children&&e.partial_match&&g.__addDependentPartial(e,b)},e),this.__update(e),e},__unregisterPartial:function(a){var b=a.owner,c=b.node,d=this.__navigator.nodeId(c);a.partial_final&&this.__result[d]&&(this.__result[d].count--,this.__result[d].count<=0&&(delete this.__result[d],this.trigger("remove",c),this.trigger("change"))),BetaJS.Objs.iter(a.deps,this.__unregisterPartial,this),a.parent&&delete a.parent.deps[a.id],this.__navigator.nodeUnwatch(c,null,a),delete b.partials[a.id],BetaJS.Types.is_empty(b.partials)&&delete this.__partials[d]},__addDependentPartial:function(a,b){var c=[];c.push(this.__register(b,a.query_index_next)),a.partial_star&&c.push(this.__register(b,a.query_index_next+1)),BetaJS.Objs.iter(c,function(b){a.deps[b.id]=b,b.parent=a},this)},__update:function(a){for(var b=!0,c=a.owner.node,d=this.__navigator.nodeId(c),e=this.__navigator.nodeData(c),f=a.query_index_start;f<a.query_index_last;++f){var g=this.__query[f];if("Selector"!=g.token)break;if(e[g.key]!=g.value){b=!1;break}}b!=a.partial_match&&(a.partial_match=b,b?a.partial_final?this.__result[d]?this.__result[d].count++:(this.__result[d]={node:c,count:1},this.trigger("add",c),this.trigger("change")):a.partial_parent?this.__addDependentPartial(a,this.__navigator.nodeParent(c)):a.partial_children&&BetaJS.Objs.iter(this.__navigator.nodeChildren(c),function(b){this.__addDependentPartial(a,b)},this):(a.partial_final&&(this.__result[d].count--,this.__result[d].count<=0&&(delete this.__result[d],this.trigger("remove",c),this.trigger("change"))),BetaJS.Objs.iter(a.deps,this.__unregisterPartial,this)))
}}]),BetaJS.Class.extend("BetaJS.Channels.Sender",[BetaJS.Events.EventsMixin,{send:function(a,b){this.trigger("send",a,b),this._send(a,b)},_send:function(){}}]),BetaJS.Class.extend("BetaJS.Channels.Receiver",[BetaJS.Events.EventsMixin,{_receive:function(a,b){this.trigger("receive",a,b),this.trigger("receive:"+a,b)}}]),BetaJS.Channels.Sender.extend("BetaJS.Channels.ReceiverSender",{constructor:function(a){this._inherited(BetaJS.Channels.ReceiverSender,"constructor"),this.__receiver=a},_send:function(a,b){this.__receiver._receive(a,b)}}),BetaJS.Channels.Sender.extend("BetaJS.Channels.SenderMultiplexer",{constructor:function(a,b){this._inherited(BetaJS.Channels.SenderMultiplexer,"constructor"),this.__sender=a,this.__prefix=b},_send:function(a,b){this.__sender.send(this.__prefix+":"+a,b)}}),BetaJS.Channels.Receiver.extend("BetaJS.Channels.ReceiverMultiplexer",{constructor:function(a,b){this._inherited(BetaJS.Channels.ReceiverMultiplexer,"constructor"),this.__receiver=a,this.__prefix=b,this.__receiver.on("receive",function(a,b){BetaJS.Strings.starts_with(a,this.__prefix+":")&&this._receive(BetaJS.Strings.strip_start(a,this.__prefix+":"),b)},this)}}),BetaJS.Class.extend("BetaJS.Channels.TransportChannel",{constructor:function(a,b,c){this._inherited(BetaJS.Channels.TransportChannel,"constructor"),this.__sender=a,this.__receiver=b,this.__options=BetaJS.Objs.extend(c,{timeout:1e4,tries:1,timer:500}),this.__receiver.on("receive:send",function(a){this.__reply(a)},this),this.__receiver.on("receive:reply",function(a){this.__complete(a)},this),this.__sent_id=0,this.__sent={},this.__received={},this.__timer=this._auto_destroy(new BetaJS.Timers.Timer({delay:this.__options.timer,context:this,fire:this.__maintenance}))},_reply:function(){},send:function(a,b,c){var d=BetaJS.Promise.create();return c=c||{},c.stateless?(this.__sender.send("send",{message:a,data:b,stateless:!0}),d.asyncSuccess(!0)):(this.__sent_id++,this.__sent[this.__sent_id]={message:a,data:b,tries:1,time:BetaJS.Time.now(),id:this.__sent_id,promise:d},this.__sender.send("send",{message:a,data:b,id:this.__sent_id})),d},__reply:function(a){return a.stateless?void this._reply(a.message,a.data):void(this.__received[a.id]?this.__received[a.id].returned&&this.__sender.send("reply",{id:a.id,reply:a.reply,success:a.success}):(this.__received[a.id]=a,this.__received[a.id].time=BetaJS.Time.now(),this.__received[a.id].returned=!1,this.__received[a.id].success=!1,this._reply(a.message,a.data).success(function(b){this.__received[a.id].reply=b,this.__received[a.id].success=!0},this).error(function(b){this.__received[a.id].reply=b},this).callback(function(){this.__received[a.id].returned=!0,this.__sender.send("reply",{id:a.id,reply:a.reply,success:a.success})},this)))},__complete:function(a){if(this.__sent[a.id]){var b=this.__sent[a.id].promise;b[a.success?"asyncSuccess":"asyncError"](a.reply),delete this.__sent[a.id]}},__maintenance:function(){var a=BetaJS.Time.now();for(var b in this.__received){var c=this.__received[b];c.time+this.__options.tries*this.__options.timeout<=a&&delete this.__received[b]}for(var d in this.__sent){var e=this.__sent[d];e.time+e.tries*this.__options.timeout<=a&&(e.tries<this.__options.tries?(e.tries++,this.__sender.send("send",{message:e.message,data:e.data,id:e.id})):(e.promise.asyncError({message:e.message,data:e.data}),delete this.__sent[d]))}}}),BetaJS.Class.extend("BetaJS.RMI.Stub",[BetaJS.Classes.InvokerMixin,{intf:[],constructor:function(){this._inherited(BetaJS.RMI.Stub,"constructor"),this.invoke_delegate("invoke",this.intf)},destroy:function(){this.invoke("_destroy"),this._inherited(BetaJS.RMI.Stub,"destroy")},invoke:function(a){return this.__send(a,BetaJS.Functions.getArguments(arguments,1))}}]),BetaJS.Class.extend("BetaJS.RMI.StubSyncer",[BetaJS.Classes.InvokerMixin,{constructor:function(a){this._inherited(BetaJS.RMI.StubSyncer,"constructor"),this.__stub=a,this.__current=null,this.__queue=[],this.invoke_delegate("invoke",this.__stub.intf)},invoke:function(){var a={args:BetaJS.Functions.getArguments(arguments),promise:BetaJS.Promise.create()};return this.__queue.push(a),this.__current||this.__next(),a.promise},__next:function(){0!==this.__queue.length&&(this.__current=this.__queue.shift(),this.__stub.invoke.apply(this.__stub,this.__current.args).forwardCallback(this.__current.promise).callback(this.__next,this))}}]),BetaJS.Class.extend("BetaJS.RMI.Skeleton",{_stub:null,intf:[],_intf:{},__superIntf:["_destroy"],constructor:function(a){this._options=BetaJS.Objs.extend({destroyable:!1},a),this._inherited(BetaJS.RMI.Skeleton,"constructor"),this.intf=this.intf.concat(this.__superIntf);for(var b=0;b<this.intf.length;++b)this._intf[this.intf[b]]=!0},_destroy:function(){this._options.destroyable&&this.destroy()},invoke:function(a,b){if(!this._intf[a])return BetaJS.Promise.error(a);try{var c=this[a].apply(this,b);return BetaJS.Promise.is(c)?c:BetaJS.Promise.value(c)}catch(d){return BetaJS.Promise.error(d)}},_success:function(a){return BetaJS.Promise.value(a)},_error:function(){return BetaJS.Promise.error(result)},stub:function(){if(this._stub)return this._stub;var a=this.cls.classname;return a.indexOf("Skeleton")>=0?a.replace("Skeleton","Stub"):a}}),BetaJS.Class.extend("BetaJS.RMI.Server",[BetaJS.Events.EventsMixin,{constructor:function(a,b){if(this._inherited(BetaJS.RMI.Server,"constructor"),this.__channels=new BetaJS.Lists.ObjectIdList,this.__instances={},a){var c=a;b&&(c=this._auto_destroy(new BetaJS.Channels.TransportChannel(a,b))),this.registerClient(c)}},destroy:function(){this.__channels.iterate(this.unregisterClient,this),BetaJS.Objs.iter(this.__instances,function(a){this.unregisterInstance(a.instance)},this),this.__channels.destroy(),this._inherited(BetaJS.RMI.Server,"destroy")},registerInstance:function(a,b){return b=b||{},this.__instances[BetaJS.Ids.objectId(a,b.name)]={instance:a,options:b},a},unregisterInstance:function(a){delete this.__instances[BetaJS.Ids.objectId(a)],a.destroy()},registerClient:function(a){var b=this;this.__channels.add(a),a._reply=function(c,d){var e=c.split(":");return 2==e.length?b._invoke(a,e[0],e[1],d):BetaJS.Promise.error(!0)}},unregisterClient:function(a){this.__channels.remove(a),a._reply=null},_serializeValue:function(a){if(BetaJS.RMI.Skeleton.is_class_instance(a)&&a.instance_of(BetaJS.RMI.Skeleton)){var b=this;return b.registerInstance(a),{__rmi_meta:!0,__rmi_stub:a.stub(),__rmi_stub_id:BetaJS.Ids.objectId(a)}}return a},_unserializeValue:function(a){if(a&&a.__rmi_meta){var b=this.client;return b.acquire(a.__rmi_stub,a.__rmi_stub_id)}return a},_invoke:function(a,b,c,d){var e=this.__instances[b];return e||(this.trigger("loadInstance",a,b),e=this.__instances[b]),e?(e=e.instance,d=BetaJS.Objs.map(d,this._unserializeValue,this),e.invoke(c,d,a).mapSuccess(function(a){return this._serializeValue(a)},this)):BetaJS.Promise.error(b)}}]),BetaJS.Class.extend("BetaJS.RMI.Client",{constructor:function(a,b){if(this._inherited(BetaJS.RMI.Client,"constructor"),this.__channel=null,this.__instances={},a){var c=a;b&&(c=this._auto_destroy(new BetaJS.Channels.TransportChannel(a,b))),this.__channel=c}},destroy:function(){this.__channel&&this.disconnect(),this._inherited(BetaJS.RMI.Client,"destroy")},connect:function(a){this.__channel||(this.__channel=a)},disconnect:function(){this.__channel&&(this.__channel=null,BetaJS.Objs.iter(this.__instances,function(a){this.release(a)},this))},_serializeValue:function(a){if(BetaJS.RMI.Skeleton.is_class_instance(a)&&a.instance_of(BetaJS.RMI.Skeleton)){var b=this.server;return b.registerInstance(a),{__rmi_meta:!0,__rmi_stub:a.stub(),__rmi_stub_id:BetaJS.Ids.objectId(a)}}return a},_unserializeValue:function(a){if(a&&a.__rmi_meta){var b=this;return b.acquire(a.__rmi_stub,a.__rmi_stub_id)}return a},acquire:function(a,b){if(this.__instances[b])return this.__instances[b];if(BetaJS.Types.is_string(a)&&(a=BetaJS.Scopes.resolve(a)),!a||!a.ancestor_of(BetaJS.RMI.Stub))return null;var c=new a;this.__instances[BetaJS.Ids.objectId(c,b)]=c;var d=this;return c.__send=function(a,c){return c=BetaJS.Objs.map(c,d._serializeValue,d),d.__channel.send(b+":"+a,c).mapSuccess(function(a){return this._unserializeValue(a)},d)},c},release:function(a){var b=BetaJS.Ids.objectId(a);this.__instances[b]&&(a.off(null,null,this),a.destroy(),delete this.__instances[b])}}),BetaJS.Class.extend("BetaJS.RMI.Peer",{constructor:function(a,b){this._inherited(BetaJS.RMI.Peer,"constructor"),this.__sender=a,this.__receiver=b,this.__client_sender=this._auto_destroy(new BetaJS.Channels.SenderMultiplexer(a,"client")),this.__server_sender=this._auto_destroy(new BetaJS.Channels.SenderMultiplexer(a,"server")),this.__client_receiver=this._auto_destroy(new BetaJS.Channels.ReceiverMultiplexer(b,"server")),this.__server_receiver=this._auto_destroy(new BetaJS.Channels.ReceiverMultiplexer(b,"client")),this.client=this._auto_destroy(new BetaJS.RMI.Client(this.__client_sender,this.__client_receiver)),this.server=this._auto_destroy(new BetaJS.RMI.Server(this.__server_sender,this.__server_receiver)),this.client.server=this.server,this.server.client=this.client},acquire:function(a,b){return this.client.acquire(a,b)},release:function(a){this.client.release(a)},registerInstance:function(a,b){return this.server.registerInstance(a,b)},unregisterInstance:function(a){this.server.unregisterInstance(a)}}),BetaJS.Promise={Promise:function(a,b,c){this.__value=b?null:a||null,this.__error=b?b:null,this.__isFinished=c,this.__hasError=!!b,this.__resultPromise=null,this.__callbacks=[]},create:function(a,b){return new this.Promise(a,b,arguments.length>0)},value:function(a){return this.is(a)?a:new this.Promise(a,null,!0)},eventualValue:function(a){var b=new this.Promise;return BetaJS.Async.eventually(function(){b.asyncSuccess(a)}),b},error:function(a){return this.is(a)?a:new this.Promise(null,a,!0)},box:function(a,b,c){try{var d=a.apply(b||this,c||[]);return this.is(d)?d:this.value(d)}catch(e){return this.error(e)}},tryCatch:function(a,b){try{return this.value(a.apply(b||this))}catch(c){return this.error(c)}},funcCallback:function(a,b){var c=BetaJS.Functions.getArguments(arguments,1);BetaJS.Types.is_function(a)?(c=BetaJS.Functions.getArguments(arguments,1),b=a,a=this):c=BetaJS.Functions.getArguments(arguments,2);var d=this.create();return c.push(d.asyncCallbackFunc()),b.apply(a,c),d},and:function(a){var b=this.create();return b.__promises=[],b.__successCount=0,b.__values=[],b.__errorPromise=null,b.and=function(a){if(a=a||[],this.__ended)return this;BetaJS.Types.is_array(a)||(a=[a]);for(var b=0;b<a.length;++b){var c=this.__promises.length;this.__promises.push(a[b]),this.__values.push(null),a[b].isFinished()?a[b].hasValue()?(this.__successCount++,this.__values[c]=a[b].value()):this.__errorPromise=a[b]:a[b].callback(function(b,c){b?this.__errorPromise=a[this.idx]:(this.promise.__successCount++,this.promise.__values[this.idx]=c),this.promise.results()},{promise:this,idx:c})}return this},b.end=function(){return this.__ended=!0,this.results(),this},b.results=function(){return this.__ended&&this.__errorPromise?this.asyncError(this.__errorPromise.err(),this.__errorPromise):this.__ended&&this.__successCount==this.__promises.length&&this.asyncSuccess(this.__values),this},b.successUnfold=function(a,b,c){return this.success(function(){return a.apply(b,arguments)},b,c)},b.and(a),b},func:function(a){for(var b=BetaJS.Functions.getArguments(arguments,1),c=[],d=0;d<b.length;++d)this.is(b[d])&&c.push(b[d]);var e=this.create();return this.and(c).end().success(function(){for(var c=[],d=0;d<b.length;++d)c[d]=this.is(b[d])?b[d].value():b[d];var f=a.apply(this,c);this.is(f)?f.forwardCallback(e):e.asyncSuccess(f)},this).forwardError(e),e},methodArgs:function(a,b,c){return c.unshift(function(){return b.apply(a,arguments)}),this.func.apply(this,c)},method:function(a,b){return this.methodArgs(a,b,BetaJS.Functions.getArguments(arguments,2))},newClass:function(a){var b=BetaJS.Functions.getArguments(arguments,1);return b.unshift(BetaJS.Functions.newClassFunc(a)),this.func.apply(this,b)},is:function(a){return a&&BetaJS.Types.is_object(a)&&a.classGuid==BetaJS.Promise.Promise.prototype.classGuid}},BetaJS.Promise.Promise.prototype.classGuid="7e3ed52f-22da-4e9c-95a4-e9bb877a3935",BetaJS.Promise.Promise.prototype.success=function(a,b,c){return this.callback(a,b,c,"success")},BetaJS.Promise.Promise.prototype.error=function(a,b,c){return this.callback(a,b,c,"error")},BetaJS.Promise.Promise.prototype.callback=function(a,b,c,d){var e={type:d||"callback",func:a,options:c||{},context:b};return this.__isFinished?this.triggerResult(e):this.__callbacks.push(e),this},BetaJS.Promise.Promise.prototype.triggerResult=function(a){if(!this.__isFinished)return this;if(a)"success"!=a.type||this.__hasError?"error"==a.type&&this.__hasError?a.func.call(a.context||this,this.__error,this.__resultPromise||this):"callback"==a.type&&a.func.call(a.context||this,this.__error,this.__value,this.__resultPromise||this):a.func.call(a.context||this,this.__value,this.__resultPromise||this);else{var b=this.__callbacks;this.__callbacks=[];for(var c=0;c<b.length;++c)this.triggerResult(b[c])}return this},BetaJS.Promise.Promise.prototype.value=function(){return this.__value},BetaJS.Promise.Promise.prototype.err=function(){return this.__error},BetaJS.Promise.Promise.prototype.isFinished=function(){return this.__isFinished},BetaJS.Promise.Promise.prototype.hasValue=function(){return this.__isFinished&&!this.__hasError},BetaJS.Promise.Promise.prototype.hasError=function(){return this.__isFinished&&this.__hasError},BetaJS.Promise.Promise.prototype.asyncSuccess=function(a,b){return this.__isFinished?this:(this.__resultPromise=b,this.__error=null,this.__isFinished=!0,this.__hasError=!1,this.__value=a,this.triggerResult())},BetaJS.Promise.Promise.prototype.forwardSuccess=function(a){return this.success(a.asyncSuccess,a),this},BetaJS.Promise.Promise.prototype.asyncError=function(a,b){return this.__isFinished?this:(this.__resultPromise=b,this.__isFinished=!0,this.__hasError=!0,this.__error=a,this.__value=null,this.triggerResult())},BetaJS.Promise.Promise.prototype.forwardError=function(a){return this.error(a.asyncError,a),this},BetaJS.Promise.Promise.prototype.asyncCallback=function(a,b,c){return a?this.asyncError(a,c):this.asyncSuccess(b,c)},BetaJS.Promise.Promise.prototype.asyncCallbackFunc=function(){return BetaJS.Functions.as_method(BetaJS.Promise.Promise.prototype.asyncCallback,this)},BetaJS.Promise.Promise.prototype.forwardCallback=function(a){return this.callback(a.asyncCallback,a),this},BetaJS.Promise.Promise.prototype.mapSuccess=function(a,b){var c=BetaJS.Promise.create();return this.forwardError(c).success(function(d,e){var f=a.call(b||c,d,e);BetaJS.Promise.is(f)?f.forwardCallback(c):c.asyncSuccess(f)}),c},BetaJS.Promise.Promise.prototype.mapError=function(a,b){var c=BetaJS.Promise.create();return this.forwardSuccess(c).error(function(d,e){var f=a.call(b||c,d,e);BetaJS.Promise.is(f)?f.forwardCallback(c):c.asyncError(f)}),c},BetaJS.Promise.Promise.prototype.mapCallback=function(a,b){var c=BetaJS.Promise.create();return this.callback(function(d,e,f){var g=a.call(b||c,d,e,f);BetaJS.Promise.is(g)?g.forwardCallback(c):c.asyncCallback(d?g:d,d?e:g,f)}),c},BetaJS.Promise.Promise.prototype.and=function(a){var b=BetaJS.Promise.and(this);return b.and(a)},BetaJS.Structures={},BetaJS.Structures.AvlTree={empty:function(){return null},singleton:function(a){return{data:a,left:null,right:null,height:1}},min:function(a){return a.left?this.min(a.left):a.data},max:function(a){return a.right?this.max(a.right):a.data},height:function(a){return a?a.height:0},height_join:function(a,b){return 1+Math.max(this.height(a),this.height(b))},create:function(a,b,c){return{data:a,left:b,right:c,height:this.height_join(b,c)}},balance:function(a,b,c){return this.height(b)>this.height(c)+2?this.height(b.left)>=this.height(b.right)?this.create(b.data,b.left,this.create(a,b.right,c)):this.create(b.right.data,this.create(b.data,b.left,b.right.left),this.create(a,b.right.right,c)):this.height(c)>this.height(b)+2?this.height(c.right)>=this.height(c.left)?this.create(c.data,this.create(a,b,c.left),c.right):this.create(c.left.data,this.create(a,b,c.left.left),this.create(c.data,c.left.right,c.right)):this.create(a,b,c)},__add_left:function(a,b){return b?this.balance(b.data,this.__add_left(a,b.left),b.right):this.singleton(a)},__add_right:function(a,b){return b?this.balance(b.data,b.data,this.__add_right(a,b.right)):this.singleton(a)},join:function(a,b,c){return b?c?this.height(b)>this.height(c)+2?this.balance(b.data,b.left,this.join(a,b.right,c)):this.height(c)>this.height(b)+2?this.balance(c.data,this.join(a,b,c.left),c.right):this.create(a,b,c):this.__add_right(a,b):this.__add_left(a,c)},take_min:function(a){if(!a.left)return[a.data,a.right];var b=this.take_min(a.left);return[b[0],this.join(a.data,b[1],a.right)]},take_max:function(a){if(!a.right)return[a.data,a.left];var b=this.take_max(a.right);return[b[0],this.join(a.data,a.left,b[1])]},rereoot:function(a,b){if(!a||!b)return a||b;if(this.height(a)>this.height(b)){var c=this.take_max(a);return this.join(c[0],c[1],b)}var d=this.take_min(b);return this.join(d[0],a,d[1])},take_min_iter:function(a){return a?a.left?this.take_min_iter(this.create(a.left.data,a.left.left,this.create(a.data,a.left.right,a.right))):[a.data,a.left]:null},take_max_iter:function(a){return a?a.right?this.take_max_iter(this.create(a.right.data,this.create(a.data,a.left,a.right.left),a.right.right)):[a.data,a.right]:null}},BetaJS.Structures.TreeMap={empty:function(a){return{root:null,length:0,compare:a||function(a,b){return a>b?1:b>a?-1:0}}},is_empty:function(a){return!a.root},length:function(a){return a.length},__add:function(a,b,c,d){var e={key:a,value:b};if(!d)return c.length++,BetaJS.Data.AvlTree.singleton(e);var f=c.compare(a,d.data.key);return 0===f?(d.data=e,d):0>f?BetaJS.Data.AvlTree.balance(d.data,this.__add(a,b,c,d.left),d.right):BetaJS.Data.AvlTree.balance(d.data,d.left,this.__add(a,b,c,d.right))},add:function(a,b,c){return c.root=this.__add(a,b,c,c.root),c},singleton:function(a,b,c){return this.add(a,b,this.empty(c))},__find:function(a,b,c){if(!c)return null;var d=b.compare(a,c.data.key);return 0===d?c.data.value:this.__find(a,b,0>d?c.left:c.right)},find:function(a,b){return this.__find(a,b,b.root)},__iterate:function(a,b,c,d){return b?this.__iterate(a,b.left,c,d)&&c.call(d,b.data.key,b.data.value)!==!1&&this.__iterate(a,b.right,c,d):!0},iterate:function(a,b,c){this.__iterate(a,a.root,b,c)},__iterate_from:function(a,b,c,d,e){if(!c)return!0;var f=b.compare(a,c.data.key);return 0>f&&!this.__iterate_from(a,b,c.left,d,e)?!1:0>=f&&d.call(e,c.data.key,c.data.value)===!1?!1:this.__iterate_from(a,b,c.right,d,e)},iterate_from:function(a,b,c,d){this.__iterate_from(a,b,b.root,c,d)},iterate_range:function(a,b,c,d,e){this.iterate_from(a,c,function(a,f){return c.compare(a,b)<=0&&d.call(e,a,f)!==!1},this)}},BetaJS.Class.extend("BetaJS.KeyValue.KeyValueStore",[BetaJS.Events.EventsMixin,{mem:function(a){return this._mem(a)},get:function(a){return this._get(a)},set:function(a,b){this._set(a,b),this.trigger("change:"+a,b)},remove:function(a){this._remove(a)}}]),BetaJS.KeyValue.KeyValueStore.extend("BetaJS.KeyValue.PrefixKeyValueStore",{constructor:function(a,b){this._inherited(BetaJS.KeyValue.PrefixKeyValueStore,"constructor"),this.__kv=a,this.__prefix=b},_mem:function(a){return this.__kv.mem(this.__prefix+a)},_get:function(a){return this.__kv.get(this.__prefix+a)},_set:function(a,b){this.__kv.set(this.__prefix+a,b)},_remove:function(a){this.__kv.remove(this.__prefix+a)}}),BetaJS.KeyValue.KeyValueStore.extend("BetaJS.KeyValue.MemoryKeyValueStore",{constructor:function(a,b){this._inherited(BetaJS.KeyValue.MemoryKeyValueStore,"constructor"),this.__data=BetaJS.Objs.clone(a,b?1:0)},_mem:function(a){return a in this.__data},_get:function(a){return this.__data[a]},_set:function(a,b){this.__data[a]=b},_remove:function(a){delete this.__data[a]}}),BetaJS.KeyValue.MemoryKeyValueStore.extend("BetaJS.KeyValue.LocalKeyValueStore",{constructor:function(){this._inherited(BetaJS.KeyValue.LocalKeyValueStore,"constructor",localStorage,!1)}}),BetaJS.KeyValue.KeyValueStore.extend("BetaJS.KeyValue.DefaultKeyValueStore",{constructor:function(a,b){this._inherited(BetaJS.KeyValue.DefaultKeyValueStore,"constructor"),this.__kv=a,this.__def=b},_mem:function(a){return this.__kv.mem(a)||this.__def.mem(a)},_get:function(a){return this.__kv.mem(a)?this.__kv.get(a):this.__def.get(a)},_set:function(a,b){this.__kv.set(a,b)},_remove:function(a){this.__kv.remove(a)}}),BetaJS.Class.extend("BetaJS.Net.AbstractAjax",{constructor:function(a){this._inherited(BetaJS.Net.AbstractAjax,"constructor"),this.__options=BetaJS.Objs.extend({method:"GET",data:{}},a)},syncCall:function(a){try{return this._syncCall(BetaJS.Objs.extend(BetaJS.Objs.clone(this.__options,1),a))}catch(b){throw b=BetaJS.Exceptions.ensure(b),b.assert(BetaJS.Net.AjaxException),b}},asyncCall:function(a){return this._asyncCall(BetaJS.Objs.extend(BetaJS.Objs.clone(this.__options,1),a))},_syncCall:function(){throw"Unsupported"},_asyncCall:function(){throw"Unsupported"}}),BetaJS.Exceptions.Exception.extend("BetaJS.Net.AjaxException",{constructor:function(a,b,c){this._inherited(BetaJS.Net.AjaxException,"constructor",a+": "+b),this.__status_code=a,this.__status_text=b,this.__data=c},status_code:function(){return this.__status_code},status_text:function(){return this.__status_text},data:function(){return this.__data},json:function(){var a=this._inherited(BetaJS.Net.AjaxException,"json");return a.data=this.data(),a}}),BetaJS.Channels.Sender.extend("BetaJS.Net.SocketSenderChannel",{constructor:function(a,b,c){this._inherited(BetaJS.Net.SocketSenderChannel,"constructor"),this.__socket=a,this.__message=b,this.__ready=BetaJS.Types.is_defined(c)?c:!0,this.__cache=[]},_send:function(a,b){this.__ready?this.__socket.emit(this.__message,{message:a,data:b}):this.__cache.push({message:a,data:b})},ready:function(){this.__ready=!0;for(var a=0;a<this.__cache.length;++a)this._send(this.__cache[a].message,this.__cache[a].data);this.__cache=[]},unready:function(){this.__ready=!1},socket:function(){return arguments.length>0&&(this.__socket=arguments[0]),this.__socket}}),BetaJS.Channels.Receiver.extend("BetaJS.Net.SocketReceiverChannel",{constructor:function(a,b){this._inherited(BetaJS.Net.SocketReceiverChannel,"constructor"),this.__message=b,this.socket(a)},socket:function(){if(arguments.length>0&&(this.__socket=arguments[0],this.__socket)){var a=this;this.__socket.on(this.__message,function(b){a._receive(b.message,b.data)})}return this.__socket}}),BetaJS.Net=BetaJS.Net||{},BetaJS.Net.HttpHeader={HTTP_STATUS_OK:200,HTTP_STATUS_CREATED:201,HTTP_STATUS_PAYMENT_REQUIRED:402,HTTP_STATUS_FORBIDDEN:403,HTTP_STATUS_NOT_FOUND:404,HTTP_STATUS_PRECONDITION_FAILED:412,HTTP_STATUS_INTERNAL_SERVER_ERROR:500,format:function(a,b){var c="";return c=a==this.HTTP_STATUS_OK?"OK":a==this.HTTP_STATUS_CREATED?"Created":a==this.HTTP_STATUS_PAYMENT_REQUIRED?"Payment Required":a==this.HTTP_STATUS_FORBIDDEN?"Forbidden":a==this.HTTP_STATUS_NOT_FOUND?"Not found":a==this.HTTP_STATUS_PRECONDITION_FAILED?"Precondition Failed":a==this.HTTP_STATUS_INTERNAL_SERVER_ERROR?"Internal Server Error":"Other Error",b?a+" "+c:c}},BetaJS.Net=BetaJS.Net||{},BetaJS.Net.Uri={build:function(a){var b="";return a.username&&(b+=a.username+":"),a.password&&(b+=a.password+"@"),b+=a.server,a.port&&(b+=":"+a.port),a.path&&(b+="/"+a.path),b},encodeUriParams:function(a,b){b=b||"";var c=[];return BetaJS.Objs.iter(a,function(a,d){BetaJS.Types.is_object(a)?c=c.concat(this.encodeUriParams(a,b+d+"_")):c.push(b+d+"="+encodeURI(a))},this),c.join("&")},appendUriParams:function(a,b,c){return BetaJS.Types.is_empty(b)?a:a+(-1!=a.indexOf("?")?"&":"?")+this.encodeUriParams(b,c)},parse:function(a,b){for(var c=b?this.__parse_strict_regex:this.__parse_loose_regex,d=c.exec(a),e={},f=0;f<this.__parse_key.length;++f)e[this.__parse_key[f]]=d[f]||"";return e.queryKey={},e[this.__parse_key[12]].replace(this.__parse_key_parser,function(a,b,c){b&&(e.queryKey[b]=c)}),e},__parse_strict_regex:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,__parse_loose_regex:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,__parse_key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],__parse_key_parser:/(?:^|&)([^&=]*)=?([^&]*)/g};