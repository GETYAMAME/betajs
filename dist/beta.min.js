/*! betajs - v0.0.2 - 2014-09-25, Copyright (c) Oliver Friedmann & Victor Lingenthal, MIT Software License. */var BetaJS=BetaJS||{};"undefined"!=typeof module&&"exports"in module&&(module.exports=BetaJS),BetaJS.Types={is_object:function(t){return"object"==typeof t},is_array:function(t){return"[object Array]"===Object.prototype.toString.call(t)},is_undefined:function(t){return t===void 0},is_null:function(t){return null===t},is_none:function(t){return this.is_undefined(t)||this.is_null(t)},is_defined:function(t){return t!==void 0},is_empty:function(t){if(this.is_none(t))return!0;if(this.is_array(t))return 0===t.length;if(this.is_object(t)){for(var e in t)return!1;return!0}return!1},is_string:function(t){return"string"==typeof t},is_function:function(t){return"function"==typeof t},is_boolean:function(t){return"boolean"==typeof t},compare:function(t,e){if(BetaJS.Types.is_boolean(t)&&BetaJS.Types.is_boolean(e))return t==e?0:t?1:-1;if(BetaJS.Types.is_array(t)&&BetaJS.Types.is_array(e)){for(var i=t.length,s=e.length,n=Math.min(i,s),r=0;n>r;++r){var o=this.compare(t[r],e[r]);if(0!==o)return o}return i==s?0:i>s?1:-1}return t.localeCompare(e)},parseBool:function(t){return this.is_boolean(t)?t:"true"==t?!0:"false"==t?!1:null},type_of:function(t){return this.is_array(t)?"array":typeof t}},BetaJS.Strings={nl2br:function(t){return(t+"").replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,"$1<br />$2")},htmlentities:function(t){return(t+"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;")},JS_ESCAPES:{"'":"'","\\":"\\","\r":"r","\n":"n","	":"t","\u2028":"u2028","\u2029":"u2029"},JS_ESCAPER_REGEX:function(){return this.JS_ESCAPER_REGEX_CACHED||(this.JS_ESCAPER_REGEX_CACHED=RegExp(BetaJS.Objs.keys(this.JS_ESCAPES).join("|"),"g")),this.JS_ESCAPER_REGEX_CACHED},js_escape:function(t){var e=this;return t.replace(this.JS_ESCAPER_REGEX(),function(t){return"\\"+e.JS_ESCAPES[t]})},starts_with:function(t,e){return t.substring(0,e.length)==e},ends_with:function(t,e){return-1!==t.indexOf(e,t.length-e.length)},strip_start:function(t,e){return this.starts_with(t,e)?t.substring(e.length):t},last_after:function(t,e){return t.substring(t.lastIndexOf(e)+e.length,t.length)},EMAIL_ADDRESS_REGEX:/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/,is_email_address:function(t){return this.EMAIL_ADDRESS_REGEX.test(t)},STRIP_HTML_TAGS:["script","style","head"],STRIP_HTML_REGEX:/<\/?([a-z][a-z0-9]*)\b[^>]*>?/gi,STRIP_HTML_COMMENT_REGEX:/<![^>]*>/gi,strip_html:function(t){var e=t;for(i=0;this.STRIP_HTML_TAGS.length>i;++i)e=e.replace(RegExp("<"+this.STRIP_HTML_TAGS[i]+".*</"+this.STRIP_HTML_TAGS[i]+">","i"),"");return e=e.replace(this.STRIP_HTML_REGEX,"").replace(this.STRIP_HTML_COMMENT_REGEX,"")},nltrim:function(t){var e=t.replace(/\t/g,"  ").split("\n"),i=null,s=0;for(s=0;e.length>s;++s){for(var n=0;e[s].length>n&&" "==e[s].charAt(n);)++n;e[s].length>n&&(i=null===i?n:Math.min(n,i))}for(s=0;e.length>s;++s)e[s]=e[s].substring(i);return e.join("\n").trim()},read_cookie_string:function(t,e){var i="; "+t,s=i.split("; "+e+"=");return 2==s.length?s.pop().split(";").shift():null},write_cookie_string:function(t,e,i){var s="; "+t,n=s.split("; "+e+"=");return 2==n.length&&(s=n[0]+n[1].substring(n[1].indexOf(";"))),e+"="+i+s},capitalize:function(t){return t.replace(/\w\S*/g,function(t){return t.charAt(0).toUpperCase()+t.substr(1).toLowerCase()})},email_get_name:function(t){t=t||"";var e=t.split("<");return t=e[0].trim(),!t&&e.length>1&&(e=e[1].split(">"),t=e[0].trim()),t=t.replace(/['"]/g,"").replace(/[\\._@]/g," "),this.capitalize(t)},email_get_email:function(t){t=t||"";var e=t.split("<");return t=e[0].trim(),e.length>1&&(e=e[1].split(">"),t=e[0].trim()),t=t.replace(/'/g,"").replace(/"/g,"").trim()},email_get_salutatory_name:function(t){return t=t||"",this.email_get_name(t).split(" ")[0]}},BetaJS.Functions={as_method:function(t,e){return function(){return t.apply(e,arguments)}},once:function(t){var e=!1,i=!1;return function(){return i?e:(i=!0,e=t.apply(this,arguments),t=null,e)}},getArguments:function(t,e){return Array.prototype.slice.call(t,e||0)},matchArgs:function(t,e){var i=0,s={};for(var n in e)(e[n]===!0||BetaJS.Types.type_of(t[i])==e[n])&&(s[n]=t[i],i++);return s}},BetaJS.SyncAsync={eventually:function(t,e,i){var s=setTimeout(function(){clearTimeout(s),BetaJS.Types.is_array(e)||(i=e,e=[]),t.apply(i||this,e||[])},0)},syncToAsync:function(t,e){var i=BetaJS.Functions.matchArgs(BetaJS.Functions.getArguments(arguments,2),{params:"array",context:"object"});try{t&&t.success&&t.success.call(t.context||this,e.apply(i.context||this,i.params||[]))}catch(s){t&&t.exception&&t.exception.call(t.context||this,s)}},either:function(t,e,i,s){var n=BetaJS.Functions.matchArgs(BetaJS.Functions.getArguments(arguments,4),{params:"array",context:"object"});if(!t||e||t.sync)return this.eitherSync(t,i,n.params,n.context);var r=n.params||[];return r.push(t),s.apply(n.context||this,r),null},eitherSync:function(t,e){var i=BetaJS.Functions.matchArgs(BetaJS.Functions.getArguments(arguments,2),{params:"array",context:"object"}),s=i.context||this,n=i.params||[];return t?(this.syncToAsync(t,e,n,s),null):e.apply(s,n)},SYNC:1,ASYNC:2,ASYNCSINGLE:3,toCallbackType:function(t,e){return e==this.ASYNCSINGLE?function(e,i){var s=e?"exception":"success";s in t&&t[s].call(t.context||this,e?e:i)}:t},then:function(){var t=BetaJS.Functions.matchArgs(arguments,{func_ctx:"object",func:!0,params:"array",type:"number",callbacks:!0,success_ctx:"object",success:"function",exception:"function"}),e=t.func_ctx||this,i=t.func,s=t.params||[],n=t.callbacks,r=t.type||(!n||n.sync?this.SYNC:this.ASYNC),o=t.success_ctx||e,a=t.success,_=t.exception;if(r!=this.SYNC)s.push(this.toCallbackType({context:n.context,success:a?function(t){a.call(o,t,n)}:n.success,exception:_?function(t){_.call(o,t,n)}:n.exception},r)),i.apply(e,s);else if(n)try{a?a.call(o,i.apply(e,s),n):n.success.call(n.context||this,i.apply(e,s))}catch(c){if(_)_.call(o,c,n);else{if(!n.exception)throw c;n.exception.call(n.context||this,c)}}else try{var u=i.apply(e,s);return a&&a.call(o,u,{sync:!0,success:function(t){u=t},exception:function(t){throw t}}),u}catch(c){if(_)return _.call(o,c,{sync:!0,success:function(t){u=t},exception:function(t){throw t}}),u;throw c}return null},PROMISE_LAZY:1,PROMISE_ACTIVE:2,PROMISE_SUCCESS:3,PROMISE_EXCEPTION:4,lazy:function(){var t=BetaJS.Functions.matchArgs(arguments,{func_ctx:"object",func:!0,params:"array",type:"number"});return{state:this.PROMISE_LAZY,func_ctx:t.func_ctx||this,func:t.func,params:t.params||[],type:t.type||this.ASYNC}},promise:function(){var t=BetaJS.Functions.matchArgs(arguments,{func_ctx:"object",func:!0,params:"array",type:"number"}),e=t.func_ctx||this,i=t.func,s=t.params||[],n=t.type||this.ASYNC;if(n!=this.SYNC){var r={state:this.PROMISE_ACTIVE,listeners:[]};return s.push({context:r,success:function(t){this.state=BetaJS.SyncAsync.PROMISE_SUCCESS,this.result=t;for(var e=0;this.listeners.length>e;++e)this.listeners[e].success.call(this.listeners[e].context||this,t)},exception:function(t){this.state=BetaJS.SyncAsync.PROMISE_EXCEPTION,this.exception=t;for(var e=0;this.listeners.length>e;++e)this.listeners[e].exception.call(this.listeners[e].context||this,t)}}),i.apply(e,s),r}try{return{state:this.PROMISE_SUCCESS,result:i.apply(e,s)}}catch(o){return{state:this.PROMISE_EXCEPTION,exception:o}}},reveal:function(t,e){if(t.state==this.PROMISE_LAZY){var i=this.promise(t.func_ctx,t.func,t.params,t.type);for(var s in i)t[s]=i[s]}t.state==this.PROMISE_ACTIVE?t.listeners.push(e):t.state==this.PROMISE_SUCCESS?e.success.call(e.context||this,t.result):t.state==this.PROMISE_EXCEPTION&&e.exception.call(e.context||this,t.exception)},join:function(t,e){for(var i={count:t.length,exception:!1,results:[]},s=0;t.length>s;++s)i.results.push(null),this.reveal(t[s],{context:{monitor:i,index:s},sync:e&&e.sync,success:function(t){this.monitor.count=this.monitor.count-1,this.monitor.exception||(this.monitor.results[this.index]=t,0>=this.monitor.count&&e&&e.success.apply(e.context||this,this.monitor.results))},exception:function(t){if(this.monitor.count=this.monitor.count-1,!this.monitor.exception){if(this.monitor.exception=!0,!e)throw t;e.exception.apply(e.context||this,t)}}});return i.results},mapSuccess:function(t,e){var i=BetaJS.Objs.clone(t,1);return i.success=e,i},mapException:function(t,e){var i=BetaJS.Objs.clone(t,1);return i.exception=e,i},callback:function(t,e){if(t&&("success"==e||"exception"==e)){var i=t.context||this,s=BetaJS.Functions.getArguments(arguments,2);e in t&&t[e].apply(i,s),"complete"in t&&t.complete.apply(i)}}},BetaJS.SyncAsync.SyncAsyncMixin={supportsSync:function(){return this._supportsSync},supportsAsync:function(){return this._supportsAsync},eitherSync:function(t,e,i){return BetaJS.SyncAsync.eitherSync(t,e,i||[],this)},either:function(t,e,i,s,n){return BetaJS.Types.is_undefined(s)&&(s=!this.supportsAsync()),BetaJS.SyncAsync.either(t,s,e,i,n||[],this)},eitherSyncFactory:function(t,e,i,s){return BetaJS.SyncAsync.eitherSync(e,function(){return this[t]||(this[t]=i.apply(this,s)),this[t]},this)},eitherAsyncFactory:function(t,e,i){var s=this;return this.either(e,function(){return s[t]},function(){i.call(this,BetaJS.SyncAsync.mapSuccess(e,function(i){s[t]=i,s.callback(e,"success",i)}))},t in this,this)},eitherFactory:function(t,e,i,s,n){var r=this;return this.either(e,function(){return this[t]||(this[t]=i.apply(this,n)),this[t]},function(){s.call(this,BetaJS.SyncAsync.mapSuccess(e,function(i){r[t]=i,e.success.call(this,i)}))},this[t]||!this.supportsAsync())},then:function(){var t=BetaJS.Functions.matchArgs(arguments,{func_ctx:"object",func:!0,params:"array",type:"number",callbacks:!0,success_ctx:"object",success:!0,exception:"function"}),e=t.func_ctx||this,i=t.func,s=t.params||[],n=t.callbacks,r=t.type||(n&&this.supportsAsync()?BetaJS.SyncAsync.ASYNC:BetaJS.SyncAsync.SYNC),o=t.success_ctx||this;return BetaJS.SyncAsync.then(e,i,s,r,n,o,t.success,t.exception)},thenSingle:function(){var t=BetaJS.Functions.matchArgs(arguments,{func_ctx:"object",func:!0,params:"array",type:"number",callbacks:!0,success_ctx:"object",success:!0}),e=t.func_ctx||this,i=t.func,s=t.params||[],n=t.callbacks,r=t.type||(n&&this.supportsAsync()?BetaJS.SyncAsync.ASYNCSINGLE:BetaJS.SyncAsync.SYNC),o=t.success_ctx||this,a=t.success;return BetaJS.SyncAsync.then(e,i,s,r,n,o,a)},promise:function(){var t=BetaJS.Functions.matchArgs(arguments,{func_ctx:"object",func:!0,params:"array",type:"number"});return BetaJS.SyncAsync.promise(t.func_ctx||this,t.func,t.params||[],t.type)},join:function(t,e){return BetaJS.SyncAsync.join(t,e)},delegate:function(){var t=BetaJS.Functions.matchArgs(arguments,{func_ctx:"object",func:!0,params:"array",callbacks:"object"}),e=t.func_ctx||this,i=t.params||[];return t.callbacks?this.supportsAsync()&&!t.callbacks.sync?(i.push(t.callbacks),t.func.apply(e,i)):BetaJS.SyncAsync.syncToAsync(t.callbacks,t.func,i,e):t.func.apply(e,i)},callback:function(){return BetaJS.SyncAsync.callback.apply(this,arguments)}},BetaJS.Scopes={base:function(t,e,i){if(!BetaJS.Types.is_string(t))return t;if(e)return e[t];try{if(window&&window[t])return window[t]}catch(s){}try{if(global&&global[t])return global[t]}catch(s){}try{if(module&&module.exports)return module.exports}catch(s){}if(!i)return null;try{if(window)return window[t]={},window[t]}catch(s){}try{if(global)return global[t]={},global[t]}catch(s){}try{if(module&&module.exports)return module.exports={},module.exports}catch(s){}return null},resolve:function(t,e){if(!BetaJS.Types.is_string(t))return t;for(var i=t.split("."),s=this.base(i[0],e),n=1;i.length>n;++n)s=s[i[n]];return s},touch:function(t,e){if(!BetaJS.Types.is_string(t))return t;for(var i=t.split("."),s=this.base(i[0],e,!0),n=1;i.length>n;++n)i[n]in s||(s[i[n]]={}),s=s[i[n]];return s},set:function(t,e,i){if(!BetaJS.Types.is_string(e))return e;for(var s=e.split("."),n=this.base(s[0],i,!0),r=1;s.length-1>r;++r)s[r]in n||(n[s[r]]={}),n=n[s[r]];return s.length>1&&(n[s[s.length-1]]=t),t}},BetaJS.Ids={__uniqueId:0,uniqueId:function(t){return(t||"")+this.__uniqueId++},objectId:function(t,e){return e!==void 0?t.__cid=e:t.__cid||(t.__cid=this.uniqueId("cid_")),t.__cid}},BetaJS.Tokens={generate_token:function(t){t=t||16;for(var e="";t>e.length;)e+=Math.random().toString(36).substr(2);return e.substr(0,t)}},BetaJS.Objs={count:function(t){if(BetaJS.Types.is_array(t))return t.length;var e=0;for(var i in t)e++;return e},clone:function(t,e){return!e||0>=e?t:BetaJS.Types.is_array(t)?t.slice(0):BetaJS.Types.is_object(t)?this.extend({},t,e-1):t},acyclic_clone:function(t,e){if(null===t||!BetaJS.Types.is_object(t))return t;var i="__acyclic_cloned";if(t[i])return e||"CYCLE";t[i]=!0;var s={};for(var n in t)n!=i&&(s[n]=this.acyclic_clone(t[n],e));return delete t[i],s},extend:function(t,e,i){if(t=t||{},e)for(var s in e)t[s]=this.clone(e[s],i);return t},tree_extend:function(t,e,i){if(t=t||{},e)for(var s in e)t[s]=s in t&&BetaJS.Types.is_object(t[s])&&BetaJS.Types.is_object(e[s])?this.tree_extend(t[s],e[s],i):this.clone(e[s],i);return t},merge:function(t,e,i){t=t||{},e=e||{};var s={},n=BetaJS.Objs.extend(BetaJS.Objs.keys(t,!0),BetaJS.Objs.keys(e,!0));for(var r in n){var o=r in i?i[r]:"primary";"primary"==o||"secondary"==o?(r in e||r in t)&&(s[r]="primary"==o?r in e?e[r]:t[r]:r in t?t[r]:e[r]):BetaJS.Types.is_function(o)?s[r]=o(t[r],e[r]):BetaJS.Types.is_object(o)&&(s[r]=BetaJS.Objs.merge(t[r],e[r],o))}return s},tree_merge:function(t,e){t=t||{},e=e||{};var i={},s=BetaJS.Objs.extend(BetaJS.Objs.keys(t,!0),BetaJS.Objs.keys(e,!0));for(var n in s)i[n]=BetaJS.Types.is_object(e[n])&&t[n]?BetaJS.Objs.tree_merge(t[n],e[n]):n in e?e[n]:t[n];return i},keys:function(t,e){var i=null,s=null;if(BetaJS.Types.is_undefined(e)){i=[];for(s in t)i.push(s);return i}i={};for(s in t)i[s]=e;return i},map:function(t,e,i){var s=null;if(BetaJS.Types.is_array(t)){s=[];for(var n=0;t.length>n;++n)s.push(i?e.apply(i,[t[n],n]):e(t[n],n));return s}s={};for(var r in t)s[r]=i?e.apply(i,[t[r],r]):e(t[r],r);return s},values:function(t){var e=[];for(var i in t)e.push(t[i]);return e},filter:function(t,e,i){var s=null;if(BetaJS.Types.is_array(t)){s=[];for(var n=0;t.length>n;++n)(i?e.apply(i,[t[n],n]):e(t[n],n))&&s.push(t[n]);return s}s={};for(var r in t)(i?e.apply(i,[t[r],r]):e(t[r],r))&&(s[r]=t[r]);return s},equals:function(t,e,i){var s=null;if(i&&i>0){for(s in t)if(!s in e||!this.equals(t[s],e[s],i-1))return!1;for(s in e)if(!s in t)return!1;return!0}return t==e},iter:function(t,e,i){var s=null;if(BetaJS.Types.is_array(t)){for(var n=0;t.length>n;++n)if(s=i?e.apply(i,[t[n],n]):e(t[n],n),BetaJS.Types.is_defined(s)&&!s)return!1}else for(var r in t)if(s=i?e.apply(i,[t[r],r]):e(t[r],r),BetaJS.Types.is_defined(s)&&!s)return!1;return!0},intersect:function(t,e){var i={};for(var s in t)s in e&&(i[s]=t[s]);return i},contains_key:function(t,e){return BetaJS.Types.is_array(t)?BetaJS.Types.is_defined(t[e]):e in t},contains_value:function(t,e){if(BetaJS.Types.is_array(t)){for(var i=0;t.length>i;++i)if(t[i]===e)return!0}else for(var s in t)if(t[s]===e)return!0;return!1},exists:function(t,e,i){var s=!1;return BetaJS.Objs.iter(t,function(){return s=s||e.apply(this,arguments),!s},i),s},all:function(t,e,i){var s=!0;return BetaJS.Objs.iter(t,function(){return s=s&&e.apply(this,arguments)},i),s},objectify:function(t,e,i){var s={},n=BetaJS.Types.is_function(e);BetaJS.Types.is_undefined(e)&&(e=!0);for(var r=0;t.length>r;++r)s[t[r]]=n?e.apply(i||this,[t[r],r]):e;return s},peek:function(t){if(BetaJS.Types.is_array(t))return t.length>0?t[0]:null;for(var e in t)return t[e];return null},poll:function(t){if(BetaJS.Types.is_array(t))return t.shift();for(var e in t){var i=t[e];return delete t[e],i}return null},objectBy:function(){for(var t={},e=arguments.length/2,i=0;e>i;++i)t[arguments[2*i]]=arguments[2*i+1];return t},valueByIndex:function(t,e){if(e=e||0,BetaJS.Types.is_array(t))return t[e];for(var i in t){if(0===e)return t[i];e--}return null},keyByIndex:function(t,e){if(e=e||0,BetaJS.Types.is_array(t))return e;for(var i in t){if(0===e)return i;e--}return null}},BetaJS.Class=function(){},BetaJS.Class.classname="Class",BetaJS.Class.extend=function(t,e,i,s){e=e||[],BetaJS.Types.is_array(e)||(e=[e]),i=i||[],BetaJS.Types.is_array(i)||(i=[i]),s=s||[],BetaJS.Types.is_array(s)||(s=[s]);var n,r=this;BetaJS.Objs.iter(e,function(t){t.hasOwnProperty("constructor")&&(n=t.constructor)});var o=BetaJS.Types.is_defined(n);BetaJS.Types.is_defined(n)||(n=function(){r.apply(this,arguments)}),BetaJS.Objs.extend(n,r),BetaJS.Objs.iter(i,function(t){BetaJS.Objs.extend(n,t)});var a={};if(r.__class_statics_keys)for(var _ in r.__class_statics_keys)n[_]=BetaJS.Objs.clone(r[_],1);BetaJS.Objs.iter(s,function(t){BetaJS.Objs.extend(n,t),BetaJS.Objs.extend(a,BetaJS.Objs.keys(t,!0))}),r.__class_statics_keys&&BetaJS.Objs.extend(a,r.__class_statics_keys),n.__class_statics_keys=a,n.parent=r,n.children=[],n.extend=this.extend,r.children||(r.children=[]),r.children.push(n);var c=function(){};return c.prototype=r.prototype,n.prototype=new c,n.prototype.cls=n,n.classname=t,t&&BetaJS.Scopes.set(n,t),n.__notifications={},r.__notifications&&BetaJS.Objs.extend(n.__notifications,r.__notifications,1),BetaJS.Objs.iter(e,function(t){if(BetaJS.Objs.extend(n.prototype,t),"constructor"in t&&(n.prototype.constructor=t.constructor),t._notifications)for(var e in t._notifications)n.__notifications[e]||(n.__notifications[e]=[]),n.__notifications[e].push(t._notifications[e])}),delete n.prototype._notifications,o||(n.prototype.constructor=r.prototype.constructor),n},BetaJS.Class.prototype.constructor=function(){this._notify("construct")},BetaJS.Class.prototype.as_method=function(t){return BetaJS.Functions.as_method(this[t],this)},BetaJS.Class.prototype._auto_destroy=function(t){this.__auto_destroy_list||(this.__auto_destroy_list=[]);var e=t;BetaJS.Types.is_array(e)||(e=[e]);for(var i=0;e.length>i;++i)this.__auto_destroy_list.push(e[i]);return t},BetaJS.Class.prototype._notify=function(t){if(this.cls.__notifications){var e=Array.prototype.slice.call(arguments,1),i=this.cls.__notifications[t];if(i)for(var s in i){var n=BetaJS.Types.is_function(i[s])?i[s]:this[i[s]];if(!n)throw this.cls.classname+": Could not find "+t+" notification handler "+i[s];n.apply(this,e)}}},BetaJS.Class.prototype.destroy=function(){if(this._notify("destroy"),this.__auto_destroy_list)for(var t=0;this.__auto_destroy_list.length>t;++t)"destroy"in this.__auto_destroy_list[t]&&this.__auto_destroy_list[t].destroy();for(var e in this)delete this[e]},BetaJS.Class.prototype._inherited=function(t,e){return t.parent.prototype[e].apply(this,Array.prototype.slice.apply(arguments,[2]))},BetaJS.Class._inherited=function(t,e){return t.parent[e].apply(this,Array.prototype.slice.apply(arguments,[2]))},BetaJS.Class.prototype.instance_of=function(t){return this.cls.ancestor_of(t)},BetaJS.Class.ancestor_of=function(t){return this==t||this!=BetaJS.Class&&this.parent.ancestor_of(t)},BetaJS.Class.prototype.cid=function(){return BetaJS.Ids.objectId(this)},BetaJS.Class.prototype.cls=BetaJS.Class,BetaJS.Class.__notifications={},BetaJS.Class.is_class_instance=function(t){return t&&BetaJS.Types.is_object(t)&&"_inherited"in t&&"cls"in t},BetaJS.Exceptions={ensure:function(t){return t&&BetaJS.Types.is_object(t)&&"instance_of"in t&&t.instance_of(BetaJS.Exceptions.Exception)?t:new BetaJS.Exceptions.NativeException(t)}},BetaJS.Class.extend("BetaJS.Exceptions.Exception",{constructor:function(t){this._inherited(BetaJS.Exceptions.Exception,"constructor"),this.__message=t},assert:function(t){if(!this.instance_of(t))throw this;return this},callstack:function(){for(var t=[],e=arguments.callee.caller;e;)t.push(""+e),e=e.caller;return t},callstack_to_string:function(){return this.callstack().join("\n")},message:function(){return this.__message},toString:function(){return this.message()},format:function(){return this.cls.classname+": "+(""+this)+"\n\nCall Stack:\n"+this.callstack_to_string()},json:function(){return{classname:this.cls.classname,message:this.message()}}},{ensure:function(t){return t=BetaJS.Exceptions.ensure(t),t.assert(this),t}}),BetaJS.Exceptions.Exception.extend("BetaJS.Exceptions.NativeException",{constructor:function(t){this._inherited(BetaJS.Exceptions.NativeException,"constructor",t?"toString"in t?""+t:t:"null"),this.__object=t},object:function(){return this.__object}}),BetaJS.Class.extend("BetaJS.Lists.AbstractList",{_add:function(){},_remove:function(){},_get:function(){},_iterate:function(){},get_ident:function(t){var e=null;return this._iterate(function(i,s){return i==t?(e=s,!1):!0}),e},exists:function(t){return t&&null!==this.get_ident(t)},_ident_changed:function(){},constructor:function(t){this._inherited(BetaJS.Lists.AbstractList,"constructor"),this.__count=0,t&&BetaJS.Objs.iter(t,function(t){this.add(t)},this)},add:function(t){var e=this._add(t);return BetaJS.Types.is_defined(e)&&this.__count++,e},count:function(){return this.__count},clear:function(){this._iterate(function(t,e){return this.remove_by_ident(e),!0},this)},remove_by_ident:function(t){var e=this._remove(t);return BetaJS.Types.is_defined(e)&&this.__count--,e},remove:function(t){return this.remove_by_ident(this.get_ident(t))},remove_by_filter:function(t){this._iterate(function(e,i){return t(e)&&this.remove_by_ident(i),!0},this)},get:function(t){return this._get(t)},iterate:function(t,e){this._iterate(function(e,i){var s=t.apply(this,[e,i]);return BetaJS.Types.is_defined(s)?s:!0},e)},iterator:function(){return BetaJS.Iterators.ArrayIterator.byIterate(this.iterate,this)}}),BetaJS.Lists.AbstractList.extend("BetaJS.Lists.LinkedList",{constructor:function(t){this.__first=null,this.__last=null,this._inherited(BetaJS.Lists.LinkedList,"constructor",t)},_add:function(t){return this.__last={obj:t,prev:this.__last,next:null},this.__first?this.__last.prev.next=this.__last:this.__first=this.__last,this.__last},_remove:function(t){return t.next?t.next.prev=t.prev:this.__last=t.prev,t.prev?t.prev.next=t.next:this.__first=t.next,t.obj},_get:function(t){return t.obj},_iterate:function(t,e){for(var i=this.__first;i;){var s=i;if(i=i.next,!t.apply(e||this,[s.obj,s]))return}}}),BetaJS.Lists.AbstractList.extend("BetaJS.Lists.ObjectIdList",{constructor:function(t,e){this.__map={},this.__id_generator=e,this._inherited(BetaJS.Lists.ObjectIdList,"constructor",t)},_add:function(t){for(;;){var e=t.__cid;if(e||(e=this.__id_generator?BetaJS.Ids.objectId(t,this.__id_generator()):BetaJS.Ids.objectId(t),!this.__map[e]||!this.__id_generator))return this.__map[e]=t,e}return null},_remove:function(t){var e=this.__map[t];return delete this.__map[t],e},_get:function(t){return this.__map[t]},_iterate:function(t,e){for(var i in this.__map)t.apply(e||this,[this.__map[i],i])},get_ident:function(t){var e=BetaJS.Ids.objectId(t);return this.__map[e]?e:null}}),BetaJS.Lists.AbstractList.extend("BetaJS.Lists.ArrayList",{constructor:function(t,e){this.__idToIndex={},this.__items=[],e=e||{},"compare"in e&&(this._compare=e.compare),this._inherited(BetaJS.Lists.ArrayList,"constructor",t)},set_compare:function(t){this._compare=t,t&&this.sort()},get_compare:function(){return this._compare},sort:function(t){if(t=t||this._compare){this.__items.sort(t);for(var e=0;this.__items.length>e;++e)this.__ident_changed(this.__items[e],e);this._sorted()}},_sorted:function(){},re_index:function(t){if(!this._compare)return t;for(var e=this.__items.length-1,i=this.__items[t],s=t;e>s&&this._compare(this.__items[s],this.__items[s+1])>0;)this.__items[s]=this.__items[s+1],this.__ident_changed(this.__items[s],s),this.__items[s+1]=i,++s;if(s==t)for(;s>0&&0>this._compare(this.__items[s],this.__items[s-1]);)this.__items[s]=this.__items[s-1],this.__ident_changed(this.__items[s],s),this.__items[s-1]=i,--s;return s!=t&&(this.__ident_changed(i,s),this._re_indexed(i)),s},_re_indexed:function(){},_add:function(t){var e=this.__items.length;this.__items.push(t);var i=this.re_index(e);return this.__idToIndex[BetaJS.Ids.objectId(t)]=i,i},_remove:function(t){for(var e=this.__items[t],i=t+1;this.__items.length>i;++i)this.__items[i-1]=this.__items[i],this.__ident_changed(this.__items[i-1],i-1);return this.__items.pop(),delete this.__idToIndex[BetaJS.Ids.objectId(e)],e},_get:function(t){return this.__items[t]},_iterate:function(t,e){for(var i=BetaJS.Objs.clone(this.__items,1),s=0;i.length>s;++s)t.apply(e||this,[i[s],this.get_ident(i[s])])},__ident_changed:function(t,e){this.__idToIndex[BetaJS.Ids.objectId(t)]=e,this._ident_changed(t,e)},get_ident:function(t){var e=BetaJS.Ids.objectId(t);return e in this.__idToIndex?this.__idToIndex[e]:null},ident_by_id:function(t){return this.__idToIndex[t]}}),BetaJS.Iterators={ensure:function(t){return null===t?new BetaJS.Iterators.ArrayIterator([]):t.instance_of(BetaJS.Iterators.Iterator)?t:BetaJS.Types.is_array(t)?new BetaJS.Iterators.ArrayIterator(t):new BetaJS.Iterators.ArrayIterator([t])}},BetaJS.Class.extend("BetaJS.Iterators.Iterator",{asArray:function(){for(var t=[];this.hasNext();)t.push(this.next());return t},asArrayDelegate:function(t){for(var e=[];this.hasNext();){var i=this.next();e.push(i[t].apply(i,BetaJS.Functions.getArguments(arguments,1)))}return e},iterate:function(t,e){for(;this.hasNext();)t.call(e||this,this.next())}}),BetaJS.Iterators.Iterator.extend("BetaJS.Iterators.ArrayIterator",{constructor:function(t){this._inherited(BetaJS.Iterators.ArrayIterator,"constructor"),this.__array=t,this.__i=0},hasNext:function(){return this.__i<this.__array.length},next:function(){var t=this.__array[this.__i];return this.__i++,t}},{byIterate:function(t,e){var i=[];return t.call(e||this,function(t){i.push(t)},this),new this(i)}}),BetaJS.Iterators.ArrayIterator.extend("BetaJS.Iterators.ObjectKeysIterator",{constructor:function(t){this._inherited(BetaJS.Iterators.ObjectKeysIterator,"constructor",BetaJS.Objs.keys(t))}}),BetaJS.Iterators.ArrayIterator.extend("BetaJS.Iterators.ObjectValuesIterator",{constructor:function(t){this._inherited(BetaJS.Iterators.ObjectValuesIterator,"constructor",BetaJS.Objs.values(t))}}),BetaJS.Iterators.Iterator.extend("BetaJS.Iterators.MappedIterator",{constructor:function(t,e,i){this._inherited(BetaJS.Iterators.MappedIterator,"constructor"),this.__iterator=t,this.__map=e,this.__context=i||this},hasNext:function(){return this.__iterator.hasNext()},next:function(){return this.hasNext()?this.__map.call(this.__context,this.__iterator.next()):null}}),BetaJS.Iterators.Iterator.extend("BetaJS.Iterators.FilteredIterator",{constructor:function(t,e,i){this._inherited(BetaJS.Iterators.FilteredIterator,"constructor"),this.__iterator=t,this.__filter=e,this.__context=i||this,this.__next=null},hasNext:function(){return this.__crawl(),null!==this.__next},next:function(){this.__crawl();var t=this.__next;return this.__next=null,t},__crawl:function(){for(;!this.__next&&this.__iterator.hasNext();){var t=this.__iterator.next();this.__filter_func(t)&&(this.__next=t)}},__filter_func:function(t){return this.__filter.apply(this.__context,[t])}}),BetaJS.Iterators.Iterator.extend("BetaJS.Iterators.SkipIterator",{constructor:function(t,e){for(this._inherited(BetaJS.Iterators.SkipIterator,"constructor"),this.__iterator=t;e>0;)t.next(),e--},hasNext:function(){return this.__iterator.hasNext()},next:function(){return this.__iterator.next()}}),BetaJS.Iterators.Iterator.extend("BetaJS.Iterators.LimitIterator",{constructor:function(t,e){this._inherited(BetaJS.Iterators.LimitIterator,"constructor"),this.__iterator=t,this.__limit=e},hasNext:function(){return this.__limit>0&&this.__iterator.hasNext()},next:function(){return 0>=this.__limit?null:(this.__limit--,this.__iterator.next())}}),BetaJS.Iterators.Iterator.extend("BetaJS.Iterators.SortedIterator",{constructor:function(t,e){this._inherited(BetaJS.Iterators.SortedIterator,"constructor"),this.__array=t.asArray(),this.__array.sort(e),this.__i=0},hasNext:function(){return this.__i<this.__array.length},next:function(){var t=this.__array[this.__i];return this.__i++,t}}),BetaJS.Events={},BetaJS.Events.EVENT_SPLITTER=/\s+/,BetaJS.Events.EventsMixin={__create_event_object:function(t,e,i){i=i||{};var s={callback:t,context:e};return i.eventually&&(s.eventually=i.eventually),i.min_delay&&(s.min_delay=new BetaJS.Timers.Timer({delay:i.min_delay,once:!0,start:!1,context:this,fire:function(){s.max_delay&&s.max_delay.stop(),s.callback.apply(s.context||this,s.params)}})),i.max_delay&&(s.max_delay=new BetaJS.Timers.Timer({delay:i.max_delay,once:!0,start:!1,context:this,fire:function(){s.min_delay&&s.min_delay.stop(),s.callback.apply(s.context||this,s.params)}})),s},__destroy_event_object:function(t){t.min_delay&&t.min_delay.destroy(),t.max_delay&&t.max_delay.destroy()},__call_event_object:function(t,e){t.min_delay&&t.min_delay.restart(),t.max_delay&&t.max_delay.start(),t.min_delay||t.max_delay?t.params=e:t.eventually?BetaJS.SyncAsync.eventually(t.callback,e,t.context||this):t.callback.apply(t.context||this,e)},on:function(t,e,i,s){this.__events_mixin_events=this.__events_mixin_events||{},t=t.split(BetaJS.Events.EVENT_SPLITTER);for(var n;;){if(n=t.shift(),!n)break;this.__events_mixin_events[n]=this.__events_mixin_events[n]||new BetaJS.Lists.LinkedList,this.__events_mixin_events[n].add(this.__create_event_object(e,i,s))}return this},off:function(t,e,i){if(this.__events_mixin_events=this.__events_mixin_events||{},t){t=t.split(BetaJS.Events.EVENT_SPLITTER);for(var s;;){if(s=t.shift(),!s)break;this.__events_mixin_events[s]&&(this.__events_mixin_events[s].remove_by_filter(function(t){var s=!(e&&t.callback!=e||i&&t.context!=i);return s&&this.__destroy_event_object&&this.__destroy_event_object(t),s}),0===this.__events_mixin_events[s].count()&&(this.__events_mixin_events[s].destroy(),delete this.__events_mixin_events[s]))}}else for(s in this.__events_mixin_events)this.__events_mixin_events[s].remove_by_filter(function(t){var s=!(e&&t.callback!=e||i&&t.context!=i);return s&&this.__destroy_event_object&&this.__destroy_event_object(t),s}),0===this.__events_mixin_events[s].count()&&(this.__events_mixin_events[s].destroy(),delete this.__events_mixin_events[s]);return this},triggerAsync:function(){var t=this,e=BetaJS.Functions.getArguments(arguments),i=setTimeout(function(){clearTimeout(i),t.trigger.apply(t,e)},0)},trigger:function(t){var e=this;t=t.split(BetaJS.Events.EVENT_SPLITTER);var i,s=BetaJS.Functions.getArguments(arguments,1);if(!this.__events_mixin_events)return this;for(;;){if(i=t.shift(),!i)break;this.__events_mixin_events[i]&&this.__events_mixin_events[i].iterate(function(t){e.__call_event_object(t,s)}),this.__events_mixin_events&&"all"in this.__events_mixin_events&&this.__events_mixin_events.all.iterate(function(t){e.__call_event_object(t,[i].concat(s))})}return this},once:function(t,e,i,s){var n=this,r=BetaJS.Functions.once(function(){n.off(t,r),e.apply(this,arguments)});return r._callback=e,this.on(name,r,i,s)},delegateEvents:function(t,e,i,s){s=s||[],i=i?i+":":"",null===t?e.on("all",function(t){var e=BetaJS.Functions.getArguments(arguments,1);this.trigger.apply(this,[i+t].concat(s).concat(e))},this):(BetaJS.Types.is_array(t)||(t=[t]),BetaJS.Objs.iter(t,function(t){e.on(t,function(){var e=BetaJS.Functions.getArguments(arguments);this.trigger.apply(this,[i+t].concat(s).concat(e))},this)},this))}},BetaJS.Class.extend("BetaJS.Events.Events",BetaJS.Events.EventsMixin),BetaJS.Events.ListenMixin={_notifications:{destroy:"listenOff"},listenOn:function(t,e,i,s){this.__listen_mixin_listen||(this.__listen_mixin_listen={}),this.__listen_mixin_listen[BetaJS.Ids.objectId(t)]=t,t.on(e,i,this,s)},listenOnce:function(t,e,i,s){this.__listen_mixin_listen||(this.__listen_mixin_listen={}),this.__listen_mixin_listen[BetaJS.Ids.objectId(t)]=t,t.once(e,i,this,s)},listenOff:function(t,e,i){this.__listen_mixin_listen&&(t?(t.off(e,i,this),e||i||delete this.__listen_mixin_listen[BetaJS.Ids.objectId(t)]):BetaJS.Objs.iter(this.__listen_mixin_listen,function(t){t.off(e,i,this),e||i||delete this.__listen_mixin_listen[BetaJS.Ids.objectId(t)]
},this))}},BetaJS.Class.extend("BetaJS.Events.Listen",BetaJS.Events.ListenMixin),BetaJS.Classes={},BetaJS.Classes.InvokerMixin={invoke_delegate:function(t,e){BetaJS.Types.is_array(e)||(e=[e]),t=this[t];for(var i=this,s=0;e.length>s;++s){var n=e[s];this[n]=function(e){return function(){var s=BetaJS.Functions.getArguments(arguments);return s.unshift(e),t.apply(i,s)}}.call(i,n)}}},BetaJS.Classes.AutoDestroyMixin={_notifications:{construct:"__initialize_auto_destroy",destroy:"__finalize_auto_destroy"},__initialize_auto_destroy:function(){this.__auto_destroy={}},__finalize_auto_destroy:function(){var t=this.__auto_destroy;this.__auto_destroy={},BetaJS.Objs.iter(t,function(t){t.unregister(this)},this)},register_auto_destroy:function(t){t.cid()in this.__auto_destroy||(this.__auto_destroy[t.cid()]=t,t.register(this),this._notify("register_auto_destroy",t))},unregister_auto_destroy:function(t){t.cid()in this.__auto_destroy&&(this._notify("unregister_auto_destroy",t),delete this.__auto_destroy[t.cid()],t.unregister(this),BetaJS.Types.is_empty(this.__auto_destroy)&&this.destroy())}},BetaJS.Class.extend("BetaJS.Classes.AutoDestroyObject",{constructor:function(){this._inherited(BetaJS.Classes.AutoDestroyObject,"constructor"),this.__objects={}},register:function(t){var e=BetaJS.Ids.objectId(t);e in this.__objects||(this.__objects[e]=t,t.register_auto_destroy(this))},unregister:function(t){var e=BetaJS.Ids.objectId(t);e in this.__objects&&(delete this.__objects[e],t.unregister_auto_destroy(this))},clear:function(){BetaJS.Objs.iter(this.__objects,function(t){this.unregister(t)},this)}}),BetaJS.Class.extend("BetaJS.Classes.ObjectCache",[BetaJS.Events.EventsMixin,{constructor:function(t){this._inherited(BetaJS.Classes.ObjectCache,"constructor"),this.__size="size"in t?t.size:null,this.__destroy_on_remove="destroy_on_remove"in t?t.destroy_on_remove:!0,this.__id_to_container={},this.__first=null,this.__last=null,this.__count=0},destroy:function(){this.clear(),this._inherited(BetaJS.Classes.ObjectCache,"destroy")},add:function(t){if(!this.get(t)){null!==this.__size&&this.__count>=this.__size&&this.__first&&this.remove(this.__first.object);var e={object:t,prev:this.__last,next:null};this.__id_to_container[BetaJS.Ids.objectId(t)]=e,this.__first?this.__last.next=e:this.__first=e,this.__last=e,this.__count++,this.trigger("cache",t)}},remove:function(t){BetaJS.Class.is_class_instance(t)&&(t=BetaJS.Ids.objectId(t));var e=this.__id_to_container[t];e&&(delete this.__id_to_container[t],e.next?e.next.prev=e.prev:this.__last=e.prev,e.prev?e.prev.next=e.next:this.__first=e.next,this.__count--,this.trigger("release",e.object),this.__destroy_on_remove&&e.object.destroy())},get:function(t){return BetaJS.Class.is_class_instance(t)&&(t=BetaJS.Ids.objectId(t)),this.__id_to_container[t]?this.__id_to_container[t].object:null},clear:function(){BetaJS.Objs.iter(this.__id_to_container,function(t){this.remove(t.object)},this)}}]),BetaJS.Classes.ModuleMixin={_notifications:{construct:function(){this.__modules={}},destroy:function(){BetaJS.Objs.iter(this.__modules,this.remove_module,this)}},add_module:function(t){t.cid()in this.__modules||(this.__modules[t.cid()]=t,t.register(this),this._notify("add_module",t))},remove_module:function(t){t.cid()in this.__modules&&(delete this.__modules[t.cid()],t.unregister(this),this._notify("remove_module",t))}},BetaJS.Class.extend("BetaJS.Classes.Module",{constructor:function(t){this._inherited(BetaJS.Classes.Module,"constructor"),this._objects={},this.__auto_destroy="auto_destroy"in t?t.auto_destroy:!0},destroy:function(){BetaJS.Objs.iter(this._objects,this.unregister,this),this._inherited(BetaJS.Classes.Module,"destroy")},register:function(t){var e=BetaJS.Ids.objectId(t);if(!(e in this._objects)){var i={};this._objects[e]={object:t,data:i},t.add_module(this),this._register(t,i)}},_register:function(){},unregister:function(t){var e=BetaJS.Ids.objectId(t);if(e in this._objects){var i=this._objects[e].data;this._unregister(t,i),delete this._objects[e],t.remove_module(this),"off"in t&&t.off(null,null,this),this.__auto_destroy&&BetaJS.Types.is_empty(this._objects)&&this.destroy()}},_unregister:function(){},_data:function(t){return this._objects[BetaJS.Ids.objectId(t)].data}},{__instance:null,singleton:function(){return this.__instance||(this.__instance=new this({auto_destroy:!1})),this.__instance}}),BetaJS.Classes.ObjectIdMixin={_notifications:{construct:"__register_object_id",destroy:"__unregister_object_id"},__object_id_scope:function(){return this.object_id_scope?this.object_id_scope:(BetaJS.Classes.ObjectIdScope||(BetaJS.Classes.ObjectIdScope=BetaJS.Objs.clone(BetaJS.Classes.ObjectIdScopeMixin,1)),BetaJS.Classes.ObjectIdScope)},__register_object_id:function(){var t=this.__object_id_scope();t.__objects[BetaJS.Ids.objectId(this)]=this},__unregister_object_id:function(){var t=this.__object_id_scope();delete t.__objects[BetaJS.Ids.objectId(this)]}},BetaJS.Classes.ObjectIdScopeMixin={__objects:{},get:function(t){return this.__objects[t]}},BetaJS.Classes.HelperClassMixin={addHelper:function(t,e){var i=new t(this,e);this.__helpers=this.__helpers||[],this.__helpers.push(this._auto_destroy(i))},_helper:function(t){function e(o){if(o>=n.__helpers.length)return BetaJS.SyncAsync.callback(t.callbacks,"success",s),void 0;if(t.method in n.__helpers[o]){var a=this.__helpers[o];-1==r?(a[t.method].apply(a,i),e(o+1)):(i[r]={context:t.callbacks.context,success:function(i){s=t.fold(s,i),e(o+1)},failure:t.callbacks.failure},a[t.method].apply(a,i))}else e(o+1)}BetaJS.Types.is_string(t)&&(t={method:t}),t=BetaJS.Objs.extend({fold_start:null,fold:function(t,e){return t||e}},t);var i=BetaJS.Functions.getArguments(arguments,1),s=t.fold_start;if(t.callbacks){var n=this,r=-1;for(j=0;i.length>j;++j)i[j]==t.callback&&(r=j);e(0)}else for(var o=0;this.__helpers.length>o;++o){var a=this.__helpers[o];if(t.method in a){var _=a[t.method].apply(a,i);s=t.fold(s,_)}}return s}},BetaJS.Properties={},BetaJS.Properties.TYPE_VALUE=0,BetaJS.Properties.TYPE_BINDING=1,BetaJS.Properties.TYPE_COMPUTED=2,BetaJS.Properties.PropertiesMixin={raw_get:function(t){return t in this.__properties?this.__properties[t].value:null},get:function(t){keys=t.split(".");for(var e=this.raw_get(keys[0]),i=1;keys.length>i;++i){if(!e||!BetaJS.Types.is_object(e))return null;e=e[keys[i]]}return e},_canSet:function(){return!0},_beforeSet:function(t,e){return e},_afterSet:function(){},has:function(t){return t in this.__properties},setAll:function(t,e){for(var i in t)this.set(i,t[i],e)},keys:function(t){return BetaJS.Objs.keys(this.__properties,t)},binding:function(t){return{type:BetaJS.Properties.TYPE_BINDING,bindee:this,property:t}},computed:function(t,e){return{type:BetaJS.Properties.TYPE_COMPUTED,func:t,dependencies:e||[]}},_isBinding:function(t){return BetaJS.Types.is_object(t)&&t&&t.type&&t.type==BetaJS.Properties.TYPE_BINDING&&t.bindee&&t.property},_isComputed:function(t){return BetaJS.Types.is_object(t)&&t&&t.type&&t.type==BetaJS.Properties.TYPE_COMPUTED&&t.func&&t.dependencies},getAll:function(){var t={};for(var e in this.__properties)t[e]=this.get(e);return t},unset:function(t){if(t in this.__properties){var e=this.__properties[t];if(e.type==BetaJS.Properties.TYPE_BINDING)e.bindee.off("change:"+e.property,null,this.__properties[t]);else if(e.type==BetaJS.Properties.TYPE_COMPUTED){var i=this;BetaJS.Objs.iter(e.dependencies,function(s){this._isBinding(s)?s.bindee.off("change:"+s.property,null,this.__properties[t]):this._isTimer(s)?e.timers[s].destroy():i.off("change:"+s,null,this.__properties[t])},this)}this.trigger("unset",t),this.trigger("unset:"+t),delete this.__properties[t]}},_set_changed:function(t,e,i){this._afterSet(t,this.get(t),e,i),this.trigger("change",t,this.get(t),e,i),this.trigger("change:"+t,this.get(t),e,i)},_isTimer:function(){return BetaJS.Strings.starts_with("dep","timer:")},_parseTimer:function(){return parseInt(BetaJS.Strings.strip_start("timer:"),10)},set:function(t,e,i){var s=t.split(".");if(2>s.length)this.raw_set(t,e,i);else{var n=this.raw_get(t,n);n||(n={},this.raw_set(t,n,i));for(var r=2;s.length-1>r;++r)n[s[r]]=n[s[r]]||{},n=n[s[r]];var o=n[s[s.length-1]];n[s[s.length-1]]=e,o!=e&&(this.trigger("change",t,e,o),this.trigger("change:"+t.replace(".","->"),e,o))}},raw_set:function(t,e,i){var s=this.get(t);if(s!=e){var n=this;this.__properties[t],this._isBinding(e)?(this.unset(t),this.__properties[t]={type:BetaJS.Properties.TYPE_BINDING,bindee:e.bindee,property:e.property,value:e.bindee.get(e.property)},e.bindee.on("change:"+e.property,function(){var i=n.__properties[t].value;n.__properties[t].value=e.bindee.get(e.property),n._set_changed(t,i)},this.__properties[t]),this._set_changed(t,s,i)):this._isComputed(e)?(this.unset(t),this.__properties[t]={type:BetaJS.Properties.TYPE_COMPUTED,func:e.func,dependencies:e.dependencies,value:e.func.apply(n),timers:{}},BetaJS.Objs.iter(e.dependencies,function(i){this._isBinding(i)?i.bindee.on("change:"+i.property,function(){var i=n.__properties[t].value;n.__properties[t].value=e.func.apply(n),n._set_changed(t,i)},this.__properties[t]):this._isTimer(i)?this.__properties[t].timers[i]=new BetaJS.Timers.Timer({delay:this._parseTimer(i),fire:function(){var i=n.__properties[t].value;n.__properties[t].value=e.func.apply(n),n._set_changed(t,i)}}):n.on("change:"+i,function(){var i=n.__properties[t].value;n.__properties[t].value=e.func.apply(n),n._set_changed(t,i)},this.__properties[t])},this),this._set_changed(t,s)):(e=this._beforeSet(t,e),this._canSet(t,e)&&(this.__properties[t]&&this.__properties[t].type==BetaJS.Properties.TYPE_BINDING?this.__properties[t].bindee.set(this.__properties[t].property,e):(this.unset(t),this.__properties[t]={type:BetaJS.Properties.TYPE_VALUE,value:e},this._set_changed(t,s,i))))}},_notifications:{construct:"__properties_construct",destroy:"__properties_destroy"},__properties_construct:function(){this.__properties={}},__properties_destroy:function(){for(var t in this.__properties)this.unset(t);this.trigger("destroy")}},BetaJS.Class.extend("BetaJS.Properties.Properties",[BetaJS.Events.EventsMixin,BetaJS.Properties.PropertiesMixin,{constructor:function(t){this._inherited(BetaJS.Properties.Properties,"constructor"),t&&this.setAll(t)}}]),BetaJS.Class.extend("BetaJS.Properties.PropertiesData",{constructor:function(t){this._inherited(BetaJS.Properties.PropertiesData,"constructor"),this.__properties=t,this.data=this.__properties.getAll(),this.__properties.on("change",function(t,e){this.data[t]=e},this),this.__properties.on("unset",function(t){delete this.data[t]},this),this.__properties.on("destroy",function(){this.destroy()},this)},properties:function(){return this.__properties}}),BetaJS.Class.extend("BetaJS.Collections.Collection",[BetaJS.Events.EventsMixin,{constructor:function(t){this._inherited(BetaJS.Collections.Collection,"constructor"),t=t||{};var e={};"compare"in t&&(e.compare=t.compare),this.__data=new BetaJS.Lists.ArrayList([],e);var i=this;this.__data._ident_changed=function(t,e){i._index_changed(t,e)},this.__data._re_indexed=function(t){i._re_indexed(t)},this.__data._sorted=function(){i._sorted()},"objects"in t&&this.add_objects(t.objects)},set_compare:function(t){this.__data.set_compare(t)},get_compare:function(){this.__data.get_compare()},destroy:function(){this.__data.iterate(function(t){"off"in t&&t.off(null,null,this)},this),this.__data.destroy(),this.trigger("destroy"),this._inherited(BetaJS.Collections.Collection,"destroy")},count:function(){return this.__data.count()},_index_changed:function(t,e){this.trigger("index",t,e)},_re_indexed:function(t){this.trigger("reindexed",t)},_sorted:function(){this.trigger("sorted")},_object_changed:function(t,e,i){this.trigger("update"),this.trigger("change",t,e,i),this.trigger("change:"+e,t,i),this.__data.re_index(this.getIndex(t))},add:function(t){if(BetaJS.Class.is_class_instance(t)||(t=new BetaJS.Properties.Properties(t)),this.exists(t))return null;var e=this.__data.add(t);return null!==e&&(this.trigger("add",t),this.trigger("update"),"on"in t&&t.on("change",function(e,i){this._object_changed(t,e,i)},this)),e},add_objects:function(t){var e=0;return BetaJS.Objs.iter(t,function(t){this.add(t)&&e++},this),e},exists:function(t){return this.__data.exists(t)},remove:function(t){if(!this.exists(t))return null;this.trigger("remove",t),this.trigger("update");var e=this.__data.remove(t);return"off"in t&&t.off(null,null,this),e},getByIndex:function(t){return this.__data.get(t)},getById:function(t){return this.__data.get(this.__data.ident_by_id(t))},getIndex:function(t){return this.__data.get_ident(t)},iterate:function(t,e){this.__data.iterate(t,e)},iterator:function(){return BetaJS.Iterators.ArrayIterator.byIterate(this.iterate,this)},clear:function(){this.iterate(function(t){this.remove(t)},this)}}]),BetaJS.Class.extend("BetaJS.Collections.CollectionData",{constructor:function(t){this._inherited(BetaJS.Collections.CollectionData,"constructor"),this.__collection=t,this.__properties_data={},this.data={},this.__collection.iterate(this.__insert,this),this.__collection.on("add",this.__insert,this),this.__collection.on("remove",this.__remove,this),this.__collection.on("destroy",function(){this.destroy()},this)},collection:function(){return this.__collection},__insert:function(t){var e=BetaJS.Ids.objectId(t);this.__properties_data[e]=new BetaJS.Properties.PropertiesData(t),this.data[e]=this.__properties_data[e].data},__remove:function(t){var e=BetaJS.Ids.objectId(t);this.__properties_data[e].destroy(),delete this.__properties_data[e],delete this.data[e]}}),BetaJS.Collections.Collection.extend("BetaJS.Collections.FilteredCollection",{constructor:function(t,e){this.__parent=t,e=e||{},delete e.objects,e.compare=e.compare||t.get_compare(),this._inherited(BetaJS.Collections.FilteredCollection,"constructor",e),"filter"in e&&(this.filter=e.filter),this.__parent.iterate(function(t){return this.add(t),!0},this),this.__parent.on("add",this.add,this),this.__parent.on("remove",this.remove,this)},filter:function(){return!0},_object_changed:function(t,e,i){this._inherited(BetaJS.Collections.FilteredCollection,"_object_changed",t,e,i),this.filter(t)||this.__selfRemove(t)},destroy:function(){this.__parent.off(null,null,this),this._inherited(BetaJS.Collections.FilteredCollection,"destroy")},__selfAdd:function(t){return this._inherited(BetaJS.Collections.FilteredCollection,"add",t)},add:function(t){if(this.exists(t)||!this.filter(t))return null;var e=this.__selfAdd(t);return this.__parent.add(t),e},__selfRemove:function(t){return this._inherited(BetaJS.Collections.FilteredCollection,"remove",t)},remove:function(t){if(!this.exists(t))return null;var e=this.__selfRemove(t);return e?this.__parent.remove(t):null}}),BetaJS.Comparators={byObject:function(t){return function(e,i){for(key in t){var s=0;if(s=BetaJS.Properties.Properties.is_class_instance(e)&&BetaJS.Properties.Properties.is_class_instance(i)?BetaJS.Comparators.byValue(e.get(key)||null,i.get(key)||null):BetaJS.Comparators.byValue(e[key]||null,i[key]||null),0!==s)return s*t[key]}return 0}},byValue:function(t,e){return BetaJS.Types.is_string(t)?t.localeCompare(e):e>t?-1:t>e?1:0}},BetaJS.Sort={sort_object:function(t,e){var i=[];for(var s in t)i.push({key:s,value:t[s]});i.sort(function(t,i){return e(t.key,i.key,t.value,i.value)});for(var n={},r=0;i.length>r;++r)n[i[r].key]=i[r].value;return n},deep_sort:function(t,e){if(e=e||BetaJS.Comparators.byValue,BetaJS.Types.is_array(t)){for(var i=0;t.length>i;++i)t[i]=this.deep_sort(t[i],e);return t.sort(e)}if(BetaJS.Types.is_object(t)){for(var s in t)t[s]=this.deep_sort(t[s],e);return this.sort_object(t,e)}return e},dependency_sort:function(t,e,i,s){var n=BetaJS.Types.is_string(e)?function(t){return t[e]}:e,r=BetaJS.Types.is_string(i)?function(t){return t[i]}:i,o=BetaJS.Types.is_string(s)?function(t){return t[s]}:s,a=t.length,_=[],c={},u={},h=null;for(h=0;a>h;++h){u[h]=!0;var l=n(t[h],h);c[l]=h,_.push({before:{},after:{}})}for(h=0;a>h;++h)BetaJS.Objs.iter(r(t[h],h)||[],function(t){var e=c[t];BetaJS.Types.is_defined(e)&&(_[h].before[e]=!0,_[e].after[h]=!0)}),BetaJS.Objs.iter(o(t[h])||[],function(t){var e=c[t];BetaJS.Types.is_defined(e)&&(_[h].after[e]=!0,_[e].before[h]=!0)});for(var d=[];!BetaJS.Types.is_empty(u);)for(h in u)if(BetaJS.Types.is_empty(_[h].after)){delete u[h],d.push(t[h]);for(bef in _[h].before)delete _[bef].after[h]}return d}},BetaJS.Locales={__data:{},language:null,get:function(t){return this.language&&this.language+"."+t in this.__data?this.__data[this.language+"."+t]:t in this.__data?this.__data[t]:t},register:function(t,e){e=e?e+".":"";for(var i in t)this.__data[e+i]=t[i]},view:function(t){return{context:this,base:t,get:function(t){return this.context.get(this.base+"."+t)},base:function(t){return this.context.base(this.base+"."+t)}}}},BetaJS.Time={format_time:function(t,e){var i=this.seconds(t),s=this.minutes(t),n=this.hours(t),r={hh:10>n?"0"+n:n,h:n,mm:10>s?"0"+s:s,m:s,ss:10>i?"0"+i:i,s:i};for(var o in r)e=e.replace(o,r[o]);return e},make:function(t){var e=0,i={hours:60,minutes:60,seconds:60,milliseconds:1e3};for(var s in i)e*=i[s],s in t&&(e+=t[s]);return e},seconds:function(t){return Math.floor(t/1e3)%60},minutes:function(t){return Math.floor(t/60/1e3)%60},hours:function(t){return Math.floor(t/60/60/1e3)%24},days:function(t){return Math.floor(t/24/60/60/1e3)},now:function(){var t=new Date;return t.getTime()},ago:function(t){return this.now()-t},days_ago:function(t){return this.days(this.ago(t))},format_ago:function(t){return this.days_ago(t)>1?this.format(t,{time:!1}):this.format_period(Math.max(this.ago(t),0))+" ago"},format_period:function(t){return t=Math.round(t/1e3),60>t?t+" "+BetaJS.Locales.get(1==t?"second":"seconds"):(t=Math.round(t/60),60>t?t+" "+BetaJS.Locales.get(1==t?"minute":"minutes"):(t=Math.round(t/60),24>t?t+" "+BetaJS.Locales.get(1==t?"hour":"hours"):(t=Math.round(t/24),t+" "+BetaJS.Locales.get(1==t?"day":"days"))))},format:function(t,e){e=BetaJS.Objs.extend({time:!0,date:!0,locale:!0},e||{});var i=new Date(t);return e.locale?e.date?e.time?i.toLocaleString():i.toLocaleDateString():i.toLocaleTimeString():e.date?e.time?""+i:i.toDateString():i.toTimeString()}},BetaJS.Class.extend("BetaJS.Timers.Timer",{constructor:function(t){this._inherited(BetaJS.Timers.Timer,"constructor"),t=BetaJS.Objs.extend({once:!1,start:!0,fire:null,context:this,destroy_on_fire:!1},t),this.__delay=t.delay,this.__destroy_on_fire=t.destroy_on_fire,this.__once=t.once,this.__fire=t.fire,this.__context=t.context,this.__started=!1,t.start&&this.start()},destroy:function(){this.stop(),this._inherited(BetaJS.Timers.Timer,"destroy")},fire:function(){this.__once&&(this.__started=!1),this.__fire&&this.__fire.apply(this.__context,[this]),this.__destroy_on_fire&&this.destroy()},stop:function(){this.__started&&(this.__once?clearTimeout(this.__timer):clearInterval(this.__timer),this.__started=!1)},start:function(){if(!this.__started){var t=this;this.__timer=this.__once?setTimeout(function(){t.fire()},this.__delay):setInterval(function(){t.fire()},this.__delay),this.__started=!0}},restart:function(){this.stop(),this.start()}}),BetaJS.Templates={tokenize:function(t){if(BetaJS.Types.is_array(t))return t;var e=[],i=0;return t.replace(BetaJS.Templates.SYNTAX_REGEX(),function(s,n,r,o,a){return a>i&&e.push({type:BetaJS.Templates.TOKEN_STRING,data:BetaJS.Strings.js_escape(t.slice(i,a))}),o&&e.push({type:BetaJS.Templates.TOKEN_CODE,data:o}),n&&e.push({type:BetaJS.Templates.TOKEN_EXPR,data:n}),r&&e.push({type:BetaJS.Templates.TOKEN_ESC,data:r}),i=a+s.length,s}),e},compile:function(t,e){BetaJS.Types.is_string(t)&&(t=this.tokenize(t)),e=e||{};for(var i=e.start_index||0,s=e.end_index||t.length,n="__p+='",r=i;s>r;++r)switch(t[r].type){case BetaJS.Templates.TOKEN_STRING:n+=t[r].data;break;case BetaJS.Templates.TOKEN_CODE:n+="';\n"+t[r].data+"\n__p+='";break;case BetaJS.Templates.TOKEN_EXPR:n+="'+\n((__t=("+t[r].data+"))==null?'':__t)+\n'";break;case BetaJS.Templates.TOKEN_ESC:n+="'+\n((__t=("+t[r].data+"))==null?'':BetaJS.Strings.htmlentities(__t))+\n'";break;default:}n+="';\n",n="with(obj||{}){\n"+n+"}\n",n="var __t,__p='',__j=Array.prototype.join,echo=function(){__p+=__j.call(arguments,'');};\n"+n+"return __p;\n";var o=Function("obj",n),a=function(t){return o.call(this,t)};return a.source="function(obj){\n"+n+"}",a}},BetaJS.Templates.SYNTAX={OPEN:"{%",CLOSE:"%}",MODIFIER_CODE:"",MODIFIER_EXPR:"=",MODIFIER_ESC:"-"},BetaJS.Templates.SYNTAX_REGEX=function(){var t=BetaJS.Templates.SYNTAX;return BetaJS.Templates.SYNTAX_REGEX_CACHED||(BetaJS.Templates.SYNTAX_REGEX_CACHED=RegExp(t.OPEN+t.MODIFIER_EXPR+"([\\s\\S]+?)"+t.CLOSE+"|"+t.OPEN+t.MODIFIER_ESC+"([\\s\\S]+?)"+t.CLOSE+"|"+t.OPEN+t.MODIFIER_CODE+"([\\s\\S]+?)"+t.CLOSE+"|"+"$","g")),BetaJS.Templates.SYNTAX_REGEX_CACHED},BetaJS.Templates.TOKEN_STRING=1,BetaJS.Templates.TOKEN_CODE=2,BetaJS.Templates.TOKEN_EXPR=3,BetaJS.Templates.TOKEN_ESC=4,BetaJS.Class.extend("BetaJS.Templates.Template",{constructor:function(t){this._inherited(BetaJS.Templates.Template,"constructor"),this.__tokens=BetaJS.Templates.tokenize(t),this.__compiled=BetaJS.Templates.compile(this.__tokens)},evaluate:function(t){return this.__compiled.apply(this,[t])}},{bySelector:function(t){return new this(BetaJS.$(t).html())}}),BetaJS.Class.extend("BetaJS.States.Host",[BetaJS.Events.EventsMixin,{initialize:function(t,e){var i=BetaJS.Scopes.resolve(t),s=new i(this,e,{});s.start()},finalize:function(){this._state&&this._state.destroy(),this._state=null},destroy:function(){this.finalize(),this._inherited(BetaJS.States.Host,"destroy")},state:function(){return this._state},_start:function(t){this._stateEvent(t,"before_start"),this._state=t},_afterStart:function(t){this._stateEvent(t,"start")},_end:function(t){this._stateEvent(t,"end"),this._state=null},_afterEnd:function(t){this._stateEvent(t,"after_end")},_next:function(t){this._stateEvent(t,"next")},_afterNext:function(t){this._stateEvent(t,"after_next")},_can_transition_to:function(){return!0},_stateEvent:function(t,e){this.trigger("event",e,t.state_name(),t.description()),this.trigger(e,t.state_name(),t.description()),this.trigger(e+":"+t.state_name(),t.description())}}]),BetaJS.Class.extend("BetaJS.States.State",{_locals:[],_persistents:[],_white_list:null,constructor:function(t,e,i){this._inherited(BetaJS.States.State,"constructor"),this.host=t,this.transitionals=i,this._starting=!1,this._started=!1,this._stopped=!1,this.__next_state=null,this.__suspended=0,e=e||{},this._locals=BetaJS.Types.is_function(this._locals)?this._locals():this._locals;for(var s=0;this._locals.length>s;++s)this["_"+this._locals[s]]=e[this._locals[s]];for(this._persistents=BetaJS.Types.is_function(this._persistents)?this._persistents():this._persistents,s=0;this._persistents.length>s;++s)this["_"+this._persistents[s]]=e[this._persistents[s]]},state_name:function(){return BetaJS.Strings.last_after(this.cls.classname,".")},description:function(){return this.state_name()},start:function(){this._starting||(this._starting=!0,this.host._start(this),this._start(),this.host&&(this.host._afterStart(this),this._started=!0))},end:function(){this._stopped||(this._stopped=!0,this._end(),this.host._end(this),this.host._afterEnd(this),this.destroy())},next:function(t,e,i){if(this._starting&&!this._stopped&&!this.__next_state){var s=this.cls.classname,n=BetaJS.Scopes.resolve(s.substring(0,s.lastIndexOf("."))),r=n[t];e=e||{};for(var o=0;this._persistents.length>o;++o)this._persistents[o]in e||(e[this._persistents[o]]=this["_"+this._persistents[o]]);var a=new r(this.host,e,i);if(!this.can_transition_to(a))return a.destroy(),void 0;this._started||(this.host._afterStart(this),this._started=!0),this.__next_state=a,0>=this.__suspended&&this.__next()}},__next:function(){var t=this.host,e=this.__next_state;t._next(e),this.end(),e.start(),t._afterNext(e)},suspend:function(){this.__suspended++},resume:function(){this.__suspended--,0===this.__suspended&&!this._stopped&&this.__next_state&&this.__next()},can_transition_to:function(t){return this.host&&this.host._can_transition_to(t)&&this._can_transition_to(t)},_start:function(){},_end:function(){},_can_transition_to:function(t){return!BetaJS.Types.is_array(this._white_list)||BetaJS.Objs.contains_value(this._white_list,t.state_name())}}),BetaJS.Class.extend("BetaJS.States.CompetingComposite",{_register_host:function(t){this._hosts=this._hosts||[],this._hosts.push(this._auto_destroy(t))},other_hosts:function(t){return BetaJS.Objs.filter(this._hosts||[],function(e){return e!=t},this)},_next:function(t,e){for(var i=this.other_hosts(t),s=0;i.length>s;++s){var n=i[s],r=n.state();r.can_coexist_with(e)||r.retreat_against(e)}}}),BetaJS.States.Host.extend("BetaJS.States.CompetingHost",{constructor:function(t){this._inherited(BetaJS.States.CompetingHost,"constructor"),this._composite=t,t&&t._register_host(this)},composite:function(){return this._composite},_can_transition_to:function(t){if(!this._composite)return!0;for(var e=this._composite.other_hosts(this),i=0;e.length>i;++i){var s=e[i],n=s.state();if(!t.can_coexist_with(n)&&!t.can_prevail_against(n))return!1}return!0},_next:function(t){this._composite&&this._composite._next(this,t),this._inherited(BetaJS.States.CompetingHost,"_next",t)}}),BetaJS.States.State.extend("BetaJS.States.CompetingState",{can_coexist_with:function(){return!0},can_prevail_against:function(){return!1},retreat_against:function(){}}),BetaJS.Class.extend("BetaJS.Channels.Sender",[BetaJS.Events.EventsMixin,{send:function(t,e){this.trigger("send",t,e),this._send(t,e)},_send:function(){}}]),BetaJS.Class.extend("BetaJS.Channels.Receiver",[BetaJS.Events.EventsMixin,{_receive:function(t,e){this.trigger("receive",t,e),this.trigger("receive:"+t,e)}}]),BetaJS.Channels.Sender.extend("BetaJS.Channels.ReveiverSender",{constructor:function(t){this._inherited(BetaJS.Channels.ReveiverSender,"constructor"),this.__receiver=t},_send:function(t,e){this.__receiver._receive(t,e)}}),BetaJS.Channels.Sender.extend("BetaJS.Channels.SenderMultiplexer",{constructor:function(t,e){this._inherited(BetaJS.Channels.SenderMultiplexer,"constructor"),this.__sender=t,this.__prefix=e},_send:function(t,e){this.__sender.send(this.__prefix+":"+t,e)}}),BetaJS.Channels.Receiver.extend("BetaJS.Channels.ReceiverMultiplexer",{constructor:function(t,e){this._inherited(BetaJS.Channels.ReceiverMultiplexer,"constructor"),this.__receiver=t,this.__prefix=e,this.__receiver.on("receive",function(t,e){BetaJS.Strings.starts_with(t,this.__prefix+":")&&this._receive(BetaJS.Strings.strip_start(t,this.__prefix+":"),e)},this)}}),BetaJS.Class.extend("BetaJS.Channels.TransportChannel",{constructor:function(t,e,i){this._inherited(BetaJS.Channels.TransportChannel,"constructor"),this.__sender=t,this.__receiver=e,this.__options=BetaJS.Objs.extend(i,{timeout:1e4,tries:1,timer:500}),this.__receiver.on("receive:send",function(t){this.__reply(t)},this),this.__receiver.on("receive:reply",function(t){this.__complete(t)},this),this.__sent_id=0,this.__sent={},this.__received={},this.__timer=this._auto_destroy(new BetaJS.Timers.Timer({delay:this.__options.timer,context:this,fire:this.__maintenance}))},_reply:function(){},send:function(t,e,i,s){s=s||{},s.stateless?this.__sender.send("send",{message:t,data:e,stateless:!0}):(this.__sent_id++,this.__sent[this.__sent_id]={message:t,data:e,tries:1,time:BetaJS.Time.now(),id:this.__sent_id,callbacks:i},this.__sender.send("send",{message:t,data:e,id:this.__sent_id}))},__reply:function(t){return t.stateless?(this._reply(t.message,t.data),void 0):(this.__received[t.id]?this.__received[t.id].returned&&this.__sender.send("reply",{id:t.id,reply:t.reply,success:t.success}):(this.__received[t.id]=t,this.__received[t.id].time=BetaJS.Time.now(),this.__received[t.id].returned=!1,this.__received[t.id].success=!1,this._reply(t.message,t.data,{context:this,success:function(e){this.__received[t.id].reply=e,this.__received[t.id].success=!0},complete:function(){this.__received[t.id].returned=!0,this.__sender.send("reply",{id:t.id,reply:t.reply,success:t.success})}})),void 0)},__complete:function(t){this.__sent[t.id]&&(BetaJS.SyncAsync.callback(this.__sent[t.id].callbacks,"success",t.reply),delete this.__sent[t.id])},__maintenance:function(){var t=BetaJS.Time.now();for(var e in this.__received){var i=this.__received[e];t>=i.time+this.__options.tries*this.__options.timeout&&delete this.__received[e]}for(var s in this.__sent){var n=this.__sent[s];t>=n.time+n.tries*this.__options.timeout&&(n.tries<this.__options.tries?(n.tries++,this.__sender.send("send",{message:n.message,data:n.data,id:n.id})):(BetaJS.SyncAsync.callback(n.callbacks,"failure",{message:n.message,data:n.data}),delete this.__sent[s]))}}}),BetaJS.Class.extend("BetaJS.RMI.Stub",[BetaJS.Classes.InvokerMixin,BetaJS.Events.EventsMixin,{intf:[],constructor:function(){this._inherited(BetaJS.RMI.Stub,"constructor"),this.invoke_delegate("invoke",this.intf)},destroy:function(){this.invoke("_destroy"),this.trigger("destroy"),this._inherited(BetaJS.RMI.Stub,"destroy")},_new_promise:function(){return{context:this,success:function(t){return this.__success=t,this.is_complete&&this.is_success&&this.__success.call(this.context,this.result),this},failure:function(t){return this.__failure=t,this.is_complete&&this.is_failure&&this.__failure.call(this.context),this},callbacks:function(t){return t=t.callbacks?t.callbacks:t,this.context=t.context||this,t.success&&this.success(t.success),t.failure&&this.failure(t.failure),t.exception&&this.failure(t.exception),this}}},_promise_success:function(t,e){t.result=e,t.is_complete=!0,t.is_success=!0,t.__success&&t.__success.call(t.context,e)},_promise_failure:function(t){t.is_complete=!0,t.is_failure=!0,t.__failure&&t.__failure.call(t.context)},invoke:function(t){var e=this._new_promise();return this.trigger("send",t,BetaJS.Functions.getArguments(arguments,1),{context:this,success:function(t){return this._promise_success(e,t)},failure:function(){return this._promise_failure(e)}}),e}}]),BetaJS.Class.extend("BetaJS.RMI.StubSyncer",[BetaJS.Classes.InvokerMixin,{constructor:function(t){this._inherited(BetaJS.RMI.StubSyncer,"constructor"),this.__stub=t,this.__current=null,this.__queue=[],this.invoke_delegate("invoke",this.__stub.intf)},invoke:function(){var t={args:BetaJS.Functions.getArguments(arguments),promise:this.__stub._new_promise()};return this.__queue.push(t),this.__current||this.__next(),t.promise},__next:function(){0!==this.__queue.length&&(this.__current=this.__queue.shift(),this.__stub.invoke.apply(this.__stub,this.__current.args).callbacks({context:this,success:function(t){this.__stub._promise_success(this.__current.promise,t),this.__next()},failure:function(){this.__stub._promise_failure(this.__current.promise),this.__next()}}))}}]),BetaJS.Class.extend("BetaJS.RMI.Skeleton",[BetaJS.Events.EventsMixin,{_stub:null,intf:[],intfSync:[],_intf:{},_intfSync:{},__superIntf:[],__superIntfSync:["_destroy"],constructor:function(t){this._options=BetaJS.Objs.extend({destroyable:!1},t),this._inherited(BetaJS.RMI.Skeleton,"constructor"),this.intf=this.intf.concat(this.__superIntf),this.intfSync=this.intfSync.concat(this.__superIntfSync);for(var e=0;this.intf.length>e;++e)this._intf[this.intf[e]]=!0;for(e=0;this.intfSync.length>e;++e)this._intfSync[this.intfSync[e]]=!0},_destroy:function(){this._options.destroyable&&this.destroy()},destroy:function(){this.trigger("destroy"),this._inherited(BetaJS.RMI.Skeleton,"destroy")},invoke:function(t,e,i,s){if(!this._intf[t]&&!this._intfSync[t])return this._failure(i),void 0;var n={callbacks:i,caller:s};if(this._intf[t])e.unshift(n),this[t].apply(this,e);else try{this._success(n,this[t].apply(this,e))}catch(r){this._failure(n,r)}},_success:function(t,e){t=t.callbacks?t.callbacks:t,BetaJS.SyncAsync.callback(t,"success",e)},_failure:function(t){t=t.callbacks?t.callbacks:t,BetaJS.SyncAsync.callback(t,"failure")},stub:function(){if(this._stub)return this._stub;var t=this.cls.classname;return t.indexOf("Skeleton")>=0?t.replace("Skeleton","Stub"):t}}]),BetaJS.Class.extend("BetaJS.RMI.Server",[BetaJS.Events.EventsMixin,{constructor:function(t,e){if(this._inherited(BetaJS.RMI.Server,"constructor"),this.__channels=new BetaJS.Lists.ObjectIdList,this.__instances={},t){var i=t;
e&&(i=this._auto_destroy(new BetaJS.Channels.TransportChannel(t,e))),this.registerClient(i)}},destroy:function(){this.__channels.iterate(this.unregisterClient,this),BetaJS.Objs.iter(this.__instances,function(t){this.unregisterInstance(t.instance)},this),this.__channels.destroy(),this._inherited(BetaJS.RMI.Server,"destroy")},registerInstance:function(t,e){return e=e||{},this.__instances[BetaJS.Ids.objectId(t,e.name)]={instance:t,options:e},t},unregisterInstance:function(t){delete this.__instances[BetaJS.Ids.objectId(t)],t.destroy()},registerClient:function(t){var e=this;this.__channels.add(t),t._reply=function(i,s,n){var r=i.split(":");2==r.length?e._invoke(t,r[0],r[1],s,n):BetaJS.SyncAsync.callback(n,"failure")}},unregisterClient:function(t){this.__channels.remove(t),t._reply=null},_invoke:function(t,e,i,s,n){var r=this.__instances[e];if(r||(this.trigger("loadInstance",t,e),r=this.__instances[e]),!r)return BetaJS.SyncAsync.callback(n,"failure"),void 0;r=r.instance;var o=this;r.invoke(i,s,BetaJS.SyncAsync.mapSuccess(n,function(t){BetaJS.RMI.Skeleton.is_class_instance(t)&&t.instance_of(BetaJS.RMI.Skeleton)?(o.registerInstance(t),BetaJS.SyncAsync.callback(n,"success",{__rmi_meta:!0,__rmi_stub:t.stub(),__rmi_stub_id:BetaJS.Ids.objectId(t)})):BetaJS.SyncAsync.callback(n,"success",t)}),t)}}]),BetaJS.Class.extend("BetaJS.RMI.Client",{constructor:function(t,e){if(this._inherited(BetaJS.RMI.Client,"constructor"),this.__channel=null,this.__instances={},t){var i=t;e&&(i=this._auto_destroy(new BetaJS.Channels.TransportChannel(t,e))),this.__channel=i}},destroy:function(){this.__channel&&this.disconnect(),this._inherited(BetaJS.RMI.Client,"destroy")},connect:function(t){this.__channel||(this.__channel=t)},disconnect:function(){this.__channel&&(this.__channel=null,BetaJS.Objs.iter(this.__instances,function(t){this.release(t)},this))},acquire:function(t,e){if(this.__instances[e])return this.__instances[e];if(BetaJS.Types.is_string(t)&&(t=BetaJS.Scopes.resolve(t)),!t||!t.ancestor_of(BetaJS.RMI.Stub))return null;var i=new t;this.__instances[BetaJS.Ids.objectId(i,e)]=i;var s=this;return i.on("send",function(t,i,n){this.__channel.send(e+":"+t,i,BetaJS.SyncAsync.mapSuccess(n,function(t){BetaJS.Types.is_object(t)&&t.__rmi_meta?BetaJS.SyncAsync.callback(n,"success",s.acquire(t.__rmi_stub,t.__rmi_stub_id)):BetaJS.SyncAsync.callback(n,"success",t)}))},this),i},release:function(t){var e=BetaJS.Ids.objectId(t);this.__instances[e]&&(t.off(null,null,this),t.destroy(),delete this.__instances[e])}}),BetaJS.Class.extend("BetaJS.RMI.Peer",{constructor:function(t,e){this._inherited(BetaJS.RMI.Peer,"constructor"),this.__sender=t,this.__receiver=e,this.__client_sender=this._auto_destroy(new BetaJS.Channels.SenderMultiplexer(t,"client")),this.__server_sender=this._auto_destroy(new BetaJS.Channels.SenderMultiplexer(t,"server")),this.__client_receiver=this._auto_destroy(new BetaJS.Channels.ReceiverMultiplexer(e,"server")),this.__server_receiver=this._auto_destroy(new BetaJS.Channels.ReceiverMultiplexer(e,"client")),this.client=this._auto_destroy(new BetaJS.RMI.Client(this.__client_sender,this.__client_receiver)),this.server=this._auto_destroy(new BetaJS.RMI.Server(this.__server_sender,this.__server_receiver))},acquire:function(t,e){return this.client.acquire(t,e)},release:function(t){this.client.release(t)},registerInstance:function(t,e){return this.server.registerInstance(t,e)},unregisterInstance:function(t){this.server.unregisterInstance(t)}}),BetaJS.Structures={},BetaJS.Structures.AvlTree={empty:function(){return null},singleton:function(t){return{data:t,left:null,right:null,height:1}},min:function(t){return t.left?this.min(t.left):t.data},max:function(t){return t.right?this.max(t.right):t.data},height:function(t){return t?t.height:0},height_join:function(t,e){return 1+Math.max(this.height(t),this.height(e))},create:function(t,e,i){return{data:t,left:e,right:i,height:this.height_join(e,i)}},balance:function(t,e,i){return this.height(e)>this.height(i)+2?this.height(e.left)>=this.height(e.right)?this.create(e.data,e.left,this.create(t,e.right,i)):this.create(e.right.data,this.create(e.data,e.left,e.right.left),this.create(t,e.right.right,i)):this.height(i)>this.height(e)+2?this.height(i.right)>=this.height(i.left)?this.create(i.data,this.create(t,e,i.left),i.right):this.create(i.left.data,this.create(t,e,i.left.left),this.create(i.data,i.left.right,i.right)):this.create(t,e,i)},__add_left:function(t,e){return e?this.balance(e.data,this.__add_left(t,e.left),e.right):this.singleton(t)},__add_right:function(t,e){return e?this.balance(e.data,e.data,this.__add_right(t,e.right)):this.singleton(t)},join:function(t,e,i){return e?i?this.height(e)>this.height(i)+2?this.balance(e.data,e.left,this.join(t,e.right,i)):this.height(i)>this.height(e)+2?this.balance(i.data,this.join(t,e,i.left),i.right):this.create(t,e,i):this.__add_right(t,e):this.__add_left(t,i)},take_min:function(t){if(!t.left)return[t.data,t.right];var e=this.take_min(t.left);return[e[0],this.join(t.data,e[1],t.right)]},take_max:function(t){if(!t.right)return[t.data,t.left];var e=this.take_max(t.right);return[e[0],this.join(t.data,t.left,e[1])]},rereoot:function(t,e){if(!t||!e)return t||e;if(this.height(t)>this.height(e)){var i=this.take_max(t);return this.join(i[0],i[1],e)}var s=this.take_min(e);return this.join(s[0],t,s[1])},take_min_iter:function(t){return t?t.left?this.take_min_iter(this.create(t.left.data,t.left.left,this.create(t.data,t.left.right,t.right))):[t.data,t.left]:null},take_max_iter:function(t){return t?t.right?this.take_max_iter(this.create(t.right.data,this.create(t.data,t.left,t.right.left),t.right.right)):[t.data,t.right]:null}},BetaJS.Structures.TreeMap={empty:function(t){return{root:null,length:0,compare:t||function(t,e){return t>e?1:e>t?-1:0}}},is_empty:function(t){return!t.root},length:function(t){return t.length},__add:function(t,e,i,s){var n={key:t,value:e};if(!s)return i.length++,BetaJS.Data.AvlTree.singleton(n);var r=i.compare(t,s.data.key);return 0===r?(s.data=n,s):0>r?BetaJS.Data.AvlTree.balance(s.data,this.__add(t,e,i,s.left),s.right):BetaJS.Data.AvlTree.balance(s.data,s.left,this.__add(t,e,i,s.right))},add:function(t,e,i){return i.root=this.__add(t,e,i,i.root),i},singleton:function(t,e,i){return this.add(t,e,this.empty(i))},__find:function(t,e,i){if(!i)return null;var s=e.compare(t,i.data.key);return 0===s?i.data.value:this.__find(t,e,0>s?i.left:i.right)},find:function(t,e){return this.__find(t,e,e.root)},__iterate:function(t,e,i,s){return e?this.__iterate(t,e.left,i,s)&&i.call(s,e.data.key,e.data.value)!==!1&&this.__iterate(t,e.right,i,s):!0},iterate:function(t,e,i){this.__iterate(t,t.root,e,i)},__iterate_from:function(t,e,i,s,n){if(!i)return!0;var r=e.compare(t,i.data.key);return 0>r&&!this.__iterate_from(t,e,i.left,s,n)?!1:0>=r&&s.call(n,i.data.key,i.data.value)===!1?!1:this.__iterate_from(t,e,i.right,s,n)},iterate_from:function(t,e,i,s){this.__iterate_from(t,e,e.root,i,s)},iterate_range:function(t,e,i,s,n){this.iterate_from(t,i,function(t,r){return 0>=i.compare(t,e)&&s.call(n,t,r)!==!1},this)}},BetaJS.Class.extend("BetaJS.Net.AbstractAjax",{constructor:function(t){this._inherited(BetaJS.Net.AbstractAjax,"constructor"),this.__options=BetaJS.Objs.extend({method:"GET",data:{}},t)},syncCall:function(t){try{return this._syncCall(BetaJS.Objs.extend(BetaJS.Objs.clone(this.__options,1),t))}catch(e){throw e=BetaJS.Exceptions.ensure(e),e.assert(BetaJS.Net.AjaxException),e}},asyncCall:function(t,e){this._asyncCall(BetaJS.Objs.extend(BetaJS.Objs.clone(this.__options,1),t),e)},call:function(t,e){return e?this.asyncCall(t,e):this.syncCall(t)},_syncCall:function(){},_asyncCall:function(){}}),BetaJS.Exceptions.Exception.extend("BetaJS.Net.AjaxException",{constructor:function(t,e,i){this._inherited(BetaJS.Net.AjaxException,"constructor",t+": "+e),this.__status_code=t,this.__status_text=e,this.__data=i},status_code:function(){return this.__status_code},status_text:function(){return this.__status_text},data:function(){return this.__data},json:function(){var t=this._inherited(BetaJS.Net.AjaxException,"json");return t.data=this.data(),t}}),BetaJS.Channels.Sender.extend("BetaJS.Net.SocketSenderChannel",{constructor:function(t,e,i){this._inherited(BetaJS.Net.SocketSenderChannel,"constructor"),this.__socket=t,this.__message=e,this.__ready=BetaJS.Types.is_defined(i)?i:!0,this.__cache=[]},_send:function(t,e){this.__ready?this.__socket.emit(this.__message,{message:t,data:e}):this.__cache.push({message:t,data:e})},ready:function(){this.__ready=!0;for(var t=0;this.__cache.length>t;++t)this._send(this.__cache[t].message,this.__cache[t].data);this.__cache=[]},unready:function(){this.__ready=!1},socket:function(){return arguments.length>0&&(this.__socket=arguments[0]),this.__socket}}),BetaJS.Channels.Receiver.extend("BetaJS.Net.SocketReceiverChannel",{constructor:function(t,e){this._inherited(BetaJS.Net.SocketReceiverChannel,"constructor"),this.__message=e,this.socket(t)},socket:function(){if(arguments.length>0&&(this.__socket=arguments[0],this.__socket)){var t=this;this.__socket.on(this.__message,function(e){t._receive(e.message,e.data)})}return this.__socket}}),BetaJS.Net=BetaJS.Net||{},BetaJS.Net.HttpHeader={HTTP_STATUS_OK:200,HTTP_STATUS_CREATED:201,HTTP_STATUS_PAYMENT_REQUIRED:402,HTTP_STATUS_FORBIDDEN:403,HTTP_STATUS_NOT_FOUND:404,HTTP_STATUS_PRECONDITION_FAILED:412,HTTP_STATUS_INTERNAL_SERVER_ERROR:500,format:function(t,e){var i="";return i=t==this.HTTP_STATUS_OK?"OK":t==this.HTTP_STATUS_CREATED?"Created":t==this.HTTP_STATUS_PAYMENT_REQUIRED?"Payment Required":t==this.HTTP_STATUS_FORBIDDEN?"Forbidden":t==this.HTTP_STATUS_NOT_FOUND?"Not found":t==this.HTTP_STATUS_PRECONDITION_FAILED?"Precondition Failed":t==this.HTTP_STATUS_INTERNAL_SERVER_ERROR?"Internal Server Error":"Other Error",e?t+" "+i:i}},BetaJS.Net=BetaJS.Net||{},BetaJS.Net.Uri={build:function(t){var e="";return t.username&&(e+=t.username+":"),t.password&&(e+=t.password+"@"),e+=t.server,t.port&&(e+=":"+t.port),t.path&&(e+="/"+t.path),e},encodeUriParams:function(t,e){e=e||"";var i=[];return BetaJS.Objs.iter(t,function(t,s){BetaJS.Types.is_object(t)?i=i.concat(this.encodeUriParams(t,e+s+"_")):i.push(e+s+"="+encodeURI(t))},this),i.join("&")},appendUriParams:function(t,e,i){return BetaJS.Types.is_empty(e)?t:t+(-1!=t.indexOf("?")?"&":"?")+this.encodeUriParams(e,i)},parse:function(t,e){for(var i=e?this.__parse_strict_regex:this.__parse_loose_regex,s=i.exec(t),n={},r=0;this.__parse_key.length>r;++r)n[this.__parse_key[r]]=s[r]||"";return n.queryKey={},n[this.__parse_key[12]].replace(this.__parse_key_parser,function(t,e,i){e&&(n.queryKey[e]=i)}),n},__parse_strict_regex:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,__parse_loose_regex:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,__parse_key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],__parse_key_parser:/(?:^|&)([^&=]*)=?([^&]*)/g},BetaJS.Queries={subsumizes:function(t,e){if(!BetaJS.Types.is_object(t)||!BetaJS.Types.is_object)return t==e;for(var i in t)if(!(i in e&&this.subsumizes(t[i],e[i])))return!1;return!0},normalize:function(t){return BetaJS.Sort.deep_sort(t)},serialize:function(t){return JSON.stringify(this.normalize(t))},unserialize:function(t){return JSON.parse(t)},__increase_dependency:function(t,e){return t in e?e[t]++:e[t]=1,e},__dependencies_queries:function(t,e){return BetaJS.Objs.iter(t,function(t){e=this.__dependencies_query(t,e)},this),e},__dependencies_query:function(t,e){for(key in t)e=this.__dependencies_pair(key,t[key],e);return e},__dependencies_pair:function(t,e,i){return"$or"==t||"$and"==t?this.__dependencies_queries(e,i):this.__increase_dependency(t,i)},dependencies:function(t){return this.__dependencies_query(t,{})},__evaluate_query:function(t,e){for(var i in t)if(!this.__evaluate_pair(i,t[i],e))return!1;return!0},__evaluate_pair:function(t,e,i){return"$or"==t?this.__evaluate_or(e,i):"$and"==t?this.__evaluate_and(e,i):this.__evaluate_value(e,i[t])},__evaluate_value:function(t,e){if(BetaJS.Types.is_object(t)){var i=!0;return BetaJS.Objs.iter(t,function(t,s){"$in"==s&&(i=i&&BetaJS.Objs.contains_value(t,e)),"$gt"==s&&(i=i&&e>=t),"$gtic"==s&&(i=i&&e.toLowerCase()>=t.toLowerCase()),"$lt"==s&&(i=i&&t>=e),"$ltic"==s&&(i=i&&e.toLowerCase()<=t.toLowerCase()),"$sw"==s&&(i=i&&0===e.indexOf(t)),"$swic"==s&&(i=i&&0===e.toLowerCase().indexOf(t.toLowerCase()))},this),i}return t==e},__evaluate_or:function(t,e){return BetaJS.Objs.iter(t,function(t){return this.__evaluate_query(t,e)?!0:void 0},this),!1},__evaluate_and:function(t,e){return BetaJS.Objs.iter(t,function(t){return this.__evaluate_query(t,e)?void 0:!1},this),!0},format:function(t){return BetaJS.Class.is_class_instance(t)?t.format():JSON.stringify(t)},overloaded_evaluate:function(t,e){return BetaJS.Class.is_class_instance(t)?t.evaluate(e):BetaJS.Types.is_function(t)?t(e):this.evaluate(t,e)},evaluate:function(t,e){return this.__evaluate_query(t,e)},emulate:function(t,e,i){var s=e.apply(i||this,{}),n=s;return s?BetaJS.Types.is_array(s)&&(n=BetaJS.Iterators.ArrayIterator(s)):n=BetaJS.Iterators.ArrayIterator([]),new BetaJS.Iterators.FilteredIterator(n,function(e){return BetaJS.Queries.evaluate(t,e)})}},BetaJS.Queries.Constrained={make:function(t,e){return{query:t,options:e||{}}},is_constrained:function(t){return t&&(t.query||t.options)},format:function(t){var e=t.query;t.query=BetaJS.Queries.format(e);var i=JSON.stringify(t);return t.query=e,i},normalize:function(t){return{query:"query"in t?BetaJS.Queries.normalize(t.query):{},options:{skip:"options"in t&&"skip"in t.options?t.options.skip:null,limit:"limit"in t&&"limit"in t.options?t.options.limit:null,sort:"sort"in t&&"sort"in t.options?t.options.sort:{}}}},emulate:function(t,e,i,s,n){var r=t.query||{},o=t.options||{},a={},_={};"sort"in o&&"sort"in e&&(_.sort=o.sort),a=r,("query"in e||BetaJS.Types.is_empty(r))&&(a=r,(!o.sort||"sort"in e)&&("skip"in o&&"skip"in e&&(_.skip=o.skip),"limit"in o&&"limit"in e&&(_.limit=o.limit,"skip"in o&&!("skip"in e)&&(_.limit+=o.skip))));var c=[a,_];n&&c.push(n);var u=function(t){var i=t;return null===t?i=new BetaJS.Iterators.ArrayIterator([]):BetaJS.Types.is_array(t)&&(i=new BetaJS.Iterators.ArrayIterator(t)),"query"in e||BetaJS.Types.is_empty(r)||(i=new BetaJS.Iterators.FilteredIterator(i,function(t){return BetaJS.Queries.evaluate(r,t)})),"sort"in o&&!("sort"in _)&&(i=new BetaJS.Iterators.SortedIterator(i,BetaJS.Comparators.byObject(o.sort))),"skip"in o&&!("skip"in _)&&(i=new BetaJS.Iterators.SkipIterator(i,o.skip)),"limit"in o&&!("limit"in _)&&(i=new BetaJS.Iterators.LimitIterator(i,o.limit)),n&&n.success&&BetaJS.SyncAsync.callback(n,"success",i),i},h=function(t){if(!n||!n.exception)throw t;BetaJS.SyncAsync.callback(n,"exception",t)};if(n)i.apply(s||this,[a,_,{success:u,exception:h,sync:n.sync,context:n.context||this}]);else try{var l=i.apply(s||this,[a,_]);return u(l)}catch(d){h(d)}return!0},subsumizes:function(t,e){if(qopt=t.options||{},qopt2=e.options||{},qskip=qopt.skip||0,qskip2=qopt2.skip||0,qlimit=qopt.limit||null,qlimit2=qopt2.limit||null,qsort=qopt.sort,qsort2=qopt2.sort,qskip>qskip2)return!1;if(qlimit){if(!qlimit2)return!1;if(qlimit2+qskip2>qlimit+qskip)return!1}return(qskip||qlimit)&&(qsort||qsort2)&&JSON.stringify(qsort)!=JSON.stringify(qsort2)?!1:BetaJS.Queries.subsumizes(t.query,e.query)},serialize:function(t){return JSON.stringify(this.normalize(t))},unserialize:function(t){return JSON.parse(t)},mergeable:function(t,e){if(BetaJS.Queries.serialize(t.query)!=BetaJS.Queries.serialize(e.query))return!1;t.options||{};var i=e.options||{};return JSON.stringify(qopts.sort||{})!=JSON.stringify(i.sort||{})?!1:"skip"in qopts?"skip"in i?qopts.skip<=i.skip?!qopts.limit||qopts.skip+qopts.limit>=i.skip:!i.limit||i.skip+i.limit>=qopts.skip:!i.limit||i.limit>=qopts.skip:!("skip"in i)||!qopts.limit||qopts.limit>=i.skip},merge:function(t,e){t.options||{};var i=e.options||{};return{query:t.query,options:{skip:"skip"in qopts?"skip"in i?Math.min(qopts.skip,i.skip):null:null,limit:"limit"in qopts?"limit"in i?Math.max(qopts.limit,i.limit):null:null,sort:t.sort}}}},BetaJS.Class.extend("BetaJS.Queries.AbstractQueryModel",{register:function(){},executable:function(){}}),BetaJS.Queries.AbstractQueryModel.extend("BetaJS.Queries.DefaultQueryModel",{constructor:function(){this._inherited(BetaJS.Queries.DefaultQueryModel,"constructor"),this.__queries={}},_insert:function(t){this.__queries[BetaJS.Queries.Constrained.serialize(t)]=t},_remove:function(t){delete this.__queries[BetaJS.Queries.Constrained.serialize(t)]},exists:function(t){return BetaJS.Queries.Constrained.serialize(t)in this.__queries},subsumizer_of:function(t){if(this.exists(t))return t;var e=null;return BetaJS.Objs.iter(this.__queries,function(i){return BetaJS.Queries.Constrained.subsumizes(i,t)&&(e=i),!e},this),e},executable:function(t){return!!this.subsumizer_of(t)},register:function(t){for(var e=!0;e;)e=!1,BetaJS.Objs.iter(this.__queries,function(i){BetaJS.Queries.Constrained.subsumizes(t,i)&&(this._remove(i),e=!0)},this);this._insert(t)},invalidate:function(t){var e=this.subsumizer_of(t);e&&this._remove(e)}}),BetaJS.Queries.DefaultQueryModel.extend("BetaJS.Queries.StoreQueryModel",{constructor:function(t){this.__store=t,this._inherited(BetaJS.Queries.StoreQueryModel,"constructor")},initialize:function(t){this.__store.query({},{},{context:this,success:function(e){for(;e.hasNext();){var i=e.next();delete i.id,this._insert(i)}BetaJS.SyncAsync.callback(t,"success")},exception:function(e){BetaJS.SyncAsync.callback(t,"exception",e)}})},_insert:function(t){this._inherited(BetaJS.Queries.StoreQueryModel,"_insert",t),this.__store.insert(t,{})},_remove:function(t){delete this.__queries[BetaJS.Queries.Constrained.serialize(t)],this.__store.query({query:t},{},{context:this,success:function(t){for(;t.hasNext();)this.__store.remove(t.next().id,{})}})}}),BetaJS.Collections.Collection.extend("BetaJS.Collections.QueryCollection",{constructor:function(t,e,i,s){this._source=t,this._inherited(BetaJS.Collections.QueryCollection,"constructor",i),this._options=BetaJS.Objs.extend({forward_steps:null,backward_steps:null,range:null},i),null!==e&&this.set_query(e,s)},query:function(){return this._query},set_query:function(t,e){e&&(e.context=e.context||this),this._query=BetaJS.Objs.extend({query:{},options:{}},t),this._query.options.skip=this._query.options.skip||0,this._query.options.limit=this._query.options.limit||null,this._query.options.sort=this._query.options.sort||{},this._count=0,this.__execute_query(this._query.options.skip,this._query.options.limit,!0,e)},__sub_query:function(t,e){this._source.query(this._query.query,t,e)},__execute_query:function(t,e,i,s){t=Math.max(t,0);var n={};this._query.options.sort&&!BetaJS.Types.is_empty(this._query.options.sort)&&(n.sort=this._query.options.sort),i?(t>0&&(n.skip=t),null!==e&&(n.limit=e),this.__sub_query(n,{context:this,success:function(i){var n=i.asArray();this._query.options.skip=t,this._query.options.limit=e,this._count=!e||e>n.length?t+n.length:null,this.clear(),this.add_objects(n),BetaJS.SyncAsync.callback(s,"success")}})):this._query.options.skip>t?(e=this._query.options.skip-t,t>0&&(n.skip=t),n.limit=e,this.__sub_query(n,{context:this,success:function(e){var i=e.asArray();this._query.options.skip=t;var n=this.add_objects(i);this._query.options.limit=null===this._query.options.limit?null:this._query.options.limit+n,BetaJS.SyncAsync.callback(s,"success")}})):t>=this._query.options.skip&&null!==this._query.options.limit&&(!e||t+e>this._query.options.skip+this._query.options.limit)&&(e=t+e-(this._query.options.skip+this._query.options.limit),t=this._query.options.skip+this._query.options.limit,t>0&&(n.skip=t),e&&(n.limit=e),this.__sub_query(n,{context:this,success:function(i){var n=i.asArray(),r=this.add_objects(n);this._query.options.limit=this._query.options.limit+r,e>n.length&&(this._count=t+r),BetaJS.SyncAsync.callback(s,"success")}}))},increase_forwards:function(t,e){t=t?t:this._options.forward_steps,t&&null!==this._query.options.limit&&this.__execute_query(this._query.options.skip+this._query.options.limit,t,!1,e)},increase_backwards:function(t){t=t?t:this._options.backward_steps,t&&this._query.options.skip>0&&(t=Math.min(t,this._query.options.skip),this.__execute_query(this._query.options.skip-t,t,!1))},paginate:function(t){this.__execute_query(this._options.range*t,this._options.range,!0)},paginate_index:function(){return this._options.range?Math.floor(this._query.options.skip/this._options.range):null},paginate_count:function(){return this._count&&this._options.range?Math.ceil(this._count/this._options.range):null},next:function(){var t=this.paginate_index();if(t){var e=this.paginate_count();(!e||this.paginate_count()-1>t)&&this.paginate(t+1)}},prev:function(){var t=this.paginate_index();t&&t>0&&this.paginate(t-1)},isComplete:function(){return null!==this._count}}),BetaJS.Collections.QueryCollection.extend("BetaJS.Collections.ActiveQueryCollection",{constructor:function(t,e,i,s){this._inherited(BetaJS.Collections.ActiveQueryCollection,"constructor",t,e,i,s),t.on("create",this.__active_create,this),t.on("remove",this.__active_remove,this),t.on("update",this.__active_update,this)},destroy:function(){this._source.off(null,null,this),this._inherited(BetaJS.Collections.ActiveQueryCollection,"destroy")},is_valid:function(t){return BetaJS.Queries.evaluate(this.query().query,t.getAll())},__active_create:function(t){this.is_valid(t)&&!this.exists(t)&&(this.add(t),this._count=this._count+1,null!==this._query.options.limit&&(this._query.options.limit=this._query.options.limit+1))},__active_remove:function(t){this.exists(t)&&(this.remove(t),this._count=this._count-1,null!==this._query.options.limit&&(this._query.options.limit=this._query.options.limit-1))},__active_update:function(t){this.is_valid(t)?this.__active_create(t):this.__active_remove(t)}}),BetaJS.Exceptions.Exception.extend("BetaJS.Stores.StoreException"),BetaJS.Class.extend("BetaJS.Stores.ListenerStore",[BetaJS.Events.EventsMixin,{constructor:function(t){this._inherited(BetaJS.Stores.ListenerStore,"constructor"),t=t||{},this._id_key=t.id_key||"id"},id_key:function(){return this._id_key},_inserted:function(t,e){this.trigger("insert",t,e)},_removed:function(t,e){this.trigger("remove",t,e)},_updated:function(t,e,i){this.trigger("update",t,e,i)}}]),BetaJS.Stores.BaseStore=BetaJS.Stores.ListenerStore.extend("BetaJS.Stores.BaseStore",[BetaJS.SyncAsync.SyncAsyncMixin,{constructor:function(t){this._inherited(BetaJS.Stores.BaseStore,"constructor",t),t=t||{},this._id_key=t.id_key||"id",this._create_ids=t.create_ids||!1,this._last_id=1,this._supportsSync=!0,this._supportsAsync=!0,this._query_model="query_model"in t?t.query_model:null},query_model:function(){return arguments.length>0&&(this._query_model=arguments[0]),this._query_model},_insert:function(){throw new BetaJS.Stores.StoreException("unsupported: insert")},_remove:function(){throw new BetaJS.Stores.StoreException("unsupported: remove")},_get:function(){throw new BetaJS.Stores.StoreException("unsupported: get")},_update:function(){throw new BetaJS.Stores.StoreException("unsupported: update")},_query_capabilities:function(){return{}},_query:function(){throw new BetaJS.Stores.StoreException("unsupported: query")},insert:function(t,e){var i=null;if(BetaJS.Types.is_array(t)&&(i=t[1],t=t[0]),this._create_ids&&!(this._id_key in t&&t[this._id_key])){for(;this.get(this._last_id);)this._last_id++;t[this._id_key]=this._last_id}return this.then(this._insert,[t],e,function(t,e){this._inserted(t,i),BetaJS.SyncAsync.callback(e,"success",t)})},insert_all:function(t,e,i){var s=null;if(arguments.length>3&&(s=arguments[3]),i&&this._query_model&&(this.trigger("query_register",i),this._query_model.register(i)),e){var n=this,r=function(i){return i>=t.length?(BetaJS.SyncAsync.callback(e,"success"),void 0):(this.insert(s?[t[i],s]:t[i],BetaJS.SyncAsync.mapSuccess(e,function(){r.call(n,i+1)})),void 0)};r.call(this,0)}else for(var o=0;t.length>o;++o)this.insert(s?[t[o],s]:t[o])},remove:function(t,e){var i=null;return BetaJS.Types.is_array(t)&&(i=t[1],t=t[0]),this.then(this._remove,[t],e,function(e,s){this._removed(t,i),BetaJS.SyncAsync.callback(s,"success",t)})},get:function(t,e){return this.delegate(this._get,[t],e)},update:function(t,e,i){var s=null;return BetaJS.Types.is_array(e)&&(s=e[1],e=e[0]),this.then(this._update,[t,e],i,function(t,i){this._updated(t,e,s),BetaJS.SyncAsync.callback(i,"success",t,e)})},query:function(t,e,i){if(e&&(e.limit&&(e.limit=parseInt(e.limit,10)),e.skip&&(e.skip=parseInt(e.skip,10))),this._query_model){var s=this._query_model.subsumizer_of({query:t,options:e});if(!s){this.trigger("query_miss",{query:t,options:e});var n=new BetaJS.Stores.StoreException("Cannot execute query");if(!i)throw n;return BetaJS.SyncAsync.callback(i,"exception",n),null}this.trigger("query_hit",{query:t,options:e},s)}var r=function(i){return BetaJS.Queries.Constrained.emulate(BetaJS.Queries.Constrained.make(t,e||{}),this._query_capabilities(),this._query,this,i)};return this.either(i,r,r)},_query_applies_to_id:function(t,e){var i=this.get(e);return i&&BetaJS.Queries.overloaded_evaluate(t,i)},clear:function(t){return this.then(this.query,[{},{}],t,function(t,e){for(var i=[];t.hasNext();)i.push(this.remove,[t.next().id]);return this.join(i,e)})},_ensure_index:function(){},ensure_index:function(t){this._ensure_index(t)},perform:function(t,e){var i=BetaJS.Objs.keyByIndex(t),s=BetaJS.Objs.valueByIndex(t);if("insert"==i)this.insert(s,e);else if("remove"==i)this.remove(s,e);else{if("update"!=i)throw new BetaJS.Stores.StoreException("unsupported: perform "+i);this.update(BetaJS.Objs.keyByIndex(s),BetaJS.Objs.valueByIndex(s),e)}},bulk:function(t,e,i){var s=[];if(i){var n=function(){s.length<t.length?this.perform(t[s.length],{context:this,success:function(){s.push(!0),n.apply(this)},exception:function(t){s.push(!1),e?n.apply(this):i.exception.apply(i.context||this,t)}}):i.success.call(i.context||this,s)};n.apply(this)}else for(var r=0;t.length>r;++r)try{this.perform(t[r]),s.push(!0)}catch(o){if(s.push(!1),!e)throw o}return s}}]),BetaJS.Stores.BaseStore.extend("BetaJS.Stores.AssocStore",{_read_key:function(){},_write_key:function(){},_remove_key:function(){},_iterate:function(){},constructor:function(t){t=t||{},t.create_ids=!0,this._inherited(BetaJS.Stores.AssocStore,"constructor",t),this._supportsAsync=!1},_insert:function(t){return this._write_key(t[this._id_key],t),t},_remove:function(t){var e=this._read_key(t);return e&&!this._remove_key(t)?null:e},_get:function(t){return this._read_key(t)},_update:function(t,e){var i=this._get(t);return i&&(this._id_key in e&&(this._remove_key(t),t=e[this._id_key],delete e[this._id_key]),BetaJS.Objs.extend(i,e),this._write_key(t,i)),i},_query:function(){return this._iterate()}}),BetaJS.Stores.AssocStore.extend("BetaJS.Stores.MemoryStore",{constructor:function(t){this._inherited(BetaJS.Stores.MemoryStore,"constructor",t),this.__data={}},_read_key:function(t){return this.__data[t]},_write_key:function(t,e){this.__data[t]=e},_remove_key:function(t){delete this.__data[t]},_iterate:function(){return new BetaJS.Iterators.ObjectValuesIterator(this.__data)}}),BetaJS.Stores.BaseStore.extend("BetaJS.Stores.DumbStore",{_read_last_id:function(){},_write_last_id:function(){},_remove_last_id:function(){},_read_first_id:function(){},_write_first_id:function(){},_remove_first_id:function(){},_read_item:function(){},_write_item:function(){},_remove_item:function(){},_read_next_id:function(){},_write_next_id:function(){},_remove_next_id:function(){},_read_prev_id:function(){},_write_prev_id:function(){},_remove_prev_id:function(){},constructor:function(t){t=t||{},t.create_ids=!0,this._inherited(BetaJS.Stores.DumbStore,"constructor",t),this._supportsAsync=!1},_insert:function(t){var e=this._read_last_id(),i=t[this._id_key];return null!==e?(this._write_next_id(e,i),this._write_prev_id(i,e)):this._write_first_id(i),this._write_last_id(i),this._write_item(i,t),t},_remove:function(t){var e=this._read_item(t);if(e){this._remove_item(t);var i=this._read_next_id(t),s=this._read_prev_id(t);null!==i?(this._remove_next_id(t),null!==s?(this._remove_prev_id(t),this._write_next_id(s,i),this._write_prev_id(i,s)):(this._remove_prev_id(i),this._write_first_id(i))):null!==s?(this._remove_next_id(s),this._write_last_id(s)):(this._remove_first_id(),this._remove_last_id())}return e},_get:function(t){return this._read_item(t)},_update:function(t,e){var i=this._get(t);return i&&(delete e[this._id_key],BetaJS.Objs.extend(i,e),this._write_item(t,i)),i},_query_capabilities:function(){return{query:!0}},_query:function(t){var e=new BetaJS.Iterators.Iterator,i=this,s=this._read_first_id();return BetaJS.Objs.extend(e,{__id:null===s?1:s,__store:i,__query:t,hasNext:function(){var e=this.__store._read_last_id();if(null===e)return!1;for(;e>this.__id&&!this.__store._read_item(this.__id);)this.__id++;for(;e>=this.__id;){if(this.__store._query_applies_to_id(t,this.__id))return!0;e>this.__id?this.__id=this.__store._read_next_id(this.__id):this.__id++}return!1},next:function(){if(this.hasNext()){var t=this.__store.get(this.__id);return this.__id==this.__store._read_last_id()?this.__id++:this.__id=this.__store._read_next_id(this.__id),t}return null}}),e}}),BetaJS.Stores.DumbStore.extend("BetaJS.Stores.AssocDumbStore",{_read_key:function(){},_write_key:function(){},_remove_key:function(){},__read_id:function(t){var e=this._read_key(t);return e?parseInt(e,10):null},_read_last_id:function(){return this.__read_id("last_id")},_write_last_id:function(t){this._write_key("last_id",t)},_remove_last_id:function(){this._remove_key("last_id")},_read_first_id:function(){return this.__read_id("first_id")},_write_first_id:function(t){this._write_key("first_id",t)},_remove_first_id:function(){this._remove_key("first_id")},_read_item:function(t){return this._read_key("item_"+t)},_write_item:function(t,e){this._write_key("item_"+t,e)},_remove_item:function(t){this._remove_key("item_"+t)},_read_next_id:function(t){return this.__read_id("next_"+t)},_write_next_id:function(t,e){this._write_key("next_"+t,e)},_remove_next_id:function(t){this._remove_key("next_"+t)},_read_prev_id:function(t){return this.__read_id("prev_"+t)},_write_prev_id:function(t,e){this._write_key("prev_"+t,e)},_remove_prev_id:function(t){this._remove_key("prev_"+t)}}),BetaJS.Stores.AssocDumbStore.extend("BetaJS.Stores.LocalStore",{constructor:function(t){this._inherited(BetaJS.Stores.LocalStore,"constructor",t),this.__prefix=t.prefix},__key:function(t){return this.__prefix+t},_read_key:function(t){var e=this.__key(t);return e in localStorage?JSON.parse(localStorage[e]):null},_write_key:function(t,e){localStorage[this.__key(t)]=JSON.stringify(e)},_remove_key:function(t){delete localStorage[this.__key(t)]}}),BetaJS.Stores.BaseStore.extend("BetaJS.Stores.DualStore",{constructor:function(t,e,i){i=BetaJS.Objs.extend({create_options:{},update_options:{},delete_options:{},get_options:{},query_options:{}},i||{}),i.id_key=t._id_key,this.__first=t,this.__second=e,this._inherited(BetaJS.Stores.DualStore,"constructor",i),this._supportsSync=t.supportsSync()&&e.supportsSync(),this._supportsAsync=t.supportsAsync()||e.supportsAsync(),this.__create_options=BetaJS.Objs.extend({start:"first",strategy:"then",auto_replicate:"first"},i.create_options),this.__update_options=BetaJS.Objs.extend({start:"first",strategy:"then",auto_replicate:"first"},i.update_options),this.__remove_options=BetaJS.Objs.extend({start:"first",strategy:"then",auto_replicate:"first"},i.delete_options),this.__get_options=BetaJS.Objs.extend({start:"first",strategy:"or",clone:!0,clone_second:!1,or_on_null:!0},i.get_options),this.__query_options=BetaJS.Objs.extend({start:"first",strategy:"or",clone:!0,clone_second:!1,or_on_null:!0},i.query_options),this.__first.on("insert",this.__inserted_first,this),this.__second.on("insert",this.__inserted_second,this),this.__first.on("update",this.__updated_first,this),this.__second.on("update",this.__updated_second,this),this.__first.on("remove",this.__removed_first,this),this.__second.on("remove",this.__removed_second,this)
},__inserted_first:function(t,e){e&&e.dual_insert||(("first"==this.__create_options.auto_replicate||"both"==this.__create_options.auto_replicate)&&this.__second.insert([t,{dual_insert:!0}],{}),this._inserted(t))},__inserted_second:function(t,e){e&&e.dual_insert||(("second"==this.__create_options.auto_replicate||"both"==this.__create_options.auto_replicate)&&this.__first.insert([t,{dual_insert:!0}],{}),this._inserted(t))},__updated_first:function(t,e,i){i&&i.dual_update||(("first"==this.__update_options.auto_replicate||"both"==this.__update_options.auto_replicate)&&this.__second.update(t[this.id_key()],[e,{dual_update:!0}],{}),this._updated(t,e))},__updated_second:function(t,e,i){i&&i.dual_update||(("second"==this.__update_options.auto_replicate||"both"==this.__update_options.auto_replicate)&&this.__first.update(t[this.id_key()],[e,{dual_update:!0}],{}),this._updated(t,e))},__removed_first:function(t,e){e&&e.dual_remove||(("first"==this.__remove_options.auto_replicate||"both"==this.__remove_options.auto_replicate)&&this.__second.remove([t,{dual_remove:!0}],{}),this._removed(t))},__removed_second:function(t,e){e&&e.dual_remove||(("second"==this.__remove_options.auto_replicate||"both"==this.__remove_options.auto_replicate)&&this.__first.remove([t,{dual_remove:!0}],{}),this._removed(t))},first:function(){return this.__first},second:function(){return this.__second},_insert:function(t,e){var i=this.__first,s=this.__second;"first"!=this.__create_options.start&&(i=this.__second,s=this.__first);var n=this.__create_options.strategy;if(e)if("then"==n)i.insert([t,{dual_insert:!0}],{success:function(t){s.insert([t,{dual_insert:!0}],e)},exception:e.exception});else{if("or"==n)return i.insert([t,{dual_insert:!0}],{success:e.success,exception:function(){s.insert([t,{dual_insert:!0}],e)}});i.insert([t,{dual_insert:!0}],e)}else{if("then"==n)return s.insert([i.insert([t,{dual_insert:!0}]),{dual_insert:!0}]);if("or"!=n)return i.insert([t,{dual_insert:!0}]);try{return i.insert([t,{dual_insert:!0}])}catch(r){return s.insert([t,{dual_insert:!0}])}}return!0},_update:function(t,e,i){var s=this.__first,n=this.__second;"first"!=this.__update_options.start&&(s=this.__second,n=this.__first);var r=this.__update_options.strategy;if(i)if("then"==r)s.update(t,[e,{dual_update:!0}],{success:function(e){n.update(t,[e,{dual_update:!0}],i)},exception:i.exception});else{if("or"==r)return s.update(t,[e,{dual_update:!0}],{success:i.success,exception:function(){n.update(t,[e,{dual_update:!0}],i)}});s.update(t,[e,{dual_update:!0}],i)}else{if("then"==r)return n.update(t,[s.update(t,[e,{dual_update:!0}]),{dual_update:!0}]);if("or"!=r)return s.update(t,[e,{dual_update:!0}]);try{return s.update(t,[e,{dual_update:!0}])}catch(o){return n.update(t,[e,{dual_update:!0}])}}return!0},_remove:function(t,e){var i=this.__first,s=this.__second;"first"!=this.__remove_options.start&&(i=this.__second,s=this.__first);var n=this.__remove_options.strategy;if(e)"then"==n?i.remove([t,{dual_remove:!0}],{success:function(){s.remove([t,{dual_remove:!0}],e)},exception:e.exception}):"or"==n?i.remove([t,{dual_remove:!0}],{success:e.success,exception:function(){s.remove([t,{dual_remove:!0}],e)}}):i.remove(t,e);else if("then"==n)i.remove([t,{dual_remove:!0}]),s.remove([t,{dual_remove:!0}]);else if("or"==n)try{i.remove([t,{dual_remove:!0}])}catch(r){s.remove([t,{dual_remove:!0}])}else i.remove([t,{dual_remove:!0}])},_query_capabilities:function(){return{query:!0,sort:!0,limit:!0,skip:!0}},_get:function(t,e){var i=this.__first,s=this.__second;"first"!=this.__get_options.start&&(i=this.__second,s=this.__first);var n=this.__get_options.strategy,r=this.__get_options.clone,o=this.__get_options.clone_second,a=this.__get_options.or_on_null;if("or"==n){var _=function(e){s.get(t,BetaJS.SyncAsync.mapSuccess(e,function(t){t&&r?i.delegate(i.insert,[t],e):this.callback(e,"success",t)}))};return i.then(i.get,[t],e,function(e,i){return!e&&a?(_(i),void 0):(o?s.get(t,{success:function(t){t?this.callback(i,"success",e):s.insert(e,i)},exception:function(){s.insert(e,i)}}):this.callback(i,"success",e),void 0)},function(t,e){_(e)})}return i.get(t,e)},_query:function(t,e,i){var s=this.__first,n=this.__second;"first"!=this.__query_options.start&&(s=this.__second,n=this.__first);var r=this.__query_options.strategy,o=this.__query_options.clone,a=this.__get_options.clone_second,_=this.__query_options.or_on_null,c=null;if("or"==r){var u=function(i){return this.trigger("query_second",t,e),n.query(t,e,BetaJS.SyncAsync.mapSuccess(i,function(n){if(n&&o){arr=n.asArray(),n=new BetaJS.Iterators.ArrayIterator(arr);var r=BetaJS.SyncAsync.mapSuccess(i,function(){BetaJS.SyncAsync.callback(i,"success",n)});s.insert_all(arr,r,{query:t,options:e},{dual_insert:!0})}else BetaJS.SyncAsync.callback(i,"success",n)})),c},h=function(i,s){arr=i.asArray(),i=new BetaJS.Iterators.ArrayIterator(arr);var r=BetaJS.SyncAsync.mapSuccess(s,function(){BetaJS.SyncAsync.callback(s,"success",i)});n.insert_all(arr,r,{query:t,options:e},{dual_insert:!0})};return this.trigger("query_first",t,e),this.then(s,s.query,[t,e],i,function(i,s){return!i&&_?(u.call(this,s),void 0):(a?(this.trigger("query_second",t,e),n.query(t,e,{success:function(t){t?this.callback(s,"success",i):h(i,s)},exception:function(){h(i,s)}})):this.callback(s,"success",i),void 0)},function(t,e){u.call(this,e)})}return this.trigger("query_first",t,e),s.query(t,e,i)}}),BetaJS.Stores.DualStore.extend("BetaJS.Stores.CachedStore",{constructor:function(t,e){e=e||{};var i=e.cache_store;"cache_store"in e||(i=this._auto_destroy(new BetaJS.Stores.MemoryStore({id_key:t.id_key()}))),i.query_model()||i.query_model(e.cache_query_model?e.cache_query_model:this._auto_destroy(new BetaJS.Queries.DefaultQueryModel)),this.__invalidation_options=e.invalidation||{},this._inherited(BetaJS.Stores.CachedStore,"constructor",t,i,BetaJS.Objs.extend({get_options:{start:"second",strategy:"or"},query_options:{start:"second",strategy:"or",clone:!0,or_on_null:!1}},e)),this.__invalidation_options.reload_after_first_hit&&(this.__queries={},this.cache().on("query_hit",function(t,e){var i=BetaJS.Queries.Constrained.serialize(e);this.__queries[i]||(this.__queries[i]=!0,BetaJS.SyncAsync.eventually(function(){this.invalidate_query(e,!0)},[],this))},this),this.cache().on("query_miss",function(t){var e=BetaJS.Queries.Constrained.serialize(t);this.__queries[e]=!0},this))},destroy:function(){this.cache().off(null,null,this),this._inherited(BetaJS.Stores.CachedStore,"destroy")},invalidate_query:function(t,e){this.cache().query_model().invalidate(t),e&&(this.supportsAsync()?this.query(t.query,t.options,{}):this.query(t.query,t.options)),this.trigger("invalidate_query",t,e)},cache:function(){return this.second()},store:function(){return this.first()}}),BetaJS.Stores.BaseStore.extend("BetaJS.Stores.ConversionStore",{constructor:function(t,e){e=e||{},e.id_key=t._id_key,this._inherited(BetaJS.Stores.ConversionStore,"constructor",e),this.__store=t,this.__key_encoding=e.key_encoding||{},this.__key_decoding=e.key_decoding||{},this.__value_encoding=e.value_encoding||{},this.__value_decoding=e.value_decoding||{}},encode_object:function(t){var e={};for(var i in t){var s=this.encode_key(i);s&&(e[s]=this.encode_value(i,t[i]))}return e},decode_object:function(t){var e={};for(var i in t){var s=this.decode_key(i);s&&(e[s]=this.decode_value(i,t[i]))}return e},encode_key:function(t){return t in this.__key_encoding?this.__key_encoding[t]:t},decode_key:function(t){return t in this.__key_decoding?this.__key_decoding[t]:t},encode_value:function(t,e){return t in this.__value_encoding?this.__value_encoding[t](e):e},decode_value:function(t,e){return t in this.__value_decoding?this.__value_decoding[t](e):e},_query_capabilities:function(){return this.__store._query_capabilities()},_ensure_index:function(t){return this.__store.ensure_index(t)},_insert:function(t,e){return this.then(this.__store,this.__store.insert,[this.encode_object(t)],e,function(t,e){e.success(this.decode_object(t))})},_remove:function(t,e){return this.delegate(this.__store,this.__store.remove,[this.encode_value(this._id_key,t)],e)},_get:function(t,e){return this.then(this.__store,this.__store.get,[this.encode_value(this._id_key,t)],e,function(t,e){e.success(this.decode_object(t))})},_update:function(t,e,i){return this.then(this.__store,this.__store.update,[this.encode_value(this._id_key,t),this.encode_object(e)],i,function(t,e){e.success(this.decode_object(t))})},_query:function(t,e,i){return this.then(this.__store,this.__store.query,[this.encode_object(t),e],i,function(t,e){var i=new BetaJS.Iterators.MappedIterator(t,function(t){return this.decode_object(t)},this);e.success(i)})}}),BetaJS.Stores.BaseStore.extend("BetaJS.Stores.PassthroughStore",{constructor:function(t,e){this.__store=t,e=e||{},e.id_key=t.id_key(),this._projection=e.projection||{},this._inherited(BetaJS.Stores.PassthroughStore,"constructor",e),this._supportsAsync=t.supportsAsync(),this._supportsSync=t.supportsSync(),e.destroy_store&&this._auto_destroy(t)},_query_capabilities:function(){return this.__store._query_capabilities()},_insert:function(t,e){return this.__store.insert(BetaJS.Objs.extend(t,this._projection),e)},_remove:function(t,e){return this.__store.remove(t,e)},_get:function(t,e){return this.__store.get(t,e)},_update:function(t,e,i){return this.__store.update(t,e,i)},_query:function(t,e,i){return this.__store.query(BetaJS.Objs.extend(t,this._projection),e,i)},_ensure_index:function(t){return this.__store.ensure_index(t)},_store:function(){return this.__store}}),BetaJS.Stores.PassthroughStore.extend("BetaJS.Stores.ActiveStore",{constructor:function(t,e,i){this._inherited(BetaJS.Stores.ActiveStore,"constructor",t,i),this.__listener=e,this.delegateEvents(null,e)}}),BetaJS.Stores.BaseStore.extend("BetaJS.Stores.SocketStore",{constructor:function(t,e,i){this._inherited(BetaJS.Stores.SocketStore,"constructor",t),this.__socket=e,this.__prefix=i,this._supportsAsync=!1},__send:function(t,e){this.__socket.emit(this.__prefix+":"+t,e)},_insert:function(t){this.__send("insert",t)},_remove:function(t){this.__send("remove",t)},_update:function(t,e){this.__send("update",BetaJS.Objs.objectBy(t,e))},bulk:function(t){this.__send("bulk",t)}}),BetaJS.Stores.ListenerStore.extend("BetaJS.Stores.SocketListenerStore",{constructor:function(t,e,i){this._inherited(BetaJS.Stores.SocketListenerStore,"constructor",t);var s=this;this.__prefix=i,e.on(this.__prefix+":insert",function(t){s._perform("insert",t)}),e.on(this.__prefix+":remove",function(t){s._perform("remove",t)}),e.on(this.__prefix+":update",function(t){s._perform("update",t)}),e.on(this.__prefix+":bulk",function(t){for(var e=0;t.length>e;++e)s._perform(BetaJS.Objs.keyByIndex(t[e]),BetaJS.Objs.valueByIndex(t[e]))})},_perform:function(t,e){if("insert"==t)this._inserted(e);else if("remove"==t)this._removed(e);else{if("update"!=t)throw new BetaJS.Stores.StoreException("unsupported: perform "+t);this._updated(BetaJS.Objs.objectBy(this.id_key(),BetaJS.Objs.keyByIndex(e)),BetaJS.Objs.valueByIndex(e))}}}),BetaJS.Class.extend("BetaJS.Stores.StoresMonitor",[BetaJS.Events.EventsMixin,{attach:function(t,e){e.on("insert",function(i){this.trigger("insert",t,e,i),this.trigger("write","insert",t,e,i)},this),e.on("remove",function(i){this.trigger("remove",t,e,i),this.trigger("write","remove",t,e,i)},this),e.on("update",function(i,s){this.trigger("update",t,e,i,s),this.trigger("write","update",t,e,i,s)},this)}}]),BetaJS.Class.extend("BetaJS.Stores.StoreHistory",[BetaJS.Events.EventsMixin,{constructor:function(t,e){this._inherited(BetaJS.Stores.StoreHistory,"constructor"),e=e||{},this._combine_update_update=e.combine_update_update||!1,this._combine_insert_update=e.combine_insert_update||!1,this._combine_insert_remove=e.combine_insert_remove||!1,this._combine_update_remove=e.combine_update_remove||!1,this._commits={},this._revision_id=null,this._store=t,this._item_commits={},this._store.on("insert",function(t){this.__add_commit({action:"insert",id:t[this._store.id_key()],data:t})},this),this._store.on("remove",function(t){this.__add_commit({action:"remove",id:t})},this),this._store.on("update",function(t,e){this.__add_commit({action:"update",id:t,data:e})},this)},__remove_commit:function(t){this.trigger("remove",this._commits[t]);var e=this._commits[t].id;delete this._commits[t],delete this._item_commits[e],BetaJS.Objs.is_empty(this._item_commits[e])&&delete this._item_commits[e]},__add_commit:function(t){t.revision_id=this._new_revision_id();var e=!1,i=!1,s=null;for(var n in this._item_commits[t.id]){var r=this._commits[n];e=e||"insert"==r.action,i=i||"update"==r.action,s=n}if(this._revision_id=t.revision_id,this._commits[this._revision_id]=t,this._item_commits[t.id]=this._item_commits[t.id]||{},this._item_commits[t.id][t.revision_id]=!0,this.trigger("commit",t),"update"==t.action)(this._combine_insert_update&&!i&&e||this._combine_update_update&&i)&&(this.__remove_commit(t.revision_id),this._commits[s].data=BetaJS.Objs.extend(this._commits[s].data,t.data));else if("remove"==t.action)for(n in this._item_commits[t.id])r=this._commits[n],(e&&this._combine_insert_remove||"update"==r.action&&this._combine_update_remove)&&this.__remove_commit(n)},flush:function(t){t=t||this._revision_id;for(var e in this._commits){if(e>t)break;this.__remove_commit(e)}},serialize:function(t){var e=this._commits[t];return"insert"==commin.action?{insert:e.data}:"remove"==e.action?{remove:e.id}:"update"==e?{update:BetaJS.Objs.objectBy(e.id,e.data)}:null},serialize_bulk:function(t){t=t||this._revision_id;var e=[];for(var i in this._commits){if(i>t)break;e.push(this.serialize(i))}return e},revision_id:function(){return this._revision_id},_new_revision_id:function(){return this.cls.__revision_id+1}}],{__revision_id:0}),BetaJS.Net=BetaJS.Net||{},BetaJS.Net.HttpHeader={HTTP_STATUS_OK:200,HTTP_STATUS_CREATED:201,HTTP_STATUS_PAYMENT_REQUIRED:402,HTTP_STATUS_FORBIDDEN:403,HTTP_STATUS_NOT_FOUND:404,HTTP_STATUS_PRECONDITION_FAILED:412,HTTP_STATUS_INTERNAL_SERVER_ERROR:500,format:function(t,e){var i="";return i=t==this.HTTP_STATUS_OK?"OK":t==this.HTTP_STATUS_CREATED?"Created":t==this.HTTP_STATUS_PAYMENT_REQUIRED?"Payment Required":t==this.HTTP_STATUS_FORBIDDEN?"Forbidden":t==this.HTTP_STATUS_NOT_FOUND?"Not found":t==this.HTTP_STATUS_PRECONDITION_FAILED?"Precondition Failed":t==this.HTTP_STATUS_INTERNAL_SERVER_ERROR?"Internal Server Error":"Other Error",e?t+" "+i:i}},BetaJS.Exceptions.Exception.extend("BetaJS.Modelling.ModelException",{constructor:function(t,e){this._inherited(BetaJS.Modelling.ModelException,"constructor",e),this.__model=t},model:function(){return this.__model}}),BetaJS.Modelling.ModelException.extend("BetaJS.Modelling.ModelMissingIdException",{constructor:function(t){this._inherited(BetaJS.Modelling.ModelMissingIdException,"constructor",t,"No id given.")}}),BetaJS.Modelling.ModelException.extend("BetaJS.Modelling.ModelInvalidException",{constructor:function(t){var e=BetaJS.Objs.values(t.errors()).join("\n");this._inherited(BetaJS.Modelling.ModelInvalidException,"constructor",t,e)}}),BetaJS.Properties.Properties.extend("BetaJS.Modelling.SchemedProperties",{constructor:function(t,e){this._inherited(BetaJS.Modelling.SchemedProperties,"constructor");var i=this.cls.scheme();this._properties_changed={},this.__errors={},this.__unvalidated={};for(var s in i)"def"in i[s]?this.set(s,i[s].def):i[s].auto_create?this.set(s,i[s].auto_create(this)):this.set(s,null);e=e||{},this._properties_changed={},this.__errors={};for(s in t)this.set(s,t[s])},_unsetChanged:function(t){delete this._properties_changed[t]},_beforeSet:function(t,e){var i=this.cls.scheme();if(!(t in i))return e;var s=i[t];return"boolean"==s.type?BetaJS.Types.parseBool(e):(s.transform&&(e=s.transform.apply(this,[e])),e)},_afterSet:function(t,e){var i=this.cls.scheme();if(t in i&&(this._properties_changed[t]=e,this.__unvalidated[t]=!0,delete this.__errors[t],i[t].after_set)){var s=BetaJS.Types.is_string(i[t].after_set)?this[i[t].after_set]:i[t].after_set;s.apply(this,[e])}},properties_changed:function(t){return BetaJS.Types.is_boolean(t)?BetaJS.Objs.filter(this._properties_changed,function(e,i){return this.validateAttr(i)==t},this):this._properties_changed},get_all_properties:function(){var t={},e=this.cls.scheme();for(var i in e)t[i]=this.get(i);return t},properties_by:function(t){return BetaJS.Types.is_boolean(t)?BetaJS.Objs.filter(this.get_all_properties(),function(e,i){return this.validateAttr(i)==t},this):this.get_all_properties()},validate:function(){this.trigger("validate");for(var t in this.__unvalidated)this.validateAttr(t);return this._customValidate(),BetaJS.Types.is_empty(this.__errors)},_customValidate:function(){},validateAttr:function(t){if(t in this.__unvalidated){delete this.__unvalidated[t],delete this.__errors[t];var e=this.cls.scheme(),i=e[t];if("validate"in i){var s=i.validate;BetaJS.Types.is_array(s)||(s=[s]);var n=this.get(t);BetaJS.Objs.iter(s,function(e){var i=e.validate(n,this);return i&&(this.__errors[t]=i),null===i},this)}this.trigger("validate:"+t,!(t in this.__errors),this.__errors[t])}return!(t in this.__errors)},setError:function(t,e){delete this.__unvalidated[t],this.__errors[t]=e,this.trigger("validate:"+t,!(t in this.__errors),this.__errors[t])},revalidate:function(){return this.__errors={},this.__unvalidated=this.keys(!0),this.validate()},errors:function(){return this.__errors},getError:function(t){return this.__errors[t]},asRecord:function(t){var e={},i=this.cls.scheme(),s=this.get_all_properties();t=t||{};for(var n in s)if(n in i){var r=i[n].tags||[],o={};BetaJS.Objs.iter(r,function(t){o[t]=!0});var a=!0;BetaJS.Objs.iter(t,function(t){a=a&&t in o},this),a&&(e[n]=s[n])}return e},setByTags:function(t,e){var i=this.cls.scheme();e=e||{};for(var s in t)if(s in i){var n=i[s].tags||[],r={};BetaJS.Objs.iter(n,function(t){r[t]=!0});var o=!0;BetaJS.Objs.iter(e,function(t){o=o&&t in r},this),o&&this.set(s,t[s])}},validation_exception_conversion:function(t){var e=t;if(t.instance_of(BetaJS.Stores.RemoteStoreException))e=t.source();else if(!("status_code"in e&&"data"in e))return t;return e.status_code()==BetaJS.Net.HttpHeader.HTTP_STATUS_PRECONDITION_FAILED&&e.data()&&(BetaJS.Objs.iter(e.data(),function(t,e){this.setError(e,t)},this),t=new BetaJS.Modelling.ModelInvalidException(model)),t}},{_initializeScheme:function(){return{}},asRecords:function(t,e){return t.map(function(t){return t.asRecord(e)})},filterPersistent:function(t){var e={},i=this.scheme();for(var s in t)(!BetaJS.Types.is_defined(i[s].persistent)||i[s].persistent)&&(e[s]=t[s]);return e}},{scheme:function(){return this.__scheme=this.__scheme||this._initializeScheme(),this.__scheme}}),BetaJS.Modelling.SchemedProperties.extend("BetaJS.Modelling.AssociatedProperties",{constructor:function(t,e){this._inherited(BetaJS.Modelling.AssociatedProperties,"constructor",t,e),this.assocs=this._initializeAssociations();for(var i in this.assocs)this.__addAssoc(i,this.assocs[i]);this.on("change:"+this.cls.primary_key(),function(t,e){this._change_id(t,e),this.trigger("change_id",t,e)},this)},_change_id:function(){},__addAssoc:function(t,e){this[t]=function(){return e.yield()}},_initializeAssociations:function(){return{}},destroy:function(){for(var t in this.assocs)this.assocs[t].destroy();this._inherited(BetaJS.Modelling.AssociatedProperties,"destroy")},id:function(){return this.get(this.cls.primary_key())},hasId:function(){return this.has(this.cls.primary_key())}},{primary_key:function(){return"id"},_initializeScheme:function(){var t=this._inherited(BetaJS.Modelling.AssociatedProperties,"_initializeScheme");return t[this.primary_key()]={type:"id"},t}}),BetaJS.Modelling.AssociatedProperties.extend("BetaJS.Modelling.Model",[BetaJS.SyncAsync.SyncAsyncMixin,{constructor:function(t,e){e=e||{},this._inherited(BetaJS.Modelling.Model,"constructor",t,e),this.__saved="saved"in e?e.saved:!1,this.__new="new"in e?e["new"]:!0,this.__removed=!1,this.__saved&&(this._properties_changed={}),this.__table=e.table||this.cls.defaultTable(),this.__table._model_register(this),this.__destroying=!1,this._supportsAsync=this.__table.supportsAsync(),this._supportsSync=this.__table.supportsSync()},destroy:function(){!this.__destroying&&this.__table&&(this.__destroying=!0,this.__table._model_unregister(this),this.trigger("destroy"),this._inherited(BetaJS.Modelling.Model,"destroy"))},isSaved:function(){return this.__saved},isNew:function(){return this.__new},isRemoved:function(){return this.__removed},update:function(t,e,i){this.setAll(t,{silent:!0}),this.save(i)},_afterSet:function(t,e,i,s){this._inherited(BetaJS.Modelling.Model,"_afterSet",t,e,i,s);var n=this.cls.scheme();t in n&&(s&&s.no_change?this._unsetChanged(t):this.__saved=!1,s&&s.silent||this.__table&&this.__table._model_set_value(this,t,e,s))},_after_create:function(){},_before_create:function(){},save:function(t){return this.__new&&this._before_create(),this.then(this.__table,this.__table._model_save,[this],t,function(t,e){this.trigger("save"),this.__saved=!0;var i=this.__new;this.__new=!1,i&&this._after_create(),this.callback(e,"success",t)})},remove:function(t){return this.then(this.__table,this.__table._model_remove,[this],t,function(t,e){this.trigger("remove"),this.__removed=!0,this.callback(e,"success",t)})},table:function(){return this.__table}}],{defaultTable:function(){return this.table||(this.table=new BetaJS.Modelling.Table(new BetaJS.Stores.MemoryStore,this)),this.table}}),BetaJS.Class.extend("BetaJS.Modelling.Table",[BetaJS.Events.EventsMixin,BetaJS.SyncAsync.SyncAsyncMixin,{constructor:function(t,e,i){this._inherited(BetaJS.Modelling.Table,"constructor"),this.__store=t,this.__model_type=e,this.__models_by_id={},this.__models_changed={},this.__options=BetaJS.Objs.extend({model_cache_size:null,type_column:null,auto_create:!1,store_validation_conversion:!0,auto_update:!0,auto_materialize:!1},i||{}),this.__models_by_cid=new BetaJS.Classes.ObjectCache({size:this.__options.model_cache_size}),this._auto_destroy(this.__models_by_cid),this.__models_by_cid.on("release",function(t){t.hasId()&&delete this.__models_by_id[t.id()]},this),this.__options.auto_materialize&&this.__store.on("insert",function(t,e){if(!(this.__models_by_id[t[this.primary_key()]]||e&&e.model_create)){var i=this.__materialize(t);this.trigger("create",i)}},this),this.__store.on("update",function(t,e,i){if(!(!this.__models_by_id[t[this.primary_key()]]||i&&i.model_update)){var s=this.__models_by_id[t[this.primary_key()]];s.setAll(e,{silent:!0}),this.trigger("update",s)}},this),this.__store.on("remove",function(t,e){if(!(!this.__models_by_id[t]||e&&e.model_remove)){var i=this.__models_by_id[t];this.trigger("remove",i),i.destroy()}},this),this._supportsAsync=!0,this._supportsSync=t.supportsSync()},_model_register:function(t){this.hasModel(t)||(this.trigger("register",t),this.__models_by_cid.add(t),t.hasId()&&(this.__models_by_id[t.id()]=t),t.isNew()&&this.__options.auto_create&&this._model_create(t))},_model_unregister:function(t){this.hasModel(t)&&(t.save(),this.__models_by_cid.remove(t),t.hasId()&&delete this.__models_by_id[t.id()],this.trigger("unregister",t))},hasModel:function(t){return null!==this.__models_by_cid.get(t)},_model_remove:function(t,e){return this.hasModel(t)?this.then(this.__store,this.__store.remove,[[t.id(),{model_remove:!0}]],e,function(e,i){this.trigger("remove",t),t.destroy(),this.callback(i,"success",!0)},function(t,e){this.callback(e,"exception",t)}):!1},_model_save:function(t,e){return t.isNew()?this._model_create(t,e):this._model_update(t,e)},__exception_conversion:function(t,e){return this.__options.store_validation_conversion?t.validation_exception_conversion(e):e},_model_create:function(t,e){if(!this.hasModel(t)||!t.isNew())return!1;if(!t.validate()){var i=new BetaJS.Modelling.ModelInvalidException(t);if(!e)throw i;this.callback(e,"exception",i)}var s=BetaJS.Scopes.resolve(this.__model_type).filterPersistent(t.get_all_properties());return this.__options.type_column&&(s[this.__options.type_column]=t.cls.classname),this.then(this.__store,this.__store.insert,[[s,{model_create:!0}]],e,function(e,i){return t.cls.primary_key()in e?(this.__models_by_id[e[t.cls.primary_key()]]=t,t.setAll(e,{no_change:!0,silent:!0}),delete this.__models_changed[t.cid()],this.trigger("create",t),this.trigger("save",t),this.callback(i,"success",t),!0):this.callback(i,"exception",new BetaJS.Modelling.ModelMissingIdException(t))},function(e,i){e=BetaJS.Exceptions.ensure(e),e=this.__exception_conversion(t,e),this.callback(i,"exception",e)})},_model_update:function(t,e){if(!this.hasModel(t)||t.isNew())return!1;if(!t.validate()){var i=new BetaJS.Modelling.ModelInvalidException(t);if(!e)throw i;this.callback(e,"exception",i)}var s=BetaJS.Scopes.resolve(this.__model_type).filterPersistent(t.properties_changed());return BetaJS.Types.is_empty(s)?(e&&this.callback(e,"success",s),s):this.then(this.__store,this.__store.update,[t.id(),[s,{model_update:!0}]],e,function(e,i){return t.setAll(e,{no_change:!0,silent:!0}),delete this.__models_changed[t.cid()],this.trigger("update",t),this.trigger("save",t),this.callback(i,"success",e),e},function(e,i){return e=BetaJS.Exceptions.ensure(e),e=this.__exception_conversion(t,e),this.callback(i,"exception",e),!1})},_model_set_value:function(t,e,i,s){return this.__models_changed[t.cid()]=t,this.trigger("change",t,e,i),this.trigger("change:"+e,t,i),this.__options.auto_update?t.save(s):void 0},save:function(t){if(t){var e=[];return BetaJS.Objs.iter(this.__models_changed,function(t){e.push(t.promise(t.save))},this),this.join(e,t)}var i=!0;return BetaJS.Objs.iter(this.__models_changed,function(t){i=t.save()&&i}),i},primary_key:function(){return BetaJS.Scopes.resolve(this.__model_type).primary_key()},__materialize:function(t){if(!t)return null;var e=this.__model_type;this.__options.type_column&&t[this.__options.type_column]&&(e=t[this.__options.type_column]);var i=BetaJS.Scopes.resolve(e);if(this.__models_by_id[t[this.primary_key()]])return this.__models_by_id[t[this.primary_key()]];var s=new i(t,{table:this,saved:!0,"new":!1});return s},findById:function(t,e){return this.__models_by_id[t]?(e&&this.callback(e,"success",this.__models_by_id[t]),this.__models_by_id[t]):this.then(this.__store,this.__store.get,[t],e,function(e,i){this.callback(i,"success",this.__materialize(this.__store.get(t)))})},findBy:function(t,e){return this.then(this,this.allBy,[t,{limit:1}],e,function(t,e){this.callback(e,"success",t.next())})},all:function(t,e){return this.allBy({},t,e)},allBy:function(t,e,i){var s=this;return this.__store.then(this.__store.query,[t,e],i,function(t,e){var i=new BetaJS.Iterators.MappedIterator(t,function(t){return this.__materialize(t)},s);s.callback(e,"success",i)})},query:function(){return this.allBy.apply(this,arguments)},scheme:function(){return this.__model_type.scheme()},ensure_indices:function(){if(!("ensure_index"in this.__store))return!1;var t=this.scheme();for(var e in t)t[e].index&&this.__store.ensure_index(e);return!0}}]),BetaJS.Class.extend("BetaJS.Modelling.Associations.Association",[BetaJS.SyncAsync.SyncAsyncMixin,{constructor:function(t,e){this._inherited(BetaJS.Modelling.Associations.Association,"constructor"),this._model=t,this._options=e||{},this.__cache=null,e.delete_cascade&&t.on("remove",function(){this.__delete_cascade()},this),e.ignore_change_id||t.on("change_id",function(t,e){this._change_id(t,e)},this)},_change_id:function(){},__delete_cascade:function(){this.yield({success:function(t){t=BetaJS.Iterators.ensure(t).toArray();for(var e=[];t.hasNext();){var i=t.next();e.push(i.promise(i.remove))}this.join(e,{success:function(){}})}})},yield:function(t){return this._options.cached?this.eitherFactory("__cache",t,this._yield,this._yield):this._yield(t)},invalidate:function(){delete this.__cache}}]),BetaJS.Modelling.Associations.Association.extend("BetaJS.Modelling.Associations.TableAssociation",{constructor:function(t,e,i,s){this._inherited(BetaJS.Modelling.Associations.TableAssociation,"constructor",t,s),this._foreign_table=e,this._foreign_key=i,s.primary_key&&(this._primary_key=s.primary_key),this._options.cached&&this._foreign_table.on("create update remove",function(){this.invalidate()},this)},destroy:function(){this._foreign_table.off(null,null,this),this._inherited(BetaJS.Modelling.Associations.TableAssociation,"destroy")}}),BetaJS.Modelling.Associations.TableAssociation.extend("BetaJS.Modelling.Associations.HasManyAssociation",{_id:function(){return this._primary_key?this._model.get(this._primary_key):this._model.id()},_yield:function(t){return this.allBy({},t)},yield:function(t){if(!this._options.cached)return this._yield(t);if(this.__cache){var e=new BetaJS.Iterators.ArrayIterator(this.__cache);return t&&this.callback(t,"success",e),e}return this.then(this._yield,t,function(t,e){this.__cache=t.asArray(),BetaJS.Objs.iter(this.__cache,function(t){t.on("destroy",function(){this.invalidate()},this)},this),this.callback(e,"success",new BetaJS.Iterators.ArrayIterator(this.__cache))})},invalidate:function(){BetaJS.Objs.iter(this.__cache,function(t){t.off(null,null,this)},this),this._inherited(BetaJS.Modelling.Associations.HasManyAssociation,"invalidate")},findBy:function(t,e){return t[this._foreign_key]=this._id(),this._foreign_table.findBy(t,e)},allBy:function(t,e,i){return t[this._foreign_key]=i?i:this._id(),this._foreign_table.allBy(t,{},e)},_change_id:function(t,e){this.allBy({},{content:this,success:function(e){for(;e.hasNext();){var i=e.next();i.set(this._foreign_key,t),i.save()}}},e)}}),BetaJS.Modelling.Associations.HasManyAssociation.extend("BetaJS.Modelling.Associations.HasManyThroughArrayAssociation",{_yield:function(t){if(t){var e=[];return BetaJS.Objs.iter(this._model.get(this._foreign_key),function(t){e.push(this._foreign_table.promise(this._foreign_table.findById,[t]))},this),this.join(e,BetaJS.SyncAsync.mapSuccess(t,function(e){this.callback(t,"success",BetaJS.Objs.filter(e,function(t){return!!t}))}))}var i=[];return BetaJS.Objs.iter(this._model.get(this._foreign_key),function(t){var e=this._foreign_table.findById(t);e&&i.push(e)},this),i},yield:function(t){if(!this._options.cached)return new BetaJS.Iterators.ArrayIterator(this._yield(t));if(this.__cache){var e=new BetaJS.Iterators.ArrayIterator(this.__cache);return t&&this.callback(t,"success",e),e}return this.then(this._yield,t,function(t,e){this.__cache=t,BetaJS.Objs.iter(this.__cache,function(t){t.on("destroy",function(){this.invalidate()},this)},this),this.callback(e,"success",new BetaJS.Iterators.ArrayIterator(this.__cache))})}}),BetaJS.Modelling.Associations.TableAssociation.extend("BetaJS.Modelling.Associations.HasOneAssociation",{_yield:function(t,e){var i={};return i[this._foreign_key]=e?e:this._primary_key?this._model.get(this._primary_key):this._model.id(),this.then(this._foreign_table,this._foreign_table.findBy,[i],t,function(t,e){t&&t.on("destroy",function(){this.invalidate()},this),this.callback(e,"success",t)})},_change_id:function(t,e){this._yield({context:this,success:function(e){e&&(e.set(this._foreign_key,t),e.save())}},e)}}),BetaJS.Modelling.Associations.TableAssociation.extend("BetaJS.Modelling.Associations.BelongsToAssociation",{_yield:function(t){var e=function(t,e){t&&t.on("destroy",function(){this.invalidate()},this),this.callback(e,"success",t)};if(!this._primary_key)return this.then(this._foreign_table,this._foreign_table.findById,[this._model.get(this._foreign_key)],t,e);var i={};return i[this._primary_key]=this._model.get(this._foreign_key),this.then(this._foreign_table,this._foreign_table.findBy,[i],t,e)}}),BetaJS.Modelling.Associations.Association.extend("BetaJS.Modelling.Associations.ConditionalAssociation",{constructor:function(t,e){this._inherited(BetaJS.Modelling.Associations.ConditionalAssociation,"constructor"),this._model=t,this._options=e||{},this.__cache=null,e.delete_cascade&&t.on("remove",function(){this.__delete_cascade()},this),e.ignore_change_id||t.on("change_id",function(t,e){this._change_id(t,e)},this)},_yield:function(t){return this._model.assocs[this._options.conditional(this._model)].yield(t)
}}),BetaJS.Modelling.Associations.Association.extend("BetaJS.Modelling.Associations.PolymorphicHasOneAssociation",{constructor:function(t,e,i,s){this._inherited(BetaJS.Modelling.Associations.PolymorphicHasOneAssociation,"constructor",t,s),this._foreign_table_key=e,this._foreign_key=i,s.primary_key&&(this._primary_key=s.primary_key)},_yield:function(t,e){var i={};i[this._foreign_key]=e?e:this._primary_key?this._model.get(this._primary_key):this._model.id();var s=BetaJS.Scopes.resolve(this._model.get(this._foreign_table_key));return this.then(s,s.findBy,[i],t,function(t,e){t&&t.on("destroy",function(){this.invalidate()},this),this.callback(e,"success",t)})},_change_id:function(t,e){this._yield({success:function(e){e&&(e.set(this._foreign_key,t),e.save())}},e)}}),BetaJS.Class.extend("BetaJS.Modelling.Validators.Validator",{validate:function(){return null}}),BetaJS.Modelling.Validators.Validator.extend("BetaJS.Modelling.Validators.PresentValidator",{constructor:function(t){this._inherited(BetaJS.Modelling.Validators.PresentValidator,"constructor"),this.__error_string=t?t:"Field is required"},validate:function(t){return BetaJS.Types.is_null(t)||""===t?this.__error_string:null}}),BetaJS.Modelling.Validators.Validator.extend("BetaJS.Modelling.Validators.EmailValidator",{constructor:function(t){this._inherited(BetaJS.Modelling.Validators.EmailValidator,"constructor"),this.__error_string=t?t:"Not a valid email address"},validate:function(t){return BetaJS.Strings.is_email_address(t)?null:this.__error_string}}),BetaJS.Modelling.Validators.Validator.extend("BetaJS.Modelling.Validators.LengthValidator",{constructor:function(t){this._inherited(BetaJS.Modelling.Validators.LengthValidator,"constructor"),this.__min_length=BetaJS.Types.is_defined(t.min_length)?t.min_length:null,this.__max_length=BetaJS.Types.is_defined(t.max_length)?t.max_length:null,this.__error_string=BetaJS.Types.is_defined(t.error_string)?t.error_string:null,this.__error_string||(null!==this.__min_length?this.__error_string=null!==this.__max_length?"Between "+this.__min_length+" and "+this.__max_length+" characters":"At least "+this.__min_length+" characters":null!==this.__max_length&&(this.__error_string="At most "+this.__max_length+" characters"))},validate:function(t){return null!==this.__min_length&&(!t||t.length<this.__min_length)?this.__error_string:null!==this.__max_length&&t.length>this.__max_length?this.__error_string:null}}),BetaJS.Modelling.Validators.Validator.extend("BetaJS.Modelling.Validators.UniqueValidator",{constructor:function(t,e){this._inherited(BetaJS.Modelling.Validators.UniqueValidator,"constructor"),this.__key=t,this.__error_string=e?e:"Key already present"},validate:function(t,e){var i={};i[this.__key]=t;var s=e.table().findBy(i);return!s||!e.isNew()&&e.id()==s.id()?null:this.__error_string}}),BetaJS.Modelling.Validators.Validator.extend("BetaJS.Modelling.Validators.ConditionalValidator",{constructor:function(t,e){this._inherited(BetaJS.Modelling.Validators.ConditionalValidator,"constructor"),this.__condition=t,this.__validator=BetaJS.Types.is_array(e)?e:[e]},validate:function(t,e){if(!this.__condition(t,e))return null;for(var i=0;this.__validator.length>i;++i){var s=this.__validator[i].validate(t,e);if(null!==s)return s}return null}}),BetaJS.Net.AbstractAjax.extend("BetaJS.Browser.JQueryAjax",{_syncCall:function(t){var e;return BetaJS.$.ajax({type:t.method,async:!1,url:t.uri,dataType:t.decodeType?t.decodeType:null,data:t.encodeType&&"json"==t.encodeType?JSON.stringify(t.data):t.data,success:function(t){e=t},error:function(t,e,i){var s="";try{s=JSON.parse(t.responseText)}catch(n){s=JSON.parse('"'+t.responseText+'"')}throw new BetaJS.Net.AjaxException(t.status,i,ee)}}),e},_asyncCall:function(t,e){BetaJS.Browser.Info.isInternetExplorer()&&9>=BetaJS.Browser.Info.internetExplorerVersion()&&(BetaJS.$.support.cors=!0),BetaJS.$.ajax({type:t.method,async:!0,url:t.uri,dataType:t.decodeType?t.decodeType:null,data:t.encodeType&&"json"==t.encodeType?JSON.stringify(t.data):t.data,success:function(t){BetaJS.SyncAsync.callback(e,"success",t)},error:function(t,i,s){var n="";try{n=JSON.parse(t.responseText)}catch(r){n=JSON.parse('"'+t.responseText+'"')}var o=new BetaJS.Net.AjaxException(t.status,s,n);BetaJS.SyncAsync.callback(e,"exception",o)}})}}),BetaJS.Browser.Cookies={get:function(t){return BetaJS.Strings.read_cookie_string(document.cookie,t)},set:function(t,e){document.cookie=BetaJS.Strings.write_cookie_string(document.cookie,t,e)}},BetaJS.Browser.Dom={traverseNext:function(t,e){return"get"in t&&(t=t.get(0)),t.firstChild&&!e?BetaJS.$(t.firstChild):t.parentNode?t.nextSibling?BetaJS.$(t.nextSibling):this.traverseNext(t.parentNode,!0):null},selectNode:function(t,e){t=BetaJS.$(t).get(0);var i=null,s=null;window.getSelection?(i=window.getSelection(),i.removeAllRanges(),s=document.createRange()):document.selection&&(i=document.selection,s=i.createRange()),e?(s.setStart(t,e),s.setEnd(t,e),i.addRange(s)):(s.selectNode(t),i.addRange(s))},selectionStartNode:function(){return window.getSelection?BetaJS.$(window.getSelection().getRangeAt(0).startContainer):document.selection?BetaJS.$(document.selection.createRange().startContainer):null},selectedHtml:function(){return window.getSelection?""+window.getSelection():document.selection?document.selection.createRange().htmlText:""},selectionAncestor:function(){return window.getSelection?BetaJS.$(window.getSelection().getRangeAt(0).commonAncestorContainer):document.selection?BetaJS.$(document.selection.createRange().parentElement()):null},selectionStartOffset:function(){return window.getSelection?window.getSelection().getRangeAt(0).startOffset:document.selection?document.selection.createRange().startOffset:null},selectionEndOffset:function(){return window.getSelection?window.getSelection().getRangeAt(0).endOffset:document.selection?document.selection.createRange().endOffset:null},selectionStart:function(){return window.getSelection?BetaJS.$(window.getSelection().getRangeAt(0).startContainer):document.selection?BetaJS.$(document.selection.createRange().startContainer):null},selectionEnd:function(){return window.getSelection?BetaJS.$(window.getSelection().getRangeAt(0).endContainer):document.selection?BetaJS.$(document.selection.createRange().endContainer):null},selectionNonEmpty:function(){var t=this.selectionStart(),e=this.selectionEnd();return t&&e&&t.get(0)&&e.get(0)&&(t.get(0)!=e.get(0)||this.selectionStartOffset()!=this.selectionEndOffset())},selectionContained:function(t){return t.has(this.selectionStart()).length>0&&t.has(this.selectionEnd()).length>0},selectionNodes:function(){var t=[],e=this.selectionStart(),i=this.selectionEnd();t.push(e);for(var s=e;s.get(0)!=i.get(0);)s=this.traverseNext(s),t.push(s);return t},selectionLeaves:function(){return BetaJS.Objs.filter(this.selectionNodes(),function(t){return 0===t.children().length})},contentSiblings:function(t){return t.parent().contents().filter(function(){return this!=t.get(0)})},remove_tag_from_parent_path:function(t,e,i){e=e.toLowerCase(),t=BetaJS.$(t);for(var s=t.parents(i?i+" "+e:e),n=0;s.length>n;++n){var r=s.get(n);for(r=BetaJS.$(r);t.get(0)!=r.get(0);)this.contentSiblings(t).wrap("<"+e+"></"+e+">"),t=t.parent();r.contents().unwrap()}},selectionSplitOffsets:function(){var t=this.selectionStartOffset(),e=this.selectionEndOffset(),i=this.selectionStart(),s=this.selectionEnd(),n=i.get(0)==s.get(0);if(s.get(0).wholeText.length>e){var r=s.get(0);r.splitText(e),s=BetaJS.$(r),n&&(i=s)}t>0&&(i=BetaJS.$(i.get(0).splitText(t)),n&&(s=i)),this.selectRange(i,s)},selectRange:function(t,e,i,s){t=BetaJS.$(t),e=BetaJS.$(e);var n=null,r=null;window.getSelection?(n=window.getSelection(),n.removeAllRanges(),r=document.createRange()):document.selection&&(n=document.selection,r=n.createRange()),r.setStart(t.get(0),i||0),r.setEnd(e.get(0),s||e.get(0).data.length),n.addRange(r)},splitNode:function(t,e,i){if(t=BetaJS.$(t),e=e||0,i=i||t.get(0).data.length,t.get(0).data.length>i){var s=t.get(0);s.splitText(i),t=BetaJS.$(s)}return e>0&&(t=BetaJS.$(t.get(0).splitText(e))),t}},BetaJS.Browser=BetaJS.Browser||{},BetaJS.Browser.Hotkeys={SHIFT_NUMS:{"`":"~",1:"!",2:"@",3:"#",4:"$",5:"%",6:"^",7:"&",8:"*",9:"(",0:")","-":"_","=":"+",";":":","'":'"',",":"<",".":">","/":"?","\\":"|"},SPECIAL_KEYS:{esc:27,escape:27,tab:9,space:32,"return":13,enter:13,backspace:8,scrolllock:145,scroll_lock:145,scroll:145,capslock:20,caps_lock:20,caps:20,numlock:144,num_lock:144,num:144,pause:19,"break":19,insert:45,home:36,"delete":46,end:35,pageup:33,page_up:33,pu:33,pagedown:34,page_down:34,pd:34,left:37,up:38,right:39,down:40,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123},MODIFIERS:["ctrl","alt","shift","meta"],keyCodeToCharacter:function(t){return 188==t?",":190==t?".":String.fromCharCode(t).toLowerCase()},register:function(t,e,i,s){s=BetaJS.Objs.extend({type:"keyup",propagate:!1,disable_in_input:!1,target:document,keycode:!1},s),s.target=BetaJS.$(s.target);var n=t.toLowerCase().split("+"),r=function(t){if(s.disable_in_input){var r=t.target||t.srcElement||null;if(r&&3==r.nodeType&&(r=r.parentNode),r&&("INPUT"==r.tagName||"TEXTAREA"==r.tagName))return}var o=t.keyCode||t.which||0,a=BetaJS.Browser.Hotkeys.keyCodeToCharacter(o),_=0,c={};BetaJS.Objs.iter(BetaJS.Browser.Hotkeys.MODIFIERS,function(e){c[e]={pressed:t[e+"Key"],wanted:!1}},this),BetaJS.Objs.iter(n,function(e){e in c?(c[e].wanted=!0,_++):e.length>1?BetaJS.Browser.Hotkeys.SPECIAL_KEYS[e]==o&&_++:s.keycode?s.keycode==o&&_++:(a==e||t.shiftKey&&BetaJS.Browser.Hotkeys.SHIFT_NUMS[a]==e)&&_++},this),_==n.length&&BetaJS.Objs.all(c,function(t){return t.wanted==t.pressed})&&(e.apply(i||this),s.propagate||t.preventDefault())};return s.target.on(s.type,r),{target:s.target,type:s.type,func:r}},unregister:function(t){t.target.off(t.type,t.func)}},BetaJS.Browser=BetaJS.Browser||{},BetaJS.Browser.Info={getNavigator:function(){return{appCodeName:navigator.appCodeName,appName:navigator.appName,appVersion:navigator.appVersion,cookieEnabled:navigator.cookieEnabled,onLine:navigator.onLine,platform:navigator.platform,userAgent:navigator.userAgent}},__cache:{},__cached:function(t,e){return t in this.__cache||(this.__cache[t]=e.apply(this)),this.__cache[t]},flash:function(){return this.__cached("flash",function(){return new BetaJS.Browser.FlashDetect})},isiOS:function(){return this.__cached("isiOS",function(){var t=navigator.userAgent;return-1!=t.indexOf("iPhone")||-1!=t.indexOf("iPod")||-1!=t.indexOf("iPad")})},isChrome:function(){return this.__cached("isChrome",function(){return("chrome"in window||-1!=navigator.userAgent.indexOf("CriOS"))&&!window.opera&&-1===navigator.userAgent.indexOf(" OPR/")})},isOpera:function(){return this.__cached("isOpera",function(){return!!window.opera||navigator.userAgent.indexOf(" OPR/")>=0})},isAndroid:function(){return this.__cached("isAndroid",function(){return-1!=navigator.userAgent.toLowerCase().indexOf("android")})},isWebOS:function(){return this.__cached("isWebOS",function(){return-1!=navigator.userAgent.toLowerCase().indexOf("webos")})},isWindowsPhone:function(){return this.__cached("isWindowsPhone",function(){return-1!=navigator.userAgent.toLowerCase().indexOf("windows phone")})},isBlackberry:function(){return this.__cached("isBlackberry",function(){return-1!=navigator.userAgent.toLowerCase().indexOf("blackberry")})},iOSversion:function(){return this.__cached("iOSversion",function(){if(!this.isiOS())return!1;var t=navigator.appVersion.match(/OS (\d+)_(\d+)_?(\d+)?/);return{major:parseInt(t[1],10),minor:parseInt(t[2],10),revision:parseInt(t[3]||0,10)}})},isMobile:function(){return this.__cached("isMobile",function(){return this.isiOS()||this.isAndroid()||this.isWebOS()||this.isWindowsPhone()||this.isBlackberry()})},isInternetExplorer:function(){return this.__cached("isInternetExplorer",function(){return null!==this.internetExplorerVersion()})},isFirefox:function(){return this.__cached("isFirefox",function(){return-1!=navigator.userAgent.toLowerCase().indexOf("firefox")})},isSafari:function(){return this.__cached("isSafari",function(){return!this.isChrome()&&-1!=navigator.userAgent.toLowerCase().indexOf("safari")})},isWindows:function(){return this.__cached("isWindows",function(){return-1!=navigator.appVersion.toLowerCase().indexOf("win")})},isMacOS:function(){return this.__cached("isMacOS",function(){return-1!=navigator.appVersion.toLowerCase().indexOf("mac")})},isUnix:function(){return this.__cached("isUnix",function(){return-1!=navigator.appVersion.toLowerCase().indexOf("x11")})},isLinux:function(){return this.__cached("isLinux",function(){return-1!=navigator.appVersion.toLowerCase().indexOf("linux")})},internetExplorerVersion:function(){if("Microsoft Internet Explorer"==navigator.appName){var t=RegExp("MSIE ([0-9]{1,}[.0-9]{0,})");if(t.exec(navigator.userAgent))return parseFloat(RegExp.$1)}else if("Netscape"==navigator.appName){var e=RegExp("Trident/.*rv:([0-9]{1,}[.0-9]{0,})");if(e.exec(navigator.userAgent))return parseFloat(RegExp.$1)}return null}},BetaJS.Class.extend("BetaJS.Browser.FlashDetect",{constructor:function(){if(this._inherited(BetaJS.Browser.FlashDetect,"constructor"),this.__version=null,navigator.plugins&&navigator.plugins.length>0){var t="application/x-shockwave-flash",e=navigator.mimeTypes;e&&e[t]&&e[t].enabledPlugin&&e[t].enabledPlugin.description&&(this.__version=this.parseVersion(e[t].enabledPlugin.description))}else if(-1==navigator.appVersion.indexOf("Mac")&&window.execScript)for(var i=0;this.__activeXDetectRules.length>i;i++)try{var s=new ActiveXObject(this.__activeXDetectRules[i].name),n=this.__activeXDetectRules[i].version(s);if(n){this.__version=this.parseActiveXVersion(n);break}}catch(r){}},parseVersion:function(t){var e=t.split(/ +/),i=e[2].split(/\./),s=e[3];return{raw:t,major:parseInt(i[0],10),minor:parseInt(i[1],10),revisionStr:s,revision:parseInt(s.replace(/[a-zA-Z]/g,""),10)}},parseActiveXVersion:function(t){var e=t.split(",");return{raw:t,major:parseInt(e[0].split(" ")[1],10),minor:parseInt(e[1],10),revision:parseInt(e[2],10),revisionStr:e[2]}},version:function(){return this.__version},installed:function(){return null!==this.__version},supported:function(){return this.installed()||!BetaJS.Browser.Info.isiOS()},majorAtLeast:function(t){return this.installed()&&this.version().major>=t},minorAtLeast:function(t){return this.installed()&&this.version().minor>=t},revisionAtLeast:function(t){return this.installed()&&this.version().revision>=t},versionAtLeast:function(){if(!this.installed())return!1;var t=[this.version().major,this.version().minor,this.version().revision],e=Math.min(t.length,arguments.length);for(i=0;e>i;i++)if(t[i]!=arguments[i])return t[i]>arguments[i];return!0},__activeXDetectRules:[{name:"ShockwaveFlash.ShockwaveFlash.7",version:function(t){try{return t.GetVariable("$version")}catch(e){return null}}},{name:"ShockwaveFlash.ShockwaveFlash.6",version:function(t){try{t.AllowScriptAccess="always";try{return t.GetVariable("$version")}catch(e){return null}}catch(e){return"6,0,21"}}},{name:"ShockwaveFlash.ShockwaveFlash",version:function(t){try{return t.GetVariable("$version")}catch(e){return null}}}]}),BetaJS.Browser=BetaJS.Browser||{},BetaJS.Browser.Loader={loadScript:function(t,e,i){var s=!1,n=document.getElementsByTagName("head")[0],r=document.createElement("script");r.src=t,r.onload=r.onreadystatechange=function(){s||this.readyState&&"loaded"!=this.readyState&&"complete"!=this.readyState||(s=!0,r.onload=r.onreadystatechange=null,e&&e.apply(i||this,[t]))},n.appendChild(r)},loadStyles:function(t,e,i){var s=!1,n=document.getElementsByTagName("head")[0],r=document.createElement("link");r.rel="stylesheet",r.href=t,r.onload=r.onreadystatechange=function(){s||this.readyState&&"loaded"!=this.readyState&&"complete"!=this.readyState||(s=!0,r.onload=r.onreadystatechange=null,e&&e.apply(i||this,[t]))},n.appendChild(r)},inlineStyles:function(t){BetaJS.$("<style>"+t+"</style>").appendTo("head")}},BetaJS.Browser=BetaJS.Browser||{},BetaJS.Browser.Router=BetaJS.Class.extend("BetaJS.Browser.Router",[BetaJS.Events.EventsMixin,{routes:[],constructor:function(t){this._inherited(BetaJS.Browser.Router,"constructor");var e=BetaJS.Types.is_function(this.routes)?this.routes():this.routes;BetaJS.Types.is_array(e)||(e=[e]),"routes"in t&&(BetaJS.Types.is_array(t.routes)?e=e.concat(t.routes):e.push(t.routes)),this.__routes=[],this.__paths={},this.__current=null,BetaJS.Objs.iter(e,function(t){BetaJS.Objs.iter(t,function(t,e){BetaJS.Types.is_string(t)&&(t={action:t}),t.key=e,t.route=RegExp("^"+e+"$"),"applicable"in t?BetaJS.Types.is_array(t.applicable)||(t.applicable=[t.applicable]):t.applicable=[],"valid"in t?BetaJS.Types.is_array(t.valid)||(t.valid=[t.valid]):t.valid=[],"path"in t||(t.path=t.key),this.__routes.push(t),this.__paths[t.path]=t},this)},this),"actions"in t&&BetaJS.Objs.iter(t.actions,function(t,e){this[e]=t},this)},destroy:function(){this.__leave(),this._inherited(BetaJS.Browser.Router,"destroy")},parse:function(t){for(var e=0;this.__routes.length>e;++e){var i=this.__routes[e],s=i.route.exec(t);if(null!==s){s.shift(1);var n=!0;if(BetaJS.Objs.iter(i.applicable,function(t){var e=BetaJS.Types.is_string(t)?this[t]:t;n=n&&e.apply(this,s)},this),!n)continue;var r=!0;return BetaJS.Objs.iter(i.valid,function(t){var e=BetaJS.Types.is_string(t)?this[t]:t;r=r&&e.apply(this,s)},this),r?{object:i,params:s}:null}}return null},object:function(t){return this.__paths[t]},path:function(t){for(var e=this.object(t).key,i=Array.prototype.slice.apply(arguments,[1]),s=/\(.*?\)/;;){var n=i.shift();if(!n)break;e=e.replace(s,n)}return e},navigate:function(t){this.trigger("navigate",t);var e=this.parse(t);return null===e?(this.trigger("navigate-fail",t),!1):(this.trigger("navigate-success",e.object,e.params),this.invoke(e.object,e.params,t))},invoke:function(t,e,i){i=i||this.path(t.key,e),this.trigger("before_invoke",t,e,i),this.__enter(t,e,i),this.trigger("after_invoke",t,e,i);var s=this._invoke(t,e);return s},_invoke:function(t,e){var i=t.action;return BetaJS.Types.is_string(i)&&(i=this[i]),i.apply(this,e)},__leave:function(){null!==this.__current&&(this.trigger("leave",this.__current),this.__current.destroy(),this.__current=null)},__enter:function(t,e,i){this.__leave(),this.__current=new BetaJS.Events.Events,this.__current.route=i,this.__current.object=t,this.__current.params=e,this.trigger("enter",this.__current)},current:function(){return this.__current}}]),BetaJS.Class.extend("BetaJS.Browser.RouterHistory",[BetaJS.Events.EventsMixin,{constructor:function(t){this._inherited(BetaJS.Browser.RouterHistory,"constructor"),this.__router=t,this.__history=[],t.on("after_invoke",this.__after_invoke,this)},destroy:function(){this.__router.off(null,null,this),this._inherited(BetaJS.Browser.RouterHistory,"destroy")},__after_invoke:function(t,e){this.__history.push({object:t,params:e}),this.trigger("change")},last:function(t){return t=t||0,this.get(this.count()-1-t)},count:function(){return this.__history.length},get:function(t){return t=t||0,this.__history[t]},getRoute:function(t){var e=this.get(t);return this.__router.path(e.object.path,e.params)},back:function(t){if(2>this.count())return null;for(t=t||0;t>=0&&this.count()>1;)this.__history.pop(),--t;var e=this.__history.pop();return this.trigger("change"),this.__router.invoke(e.object,e.params)}}]),BetaJS.Class.extend("BetaJS.Browser.RouteBinder",{constructor:function(t){this._inherited(BetaJS.Browser.RouteBinder,"constructor"),this.__router=t,this.__router.on("after_invoke",function(t,e,i){this._getExternalRoute()!=i&&this._setExternalRoute(i)},this)},destroy:function(){this.__router.off(null,null,this),this._inherited(BetaJS.Browser.RouteBinder,"destroy")},current:function(){return this._getExternalRoute()},_setRoute:function(t){var e=this.__router.current();e&&e.route==t||this.__router.navigate(t)},_getExternalRoute:function(){return""},_setExternalRoute:function(){}}),BetaJS.Browser.RouteBinder.extend("BetaJS.Browser.HashRouteBinder",{constructor:function(t){this._inherited(BetaJS.Browser.HashRouteBinder,"constructor",t);var e=this;BetaJS.$(window).on("hashchange.events"+this.cid(),function(){e._setRoute(e._getExternalRoute())})},destroy:function(){BetaJS.$(window).off("hashchange.events"+this.cid()),this._inherited(BetaJS.Browser.HashRouteBinder,"destroy")},_getExternalRoute:function(){var t=window.location.hash;return t.length&&"#"==t[0]?t.slice(1):t},_setExternalRoute:function(t){window.location.hash="#"+t}}),BetaJS.Browser.RouteBinder.extend("BetaJS.Browser.HistoryRouteBinder",{constructor:function(t){this._inherited(BetaJS.Browser.HistoryRouteBinder,"constructor",t);var e=this;this.__used=!1,BetaJS.$(window).on("popstate.events"+this.cid(),function(){e.__used&&e._setRoute(e._getExternalRoute())})},destroy:function(){BetaJS.$(window).off("popstate.events"+this.cid()),this._inherited(BetaJS.Browser.HistoryRouteBinder,"destroy")},_getExternalRoute:function(){return window.location.pathname},_setExternalRoute:function(t){window.history.pushState({},document.title,t),this.__used=!0}},{supported:function(){return window.history&&window.history.pushState}}),BetaJS.Browser.RouteBinder.extend("BetaJS.Browser.LocationRouteBinder",{_getExternalRoute:function(){return window.location.pathname},_setExternalRoute:function(t){window.location.pathname=t}}),BetaJS.Stores.StoreException.extend("BetaJS.Stores.RemoteStoreException",{constructor:function(t){t=BetaJS.Net.AjaxException.ensure(t),this._inherited(BetaJS.Stores.RemoteStoreException,"constructor",""+t),this.__source=t},source:function(){return this.__source}}),BetaJS.Stores.BaseStore.extend("BetaJS.Stores.RemoteStore",{constructor:function(t,e,i){this._inherited(BetaJS.Stores.RemoteStore,"constructor",i),this._uri=t,this.__ajax=e,this.__options=BetaJS.Objs.extend({update_method:"PUT",uri_mappings:{},bulk_method:"POST",supports_bulk:!1},i||{})},getUri:function(){return this._uri},prepare_uri:function(t,e){return this.__options.uri_mappings[t]?this.__options.uri_mappings[t](e):"remove"==t||"get"==t||"update"==t?this.getUri()+"/"+e[this._id_key]:this.getUri()},_encode_query:function(){return{uri:this.prepare_uri("query")}},__invoke:function(t,e,i){if(e)return this.__ajax.asyncCall(t,{success:function(t){if(i&&BetaJS.Types.is_string(t))try{t=JSON.parse(t)}catch(s){}BetaJS.SyncAsync.callback(e,"success",t)},exception:function(t){BetaJS.SyncAsync.callback(e,"exception",new BetaJS.Stores.RemoteStoreException(t))}});try{var s=this.__ajax.syncCall(t);if(i&&BetaJS.Types.is_string(s))try{return JSON.parse(s)}catch(n){}return s}catch(n){throw new BetaJS.Stores.RemoteStoreException(n)}return!1},_insert:function(t,e){return this.__invoke({method:"POST",uri:this.prepare_uri("insert",t),data:t},e,!0)},_get:function(t,e){var i={};return i[this._id_key]=t,this.__invoke({uri:this.prepare_uri("get",i)},e)},_update:function(t,e,i){var s=BetaJS.Objs.clone(e,1);return s[this._id_key]=t,this.__invoke({method:this.__options.update_method,uri:this.prepare_uri("update",s),data:e},i)},_remove:function(t,e){var i={};return i[this._id_key]=t,this.__invoke({method:"DELETE",uri:this.prepare_uri("remove",i)},e)},_query:function(t,e,i){return this.__invoke(this._encode_query(t,e),i,!0)},bulk:function(t,e){return this.__options.supports_bulk?this.__invoke({method:this.__options.bulk_method,uri:this.prepare_uri("bulk"),data:t}):this._inherited(BetaJS.Stores.RemoteStore,"bulk",t,e)}}),BetaJS.Stores.RemoteStore.extend("BetaJS.Stores.QueryGetParamsRemoteStore",{constructor:function(t,e,i,s){this._inherited(BetaJS.Stores.QueryGetParamsRemoteStore,"constructor",t,e,s),this.__capability_params=i},_query_capabilities:function(){var t={};return"skip"in this.__capability_params&&(t.skip=!0),"limit"in this.__capability_params&&(t.limit=!0),"query"in this.__capability_params&&(t.query=!0),"sort"in this.__capability_params&&(t.sort=!0),t},_encode_query:function(t,e){e=e||{};var i=this.getUri()+"?";return e.skip&&"skip"in this.__capability_params&&(i+=this.__capability_params.skip+"="+e.skip+"&"),e.limit&&"limit"in this.__capability_params&&(i+=this.__capability_params.limit+"="+e.limit+"&"),e.sort&&"sort"in this.__capability_params&&(i+=this.__capability_params.sort+"="+JSON.stringify(e.sort)+"&"),"query"in this.__capability_params&&(i+=this.__capability_params.query+"="+JSON.stringify(t)+"&"),{uri:i}}}),BetaJS.$="jQuery"in window?window.jQuery:null,BetaJS.Exceptions.Exception.extend("BetaJS.Views.ViewException"),BetaJS.Views.View=BetaJS.Class.extend("BetaJS.Views.View",[BetaJS.Events.EventsMixin,BetaJS.Events.ListenMixin,BetaJS.Properties.PropertiesMixin,BetaJS.Classes.ModuleMixin,{$el:null,_templates:function(){return{}},_dynamics:function(){return{}},_events:function(){return[]},_global_events:function(){return[]},_css:function(){return{}},css:function(t){if(this.__css[t])return this.__css[t];var e=null;return this.__parent&&(e=this.__parent.css(t),e&&e!=t)?e:(e=this._css(),e[t]?e[t]:t)},_render:function(){this.__html?this.$el.html(this.__html):this.__templates["default"]?this.$el.html(this.evaluateTemplate("default",{})):this.__dynamics["default"]&&this.evaluateDynamics("default",this.$el,{},{name:"default"})},templates:function(t){return t in this.__templates?this.__templates[t]:null},dynamics:function(t){return t in this.__dynamics?this.__dynamics[t]:null},_supp:function(){return{__context:this,css:function(t){return this.__context.css(t)},attrs:function(t){var e="";for(var i in t)e+=(t[i]?i+"='"+t[i]+"'":i)+" ";return e},styles:function(t){var e="";for(var i in t)e+=i+":"+t[i]+";";return e},selector:function(t){return"data-selector='"+t+"' "},view_id:this.cid()}},templateArguments:function(){var t=this.getAll();return t.supp=this._supp(),t},evaluateTemplate:function(t,e){return e=e||{},this.__templates[t].evaluate(BetaJS.Objs.extend(e,this.templateArguments()))},evaluateDynamics:function(t,e,i,s){return this.__dynamics[t].renderInstance(e,BetaJS.Objs.extend(s||{},{args:i||{}}))},_setOption:function(t,e,i,s){s=s?s:"__",this[s+e]=t&&e in t&&BetaJS.Types.is_defined(t[e])?t[e]:i},_setOptionTyped:function(t,e,i,s,n){this._setOption(t,e,this.cls._parseType(i,s),n)},_setOptionProperty:function(t,e,i){this.set(e,t&&e in t&&BetaJS.Types.is_defined(t[e])?t[e]:i)},_setOptionPropertyTyped:function(t,e,i){this._setOptionProperty(t,e,this.cls._parseType(i,type))},constructor:function(t){t=t||{},this._inherited(BetaJS.Views.View,"constructor"),this._setOption(t,"el",null),this._setOption(t,"visible",!0),this._setOption(t,"html",null),this._setOption(t,"events",[]),this._setOption(t,"attributes",{}),this._setOption(t,"invalidate_on_show",!1),this._setOption(t,"append_to_el",!1),this.__old_attributes={},this._setOption(t,"el_classes",[]),BetaJS.Types.is_string(this.__el_classes)&&(this.__el_classes=this.__el_classes.split(" ")),this.__added_el_classes=[],this._setOption(t,"el_styles",{}),this._setOption(t,"children_styles",{}),this._setOption(t,"children_classes",[]),BetaJS.Types.is_string(this.__children_classes)&&(this.__children_classes=this.__children_classes.split(" ")),this._setOption(t,"invalidate_on_change",!1),this.__old_el_styles={},this._setOption(t,"css",{}),this.__parent=null,this.__children={},this.__active=!1,this.$el=null;var e=BetaJS.Types.is_function(this._events)?this._events():this._events;BetaJS.Types.is_array(e)||(e=[e]),this.__events=e.concat(this.__events);var i=BetaJS.Types.is_function(this._global_events)?this._global_events():this._global_events;BetaJS.Types.is_array(i)||(i=[i]),this.__global_events=i;var s=BetaJS.Objs.extend(BetaJS.Types.is_function(this._templates)?this._templates():this._templates,t.templates||{});"template"in t&&(s["default"]=t.template),this.__templates={};var n=null;for(n in s){if(!s[n])throw new BetaJS.Views.ViewException("Could not find template '"+n+"' in View '"+this.cls.classname+"'");this.__templates[n]=new BetaJS.Templates.Template(BetaJS.Types.is_string(s[n])?s[n]:s[n].html())}var r=BetaJS.Objs.extend(BetaJS.Types.is_function(this._dynamics)?this._dynamics():this._dynamics,t.dynamics||{});"dynamic"in t&&(r["default"]=t.dynamic),this.__dynamics={};for(n in r)this.__dynamics[n]=new BetaJS.Views.DynamicTemplate(this,BetaJS.Types.is_string(r[n])?r[n]:r[n].html());this.setAll(t.properties||{}),this.__invalidate_on_change&&this.on("change",function(){this.invalidate()},this),this.__modules={},BetaJS.Objs.iter(t.modules||[],this.add_module,this),this._notify("created",t),this.ns={};var o=this._domain(),a=this._domain_defaults(),_=null;if(!BetaJS.Types.is_empty(o)){var c=[];for(_ in o)c.push({name:_,data:o[_]});c=BetaJS.Sort.dependency_sort(c,function(t){return t.name},function(t){return t.data.before||[]},function(t){var e=t.data.after||[];return t.data.parent&&e.push(t.data.parent),e});for(var u=0;c.length>u;++u){_=c[u].name;var h=c[u].data,l=h.options||{};BetaJS.Types.is_function(l)&&(l=l.apply(this,[this]));var d=a[h.type]||{};BetaJS.Types.is_function(d)&&(d=d.apply(this,[this])),l=BetaJS.Objs.tree_merge(d,l),h.type in BetaJS.Views&&(h.type=BetaJS.Views[h.type]),BetaJS.Types.is_string(h.type)&&(h.type=BetaJS.Scopes.resolve(h.type));var f=new h.type(l);this.ns[_]=f;var p=h.parent_options||{},S=this;h.parent&&(S=BetaJS.Scopes.resolve(h.parent,this.ns)),h.method?h.method(S,f):S.addChild(f,p),f.domain=this;var y=null;for(y in h.events||{})f.on(y,h.events[y],f);for(y in h.listeners||{})this.on(y,h.listeners[y],f)}}},_domain:function(){return{}},_domain_defaults:function(){return{}},isActive:function(){return this.__active},activate:function(){if(this.isActive())return this;if(this.__parent&&!this.__parent.isActive())return null;if(this.$el=this.__parent?this.__el?this.__parent.$(this.__el):this.__parent.$el:BetaJS.$(this.__el),0===this.$el.size()&&(this.$el=null),!this.$el)return null;this.__append_to_el&&(this.$el.append("<div data-view-id='"+this.cid()+"'></div>"),this.$el=this.$el.find("[data-view-id='"+this.cid()+"']")),this.__old_attributes={};var t=null,e=null;for(t in this.__attributes)e=this.$el.attr(t),this.__old_attributes[t]=BetaJS.Types.is_defined(e)?e:null,this.$el.attr(t,this.__attributes[t]);this.__added_el_classes=[];for(var i=this._el_classes().concat(this.__el_classes),s=0;i.length>s;++s)this.$el.hasClass(i[s])||(this.$el.addClass(i[s]),this.__added_el_classes.push(i[s]));this.__old_el_styles={};var n=BetaJS.Objs.extend(this._el_styles(),this.__el_styles);for(t in n)e=this.$el.css(t),this.__old_el_styles[t]=BetaJS.Types.is_defined(e)?e:null,this.$el.css(t,n[t]);return this.__bind(),this.__visible||this.$el.css("display",this.__visible?"":"none"),this.__active=!0,this.__render(),this._notify("preactivate"),BetaJS.Objs.iter(this.__children,function(t){t.view.activate()}),this._notify("activate"),this.trigger("activate"),this.__visible&&this.trigger("show"),this.trigger("visibility",this.__visible),this.trigger("resize"),this},deactivate:function(){if(!this.isActive())return!1;this.__visible&&this.trigger("hide"),this.trigger("visibility",!1),this._notify("deactivate"),this.trigger("deactivate"),BetaJS.Objs.iter(this.__children,function(t){t.view.deactivate()}),this.__active=!1,BetaJS.Objs.iter(this.__dynamics,function(t){t.reset()},this),this.__unbind(),this.$el.html("");var t=null;for(t in this.__old_attributes)this.$el.attr(t,this.__old_attributes[t]);for(var e=0;this.__added_el_classes.length>e;++e)this.$el.removeClass(this.__added_el_classes[e]);for(t in this.__old_el_styles)this.$el.css(t,this.__old_el_styles[t]);return this.__append_to_el&&this.$el.remove(),this.$el=null,!0},_el_styles:function(){return{}},_el_classes:function(){return[]},$:function(t){return this.$el.find(t)},$data:function(t,e){e||(e=this.$el);var i="";for(var s in t)i+="[data-"+s+"='"+t[s]+"']";return e.find(i)},destroy:function(){this.deactivate(),this.setParent(null);var t=this.__children;this.__children={},BetaJS.Objs.iter(t,function(t){t.view.destroy()}),this.__children={},BetaJS.Objs.iter(this.__dynamics,function(t){t.destroy()},this),BetaJS.Objs.iter(this.__templates,function(t){t.destroy()
},this),this.trigger("destroy"),this._inherited(BetaJS.Views.View,"destroy")},show:function(){this.setVisibility(!0)},hide:function(){this.setVisibility(!1)},isVisible:function(){return this.__visible},setVisibility:function(t){t!=this.__visible&&(this.__visible=t,this.isActive()&&(this.$el.css("display",this.__visible?"":"none"),this.__visible&&(this.trigger("resize"),this.__invalidate_on_show&&this.invalidate()),this.trigger(t?"show":"hide"),this.trigger("visibility",t)),this.__parent&&this.__parent.updateChildVisibility(this))},updateChildVisibility:function(){},toggle:function(){this.setVisibility(!this.isVisible())},__bind:function(){var t=this;this.__unbind(),BetaJS.Objs.iter(this.__events,function(e){BetaJS.Objs.iter(e,function(e,i){var s=BetaJS.Types.is_function(e)?e:t[e],n=i.match(BetaJS.Views.BIND_EVENT_SPLITTER),r=n[1],o=n[2];r=r+".events"+t.cid();var a=BetaJS.Functions.as_method(s,t);""===o?t.$el.on(r,a):t.$el.on(r,o,a)})}),BetaJS.Objs.iter(this.__global_events,function(e){BetaJS.Objs.iter(e,function(e,i){var s=BetaJS.Types.is_function(e)?e:t[e],n=i.match(BetaJS.Views.BIND_EVENT_SPLITTER),r=n[1],o=n[2];r=r+".events"+t.cid();var a=BetaJS.Functions.as_method(s,t);""===o?BetaJS.$(document).on(r,a):BetaJS.$(document).on(r,o,a)})})},__unbind:function(){this.$el.off(".events"+this.cid()),BetaJS.$(document).off(".events"+this.cid())},__render:function(){if(this.isActive()){this._render();var t=this.$el.children();if(!BetaJS.Types.is_empty(this.__children_styles))for(var e in this.__children_styles)t.css(e,this.__children_styles[e]);BetaJS.Objs.iter(this.__children_classes,function(e){t.addClass(e)}),this.trigger("render")}},invalidate:function(){this.isActive()&&(BetaJS.Objs.iter(this.__children,function(t){t.view.deactivate()}),BetaJS.Objs.iter(this.__dynamics,function(t){t.reset()},this),this.__render(),BetaJS.Objs.iter(this.__children,function(t){t.view.activate()}))},setEl:function(t){this.isActive()?(this.deactivate(),this.__el=t,this.activate()):this.__el=t},getParent:function(){return this.__parent},hasChild:function(t){return t&&t.cid()in this.__children},setParent:function(t){if(t!=this.__parent){if(this.deactivate(),this.__parent){this._unbindParent(this.__parent);var e=this.__parent;this.__parent.off(null,null,this),this.__parent=null,e.removeChild(this)}t&&(this.__parent=t,t.addChild(this),this._bindParent(t),t.isActive()&&this.activate())}},_bindParent:function(){},_unbindParent:function(){},children:function(){var t={};return BetaJS.Objs.iter(this.__children,function(e,i){t[i]=e.view},this),t},childOptions:function(t){return this.__children[t.cid()].options},addChildren:function(t){BetaJS.Objs.iter(t,function(t){this.addChild(t)},this)},addChild:function(t,e){return this.hasChild(t)?null:(e=e||{},this.__children[t.cid()]={view:t,options:e},this._notify("addChild",t,e),t.setParent(this),this.isActive()&&this.isVisible()&&this.trigger("resize"),t)},removeChildren:function(t){BetaJS.Objs.iter(t,function(t){this.removeChild(t)},this)},removeChild:function(t){this.hasChild(t)&&(delete this.__children[t.cid()],t.setParent(null),t.off(null,null,this),this._notify("removeChild",t),this.isActive()&&this.isVisible()&&this.trigger("resize"))},width:function(){return this.$el.width()},innerWidth:function(){return this.$el.innerWidth()},outerWidth:function(){return this.$el.outerWidth()},height:function(){return this.$el.height()},innerHeight:function(){return this.$el.innerHeight()},outerHeight:function(){return this.$el.outerHeight()}}],{parseType:function(t,e){if(BetaJS.Types.is_defined(t)&&BetaJS.Types.is_string(t)){if(t=t.replace(/\s+/g,""),"int"==e)return parseInt(t,10);if("array"==e)return t.split(",");if("bool"==e)return""===t||BetaJS.Types.parseBool(t);if("object"==e||"function"==e)return BetaJS.Scopes.resolve(t)}return t}}),BetaJS.Views.BIND_EVENT_SPLITTER=/^(\S+)\s*(.*)$/,BetaJS.Class.extend("BetaJS.Views.DynamicTemplate",{constructor:function(t,e){this._inherited(BetaJS.Views.DynamicTemplate,"constructor"),this.__parent=t,this.__template=new BetaJS.Templates.Template(e),this.__instances={},this.__instances_by_name={}},reset:function(){BetaJS.Objs.iter(this.__instances,function(t){this.removeInstance(t)},this)},destroy:function(){this.reset(),this._inherited(BetaJS.Views.DynamicTemplate,"destroy")},renderInstance:function(t,e){e=e||{},e.name&&this.removeInstanceByName(e.name);var i=new BetaJS.Views.DynamicTemplateInstance(this,t,e);this.__instances[i.cid()]=i,e.name&&(this.__instances_by_name[name]=i)},removeInstanceByName:function(t){t in this.__instances_by_name&&this.removeInstance(this.__instances_by_name[t])},removeInstance:function(t){delete this.__instances[t.cid()],delete this.__instances_by_name[t.name()],t.destroy()},view:function(){return this.__parent},template:function(){return this.__template}}),BetaJS.Class.extend("BetaJS.Views.DynamicTemplateInstance",[BetaJS.Events.ListenMixin,{__bind:{attr:function(t,e){return this.__context.__bind_attribute(t,e)},attrs:function(t){var e="";for(attribute in t)e+=this.attr(attribute,t[attribute])+" ";return e},value:function(t){return this.__context.__bind_value(t)},inner:function(t){return this.__context.__bind_inner(t)},css_if:function(t,e){return this.__context.__bind_css_if(t,e,!0)},css_if_not:function(t,e){return this.__context.__bind_css_if(t,e,!1)}},__new_element:function(t){var e=BetaJS.Ids.uniqueId();return this.__elements[e]=BetaJS.Objs.extend({id:e,$el:null},t),this.__elements[e]},__decompose_variable:function(t){var e=t.split(".");return{object:1==e.length?this.__parent.view():this.__args[e[0]],key:1==e.length?t:e[1]}},__get_variable:function(t){var e=this.__decompose_variable(t);return e.object.get(e.key)},__set_variable:function(t,e){var i=this.__decompose_variable(t);return i.object.set(i.key,e)},__update_element:function(t){var e=this.__get_variable(t.variable);"inner"==t.type?t.$el.html(e):"value"==t.type?t.$el.val()!=e&&t.$el.val(e):"attribute"==t.type?t.$el.attr(t.attribute,e):"css"==t.type&&(t.positive||(e=!e),e?t.$el.addClass(this.__parent.view().css(t.css)):t.$el.removeClass(this.__parent.view().css(t.css)))},__prepare_element:function(t){var e=this;t.$el=this.$el.find(t.selector),"inner"==t.type||"css"==t.type?this.__update_element(t):"value"==t.type&&t.$el.on("change input keyup paste",function(){e.__set_variable(t.variable,t.$el.val())})},__bind_attribute:function(t,e){var i=this.__new_element({type:"attribute",attribute:t,variable:e}),s="data-bind-"+t+"='"+i.id+"'";i.selector="["+s+"]";var n=this.__decompose_variable(e);return this.listenOn(n.object,"change:"+n.key,function(){this.__update_element(i)},this),s+" "+t+"='"+n.object.get(n.key)+"'"},__bind_css_if:function(t,e,i){var s=this.__new_element({type:"css",css:t,variable:e,positive:i}),n="data-bind-css-"+t+"='"+s.id+"'";s.selector="["+n+"]";var r=this.__decompose_variable(e);return this.listenOn(r.object,"change:"+r.key,function(){this.__update_element(s)},this),n},__bind_value:function(t){var e=this.__new_element({type:"value",variable:t}),i="data-bind-value='"+e.id+"'";e.selector="["+i+"]";var s=this.__decompose_variable(t);return this.listenOn(s.object,"change:"+s.key,function(){this.__update_element(e)},this),i+" value='"+s.object.get(s.key)+"'"},__bind_inner:function(t){var e=this.__new_element({type:"inner",variable:t}),i="data-bind-inner='"+e.id+"'";e.selector="["+i+"]";var s=this.__decompose_variable(t);return this.listenOn(s.object,"change:"+s.key,function(){this.__update_element(e)},this),i},constructor:function(t,e,i){this._inherited(BetaJS.Views.DynamicTemplateInstance,"constructor"),this.__elements={},this.__inners={},i=i||{},i.name&&(this.__name=name),this.__parent=t,this.$el=e,this.__args=BetaJS.Objs.extend(i.args||{},this.__parent.view().templateArguments()),this.__args.bind=BetaJS.Objs.extend({__context:this},this.__bind),this.$el.html(t.template().evaluate(this.__args)),BetaJS.Objs.iter(this.__elements,function(t){this.__prepare_element(t)},this)},destroy:function(){BetaJS.Objs.iter(this.__elements,function(t){t.$el.off()},this),this._inherited(BetaJS.Views.DynamicTemplateInstance,"destroy")},name:function(){return this.__name}}]),BetaJS.Views.ActiveDom={__prefix_alias:["bjs","betajs"],__view_alias:{},__views:{},__active:!1,__on_add_element:function(t){var e=BetaJS.$(t.target);if(e){var i=!1;e.prop("tagName")&&(BetaJS.Objs.iter(BetaJS.Views.ActiveDom.__prefix_alias,function(t){e.prop("tagName").toLowerCase()==t+"view"&&(BetaJS.Views.ActiveDom.__attach(e),i=!0)}),BetaJS.Objs.iter(BetaJS.Views.ActiveDom.__view_alias,function(t,s){e.prop("tagName").toLowerCase()==s&&(BetaJS.Views.ActiveDom.__attach(e,t),i=!0)})),i||(BetaJS.Objs.iter(BetaJS.Views.ActiveDom.__prefix_alias,function(t){e.find(t+"view").each(function(){BetaJS.Views.ActiveDom.__attach(BetaJS.$(this))})}),BetaJS.Objs.iter(BetaJS.Views.ActiveDom.__view_alias,function(t,i){e.find(i).each(function(){BetaJS.Views.ActiveDom.__attach(BetaJS.$(this),t)})}))}},__on_remove_element:function(t){var e=BetaJS.$(t.target);e.attr("data-active-dom-id")in BetaJS.Views.ActiveDom.__views?BetaJS.Views.ActiveDom.__views[e.attr("data-active-dom-id")].destroy():e.find("[data-active-dom-id]").each(function(){var t=BetaJS.$(this);t.attr("data-active-dom-id")in BetaJS.Views.ActiveDom.__views&&BetaJS.Views.ActiveDom.__views[t.attr("data-active-dom-id")].destroy()})},__attach:function(t,e){if(!t.attr("data-active-dom-element")){var i=function(t,i){for(var s=0;BetaJS.Views.ActiveDom.__prefix_alias.length>s;){var _=BetaJS.Views.ActiveDom.__prefix_alias[s];if(BetaJS.Strings.starts_with(t,_+"-"))return t=BetaJS.Strings.strip_start(t,_+"-"),BetaJS.Strings.starts_with(t,"child-")?(t=BetaJS.Strings.strip_start(t,"child-"),r[t]=i):t in a?e[t]=i:o[t]=i,void 0;++s}n[t]=i},s=function(t){var e=t.find("script[type='text/param']");return BetaJS.Strings.nltrim(e.length>0?e.html():t.html())},n={},r={},o={},a={type:"View","default":null,name:null,"keep-tag":!0};e=BetaJS.Objs.extend(BetaJS.Objs.clone(a,1),e||{});for(var _=t.get(0).attributes,c=0;_.length>c;++c)i(_.item(c).nodeName,_.item(c).nodeValue);BetaJS.Objs.iter(BetaJS.Views.ActiveDom.__prefix_alias,function(e){t.children(e+"param").each(function(){var t=BetaJS.$(this);i(e+"-"+t.attr(e+"-key"),s(t))})}),e["default"]&&(o[e["default"]]=s(t)),e.type in BetaJS.Views&&(e.type=BetaJS.Views[e.type]),BetaJS.Types.is_string(e.type)&&(e.type=BetaJS.Scopes.resolve(e.type));var u=new e.type(o);u.setEl("[data-active-dom-id='"+u.cid()+"']");var h="<div data-active-dom-id='"+u.cid()+"'></div>";e["keep-tag"]&&(h="<"+t.prop("tagName")+" data-active-dom-element='"+u.cid()+"'>"+h+"</"+t.prop("tagName")+">"),t.replaceWith(h),t=BetaJS.$("[data-active-dom-id='"+u.cid()+"']");var l=null;for(l in n)t.attr(l,n[l]);u.on("destroy",function(){delete BetaJS.Views.ActiveDom.__views[u.cid()]}),BetaJS.Views.ActiveDom.__views[u.cid()]=u,u.activate();for(l in r)t.children().attr(l,r[l]);e.name&&BetaJS.Scopes.set(u,e.name)}},activate:function(){BetaJS.$(document).ready(function(){BetaJS.Views.ActiveDom.__active||(document.addEventListener?(document.addEventListener("DOMNodeInserted",BetaJS.Views.ActiveDom.__on_add_element),document.addEventListener("DOMNodeRemoved",BetaJS.Views.ActiveDom.__on_remove_element)):(document.attachEvent("DOMNodeInserted",BetaJS.Views.ActiveDom.__on_add_element),document.attachEvent("DOMNodeRemoved",BetaJS.Views.ActiveDom.__on_remove_element)),BetaJS.Objs.iter(BetaJS.Views.ActiveDom.__prefix_alias,function(t){BetaJS.$(t+"view").each(function(){BetaJS.Views.ActiveDom.__attach(BetaJS.$(this))})}),BetaJS.Objs.iter(BetaJS.Views.ActiveDom.__view_alias,function(t,e){BetaJS.$(e).each(function(){BetaJS.Views.ActiveDom.__attach(BetaJS.$(this),t)})}),BetaJS.Views.ActiveDom.__active=!0)})},deactivate:function(){BetaJS.$(document).ready(function(){BetaJS.Views.ActiveDom.__active&&(document.removeEventListener("DOMNodeInserted",BetaJS.Views.ActiveDom.__on_add_element),document.removeEventListener("DOMNodeRemoved",BetaJS.Views.ActiveDom.__on_remove_element),BetaJS.Objs.iter(BetaJS.Views.ActiveDom.__views,function(t){t.destroy()}),BetaJS.Views.ActiveDom.__active=!1)})},registerPrefixAlias:function(t){this.__prefix_alias.push(t)},registerViewAlias:function(t,e,i){this.__view_alias[t]={type:e},this.__view_alias[t]["default"]=i}},BetaJS.Classes.Module.extend("BetaJS.Views.Modules.Centering",{constructor:function(t){this._inherited(BetaJS.Views.Modules.Centering,"constructor",t),this.__vertical="vertical"in t?t.vertical:!1,this.__horizontal="horizontal"in t?t.horizontal:!1},_register:function(t){t.on("resize",function(){t.isVisible()&&this.__update(t)},this),t.isActive()&&t.isVisible()&&this.__update(t)},__update:function(t){this.__vertical&&(t.$el.css("top","50%"),t.$el.css("margin-top",Math.round(-t.$el.height()/2)+"px")),this.__horizontal&&(t.$el.css("left","50%"),t.$el.css("margin-left",Math.round(-t.$el.width()/2)+"px"))}},{__vertical:null,vertical:function(){return this.__vertical||(this.__vertical=new this({auto_destroy:!1,vertical:!0,horizontal:!1})),this.__vertical},__horizontal:null,horizontal:function(){return this.__horizontal||(this.__horizontal=new this({auto_destroy:!1,horizontal:!0,vertical:!1})),this.__horizontal},__both:null,both:function(){return this.__both||(this.__both=new this({auto_destroy:!1,vertical:!0,horizontal:!0})),this.__both}}),BetaJS.Classes.Module.extend("BetaJS.Views.Modules.BindOnActivate",{_register:function(t,e){e.bound=!1,t.on("activate",function(){this.__bind(t)},this),t.on("deactivate",function(){this.__unbind(t)},this),t.isActive()&&this.__bind(t)},_unregister:function(t){this.__unbind(t)},__bind:function(t){var e=this._data(t);e.bound||(this._bind(t,e),e.bound=!0)},__unbind:function(t){var e=this._data(t);e.bound&&(this._unbind(t,e),e.bound=!1)},_bind:function(){},_unbind:function(){}}),BetaJS.Classes.Module.extend("BetaJS.Views.Modules.BindOnVisible",{_register:function(t,e){e.bound=!1,t.on("visibility",function(e){e?this.__bind(t):this.__unbind(t)},this),t.isActive()&&t.isVisible()&&this.__bind(t)},_unregister:function(t){this.__unbind(t)},__bind:function(t){var e=this._data(t);e.bound||(this._bind(t,e),e.bound=!0)},__unbind:function(t){var e=this._data(t);e.bound&&(this._unbind(t,e),e.bound=!1)},_bind:function(){},_unbind:function(){}}),BetaJS.Views.Modules.BindOnVisible.extend("BetaJS.Views.Modules.HideOnLeave",{_bind:function(t,e){var i=t.$el.get(0);e.hide_on_leave_func=function(s){return e.hide_on_leave_skip?(e.hide_on_leave_skip=!1,void 0):(document.contains(s.target)&&s.target!==i&&!BetaJS.$.contains(i,s.target)&&t.hide(),void 0)},e.hide_on_leave_skip=!0,BetaJS.$(document.body).on("click",e.hide_on_leave_func)},_unbind:function(t,e){BetaJS.$(document.body).unbind("click",e.hide_on_leave_func)}}),BetaJS.Views.Modules.BindOnActivate.extend("BetaJS.Views.Modules.Hotkeys",{constructor:function(t){this._inherited(BetaJS.Views.Modules.Hotkeys,"constructor",t),this.__hotkeys=t.hotkeys},_bind:function(t,e){e.hotkeys={},BetaJS.Objs.iter(this.__hotkeys,function(i,s){e.hotkeys[s]=BetaJS.Browser.Hotkeys.register(s,BetaJS.Types.is_function(i)?i:t[i],t)},this)},_unbind:function(t,e){BetaJS.Objs.iter(e.hotkeys,function(t){BetaJS.Browser.Hotkeys.unregister(t)},this),e.hotkeys={}}}),BetaJS.Templates.Cached=BetaJS.Templates.Cached||{},BetaJS.Templates.Cached["holygrail-view-template"]="  <div data-selector=\"right\" class='holygrail-view-right-container'></div>  <div data-selector=\"left\" class='holygrail-view-left-container'></div>  <div data-selector=\"center\" class='holygrail-view-center-container'></div> ",BetaJS.Templates.Cached["list-container-view-item-template"]='  <{%= container_element %} data-view-id="{%= cid %}"></{%= container_element %}> ',BetaJS.Templates.Cached["switch-container-view-item-template"]='  <div data-view-id="{%= cid %}" data-selector="switch-container-item"></div> ',BetaJS.Templates.Cached["button-view-template"]='   <{%= button_container_element %} type="button" data-selector="button-inner" class="{%= supp.css("default") %}"    {%= bind.css_if("disabled", "disabled") %}    {%= bind.css_if("selected", "selected") %}    {%= bind.inner("label") %}>   </{%= button_container_element %}>  ',BetaJS.Templates.Cached["check-box-view-template"]='  <input type="checkbox" {%= checked ? "checked" : "" %} id="check-{%= supp.view_id %}" />  <label for="check-{%= supp.view_id %}">{%= label %}</label> ',BetaJS.Templates.Cached["input-view-template"]='  <input class="input-view" type="{%= input_type %}" {%= bind.value("value") %} {%= bind.attr("placeholder", "placeholder") %} {%= bind.css_if("input-horizontal-fill", "horizontal_fill") %} /> ',BetaJS.Templates.Cached["label-view-template"]='  <{%= element %} class="{%= supp.css(\'label\') %}" {%= bind.inner("label") %}></{%= element %}> ',BetaJS.Templates.Cached["link-view-template"]='  <a href="javascript:{}" {%= bind.inner("label") %}></a> ',BetaJS.Templates.Cached["text-area-template"]='   <textarea {%= bind.value("value") %} {%= bind.attr("placeholder", "placeholder") %}             {%= bind.css_if_not("text-area-no-resize", "resizable") %}             {%= readonly ? \'readonly\' : \'\' %}             style="resize: {%= horizontal_resize ? (vertical_resize ? \'both\' : \'horizontal\') : (vertical_resize ? \'vertical\' : \'none\') %}"             {%= bind.css_if("text-area-horizontal-fill", "horizontal_fill") %}></textarea>  ',BetaJS.Templates.Cached["progress-template"]='  <div class="{%= supp.css(\'outer\') %}">   <div data-selector="inner" class="{%= supp.css(\'inner\') %}" style="{%= horizontal ? \'width\': \'height\' %}:{%= value*100 %}%">   </div>   <div class="progress-view-overlay" data-selector="label">    {%= label %}   </div>  </div> ',BetaJS.Templates.Cached["list-view-template"]='   <{%= list_container_element %}    {%= supp.attrs(list_container_attrs) %}    class="{%= list_container_classes %}"    data-selector="list">   </{%= list_container_element %}>  ',BetaJS.Templates.Cached["list-view-item-container-template"]='   <{%= item_container_element %}    {%= supp.attrs(item_container_attrs) %}    class="{%= item_container_classes %}"    {%= supp.list_item_attr(item) %}>   </{%= item_container_element %}>  ',BetaJS.Templates.Cached["overlay-view-template"]='  <div data-selector="container"></div> ',BetaJS.Templates.Cached["fullscreen-overlay-view-template"]='  <div class="fullscreen-overlay-background" data-selector="outer"></div>  <div class="fullscreen-overlay" data-selector="container">   <div class="fullscreen-overlay-inner" data-selector="inner"></div>  </div> ',BetaJS.Views.View.extend("BetaJS.Views.HolygrailView",{_templates:{"default":BetaJS.Templates.Cached["holygrail-view-template"]},constructor:function(t){this._inherited(BetaJS.Views.HolygrailView,"constructor",t),this.__left=null,this.__center=null,this.__right=null},getLeft:function(){return this.__left},setLeft:function(t){return this.__setView("left",t)},getCenter:function(){return this.__center},setCenter:function(t){return this.__setView("center",t)},getRight:function(){return this.__right},setRight:function(t){return this.__setView("right",t)},__setView:function(t,e){return this.removeChild(this["__"+t]),this["__"+t]=null,e&&(e.setEl('[data-selector="'+t+'"]'),this["__"+t]=this.addChild(e)),e}}),BetaJS.Views.View.extend("BetaJS.Views.ListContainerView",{_templates:{item:BetaJS.Templates.Cached["list-container-view-item-template"]},_notifications:{addChild:"__addChildContainer",removeChild:"__removeChildContainer"},constructor:function(t){t=t||{},this._inherited(BetaJS.Views.ListContainerView,"constructor",t),this._setOption(t,"alignment","horizontal"),this._setOption(t,"positioning","float"),this._setOption(t,"clear_float",!1),this._setOption(t,"container_element","div"),this.on("show",function(){"computed"==this.__positioning&&this.__updatePositioning()},this)},isHorizontal:function(){return"horizontal"==this.__alignment},_render:function(){this.__clear_float?this.$el.html("<div data-selector='clearboth' style='clear:both'></div>"):this.$el.html(""),BetaJS.Objs.iter(this.children(),function(t){this.__addChildContainer(t)},this)},__addChildContainer:function(t){var e=this.childOptions(t);if(this.isActive()){var i=this.evaluateTemplate("item",{cid:t.cid(),container_element:this.__container_element});this.__clear_float?this.$("[data-selector='clearboth']").before(i):this.$el.append(i)}if(t.setEl("[data-view-id='"+t.cid()+"']"),!this.isHorizontal()||"float"in e||"float"!=this.__positioning||(e["float"]="left"),this.isActive()&&"float"in e&&"float"==this.__positioning){var s=this.$("[data-view-id='"+t.cid()+"']");s.css("float",e["float"])}},__removeChildContainer:function(t){this.$data({"view-id":t.cid()}).remove()},__updatePositioningHelper:function(t,e,i){var s=0;BetaJS.Objs.iter(t,function(t){var n=this.childOptions(t);return n.type&&"ignore"==n.type||(t.$el.css(e,s+"px"),t.isVisible()&&(s+=parseInt(t.$el.css(i),10)),!n.type||"dynamic"!=n.type)?void 0:!1},this)},__updatePositioning:function(){var t=BetaJS.Objs.values(this.children()),e=BetaJS.Objs.clone(t,1).reverse(),i=this.isHorizontal()?"left":"top",s=this.isHorizontal()?"right":"bottom",n=this.isHorizontal()?"width":"height";this.__updatePositioningHelper(e,s,n),this.__updatePositioningHelper(t,i,n)},updateChildVisibility:function(t){this._inherited(BetaJS.Views.ListContainerView,"updateChildVisibility",t),"computed"==this.__positioning&&this.__updatePositioning()}}),BetaJS.Views.View.extend("BetaJS.Views.SingleContainerView",{constructor:function(t){this._inherited(BetaJS.Views.SingleContainerView,"constructor",t),this.__view=null},getView:function(){return this.__view},setView:function(t){return this.removeChild(this.__view),t&&(t.setEl(""),this.__view=this.addChild(t)),t}}),BetaJS.Views.View.extend("BetaJS.Views.SwitchContainerView",{_templates:{item:BetaJS.Templates.Cached["switch-container-view-item-template"]},_notifications:{addChild:"__addChildContainer",removeChild:"__removeChildContainer"},constructor:function(t){this._inherited(BetaJS.Views.SwitchContainerView,"constructor",t),this.__selected=null},_render:function(){this.$el.html(""),BetaJS.Objs.iter(this.children(),function(t){this.__addChildContainer(t)},this)},__addChildContainer:function(t){this.isActive()&&this.$el.append(this.evaluateTemplate("item",{cid:t.cid()})),t.setEl("[data-view-id='"+t.cid()+"']"),this.__selected=this.__selected||t,t.setVisibility(this.__selected==t)},__removeChildContainer:function(t){this.$data({"view-id":t.cid()}).remove(),this.__selected==t&&(this.__selected=null)},select:function(t){this.__selected=t,BetaJS.Objs.iter(this.children(),function(t){t.setVisibility(this.__selected==t)},this)},selected:function(){return this.__selected}}),BetaJS.Views.ListContainerView.extend("BetaJS.Views.TabbedView",{constructor:function(t){t=BetaJS.Objs.extend(t||{},{alignment:"vertical",positioning:"none"}),this._inherited(BetaJS.Views.TabbedView,"constructor",t),this.toolbar=this.addChild(new BetaJS.Views.ToolBarView),this.container=this.addChild(new BetaJS.Views.SwitchContainerView),this.toolbar.on("item:click",function(t){this.select(t)},this),t.tabs&&BetaJS.Objs.iter(t.tabs,function(t){this.addTab(t)},this)},addTab:function(t){t=BetaJS.Objs.extend(t,{selectable:!0,deselect_all:!0});var e=this.toolbar.addItem(t);return e.__tabView=this.container.addChild(t.view),t.view.__tabButton=e,t.selected&&this.select(e),e.__tabView},select:function(t){var e=null;return e=BetaJS.Types.is_string(t)?this.toolbar.itemByIdent(t).__tabView:t.__tabButton?t:t.__tabView,this.container.select(e),e.__tabButton.select(),this.trigger("select",e),e}}),BetaJS.Views.View.extend("BetaJS.Views.ButtonView",{_dynamics:{"default":BetaJS.Templates.Cached["button-view-template"]},_css:function(){return{disabled:"","default":"",selected:""}},constructor:function(t){if(t=t||{},this._inherited(BetaJS.Views.ButtonView,"constructor",t),this._setOptionProperty(t,"label",""),this._setOptionProperty(t,"button_container_element","button"),this._setOptionProperty(t,"disabled",!1),this._setOptionProperty(t,"selected",!1),this._setOption(t,"selectable",!1),this._setOption(t,"deselect_all",!1),t.hotkey){var e={};e[t.hotkey]=function(){this.click()},this.add_module(new BetaJS.Views.Modules.Hotkeys({hotkeys:e}))}},_events:function(){return this._inherited(BetaJS.Views.ButtonView,"_events").concat([{"click [data-selector='button-inner']":"click"}])},click:function(){this.get("disabled")||(this.__selectable&&this.select(),this.trigger("click"))},_bindParent:function(t){t.on("deselect",function(){this.unselect()},this)},_unbindParent:function(t){t.off("deselect",this)},select:function(){this.__selectable&&(this.__deselect_all&&this.getParent().trigger("deselect"),this.getParent().trigger("select",this),this.set("selected",!0))},unselect:function(){this.__selectable&&this.set("selected",!1)},isSelected:function(){return this.get("selected")}}),BetaJS.Views.View.extend("BetaJS.Views.CheckBoxView",{_templates:{"default":BetaJS.Templates.Cached["check-box-view-template"]},_events:function(){return this._inherited(BetaJS.Views.ButtonView,"_events").concat([{"click input":"__click"}])},constructor:function(t){t=t||{},t.invalidate_on_change=!0,this._inherited(BetaJS.Views.CheckBoxView,"constructor",t),this._setOptionProperty(t,"checked",!1),this._setOptionProperty(t,"label","")},__click:function(){this.set("checked",this.$("input").is(":checked")),this.trigger("check",this.get("checked"))}}),BetaJS.Views.SwitchContainerView.extend("BetaJS.Views.InputLabelView",{constructor:function(t){this._inherited(BetaJS.Views.InputLabelView,"constructor",t),this._setOptionProperty(t,"value",""),this._setOptionProperty(t,"placeholder",""),this._setOption(t,"edit_on_click",!0),this._setOption(t,"label_mode",!0),this._setOption(t,"read_only",!1),this.label=this.addChild(new BetaJS.Views.LabelView({label:this.binding("value"),el_classes:t.label_el_classes,children_classes:t.label_children_classes})),this.input=this.addChild(new BetaJS.Views.InputView({value:this.binding("value"),placeholder:this.binding("placeholder")})),this.__label_mode||this.select(this.input),this.input.on("leave enter_key",function(){this.label_mode()},this),this.__edit_on_click&&this.label.on("click",function(){this.edit_mode()},this)},is_label_mode:function(){return this.__label_mode},is_edit_mode:function(){return!this.__label_mode},label_mode:function(){this.is_label_mode()||(this.__label_mode=!0,this.select(this.label))},edit_mode:function(){this.is_edit_mode()||this.__read_only||(this.__label_mode=!1,this.select(this.input),this.input.focus(!0))}}),BetaJS.Views.View.extend("BetaJS.Views.InputView",{_dynamics:{"default":BetaJS.Templates.Cached["input-view-template"]},_events:function(){return[{"blur input":"__leaveEvent","keyup input":"__changeEvent","change input":"__changeEvent","input input":"__changeEvent","paste input":"__changeEvent"},{"keyup input":"__keyupEvent"}]},constructor:function(t){this._inherited(BetaJS.Views.InputView,"constructor",t),this._setOptionProperty(t,"value",""),this._setOptionProperty(t,"placeholder",""),this._setOptionProperty(t,"clear_after_enter",!1),this._setOptionProperty(t,"horizontal_fill",!1),this._setOptionProperty(t,"input_type","text")},__keyupEvent:function(t){var e=t.keyCode||t.which;13==e&&(this.trigger("enter_key",this.get("value")),this.get("clear_after_enter")&&this.set("value",""))},__leaveEvent:function(){this.trigger("leave")},__changeEvent:function(){this.trigger("change",this.get("value"))},focus:function(t){this.$("input").focus(),this.$("input").focus(),t&&this.$("input").select()}}),BetaJS.Views.View.extend("BetaJS.Views.LabelView",{_dynamics:{"default":BetaJS.Templates.Cached["label-view-template"]},_css:function(){return{label:"label-view-class"}},_events:function(){return[{click:"__clickEvent"}]},constructor:function(t){this._inherited(BetaJS.Views.LabelView,"constructor",t),this._setOptionProperty(t,"label",""),this._setOptionProperty(t,"element","span")},__clickEvent:function(){this.trigger("click")}}),BetaJS.Views.View.extend("BetaJS.Views.LinkView",{_dynamics:{"default":BetaJS.Templates.Cached["link-view-template"]},constructor:function(t){this._inherited(BetaJS.Views.LinkView,"constructor",t),this._setOptionProperty(t,"label","")},_events:function(){return this._inherited(BetaJS.Views.LinkView,"_events").concat([{"click a":"__click"}])},__click:function(){this.trigger("click")}}),BetaJS.Views.View.extend("BetaJS.Views.ProgressView",{_templates:{"default":BetaJS.Templates.Cached["progress-template"]},_css:function(){return{outer:"",inner:""}},constructor:function(t){this._inherited(BetaJS.Views.ProgressView,"constructor",t),this._setOptionProperty(t,"label",""),this._setOptionProperty(t,"horizontal",!0),this._setOptionProperty(t,"value",1),this.on("change:value",function(t){this.isActive()&&this.$("[data-selector='inner']").css(this.get("horizontal")?"width":"height",100*t+"%")},this),this.on("change:label",function(t){this.isActive()&&this.$("[data-selector='label']").html(t)},this)}}),BetaJS.Views.View.extend("BetaJS.Views.TextAreaView",{_dynamics:{"default":BetaJS.Templates.Cached["text-area-template"]},constructor:function(t){this._inherited(BetaJS.Views.TextAreaView,"constructor",t),this._setOptionProperty(t,"value",""),this._setOptionProperty(t,"placeholder",""),this._setOptionProperty(t,"horizontal_resize",!1),this._setOptionProperty(t,"vertical_resize",!0),this._setOptionProperty(t,"horizontal_fill",!1),this._setOptionProperty(t,"readonly",!1),this.on("change:readonly",function(){this.get("readonly")?this.$("textarea").attr("readonly","readonly"):this.$("textarea").removeAttr("readonly")},this)},addLine:function(t){this.get("value")?this.set("value",this.get("value")+"\n"+t):this.set("value",t),this.scrollToEnd()},scrollToEnd:function(){var t=this.$("textarea").get(0);t.scrollTop=t.scrollHeight}}),BetaJS.Views.View.extend("BetaJS.Views.CustomListView",{_templates:function(){return{"default":BetaJS.Templates.Cached["list-view-template"],"item-container":BetaJS.Templates.Cached["list-view-item-container-template"]}},_supp:function(){return BetaJS.Objs.extend(this._inherited(BetaJS.Views.CustomListView,"_supp"),{list_item_attr:function(t){return this.attrs({"data-view-id":this.__context.cid(),"data-cid":BetaJS.Ids.objectId(t),"data-index":this.__context.__collection.getIndex(t)})}})},_notifications:{activate:"__activateItems",deactivate:"__deactivateItems"},_events:function(){return[{click:"__click"}]},constructor:function(t){if(this._inherited(BetaJS.Views.CustomListView,"constructor",t),this._setOption(t,"list_container_element","ul"),this._setOption(t,"list_container_attrs",{}),this._setOption(t,"list_container_classes",""),this._setOption(t,"item_container_element","li"),this._setOption(t,"item_container_classes",""),this._setOption(t,"selectable",!0),this._setOption(t,"multi_select",!1),this._setOption(t,"click_select",!1),this.__itemData={},"table"in t){var e=this.cls.parseType(t.table,"object");this.active_query=new BetaJS.Queries.ActiveQuery(e.active_query_engine(),{}),t.collection=this.active_query.collection(),t.destroy_collection=!0}if("compare"in t&&(t.compare=this.cls.parseType(t.compare,"function")),"collection"in t)this.__collection=t.collection,this.__destroy_collection="destroy_collection"in t?t.destroy_collection:!1,"compare"in t&&this.__collection.set_compare(t.compare);else{var i={};"objects"in t&&(i.objects=t.objects),"compare"in t&&(i.compare=t.compare),this.__collection=new BetaJS.Collections.Collection(i),this.__destroy_collection=!0}this.__collection.on("add",function(t){this._addItem(t)},this),this.__collection.on("remove",function(t){this._removeItem(t)},this),this.__collection.on("change",function(t){this._changeItem(t)},this),this.__collection.on("index",function(t,e){this.__updateItemIndex(t,e)},this),this.__collection.on("reindexed",function(t){this.__reIndexItem(t)},this),this.__collection.on("sorted",function(){this.__sort()},this),this.__collection.iterate(function(t){this._registerItem(t)
},this)},destroy:function(){this.__collection.iterate(function(t){this._unregisterItem(t)},this),this.__collection.off(null,null,this),this.__destroy_collection&&this.__collection.destroy(),this._inherited(BetaJS.Views.CustomListView,"destroy")},_itemBySubElement:function(t){var e=t.closest("[data-view-id='"+this.cid()+"']");return 0===e.length?null:this.__collection.getById(e.attr("data-cid"))},__click:function(t){if(this.__click_select&&this.__selectable){var e=this._itemBySubElement(BetaJS.$(t.target));e&&this.select(e)}},collection:function(){return this.__collection},add:function(t){this.__collection.add(t)},remove:function(t){this.__collection.remove(t)},_render:function(){this.$selector_list=this._renderListContainer()},_renderListContainer:function(){return this.$el.html(this.evaluateTemplate("default",{list_container_element:this.__list_container_element,list_container_attrs:this.__list_container_attrs,list_container_classes:this.__list_container_classes})),this.$data({selector:"list"})},invalidate:function(){this.isActive()&&this.__deactivateItems(),this._inherited(BetaJS.Views.CustomListView,"invalidate"),this.isActive()&&this.__activateItems()},__activateItems:function(){this.__collection.iterate(function(t){this._activateItem(t)},this)},__deactivateItems:function(){this.__collection.iterate(function(t){this._deactivateItem(t)},this)},itemElement:function(t){return this.$data({"view-id":this.cid(),cid:BetaJS.Ids.objectId(t)},this.$selector_list)},_findIndexElement:function(t){return this.$data({"view-id":this.cid(),index:t},this.$selector_list)},_changeItem:function(){},__updateItemIndex:function(t,e){var i=this.itemElement(t);i.attr("data-index",e),this._updateItemIndex(t,i)},__reIndexItem:function(t){var e=this.itemElement(t),i=this.collection().getIndex(t);if(0===i)this.$selector_list.prepend(e);else{var s=this._findIndexElement(i-1);s.after(e)}},_updateItemIndex:function(){},__sort:function(){for(var t=this.collection().count()-1;t>=0;t--)this.$selector_list.prepend(this._findIndexElement(t))},itemData:function(t){return this.__itemData[t.cid()]},_registerItem:function(t){this.__itemData[t.cid()]={properties:new BetaJS.Properties.Properties({selected:!1,new_element:!1})}},_unregisterItem:function(t){this.__itemData[t.cid()]&&(this.__itemData[t.cid()].properties.destroy(),delete this.__itemData[t.cid()])},_activateItem:function(t){var e=this.evaluateTemplate("item-container",{item:t,item_container_element:this.__item_container_element,item_container_attrs:this.__item_container_attrs,item_container_classes:this.__item_container_classes}),i=this.__collection.getIndex(t);if(0===i)this.$selector_list.prepend(e);else{var s=this._findIndexElement(i-1);if(s.length>0)s.after(e);else{var n=this._findIndexElement(i+1);n.length>0?n.before(e):this.$selector_list.append(e)}}this.trigger("activate_item",t)},_deactivateItem:function(t){this.itemData(t).new_element=!1;var e=this.itemElement(t);e.remove()},_addItem:function(t){this._registerItem(t),this.isActive()&&(this.itemData(t).new_element=!0,this._activateItem(t))},_removeItem:function(t){this.isActive()&&this._deactivateItem(t),this._unregisterItem(t)},isSelected:function(t){return this.itemData(t).properties.get("selected")},select:function(t){var e=this.itemData(t);return this.__selectable&&!this.isSelected(t)&&(this.__multi_select||this.collection().iterate(function(t){this.unselect(t)},this),e.properties.set("selected",!0),this.trigger("select",t)),e},unselect:function(t){var e=this.itemData(t);return this.__selectable&&this.isSelected(t)&&(e.properties.set("selected",!1),this.trigger("unselect",t)),e}}),BetaJS.Views.CustomListView.extend("BetaJS.Views.ListView",{constructor:function(t){t=t||{},"item_template"in t&&(t.templates={item:t.item_template}),"item_dynamic"in t&&(t.dynamics={item:t.item_dynamic}),this._inherited(BetaJS.Views.ListView,"constructor",t),this._setOption(t,"item_label","label"),this._setOption(t,"render_item_on_change",BetaJS.Types.is_defined(this.dynamics("item")))},_changeItem:function(t){this._inherited(BetaJS.Views.ListView,"_changeItem",t),this.__render_item_on_change&&this.isActive()&&this._renderItem(t)},_activateItem:function(t){this._inherited(BetaJS.Views.ListView,"_activateItem",t),this._renderItem(t)},_renderItem:function(t){var e=this.itemElement(t),i=this.itemData(t).properties;this.templates("item")?e.html(this.evaluateTemplate("item",{item:t,properties:i})):this.dynamics("item")?this.evaluateDynamics("item",e,{item:t,properties:i},{name:"item-"+BetaJS.Ids.objectId(t)}):e.html(t.get(this.__item_label))},_deactivateItem:function(t){this.dynamics("item")&&this.dynamics("item").removeInstanceByName("item-"+BetaJS.Ids.objectId(t)),this._inherited(BetaJS.Views.ListView,"_deactivateItem",t)}}),BetaJS.Views.CustomListView.extend("BetaJS.Views.SubViewListView",{_sub_view:BetaJS.Views.View,_sub_view_options:function(t){return{item:t,item_properties:this.itemData(t).properties}},_property_map:function(){},constructor:function(t){this._inherited(BetaJS.Views.SubViewListView,"constructor",t),"create_view"in t&&(this._create_view=t.create_view),"sub_view"in t&&(this._sub_view=this.cls.parseType(t.sub_view,"object")),"sub_view_options"in t&&(this._sub_view_options_param=t.sub_view_options),"property_map"in t&&(this._property_map_param=t.property_map)},_create_view:function(t){var e=BetaJS.Objs.extend(BetaJS.Types.is_function(this._property_map)?this._property_map.apply(this,[t]):this._property_map,BetaJS.Types.is_function(this._property_map_param)?this._property_map_param.apply(this,[t]):this._property_map_param),i=BetaJS.Objs.extend(BetaJS.Types.is_function(this._sub_view_options)?this._sub_view_options.apply(this,[t]):this._sub_view_options,BetaJS.Objs.extend(BetaJS.Types.is_function(this._sub_view_options_param)?this._sub_view_options_param.apply(this,[t]):this._sub_view_options_param||{},BetaJS.Objs.map(e,t.get,t)));return i.el=this.itemElement(t),new this._sub_view(i)},_activateItem:function(t){this._inherited(BetaJS.Views.SubViewListView,"_activateItem",t);var e=this._create_view(t);this.delegateEvents(null,e,"item",[e,t]),this.itemData(t).view=e,this.addChild(e)},_deactivateItem:function(t){var e=this.itemData(t).view;this.removeChild(e),e.destroy(),this._inherited(BetaJS.Views.SubViewListView,"_deactivateItem",t)}}),BetaJS.Classes.Module.extend("BetaJS.Views.Modules.ListViewAnimation",{_register:function(t){t.on("activate_item",function(e){if(t.itemData(e).new_element){var i=t.itemElement(e);i.css("display","none"),i.fadeIn()}},this)}},{__singleton:null,singleton:function(){return this.__singleton||(this.__singleton=new this({auto_destroy:!1})),this.__singleton}}),BetaJS.Views.View.extend("BetaJS.Views.OverlayView",{_templates:{"default":BetaJS.Templates.Cached["overlay-view-template"]},constructor:function(t){t=t||{},t.anchor=t.anchor||"absolute",t.visible="visible"in t?t.visible:!1,t.children_classes=t.children_classes||[],BetaJS.Types.is_string(t.children_classes)&&(t.children_classes=t.children_classes.split(" ")),t.children_classes.push("overlay-container-class"),this._inherited(BetaJS.Views.OverlayView,"constructor",t),this._setOption(t,"anchor","none"),this._setOption(t,"element",""),this._setOption(t,"overlay_left",0),this._setOption(t,"overlay_top",0),this._setOption(t,"overlay_align_vertical","top"),this._setOption(t,"overlay_align_horizontal","left"),this._setOption(t,"element_align_vertical","bottom"),this._setOption(t,"element_align_horizontal","left"),t.overlay_inner&&(t.overlay_inner.setEl('[data-selector="container"]'),this.overlay_inner=this.addChild(t.overlay_inner)),"hide_on_leave"in t&&!t.hide_on_leave||this.add_module(BetaJS.Views.Modules.HideOnLeave.singleton()),this.on("show",this._after_show,this)},_after_show:function(){if("none"!=this.__anchor){var t=this.$(".overlay-container-class"),e=t.outerWidth(),i=t.outerHeight(),s=this.__overlay_left,n=this.__overlay_top;"bottom"==this.__overlay_align_vertical?n-=i:"center"==this.__overlay_align_vertical&&(n-=Math.round(i/2)),"right"==this.__overlay_align_horizontal?s-=e:"center"==this.__overlay_align_horizontal&&(s-=Math.round(e/2));var r=this.$el;"element"==this.__anchor&&this.__element&&(r=this.__element,BetaJS.Types.is_string(r)?r=BetaJS.$(r):BetaJS.Class.is_class_instance(r)&&(r=r.$el)),("relative"==this.__anchor||"element"==this.__anchor)&&(element_width=r.outerWidth(),element_height=r.outerHeight(),s+=r.offset().left-BetaJS.$(window).scrollLeft(),n+=r.offset().top-BetaJS.$(window).scrollTop(),"bottom"==this.__element_align_vertical?n+=element_height:"center"==this.__element_align_vertical&&(n+=Math.round(element_height/2)),"right"==this.__element_align_horizontal?s+=element_width:"center"==this.__element_align_horizontal&&(s+=Math.round(element_width/2))),t.css("left",s+"px"),t.css("top",n+"px")}}}),BetaJS.Views.View.extend("BetaJS.Views.FullscreenOverlayView",{_templates:{"default":BetaJS.Templates.Cached["fullscreen-overlay-view-template"]},_events:function(){return[{'click [data-selector="outer"]':"unfocus",'touchstart [data-selector="outer"]':"unfocus"}]},constructor:function(t){t=t||{},t.el=t.el||"body",t.append_to_el="append_to_el"in t?t.append_to_el:!0,t.visible="visible"in t?t.visible:!1,this._inherited(BetaJS.Views.FullscreenOverlayView,"constructor",t),t.overlay_inner.setEl('[data-selector="inner"]'),this.overlay_inner=this.addChild(t.overlay_inner),this._setOption(t,"hide_on_unfocus",!0),this._setOption(t,"destroy_on_unfocus",!1),this.on("show",this._after_show,this),this.on("hide",this._after_hide,this)},_after_show:function(){var t=this.$('[data-selector="outer"]'),e=this.$('[data-selector="inner"]'),i=this.$('[data-selector="container"]');i.removeClass("fullscreen-overlay-float"),i.removeClass("fullscreen-overlay-fit");var s=t.outerWidth(),n=t.outerHeight(),r=e.outerWidth(),o=e.outerHeight(),a=Math.floor((s-r)/2),_=Math.floor((n-o)/2);a>=0&&_>=0?(i.css("left",a+"px"),i.css("top",_+"px"),i.addClass("fullscreen-overlay-float")):(i.css("left","0px"),i.css("top","0px"),i.addClass("fullscreen-overlay-fit")),BetaJS.$("body").addClass("fullscreen-overlay-body")},_after_hide:function(){BetaJS.$("body").removeClass("fullscreen-overlay-body")},unfocus:function(){this.__destroy_on_unfocus?this.destroy():this.__hide_on_unfocus&&this.hide()}}),BetaJS.Views.ListContainerView.extend("BetaJS.Views.FormControlView",{constructor:function(t){this._inherited(BetaJS.Views.FormControlView,"constructor",t),this._model=t.model,this._property=t.property,this._setOption(t,"validate_on_change",!1),this._setOption(t,"validate_on_show",!1),this._setOption(t,"error_classes",""),this.control_view=this.addChild(this._createControl(this._model,this._property,t.control_options||{})),this.label_view=this.addChild(new BetaJS.Views.LabelView(BetaJS.Objs.extend(t.label_options||{},{visible:!1}))),this.__validate_on_change&&this._model.on("change:"+this._property,this.validate,this),this.__validate_on_show&&this.on("show",this.validate,this),this._model.on("validate:"+this._property,this.validate,this)},validate:function(){if(this.isActive()){var t=this._model.validateAttr(this._property);this.label_view.setVisibility(!t),t?this.$el.removeClass(this.__error_classes):(this.$el.addClass(this.__error_classes),this.label_view.set("label",this._model.getError(this._property)))}},_createControl:function(){}}),BetaJS.Views.FormControlView.extend("BetaJS.Views.FormInputView",{_createControl:function(t,e,i){return new BetaJS.Views.InputView(BetaJS.Objs.extend(i,{value:t.binding(e)}))}}),BetaJS.Views.FormControlView.extend("BetaJS.Views.FormCheckBoxView",{_createControl:function(t,e,i){return new BetaJS.Views.CheckBoxView(BetaJS.Objs.extend(i,{checked:t.binding(e)}))}}),BetaJS.Views.ListContainerView.extend("BetaJS.Views.ToolBarView",{_css:function(){return{divider:"divider",group:"group"}},constructor:function(t){t=BetaJS.Objs.extend({clear_float:!0},t||{}),this._inherited(BetaJS.Views.ToolBarView,"constructor",t),this.__group_by_ident={},this.__item_by_ident={},t.groups&&BetaJS.Objs.iter(t.groups,function(t){this.addGroup(t)},this),t.items&&BetaJS.Objs.iter(t.items,function(t){this.addItem(t)},this)},__group_parent_options:BetaJS.Objs.objectify(["group_ident","group_type","group_options"]),addGroup:function(t){var e={group_type:"container"},i={};BetaJS.Objs.iter(t||{},function(t,s){s in this.__group_parent_options?e[s]=t:i[s]=t},this);var s=null;if("container"==e.group_type){if(i.el_classes=this.css("group"),s=this.addChild(new BetaJS.Views.ListContainerView(i),e),e.group_ident){if(e.group_ident in this.__group_by_ident)throw"Group identifier already registered: "+e.group_ident;this.__group_by_ident[e.group_ident]=s}return s}if("divider"!=e.group_type)throw"Unknown group type: "+e.group_type;return i.el_classes=this.css("divider"),s=this.addChild(new BetaJS.Views.View(i),e)},__item_parent_options:BetaJS.Objs.objectify(["item_ident","item_type","item_group"]),addItem:function(t){var e={item_type:"ButtonView"},i={};BetaJS.Objs.iter(t||{},function(t,s){s in this.__item_parent_options?e[s]=t:i[s]=t},this),e.item_type in BetaJS.Views&&(e.item_type=BetaJS.Views[e.item_type]),BetaJS.Types.is_string(e.item_type)&&(e.item_type=BetaJS.Scopes.resolve(e.item_type));var s=this;if(e.item_group){if(!(e.item_group in this.__group_by_ident))throw"Unknown group identifier: "+e.item_group;s=this.__group_by_ident[e.item_group];var n=this.childOptions(s);i=BetaJS.Objs.extend(n.group_options||{},i)}var r=s.addChild(new e.item_type(i),e);if(this.delegateEvents(null,r,"item",[r,e]),e.item_ident&&this.delegateEvents(null,r,"item-"+e.item_ident,[r,e]),e.item_ident){if(e.item_ident in this.__item_by_ident)throw"Item identifier already registered: "+e.item_ident;this.__item_by_ident[e.item_ident]=r}return r},itemByIdent:function(t){return this.__item_by_ident[t]}});