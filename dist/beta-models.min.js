/*! betajs - v0.0.2 - 2014-05-20, Copyright (c) Oliver Friedmann & Victor Lingenthal, MIT Software License. */BetaJS.Net=BetaJS.Net||{},BetaJS.Net.HttpHeader={HTTP_STATUS_OK:200,HTTP_STATUS_CREATED:201,HTTP_STATUS_PAYMENT_REQUIRED:402,HTTP_STATUS_FORBIDDEN:403,HTTP_STATUS_NOT_FOUND:404,HTTP_STATUS_PRECONDITION_FAILED:412,HTTP_STATUS_INTERNAL_SERVER_ERROR:500,format:function(a,b){var c="";return c=a==this.HTTP_STATUS_OK?"OK":a==this.HTTP_STATUS_CREATED?"Created":a==this.HTTP_STATUS_PAYMENT_REQUIRED?"Payment Required":a==this.HTTP_STATUS_FORBIDDEN?"Forbidden":a==this.HTTP_STATUS_NOT_FOUND?"Not found":a==this.HTTP_STATUS_PRECONDITION_FAILED?"Precondition Failed":a==this.HTTP_STATUS_INTERNAL_SERVER_ERROR?"Internal Server Error":"Other Error",b?a+" "+c:c}},BetaJS.Exceptions.Exception.extend("BetaJS.Modelling.ModelException",{constructor:function(a,b){this._inherited(BetaJS.Modelling.ModelException,"constructor",b),this.__model=a},model:function(){return this.__model}}),BetaJS.Modelling.ModelException.extend("BetaJS.Modelling.ModelMissingIdException",{constructor:function(a){this._inherited(BetaJS.Modelling.ModelMissingIdException,"constructor",a,"No id given.")}}),BetaJS.Modelling.ModelException.extend("BetaJS.Modelling.ModelInvalidException",{constructor:function(a){var b=BetaJS.Objs.values(a.errors()).join("\n");this._inherited(BetaJS.Modelling.ModelInvalidException,"constructor",a,b)}}),BetaJS.Properties.Properties.extend("BetaJS.Modelling.SchemedProperties",{constructor:function(a,b){this._inherited(BetaJS.Modelling.SchemedProperties,"constructor");var c=this.cls.scheme();this._properties_changed={},this.__errors={},this.__unvalidated={};for(var d in c)"def"in c[d]?this.set(d,c[d].def):c[d].auto_create?this.set(d,c[d].auto_create(this)):this.set(d,null);b=b||{},this._properties_changed={},this.__errors={};for(d in a)this.set(d,a[d])},_unsetChanged:function(a){delete this._properties_changed[a]},_beforeSet:function(a,b){var c=this.cls.scheme();if(!(a in c))return b;var d=c[a];return"boolean"==d.type?BetaJS.Types.parseBool(b):(d.transform&&(b=d.transform.apply(this,[b])),b)},_afterSet:function(a,b){var c=this.cls.scheme();if(a in c&&(this._properties_changed[a]=b,this.__unvalidated[a]=!0,delete this.__errors[a],c[a].after_set)){var d=BetaJS.Types.is_string(c[a].after_set)?this[c[a].after_set]:c[a].after_set;d.apply(this,[b])}},properties_changed:function(a){return BetaJS.Types.is_boolean(a)?BetaJS.Objs.filter(this._properties_changed,function(b,c){return this.validateAttr(c)==a},this):this._properties_changed},get_all_properties:function(){var a={},b=this.cls.scheme();for(var c in b)a[c]=this.get(c);return a},properties_by:function(a){return BetaJS.Types.is_boolean(a)?BetaJS.Objs.filter(this.get_all_properties(),function(b,c){return this.validateAttr(c)==a},this):this.get_all_properties()},validate:function(){this.trigger("validate");for(var a in this.__unvalidated)this.validateAttr(a);return this._customValidate(),BetaJS.Types.is_empty(this.__errors)},_customValidate:function(){},validateAttr:function(a){if(a in this.__unvalidated){delete this.__unvalidated[a],delete this.__errors[a];var b=this.cls.scheme(),c=b[a];if("validate"in c){var d=c.validate;BetaJS.Types.is_array(d)||(d=[d]);var e=this.get(a);BetaJS.Objs.iter(d,function(b){var c=b.validate(e,this);return c&&(this.__errors[a]=c),null===c},this)}this.trigger("validate:"+a,!(a in this.__errors),this.__errors[a])}return!(a in this.__errors)},setError:function(a,b){delete this.__unvalidated[a],this.__errors[a]=b,this.trigger("validate:"+a,!(a in this.__errors),this.__errors[a])},revalidate:function(){return this.__errors={},this.__unvalidated=this.keys(!0),this.validate()},errors:function(){return this.__errors},getError:function(a){return this.__errors[a]},asRecord:function(a){var b={},c=this.cls.scheme(),d=this.get_all_properties();a=a||{};for(var e in d)if(e in c){var f=c[e].tags||[],g={};BetaJS.Objs.iter(f,function(a){g[a]=!0});var h=!0;BetaJS.Objs.iter(a,function(a){h=h&&a in g},this),h&&(b[e]=d[e])}return b},setByTags:function(a,b){var c=this.cls.scheme();b=b||{};for(var d in a)if(d in c){var e=c[d].tags||[],f={};BetaJS.Objs.iter(e,function(a){f[a]=!0});var g=!0;BetaJS.Objs.iter(b,function(a){g=g&&a in f},this),g&&this.set(d,a[d])}},validation_exception_conversion:function(a){var b=a;if(a.instance_of(BetaJS.Stores.RemoteStoreException))b=a.source();else if(!("status_code"in b&&"data"in b))return a;return b.status_code()==BetaJS.Net.HttpHeader.HTTP_STATUS_PRECONDITION_FAILED&&b.data()&&(BetaJS.Objs.iter(b.data(),function(a,b){this.setError(b,a)},this),a=new BetaJS.Modelling.ModelInvalidException(model)),a}},{_initializeScheme:function(){return{}},asRecords:function(a,b){return a.map(function(a){return a.asRecord(b)})},filterPersistent:function(a){var b={},c=this.scheme();for(var d in a)(!BetaJS.Types.is_defined(c[d].persistent)||c[d].persistent)&&(b[d]=a[d]);return b}},{scheme:function(){return this.__scheme=this.__scheme||this._initializeScheme(),this.__scheme}}),BetaJS.Modelling.SchemedProperties.extend("BetaJS.Modelling.AssociatedProperties",{constructor:function(a,b){this._inherited(BetaJS.Modelling.AssociatedProperties,"constructor",a,b),this.assocs=this._initializeAssociations();for(var c in this.assocs)this.__addAssoc(c,this.assocs[c]);this.on("change:"+this.cls.primary_key(),function(a,b){this._change_id(a,b),this.trigger("change_id",a,b)},this)},_change_id:function(){},__addAssoc:function(a,b){this[a]=function(){return b.yield()}},_initializeAssociations:function(){return{}},destroy:function(){for(var a in this.assocs)this.assocs[a].destroy();this._inherited(BetaJS.Modelling.AssociatedProperties,"destroy")},id:function(){return this.get(this.cls.primary_key())},hasId:function(){return this.has(this.cls.primary_key())}},{primary_key:function(){return"id"},_initializeScheme:function(){var a=this._inherited(BetaJS.Modelling.AssociatedProperties,"_initializeScheme");return a[this.primary_key()]={type:"id"},a}}),BetaJS.Modelling.AssociatedProperties.extend("BetaJS.Modelling.Model",[BetaJS.SyncAsync.SyncAsyncMixin,{constructor:function(a,b){b=b||{},this._inherited(BetaJS.Modelling.Model,"constructor",a,b),this.__saved="saved"in b?b.saved:!1,this.__new="new"in b?b["new"]:!0,this.__removed=!1,this.__saved&&(this._properties_changed={}),this.__table=b.table||this.cls.defaultTable(),this.__table._model_register(this),this.__destroying=!1},destroy:function(){!this.__destroying&&this.__table&&(this.__destroying=!0,this.__table._model_unregister(this),this.trigger("destroy"),this._inherited(BetaJS.Modelling.Model,"destroy"))},isSaved:function(){return this.__saved},isNew:function(){return this.__new},isRemoved:function(){return this.__removed},update:function(a,b,c){this.setAll(a,{silent:!0}),this.save(c)},_afterSet:function(a,b,c,d){this._inherited(BetaJS.Modelling.Model,"_afterSet",a,b,c,d);var e=this.cls.scheme();a in e&&(d&&d.no_change?this._unsetChanged(a):this.__saved=!1,d&&d.silent||this.__table&&this.__table._model_set_value(this,a,b,d))},_after_create:function(){},_before_create:function(){},save:function(a){return this.__new&&this._before_create(),this.then(this.__table,this.__table._model_save,[this],a,function(a,b){this.trigger("save"),this.__saved=!0;var c=this.__new;this.__new=!1,c&&this._after_create(),this.callback(b,"success",a)})},remove:function(a){return this.then(this.__table,this.__table._model_remove,[this],a,function(a,b){this.trigger("remove"),this.__removed=!0,this.callback(b,"success",a)})},table:function(){return this.__table}}],{defaultTable:function(){return this.table||(this.table=new BetaJS.Modelling.Table(new BetaJS.Stores.MemoryStore,this)),this.table}}),BetaJS.Class.extend("BetaJS.Modelling.Table",[BetaJS.Events.EventsMixin,BetaJS.SyncAsync.SyncAsyncMixin,{constructor:function(a,b,c){this._inherited(BetaJS.Modelling.Table,"constructor"),this.__store=a,this.__model_type=b,this.__models_by_id={},this.__models_changed={},this.__options=BetaJS.Objs.extend({model_cache_size:null,type_column:null,auto_create:!1,store_validation_conversion:!0,auto_update:!0,auto_materialize:!1},c||{}),this.__models_by_cid=new BetaJS.Classes.ObjectCache({size:this.__options.model_cache_size}),this._auto_destroy(this.__models_by_cid),this.__models_by_cid.on("release",function(a){a.hasId()&&delete this.__models_by_id[a.id()]},this),this.__options.auto_materialize&&this.__store.on("insert",function(a,b){if(!(this.__models_by_id[a[this.primary_key()]]||b&&b.model_create)){var c=this.__materialize(a);this.trigger("create",c)}},this),this.__store.on("update",function(a,b,c){if(!(!this.__models_by_id[a[this.primary_key()]]||c&&c.model_update)){var d=this.__models_by_id[a[this.primary_key()]];d.setAll(b,{silent:!0}),this.trigger("update",d)}},this),this.__store.on("remove",function(a,b){if(!(!this.__models_by_id[a]||b&&b.model_remove)){var c=this.__models_by_id[a];this.trigger("remove",c),c.destroy()}},this)},_model_register:function(a){this.hasModel(a)||(this.trigger("register",a),this.__models_by_cid.add(a),a.hasId()&&(this.__models_by_id[a.id()]=a),a.isNew()&&this.__options.auto_create&&this._model_create(a))},_model_unregister:function(a){this.hasModel(a)&&(a.save(),this.__models_by_cid.remove(a),a.hasId()&&delete this.__models_by_id[a.id()],this.trigger("unregister",a))},hasModel:function(a){return null!==this.__models_by_cid.get(a)},_model_remove:function(a,b){return this.hasModel(a)?this.then(this.__store,this.__store.remove,[[a.id(),{model_remove:!0}]],b,function(b,c){this.trigger("remove",a),a.destroy(),this.callback(c,"success",!0)},function(a,b){this.callback(b,"exception",a)}):!1},_model_save:function(a,b){return a.isNew()?this._model_create(a,b):this._model_update(a,b)},__exception_conversion:function(a,b){return this.__options.store_validation_conversion?a.validation_exception_conversion(b):b},_model_create:function(a,b){if(!this.hasModel(a)||!a.isNew())return!1;if(!a.validate()){var c=new BetaJS.Modelling.ModelInvalidException(a);if(!b)throw c;this.callback(b,"exception",c)}var d=BetaJS.Scopes.resolve(this.__model_type).filterPersistent(a.get_all_properties());return this.__options.type_column&&(d[this.__options.type_column]=a.cls.classname),this.then(this.__store,this.__store.insert,[[d,{model_create:!0}]],b,function(b,c){return a.cls.primary_key()in b?(this.__models_by_id[b[a.cls.primary_key()]]=a,a.setAll(b,{no_change:!0,silent:!0}),delete this.__models_changed[a.cid()],this.trigger("create",a),this.trigger("save",a),!0):this.callback(c,"exception",new BetaJS.Modelling.ModelMissingIdException(a))},function(b,c){b=BetaJS.Exceptions.ensure(b),b=this.__exception_conversion(a,b),this.callback(c,"exception",b)})},_model_update:function(a,b){if(!this.hasModel(a)||a.isNew())return!1;if(!a.validate()){var c=new BetaJS.Modelling.ModelInvalidException(a);if(!b)throw c;this.callback(b,"exception",c)}var d=BetaJS.Scopes.resolve(this.__model_type).filterPersistent(a.properties_changed());return BetaJS.Types.is_empty(d)?(b&&this.callback(b,"success",d),d):this.then(this.__store,this.__store.update,[a.id(),[d,{model_update:!0}]],b,function(b,c){return a.setAll(b,{no_change:!0,silent:!0}),delete this.__models_changed[a.cid()],this.trigger("update",a),this.trigger("save",a),this.callback(c,"success",b),b},function(b,c){return b=BetaJS.Exceptions.ensure(b),b=this.__exception_conversion(a,b),this.callback(c,"exception",b),!1})},_model_set_value:function(a,b,c,d){return this.__models_changed[a.cid()]=a,this.trigger("change",a,b,c),this.trigger("change:"+b,a,c),this.__options.auto_update?a.save(d):void 0},save:function(a){if(a){var b=[];return BetaJS.Objs.iter(this.__models_changed,function(a){b.push(a.promise(a.save))},this),this.join(b,a)}var c=!0;return BetaJS.Objs.iter(this.__models_changed,function(a){c=a.save()&&c}),c},primary_key:function(){return BetaJS.Scopes.resolve(this.__model_type).primary_key()},__materialize:function(a){if(!a)return null;var b=this.__model_type;this.__options.type_column&&a[this.__options.type_column]&&(b=a[this.__options.type_column]);var c=BetaJS.Scopes.resolve(b);if(this.__models_by_id[a[this.primary_key()]])return this.__models_by_id[a[this.primary_key()]];var d=new c(a,{table:this,saved:!0,"new":!1});return d},findById:function(a,b){return this.__models_by_id[a]?(b&&this.callback(b,"success",this.__models_by_id[a]),this.__models_by_id[a]):this.then(this.__store,this.__store.get,[a],b,function(b,c){this.callback(c,"success",this.__materialize(this.__store.get(a)))})},findBy:function(a,b){return this.then(this,this.allBy,[a,{limit:1}],b,function(a,b){this.callback(b,"success",a.next())})},all:function(a,b){return this.allBy({},a,b)},allBy:function(a,b,c){var d=this;return this.__store.then(this.__store.query,[a,b],c,function(a,b){var c=new BetaJS.Iterators.MappedIterator(a,function(a){return this.__materialize(a)},d);d.callback(b,"success",c)})},query:function(){return this.allBy.apply(this,arguments)},scheme:function(){return this.__model_type.scheme()},ensure_indices:function(){if(!("ensure_index"in this.__store))return!1;var a=this.scheme();for(var b in a)a[b].index&&this.__store.ensure_index(b);return!0}}]),BetaJS.Class.extend("BetaJS.Modelling.Associations.Association",[BetaJS.SyncAsync.SyncAsyncMixin,{constructor:function(a,b){this._inherited(BetaJS.Modelling.Associations.Association,"constructor"),this._model=a,this._options=b||{},this.__cache=null,b.delete_cascade&&a.on("remove",function(){this.__delete_cascade()},this),b.ignore_change_id||a.on("change_id",function(a,b){this._change_id(a,b)},this)},_change_id:function(){},__delete_cascade:function(){this.yield({success:function(a){a=BetaJS.Iterators.ensure(a).toArray();for(var b=[];a.hasNext();){var c=a.next();b.push(c.promise(c.remove))}this.join(b,{success:function(){}})}})},"yield":function(a){return this._options.cached?this.eitherFactory("__cache",a,this._yield,this._yield):this._yield(a)},invalidate:function(){delete this.__cache}}]),BetaJS.Modelling.Associations.Association.extend("BetaJS.Modelling.Associations.TableAssociation",{constructor:function(a,b,c,d){this._inherited(BetaJS.Modelling.Associations.TableAssociation,"constructor",a,d),this._foreign_table=b,this._foreign_key=c,d.primary_key&&(this._primary_key=d.primary_key),this._options.cached&&this._foreign_table.on("create update remove",function(){this.invalidate()},this)},destroy:function(){this._foreign_table.off(null,null,this),this._inherited(BetaJS.Modelling.Associations.TableAssociation,"destroy")}}),BetaJS.Modelling.Associations.TableAssociation.extend("BetaJS.Modelling.Associations.HasManyAssociation",{_id:function(){return this._primary_key?this._model.get(this._primary_key):this._model.id()},_yield:function(a){return this.allBy({},a)},"yield":function(a){if(!this._options.cached)return this._yield(a);if(this.__cache){var b=new BetaJS.Iterators.ArrayIterator(this.__cache);return a&&this.callback(a,"success",b),b}return this.then(this._yield,a,function(a,b){this.__cache=a.asArray(),BetaJS.Objs.iter(this.__cache,function(a){a.on("destroy",function(){this.invalidate()},this)},this),this.callback(b,"success",new BetaJS.Iterators.ArrayIterator(this.__cache))})},invalidate:function(){BetaJS.Objs.iter(this.__cache,function(a){a.off(null,null,this)},this),this._inherited(BetaJS.Modelling.Associations.HasManyAssociation,"invalidate")},findBy:function(a,b){return a[this._foreign_key]=this._id(),this._foreign_table.findBy(a,b)},allBy:function(a,b,c){return a[this._foreign_key]=c?c:this._id(),this._foreign_table.allBy(a,{},b)},_change_id:function(a,b){this.allBy({},{content:this,success:function(b){for(;b.hasNext();){var c=b.next();c.set(this._foreign_key,a),c.save()}}},b)}}),BetaJS.Modelling.Associations.HasManyAssociation.extend("BetaJS.Modelling.Associations.HasManyThroughArrayAssociation",{_yield:function(a){if(a){var b=[];return BetaJS.Objs.iter(this._model.get(this._foreign_key),function(a){b.push(this._foreign_table.promise(this._foreign_table.findById,[a]))},this),this.join(b,BetaJS.SyncAsync.mapSuccess(a,function(b){this.callback(a,"success",BetaJS.Objs.filter(b,function(a){return!!a}))}))}var c=[];return BetaJS.Objs.iter(this._model.get(this._foreign_key),function(a){var b=this._foreign_table.findById(a);b&&c.push(b)},this),c},"yield":function(a){if(!this._options.cached)return new BetaJS.Iterators.ArrayIterator(this._yield(a));if(this.__cache){var b=new BetaJS.Iterators.ArrayIterator(this.__cache);return a&&this.callback(a,"success",b),b}return this.then(this._yield,a,function(a,b){this.__cache=a,BetaJS.Objs.iter(this.__cache,function(a){a.on("destroy",function(){this.invalidate()},this)},this),this.callback(b,"success",new BetaJS.Iterators.ArrayIterator(this.__cache))})}}),BetaJS.Modelling.Associations.TableAssociation.extend("BetaJS.Modelling.Associations.HasOneAssociation",{_yield:function(a,b){var c={};return c[this._foreign_key]=b?b:this._primary_key?this._model.get(this._primary_key):this._model.id(),this.then(this._foreign_table,this._foreign_table.findBy,[c],a,function(a,b){a&&a.on("destroy",function(){this.invalidate()},this),this.callback(b,"success",a)})},_change_id:function(a,b){this._yield({context:this,success:function(b){b&&(b.set(this._foreign_key,a),b.save())}},b)}}),BetaJS.Modelling.Associations.TableAssociation.extend("BetaJS.Modelling.Associations.BelongsToAssociation",{_yield:function(a){var b=function(a,b){a&&a.on("destroy",function(){this.invalidate()},this),this.callback(b,"success",a)};if(!this._primary_key)return this.then(this._foreign_table,this._foreign_table.findById,[this._model.get(this._foreign_key)],a,b);var c={};return c[this._primary_key]=this._model.get(this._foreign_key),this.then(this._foreign_table,this._foreign_table.findBy,[c],a,b)}}),BetaJS.Modelling.Associations.Association.extend("BetaJS.Modelling.Associations.ConditionalAssociation",{constructor:function(a,b){this._inherited(BetaJS.Modelling.Associations.ConditionalAssociation,"constructor"),this._model=a,this._options=b||{},this.__cache=null,b.delete_cascade&&a.on("remove",function(){this.__delete_cascade()},this),b.ignore_change_id||a.on("change_id",function(a,b){this._change_id(a,b)},this)},_yield:function(a){return this._model.assocs[this._options.conditional(this._model)].yield(a)}}),BetaJS.Modelling.Associations.Association.extend("BetaJS.Modelling.Associations.PolymorphicHasOneAssociation",{constructor:function(a,b,c,d){this._inherited(BetaJS.Modelling.Associations.PolymorphicHasOneAssociation,"constructor",a,d),this._foreign_table_key=b,this._foreign_key=c,d.primary_key&&(this._primary_key=d.primary_key)},_yield:function(a,b){var c={};c[this._foreign_key]=b?b:this._primary_key?this._model.get(this._primary_key):this._model.id();var d=BetaJS.Scopes.resolve(this._model.get(this._foreign_table_key));return this.then(d,d.findBy,[c],a,function(a,b){a&&a.on("destroy",function(){this.invalidate()},this),this.callback(b,"success",a)})},_change_id:function(a,b){this._yield({success:function(b){b&&(b.set(this._foreign_key,a),b.save())}},b)}}),BetaJS.Class.extend("BetaJS.Modelling.Validators.Validator",{validate:function(){return null}}),BetaJS.Modelling.Validators.Validator.extend("BetaJS.Modelling.Validators.PresentValidator",{constructor:function(a){this._inherited(BetaJS.Modelling.Validators.PresentValidator,"constructor"),this.__error_string=a?a:"Field is required"},validate:function(a){return BetaJS.Types.is_null(a)||""===a?this.__error_string:null}}),BetaJS.Modelling.Validators.Validator.extend("BetaJS.Modelling.Validators.EmailValidator",{constructor:function(a){this._inherited(BetaJS.Modelling.Validators.EmailValidator,"constructor"),this.__error_string=a?a:"Not a valid email address"},validate:function(a){return BetaJS.Strings.is_email_address(a)?null:this.__error_string}}),BetaJS.Modelling.Validators.Validator.extend("BetaJS.Modelling.Validators.LengthValidator",{constructor:function(a){this._inherited(BetaJS.Modelling.Validators.LengthValidator,"constructor"),this.__min_length=BetaJS.Types.is_defined(a.min_length)?a.min_length:null,this.__max_length=BetaJS.Types.is_defined(a.max_length)?a.max_length:null,this.__error_string=BetaJS.Types.is_defined(a.error_string)?a.error_string:null,this.__error_string||(null!==this.__min_length?this.__error_string=null!==this.__max_length?"Between "+this.__min_length+" and "+this.__max_length+" characters":"At least "+this.__min_length+" characters":null!==this.__max_length&&(this.__error_string="At most "+this.__max_length+" characters"))},validate:function(a){return null!==this.__min_length&&(!a||a.length<this.__min_length)?this.__error_string:null!==this.__max_length&&a.length>this.__max_length?this.__error_string:null}}),BetaJS.Modelling.Validators.Validator.extend("BetaJS.Modelling.Validators.UniqueValidator",{constructor:function(a,b){this._inherited(BetaJS.Modelling.Validators.UniqueValidator,"constructor"),this.__key=a,this.__error_string=b?b:"Key already present"},validate:function(a,b){var c={};c[this.__key]=a;var d=b.table().findBy(c);return!d||!b.isNew()&&b.id()==d.id()?null:this.__error_string}}),BetaJS.Modelling.Validators.Validator.extend("BetaJS.Modelling.Validators.ConditionalValidator",{constructor:function(a,b){this._inherited(BetaJS.Modelling.Validators.ConditionalValidator,"constructor"),this.__condition=a,this.__validator=BetaJS.Types.is_array(b)?b:[b]},validate:function(a,b){if(!this.__condition(a,b))return null;for(var c=0;c<this.__validator.length;++c){var d=this.__validator[c].validate(a,b);if(null!==d)return d}return null}});