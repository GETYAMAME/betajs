/*! betajs - v0.0.1 - 2013-08-21, Copyright (c) Oliver Friedmann & Victor Lingenthal, MIT Software License. */BetaJS.Net=BetaJS.Net||{},BetaJS.Net.HttpHeader={HTTP_STATUS_OK:200,HTTP_STATUS_CREATED:201,HTTP_STATUS_PAYMENT_REQUIRED:402,HTTP_STATUS_FORBIDDEN:403,HTTP_STATUS_NOT_FOUND:404,HTTP_STATUS_PRECONDITION_FAILED:412,HTTP_STATUS_INTERNAL_SERVER_ERROR:500,format:function(a,b){var c="";return c=a==this.HTTP_STATUS_OK?"OK":a==this.HTTP.STATUS_CREATED?"Created":a==this.HTTP_STATUS_PAYMENT_REQUIRED?"Payment Required":a==this.HTTP_STATUS_FORBIDDEN?"Forbidden":a==this.HTTP_STATUS_NOT_FOUND?"Not found":a==this.HTTP_STATUS_PRECONDITION_FAILED?"Precondition Failed":a==this.HTTP_STATUS_INTERNAL_SERVER_ERROR?"Internal Server Error":"Other Error",b?a+" "+c:c}},BetaJS.Properties.Properties.extend("BetaJS.Modelling.SchemedProperties",{constructor:function(a,b){this._inherited(BetaJS.Modelling.SchemedProperties,"constructor");var c=this.cls.scheme();this._properties_changed={},this.__errors={},this.__unvalidated={};for(var d in c)"def"in c[d]?this.set(d,c[d].def):c[d].auto_create?this.set(d,c[d].auto_create(this)):this.set(d,null);b=b||{},this._properties_changed={},this.__errors={},this.__unvalidated={};for(d in a)this.set(d,a[d])},_unsetChanged:function(a){delete this._properties_changed[a]},_afterSet:function(a,b){var c=this.cls.scheme();a in c&&(this._properties_changed[a]=b,this.__unvalidated[a]=!0,delete this.__errors[a])},properties_changed:function(a){return BetaJS.Types.is_boolean(a)?BetaJS.Objs.filter(this._properties_changed,function(b,c){return this.validateAttr(c)==a},this):this._properties_changed},properties_by:function(a){return BetaJS.Types.is_boolean(a)?BetaJS.Objs.filter(this.getAll(),function(b,c){return this.validateAttr(c)==a},this):this.getAll()},validate:function(){this.trigger("validate");for(key in this.__unvalidated)this.validateAttr(key);return BetaJS.Types.is_empty(this.__errors)},validateAttr:function(a){if(a in this.__unvalidated){delete this.__unvalidated[a],delete this.__errors[a];var b=this.cls.scheme(),c=b[a];if("validate"in c){var d=c.validate;BetaJS.Types.is_array(d)||(d=[d]);var e=this.get(a);BetaJS.Objs.iter(d,function(b){var c=b.validate(e,this);return null!=c&&(this.__errors[a]=c),null==c},this)}this.trigger("validate:"+a,!(a in this.__errors),this.__errors[a])}return!(a in this.__errors)},setError:function(a,b){delete this.__unvalidated[a],this.__errors[a]=b},revalidate:function(){return this.__errors={},this.__unvalidated=this.keys(!0),this.validate()},errors:function(){return this.__errors},asRecord:function(a){var b={},c=this.cls.scheme(),d=this.getAll();a=a||{};for(var e in d)if(e in c){var f=c[e].tags||[],g={};BetaJS.Objs.iter(f,function(a){g[a]=!0});var h=!0;BetaJS.Objs.iter(a,function(a){h=h&&a in g},this),h&&(b[e]=d[e])}return b},setByTags:function(a,b){var c=this.cls.scheme();b=b||{};for(var d in a)if(d in c){var e=c[d].tags||[],f={};BetaJS.Objs.iter(e,function(a){f[a]=!0});var g=!0;BetaJS.Objs.iter(b,function(a){g=g&&a in f},this),g&&this.set(d,a[d])}}},{_initializeScheme:function(){var a={};return a[this.primary_key()]={type:"id"},a},asRecords:function(a,b){return a.map(function(a){return a.asRecord(b)})}},{scheme:function(){return this.__scheme=this.__scheme||this._initializeScheme(),this.__scheme}}),BetaJS.Modelling.SchemedProperties.extend("BetaJS.Modelling.AssociatedProperties",{constructor:function(a,b){this._inherited(BetaJS.Modelling.AssociatedProperties,"constructor",a,b),this.assocs=this._initializeAssociations();for(var c in this.assocs)this.__addAssoc(c,this.assocs[c]);this.on("change:"+this.cls.primary_key(),function(a,b){this._change_id(a,b),this.trigger("change_id",a,b)},this)},_change_id:function(){},__addAssoc:function(a,b){this[a]=function(){return b.yield()}},_initializeAssociations:function(){return{}},destroy:function(){for(var a in this.assocs)this.assocs[a].destroy();this._inherited(BetaJS.Modelling.AssociatedProperties,"destroy")},id:function(){return this.get(this.cls.primary_key())},hasId:function(){return this.has(this.cls.primary_key())}},{primary_key:function(){return"id"}}),BetaJS.Modelling.AssociatedProperties.extend("BetaJS.Modelling.Model",[BetaJS.Ids.ClientIdMixin,BetaJS.Classes.AutoDestroyMixin,{constructor:function(a,b){this._inherited(BetaJS.Modelling.Model,"constructor",a,b),this.__saved="saved"in b?b.saved:!1,this.__new="new"in b?b["new"]:!0,this.__removed=!1,this.__saved&&(this._properties_changed={}),this.__table=b.table,this.__table._model_register(this)},destroy:function(){this.__table._model_unregister(this),this.trigger("destroy"),this._inherited(BetaJS.Modelling.Model,"destroy")},isSaved:function(){return this.__saved},isNew:function(){return this.__new},isRemoved:function(){return this.__removed},update:function(a,b){this.setAll(a,{silent:!0}),this.save(b)},_afterSet:function(a,b,c,d){this._inherited(BetaJS.Modelling.Model,"_afterSet",a,b,c,d);var e=this.cls.scheme();a in e&&(d&&d.no_change?this._unsetChanged(a):this.__saved=!1,d&&d.silent||this.__table&&this.__table._model_set_value(this,a,b,d))},_after_create:function(){},save:function(a){var b=this,c=BetaJS.Objs.clone(a||{},1);return c.success=function(){b.trigger("save"),b.__saved=!0;var c=b.__new;b.__new=!1,c&&b._after_create(),a&&a.success&&a.success()},this.__table._model_save(this,c)},remove:function(a){var b=this,c=BetaJS.Objs.clone(a||{},1);return c.success=function(){b.trigger("remove"),b.__removed=!0,a&&a.success&&a.success()},this.__table._model_remove(this,c)}}]),BetaJS.Exceptions.Exception.extend("BetaJS.Modelling.ModelException",{constructor:function(a,b){this._inherited(BetaJS.Modelling.ModelException,"constructor",b),this.__model=a},model:function(){return this.__model}}),BetaJS.Modelling.ModelException.extend("BetaJS.Modelling.ModelInvalidException",{constructor:function(a){var b=BetaJS.Objs.values(a.errors()).join("\n");this._inherited(BetaJS.Modelling.ModelInvalidException,"constructor",a,b)}}),BetaJS.Modelling.ModelException.extend("BetaJS.Modelling.ModelMissingIdException",{constructor:function(a){this._inherited(BetaJS.Modelling.ModelMissingIdException,"constructor",a,"No id given.")}}),BetaJS.Class.extend("BetaJS.Modelling.Table",[BetaJS.Events.EventsMixin,{constructor:function(a,b,c){this._inherited(BetaJS.Modelling.Table,"constructor"),this.__store=a,this.__model_type=b,this.__models_by_id={},this.__models_by_cid={},this.__models_changed={},this.__options=BetaJS.Objs.extend({type_column:null,remove_exception:!0,auto_create:!1,create_exception:!0,invalid_create_exception:!0,invalid_create_save:!1,greedy_create:!1,store_validation_conversion:!0,auto_update:!0,update_exception:!0,invalid_update_exception:!0,invalid_update_save:!1,greedy_update:!1},c||{})},async_read:function(){return this.__store.async_read()},async_write:function(){return this.__store.async_write()},_model_register:function(a){this.hasModel(a)||(this.trigger("register",a),this.__models_by_cid[a.cid()]=a,a.hasId()&&(this.__models_by_id[a.id()]=a),a.isNew()&&this.__options.auto_create&&this._model_create(a))},_model_unregister:function(a){this.hasModel(a)&&(a.save(),delete this.__models_by_cid[a.cid()],a.hasId()&&delete this.__models_by_id[a.id()],this.trigger("unregister",a))},hasModel:function(a){return a.cid()in this.__models_by_cid},_model_remove:function(a,b){if(!this.hasModel(a))return!1;var c=this,d={success:function(){return b&&b.success&&b.success(),b&&b.complete&&b.complete(),c.trigger("remove",a),a.destroy(),!0},exception:function(a){if(b&&b.exception&&b.exception(a),b&&b.complete&&b.complete(),(!b||!b.exception)&&c.__options.remove_exception)throw a;return!1}};if(this.async_write())this.__store.remove(a.id(),d);else try{return this.__store.remove(a.id()),d.success()}catch(e){return d.exception(e)}},_model_save:function(a,b){return a.isNew()?this._model_create(a,b):this._model_update(a,b)},__exception_conversion:function(a,b){if(this.__options.store_validation_conversion&&b.instance_of(BetaJS.Stores.RemoteStoreException)){var c=b.source();c.status_code()==BetaJS.Net.HttpHeader.HTTP_STATUS_PRECONDITION_FAILED&&c.data()&&(BetaJS.Objs.iter(c.data(),function(b,c){a.setError(c,b)},this),b=new BetaJS.Modelling.ModelInvalidException(a))}return b},_model_create:function(a,b){if(!this.hasModel(a)||!a.isNew())return!1;var c=this,d=a.validate();if(!d){var e=new BetaJS.Modelling.ModelInvalidException(a);if(b&&b.exception&&b.exception(e),b&&b.complete&&b.complete(),(!b||!b.exception)&&c.__options.invalid_create_exception)throw e;if(!this.__options.invalid_create_save)return!1}var f=this.__options.greedy_create?a.properties_by(!0):a.getAll();this.__options.type_column&&(f[this.__options.type_column]=a.cls.classname);var g={success:function(e){if(!(a.cls.primary_key()in e))return g.exception(new BetaJS.Modelling.ModelMissingIdException(a));if(c.__models_by_id[e[a.cls.primary_key()]]=a,!c.__options.greedy_create)for(var f in a.properties_by(!1))delete e[f];return a.setAll(e,{no_change:!0,silent:!0}),d&&delete c.__models_changed[a.cid()],c.trigger("create",a),c.trigger("save",a),b&&b.success&&b.success(e),b&&b.complete&&b.complete(),!0},exception:function(d){if(d=BetaJS.Exceptions.ensure(d),d=c.__exception_conversion(a,d),b&&b.exception&&b.exception(d),b&&b.complete&&b.complete(),(!b||!b.exception)&&c.__options.create_exception)throw d;return!1}};if(this.async_write())this.__store.insert(f,g);else try{var h=this.__store.insert(f);return g.success(h)}catch(e){return g.exception(e)}},_model_update:function(a,b){if(!this.hasModel(a)||a.isNew())return!1;var c=this,d=a.validate();if(!d){var e=new BetaJS.Modelling.ModelInvalidException(a);if(b&&b.exception&&b.exception(e),b&&b.complete&&b.complete(),(!b||!b.exception)&&c.__options.invalid_update_exception)throw e;if(!this.__options.invalid_update_save)return!1}var f=this.__options.greedy_update?a.properties_changed(!0):a.properties_changed(),g={success:function(e){if(!c.__options.greedy_update)for(var f in a.properties_changed(!1))delete e[f];return a.setAll(e,{no_change:!0,silent:!0}),d&&delete c.__models_changed[a.cid()],c.trigger("update",a),c.trigger("save",a),b&&b.success&&b.success(e),b&&b.complete&&b.complete(),!0},exception:function(a){if(b&&b.exception&&b.exception(a),b&&b.complete&&b.complete(),(!b||!b.exception)&&c.__options.update_exception)throw a;return!1}};if(this.async_write()&&!BetaJS.Types.is_empty(f))this.__store.update(a.id(),f,g);else try{var h=BetaJS.Types.is_empty(f)?{}:this.__store.update(a.id(),f);return g.success(h)}catch(e){return g.exception(e)}},_model_set_value:function(a,b,c,d){return this.__models_changed[a.cid()]=a,this.trigger("change",a,b,c),this.trigger("change:"+b,a,c),this.__options.auto_update?a.save(d):void 0},save:function(){var a=!0;return BetaJS.Objs.iter(this.__models_changed,function(b){a=b.save()&&a}),a},__materialize:function(a){if(!a)return null;var b=this.__model_type;this.__options.type_column&&a[this.__options.type_column]&&(b=a[this.__options.type_column]);var c=BetaJS.Scopes.resolve(b);if(this.__models_by_id[a[c.primary_key()]])return this.__models_by_id[a[c.primary_key()]];var d=new c(a,{table:this,saved:!0,"new":!1});return d},findById:function(a){return this.__models_by_id[a]?this.__models_by_id[a]:this.__materialize(this.__store.get(a))},findBy:function(a){return this.allBy(a,{limit:1}).next()},all:function(a){return this.allBy({},a)},allBy:function(a,b){var c=this.__store.query(a,b),d=this,e=new BetaJS.Iterators.MappedIterator(c,function(a){return d.__materialize(a)});return e},active_query_engine:function(){if(!this._active_query_engine){var a=this;this._active_query_engine=new BetaJS.Queries.ActiveQueryEngine,this._active_query_engine._query=function(b){return a.allBy(b)},this.on("create",function(a){this._active_query_engine.insert(a)}),this.on("remove",function(a){this._active_query_engine.remove(a)}),this.on("change",function(a){this._active_query_engine.update(a)})}return this._active_query_engine}}]),BetaJS.Class.extend("BetaJS.Modelling.Associations.Association",{constructor:function(a,b){this._inherited(BetaJS.Modelling.Associations.Association,"constructor"),this._model=a,this._options=b||{},this.__cache=null,b.delete_cascade&&a.on("remove",function(){this.__delete_cascade()},this),b.ignore_change_id||a.on("change_id",function(a,b){this._change_id(a,b)},this)},_change_id:function(){},__delete_cascade:function(){for(var a=BetaJS.Iterators.ensure(this.yield());a.hasNext();)a.next().remove()},yield:function(){if(this.__cache)return this.__cache;var a=this._yield();return this._options.cached&&(this.__cache=a),a},invalidate:function(){delete this.__cache}}),BetaJS.Modelling.Associations.Association.extend("BetaJS.Modelling.Associations.TableAssociation",{constructor:function(a,b,c,d){this._inherited(BetaJS.Modelling.Associations.TableAssociation,"constructor",a,d),this._foreign_table=b,this._foreign_key=c,this._options.cached&&this._foreign_table.on("create update remove",function(){this.invalidate()},this)},destroy:function(){this._foreign_table.off(null,null,this),this._inherited(BetaJS.Modelling.Associations.TableAssociation,"destroy")}}),BetaJS.Modelling.Associations.TableAssociation.extend("BetaJS.Modelling.Associations.HasManyAssociation",{_yield:function(){var a={};return a[this._foreign_key]=this._model.id(),this._foreign_table.allBy(a)},yield:function(){return this._options.cached?(this.__cache||(this.__cache=this._yield().asArray()),new BetaJS.Iterators.ArrayIterator(this.__cache)):this._yield()},findBy:function(a){return a[this._foreign_key]=this._model.id(),this._foreign_table.findBy(a)},allBy:function(a){return a[this._foreign_key]=this._model.id(),this._foreign_table.allBy(a)},_change_id:function(a){for(var b=this._yield();b.hasNext();){var c=b.next();c.set(this._foreign_key,a),c.save()}}}),BetaJS.Modelling.Associations.HasManyAssociation.extend("BetaJS.Modelling.Associations.HasManyThroughArrayAssociation",{_yield:function(){var a=[];return BetaJS.Objs.iter(this._model.get(this._foreign_key),function(b){var c=this._foreign_table.findById(b);c&&a.push(c)},this),a},yield:function(){return this._options.cached?(this.__cache||(this.__cache=this._yield()),new BetaJS.Iterators.ArrayIterator(this.__cache)):new BetaJS.Iterators.ArrayIterator(this._yield())}}),BetaJS.Modelling.Associations.TableAssociation.extend("BetaJS.Modelling.Associations.HasOneAssociation",{_yield:function(a){var b={};return b[this._foreign_key]=a||this._model.id(),this._foreign_table.findBy(b)},_change_id:function(a,b){var c=this._yield(b);c&&(c.set(this._foreign_key,a),c.save())}}),BetaJS.Modelling.Associations.TableAssociation.extend("BetaJS.Modelling.Associations.BelongsToAssociation",{_yield:function(){return this._foreign_table.findById(this._model.get(this._foreign_key))}}),BetaJS.Class.extend("BetaJS.Modelling.Validators.Validator",{validate:function(){return null}}),BetaJS.Modelling.Validators.Validator.extend("BetaJS.Modelling.Validators.PresentValidator",{constructor:function(a){this._inherited(BetaJS.Modelling.Validators.PresentValidator,"constructor"),this.__error_string=a?a:"Field is required"},validate:function(a){return BetaJS.Types.is_null(a)?this.__error_string:null}});