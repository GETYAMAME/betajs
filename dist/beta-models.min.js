/*! betajs - v0.0.2 - 2014-05-14, Copyright (c) Oliver Friedmann & Victor Lingenthal, MIT Software License. */BetaJS.Net=BetaJS.Net||{},BetaJS.Net.HttpHeader={HTTP_STATUS_OK:200,HTTP_STATUS_CREATED:201,HTTP_STATUS_PAYMENT_REQUIRED:402,HTTP_STATUS_FORBIDDEN:403,HTTP_STATUS_NOT_FOUND:404,HTTP_STATUS_PRECONDITION_FAILED:412,HTTP_STATUS_INTERNAL_SERVER_ERROR:500,format:function(t,e){var i="";return i=t==this.HTTP_STATUS_OK?"OK":t==this.HTTP_STATUS_CREATED?"Created":t==this.HTTP_STATUS_PAYMENT_REQUIRED?"Payment Required":t==this.HTTP_STATUS_FORBIDDEN?"Forbidden":t==this.HTTP_STATUS_NOT_FOUND?"Not found":t==this.HTTP_STATUS_PRECONDITION_FAILED?"Precondition Failed":t==this.HTTP_STATUS_INTERNAL_SERVER_ERROR?"Internal Server Error":"Other Error",e?t+" "+i:i}},BetaJS.Exceptions.Exception.extend("BetaJS.Modelling.ModelException",{constructor:function(t,e){this._inherited(BetaJS.Modelling.ModelException,"constructor",e),this.__model=t},model:function(){return this.__model}}),BetaJS.Modelling.ModelException.extend("BetaJS.Modelling.ModelMissingIdException",{constructor:function(t){this._inherited(BetaJS.Modelling.ModelMissingIdException,"constructor",t,"No id given.")}}),BetaJS.Modelling.ModelException.extend("BetaJS.Modelling.ModelInvalidException",{constructor:function(t){var e=BetaJS.Objs.values(t.errors()).join("\n");this._inherited(BetaJS.Modelling.ModelInvalidException,"constructor",t,e)}}),BetaJS.Properties.Properties.extend("BetaJS.Modelling.SchemedProperties",{constructor:function(t,e){this._inherited(BetaJS.Modelling.SchemedProperties,"constructor");var i=this.cls.scheme();this._properties_changed={},this.__errors={},this.__unvalidated={};for(var s in i)"def"in i[s]?this.set(s,i[s].def):i[s].auto_create?this.set(s,i[s].auto_create(this)):this.set(s,null);e=e||{},this._properties_changed={},this.__errors={};for(s in t)this.set(s,t[s])},_unsetChanged:function(t){delete this._properties_changed[t]},_beforeSet:function(t,e){var i=this.cls.scheme();if(!(t in i))return e;var s=i[t];return"boolean"==s.type?BetaJS.Types.parseBool(e):(s.transform&&(e=s.transform.apply(this,[e])),e)},_afterSet:function(t,e){var i=this.cls.scheme();if(t in i&&(this._properties_changed[t]=e,this.__unvalidated[t]=!0,delete this.__errors[t],i[t].after_set)){var s=BetaJS.Types.is_string(i[t].after_set)?this[i[t].after_set]:i[t].after_set;s.apply(this,[e])}},properties_changed:function(t){return BetaJS.Types.is_boolean(t)?BetaJS.Objs.filter(this._properties_changed,function(e,i){return this.validateAttr(i)==t},this):this._properties_changed},get_all_properties:function(){var t={},e=this.cls.scheme();for(var i in e)t[i]=this.get(i);return t},properties_by:function(t){return BetaJS.Types.is_boolean(t)?BetaJS.Objs.filter(this.get_all_properties(),function(e,i){return this.validateAttr(i)==t},this):this.get_all_properties()},validate:function(){this.trigger("validate");for(var t in this.__unvalidated)this.validateAttr(t);return this._customValidate(),BetaJS.Types.is_empty(this.__errors)},_customValidate:function(){},validateAttr:function(t){if(t in this.__unvalidated){delete this.__unvalidated[t],delete this.__errors[t];var e=this.cls.scheme(),i=e[t];if("validate"in i){var s=i.validate;BetaJS.Types.is_array(s)||(s=[s]);var n=this.get(t);BetaJS.Objs.iter(s,function(e){var i=e.validate(n,this);return i&&(this.__errors[t]=i),null===i},this)}this.trigger("validate:"+t,!(t in this.__errors),this.__errors[t])}return!(t in this.__errors)},setError:function(t,e){delete this.__unvalidated[t],this.__errors[t]=e,this.trigger("validate:"+t,!(t in this.__errors),this.__errors[t])},revalidate:function(){return this.__errors={},this.__unvalidated=this.keys(!0),this.validate()},errors:function(){return this.__errors},getError:function(t){return this.__errors[t]},asRecord:function(t){var e={},i=this.cls.scheme(),s=this.get_all_properties();t=t||{};for(var n in s)if(n in i){var r=i[n].tags||[],o={};BetaJS.Objs.iter(r,function(t){o[t]=!0});var _=!0;BetaJS.Objs.iter(t,function(t){_=_&&t in o},this),_&&(e[n]=s[n])}return e},setByTags:function(t,e){var i=this.cls.scheme();e=e||{};for(var s in t)if(s in i){var n=i[s].tags||[],r={};BetaJS.Objs.iter(n,function(t){r[t]=!0});var o=!0;BetaJS.Objs.iter(e,function(t){o=o&&t in r},this),o&&this.set(s,t[s])}},validation_exception_conversion:function(t){var e=t;if(t.instance_of(BetaJS.Stores.RemoteStoreException))e=t.source();else if(!("status_code"in e&&"data"in e))return t;return e.status_code()==BetaJS.Net.HttpHeader.HTTP_STATUS_PRECONDITION_FAILED&&e.data()&&(BetaJS.Objs.iter(e.data(),function(t,e){this.setError(e,t)},this),t=new BetaJS.Modelling.ModelInvalidException(model)),t}},{_initializeScheme:function(){return{}},asRecords:function(t,e){return t.map(function(t){return t.asRecord(e)})},filterPersistent:function(t){var e={},i=this.scheme();for(var s in t)(!BetaJS.Types.is_defined(i[s].persistent)||i[s].persistent)&&(e[s]=t[s]);return e}},{scheme:function(){return this.__scheme=this.__scheme||this._initializeScheme(),this.__scheme}}),BetaJS.Modelling.SchemedProperties.extend("BetaJS.Modelling.AssociatedProperties",{constructor:function(t,e){this._inherited(BetaJS.Modelling.AssociatedProperties,"constructor",t,e),this.assocs=this._initializeAssociations();for(var i in this.assocs)this.__addAssoc(i,this.assocs[i]);this.on("change:"+this.cls.primary_key(),function(t,e){this._change_id(t,e),this.trigger("change_id",t,e)},this)},_change_id:function(){},__addAssoc:function(t,e){this[t]=function(){return e.yield()}},_initializeAssociations:function(){return{}},destroy:function(){for(var t in this.assocs)this.assocs[t].destroy();this._inherited(BetaJS.Modelling.AssociatedProperties,"destroy")},id:function(){return this.get(this.cls.primary_key())},hasId:function(){return this.has(this.cls.primary_key())}},{primary_key:function(){return"id"},_initializeScheme:function(){var t=this._inherited(BetaJS.Modelling.AssociatedProperties,"_initializeScheme");return t[this.primary_key()]={type:"id"},t}}),BetaJS.Modelling.AssociatedProperties.extend("BetaJS.Modelling.Model",[BetaJS.SyncAsync.SyncAsyncMixin,{constructor:function(t,e){e=e||{},this._inherited(BetaJS.Modelling.Model,"constructor",t,e),this.__saved="saved"in e?e.saved:!1,this.__new="new"in e?e["new"]:!0,this.__removed=!1,this.__saved&&(this._properties_changed={}),this.__table=e.table||this.cls.defaultTable(),this.__table._model_register(this),this.__destroying=!1},destroy:function(){!this.__destroying&&this.__table&&(this.__destroying=!0,this.__table._model_unregister(this),this.trigger("destroy"),this._inherited(BetaJS.Modelling.Model,"destroy"))},isSaved:function(){return this.__saved},isNew:function(){return this.__new},isRemoved:function(){return this.__removed},update:function(t,e,i){this.setAll(t,{silent:!0}),this.save(i)},_afterSet:function(t,e,i,s){this._inherited(BetaJS.Modelling.Model,"_afterSet",t,e,i,s);var n=this.cls.scheme();t in n&&(s&&s.no_change?this._unsetChanged(t):this.__saved=!1,s&&s.silent||this.__table&&this.__table._model_set_value(this,t,e,s))},_after_create:function(){},_before_create:function(){},save:function(t){return this.__new&&this._before_create(),this.then(this.__table,this.__table._model_save,[this],t,function(t,e){this.trigger("save"),this.__saved=!0;var i=this.__new;this.__new=!1,i&&this._after_create(),this.callback(e,"success",t)})},remove:function(t){return this.then(this.__table,this.__table._model_remove,[this],t,function(t,e){this.trigger("remove"),this.__removed=!0,this.callback(e,"success",t)})},table:function(){return this.__table}}],{defaultTable:function(){return this.table||(this.table=new BetaJS.Modelling.Table(new BetaJS.Stores.MemoryStore,this)),this.table}}),BetaJS.Class.extend("BetaJS.Modelling.Table",[BetaJS.Events.EventsMixin,BetaJS.SyncAsync.SyncAsyncMixin,{constructor:function(t,e,i){this._inherited(BetaJS.Modelling.Table,"constructor"),this.__store=t,this.__model_type=e,this.__models_by_id={},this.__models_changed={},this.__options=BetaJS.Objs.extend({model_cache_size:null,type_column:null,auto_create:!1,store_validation_conversion:!0,auto_update:!0,auto_materialize:!1},i||{}),this.__models_by_cid=new BetaJS.Classes.ObjectCache({size:this.__options.model_cache_size}),this._auto_destroy(this.__models_by_cid),this.__models_by_cid.on("release",function(t){t.hasId()&&delete this.__models_by_id[t.id()]},this),this.__options.auto_materialize&&this.__store.on("insert",function(t,e){if(!(this.__models_by_id[t[this.primary_key()]]||e&&e.model_create)){var i=this.__materialize(t);this.trigger("create",i)}},this),this.__store.on("update",function(t,e,i){if(!(!this.__models_by_id[t[this.primary_key()]]||i&&i.model_update)){var s=this.__models_by_id[t[this.primary_key()]];s.setAll(e,{silent:!0}),this.trigger("update",s)}},this),this.__store.on("remove",function(t,e){if(!(!this.__models_by_id[t]||e&&e.model_remove)){var i=this.__models_by_id[t];this.trigger("remove",i),i.destroy()}},this)},_model_register:function(t){this.hasModel(t)||(this.trigger("register",t),this.__models_by_cid.add(t),t.hasId()&&(this.__models_by_id[t.id()]=t),t.isNew()&&this.__options.auto_create&&this._model_create(t))},_model_unregister:function(t){this.hasModel(t)&&(t.save(),this.__models_by_cid.remove(t),t.hasId()&&delete this.__models_by_id[t.id()],this.trigger("unregister",t))},hasModel:function(t){return null!==this.__models_by_cid.get(t)},_model_remove:function(t,e){return this.hasModel(t)?this.then(this.__store,this.__store.remove,[[t.id(),{model_remove:!0}]],e,function(e,i){this.trigger("remove",t),t.destroy(),this.callback(i,"success",!0)},function(t,e){this.callback(e,"exception",t)}):!1},_model_save:function(t,e){return t.isNew()?this._model_create(t,e):this._model_update(t,e)},__exception_conversion:function(t,e){return this.__options.store_validation_conversion?t.validation_exception_conversion(e):e},_model_create:function(t,e){if(!this.hasModel(t)||!t.isNew())return!1;if(!t.validate()){var i=new BetaJS.Modelling.ModelInvalidException(t);if(!e)throw i;this.callback(e,"exception",i)}var s=BetaJS.Scopes.resolve(this.__model_type).filterPersistent(t.get_all_properties());return this.__options.type_column&&(s[this.__options.type_column]=t.cls.classname),this.then(this.__store,this.__store.insert,[[s,{model_create:!0}]],e,function(e,i){return t.cls.primary_key()in e?(this.__models_by_id[e[t.cls.primary_key()]]=t,t.setAll(e,{no_change:!0,silent:!0}),delete this.__models_changed[t.cid()],this.trigger("create",t),this.trigger("save",t),!0):this.callback(i,"exception",new BetaJS.Modelling.ModelMissingIdException(t))},function(e,i){e=BetaJS.Exceptions.ensure(e),e=this.__exception_conversion(t,e),this.callback(i,"exception",e)})},_model_update:function(t,e){if(!this.hasModel(t)||t.isNew())return!1;if(!t.validate()){var i=new BetaJS.Modelling.ModelInvalidException(t);if(!e)throw i;this.callback(e,"exception",i)}var s=BetaJS.Scopes.resolve(this.__model_type).filterPersistent(t.properties_changed());return BetaJS.Types.is_empty(s)?(e&&this.callback(e,"success",s),s):this.then(this.__store,this.__store.update,[t.id(),[s,{model_update:!0}]],e,function(e,i){return t.setAll(e,{no_change:!0,silent:!0}),delete this.__models_changed[t.cid()],this.trigger("update",t),this.trigger("save",t),this.callback(i,"success",e),e},function(e,i){return e=BetaJS.Exceptions.ensure(e),e=this.__exception_conversion(t,e),this.callback(i,"exception",e),!1})},_model_set_value:function(t,e,i,s){return this.__models_changed[t.cid()]=t,this.trigger("change",t,e,i),this.trigger("change:"+e,t,i),this.__options.auto_update?t.save(s):void 0},save:function(t){if(t){var e=[];return BetaJS.Objs.iter(this.__models_changed,function(t){e.push(t.promise(t.save))},this),this.join(e,t)}var i=!0;return BetaJS.Objs.iter(this.__models_changed,function(t){i=t.save()&&i}),i},primary_key:function(){return BetaJS.Scopes.resolve(this.__model_type).primary_key()},__materialize:function(t){if(!t)return null;var e=this.__model_type;this.__options.type_column&&t[this.__options.type_column]&&(e=t[this.__options.type_column]);var i=BetaJS.Scopes.resolve(e);if(this.__models_by_id[t[this.primary_key()]])return this.__models_by_id[t[this.primary_key()]];var s=new i(t,{table:this,saved:!0,"new":!1});return s},findById:function(t,e){return this.__models_by_id[t]?(e&&this.callback(e,"success",this.__models_by_id[t]),this.__models_by_id[t]):this.then(this.__store,this.__store.get,[t],e,function(e,i){this.callback(i,"success",this.__materialize(this.__store.get(t)))})},findBy:function(t,e){return this.then(this,this.allBy,[t,{limit:1}],e,function(t,e){this.callback(e,"success",t.next())})},all:function(t,e){return this.allBy({},t,e)},allBy:function(t,e,i){return this.then(this.__store,this.__store.query,[t,e],i,function(t,e){var i=new BetaJS.Iterators.MappedIterator(t,function(t){return this.__materialize(t)},this);this.callback(e,"success",i)})},query:function(){return this.allBy.apply(this,arguments)},scheme:function(){return this.__model_type.scheme()},ensure_indices:function(){if(!("ensure_index"in this.__store))return!1;var t=this.scheme();for(var e in t)t[e].index&&this.__store.ensure_index(e);return!0}}]),BetaJS.Class.extend("BetaJS.Modelling.Associations.Association",[BetaJS.SyncAsync.SyncAsyncMixin,{constructor:function(t,e){this._inherited(BetaJS.Modelling.Associations.Association,"constructor"),this._model=t,this._options=e||{},this.__cache=null,e.delete_cascade&&t.on("remove",function(){this.__delete_cascade()},this),e.ignore_change_id||t.on("change_id",function(t,e){this._change_id(t,e)},this)},_change_id:function(){},__delete_cascade:function(){this.yield({success:function(t){t=BetaJS.Iterators.ensure(t).toArray();for(var e=[];t.hasNext();){var i=t.next();e.push(i.promise(i.remove))}this.join(e,{success:function(){}})}})},yield:function(t){return this._options.cached?this.eitherFactory("__cache",t,this._yield,this._yield):this._yield(t)},invalidate:function(){delete this.__cache}}]),BetaJS.Modelling.Associations.Association.extend("BetaJS.Modelling.Associations.TableAssociation",{constructor:function(t,e,i,s){this._inherited(BetaJS.Modelling.Associations.TableAssociation,"constructor",t,s),this._foreign_table=e,this._foreign_key=i,s.primary_key&&(this._primary_key=s.primary_key),this._options.cached&&this._foreign_table.on("create update remove",function(){this.invalidate()},this)},destroy:function(){this._foreign_table.off(null,null,this),this._inherited(BetaJS.Modelling.Associations.TableAssociation,"destroy")}}),BetaJS.Modelling.Associations.TableAssociation.extend("BetaJS.Modelling.Associations.HasManyAssociation",{_id:function(){return this._primary_key?this._model.get(this._primary_key):this._model.id()},_yield:function(t){return this.allBy({},t)},yield:function(t){if(!this._options.cached)return this._yield(t);if(this.__cache){var e=new BetaJS.Iterators.ArrayIterator(this.__cache);return t&&this.callback(t,"success",e),e}return this.then(this._yield,t,function(t,e){this.__cache=t.asArray(),BetaJS.Objs.iter(this.__cache,function(t){t.on("destroy",function(){this.invalidate()},this)},this),this.callback(e,"success",new BetaJS.Iterators.ArrayIterator(this.__cache))})},invalidate:function(){BetaJS.Objs.iter(this.__cache,function(t){t.off(null,null,this)},this),this._inherited(BetaJS.Modelling.Associations.HasManyAssociation,"invalidate")},findBy:function(t,e){return t[this._foreign_key]=this._id(),this._foreign_table.findBy(t,e)},allBy:function(t,e,i){return t[this._foreign_key]=i?i:this._id(),this._foreign_table.allBy(t,{},e)},_change_id:function(t,e){this.allBy({},{content:this,success:function(e){for(;e.hasNext();){var i=e.next();i.set(this._foreign_key,t),i.save()}}},e)}}),BetaJS.Modelling.Associations.HasManyAssociation.extend("BetaJS.Modelling.Associations.HasManyThroughArrayAssociation",{_yield:function(t){if(t){var e=[];return BetaJS.Objs.iter(this._model.get(this._foreign_key),function(t){e.push(this._foreign_table.promise(this._foreign_table.findById,[t]))},this),this.join(e,BetaJS.SyncAsync.mapSuccess(t,function(e){this.callback(t,"success",BetaJS.Objs.filter(e,function(t){return!!t}))}))}var i=[];return BetaJS.Objs.iter(this._model.get(this._foreign_key),function(t){var e=this._foreign_table.findById(t);e&&i.push(e)},this),i},yield:function(t){if(!this._options.cached)return new BetaJS.Iterators.ArrayIterator(this._yield(t));if(this.__cache){var e=new BetaJS.Iterators.ArrayIterator(this.__cache);return t&&this.callback(t,"success",e),e}return this.then(this._yield,t,function(t,e){this.__cache=t,BetaJS.Objs.iter(this.__cache,function(t){t.on("destroy",function(){this.invalidate()},this)},this),this.callback(e,"success",new BetaJS.Iterators.ArrayIterator(this.__cache))})}}),BetaJS.Modelling.Associations.TableAssociation.extend("BetaJS.Modelling.Associations.HasOneAssociation",{_yield:function(t,e){var i={};return i[this._foreign_key]=e?e:this._primary_key?this._model.get(this._primary_key):this._model.id(),this.then(this._foreign_table,this._foreign_table.findBy,[i],t,function(t,e){t&&t.on("destroy",function(){this.invalidate()},this),this.callback(e,"success",t)})},_change_id:function(t,e){this._yield({context:this,success:function(e){e&&(e.set(this._foreign_key,t),e.save())}},e)}}),BetaJS.Modelling.Associations.TableAssociation.extend("BetaJS.Modelling.Associations.BelongsToAssociation",{_yield:function(t){var e=function(t,e){t&&t.on("destroy",function(){this.invalidate()},this),this.callback(e,"success",t)};if(!this._primary_key)return this.then(this._foreign_table,this._foreign_table.findById,[this._model.get(this._foreign_key)],t,e);var i={};return i[this._primary_key]=this._model.get(this._foreign_key),this.then(this._foreign_table,this._foreign_table.findBy,[i],t,e)}}),BetaJS.Modelling.Associations.Association.extend("BetaJS.Modelling.Associations.ConditionalAssociation",{constructor:function(t,e){this._inherited(BetaJS.Modelling.Associations.ConditionalAssociation,"constructor"),this._model=t,this._options=e||{},this.__cache=null,e.delete_cascade&&t.on("remove",function(){this.__delete_cascade()},this),e.ignore_change_id||t.on("change_id",function(t,e){this._change_id(t,e)},this)},_yield:function(t){return this._model.assocs[this._options.conditional(this._model)].yield(t)}}),BetaJS.Modelling.Associations.Association.extend("BetaJS.Modelling.Associations.PolymorphicHasOneAssociation",{constructor:function(t,e,i,s){this._inherited(BetaJS.Modelling.Associations.PolymorphicHasOneAssociation,"constructor",t,s),this._foreign_table_key=e,this._foreign_key=i,s.primary_key&&(this._primary_key=s.primary_key)},_yield:function(t,e){var i={};i[this._foreign_key]=e?e:this._primary_key?this._model.get(this._primary_key):this._model.id();var s=BetaJS.Scopes.resolve(this._model.get(this._foreign_table_key));return this.then(s,s.findBy,[i],t,function(t,e){t&&t.on("destroy",function(){this.invalidate()},this),this.callback(e,"success",t)})},_change_id:function(t,e){this._yield({success:function(e){e&&(e.set(this._foreign_key,t),e.save())}},e)}}),BetaJS.Class.extend("BetaJS.Modelling.Validators.Validator",{validate:function(){return null}}),BetaJS.Modelling.Validators.Validator.extend("BetaJS.Modelling.Validators.PresentValidator",{constructor:function(t){this._inherited(BetaJS.Modelling.Validators.PresentValidator,"constructor"),this.__error_string=t?t:"Field is required"},validate:function(t){return BetaJS.Types.is_null(t)||""===t?this.__error_string:null}}),BetaJS.Modelling.Validators.Validator.extend("BetaJS.Modelling.Validators.EmailValidator",{constructor:function(t){this._inherited(BetaJS.Modelling.Validators.EmailValidator,"constructor"),this.__error_string=t?t:"Not a valid email address"},validate:function(t){return BetaJS.Strings.is_email_address(t)?null:this.__error_string}}),BetaJS.Modelling.Validators.Validator.extend("BetaJS.Modelling.Validators.LengthValidator",{constructor:function(t){this._inherited(BetaJS.Modelling.Validators.LengthValidator,"constructor"),this.__min_length=BetaJS.Types.is_defined(t.min_length)?t.min_length:null,this.__max_length=BetaJS.Types.is_defined(t.max_length)?t.max_length:null,this.__error_string=BetaJS.Types.is_defined(t.error_string)?t.error_string:null,this.__error_string||(null!==this.__min_length?this.__error_string=null!==this.__max_length?"Between "+this.__min_length+" and "+this.__max_length+" characters":"At least "+this.__min_length+" characters":null!==this.__max_length&&(this.__error_string="At most "+this.__max_length+" characters"))},validate:function(t){return null!==this.__min_length&&(!t||t.length<this.__min_length)?this.__error_string:null!==this.__max_length&&t.length>this.__max_length?this.__error_string:null}}),BetaJS.Modelling.Validators.Validator.extend("BetaJS.Modelling.Validators.UniqueValidator",{constructor:function(t,e){this._inherited(BetaJS.Modelling.Validators.UniqueValidator,"constructor"),this.__key=t,this.__error_string=e?e:"Key already present"},validate:function(t,e){var i={};i[this.__key]=t;var s=e.table().findBy(i);return!s||!e.isNew()&&e.id()==s.id()?null:this.__error_string}}),BetaJS.Modelling.Validators.Validator.extend("BetaJS.Modelling.Validators.ConditionalValidator",{constructor:function(t,e){this._inherited(BetaJS.Modelling.Validators.ConditionalValidator,"constructor"),this.__condition=t,this.__validator=BetaJS.Types.is_array(e)?e:[e]},validate:function(t,e){if(!this.__condition(t,e))return null;for(var i=0;this.__validator.length>i;++i){var s=this.__validator[i].validate(t,e);if(null!==s)return s}return null}});