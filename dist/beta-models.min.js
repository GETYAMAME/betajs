/*! betajs - v0.0.1 - 2013-08-07, Copyright (c) Oliver Friedmann & Victor Lingenthal, MIT Software License. */BetaJS.Modelling=BetaJS.Modelling||{},BetaJS.Modelling.Model=BetaJS.Properties.Properties.extend("Model",[BetaJS.Ids.ClientIdMixin,BetaJS.Classes.AutoDestroyMixin,{constructor:function(t,e){this._inherited(BetaJS.Modelling.Model,"constructor");var i=this.cls.scheme();this.__properties_changed={},this.__errors={},this.__unvalidated={};for(var r in i)"def"in i[r]?this.set(r,i[r].def):i[r].auto_create?this.set(r,i[r].auto_create(this)):this.set(r,null);e=e||{},this.__properties_changed={},this.__errors={},this.__unvalidated={},this.__enter_table_count=0;for(r in t)this.set(r,t[r]);this.__saved="saved"in e?e.saved:!1,this.__new="new"in e?e["new"]:!0,this.__saved&&(this.__properties_changed={}),"table"in e&&(this.__table=e.table),this.__canCallTable()&&this.__table.__modelCreate(this),this.assocs=this._initializeAssociations();for(var r in this.assocs)this.__addAssoc(r,this.assocs[r])},__addAssoc:function(t,e){this[t]=function(){return e.yield()}},_initializeAssociations:function(){return{}},destroy:function(){if(this.__canCallTable()&&!this.__table.__modelDestroy(this))return!1;this.trigger("destroy");for(var t in this.assocs)this.assocs[t].destroy();this._inherited(BetaJS.Modelling.Model,"destroy")},__canCallTable:function(){return this.__table&&this.__enter_table_count>=0},__enterTable:function(){this.__enter_table_count=this.__enter_table_count+1},__leaveTable:function(){this.__enter_table_count=this.__enter_table_count-1},__unsetChanged:function(t){delete this.__properties_changed[t]},_afterSet:function(t,e){var i=this.cls.scheme();t in i&&(this.__properties_changed[t]=e,this.__unvalidated[t]=!0,this.__saved=!1,delete this.__errors[t],this.__canCallTable()&&this.__table.__modelSetAttr(this,t,e))},update:function(t){this.setAll(t),this.__canCallTable()&&this.__table.__modelUpdate(this)},properties_changed:function(t){return BetaJS.Types.is_boolean(t)?BetaJS.Objs.filter(this.__properties_changed,function(e,i){return this.validateAttr(i)==t},this):this.__properties_changed},validate:function(){for(key in this.__unvalidated)this.validateAttr(key);return BetaJS.Types.is_empty(this.__errors)},validateAttr:function(t){if(t in this.__unvalidated){delete this.__unvalidated[t],delete this.__errors[t];var e=this.cls.scheme(),i=e[t];if("validate"in i){var r=i.validate;BetaJS.Types.is_array(r)||(r=[r]);var n=this.get(t);BetaJS.Objs.iter(r,function(e){var i=e.validate(n,this);return null!=i&&(this.__errors[t]=i),null==i},this)}}return!(t in this.__errors)},revalidate:function(){return this.__errors={},this.__unvalidated=this.keys(!0),this.validate()},errors:function(){return this.__errors},save:function(){if(this.__saved)return!0;if(this.__canCallTable()&&!this.__table.__modelSave(this))return!1;this.trigger("save"),this.__saved=!0;var t=this.__new;return this.__new=!1,t&&this._after_create(),!0},_after_create:function(){},isSaved:function(){return this.__saved},isNew:function(){return this.__new},remove:function(){return this.__canCallTable()&&!this.__table.__modelRemove(this)?!1:(this.trigger("remove"),this.destroy(),!0)},asRecord:function(t){var e={},i=this.cls.scheme(),r=this.getAll();t=t||{};for(var n in r)if(n in i){var s=i[n].tags||[],_={};BetaJS.Objs.iter(s,function(t){_[t]=!0});var a=!0;BetaJS.Objs.iter(t,function(t){a=a&&t in _},this),a&&(e[n]=r[n])}return e},setByTags:function(t,e){var i=this.cls.scheme();e=e||{};for(var r in t)if(r in i){var n=i[r].tags||[],s={};BetaJS.Objs.iter(n,function(t){s[t]=!0});var _=!0;BetaJS.Objs.iter(e,function(t){_=_&&t in s},this),_&&this.set(r,t[r])}},id:function(){return this.get(this.cls.primary_key())},hasId:function(){return this.has(this.cls.primary_key())}}],{primary_key:function(){return"id"},_initializeScheme:function(){var t={};return t[this.primary_key()]={type:"id"},t},asRecords:function(t,e){return t.map(function(t){return t.asRecord(e)})}},{scheme:function(){return this.__scheme=this.__scheme||this._initializeScheme(),this.__scheme}}),BetaJS.Modelling.Table=BetaJS.Class.extend("Table",[BetaJS.Events.EventsMixin,{constructor:function(t,e,i){this._inherited(BetaJS.Modelling.Table,"constructor"),this.__store=t,this.__model_type=e,this.__models_by_id={},this.__models_by_cid={},this.__models_changed={},this.__options=BetaJS.Objs.extend({type_column:null,auto_update:!0,auto_update_attr:!1,auto_create:!1,save_invalid:!1,greedy_save:!0},i||{})},__enterModel:function(t){this.trigger("enter",t),this.__models_by_cid[t.cid()]=t,t.hasId()&&(this.__models_by_id[t.id()]=t)},__leaveModel:function(t){this.trigger("leave",t),delete this.__models_by_cid[t.cid()],t.hasId()&&delete this.__models_by_id[t.id()]},__hasModel:function(t){return t.cid()in this.__models_by_cid},__modelCreate:function(t){return this.__hasModel(t)?!1:this.__enterModel(t)&&(!this.__options.auto_create||t.save())},__modelDestroy:function(t){if(!this.__hasModel(t))return!0;var e=t.save();return this.__leaveModel(t)&&e},__modelRemove:function(t){if(!this.__hasModel(t))return!1;var e=this.__store.remove(t.id());return e&&this.trigger("remove",t),this.__leaveModel(t)&&e},__modelSetAttr:function(t,e,i){return this.__models_changed[t.cid()]=t,this.trigger("change",t,e,i),this.trigger("change:"+e,t,i),!this.__options.auto_update_attr||t.save()},__modelUpdate:function(t){return this.trigger("update",t),!this.__options.auto_update||t.save()},__modelSave:function(t){if(t.isSaved())return!0;var e=t.validate();if(!e&&!this.__options.save_invalid&&!this.__options.greedy_save)return!1;var i={},r=t.isNew();i=r?t.getAll():this.__options.save_invalid?t.properties_changed():t.properties_changed(!0);var n={};if(r){if(this.__options.type_column&&(i[this.__options.type_column]=t.cls.classname),n=this.__store.insert(i),!(t.cls.primary_key()in n))return!1;this.__models_by_id[n[t.cls.primary_key()]]=t}else if(!BetaJS.Types.is_empty(i)&&(n=this.__store.update(t.id(),i),BetaJS.Types.is_empty(n)))return!1;if(!this.__options.save_invalid)for(var s in t.properties_changed(!1))delete n[s];t.__leaveTable(),t.setAll(n),t.__enterTable();for(var s in n)t.__unsetChanged(s);return e&&delete this.__models_changed[t.cid()],r&&this.trigger("create",t),this.trigger("save",t),this.__options.save_invalid||e},save:function(){var t=!0;return BetaJS.Objs.iter(this.__models_changed,function(e){t=e.save()&&t}),t},findById:function(t){return this.__models_by_id[t]?this.__models_by_id[t]:this.__materialize(this.__store.get(t))},findBy:function(t){return this.allBy(t,{limit:1}).next()},all:function(t){return this.allBy({},t)},allBy:function(t,e){var i=this.__store.query(t,e),r=this,n=new BetaJS.Iterators.MappedIterator(i,function(t){return r.__materialize(t)});return n},__materialize:function(t){if(!t)return null;var e=this.__model_type;this.__options.type_column&&t[this.__options.type_column]&&(e=t[this.__options.type_column]);var i=BetaJS.Scopes.resolve(e);if(this.__models_by_id[t[i.primary_key()]])return this.__models_by_id[t[i.primary_key()]];var r=new i(t,{table:this,saved:!0,"new":!1});return this.__enterModel(r),r},active_query_engine:function(){if(!this.__active_query_engine){var t=this;this._active_query_engine=new BetaJS.Queries.ActiveQueryEngine,this._active_query_engine._query=function(e){return t.allBy(e)},this.on("create",function(t){this._active_query_engine.insert(t)}),this.on("remove",function(){this._active_query_engine.insert(remove)}),this.on("change",function(t){this._active_query_engine.update(t)})}return this._active_query_engine}}]),BetaJS.Modelling.Associations={},BetaJS.Modelling.Associations.Association=BetaJS.Class.extend("Assocation",{constructor:function(t,e,i,r){this._inherited(BetaJS.Modelling.Associations.Association,"constructor"),this._model=t,this._foreign_table=e,this._foreign_key=i,this._options=r||{},this.__cache=null,r.delete_cascade&&t.on("remove",function(){this.__delete_cascade()},this)},__delete_cascade:function(){for(var t=BetaJS.Iterators.ensure(this.yield());t.hasNext();)t.next().remove()},yield:function(){if(this.__cache)return this.__cache;var t=this._yield();return this._options.cached&&(this.__cache=t),t},invalidate:function(){delete this.__cache}}),BetaJS.Modelling.Associations.HasManyAssociation=BetaJS.Modelling.Associations.Association.extend("HasManyAssocation",{_yield:function(){var t={};return t[this._foreign_key]=this._model.id(),this._foreign_table.allBy(t)},yield:function(){return this._options.cached?(this.__cache||(this.__cache=this._yield().asArray()),new BetaJS.Iterators.ArrayIterator(this.__cache)):this._yield()},findBy:function(t){return t[this._foreign_key]=this._model.id(),this._foreign_table.findBy(t)},allBy:function(t){return t[this._foreign_key]=this._model.id(),this._foreign_table.allBy(t)}}),BetaJS.Modelling.Associations.HasManyThroughArrayAssociation=BetaJS.Modelling.Associations.HasManyAssociation.extend("HasManyThroughArrayAssociation",{_yield:function(){var t=[];return BetaJS.Objs.iter(this._model.get(this._foreign_key),function(e){var i=this._foreign_table.findById(e);i&&t.push(i)},this),t},yield:function(){return this._options.cached?(this.__cache||(this.__cache=this._yield()),new BetaJS.Iterators.ArrayIterator(this.__cache)):new BetaJS.Iterators.ArrayIterator(this._yield())}}),BetaJS.Modelling.Associations.HasOneAssociation=BetaJS.Modelling.Associations.Association.extend("HasOneAssocation",{_yield:function(){var t={};return t[this._foreign_key]=this._model.id(),this._foreign_table.findBy(t)}}),BetaJS.Modelling.Associations.BelongsToAssociation=BetaJS.Modelling.Associations.Association.extend("BelongsToAssocation",{_yield:function(){return this._foreign_table.findById(this._model.get(this._foreign_key))}}),BetaJS.Modelling.Validators={},BetaJS.Modelling.Validators.Validator=BetaJS.Class.extend("Validator",{validate:function(){return null}}),BetaJS.Modelling.Validators.PresentValidator=BetaJS.Modelling.Validators.Validator.extend("PresentValidator",{constructor:function(t){this._inherited(BetaJS.Modelling.Validators.PresentValidator,"constructor"),this.__error_string=t?t:"Field is required"},validate:function(t){return BetaJS.Types.is_null(t)?this.__error_string:null}});