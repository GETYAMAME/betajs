/*! betajs - v0.0.1 - 2013-06-17, Copyright (c) Oliver Friedmann & Victor Lingenthal, MIT Software License. */BetaJS.Modelling=BetaJS.Modelling||{},BetaJS.Modelling.Model=BetaJS.Properties.Properties.extend("Model",[BetaJS.Ids.ClientIdMixin,BetaJS.Classes.AutoDestroyMixin,{constructor:function(t,e){this._inherited(BetaJS.Modelling.Model,"constructor"),e=e||{},this.__properties_changed={},this.__errors={},this.__unvalidated={},this.__enter_table_count=0,"table"in e&&(this.__table=e.table),this.__saved="saved"in e?e.saved:!1,this.__new="new"in e?e["new"]:!0;for(key in t)this.set(key,t[key]);this.__canCallTable()&&this.__table.__modelCreate(this)},destroy:function(){return this.__canCallTable()&&!this.__table.__modelDestroy(this)?!1:(this.trigger("destroy"),this._inherited(BetaJS.Modelling.Model,"destroy"),void 0)},__canCallTable:function(){return this.__table&&this.__enter_table_count>=0},__enterTable:function(){this.__enter_table_count=this.__enter_table_count+1},__leaveTable:function(){this.__enter_table_count=this.__enter_table_count-1},__unsetChanged:function(t){delete this.__properties_changed[t]},_canSet:function(t){var e=this.cls.scheme();return t in e},_afterSet:function(t,e){this.__properties_changed[t]=!0,this.__unvalidated[t]=!0,this.__saved=!1,delete this.__errors[t],this.__canCallTable()&&this.__table.__modelSetAttr(this,t,e)},update:function(t){this.setAll(t),this.__canCallTable()&&this.__table.__modelUpdate(this)},properties_changed:function(t){return BetaJS.Types.is_boolean(t)?BetaJS.Objs.filter(this.__properties_changed,function(e,i){return this.validateAttr(i)==t},this):this.__properties_changed},validate:function(){for(key in this.__unvalidated)this.validateAttr(key);return BetaJS.Types.is_empty(this.__errors)},validateAttr:function(t){if(t in this.__unvalidated){delete this.__unvalidated[t],delete this.__errors[t];var e=this.cls.scheme(),i=e[t];if("validate"in i){var n=i.validate;BetaJS.Types.is_array(n)||(n=[n]);var r=this.get(t);BetaJS.Objs.iter(n,function(e){var i=e.validate(r,this);return null!=i&&(this.__errors[t]=i),null==i},this)}}return!(t in this.__errors)},revalidate:function(){return this.__errors={},this.__unvalidated=this.keys(!0),this.validate()},errors:function(){return this.__errors},save:function(){return this.__saved?!0:this.__canCallTable()&&!this.__table.__modelSave(this)?!1:(this.trigger("save"),this.__saved=!0,this.__new=!1,!0)},isSaved:function(){return this.__saved},isNew:function(){return this.__new},remove:function(){return this.__canCallTable()&&!this.__table.__modelRemove(this)?!1:(this.trigger("remove"),this.destroy(),!0)}}],{_initializeScheme:function(){return{id:{}}}},{scheme:function(){return this.__scheme=this.__scheme||this._initializeScheme(),this.__scheme}}),BetaJS.Modelling.Table=BetaJS.Class.extend("Table",[BetaJS.Events.EventsMixin,{constructor:function(t,e,i){this._inherited(BetaJS.Modelling.Table,"constructor"),this.__store=t,this.__model_type=e,this.__models_by_id={},this.__models_by_cid={},this.__models_changed={},this.__options=BetaJS.Objs.extend({type_column:null,auto_update:!0,auto_update_attr:!1,auto_create:!1,save_invalid:!1,greedy_save:!0},i||{})},__enterModel:function(t){this.trigger("enter",t),this.__models_by_cid[t.cid()]=t,t.has("id")&&(this.__models_by_id[t.get("id")]=t)},__leaveModel:function(t){this.trigger("leave",t),delete this.__models_by_cid[t.cid()],t.has("id")&&delete this.__models_by_id[t.get("id")]},__hasModel:function(t){return t.cid()in this.__model_by_cid},__modelCreate:function(t){return this.__hasModel(t)?!1:this.__enterModel(t)&&(!this.__options.auto_create||t.save())},__modelDestroy:function(t){if(!this.__hasModel(t))return!0;var e=t.save();return this.__leaveModel(t)&&e},__modelRemove:function(t){if(!this.__hasModel(t))return!1;var e=this.__store.remove(t.get("id"));return e&&this.trigger("remove",t),this.__leaveModel(t)&&e},__modelSetAttr:function(t,e,i){return this.__models_changed[t.cid()]=t,this.trigger("change",t,e,i),this.trigger("change:"+e,t,i),!this.__options.auto_update_attr||t.save()},__modelUpdate:function(t){return this.trigger("update",t),!this.__options.auto_update||t.save()},__modelSave:function(t){if(t.isSaved())return!0;var e=t.validate();if(!e&&!this.__options.save_invalid&&!this.__options.greedy_save)return!1;var i={};i=this.__options.save_invalid?t.properties_changed():t.properties_changed(!0);var n={},r=t.isNew();if(r){if(this.__options.type_column&&(i[this.__options.type_column]=t.cls.classname),n=this.__store.insert(i),!("id"in n))return!1;this.__models_by_id[n.id]=t}else if(!BetaJS.Types.is_empty(i)&&(n=this.__store.update(t.get("id"),i),BetaJS.Types.is_empty(n)))return!1;if(!this.__options.save_invalid)for(var s in t.properties_changed(!1))delete n[s];t.__leaveTable(),t.setAll(n),t.__enterTable();for(var s in n)t.__unsetChanged(s);return e&&delete this.__models_changed[t.cid()],r&&this.trigger("create",t),this.trigger("save",t),this.__options.save_invalid||e},save:function(){var t=!0;return BetaJS.Objs.iter(this.__models_changed,function(e){t=e.save()&&t}),t}}]),BetaJS.Modelling.Associations={},BetaJS.Modelling.Associations.Association=BetaJS.Class.extend("Assocation",{}),BetaJS.Modelling.Associations.HasManyAssociation=BetaJS.Modelling.Associations.Association.extend("HasManyAssocation",{}),BetaJS.Modelling.Validators={},BetaJS.Modelling.Validators.Validator=BetaJS.Class.extend("Validator",{validate:function(){return null}}),BetaJS.Modelling.Validators.PresentValidator=BetaJS.Modelling.Validators.Validator.extend("PresentValidator",{constructor:function(t){this._inherited(BetaJS.Modelling.Validators.PresentValidator,"constructor"),this.__error_string=t?t:"Field is required"},validate:function(t){return BetaJS.Types.is_null(t)?this.__error_string:null}});