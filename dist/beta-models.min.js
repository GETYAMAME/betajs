/*! betajs - v0.0.1 - 2013-07-27, Copyright (c) Oliver Friedmann & Victor Lingenthal, MIT Software License. */BetaJS.Modelling=BetaJS.Modelling||{},BetaJS.Modelling.Model=BetaJS.Properties.Properties.extend("Model",[BetaJS.Ids.ClientIdMixin,BetaJS.Classes.AutoDestroyMixin,{constructor:function(a,b){this._inherited(BetaJS.Modelling.Model,"constructor");var c=this.cls.scheme();this.__properties_changed={},this.__errors={},this.__unvalidated={};for(var d in c)c[d].def?this.set(d,c[d].def):c[d].auto_create?this.set(d,c[d].auto_create(this)):this.set(d,null);b=b||{},this.__properties_changed={},this.__errors={},this.__unvalidated={},this.__enter_table_count=0;for(d in a)this.set(d,a[d]);this.__saved="saved"in b?b.saved:!1,this.__new="new"in b?b["new"]:!0,this.__saved&&(this.__properties_changed={}),"table"in b&&(this.__table=b.table),this.__canCallTable()&&this.__table.__modelCreate(this),this.assocs=this._initializeAssociations();for(var d in this.assocs)this.__addAssoc(d,this.assocs[d])},__addAssoc:function(a,b){this[a]=function(){return b.yield()}},_initializeAssociations:function(){return{}},destroy:function(){if(this.__canCallTable()&&!this.__table.__modelDestroy(this))return!1;this.trigger("destroy");for(var a in this.assocs)this.assocs[a].destroy();this._inherited(BetaJS.Modelling.Model,"destroy")},__canCallTable:function(){return this.__table&&this.__enter_table_count>=0},__enterTable:function(){this.__enter_table_count=this.__enter_table_count+1},__leaveTable:function(){this.__enter_table_count=this.__enter_table_count-1},__unsetChanged:function(a){delete this.__properties_changed[a]},_afterSet:function(a,b){var c=this.cls.scheme();a in c&&(this.__properties_changed[a]=!0,this.__unvalidated[a]=!0,this.__saved=!1,delete this.__errors[a],this.__canCallTable()&&this.__table.__modelSetAttr(this,a,b))},update:function(a){this.setAll(a),this.__canCallTable()&&this.__table.__modelUpdate(this)},properties_changed:function(a){return BetaJS.Types.is_boolean(a)?BetaJS.Objs.filter(this.__properties_changed,function(b,c){return this.validateAttr(c)==a},this):this.__properties_changed},validate:function(){for(key in this.__unvalidated)this.validateAttr(key);return BetaJS.Types.is_empty(this.__errors)},validateAttr:function(a){if(a in this.__unvalidated){delete this.__unvalidated[a],delete this.__errors[a];var b=this.cls.scheme(),c=b[a];if("validate"in c){var d=c.validate;BetaJS.Types.is_array(d)||(d=[d]);var e=this.get(a);BetaJS.Objs.iter(d,function(b){var c=b.validate(e,this);return null!=c&&(this.__errors[a]=c),null==c},this)}}return!(a in this.__errors)},revalidate:function(){return this.__errors={},this.__unvalidated=this.keys(!0),this.validate()},errors:function(){return this.__errors},save:function(){if(this.__saved)return!0;if(this.__canCallTable()&&!this.__table.__modelSave(this))return!1;this.trigger("save"),this.__saved=!0;var a=this.__new;return this.__new=!1,a&&this._after_create(),!0},_after_create:function(){},isSaved:function(){return this.__saved},isNew:function(){return this.__new},remove:function(){return this.__canCallTable()&&!this.__table.__modelRemove(this)?!1:(this.trigger("remove"),this.destroy(),!0)},asRecord:function(a){var b={},c=this.cls.scheme(),d=this.getAll();a=a||{};for(var e in d)if(e in c){var f=c[e].tags||[],g={};BetaJS.Objs.iter(f,function(a){g[a]=!0});var h=!0;BetaJS.Objs.iter(a,function(a){h=h&&a in g},this),h&&(b[e]=d[e])}return b},setByTags:function(a,b){var c=this.cls.scheme();b=b||{};for(var d in a)if(d in c){var e=c[d].tags||[],f={};BetaJS.Objs.iter(e,function(a){f[a]=!0});var g=!0;BetaJS.Objs.iter(b,function(a){g=g&&a in f},this),g&&this.set(d,a[d])}},id:function(){return this.get(this.cls.primary_key())},hasId:function(){return this.has(this.cls.primary_key())}}],{primary_key:function(){return"id"},_initializeScheme:function(){var a={};return a[this.primary_key()]={type:"id"},a},asRecords:function(a,b){return a.map(function(a){return a.asRecord(b)})}},{scheme:function(){return this.__scheme=this.__scheme||this._initializeScheme(),this.__scheme}}),BetaJS.Modelling.Table=BetaJS.Class.extend("Table",[BetaJS.Events.EventsMixin,{constructor:function(a,b,c){this._inherited(BetaJS.Modelling.Table,"constructor"),this.__store=a,this.__model_type=b,this.__models_by_id={},this.__models_by_cid={},this.__models_changed={},this.__options=BetaJS.Objs.extend({type_column:null,auto_update:!0,auto_update_attr:!1,auto_create:!1,save_invalid:!1,greedy_save:!0},c||{})},__enterModel:function(a){this.trigger("enter",a),this.__models_by_cid[a.cid()]=a,a.hasId()&&(this.__models_by_id[a.id()]=a)},__leaveModel:function(a){this.trigger("leave",a),delete this.__models_by_cid[a.cid()],a.hasId()&&delete this.__models_by_id[a.id()]},__hasModel:function(a){return a.cid()in this.__models_by_cid},__modelCreate:function(a){return this.__hasModel(a)?!1:this.__enterModel(a)&&(!this.__options.auto_create||a.save())},__modelDestroy:function(a){if(!this.__hasModel(a))return!0;var b=a.save();return this.__leaveModel(a)&&b},__modelRemove:function(a){if(!this.__hasModel(a))return!1;var b=this.__store.remove(a.id());return b&&this.trigger("remove",a),this.__leaveModel(a)&&b},__modelSetAttr:function(a,b,c){return this.__models_changed[a.cid()]=a,this.trigger("change",a,b,c),this.trigger("change:"+b,a,c),!this.__options.auto_update_attr||a.save()},__modelUpdate:function(a){return this.trigger("update",a),!this.__options.auto_update||a.save()},__modelSave:function(a){if(a.isSaved())return!0;var b=a.validate();if(!b&&!this.__options.save_invalid&&!this.__options.greedy_save)return!1;var c={},d=a.isNew();c=d?a.getAll():this.__options.save_invalid?a.properties_changed():a.properties_changed(!0);var e={};if(d){if(this.__options.type_column&&(c[this.__options.type_column]=a.cls.classname),e=this.__store.insert(c),!(a.cls.primary_key()in e))return!1;this.__models_by_id[e[a.cls.primary_key()]]=a}else if(!BetaJS.Types.is_empty(c)&&(e=this.__store.update(a.id(),c),BetaJS.Types.is_empty(e)))return!1;if(!this.__options.save_invalid)for(var f in a.properties_changed(!1))delete e[f];a.__leaveTable(),a.setAll(e),a.__enterTable();for(var f in e)a.__unsetChanged(f);return b&&delete this.__models_changed[a.cid()],d&&this.trigger("create",a),this.trigger("save",a),this.__options.save_invalid||b},save:function(){var a=!0;return BetaJS.Objs.iter(this.__models_changed,function(b){a=b.save()&&a}),a},findById:function(a){return this.__models_by_id[a]?this.__models_by_id[a]:this.__materialize(this.__store.get(a))},findBy:function(a){return this.allBy(a,{limit:1}).next()},all:function(a){return this.allBy({},a)},allBy:function(a,b){var c=this.__store.query(a,b),d=this,e=new BetaJS.Iterators.MappedIterator(c,function(a){return d.__materialize(a)});return e},__materialize:function(a){if(!a)return null;var b=this.__model_type;this.__options.type_column&&a[this.__options.type_column]&&(b=a[this.__options.type_column]);var c=BetaJS.Scopes.resolve(b);if(this.__models_by_id[a[c.primary_key()]])return this.__models_by_id[a[c.primary_key()]];var d=new c(a,{table:this,saved:!0,"new":!1});return this.__enterModel(d),d}}]),BetaJS.Modelling.Associations={},BetaJS.Modelling.Associations.Association=BetaJS.Class.extend("Assocation",{constructor:function(a,b,c,d){this._inherited(BetaJS.Modelling.Associations.Association,"constructor"),this._model=a,this._foreign_table=b,this._foreign_key=c,this._options=d||{},this.__cache=null,d.delete_cascade&&a.on("remove",function(){this.__delete_cascade()},this)},__delete_cascade:function(){for(var a=BetaJS.Iterators.ensure(this.yield());a.hasNext();)a.next().remove()},yield:function(){if(this.__cache)return this.__cache;var a=this._yield();return this._options.cached&&(this.__cache=a),a},invalidate:function(){delete this.__cache}}),BetaJS.Modelling.Associations.HasManyAssociation=BetaJS.Modelling.Associations.Association.extend("HasManyAssocation",{_yield:function(){var a={};return a[this._foreign_key]=this._model.id(),this._foreign_table.allBy(a)},yield:function(){return this._options.cached?(this.__cache||(this.__cache=this._yield().asArray()),new BetaJS.Iterators.ArrayIterator(this.__cache)):this._yield()}}),BetaJS.Modelling.Associations.HasOneAssociation=BetaJS.Modelling.Associations.Association.extend("HasOneAssocation",{_yield:function(){var a={};return a[this._foreign_key]=this._model.id(),this._foreign_table.findBy(a)}}),BetaJS.Modelling.Associations.BelongsToAssociation=BetaJS.Modelling.Associations.Association.extend("BelongsToAssocation",{_yield:function(){return this._foreign_table.findById(this._model.get(this._foreign_key))}}),BetaJS.Modelling.Validators={},BetaJS.Modelling.Validators.Validator=BetaJS.Class.extend("Validator",{validate:function(){return null}}),BetaJS.Modelling.Validators.PresentValidator=BetaJS.Modelling.Validators.Validator.extend("PresentValidator",{constructor:function(a){this._inherited(BetaJS.Modelling.Validators.PresentValidator,"constructor"),this.__error_string=a?a:"Field is required"},validate:function(a){return BetaJS.Types.is_null(a)?this.__error_string:null}});