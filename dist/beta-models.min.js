/*! betajs - v0.0.1 - 2013-06-16, Copyright (c) Oliver Friedmann & Victor Lingenthal, MIT Software License. */BetaJS.Modelling=BetaJS.Modelling||{},BetaJS.Modelling.Model=BetaJS.Properties.Properties.extend("Model",[BetaJS.Ids.ClientIdMixin,BetaJS.Classes.AutoDestroyMixin,{constructor:function(a,b){this._inherited(BetaJS.Modelling.Model,"constructor"),b=b||{},this.__properties_changed={},this.__errors={},this.__unvalidated={},this.__enter_table_count=0,"table"in b&&(this.__table=b.table),this.__saved="saved"in b?b.saved:!1,this.__new="new"in b?b["new"]:!0;for(key in a)this.set(key,a[key]);this.__canCallTable()&&this.__table.__modelCreate(this)},destroy:function(){return this.__canCallTable()&&!this.__table.__modelDestroy(this)?!1:(this.trigger("destroy"),this._inherited(BetaJS.Modelling.Model,"destroy"),void 0)},__canCallTable:function(){return this.__table&&this.__enter_table_count>=0},__enterTable:function(){this.__enter_table_count=this.__enter_table_count+1},__leaveTable:function(){this.__enter_table_count=this.__enter_table_count-1},__unsetChanged:function(a){delete this.__properties_changed[a]},_canSet:function(a){var b=this.cls.scheme();return a in b},_afterSet:function(a,b){this.__properties_changed[a]=!0,this.__unvalidated[a]=!0,this.__saved=!1,delete this.__errors[a],this.__canCallTable()&&this.__table.__modelSetAttr(this,a,b)},update:function(a){this.setAll(a),this.__canCallTable()&&this.__table.__modelUpdate(this)},properties_changed:function(a){return BetaJS.Types.is_boolean(a)?BetaJS.Objs.filter(this.__properties_changed,function(b,c){return this.validateAttr(c)==a},this):this.__properties_changed},validate:function(){for(key in this.__unvalidated)this.validateAttr(key);return BetaJS.Types.is_empty(this.__errors)},validateAttr:function(a){if(a in this.__unvalidated){delete this.__unvalidated[a],delete this.__errors[a];var b=this.cls.scheme(),c=b[a];if("validate"in c){var d=c.validate;BetaJS.Types.is_array(d)||(d=[d]);var e=this.get(a);BetaJS.Objs.iter(d,function(b){var c=b.validate(e,this);return null!=c&&(this.__errors[a]=c),null==c},this)}}return!(a in this.__errors)},revalidate:function(){return this.__errors={},this.__unvalidated=this.keys(!0),this.validate()},errors:function(){return this.__errors},save:function(){return this.__saved?!0:this.__canCallTable()&&!this.__table.__modelSave(this)?!1:(this.trigger("save"),this.__saved=!0,this.__new=!1,!0)},isSaved:function(){return this.__saved},isNew:function(){return this.__new},remove:function(){return this.__canCallTable()&&!this.__table.__modelRemove(this)?!1:(this.trigger("remove"),this.destroy(),!0)}}],{_initializeScheme:function(){return{id:{}}}},{scheme:function(){return this.__scheme=this.__scheme||this._initializeScheme(),this.__scheme}}),BetaJS.Modelling.Table=BetaJS.Class.extend("Table",[BetaJS.Events.EventsMixin,{constructor:function(a,b,c){this._inherited(BetaJS.Modelling.Table,"constructor"),this.__store=a,this.__model_type=b,this.__models_by_id={},this.__models_by_cid={},this.__models_changed={},this.__options=BetaJS.Objs.extend({type_column:null,auto_update:!0,auto_update_attr:!1,auto_create:!1,save_invalid:!1,greedy_save:!0},c||{})},__enterModel:function(a){this.trigger("enter",a),this.__models_by_cid[a.cid()]=a,a.has("id")&&(this.__models_by_id[a.get("id")]=a)},__leaveModel:function(a){this.trigger("leave",a),delete this.__models_by_cid[a.cid()],a.has("id")&&delete this.__models_by_id[a.get("id")]},__hasModel:function(a){return a.cid()in this.__model_by_cid},__modelCreate:function(a){return this.__hasModel(a)?!1:this.__enterModel(a)&&(!this.__options.auto_create||a.save())},__modelDestroy:function(a){if(!this.__hasModel(a))return!0;var b=a.save();return this.__leaveModel(a)&&b},__modelRemove:function(a){if(!this.__hasModel(a))return!1;var b=this.__store.remove(a.get("id"));return b&&this.trigger("remove",a),this.__leaveModel(a)&&b},__modelSetAttr:function(a,b,c){return this.__models_changed[a.cid()]=a,this.trigger("change",a,b,c),this.trigger("change:"+b,a,c),!this.__options.auto_update_attr||a.save()},__modelUpdate:function(a){return this.trigger("update",a),!this.__options.auto_update||a.save()},__modelSave:function(a){if(a.isSaved())return!0;var b=a.validate();if(!b&&!this.__options.save_invalid&&!this.__options.greedy_save)return!1;var c={};c=this.__options.save_invalid?a.properties_changed():a.properties_changed(!0);var d={},e=a.isNew();if(e){if(this.__options.type_column&&(c[this.__options.type_column]=a.cls.classname),d=this.__store.insert(c),!("id"in d))return!1;this.__models_by_id[d.id]=a}else if(!BetaJS.Types.is_empty(c)&&(d=this.__store.update(a.get("id"),c),BetaJS.Types.is_empty(d)))return!1;if(!this.__options.save_invalid)for(var f in a.properties_changed(!1))delete d[f];a.__leaveTable(),a.setAll(d),a.__enterTable();for(var f in d)a.__unsetChanged(f);return b&&delete this.__models_changed[a.cid()],e&&this.trigger("create",a),this.trigger("save",a),this.__options.save_invalid||b},save:function(){var a=!0;return BetaJS.Objs.iter(this.__models_changed,function(b){a=b.save()&&a}),a}}]),BetaJS.Modelling.Associations={},BetaJS.Modelling.Associations.Association=BetaJS.Class.extend("Assocation",{}),BetaJS.Modelling.Associations.HasManyAssociation=BetaJS.Modelling.Associations.Association.extend("HasManyAssocation",{}),BetaJS.Modelling.Validators={},BetaJS.Modelling.Validators.Validator=BetaJS.Class.extend("Validator",{validate:function(){return null}}),BetaJS.Modelling.Validators.PresentValidator=BetaJS.Modelling.Validators.Validator.extend("PresentValidator",{constructor:function(a){this._inherited(BetaJS.Modelling.Validators.PresentValidator,"constructor"),this.__error_string=a?a:"Field is required"},validate:function(a){return BetaJS.Types.is_null(a)?this.__error_string:null}});