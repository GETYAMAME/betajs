/*! betajs - v0.0.1 - 2013-08-14, Copyright (c) Oliver Friedmann & Victor Lingenthal, MIT Software License. */BetaJS.Net.HttpHeader={HTTP_STATUS_OK:200,HTTP_STATUS_CREATED:201,HTTP_STATUS_PAYMENT_REQUIRED:402,HTTP_STATUS_FORBIDDEN:403,HTTP_STATUS_NOT_FOUND:404,HTTP_STATUS_PRECONDITION_FAILED:412,HTTP_STATUS_INTERNAL_SERVER_ERROR:500,format:function(t,e){var i="";return i=t==this.HTTP_STATUS_OK?"OK":t==this.HTTP.STATUS_CREATED?"Created":t==this.HTTP_STATUS_PAYMENT_REQUIRED?"Payment Required":t==this.HTTP_STATUS_FORBIDDEN?"Forbidden":t==this.HTTP_STATUS_NOT_FOUND?"Not found":t==this.HTTP_STATUS_PRECONDITION_FAILED?"Precondition Failed":t==this.HTTP_STATUS_INTERNAL_SERVER_ERROR?"Internal Server Error":"Other Error",e?t+" "+i:i}},BetaJS.Modelling=BetaJS.Modelling||{},BetaJS.Modelling.SchemedProperties=BetaJS.Properties.Properties.extend("SchemedProperties",{constructor:function(t,e){this._inherited(BetaJS.Modelling.SchemedProperties,"constructor");var i=this.cls.scheme();this._properties_changed={},this.__errors={},this.__unvalidated={};for(var n in i)"def"in i[n]?this.set(n,i[n].def):i[n].auto_create?this.set(n,i[n].auto_create(this)):this.set(n,null);e=e||{},this._properties_changed={},this.__errors={},this.__unvalidated={};for(n in t)this.set(n,t[n])},_unsetChanged:function(t){delete this._properties_changed[t]},_afterSet:function(t,e){var i=this.cls.scheme();t in i&&(this._properties_changed[t]=e,this.__unvalidated[t]=!0,delete this.__errors[t])},properties_changed:function(t){return BetaJS.Types.is_boolean(t)?BetaJS.Objs.filter(this._properties_changed,function(e,i){return this.validateAttr(i)==t},this):this._properties_changed},properties_by:function(t){return BetaJS.Types.is_boolean(t)?BetaJS.Objs.filter(this.getAll(),function(e,i){return this.validateAttr(i)==t},this):this.getAll()},validate:function(){this.trigger("validate");for(key in this.__unvalidated)this.validateAttr(key);return BetaJS.Types.is_empty(this.__errors)},validateAttr:function(t){if(t in this.__unvalidated){delete this.__unvalidated[t],delete this.__errors[t];var e=this.cls.scheme(),i=e[t];if("validate"in i){var n=i.validate;BetaJS.Types.is_array(n)||(n=[n]);var r=this.get(t);BetaJS.Objs.iter(n,function(e){var i=e.validate(r,this);return null!=i&&(this.__errors[t]=i),null==i},this)}this.trigger("validate:"+t,!(t in this.__errors),this.__errors[t])}return!(t in this.__errors)},setError:function(t,e){delete this.__unvalidated[t],this.__errors[t]=e},revalidate:function(){return this.__errors={},this.__unvalidated=this.keys(!0),this.validate()},errors:function(){return this.__errors},asRecord:function(t){var e={},i=this.cls.scheme(),n=this.getAll();t=t||{};for(var r in n)if(r in i){var s=i[r].tags||[],_={};BetaJS.Objs.iter(s,function(t){_[t]=!0});var o=!0;BetaJS.Objs.iter(t,function(t){o=o&&t in _},this),o&&(e[r]=n[r])}return e},setByTags:function(t,e){var i=this.cls.scheme();e=e||{};for(var n in t)if(n in i){var r=i[n].tags||[],s={};BetaJS.Objs.iter(r,function(t){s[t]=!0});var _=!0;BetaJS.Objs.iter(e,function(t){_=_&&t in s},this),_&&this.set(n,t[n])}}},{_initializeScheme:function(){var t={};return t[this.primary_key()]={type:"id"},t},asRecords:function(t,e){return t.map(function(t){return t.asRecord(e)})}},{scheme:function(){return this.__scheme=this.__scheme||this._initializeScheme(),this.__scheme}}),BetaJS.Modelling.AssociatedProperties=BetaJS.Modelling.SchemedProperties.extend("AssociatedProperties",{constructor:function(t,e){this._inherited(BetaJS.Modelling.AssociatedProperties,"constructor",t,e),this.assocs=this._initializeAssociations();for(var i in this.assocs)this.__addAssoc(i,this.assocs[i]);this.on("change:"+this.cls.primary_key(),function(t,e){this._change_id(t,e),this.trigger("change_id",t,e)},this)},_change_id:function(){},__addAssoc:function(t,e){this[t]=function(){return e.yield()}},_initializeAssociations:function(){return{}},destroy:function(){for(var t in this.assocs)this.assocs[t].destroy();this._inherited(BetaJS.Modelling.AssociatedProperties,"destroy")},id:function(){return this.get(this.cls.primary_key())},hasId:function(){return this.has(this.cls.primary_key())}},{primary_key:function(){return"id"}}),BetaJS.Modelling.Model=BetaJS.Modelling.AssociatedProperties.extend("Model",[BetaJS.Ids.ClientIdMixin,BetaJS.Classes.AutoDestroyMixin,{constructor:function(t,e){this._inherited(BetaJS.Modelling.Model,"constructor",t,e),this.__saved="saved"in e?e.saved:!1,this.__new="new"in e?e["new"]:!0,this.__removed=!1,this.__saved&&(this._properties_changed={}),this.__table=e.table,this.__table._model_register(this)},destroy:function(){this.__table._model_unregister(this),this.trigger("destroy"),this._inherited(BetaJS.Modelling.Model,"destroy")},isSaved:function(){return this.__saved},isNew:function(){return this.__new},isRemoved:function(){return this.__removed},update:function(t,e){this.setAll(t,{silent:!0}),this.save(e)},_afterSet:function(t,e,i,n){this._inherited(BetaJS.Modelling.Model,"_afterSet",t,e,i,n);var r=this.cls.scheme();t in r&&(n&&n.no_change?this._unsetChanged(t):this.__saved=!1,n&&n.silent||this.__table&&this.__table._model_set_value(this,t,e,n))},_after_create:function(){},save:function(t){var e=this,i=BetaJS.Objs.clone(t||{},1);return i.success=function(){e.trigger("save"),e.__saved=!0;var i=e.__new;e.__new=!1,i&&e._after_create(),t&&t.success&&t.success()},this.__table._model_save(this,i)},remove:function(t){var e=this,i=BetaJS.Objs.clone(t||{},1);return i.success=function(){e.trigger("remove"),e.__removed=!0,t&&t.success&&t.success()},this.__table._model_remove(this,i)}}]),BetaJS.Modelling.ModelException=BetaJS.Exceptions.Exception.extend("ModelException",{constructor:function(t,e){this._inherited(BetaJS.Modelling.ModelException,"constructor",e),this.__model=t},model:function(){return this.__model}}),BetaJS.Modelling.ModelInvalidException=BetaJS.Modelling.ModelException.extend("ModelInvalidException",{constructor:function(t){var e=BetaJS.Objs.values(t.errors()).join("\n");this._inherited(BetaJS.Modelling.ModelInvalidException,"constructor",t,e)}}),BetaJS.Modelling.ModelMissingIdException=BetaJS.Modelling.ModelException.extend("ModelMissingIdException",{constructor:function(t){this._inherited(BetaJS.Modelling.ModelMissingIdException,"constructor",t,"No id given.")}}),BetaJS.Modelling.Table=BetaJS.Class.extend("Table",[BetaJS.Events.EventsMixin,{constructor:function(t,e,i){this._inherited(BetaJS.Modelling.Table,"constructor"),this.__store=t,this.__model_type=e,this.__models_by_id={},this.__models_by_cid={},this.__models_changed={},this.__options=BetaJS.Objs.extend({type_column:null,remove_exception:!0,auto_create:!1,create_exception:!0,invalid_create_exception:!0,invalid_create_save:!1,greedy_create:!1,store_validation_conversion:!0,auto_update:!0,update_exception:!0,invalid_update_exception:!0,invalid_update_save:!1,greedy_update:!1},i||{})},async_read:function(){return this.__store.async_read()},async_write:function(){return this.__store.async_write()},_model_register:function(t){this.hasModel(t)||(this.trigger("register",t),this.__models_by_cid[t.cid()]=t,t.hasId()&&(this.__models_by_id[t.id()]=t),t.isNew()&&this.__options.auto_create&&this._model_create(t))},_model_unregister:function(t){this.hasModel(t)&&(t.save(),delete this.__models_by_cid[t.cid()],t.hasId()&&delete this.__models_by_id[t.id()],this.trigger("unregister",t))},hasModel:function(t){return t.cid()in this.__models_by_cid},_model_remove:function(t,e){if(!this.hasModel(t))return!1;var i=this,n={success:function(){return e&&e.success&&e.success(),e&&e.complete&&e.complete(),i.trigger("remove",t),t.destroy(),!0},exception:function(t){if(e&&e.exception&&e.exception(t),e&&e.complete&&e.complete(),(!e||!e.exception)&&i.__options.remove_exception)throw t;return!1}};if(this.async_write())this.__store.remove(t.id(),n);else try{return this.__store.remove(t.id()),n.success()}catch(r){return n.exception(r)}},_model_save:function(t,e){return t.isNew()?this._model_create(t,e):this._model_update(t,e)},__exception_conversion:function(t,e){if(this.__options.store_validation_conversion&&e.instance_of(BetaJS.Stores.RemoteStoreException)){var i=e.source();i.status_code()==BetaJS.Net.HttpHeader.HTTP_STATUS_PRECONDITION_FAILED&&i.data()&&(BetaJS.Objs.iter(i.data(),function(e,i){t.setError(i,e)},this),e=new BetaJS.Modelling.ModelInvalidException(t))}return e},_model_create:function(t,e){if(!this.hasModel(t)||!t.isNew())return!1;var i=this,n=t.validate();if(!n){var r=new BetaJS.Modelling.ModelInvalidException(t);if(e&&e.exception&&e.exception(r),e&&e.complete&&e.complete(),(!e||!e.exception)&&i.__options.invalid_create_exception)throw r;if(!this.__options.invalid_create_save)return!1}var s=this.__options.greedy_create?t.properties_by(!0):t.getAll();this.__options.type_column&&(s[this.__options.type_column]=t.cls.classname);var _={success:function(r){if(!(t.cls.primary_key()in r))return _.exception(new BetaJS.Modelling.ModelMissingIdException(t));if(i.__models_by_id[r[t.cls.primary_key()]]=t,!i.__options.greedy_create)for(var s in t.properties_by(!1))delete r[s];return t.setAll(r,{no_change:!0,silent:!0}),n&&delete i.__models_changed[t.cid()],i.trigger("create",t),i.trigger("save",t),e&&e.success&&e.success(r),e&&e.complete&&e.complete(),!0},exception:function(n){if(n=BetaJS.Exceptions.ensure(n),n=i.__exception_conversion(t,n),e&&e.exception&&e.exception(n),e&&e.complete&&e.complete(),(!e||!e.exception)&&i.__options.create_exception)throw n;return!1}};if(this.async_write())this.__store.insert(s,_);else try{var o=this.__store.insert(s);return _.success(o)}catch(r){return _.exception(r)}},_model_update:function(t,e){if(!this.hasModel(t)||t.isNew())return!1;var i=this,n=t.validate();if(!n){var r=new BetaJS.Modelling.ModelInvalidException(t);if(e&&e.exception&&e.exception(r),e&&e.complete&&e.complete(),(!e||!e.exception)&&i.__options.invalid_update_exception)throw r;if(!this.__options.invalid_update_save)return!1}var s=this.__options.greedy_update?t.properties_changed(!0):t.properties_changed(),_={success:function(r){if(!i.__options.greedy_update)for(var s in t.properties_changed(!1))delete r[s];return t.setAll(r,{no_change:!0,silent:!0}),n&&delete i.__models_changed[t.cid()],i.trigger("update",t),i.trigger("save",t),e&&e.success&&e.success(r),e&&e.complete&&e.complete(),!0},exception:function(t){if(e&&e.exception&&e.exception(t),e&&e.complete&&e.complete(),(!e||!e.exception)&&i.__options.update_exception)throw t;return!1}};if(this.async_write()&&!BetaJS.Types.is_empty(s))this.__store.update(t.id(),s,_);else try{var o=BetaJS.Types.is_empty(s)?{}:this.__store.update(t.id(),s);return _.success(o)}catch(r){return _.exception(r)}},_model_set_value:function(t,e,i,n){return this.__models_changed[t.cid()]=t,this.trigger("change",t,e,i),this.trigger("change:"+e,t,i),this.__options.auto_update?t.save(n):void 0},save:function(){var t=!0;return BetaJS.Objs.iter(this.__models_changed,function(e){t=e.save()&&t}),t},__materialize:function(t){if(!t)return null;var e=this.__model_type;this.__options.type_column&&t[this.__options.type_column]&&(e=t[this.__options.type_column]);var i=BetaJS.Scopes.resolve(e);if(this.__models_by_id[t[i.primary_key()]])return this.__models_by_id[t[i.primary_key()]];var n=new i(t,{table:this,saved:!0,"new":!1});return n},findById:function(t){return this.__models_by_id[t]?this.__models_by_id[t]:this.__materialize(this.__store.get(t))},findBy:function(t){return this.allBy(t,{limit:1}).next()},all:function(t){return this.allBy({},t)},allBy:function(t,e){var i=this.__store.query(t,e),n=this,r=new BetaJS.Iterators.MappedIterator(i,function(t){return n.__materialize(t)});return r},active_query_engine:function(){if(!this._active_query_engine){var t=this;this._active_query_engine=new BetaJS.Queries.ActiveQueryEngine,this._active_query_engine._query=function(e){return t.allBy(e)},this.on("create",function(t){this._active_query_engine.insert(t)}),this.on("remove",function(t){this._active_query_engine.remove(t)}),this.on("change",function(t){this._active_query_engine.update(t)})}return this._active_query_engine}}]),BetaJS.Modelling.Associations={},BetaJS.Modelling.Associations.Association=BetaJS.Class.extend("Assocation",{constructor:function(t,e){this._inherited(BetaJS.Modelling.Associations.Association,"constructor"),this._model=t,this._options=e||{},this.__cache=null,e.delete_cascade&&t.on("remove",function(){this.__delete_cascade()},this),e.ignore_change_id||t.on("change_id",function(t,e){this._change_id(t,e)},this)},_change_id:function(){},__delete_cascade:function(){for(var t=BetaJS.Iterators.ensure(this.yield());t.hasNext();)t.next().remove()},yield:function(){if(this.__cache)return this.__cache;var t=this._yield();return this._options.cached&&(this.__cache=t),t},invalidate:function(){delete this.__cache}}),BetaJS.Modelling.Associations.TableAssociation=BetaJS.Modelling.Associations.Association.extend("TableAssociation",{constructor:function(t,e,i,n){this._inherited(BetaJS.Modelling.Associations.TableAssociation,"constructor",t,n),this._foreign_table=e,this._foreign_key=i,this._options.cached&&this._foreign_table.on("create update remove",function(){this.invalidate()},this)},destroy:function(){this._foreign_table.off(null,null,this),this._inherited(BetaJS.Modelling.Associations.TableAssociation,"destroy")}}),BetaJS.Modelling.Associations.HasManyAssociation=BetaJS.Modelling.Associations.TableAssociation.extend("HasManyAssocation",{_yield:function(){var t={};return t[this._foreign_key]=this._model.id(),this._foreign_table.allBy(t)},yield:function(){return this._options.cached?(this.__cache||(this.__cache=this._yield().asArray()),new BetaJS.Iterators.ArrayIterator(this.__cache)):this._yield()},findBy:function(t){return t[this._foreign_key]=this._model.id(),this._foreign_table.findBy(t)},allBy:function(t){return t[this._foreign_key]=this._model.id(),this._foreign_table.allBy(t)},_change_id:function(t){for(var e=this._yield();e.hasNext();){var i=e.next();i.set(this._foreign_key,t),i.save()}}}),BetaJS.Modelling.Associations.HasManyThroughArrayAssociation=BetaJS.Modelling.Associations.HasManyAssociation.extend("HasManyThroughArrayAssociation",{_yield:function(){var t=[];return BetaJS.Objs.iter(this._model.get(this._foreign_key),function(e){var i=this._foreign_table.findById(e);i&&t.push(i)},this),t},yield:function(){return this._options.cached?(this.__cache||(this.__cache=this._yield()),new BetaJS.Iterators.ArrayIterator(this.__cache)):new BetaJS.Iterators.ArrayIterator(this._yield())}}),BetaJS.Modelling.Associations.HasOneAssociation=BetaJS.Modelling.Associations.TableAssociation.extend("HasOneAssocation",{_yield:function(t){var e={};return e[this._foreign_key]=t||this._model.id(),this._foreign_table.findBy(e)},_change_id:function(t,e){var i=this._yield(e);i&&(i.set(this._foreign_key,t),i.save())}}),BetaJS.Modelling.Associations.BelongsToAssociation=BetaJS.Modelling.Associations.TableAssociation.extend("BelongsToAssocation",{_yield:function(){return this._foreign_table.findById(this._model.get(this._foreign_key))}}),BetaJS.Modelling.Validators={},BetaJS.Modelling.Validators.Validator=BetaJS.Class.extend("Validator",{validate:function(){return null}}),BetaJS.Modelling.Validators.PresentValidator=BetaJS.Modelling.Validators.Validator.extend("PresentValidator",{constructor:function(t){this._inherited(BetaJS.Modelling.Validators.PresentValidator,"constructor"),this.__error_string=t?t:"Field is required"},validate:function(t){return BetaJS.Types.is_null(t)?this.__error_string:null}});