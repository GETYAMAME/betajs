/*! betajs - v0.0.1 - 2013-04-12, Copyright (c) Oliver Friedmann & Victor Lingenthal, MIT Software License. */BetaJS.Templates={tokenize:function(t){if(BetaJS.Types.is_array(t))return t;var e=[],i=0;return t.replace(BetaJS.Templates.SYNTAX_REGEX(),function(n,s,r,_,a){return a>i&&e.push({type:BetaJS.Templates.TOKEN_STRING,data:BetaJS.Strings.js_escape(t.slice(i,a))}),_&&e.push({type:BetaJS.Templates.TOKEN_CODE,data:_}),s&&e.push({type:BetaJS.Templates.TOKEN_EXPR,data:s}),r&&e.push({type:BetaJS.Templates.TOKEN_ESC,data:r}),i=a+n.length,n}),e},compile:function(t,e){BetaJS.Types.is_string(t)&&(t=this.tokenize(t)),e=e||{};for(var i=e.start_index||0,n=e.end_index||t.length,s="__p+='",r=i;n>r;++r)switch(t[r].type){case BetaJS.Templates.TOKEN_STRING:s+=t[r].data;break;case BetaJS.Templates.TOKEN_CODE:s+="';\n"+t[r].data+"\n__p+='";break;case BetaJS.Templates.TOKEN_EXPR:s+="'+\n((__t=("+t[r].data+"))==null?'':__t)+\n'";break;case BetaJS.Templates.TOKEN_ESC:s+="'+\n((__t=("+t[r].data+"))==null?'':BetaJS.Strings.htmlentities(__t))+\n'"}s+="';\n",s="with(obj||{}){\n"+s+"}\n",s="var __t,__p='',__j=Array.prototype.join,echo=function(){__p+=__j.call(arguments,'');};\n"+s+"return __p;\n";var _=Function("obj",s),a=function(t){return _.call(this,t)};return a.source="function(obj){\n"+s+"}",a}},BetaJS.Templates.SYNTAX={OPEN:"{%",CLOSE:"%}",MODIFIER_CODE:"",MODIFIER_EXPR:"=",MODIFIER_ESC:"-"},BetaJS.Templates.SYNTAX_REGEX=function(){var t=BetaJS.Templates.SYNTAX;return BetaJS.Templates.SYNTAX_REGEX_CACHED||(BetaJS.Templates.SYNTAX_REGEX_CACHED=RegExp(t.OPEN+t.MODIFIER_EXPR+"([\\s\\S]+?)"+t.CLOSE+"|"+t.OPEN+t.MODIFIER_ESC+"([\\s\\S]+?)"+t.CLOSE+"|"+t.OPEN+t.MODIFIER_CODE+"([\\s\\S]+?)"+t.CLOSE+"|"+"$","g")),BetaJS.Templates.SYNTAX_REGEX_CACHED},BetaJS.Templates.TOKEN_STRING=1,BetaJS.Templates.TOKEN_CODE=2,BetaJS.Templates.TOKEN_EXPR=3,BetaJS.Templates.TOKEN_ESC=4,BetaJS.Templates=BetaJS.Templates||{},BetaJS.Templates.Template=BetaJS.Class.extend("Template",{constructor:function(t){this._inherited(BetaJS.Templates.Template,"constructor"),this.__tokens=BetaJS.Templates.tokenize(t),this.__compiled=BetaJS.Templates.compile(this.__tokens)},evaluate:function(t){return this.__compiled.apply(this,[t])}},{bySelector:function(t){return new this($(t).html())}}),BetaJS.Views=BetaJS.Views||{},BetaJS.Views.View=BetaJS.Class.extend("View",[BetaJS.Events.EventsMixin,BetaJS.Events.ListenMixin,BetaJS.Ids.ClientIdMixin,BetaJS.Properties.BindablePropertiesMixin,{_templates:function(){return{}},_dynamics:function(){return{}},_events:function(){return[]},_css:function(){return{}},css:function(t){if(this.__css[t])return this.__css[t];if(this.__parent){var e=this.__parent.css(t);if(e)return e}var e=this._css();return e[t]?e[t]:null},_render:function(){this.__render_string?this.$el.html(this.__render_string):this.__templates["default"]?this.$el.html(this.evaluateTemplate("default",{})):this.__dynamics["default"]&&this.evaluateDynamics("default",this.$el,{},{name:"default"})},templates:function(t){return this.__templates[t]},_supp:function(){return{__context:this,css:function(t){return this.__context.css(t)},attrs:function(t){var e="";for(var i in t)e+=(null==t[i]?i:i+"='"+t[i]+"'")+" ";return e},selector:function(t){return"data-selector='"+t+"' "}}},templateArguments:function(){var t=this.getAll();return t.supp=this._supp(),t},evaluateTemplate:function(t,e){return this.__templates[t].evaluate(BetaJS.Objs.extend(e,this.templateArguments()))},evaluateDynamics:function(t,e,i,n){this.__dynamics[t].renderInstance(e,BetaJS.Objs.extend(n||{},i||{}))},dynamics:function(t){return this.__dynamics[t]},_setOption:function(t,e,i,n){var n=n?n:"__";this[n+e]=e in t?t[e]:i},_setOptionProperty:function(t,e,i){this.set(e,e in t?t[e]:i)},constructor:function(t){this._inherited(BetaJS.Views.View,"constructor"),this._setOption(t,"el",null),this._setOption(t,"visible",!0),this._setOption(t,"render_string",null),this._setOption(t,"events",[]),this._setOption(t,"attributes",{}),this.__old_attributes={},this._setOption(t,"css_classes",[]),this.__added_css_classes=[],this._setOption(t,"css_styles",{}),this.__old_css_styles={},this._setOption(t,"css",{}),this.__parent=null,this.__children={},this.__active=!1,this.$el=null,this.__events=this._events().concat(this.__events);var e=BetaJS.Objs.extend(BetaJS.Types.is_function(this._templates)?this._templates():this._templates,t.templates||{});"template"in t&&(e["default"]=t.template),this.__templates={};for(var i in e)this.__templates[i]=new BetaJS.Templates.Template(BetaJS.Types.is_string(e[i])?e[i]:e[i].html());var n=BetaJS.Objs.extend(BetaJS.Types.is_function(this._dynamics)?this._dynamics():this._dynamics,t.dynamics||{});"dynamic"in t&&(n["default"]=t.dynamic),this.__dynamics={};for(var i in n)this.__dynamics[i]=new BetaJS.Views.DynamicTemplate(this,BetaJS.Types.is_string(n[i])?n[i]:n[i].html());this.setAll(t.properties||{})},isActive:function(){return this.__active},activate:function(){if(this.isActive())return!0;if(!this.__el)return!1;if(this.__parent&&!this.__parent.isActive())return!1;if(this.$el=this.__parent?this.__parent.$(this.__el):$(this.__el),0==this.$el.size()&&(this.$el=null),!this.$el)return!1;this.__old_attributes={};for(var t in this.__attributes){var e=this.$el.attr(t);this.__old_attributes[t]=BetaJS.Types.is_defined(e)?e:null,this.$el.attr(t,this.__attributes[t])}this.__added_css_classes=[];for(var i;this.__css_classes>i;++i)this.$el.hasClass(this.__css_classes[i])||(this.$el.addClass(this.__css_classes[i]),this.__added_css_classes.push(this.__css_classes[i]));this.__old_css_styles={};for(var t in this.__css_styles){var e=this.$el.css(t);this.__old_css_styles[t]=BetaJS.Types.is_defined(e)?e:null,this.$el.css(t,this.__css_styles[t])}return this.__bind(),this.$el.css("display",this.__visible?"":"none"),this.__active=!0,this.__render(),BetaJS.Objs.iter(this.__children,function(t){t.activate()}),!0},deactivate:function(){if(!this.isActive())return!1;BetaJS.Objs.iter(this.__children,function(t){t.deactivate()}),this.__active=!1,BetaJS.Objs.iter(this.__dynamics,function(t){t.reset()},this),this.__unbind(),this.$el.html("");for(var t in this.__old_attributes)this.$el.attr(t,this.__old_attributes[t]);for(var e;this.__added_css_classes>e;++e)this.$el.removeClass(this.__added_css_classes[e]);for(var t in this.__old_css_styles)this.$el.css(t,this.__old_css_styles[t]);return this.$el=null,!0},$:function(t){return this.$el.find(t)},$data:function(t,e){return this.$("[data-"+t+"='"+e+"']")},$subdata:function(t,e){var i="";for(var n in e)i+="[data-"+n+"='"+e[n]+"']";return t.find(i)},destroy:function(){this.deactivate(),BetaJS.Objs.iter(this.__children,function(t){t.destroy()}),BetaJS.Objs.iter(this.__dynamics,function(t){t.destroy()},this),BetaJS.Objs.iter(this.__templates,function(t){t.destroy()},this),this._inherited(BetaJS.Views.View,"destroy")},show:function(){this.setVisibility(!0)},hide:function(){this.setVisibility(!1)},setVisibility:function(t){t!=this.__visible&&(this.__visible=t,this.isActive()&&this.$el.css("display",this.__visible?"":"none"))},__bind:function(){var t=this;this.__unbind(),BetaJS.Objs.iter(this.__events,function(e){BetaJS.Objs.iter(e,function(e,i){var n=t[e],s=i.match(BetaJS.Views.BIND_EVENT_SPLITTER),r=s[1],_=s[2];r=r+".events"+t.cid();var a=BetaJS.Functions.as_method(n,t);""===_?t.$el.on(r,a):t.$el.on(r,_,a)})})},__unbind:function(){this.$el.off(".events"+this.cid())},__render:function(){this.isActive()&&this._render()},invalidate:function(){this.isActive()&&(BetaJS.Objs.iter(this.__children,function(t){t.deactivate()}),BetaJS.Objs.iter(this.__dynamics,function(t){t.reset()},this),this.__render(),BetaJS.Objs.iter(this.__children,function(t){t.activate()}))},setEl:function(t){this.isActive()?(this.deactivate(),this.__el=t,this.activate()):this.__el=t},getParent:function(){return this.__parent},hasChild:function(t){return t&&t.cid()in this.__children},setParent:function(t){if(t!=this.__parent){if(this.deactivate(),this.__parent){var e=this.__parent;this.__parent=null,e.removeChild(this)}t&&(this.__parent=t,t.addChild(this),t.isActive()&&this.activate())}},children:function(){return BetaJS.Objs.values(this.__children)},addChildren:function(t){BetaJS.Objs.iter(t,function(t){this.addChild(t)},this)},addChild:function(t){return this.hasChild(t)?null:(this.__children[t.cid()]=t,this._notify("addChild",t),t.setParent(this),t)},removeChildren:function(t){BetaJS.Objs.iter(t,function(t){this.removeChild(t)},this)},removeChild:function(t){this.hasChild(t)&&(delete this.__children[t.cid()],t.setParent(null),this._notify("removeChild",t))}}]),BetaJS.Views.BIND_EVENT_SPLITTER=/^(\S+)\s*(.*)$/,BetaJS.Views.DynamicTemplate=BetaJS.Class.extend("DynamicTemplate",{constructor:function(t,e){this._inherited(BetaJS.Views.DynamicTemplate,"constructor"),this.__parent=t,this.__template=new BetaJS.Templates.Template(e),this.__instances={},this.__instances_by_name={}},reset:function(){BetaJS.Objs.iter(this.__instances,function(t){this.removeInstance(t)},this)},destroy:function(){this.reset(),this._inherited(BetaJS.Views.DynamicTemplate,"destroy")},renderInstance:function(t,e){e=e||{},e.name&&this.removeInstanceByName(e.name);var i=new BetaJS.Views.DynamicTemplateInstance(this,t,e);this.__instances[i.cid()]=i,e.name&&(this.__instances_by_name[name]=i)},removeInstanceByName:function(t){this.__instances_by_name[t]&&this.removeInstance(this.__instances_by_name[t])},removeInstance:function(t){delete this.__instances[t.cid()],delete this.__instances_by_name[t.name()],t.destroy()},view:function(){return this.__parent},template:function(){return this.__template}}),BetaJS.Views.DynamicTemplateInstance=BetaJS.Class.extend("DynamicTemplateInstance",[BetaJS.Ids.ClientIdMixin,BetaJS.Events.ListenMixin,{__bind:{attr:function(t,e){return this.__context.__bind_attribute(t,e)},attrs:function(t){var e="";for(attribute in t)e+=this.attr(attribute,t[attribute])+" ";return e},value:function(t){return this.__context.__bind_value(t)},inner:function(t){return this.__context.__bind_inner(t)}},__new_element:function(t){var e=BetaJS.Ids.uniqueId();return this.__elements[e]=BetaJS.Objs.extend({id:e,$el:null},t),this.__elements[e]},__decompose_variable:function(t){var e=t.split(".");return{object:1==e.length?this.__parent.view():this.__args[e[0]],key:1==e.length?t:e[1]}},__get_variable:function(t){var e=this.__decompose_variable(t);return e.object.get(e.key)},__set_variable:function(t,e){var i=this.__decompose_variable(t);return i.object.set(i.key,e)},__update_element:function(t){var e=this.__get_variable(t.variable);"inner"==t.type?t.$el.html(e):"value"==t.type?t.$el.val(e):"attribute"==t.type&&t.$el.attr(t.attribute,e)},__prepare_element:function(t){var e=this;t.$el=this.$el.find(t.selector),"inner"==t.type?this.__update_element(t):"value"==t.type&&t.$el.on("change input keyup paste",function(){e.__set_variable(t.variable,t.$el.val())})},__bind_attribute:function(t,e){var i=this.__new_element({type:"attribute",attribute:t,variable:e}),n="data-bind-"+t+"='"+i.id+"'";i.selector="["+n+"]";var s=this.__decompose_variable(e);return this.listenOn(s.object,"change:"+s.key,function(){this.__update_element(i)},this),n+" "+t+"='"+s.object.get(s.key)+"'"},__bind_value:function(t){var e=this.__new_element({type:"value",variable:t}),i="data-bind-value='"+e.id+"'";e.selector="["+i+"]";var n=this.__decompose_variable(t);return this.listenOn(n.object,"change:"+n.key,function(){this.__update_element(e)},this),i+" value='"+n.object.get(n.key)+"'"},__bind_inner:function(t){var e=this.__new_element({type:"inner",variable:t}),i="data-bind-inner='"+e.id+"'";e.selector="["+i+"]";var n=this.__decompose_variable(t);return this.listenOn(n.object,"change:"+n.key,function(){this.__update_element(e)},this),i},constructor:function(t,e,i){this._inherited(BetaJS.Views.DynamicTemplateInstance,"constructor"),this.__elements={},this.__inners={},i=i||{},i.name&&(this.__name=name),this.__parent=t,this.$el=e,this.__args=BetaJS.Objs.extend(i.args||{},this.__parent.view().templateArguments()),this.__args.bind=BetaJS.Objs.extend({__context:this},this.__bind),this.$el.html(t.template().evaluate(this.__args)),BetaJS.Objs.iter(this.__elements,function(t){this.__prepare_element(t)},this)},destroy:function(){BetaJS.Objs.iter(this.__elements,function(t){t.$el.off()},this),this._inherited(BetaJS.Views.DynamicTemplateInstance,"destroy")}}]),BetaJS.Templates.Cached=BetaJS.Templates.Cached||{},BetaJS.Templates.Cached["holygrail-view-template"]="<div data-selector=\"right\" class='holygrail-view-right-container'></div><div data-selector=\"left\" class='holygrail-view-left-container'></div><div data-selector=\"center\" class='holygrail-view-center-container'></div>",BetaJS.Templates.Cached["list-container-view-item-template"]='<div data-view-id="{%= cid %}" class="list-container-item"></div>',BetaJS.Templates.Cached["button-view-template"]='<button class="button-view" {%= bind.inner("label") %}></button>',BetaJS.Templates.Cached["input-view-template"]='<input class="input-view" {%= bind.value("value") %} {%= bind.attr("placeholder", "placeholder") %} />',BetaJS.Templates.Cached["label-view-template"]='<label class="label-view" {%= bind.inner("label") %}></label>',BetaJS.Templates.Cached["text-area-template"]='<textarea class="text-area-view" {%= bind.value("value") %} {%= bind.attr("placeholder", "placeholder") %}></textarea>',BetaJS.Templates.Cached["list-view-template"]='<{%= list_container_element %} {%= supp.attrs(list_container_attrs) %} data-selector="list"></{%= list_container_element %}>',BetaJS.Templates.Cached["list-view-item-container-template"]="<{%= item_container_element %} {%= supp.attrs(item_container_attrs) %} {%= supp.list_item_attr(item) %}></{%= item_container_element %}>",BetaJS.Templates.Cached["list-view-item-template"]="{%= item.get(item_label) %}",BetaJS.Views.HolygrailView=BetaJS.Views.View.extend("HolygrailView",{_templates:{"default":BetaJS.Templates.Cached["holygrail-view-template"]},constructor:function(t){this._inherited(BetaJS.Views.HolygrailView,"constructor",t),this.__left=null,this.__center=null,this.__right=null},getLeft:function(){return this.__left},setLeft:function(t){this.__setView("left",t)},getCenter:function(){return this.__center},setCenter:function(t){this.__setView("center",t)},getRight:function(){return this.__right},setRight:function(t){this.__setView("right",t)},__setView:function(t,e){this.removeChild(this["__"+t]),this["__"+t]=null,e&&(e.setEl('[data-selector="'+t+'"]'),this["__"+t]=this.addChild(e))}}),BetaJS.Views.ListContainerView=BetaJS.Views.View.extend("ListContainerView",{_templates:{item:BetaJS.Templates.Cached["list-container-view-item-template"]},_notifications:{addChild:"__addChildContainer",removeChild:"__removeChildContainer"},_render:function(){this.$el.html(""),BetaJS.Objs.iter(this.children(),function(t){this.__addChildContainer(t)},this)},__addChildContainer:function(t){this.isActive()&&this.$el.append(this.evaluateTemplate("item",{cid:t.cid()})),t.setEl("[data-view-id='"+t.cid()+"']")},__removeChildContainer:function(t){this.$data("view-id",t.cid()).remove()}}),BetaJS.Views.ButtonView=BetaJS.Views.View.extend("ButtonView",{_dynamics:{"default":BetaJS.Templates.Cached["button-view-template"]},constructor:function(t){this._inherited(BetaJS.Views.ButtonView,"constructor",t),this._setOptionProperty(t,"label","")},_events:function(){return this._inherited(BetaJS.Views.ButtonView,"_events").concat([{"click button":"__clickButton"}])},__clickButton:function(){this.trigger("clicked")}}),BetaJS.Views.InputView=BetaJS.Views.View.extend("InputView",{_dynamics:{"default":BetaJS.Templates.Cached["input-view-template"]},constructor:function(t){this._inherited(BetaJS.Views.InputView,"constructor",t),this._setOptionProperty(t,"value",""),this._setOptionProperty(t,"placeholder","")}}),BetaJS.Views.LabelView=BetaJS.Views.View.extend("LabelView",{_dynamics:{"default":BetaJS.Templates.Cached["label-view-template"]},constructor:function(t){this._inherited(BetaJS.Views.LabelView,"constructor",t),this._setOptionProperty(t,"label","")}}),BetaJS.Views.TextAreaView=BetaJS.Views.View.extend("TextAreaView",{_dynamics:{"default":BetaJS.Templates.Cached["text-area-template"]},constructor:function(t){this._inherited(BetaJS.Views.TextAreaView,"constructor",t),this._setOptionProperty(t,"value",""),this._setOptionProperty(t,"placeholder","")}}),BetaJS.Views.ListView=BetaJS.Views.View.extend("ListView",{_templates:{"default":BetaJS.Templates.Cached["list-view-template"],"item-container":BetaJS.Templates.Cached["list-view-item-container-template"],item:BetaJS.Templates.Cached["list-view-item-template"]},_supp:function(){return BetaJS.Objs.extend(this._inherited(BetaJS.Views.ListView,"_supp"),{list_item_attr:function(t){return this.attrs({"data-view-id":this.__context.cid(),"data-cid":BetaJS.Ids.objectId(t),"data-index":this.__context.__collection.getIndex(t)})}})},constructor:function(t){this._inherited(BetaJS.Views.ListView,"constructor",t),this._setOption(t,"list_container_element","ul"),this._setOption(t,"list_container_attrs",{}),this._setOption(t,"item_container_element","li"),this._setOption(t,"item_container_attrs",{}),this._setOption(t,"item_label","label"),"collection"in t?(this.__collection=t.collection,this.__destroy_collection=!1):(this.__collection=new BetaJS.Collections.Collection({objects:t.objects,compare:t.compare}),this.__destroy_collection=!0),this.__collection.on("add",function(t){this.__renderAdd(t)},this),this.__collection.on("remove",function(t){this.__renderRemove(t)},this),this.__collection.on("index",function(t,e){this.__renderUpdateIndex(t,e)},this)},destroy:function(){this.__collection.off(null,null,this),this.__destroy_collection&&this.__collection.destroy(),this._inherited(BetaJS.Views.ListView,"destroy")},getCollection:function(){return this.__collection},_render:function(){this.$el.html(this.evaluateTemplate("default",{list_container_element:this.__list_container_element,list_container_attrs:this.__list_container_attrs})),this.$selector_list=this.$data("selector","list");var t=this;this.__collection.iterate(function(e){t.__renderAdd(e)})},__renderAdd:function(t){if(this.isActive()){var e=this.evaluateTemplate("item-container",{item:t,item_container_element:this.__item_container_element,item_container_attrs:this.__item_container_attrs}),i=this.__collection.getIndex(t);if(0==i)this.$selector_list.prepend(e);else{var n=this.__findIndexElement(i-1);if(n.length>0)n.after(e);else{var s=this.__findIndexElement(i+1);s.length>0?s.before(e):this.$selector_list.append(e)}}var r=this.__findItemElement(t);r.html(this.evaluateTemplate("item",{item_label:this.__item_label,item:t}))}},__renderRemove:function(t){this.isActive()&&this.__findItemElement(t).remove()},__renderUpdateIndex:function(t,e){var i=this.__findItemElement(t),n=i.attr("data-index");if(i.attr("data-index",e),!(e+1>=n||n>=e-1))if(0==e)this.$selector_list.prepend(i);else{var s=this.__findIndexElement(e-1);if(s.length>0)s.insertAfter(i);else{var r=this.__findIndexElement(e+1);r.length>0&&r.insertBefore(i)}}},__findItemElement:function(t){return this.$subdata(this.$selector_list,{"view-id":this.cid(),cid:BetaJS.Ids.objectId(t)})},__findIndexElement:function(t){return this.$subdata(this.$selector_list,{"view-id":this.cid(),index:t})},add:function(t){this.__collection.add(t)}});