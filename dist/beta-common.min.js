/*! betajs - v0.0.2 - 2014-06-19, Copyright (c) Oliver Friedmann & Victor Lingenthal, MIT Software License. */var BetaJS=BetaJS||{};"undefined"!=typeof module&&"exports"in module&&(module.exports=BetaJS),BetaJS.Types={is_object:function(a){return"object"==typeof a},is_array:function(a){return"[object Array]"===Object.prototype.toString.call(a)},is_undefined:function(a){return"undefined"==typeof a},is_null:function(a){return null===a},is_none:function(a){return this.is_undefined(a)||this.is_null(a)},is_defined:function(a){return"undefined"!=typeof a},is_empty:function(a){if(this.is_none(a))return!0;if(this.is_array(a))return 0===a.length;if(this.is_object(a)){for(var b in a)return!1;return!0}return!1},is_string:function(a){return"string"==typeof a},is_function:function(a){return"function"==typeof a},is_boolean:function(a){return"boolean"==typeof a},compare:function(a,b){if(BetaJS.Types.is_boolean(a)&&BetaJS.Types.is_boolean(b))return a==b?0:a?1:-1;if(BetaJS.Types.is_array(a)&&BetaJS.Types.is_array(b)){for(var c=a.length,d=b.length,e=Math.min(c,d),f=0;e>f;++f){var g=this.compare(a[f],b[f]);if(0!==g)return g}return c==d?0:c>d?1:-1}return a.localeCompare(b)},parseBool:function(a){return this.is_boolean(a)?a:"true"==a?!0:"false"==a?!1:null},type_of:function(a){return this.is_array(a)?"array":typeof a}},BetaJS.Strings={nl2br:function(a){return(a+"").replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,"$1<br />$2")},htmlentities:function(a){return(a+"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;")},JS_ESCAPES:{"'":"'","\\":"\\","\r":"r","\n":"n","	":"t","\u2028":"u2028","\u2029":"u2029"},JS_ESCAPER_REGEX:function(){return this.JS_ESCAPER_REGEX_CACHED||(this.JS_ESCAPER_REGEX_CACHED=new RegExp(BetaJS.Objs.keys(this.JS_ESCAPES).join("|"),"g")),this.JS_ESCAPER_REGEX_CACHED},js_escape:function(a){var b=this;return a.replace(this.JS_ESCAPER_REGEX(),function(a){return"\\"+b.JS_ESCAPES[a]})},starts_with:function(a,b){return a.substring(0,b.length)==b},ends_with:function(a,b){return-1!==a.indexOf(b,a.length-b.length)},strip_start:function(a,b){return this.starts_with(a,b)?a.substring(b.length):a},last_after:function(a,b){return a.substring(a.lastIndexOf(b)+b.length,a.length)},EMAIL_ADDRESS_REGEX:/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/,is_email_address:function(a){return this.EMAIL_ADDRESS_REGEX.test(a)},STRIP_HTML_TAGS:["script","style","head"],STRIP_HTML_REGEX:/<\/?([a-z][a-z0-9]*)\b[^>]*>?/gi,STRIP_HTML_COMMENT_REGEX:/<![^>]*>/gi,strip_html:function(a){var b=a;for(i=0;i<this.STRIP_HTML_TAGS.length;++i)b=b.replace(new RegExp("<"+this.STRIP_HTML_TAGS[i]+".*</"+this.STRIP_HTML_TAGS[i]+">","i"),"");return b=b.replace(this.STRIP_HTML_REGEX,"").replace(this.STRIP_HTML_COMMENT_REGEX,"")},nltrim:function(a){var b=a.replace(/\t/g,"  ").split("\n"),c=null,d=0;for(d=0;d<b.length;++d){for(var e=0;e<b[d].length&&" "==b[d].charAt(e);)++e;e<b[d].length&&(c=null===c?e:Math.min(e,c))}for(d=0;d<b.length;++d)b[d]=b[d].substring(c);return b.join("\n").trim()},read_cookie_string:function(a,b){var c="; "+a,d=c.split("; "+b+"=");return 2==d.length?d.pop().split(";").shift():null},write_cookie_string:function(a,b,c){var d="; "+a,e=d.split("; "+b+"=");return 2==e.length&&(d=e[0]+e[1].substring(e[1].indexOf(";"))),b+"="+c+d},capitalize:function(a){return a.replace(/\w\S*/g,function(a){return a.charAt(0).toUpperCase()+a.substr(1).toLowerCase()})},email_get_name:function(a){var b=a.split("<");return a=b[0].trim(),!a&&b.length>1&&(b=b[1].split(">"),a=b[0].trim()),a=a.replace(/['"]/g,"").replace(/[\\._@]/g," "),this.capitalize(a)},email_get_email:function(a){var b=a.split("<");return a=b[0].trim(),b.length>1&&(b=b[1].split(">"),a=b[0].trim()),a=a.replace(/'/g,"").replace(/"/g,"").trim()},email_get_salutatory_name:function(a){return this.email_get_name(a).split(" ")[0]}},BetaJS.Functions={as_method:function(a,b){return function(){return a.apply(b,arguments)}},once:function(a){var b=!1,c=!1;return function(){return c?b:(c=!0,b=a.apply(this,arguments),a=null,b)}},getArguments:function(a,b){return Array.prototype.slice.call(a,b||0)},matchArgs:function(a,b){var c=0,d={};for(var e in b)(b[e]===!0||BetaJS.Types.type_of(a[c])==b[e])&&(d[e]=a[c],c++);return d}},BetaJS.SyncAsync={eventually:function(a,b,c){var d=setTimeout(function(){clearTimeout(d),a.apply(c||this,b||[])},0)},syncToAsync:function(a,b){var c=BetaJS.Functions.matchArgs(BetaJS.Functions.getArguments(arguments,2),{params:"array",context:"object"});try{a&&a.success&&a.success.call(a.context||this,b.apply(c.context||this,c.params||[]))}catch(d){a&&a.exception&&a.exception.call(a.context||this,d)}},either:function(a,b,c,d){var e=BetaJS.Functions.matchArgs(BetaJS.Functions.getArguments(arguments,4),{params:"array",context:"object"});if(!a||b||a.sync)return this.eitherSync(a,c,e.params,e.context);var f=e.params||[];return f.push(a),d.apply(e.context||this,f),null},eitherSync:function(a,b){var c=BetaJS.Functions.matchArgs(BetaJS.Functions.getArguments(arguments,2),{params:"array",context:"object"}),d=c.context||this,e=c.params||[];return a?(this.syncToAsync(a,b,e,d),null):b.apply(d,e)},SYNC:1,ASYNC:2,ASYNCSINGLE:3,toCallbackType:function(a,b){return b==this.ASYNCSINGLE?function(b,c){b&&a.exception.call(a.context||this,b),a.success.call(a.context||this,c)}:a},then:function(){var a=BetaJS.Functions.matchArgs(arguments,{func_ctx:"object",func:!0,params:"array",type:"number",callbacks:!0,success_ctx:"object",success:"function",exception:"function"}),b=a.func_ctx||this,c=a.func,d=a.params||[],e=a.callbacks,f=a.type||(!e||e.sync?this.SYNC:this.ASYNC),g=a.success_ctx||b,h=a.success,i=a.exception;if(f!=this.SYNC)d.push(this.toCallbackType({context:e.context,success:h?function(a){h.call(g,a,e)}:e.success,exception:i?function(a){i.call(g,a,e)}:e.exception},f)),c.apply(b,d);else if(e)try{h?h.call(g,c.apply(b,d),e):e.success.call(e.context||this,c.apply(b,d))}catch(j){if(i)i.call(g,j,e);else{if(!e.exception)throw j;e.exception.call(e.context||this,j)}}else try{var k=c.apply(b,d);return h&&h.call(g,k,{sync:!0,success:function(a){k=a},exception:function(a){throw a}}),k}catch(j){if(i)return i.call(g,j,{sync:!0,success:function(a){k=a},exception:function(a){throw a}}),k;throw j}return null},PROMISE_LAZY:1,PROMISE_ACTIVE:2,PROMISE_SUCCESS:3,PROMISE_EXCEPTION:4,lazy:function(){var a=BetaJS.Functions.matchArgs(arguments,{func_ctx:"object",func:!0,params:"array",type:"number"});return{state:this.PROMISE_LAZY,func_ctx:a.func_ctx||this,func:a.func,params:a.params||[],type:a.type||this.ASYNC}},promise:function(){var a=BetaJS.Functions.matchArgs(arguments,{func_ctx:"object",func:!0,params:"array",type:"number"}),b=a.func_ctx||this,c=a.func,d=a.params||[],e=a.type||this.ASYNC;if(e!=this.SYNC){var f={state:this.PROMISE_ACTIVE,listeners:[]};return d.push({context:f,success:function(a){this.state=BetaJS.SyncAsync.PROMISE_SUCCESS,this.result=a;for(var b=0;b<this.listeners.length;++b)this.listeners[b].success.call(this.listeners[b].context||this,a)},exception:function(a){this.state=BetaJS.SyncAsync.PROMISE_EXCEPTION,this.exception=a;for(var b=0;b<this.listeners.length;++b)this.listeners[b].exception.call(this.listeners[b].context||this,a)}}),c.apply(b,d),f}try{return{state:this.PROMISE_SUCCESS,result:c.apply(b,d)}}catch(g){return{state:this.PROMISE_EXCEPTION,exception:g}}},reveal:function(a,b){if(a.state==this.PROMISE_LAZY){var c=this.promise(a.func_ctx,a.func,a.params,a.type);for(var d in c)a[d]=c[d]}a.state==this.PROMISE_ACTIVE?a.listeners.push(b):a.state==this.PROMISE_SUCCESS?b.success.call(b.context||this,a.result):a.state==this.PROMISE_EXCEPTION&&b.exception.call(b.context||this,a.exception)},join:function(a,b){for(var c={count:a.length,exception:!1,results:[]},d=0;d<a.length;++d)c.results.push(null),this.reveal(a[d],{context:{monitor:c,index:d},sync:b&&b.sync,success:function(a){this.monitor.count=this.monitor.count-1,this.monitor.exception||(this.monitor.results[this.index]=a,this.monitor.count<=0&&b&&b.success.apply(b.context||this,this.monitor.results))},exception:function(a){if(this.monitor.count=this.monitor.count-1,!this.monitor.exception){if(this.monitor.exception=!0,!b)throw a;b.exception.apply(b.context||this,a)}}});return c.results},mapSuccess:function(a,b){var c=BetaJS.Objs.clone(a,1);return c.success=b,c},mapException:function(a,b){var c=BetaJS.Objs.clone(a,1);return c.exception=b,c},callback:function(a,b){if(a&&("success"==b||"exception"==b)){var c=a.context||this,d=BetaJS.Functions.getArguments(arguments,2);b in a&&a[b].apply(c,d),"complete"in a&&a.complete.apply(c)}}},BetaJS.SyncAsync.SyncAsyncMixin={supportsSync:function(){return this._supportsSync},supportsAsync:function(){return this._supportsAsync},eitherSync:function(a,b,c){return BetaJS.SyncAsync.eitherSync(a,b,c||[],this)},either:function(a,b,c,d,e){return BetaJS.Types.is_undefined(d)&&(d=!this.supportsAsync()),BetaJS.SyncAsync.either(a,d,b,c,e||[],this)},eitherSyncFactory:function(a,b,c,d){return BetaJS.SyncAsync.eitherSync(b,function(){return this[a]||(this[a]=c.apply(this,d)),this[a]},this)},eitherAsyncFactory:function(a,b,c){var d=this;return this.either(b,function(){return this[a]},function(){c.apply(this,BetaJS.SyncAsync.mapSuccess(b,function(c){d[a]=c,b.success.call(this,c)}))},a in this,this)},eitherFactory:function(a,b,c,d,e){var f=this;return this.either(b,function(){return this[a]||(this[a]=c.apply(this,e)),this[a]},function(){d.apply(this,BetaJS.SyncAsync.mapSuccess(b,function(c){f[a]=c,b.success.call(this,c)}))},this[a]||!this.supportsAsync())},then:function(){var a=BetaJS.Functions.matchArgs(arguments,{func_ctx:"object",func:!0,params:"array",type:"number",callbacks:!0,success_ctx:"object",success:!0,exception:"function"}),b=a.func_ctx||this,c=a.func,d=a.params||[],e=a.callbacks,f=a.type||(e&&this.supportsAsync()?BetaJS.SyncAsync.ASYNC:BetaJS.SyncAsync.SYNC),g=a.success_ctx||this;return BetaJS.SyncAsync.then(b,c,d,f,e,g,a.success,a.exception)},thenSingle:function(){var a=BetaJS.Functions.matchArgs(arguments,{func_ctx:"object",func:!0,params:"array",type:"number",callbacks:!0,success_ctx:"object",success:!0}),b=a.func_ctx||this,c=a.func,d=a.params||[],e=a.callbacks,f=a.type||(e&&this.supportsAsync()?BetaJS.SyncAsync.ASYNCSINGLE:BetaJS.SyncAsync.SYNC),g=a.success_ctx||this,h=a.success;return BetaJS.SyncAsync.then(b,c,d,f,e,g,h)},promise:function(){var a=BetaJS.Functions.matchArgs(arguments,{func_ctx:"object",func:!0,params:"array",type:"number"});return BetaJS.SyncAsync.promise(a.func_ctx||this,a.func,a.params||[],a.type)},join:function(a,b){return BetaJS.SyncAsync.join(a,b)},delegate:function(){var a=BetaJS.Functions.matchArgs(arguments,{func_ctx:"object",func:!0,params:"array",callbacks:"object"}),b=a.func_ctx||this,c=a.params||[];return a.callbacks?this.supportsAsync()&&!a.callbacks.sync?(c.push(a.callbacks),a.func.apply(b,c)):BetaJS.SyncAsync.syncToAsync(a.callbacks,a.func,c,b):a.func.apply(b,c)},callback:function(){return BetaJS.SyncAsync.callback.apply(this,arguments)}},BetaJS.Scopes={base:function(a,b){if(!BetaJS.Types.is_string(a))return a;if(b)return b[a];try{if(window)return window[a]}catch(c){}try{if(global&&global[a])return global[a]}catch(c){}try{if(module&&module.exports)return module.exports}catch(c){}return null},resolve:function(a,b){if(!BetaJS.Types.is_string(a))return a;for(var c=a.split("."),d=this.base(c[0],b),e=1;e<c.length;++e)d=d[c[e]];return d},touch:function(a,b){if(!BetaJS.Types.is_string(a))return a;for(var c=a.split("."),d=this.base(c[0],b),e=1;e<c.length;++e)c[e]in d||(d[c[e]]={}),d=d[c[e]];return d},set:function(a,b,c){if(!BetaJS.Types.is_string(b))return b;for(var d=b.split("."),e=this.base(d[0],c),f=1;f<d.length-1;++f)d[f]in e||(e[d[f]]={}),e=e[d[f]];return d.length>1&&(e[d[d.length-1]]=a),a}},BetaJS.Ids={__uniqueId:0,uniqueId:function(a){return(a||"")+this.__uniqueId++},objectId:function(a,b){return"undefined"!=typeof b?a.__cid=b:a.__cid||(a.__cid=this.uniqueId("cid_")),a.__cid}},BetaJS.Tokens={generate_token:function(a){a=a||16;for(var b="";b.length<a;)b+=Math.random().toString(36).substr(2);return b.substr(0,a)}},BetaJS.Objs={count:function(a){if(BetaJS.Types.is_array(a))return a.length;var b=0;for(var c in a)b++;return b},clone:function(a,b){return!b||0>=b?a:BetaJS.Types.is_array(a)?a.slice(0):BetaJS.Types.is_object(a)?this.extend({},a,b-1):a},acyclic_clone:function(a,b){if(null===a||!BetaJS.Types.is_object(a))return a;var c="__acyclic_cloned";if(a[c])return b||"CYCLE";a[c]=!0;var d={};for(var e in a)e!=c&&(d[e]=this.acyclic_clone(a[e],b));return delete a[c],d},extend:function(a,b,c){if(a=a||{},b)for(var d in b)a[d]=this.clone(b[d],c);return a},merge:function(a,b,c){a=a||{},b=b||{};var d={},e=BetaJS.Objs.extend(BetaJS.Objs.keys(a,!0),BetaJS.Objs.keys(b,!0));for(var f in e){var g=f in c?c[f]:"primary";"primary"==g||"secondary"==g?(f in b||f in a)&&(d[f]="primary"==g?f in b?b[f]:a[f]:f in a?a[f]:b[f]):BetaJS.Types.is_function(g)?d[f]=g(a[f],b[f]):BetaJS.Types.is_object(g)&&(d[f]=BetaJS.Objs.merge(a[f],b[f],g))}return d},tree_merge:function(a,b){a=a||{},b=b||{};var c={},d=BetaJS.Objs.extend(BetaJS.Objs.keys(a,!0),BetaJS.Objs.keys(b,!0));for(var e in d)c[e]=BetaJS.Types.is_object(b[e])&&a[e]?BetaJS.Objs.tree_merge(a[e],b[e]):e in b?b[e]:a[e];return c},keys:function(a,b){var c=null,d=null;if(BetaJS.Types.is_undefined(b)){c=[];for(d in a)c.push(d);return c}c={};for(d in a)c[d]=b;return c},map:function(a,b,c){var d=null;if(BetaJS.Types.is_array(a)){d=[];for(var e=0;e<a.length;++e)d.push(c?b.apply(c,[a[e],e]):b(a[e],e));return d}d={};for(var f in a)d[f]=c?b.apply(c,[a[f],f]):b(a[f],f);return d},values:function(a){var b=[];for(var c in a)b.push(a[c]);return b},filter:function(a,b,c){var d=null;if(BetaJS.Types.is_array(a)){d=[];for(var e=0;e<a.length;++e)(c?b.apply(c,[a[e],e]):b(a[e],e))&&d.push(a[e]);return d}d={};for(var f in a)(c?b.apply(c,[a[f],f]):b(a[f],f))&&(d[f]=a[f]);return d},equals:function(a,b,c){var d=null;if(c&&c>0){for(d in a)if(!d in b||!this.equals(a[d],b[d],c-1))return!1;for(d in b)if(!d in a)return!1;return!0}return a==b},iter:function(a,b,c){var d=null;if(BetaJS.Types.is_array(a)){for(var e=0;e<a.length;++e)if(d=c?b.apply(c,[a[e],e]):b(a[e],e),BetaJS.Types.is_defined(d)&&!d)return!1}else for(var f in a)if(d=c?b.apply(c,[a[f],f]):b(a[f],f),BetaJS.Types.is_defined(d)&&!d)return!1;return!0},intersect:function(a,b){var c={};for(var d in a)d in b&&(c[d]=a[d]);return c},contains_key:function(a,b){return BetaJS.Types.is_array(a)?BetaJS.Types.is_defined(a[b]):b in a},contains_value:function(a,b){if(BetaJS.Types.is_array(a)){for(var c=0;c<a.length;++c)if(a[c]===b)return!0}else for(var d in a)if(a[d]===b)return!0;return!1},exists:function(a,b,c){var d=!1;return BetaJS.Objs.iter(a,function(){return d=d||b.apply(this,arguments),!d},c),d},all:function(a,b,c){var d=!0;return BetaJS.Objs.iter(a,function(){return d=d&&b.apply(this,arguments)},c),d},objectify:function(a,b,c){var d={},e=BetaJS.Types.is_function(b);BetaJS.Types.is_undefined(b)&&(b=!0);for(var f=0;f<a.length;++f)d[a[f]]=e?b.apply(c||this,[a[f],f]):b;return d},peek:function(a){if(BetaJS.Types.is_array(a))return a.length>0?a[0]:null;for(var b in a)return a[b];return null},poll:function(a){if(BetaJS.Types.is_array(a))return a.shift();for(var b in a){var c=a[b];return delete a[b],c}return null},objectBy:function(){for(var a={},b=arguments.length/2,c=0;b>c;++c)a[arguments[2*c]]=arguments[2*c+1];return a},valueByIndex:function(a,b){if(b=b||0,BetaJS.Types.is_array(a))return a[b];for(var c in a){if(0===b)return a[c];b--}return null},keyByIndex:function(a,b){if(b=b||0,BetaJS.Types.is_array(a))return b;for(var c in a){if(0===b)return c;b--}return null}},BetaJS.Class=function(){},BetaJS.Class.classname="Class",BetaJS.Class.extend=function(a,b,c,d){b=b||[],BetaJS.Types.is_array(b)||(b=[b]),c=c||[],BetaJS.Types.is_array(c)||(c=[c]),d=d||[],BetaJS.Types.is_array(d)||(d=[d]);var e,f=this;BetaJS.Objs.iter(b,function(a){a.hasOwnProperty("constructor")&&(e=a.constructor)});var g=BetaJS.Types.is_defined(e);BetaJS.Types.is_defined(e)||(e=function(){f.apply(this,arguments)}),BetaJS.Objs.extend(e,f),BetaJS.Objs.iter(c,function(a){BetaJS.Objs.extend(e,a)});var h={};if(f.__class_statics_keys)for(var i in f.__class_statics_keys)e[i]=BetaJS.Objs.clone(f[i],1);BetaJS.Objs.iter(d,function(a){BetaJS.Objs.extend(e,a),BetaJS.Objs.extend(h,BetaJS.Objs.keys(a,!0))}),f.__class_statics_keys&&BetaJS.Objs.extend(h,f.__class_statics_keys),e.__class_statics_keys=h,e.parent=f,e.children=[],e.extend=this.extend,f.children||(f.children=[]),f.children.push(e);var j=function(){};return j.prototype=f.prototype,e.prototype=new j,e.prototype.cls=e,e.classname=a,a&&BetaJS.Scopes.set(e,a),e.__notifications={},f.__notifications&&BetaJS.Objs.extend(e.__notifications,f.__notifications,1),BetaJS.Objs.iter(b,function(a){if(BetaJS.Objs.extend(e.prototype,a),"constructor"in a&&(e.prototype.constructor=a.constructor),a._notifications)for(var b in a._notifications)e.__notifications[b]||(e.__notifications[b]=[]),e.__notifications[b].push(a._notifications[b])}),delete e.prototype._notifications,g||(e.prototype.constructor=f.prototype.constructor),e},BetaJS.Class.prototype.constructor=function(){this._notify("construct")},BetaJS.Class.prototype.as_method=function(a){return BetaJS.Functions.as_method(this[a],this)},BetaJS.Class.prototype._auto_destroy=function(a){return this.__auto_destroy_list||(this.__auto_destroy_list=[]),this.__auto_destroy_list.push(a),a},BetaJS.Class.prototype._notify=function(a){if(this.cls.__notifications){var b=Array.prototype.slice.call(arguments,1),c=this.cls.__notifications[a];if(c)for(var d in c){var e=BetaJS.Types.is_function(c[d])?c[d]:this[c[d]];if(!e)throw this.cls.classname+": Could not find "+a+" notification handler "+c[d];e.apply(this,b)}}},BetaJS.Class.prototype.destroy=function(){if(this._notify("destroy"),this.__auto_destroy_list)for(var a=0;a<this.__auto_destroy_list.length;++a)"destroy"in this.__auto_destroy_list[a]&&this.__auto_destroy_list[a].destroy();for(var b in this)delete this[b]},BetaJS.Class.prototype._inherited=function(a,b){return a.parent.prototype[b].apply(this,Array.prototype.slice.apply(arguments,[2]))},BetaJS.Class._inherited=function(a,b){return a.parent[b].apply(this,Array.prototype.slice.apply(arguments,[2]))},BetaJS.Class.prototype.instance_of=function(a){return this.cls.ancestor_of(a)},BetaJS.Class.ancestor_of=function(a){return this==a||this!=BetaJS.Class&&this.parent.ancestor_of(a)},BetaJS.Class.prototype.cid=function(){return BetaJS.Ids.objectId(this)},BetaJS.Class.prototype.cls=BetaJS.Class,BetaJS.Class.__notifications={},BetaJS.Class.is_class_instance=function(a){return a&&BetaJS.Types.is_object(a)&&"_inherited"in a&&"cls"in a},BetaJS.Exceptions={ensure:function(a){return a&&BetaJS.Types.is_object(a)&&"instance_of"in a&&a.instance_of(BetaJS.Exceptions.Exception)?a:new BetaJS.Exceptions.NativeException(a)}},BetaJS.Class.extend("BetaJS.Exceptions.Exception",{constructor:function(a){this._inherited(BetaJS.Exceptions.Exception,"constructor"),this.__message=a},assert:function(a){if(!this.instance_of(a))throw this;return this},callstack:function(){for(var a=[],b=arguments.callee.caller;b;)a.push(b.toString()),b=b.caller;return a},callstack_to_string:function(){return this.callstack().join("\n")},message:function(){return this.__message},toString:function(){return this.message()},format:function(){return this.cls.classname+": "+this.toString()+"\n\nCall Stack:\n"+this.callstack_to_string()},json:function(){return{classname:this.cls.classname,message:this.message()}}},{ensure:function(a){return a=BetaJS.Exceptions.ensure(a),a.assert(this),a}}),BetaJS.Exceptions.Exception.extend("BetaJS.Exceptions.NativeException",{constructor:function(a){this._inherited(BetaJS.Exceptions.NativeException,"constructor",a.toString()),this.__object=a},object:function(){return this.__object}}),BetaJS.Class.extend("BetaJS.Lists.AbstractList",{_add:function(){},_remove:function(){},_get:function(){},_iterate:function(){},get_ident:function(a){var b=null;return this._iterate(function(c,d){return c==a?(b=d,!1):!0}),b},exists:function(a){return a&&null!==this.get_ident(a)},_ident_changed:function(){},constructor:function(a){this._inherited(BetaJS.Lists.AbstractList,"constructor"),this.__count=0,a&&BetaJS.Objs.iter(a,function(a){this.add(a)},this)},add:function(a){var b=this._add(a);return BetaJS.Types.is_defined(b)&&this.__count++,b},count:function(){return this.__count},clear:function(){this._iterate(function(a,b){return this.remove_by_ident(b),!0},this)},remove_by_ident:function(a){var b=this._remove(a);return BetaJS.Types.is_defined(b)&&this.__count--,b},remove:function(a){return this.remove_by_ident(this.get_ident(a))},remove_by_filter:function(a){this._iterate(function(b,c){return a(b)&&this.remove_by_ident(c),!0},this)},get:function(a){return this._get(a)},iterate:function(a,b){this._iterate(function(b,c){var d=a.apply(this,[b,c]);return BetaJS.Types.is_defined(d)?d:!0},b)},iterator:function(){return BetaJS.Iterators.ArrayIterator.byIterate(this.iterate,this)}}),BetaJS.Lists.AbstractList.extend("BetaJS.Lists.LinkedList",{constructor:function(a){this.__first=null,this.__last=null,this._inherited(BetaJS.Lists.LinkedList,"constructor",a)},_add:function(a){return this.__last={obj:a,prev:this.__last,next:null},this.__first?this.__last.prev.next=this.__last:this.__first=this.__last,this.__last},_remove:function(a){return a.next?a.next.prev=a.prev:this.__last=a.prev,a.prev?a.prev.next=a.next:this.__first=a.next,a.obj},_get:function(a){return a.obj},_iterate:function(a,b){for(var c=this.__first;c;){var d=c;if(c=c.next,!a.apply(b||this,[d.obj,d]))return}}}),BetaJS.Lists.AbstractList.extend("BetaJS.Lists.ObjectIdList",{constructor:function(a){this.__map={},this._inherited(BetaJS.Lists.ObjectIdList,"constructor",a)},_add:function(a){var b=BetaJS.Ids.objectId(a);return this.__map[b]=a,b},_remove:function(a){var b=this.__map[a];return delete this.__map[a],b},_get:function(a){return this.__map[a]},_iterate:function(a,b){for(var c in this.__map)a.apply(b||this,[this.__map[c],c])},get_ident:function(a){var b=BetaJS.Ids.objectId(a);return this.__map[b]?b:null}}),BetaJS.Lists.AbstractList.extend("BetaJS.Lists.ArrayList",{constructor:function(a,b){this.__idToIndex={},this.__items=[],b=b||{},"compare"in b&&(this._compare=b.compare),this._inherited(BetaJS.Lists.ArrayList,"constructor",a)},set_compare:function(a){this._compare=a,a&&this.sort()},get_compare:function(){return this._compare},sort:function(a){if(a=a||this._compare){this.__items.sort(a);for(var b=0;b<this.__items.length;++b)this.__ident_changed(this.__items[b],b);this._sorted()}},_sorted:function(){},re_index:function(a){if(!this._compare)return a;for(var b=this.__items.length-1,c=this.__items[a],d=a;b>d&&this._compare(this.__items[d],this.__items[d+1])>0;)this.__items[d]=this.__items[d+1],this.__ident_changed(this.__items[d],d),this.__items[d+1]=c,++d;if(d==a)for(;d>0&&this._compare(this.__items[d],this.__items[d-1])<0;)this.__items[d]=this.__items[d-1],this.__ident_changed(this.__items[d],d),this.__items[d-1]=c,--d;return d!=a&&(this.__ident_changed(c,d),this._re_indexed(c)),d},_re_indexed:function(){},_add:function(a){var b=this.__items.length;this.__items.push(a);var c=this.re_index(b);return this.__idToIndex[BetaJS.Ids.objectId(a)]=c,c},_remove:function(a){for(var b=this.__items[a],c=a+1;c<this.__items.length;++c)this.__items[c-1]=this.__items[c],this.__ident_changed(this.__items[c-1],c-1);return this.__items.pop(),delete this.__idToIndex[BetaJS.Ids.objectId(b)],b},_get:function(a){return this.__items[a]},_iterate:function(a,b){for(var c=BetaJS.Objs.clone(this.__items,1),d=0;d<c.length;++d)a.apply(b||this,[c[d],this.get_ident(c[d])])},__ident_changed:function(a,b){this.__idToIndex[BetaJS.Ids.objectId(a)]=b,this._ident_changed(a,b)},get_ident:function(a){var b=BetaJS.Ids.objectId(a);return b in this.__idToIndex?this.__idToIndex[b]:null},ident_by_id:function(a){return this.__idToIndex[a]}}),BetaJS.Iterators={ensure:function(a){return null===a?new BetaJS.Iterators.ArrayIterator([]):a.instance_of(BetaJS.Iterators.Iterator)?a:new BetaJS.Iterators.ArrayIterator(BetaJS.Types.is_array(a)?a:[a])}},BetaJS.Class.extend("BetaJS.Iterators.Iterator",{asArray:function(){for(var a=[];this.hasNext();)a.push(this.next());return a},asArrayDelegate:function(a){for(var b=[];this.hasNext();){var c=this.next();b.push(c[a].apply(c,BetaJS.Functions.getArguments(arguments,1)))}return b},iterate:function(a,b){for(;this.hasNext();)a.call(b||this,this.next())}}),BetaJS.Iterators.Iterator.extend("BetaJS.Iterators.ArrayIterator",{constructor:function(a){this._inherited(BetaJS.Iterators.ArrayIterator,"constructor"),this.__array=a,this.__i=0},hasNext:function(){return this.__i<this.__array.length},next:function(){var a=this.__array[this.__i];return this.__i++,a}},{byIterate:function(a,b){var c=[];return a.call(b||this,function(a){c.push(a)},this),new this(c)}}),BetaJS.Iterators.ArrayIterator.extend("BetaJS.Iterators.ObjectKeysIterator",{constructor:function(a){this._inherited(BetaJS.Iterators.ObjectKeysIterator,"constructor",BetaJS.Objs.keys(a))}}),BetaJS.Iterators.ArrayIterator.extend("BetaJS.Iterators.ObjectValuesIterator",{constructor:function(a){this._inherited(BetaJS.Iterators.ObjectValuesIterator,"constructor",BetaJS.Objs.values(a))}}),BetaJS.Iterators.Iterator.extend("BetaJS.Iterators.MappedIterator",{constructor:function(a,b,c){this._inherited(BetaJS.Iterators.MappedIterator,"constructor"),this.__iterator=a,this.__map=b,this.__context=c||this},hasNext:function(){return this.__iterator.hasNext()},next:function(){return this.hasNext()?this.__map.call(this.__context,this.__iterator.next()):null}}),BetaJS.Iterators.Iterator.extend("BetaJS.Iterators.FilteredIterator",{constructor:function(a,b,c){this._inherited(BetaJS.Iterators.FilteredIterator,"constructor"),this.__iterator=a,this.__filter=b,this.__context=c||this,this.__next=null},hasNext:function(){return this.__crawl(),null!==this.__next},next:function(){this.__crawl();var a=this.__next;return this.__next=null,a},__crawl:function(){for(;!this.__next&&this.__iterator.hasNext();){var a=this.__iterator.next();this.__filter_func(a)&&(this.__next=a)}},__filter_func:function(a){return this.__filter.apply(this.__context,[a])}}),BetaJS.Iterators.Iterator.extend("BetaJS.Iterators.SkipIterator",{constructor:function(a,b){for(this._inherited(BetaJS.Iterators.SkipIterator,"constructor"),this.__iterator=a;b>0;)a.next(),b--},hasNext:function(){return this.__iterator.hasNext()},next:function(){return this.__iterator.next()}}),BetaJS.Iterators.Iterator.extend("BetaJS.Iterators.LimitIterator",{constructor:function(a,b){this._inherited(BetaJS.Iterators.LimitIterator,"constructor"),this.__iterator=a,this.__limit=b},hasNext:function(){return this.__limit>0&&this.__iterator.hasNext()},next:function(){return this.__limit<=0?null:(this.__limit--,this.__iterator.next())}}),BetaJS.Iterators.Iterator.extend("BetaJS.Iterators.SortedIterator",{constructor:function(a,b){this._inherited(BetaJS.Iterators.SortedIterator,"constructor"),this.__array=a.asArray(),this.__array.sort(b),this.__i=0},hasNext:function(){return this.__i<this.__array.length},next:function(){var a=this.__array[this.__i];return this.__i++,a}}),BetaJS.Events={},BetaJS.Events.EVENT_SPLITTER=/\s+/,BetaJS.Events.EventsMixin={__create_event_object:function(a,b,c){c=c||{};var d={callback:a,context:b};return c.eventually&&(d.eventually=c.eventually),c.min_delay&&(d.min_delay=new BetaJS.Timers.Timer({delay:c.min_delay,once:!0,start:!1,context:this,fire:function(){d.max_delay&&d.max_delay.stop(),d.callback.apply(d.context||this,d.params)}})),c.max_delay&&(d.max_delay=new BetaJS.Timers.Timer({delay:c.max_delay,once:!0,start:!1,context:this,fire:function(){d.min_delay&&d.min_delay.stop(),d.callback.apply(d.context||this,d.params)}})),d},__destroy_event_object:function(a){a.min_delay&&a.min_delay.destroy(),a.max_delay&&a.max_delay.destroy()},__call_event_object:function(a,b){a.min_delay&&a.min_delay.restart(),a.max_delay&&a.max_delay.start(),a.min_delay||a.max_delay?a.params=b:a.eventually?BetaJS.SyncAsync.eventually(a.callback,b,a.context||this):a.callback.apply(a.context||this,b)},on:function(a,b,c,d){this.__events_mixin_events=this.__events_mixin_events||{},a=a.split(BetaJS.Events.EVENT_SPLITTER);for(var e;;){if(e=a.shift(),!e)break;this.__events_mixin_events[e]=this.__events_mixin_events[e]||new BetaJS.Lists.LinkedList,this.__events_mixin_events[e].add(this.__create_event_object(b,c,d))}return this},off:function(a,b,c){if(this.__events_mixin_events=this.__events_mixin_events||{},a){a=a.split(BetaJS.Events.EVENT_SPLITTER);for(var d;;){if(d=a.shift(),!d)break;this.__events_mixin_events[d]&&(this.__events_mixin_events[d].remove_by_filter(function(a){var d=!(b&&a.callback!=b||c&&a.context!=c);return d&&this.__destroy_event_object&&this.__destroy_event_object(a),d}),0===this.__events_mixin_events[d].count()&&(this.__events_mixin_events[d].destroy(),delete this.__events_mixin_events[d]))}}else for(d in this.__events_mixin_events)this.__events_mixin_events[d].remove_by_filter(function(a){var d=!(b&&a.callback!=b||c&&a.context!=c);return d&&this.__destroy_event_object&&this.__destroy_event_object(a),d}),0===this.__events_mixin_events[d].count()&&(this.__events_mixin_events[d].destroy(),delete this.__events_mixin_events[d]);return this},triggerAsync:function(){var a=this,b=BetaJS.Functions.getArguments(arguments),c=setTimeout(function(){clearTimeout(c),a.trigger.apply(a,b)},0)},trigger:function(a){var b=this;a=a.split(BetaJS.Events.EVENT_SPLITTER);var c,d=BetaJS.Functions.getArguments(arguments,1);if(!this.__events_mixin_events)return this;for(;;){if(c=a.shift(),!c)break;this.__events_mixin_events[c]&&this.__events_mixin_events[c].iterate(function(a){b.__call_event_object(a,d)}),this.__events_mixin_events&&"all"in this.__events_mixin_events&&this.__events_mixin_events.all.iterate(function(a){b.__call_event_object(a,[c].concat(d))})}return this},once:function(a,b,c,d){var e=this,f=BetaJS.Functions.once(function(){e.off(a,f),b.apply(this,arguments)});return f._callback=b,this.on(name,f,c,d)},delegateEvents:function(a,b,c,d){d=d||[],c=c?c+":":"",null===a?b.on("all",function(a){var b=BetaJS.Functions.getArguments(arguments,1);this.trigger.apply(this,[c+a].concat(d).concat(b))},this):(BetaJS.Types.is_array(a)||(a=[a]),BetaJS.Objs.iter(a,function(a){b.on(a,function(){var b=BetaJS.Functions.getArguments(arguments);this.trigger.apply(this,[c+a].concat(d).concat(b))},this)},this))}},BetaJS.Class.extend("BetaJS.Events.Events",BetaJS.Events.EventsMixin),BetaJS.Events.ListenMixin={_notifications:{destroy:"listenOff"},listenOn:function(a,b,c,d){this.__listen_mixin_listen||(this.__listen_mixin_listen={}),this.__listen_mixin_listen[BetaJS.Ids.objectId(a)]=a,a.on(b,c,this,d)},listenOnce:function(a,b,c,d){this.__listen_mixin_listen||(this.__listen_mixin_listen={}),this.__listen_mixin_listen[BetaJS.Ids.objectId(a)]=a,a.once(b,c,this,d)},listenOff:function(a,b,c){this.__listen_mixin_listen&&(a?(a.off(b,c,this),b||c||delete this.__listen_mixin_listen[BetaJS.Ids.objectId(a)]):BetaJS.Objs.iter(this.__listen_mixin_listen,function(a){a.off(b,c,this),b||c||delete this.__listen_mixin_listen[BetaJS.Ids.objectId(a)]},this))}},BetaJS.Class.extend("BetaJS.Events.Listen",BetaJS.Events.ListenMixin),BetaJS.Classes={},BetaJS.Classes.InvokerMixin={invoke_delegate:function(a,b){BetaJS.Types.is_array(b)||(b=[b]),a=this[a];for(var c=this,d=0;d<b.length;++d){var e=b[d];this[e]=function(b){return function(){var d=BetaJS.Functions.getArguments(arguments);return d.unshift(b),a.apply(c,d)}}.call(c,e)}}},BetaJS.Classes.AutoDestroyMixin={_notifications:{construct:"__initialize_auto_destroy",destroy:"__finalize_auto_destroy"},__initialize_auto_destroy:function(){this.__auto_destroy={}},__finalize_auto_destroy:function(){var a=this.__auto_destroy;this.__auto_destroy={},BetaJS.Objs.iter(a,function(a){a.unregister(this)
},this)},register_auto_destroy:function(a){a.cid()in this.__auto_destroy||(this.__auto_destroy[a.cid()]=a,a.register(this),this._notify("register_auto_destroy",a))},unregister_auto_destroy:function(a){a.cid()in this.__auto_destroy&&(this._notify("unregister_auto_destroy",a),delete this.__auto_destroy[a.cid()],a.unregister(this),BetaJS.Types.is_empty(this.__auto_destroy)&&this.destroy())}},BetaJS.Class.extend("BetaJS.Classes.AutoDestroyObject",{constructor:function(){this._inherited(BetaJS.Classes.AutoDestroyObject,"constructor"),this.__objects={}},register:function(a){var b=BetaJS.Ids.objectId(a);b in this.__objects||(this.__objects[b]=a,a.register_auto_destroy(this))},unregister:function(a){var b=BetaJS.Ids.objectId(a);b in this.__objects&&(delete this.__objects[b],a.unregister_auto_destroy(this))},clear:function(){BetaJS.Objs.iter(this.__objects,function(a){this.unregister(a)},this)}}),BetaJS.Class.extend("BetaJS.Classes.ObjectCache",[BetaJS.Events.EventsMixin,{constructor:function(a){this._inherited(BetaJS.Classes.ObjectCache,"constructor"),this.__size="size"in a?a.size:null,this.__destroy_on_remove="destroy_on_remove"in a?a.destroy_on_remove:!0,this.__id_to_container={},this.__first=null,this.__last=null,this.__count=0},destroy:function(){this.clear(),this._inherited(BetaJS.Classes.ObjectCache,"destroy")},add:function(a){if(!this.get(a)){null!==this.__size&&this.__count>=this.__size&&this.__first&&this.remove(this.__first.object);var b={object:a,prev:this.__last,next:null};this.__id_to_container[BetaJS.Ids.objectId(a)]=b,this.__first?this.__last.next=b:this.__first=b,this.__last=b,this.__count++,this.trigger("cache",a)}},remove:function(a){BetaJS.Class.is_class_instance(a)&&(a=BetaJS.Ids.objectId(a));var b=this.__id_to_container[a];b&&(delete this.__id_to_container[a],b.next?b.next.prev=b.prev:this.__last=b.prev,b.prev?b.prev.next=b.next:this.__first=b.next,this.__count--,this.trigger("release",b.object),this.__destroy_on_remove&&b.object.destroy())},get:function(a){return BetaJS.Class.is_class_instance(a)&&(a=BetaJS.Ids.objectId(a)),this.__id_to_container[a]?this.__id_to_container[a].object:null},clear:function(){BetaJS.Objs.iter(this.__id_to_container,function(a){this.remove(a.object)},this)}}]),BetaJS.Classes.ModuleMixin={_notifications:{construct:function(){this.__modules={}},destroy:function(){BetaJS.Objs.iter(this.__modules,this.remove_module,this)}},add_module:function(a){a.cid()in this.__modules||(this.__modules[a.cid()]=a,a.register(this),this._notify("add_module",a))},remove_module:function(a){a.cid()in this.__modules&&(delete this.__modules[a.cid()],a.unregister(this),this._notify("remove_module",a))}},BetaJS.Class.extend("BetaJS.Classes.Module",{constructor:function(a){this._inherited(BetaJS.Classes.Module,"constructor"),this._objects={},this.__auto_destroy="auto_destroy"in a?a.auto_destroy:!0},destroy:function(){BetaJS.Objs.iter(this._objects,this.unregister,this),this._inherited(BetaJS.Classes.Module,"destroy")},register:function(a){var b=BetaJS.Ids.objectId(a);if(!(b in this._objects)){var c={};this._objects[b]={object:a,data:c},a.add_module(this),this._register(a,c)}},_register:function(){},unregister:function(a){var b=BetaJS.Ids.objectId(a);if(b in this._objects){var c=this._objects[b].data;this._unregister(a,c),delete this._objects[b],a.remove_module(this),"off"in a&&a.off(null,null,this),this.__auto_destroy&&BetaJS.Types.is_empty(this._objects)&&this.destroy()}},_unregister:function(){},_data:function(a){return this._objects[BetaJS.Ids.objectId(a)].data}},{__instance:null,singleton:function(){return this.__instance||(this.__instance=new this({auto_destroy:!1})),this.__instance}}),BetaJS.Properties={},BetaJS.Properties.TYPE_VALUE=0,BetaJS.Properties.TYPE_BINDING=1,BetaJS.Properties.TYPE_COMPUTED=2,BetaJS.Properties.PropertiesMixin={get:function(a){return a in this.__properties?this.__properties[a].value:null},_canSet:function(){return!0},_beforeSet:function(a,b){return b},_afterSet:function(){},has:function(a){return a in this.__properties},setAll:function(a,b){for(var c in a)this.set(c,a[c],b)},keys:function(a){return BetaJS.Objs.keys(this.__properties,a)},binding:function(a){return{type:BetaJS.Properties.TYPE_BINDING,bindee:this,property:a}},computed:function(a,b){return{type:BetaJS.Properties.TYPE_COMPUTED,func:a,dependencies:b||[]}},_isBinding:function(a){return BetaJS.Types.is_object(a)&&a&&a.type&&a.type==BetaJS.Properties.TYPE_BINDING&&a.bindee&&a.property},_isComputed:function(a){return BetaJS.Types.is_object(a)&&a&&a.type&&a.type==BetaJS.Properties.TYPE_COMPUTED&&a.func&&a.dependencies},getAll:function(){var a={};for(var b in this.__properties)a[b]=this.get(b);return a},unset:function(a){if(a in this.__properties){var b=this.__properties[a];if(b.type==BetaJS.Properties.TYPE_BINDING)b.bindee.off("change:"+b.property,null,this.__properties[a]);else if(b.type==BetaJS.Properties.TYPE_COMPUTED){var c=this;BetaJS.Objs.iter(b.dependencies,function(d){this._isBinding(d)?d.bindee.off("change:"+d.property,null,this.__properties[a]):this._isTimer(d)?b.timers[d].destroy():c.off("change:"+d,null,this.__properties[a])},this)}this.trigger("unset",a),this.trigger("unset:"+a),delete this.__properties[a]}},_set_changed:function(a,b,c){this._afterSet(a,this.get(a),b,c),this.trigger("change",a,this.get(a),b,c),this.trigger("change:"+a,this.get(a),b,c)},_isTimer:function(){return BetaJS.Strings.starts_with("dep","timer:")},_parseTimer:function(){return parseInt(BetaJS.Strings.strip_start("timer:"),10)},set:function(a,b,c){var d=this.get(a);if(d!=b){{var e=this;this.__properties[a]}this._isBinding(b)?(this.unset(a),this.__properties[a]={type:BetaJS.Properties.TYPE_BINDING,bindee:b.bindee,property:b.property,value:b.bindee.get(b.property)},b.bindee.on("change:"+b.property,function(){var c=e.__properties[a].value;e.__properties[a].value=b.bindee.get(b.property),e._set_changed(a,c)},this.__properties[a]),this._set_changed(a,d,c)):this._isComputed(b)?(this.unset(a),this.__properties[a]={type:BetaJS.Properties.TYPE_COMPUTED,func:b.func,dependencies:b.dependencies,value:b.func.apply(e),timers:{}},BetaJS.Objs.iter(b.dependencies,function(c){this._isBinding(c)?c.bindee.on("change:"+c.property,function(){var c=e.__properties[a].value;e.__properties[a].value=b.func.apply(e),e._set_changed(a,c)},this.__properties[a]):this._isTimer(c)?this.__properties[a].timers[c]=new BetaJS.Timers.Timer({delay:this._parseTimer(c),fire:function(){var c=e.__properties[a].value;e.__properties[a].value=b.func.apply(e),e._set_changed(a,c)}}):e.on("change:"+c,function(){var c=e.__properties[a].value;e.__properties[a].value=b.func.apply(e),e._set_changed(a,c)},this.__properties[a])},this),this._set_changed(a,d)):(b=this._beforeSet(a,b),this._canSet(a,b)&&(this.__properties[a]&&this.__properties[a].type==BetaJS.Properties.TYPE_BINDING?this.__properties[a].bindee.set(this.__properties[a].property,b):(this.unset(a),this.__properties[a]={type:BetaJS.Properties.TYPE_VALUE,value:b},this._set_changed(a,d,c))))}},_notifications:{construct:"__properties_construct",destroy:"__properties_destroy"},__properties_construct:function(){this.__properties={}},__properties_destroy:function(){for(var a in this.__properties)this.unset(a);this.trigger("destroy")}},BetaJS.Class.extend("BetaJS.Properties.Properties",[BetaJS.Events.EventsMixin,BetaJS.Properties.PropertiesMixin,{constructor:function(a){this._inherited(BetaJS.Properties.Properties,"constructor"),a&&this.setAll(a)}}]),BetaJS.Class.extend("BetaJS.Properties.PropertiesData",{constructor:function(a){this._inherited(BetaJS.Properties.PropertiesData,"constructor"),this.__properties=a,this.data=this.__properties.getAll(),this.__properties.on("change",function(a,b){this.data[a]=b},this),this.__properties.on("unset",function(a){delete this.data[a]},this),this.__properties.on("destroy",function(){this.destroy()},this)},properties:function(){return this.__properties}}),BetaJS.Class.extend("BetaJS.Collections.Collection",[BetaJS.Events.EventsMixin,{constructor:function(a){this._inherited(BetaJS.Collections.Collection,"constructor"),a=a||{};var b={};"compare"in a&&(b.compare=a.compare),this.__data=new BetaJS.Lists.ArrayList([],b);var c=this;this.__data._ident_changed=function(a,b){c._index_changed(a,b)},this.__data._re_indexed=function(a){c._re_indexed(a)},this.__data._sorted=function(){c._sorted()},"objects"in a&&this.add_objects(a.objects)},set_compare:function(a){this.__data.set_compare(a)},get_compare:function(){this.__data.get_compare()},destroy:function(){this.__data.iterate(function(a){"off"in a&&a.off(null,null,this)},this),this.__data.destroy(),this.trigger("destroy"),this._inherited(BetaJS.Collections.Collection,"destroy")},count:function(){return this.__data.count()},_index_changed:function(a,b){this.trigger("index",a,b)},_re_indexed:function(a){this.trigger("reindexed",a)},_sorted:function(){this.trigger("sorted")},_object_changed:function(a,b,c){this.trigger("update"),this.trigger("change",a,b,c),this.trigger("change:"+b,a,c),this.__data.re_index(this.getIndex(a))},add:function(a){if(BetaJS.Class.is_class_instance(a)||(a=new BetaJS.Properties.Properties(a)),this.exists(a))return null;var b=this.__data.add(a);return null!==b&&(this.trigger("add",a),this.trigger("update"),"on"in a&&a.on("change",function(b,c){this._object_changed(a,b,c)},this)),b},add_objects:function(a){var b=0;return BetaJS.Objs.iter(a,function(a){this.add(a)&&b++},this),b},exists:function(a){return this.__data.exists(a)},remove:function(a){if(!this.exists(a))return null;this.trigger("remove",a),this.trigger("update");var b=this.__data.remove(a);return"off"in a&&a.off(null,null,this),b},getByIndex:function(a){return this.__data.get(a)},getById:function(a){return this.__data.get(this.__data.ident_by_id(a))},getIndex:function(a){return this.__data.get_ident(a)},iterate:function(a,b){this.__data.iterate(a,b)},iterator:function(){return BetaJS.Iterators.ArrayIterator.byIterate(this.iterate,this)},clear:function(){this.iterate(function(a){this.remove(a)},this)}}]),BetaJS.Class.extend("BetaJS.Collections.CollectionData",{constructor:function(a){this._inherited(BetaJS.Collections.CollectionData,"constructor"),this.__collection=a,this.__properties_data={},this.data={},this.__collection.iterate(this.__insert,this),this.__collection.on("add",this.__insert,this),this.__collection.on("remove",this.__remove,this),this.__collection.on("destroy",function(){this.destroy()},this)},collection:function(){return this.__collection},__insert:function(a){var b=BetaJS.Ids.objectId(a);this.__properties_data[b]=new BetaJS.Properties.PropertiesData(a),this.data[b]=this.__properties_data[b].data},__remove:function(a){var b=BetaJS.Ids.objectId(a);this.__properties_data[b].destroy(),delete this.__properties_data[b],delete this.data[b]}}),BetaJS.Collections.Collection.extend("BetaJS.Collections.FilteredCollection",{constructor:function(a,b){this.__parent=a,b=b||{},delete b.objects,b.compare=b.compare||a.get_compare(),this._inherited(BetaJS.Collections.FilteredCollection,"constructor",b),"filter"in b&&(this.filter=b.filter),this.__parent.iterate(function(a){return this.add(a),!0},this),this.__parent.on("add",this.add,this),this.__parent.on("remove",this.remove,this)},filter:function(){return!0},_object_changed:function(a,b,c){this._inherited(BetaJS.Collections.FilteredCollection,"_object_changed",a,b,c),this.filter(a)||this.__selfRemove(a)},destroy:function(){this.__parent.off(null,null,this),this._inherited(BetaJS.Collections.FilteredCollection,"destroy")},__selfAdd:function(a){return this._inherited(BetaJS.Collections.FilteredCollection,"add",a)},add:function(a){if(this.exists(a)||!this.filter(a))return null;var b=this.__selfAdd(a);return this.__parent.add(a),b},__selfRemove:function(a){return this._inherited(BetaJS.Collections.FilteredCollection,"remove",a)},remove:function(a){if(!this.exists(a))return null;var b=this.__selfRemove(a);return b?this.__parent.remove(a):null}}),BetaJS.Comparators={byObject:function(a){return function(b,c){for(key in a){var d=0;if(d=BetaJS.Properties.Properties.is_class_instance(b)&&BetaJS.Properties.Properties.is_class_instance(c)?BetaJS.Comparators.byValue(b.get(key)||null,c.get(key)||null):BetaJS.Comparators.byValue(b[key]||null,c[key]||null),0!==d)return d*a[key]}return 0}},byValue:function(a,b){return BetaJS.Types.is_string(a)?a.localeCompare(b):b>a?-1:a>b?1:0}},BetaJS.Sort={dependency_sort:function(a,b,c,d){var e=BetaJS.Types.is_string(b)?function(a){return a[b]}:b,f=BetaJS.Types.is_string(c)?function(a){return a[c]}:c,g=BetaJS.Types.is_string(d)?function(a){return a[d]}:d,h=a.length,i=[],j={},k={},l=null;for(l=0;h>l;++l){k[l]=!0;var m=e(a[l],l);j[m]=l,i.push({before:{},after:{}})}for(l=0;h>l;++l)BetaJS.Objs.iter(f(a[l],l)||[],function(a){var b=j[a];BetaJS.Types.is_defined(b)&&(i[l].before[b]=!0,i[b].after[l]=!0)}),BetaJS.Objs.iter(g(a[l])||[],function(a){var b=j[a];BetaJS.Types.is_defined(b)&&(i[l].after[b]=!0,i[b].before[l]=!0)});for(var n=[];!BetaJS.Types.is_empty(k);)for(l in k)if(BetaJS.Types.is_empty(i[l].after)){delete k[l],n.push(a[l]);for(bef in i[l].before)delete i[bef].after[l]}return n}},BetaJS.Locales={__data:{},get:function(a){return a in this.__data?this.__data[a]:a},register:function(a,b){b=b?b+".":"";for(var c in a)this.__data[b+c]=a[c]},view:function(a){return{context:this,base:a,get:function(a){return this.context.get(this.base+"."+a)},base:function(a){return this.context.base(this.base+"."+a)}}}},BetaJS.Time={format_time:function(a,b){var c=this.seconds(a),d=this.minutes(a),e=this.hours(a),f={hh:10>e?"0"+e:e,h:e,mm:10>d?"0"+d:d,m:d,ss:10>c?"0"+c:c,s:c};for(var g in f)b=b.replace(g,f[g]);return b},make:function(a){var b=0,c={hours:60,minutes:60,seconds:60,milliseconds:1e3};for(var d in c)b*=c[d],d in a&&(b+=a[d]);return b},seconds:function(a){return Math.floor(a/1e3)%60},minutes:function(a){return Math.floor(a/60/1e3)%60},hours:function(a){return Math.floor(a/60/60/1e3)%24},days:function(a){return Math.floor(a/24/60/60/1e3)},now:function(){var a=new Date;return a.getTime()},ago:function(a){return this.now()-a},days_ago:function(a){return this.days(this.ago(a))},format_ago:function(a){return this.days_ago(a)>1?this.format(a,{time:!1}):this.format_period(Math.max(this.ago(a),0))+" ago"},format_period:function(a){return a=Math.round(a/1e3),60>a?a+" "+BetaJS.Locales.get(1==a?"second":"seconds"):(a=Math.round(a/60),60>a?a+" "+BetaJS.Locales.get(1==a?"minute":"minutes"):(a=Math.round(a/60),24>a?a+" "+BetaJS.Locales.get(1==a?"hour":"hours"):(a=Math.round(a/24),a+" "+BetaJS.Locales.get(1==a?"day":"days"))))},format:function(a,b){b=BetaJS.Objs.extend({time:!0,date:!0,locale:!0},b||{});var c=new Date(a);return b.locale?b.date?b.time?c.toLocaleString():c.toLocaleDateString():c.toLocaleTimeString():b.date?b.time?c.toString():c.toDateString():c.toTimeString()}},BetaJS.Class.extend("BetaJS.Timers.Timer",{constructor:function(a){this._inherited(BetaJS.Timers.Timer,"constructor"),a=BetaJS.Objs.extend({once:!1,start:!0,fire:null,context:this,destroy_on_fire:!1},a),this.__delay=a.delay,this.__destroy_on_fire=a.destroy_on_fire,this.__once=a.once,this.__fire=a.fire,this.__context=a.context,this.__started=!1,a.start&&this.start()},destroy:function(){this.stop(),this._inherited(BetaJS.Timers.Timer,"destroy")},fire:function(){this.__once&&(this.__started=!1),this.__fire&&this.__fire.apply(this.__context,[this]),this.__destroy_on_fire&&this.destroy()},stop:function(){this.__started&&(this.__once?clearTimeout(this.__timer):clearInterval(this.__timer),this.__started=!1)},start:function(){if(!this.__started){var a=this;this.__timer=this.__once?setTimeout(function(){a.fire()},this.__delay):setInterval(function(){a.fire()},this.__delay),this.__started=!0}},restart:function(){this.stop(),this.start()}}),BetaJS.Templates={tokenize:function(a){if(BetaJS.Types.is_array(a))return a;var b=[],c=0;return a.replace(BetaJS.Templates.SYNTAX_REGEX(),function(d,e,f,g,h){return h>c&&b.push({type:BetaJS.Templates.TOKEN_STRING,data:BetaJS.Strings.js_escape(a.slice(c,h))}),g&&b.push({type:BetaJS.Templates.TOKEN_CODE,data:g}),e&&b.push({type:BetaJS.Templates.TOKEN_EXPR,data:e}),f&&b.push({type:BetaJS.Templates.TOKEN_ESC,data:f}),c=h+d.length,d}),b},compile:function(a,b){BetaJS.Types.is_string(a)&&(a=this.tokenize(a)),b=b||{};for(var c=b.start_index||0,d=b.end_index||a.length,e="__p+='",f=c;d>f;++f)switch(a[f].type){case BetaJS.Templates.TOKEN_STRING:e+=a[f].data;break;case BetaJS.Templates.TOKEN_CODE:e+="';\n"+a[f].data+"\n__p+='";break;case BetaJS.Templates.TOKEN_EXPR:e+="'+\n((__t=("+a[f].data+"))==null?'':__t)+\n'";break;case BetaJS.Templates.TOKEN_ESC:e+="'+\n((__t=("+a[f].data+"))==null?'':BetaJS.Strings.htmlentities(__t))+\n'"}e+="';\n",e="with(obj||{}){\n"+e+"}\n",e="var __t,__p='',__j=Array.prototype.join,echo=function(){__p+=__j.call(arguments,'');};\n"+e+"return __p;\n";var g=new Function("obj",e),h=function(a){return g.call(this,a)};return h.source="function(obj){\n"+e+"}",h}},BetaJS.Templates.SYNTAX={OPEN:"{%",CLOSE:"%}",MODIFIER_CODE:"",MODIFIER_EXPR:"=",MODIFIER_ESC:"-"},BetaJS.Templates.SYNTAX_REGEX=function(){var a=BetaJS.Templates.SYNTAX;return BetaJS.Templates.SYNTAX_REGEX_CACHED||(BetaJS.Templates.SYNTAX_REGEX_CACHED=new RegExp(a.OPEN+a.MODIFIER_EXPR+"([\\s\\S]+?)"+a.CLOSE+"|"+a.OPEN+a.MODIFIER_ESC+"([\\s\\S]+?)"+a.CLOSE+"|"+a.OPEN+a.MODIFIER_CODE+"([\\s\\S]+?)"+a.CLOSE+"|$","g")),BetaJS.Templates.SYNTAX_REGEX_CACHED},BetaJS.Templates.TOKEN_STRING=1,BetaJS.Templates.TOKEN_CODE=2,BetaJS.Templates.TOKEN_EXPR=3,BetaJS.Templates.TOKEN_ESC=4,BetaJS.Class.extend("BetaJS.Templates.Template",{constructor:function(a){this._inherited(BetaJS.Templates.Template,"constructor"),this.__tokens=BetaJS.Templates.tokenize(a),this.__compiled=BetaJS.Templates.compile(this.__tokens)},evaluate:function(a){return this.__compiled.apply(this,[a])}},{bySelector:function(a){return new this(BetaJS.$(a).html())}}),BetaJS.Class.extend("BetaJS.Channels.Sender",[BetaJS.Events.EventsMixin,{send:function(a,b){this.trigger("send",a,b),this._send(a,b)},_send:function(){}}]),BetaJS.Class.extend("BetaJS.Channels.Receiver",[BetaJS.Events.EventsMixin,{_receive:function(a,b){this.trigger("receive",a,b),this.trigger("receive:"+a,b)}}]),BetaJS.Channels.Sender.extend("BetaJS.Channels.ReveiverSender",{constructor:function(a){this._inherited(BetaJS.Channels.ReveiverSender,"constructor"),this.__receiver=a},_send:function(a,b){this.__receiver._receive(a,b)}}),BetaJS.Class.extend("BetaJS.Channels.SenderMultiplexer",{constructor:function(a,b){this._inherited(BetaJS.Channels.SenderMultiplexer,"constructor"),this.__sender=a,this.__prefix=b},_send:function(a,b){this.__sender.send(prefix+":"+a,b)}}),BetaJS.Class.extend("BetaJS.Channels.ReceiverMultiplexer",{constructor:function(a,b){this._inherited(BetaJS.Channels.ReceiverMultiplexer,"constructor"),this.__receiver=a,this.__prefix=b,this.__receiver.on("receive",function(a,b){BetaJS.Strings.starts_with(a,this.__prefix+":")&&this._receive(BetaJS.Strings.strip_start(a,this.__prefix+":"),b)},this)}}),BetaJS.Class.extend("BetaJS.Channels.TransportChannel",{constructor:function(a,b,c){this._inherited(BetaJS.Channels.TransportChannel,"constructor"),this.__sender=a,this.__receiver=b,this.__options=BetaJS.Objs.extend(c,{timeout:1e4,tries:1,timer:500}),this.__receiver.on("receive:send",function(a){this.__reply(a)},this),this.__receiver.on("receive:reply",function(a){this.__complete(a)},this),this.__sent_id=0,this.__sent={},this.__received={},this.__timer=this._auto_destroy(new BetaJS.Timers.Timer({delay:this.__options.timer,context:this,fire:this.__maintenance}))},_reply:function(){},send:function(a,b,c,d){d=d||{},d.stateless?this.__sender.send("send",{message:a,data:b,stateless:!0}):(this.__sent_id++,this.__sent[this.__sent_id]={message:a,data:b,tries:1,time:BetaJS.Time.now(),id:this.__sent_id,callbacks:c},this.__sender.send("send",{message:a,data:b,id:this.__sent_id}))},__reply:function(a){return a.stateless?void this._reply(a.message,a.data):void(this.__received[a.id]?this.__received[a.id].returned&&this.__sender.send("reply",{id:a.id,reply:a.reply,success:a.success}):(this.__received[a.id]=a,this.__received[a.id].time=BetaJS.Time.now(),this.__received[a.id].returned=!1,this.__received[a.id].success=!1,this._reply(a.message,a.data,{context:this,success:function(b){this.__received[a.id].reply=b,this.__received[a.id].success=!0},complete:function(){this.__received[a.id].returned=!0,this.__sender.send("reply",{id:a.id,reply:a.reply,success:a.success})}})))},__complete:function(a){this.__sent[a.id]&&(BetaJS.SyncAsync.callback(this.__sent[a.id].callbacks,"success",a.reply),delete this.__sent[a.id])},__maintenance:function(){var a=BetaJS.Time.now();for(var b in this.__received){var c=this.__received[b];c.time+this.__options.tries*this.__options.timeout<=a&&delete this.__received[b]}for(var d in this.__sent){var e=this.__sent[d];e.time+e.tries*this.__options.timeout<=a&&(e.tries<this.__options.tries?(e.tries++,this.__sender.send("send",{message:e.message,data:e.data,id:e.id})):(BetaJS.SyncAsync.callback(e.callbacks,"failure",{message:e.message,data:e.data}),delete this.__sent[d]))}}}),BetaJS.Class.extend("BetaJS.RMI.Stub",[BetaJS.Classes.InvokerMixin,BetaJS.Events.EventsMixin,{intf:[],constructor:function(){this._inherited(BetaJS.RMI.Stub,"constructor"),this.invoke_delegate("invoke",this.intf)},destroy:function(){this.trigger("destroy"),this._inherited(BetaJS.RMI.Stub,"destroy")},invoke:function(a){var b={context:this,success:function(a){this.__success=a,this.is_complete&&this.is_success&&this.__success.call(this,this.result)},failure:function(a){this.__failure=a,this.is_complete&&this.is_failure&&this.__failure.call(this)}};return this.trigger("send",a,BetaJS.Functions.getArguments(arguments,1),{context:this,success:function(a){b.result=a,b.is_complete=!0,b.is_success=!0,b.__success&&b.__success.call(this,a)},failure:function(){b.is_complete=!0,b.is_failure=!0,b.__failure&&b.__failure.call(this)}}),b}}]),BetaJS.Class.extend("BetaJS.RMI.Skeleton",[BetaJS.Events.EventsMixin,{intf:[],_intf:{},constructor:function(){this._inherited(BetaJS.RMI.Skeleton,"constructor");for(var a=0;a<this.intf.length;++a)this._intf[this.intf[a]]=!0},destroy:function(){this.trigger("destroy"),this._inherited(BetaJS.RMI.Skeleton,"destroy")},invoke:function(a,b,c,d){return this._intf[a]?(b.unshift({callbacks:c,caller:d}),void this[a].apply(this,b)):void this._failure(c)},_success:function(a,b){a=a.callbacks?a.callbacks:a,BetaJS.SyncAsync.callback(a,"success",b)},_failure:function(a){a=a.callbacks?a.callbacks:a,BetaJS.SyncAsync.callback(a,"failure")}}]),BetaJS.Class.extend("BetaJS.RMI.Server",{constructor:function(){this._inherited(BetaJS.RMI.Server,"constructor"),this.__channels=new BetaJS.Lists.ObjectIdList,this.__instances={}},destroy:function(){this.__channels.iterate(this.unregisterClient,this),BetaJS.Objs.iter(this.__instances,function(a){this.unregisterInstance(a.instance)},this),this.__channels.destroy(),this._inherited(BetaJS.RMI.Server,"destroy")},registerInstance:function(a,b){b=b||{},this.__instances[BetaJS.Ids.objectId(a,b.name)]={instance:a,options:b}},unregisterInstance:function(a){delete this.__instances[BetaJS.Ids.objectId(a)],a.destroy()},registerClient:function(a){var b=this;this.__channels.add(a),a._reply=function(c,d,e){var f=c.split(":");2==f.length?b._invoke(a,f[0],f[1],d,e):BetaJS.SyncAsync.callback(e,"failure")}},unregisterClient:function(a){this.__channels.remove(a),a._reply=null},_invoke:function(a,b,c,d,e){var f=this.__instances[b];return f?(f=f.instance,void f.invoke(c,d,e,a)):void BetaJS.SyncAsync.callback(e,"failure")}}),BetaJS.Class.extend("BetaJS.RMI.Client",{constructor:function(){this._inherited(BetaJS.RMI.Client,"constructor"),this.__channel=null,this.__instances={}},destroy:function(){this.__channel&&this.disconnect(),this._inherited(BetaJS.RMI.Client,"destroy")},connect:function(a){this.__channel||(this.__channel=a)},disconnect:function(){this.__channel&&(this.__channel=null,BetaJS.Objs.iter(this.__instances,function(a){this.release(a)},this))},acquire:function(a,b){if(this.__instances[b])return this.__instances[b];var c=new a;return this.__instances[BetaJS.Ids.objectId(c,b)]=c,c.on("send",function(a,c,d){this.__channel.send(b+":"+a,c,d)},this),c},release:function(a){var b=BetaJS.Ids.objectId(a);this.__instances[b]&&(a.off(null,null,this),a.destroy(),delete this.__instances[b])}}),BetaJS.Class.extend("BetaJS.Net.AbstractAjax",{constructor:function(a){this._inherited(BetaJS.Net.AbstractAjax,"constructor"),this.__options=BetaJS.Objs.extend({method:"GET",data:{}},a)},syncCall:function(a){try{return this._syncCall(BetaJS.Objs.extend(BetaJS.Objs.clone(this.__options,1),a))}catch(b){throw b=BetaJS.Exceptions.ensure(b),b.assert(BetaJS.Net.AjaxException),b}},asyncCall:function(a,b){this._asyncCall(BetaJS.Objs.extend(BetaJS.Objs.clone(this.__options,1),a),b)},call:function(a,b){return b?this.asyncCall(a,b):this.syncCall(a)},_syncCall:function(){},_asyncCall:function(){}}),BetaJS.Exceptions.Exception.extend("BetaJS.Net.AjaxException",{constructor:function(a,b,c){this._inherited(BetaJS.Net.AjaxException,"constructor",a+": "+b),this.__status_code=a,this.__status_text=b,this.__data=c},status_code:function(){return this.__status_code},status_text:function(){return this.__status_text},data:function(){return this.__data},json:function(){var a=this._inherited(BetaJS.Net.AjaxException,"json");return a.data=this.data(),a}}),BetaJS.Channels.Sender.extend("BetaJS.Net.SocketSenderChannel",{constructor:function(a,b){this._inherited(BetaJS.Net.SocketSenderChannel,"constructor"),this.__socket=a,this.__message=b},_send:function(a,b){this.__socket.emit(this.__message,{message:a,data:b})}}),BetaJS.Channels.Receiver.extend("BetaJS.Net.SocketReceiverChannel",{constructor:function(a,b){this._inherited(BetaJS.Net.SocketReceiverChannel,"constructor");var c=this;a.on(b,function(a){c._receive(a.message,a.data)})}}),BetaJS.Net=BetaJS.Net||{},BetaJS.Net.HttpHeader={HTTP_STATUS_OK:200,HTTP_STATUS_CREATED:201,HTTP_STATUS_PAYMENT_REQUIRED:402,HTTP_STATUS_FORBIDDEN:403,HTTP_STATUS_NOT_FOUND:404,HTTP_STATUS_PRECONDITION_FAILED:412,HTTP_STATUS_INTERNAL_SERVER_ERROR:500,format:function(a,b){var c="";return c=a==this.HTTP_STATUS_OK?"OK":a==this.HTTP_STATUS_CREATED?"Created":a==this.HTTP_STATUS_PAYMENT_REQUIRED?"Payment Required":a==this.HTTP_STATUS_FORBIDDEN?"Forbidden":a==this.HTTP_STATUS_NOT_FOUND?"Not found":a==this.HTTP_STATUS_PRECONDITION_FAILED?"Precondition Failed":a==this.HTTP_STATUS_INTERNAL_SERVER_ERROR?"Internal Server Error":"Other Error",b?a+" "+c:c}},BetaJS.Net=BetaJS.Net||{},BetaJS.Net.Uri={build:function(a){var b="";return a.username&&(b+=a.username+":"),a.password&&(b+=a.password+"@"),b+=a.server,a.port&&(b+=":"+a.port),a.path&&(b+="/"+a.path),b},encodeUriParams:function(a,b){b=b||"";var c=[];return BetaJS.Objs.iter(a,function(a,d){BetaJS.Types.is_object(a)?c=c.concat(this.encodeUriParams(a,b+d+"_")):c.push(b+d+"="+encodeURI(a))},this),c.join("&")},appendUriParams:function(a,b,c){return BetaJS.Types.is_empty(b)?a:a+(-1!=a.indexOf("?")?"&":"?")+this.encodeUriParams(b,c)},parse:function(a,b){for(var c=b?this.__parse_strict_regex:this.__parse_loose_regex,d=c.exec(a),e={},f=0;f<this.__parse_key.length;++f)e[this.__parse_key[f]]=d[f]||"";return e.queryKey={},e[this.__parse_key[12]].replace(this.__parse_key_parser,function(a,b,c){b&&(e.queryKey[b]=c)}),e},__parse_strict_regex:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,__parse_loose_regex:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,__parse_key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],__parse_key_parser:/(?:^|&)([^&=]*)=?([^&]*)/g},BetaJS.Queries={subsumizes:function(a,b){if(!BetaJS.Types.is_object(a)||!BetaJS.Types.is_object)return a==b;for(var c in a)if(!(c in b&&this.subsumizes(a[c],b[c])))return!1;return!0},__increase_dependency:function(a,b){return a in b?b[a]++:b[a]=1,b},__dependencies_queries:function(a,b){return BetaJS.Objs.iter(a,function(a){b=this.__dependencies_query(a,b)},this),b},__dependencies_query:function(a,b){for(key in a)b=this.__dependencies_pair(key,a[key],b);return b},__dependencies_pair:function(a,b,c){return"$or"==a||"$and"==a?this.__dependencies_queries(b,c):this.__increase_dependency(a,c)},dependencies:function(a){return this.__dependencies_query(a,{})},__evaluate_query:function(a,b){for(var c in a)if(!this.__evaluate_pair(c,a[c],b))return!1;return!0},__evaluate_pair:function(a,b,c){return"$or"==a?this.__evaluate_or(b,c):"$and"==a?this.__evaluate_and(b,c):this.__evaluate_value(b,c[a])},__evaluate_value:function(a,b){if(BetaJS.Types.is_object(a)){var c=!0;return BetaJS.Objs.iter(a,function(a,d){"$in"==d&&(c=c&&BetaJS.Objs.contains_value(a,b)),"$gt"==d&&(c=c&&b>=a),"$gtic"==d&&(c=c&&b.toLowerCase()>=a.toLowerCase()),"$lt"==d&&(c=c&&a>=b),"$ltic"==d&&(c=c&&b.toLowerCase()<=a.toLowerCase()),"$sw"==d&&(c=c&&0===b.indexOf(a)),"$swic"==d&&(c=c&&0===b.toLowerCase().indexOf(a.toLowerCase()))},this),c}return a==b},__evaluate_or:function(a,b){return BetaJS.Objs.iter(a,function(a){return this.__evaluate_query(a,b)?!0:void 0},this),!1},__evaluate_and:function(a,b){return BetaJS.Objs.iter(a,function(a){return this.__evaluate_query(a,b)?void 0:!1},this),!0},format:function(a){return BetaJS.Class.is_class_instance(a)?a.format():JSON.stringify(a)},overloaded_evaluate:function(a,b){return BetaJS.Class.is_class_instance(a)?a.evaluate(b):BetaJS.Types.is_function(a)?a(b):this.evaluate(a,b)},evaluate:function(a,b){return this.__evaluate_query(a,b)},emulate:function(a,b,c){var d=b.apply(c||this,{}),e=d;return d?BetaJS.Types.is_array(d)&&(e=BetaJS.Iterators.ArrayIterator(d)):e=BetaJS.Iterators.ArrayIterator([]),new BetaJS.Iterators.FilteredIterator(e,function(b){return BetaJS.Queries.evaluate(a,b)})}},BetaJS.Queries.Constrained={make:function(a,b){return{query:a,options:b||{}}},is_constrained:function(a){return a&&(a.query||a.options)},format:function(a){var b=a.query;a.query=BetaJS.Queries.format(b);var c=JSON.stringify(a);return a.query=b,c},emulate:function(a,b,c,d,e){var f=a.query||{},g=a.options||{},h={},i={};"sort"in g&&"sort"in b&&(i.sort=g.sort),h=f,("query"in b||BetaJS.Types.is_empty(f))&&(h=f,(!g.sort||"sort"in b)&&("skip"in g&&"skip"in b&&(i.skip=g.skip),"limit"in g&&"limit"in b&&(i.limit=g.limit,"skip"in g&&!("skip"in b)&&(i.limit+=g.skip))));var j=[h,i];e&&j.push(e);var k=function(a){var c=a;return null===a?c=new BetaJS.Iterators.ArrayIterator([]):BetaJS.Types.is_array(a)&&(c=new BetaJS.Iterators.ArrayIterator(a)),"query"in b||BetaJS.Types.is_empty(f)||(c=new BetaJS.Iterators.FilteredIterator(c,function(a){return BetaJS.Queries.evaluate(f,a)})),"sort"in g&&!("sort"in i)&&(c=new BetaJS.Iterators.SortedIterator(c,BetaJS.Comparators.byObject(g.sort))),"skip"in g&&!("skip"in i)&&(c=new BetaJS.Iterators.SkipIterator(c,g.skip)),"limit"in g&&!("limit"in i)&&(c=new BetaJS.Iterators.LimitIterator(c,g.limit)),e&&e.success&&e.success(c),c},l=function(a){if(!e||!e.exception)throw a;e.exception(a)};if(e)c.apply(d||this,[h,i,{success:k,exception:l,sync:e.sync,context:e.context||this}]);else try{var m=c.apply(d||this,[h,i]);return k(m)}catch(n){l(n)}return!0},subsumizes:function(a,b){if(qopt=a.options||{},qopt2=b.options||{},qskip=qopt.skip||0,qskip2=qopt2.skip||0,qlimit=qopt.limit||null,qlimit2=qopt2.limit||null,qsort=qopt.sort,qsort2=qopt2.sort,qskip>qskip2)return!1;if(qlimit){if(!qlimit2)return!1;if(qlimit2+qskip2>qlimit+qskip)return!1}return(qskip||qlimit)&&(qsort||qsort2)&&qsort!=qsort2?!1:BetaJS.Queries.subsumizes(a.query,b.query)}},BetaJS.Class.extend("BetaJS.Queries.AbstractQueryModel",{register:function(){},executable:function(){}}),BetaJS.Queries.AbstractQueryModel.extend("BetaJS.Queries.DefaultQueryModel",{__queries:{},exists:function(a){return BetaJS.Queries.Constrained.format(a)in this.__queries
},executable:function(a){if(this.exists(a))return!0;var b=!1;return BetaJS.Objs.iter(this.__queries,function(c){return b=BetaJS.Queries.Constrained.subsumizes(c,a),!b},this),b},register:function(a){BetaJS.Objs.iter(this.__queries,function(b){BetaJS.Queries.Constrained.subsumizes(a,b)&&delete this.__queries[BetaJS.Queries.Constrained.format(b)]},this),this.__queries[BetaJS.Queries.Constrained.format(a)]=a}}),BetaJS.Collections.Collection.extend("BetaJS.Collections.QueryCollection",{constructor:function(a,b,c,d){this._source=a,this._inherited(BetaJS.Collections.QueryCollection,"constructor",c),this._options=BetaJS.Objs.extend({forward_steps:null,backward_steps:null,range:null},c),null!==b&&this.set_query(b,d)},query:function(){return this._query},set_query:function(a,b){b&&(b.context=b.context||this),this._query=BetaJS.Objs.extend({query:{},options:{}},a),this._query.options.skip=this._query.options.skip||0,this._query.options.limit=this._query.options.limit||null,this._query.options.sort=this._query.options.sort||{},this._count=0,this.__execute_query(this._query.options.skip,this._query.options.limit,!0,b)},__sub_query:function(a,b){this._source.query(this._query.query,a,b)},__execute_query:function(a,b,c,d){a=Math.max(a,0);var e={};this._query.options.sort&&!BetaJS.Types.is_empty(this._query.options.sort)&&(e.sort=this._query.options.sort),c?(a>0&&(e.skip=a),null!==b&&(e.limit=b),this.__sub_query(e,{context:this,success:function(c){var e=c.asArray();this._query.options.skip=a,this._query.options.limit=b,this._count=!b||e.length<b?a+e.length:null,this.clear(),this.add_objects(e),BetaJS.SyncAsync.callback(d,"success")}})):a<this._query.options.skip?(b=this._query.options.skip-a,a>0&&(e.skip=a),e.limit=b,this.__sub_query(e,{context:this,success:function(b){var c=b.asArray();this._query.options.skip=a;var e=this.add_objects(c);this._query.options.limit=null===this._query.options.limit?null:this._query.options.limit+e,BetaJS.SyncAsync.callback(d,"success")}})):a>=this._query.options.skip&&null!==this._query.options.limit&&(!b||a+b>this._query.options.skip+this._query.options.limit)&&(b=a+b-(this._query.options.skip+this._query.options.limit),a=this._query.options.skip+this._query.options.limit,a>0&&(e.skip=a),b&&(e.limit=b),this.__sub_query(e,{context:this,success:function(c){var e=c.asArray(),f=this.add_objects(e);this._query.options.limit=this._query.options.limit+f,b>e.length&&(this._count=a+f),BetaJS.SyncAsync.callback(d,"success")}}))},increase_forwards:function(a,b){a=a?a:this._options.forward_steps,a&&null!==this._query.options.limit&&this.__execute_query(this._query.options.skip+this._query.options.limit,a,!1,b)},increase_backwards:function(a){a=a?a:this._options.backward_steps,a&&this._query.options.skip>0&&(a=Math.min(a,this._query.options.skip),this.__execute_query(this._query.options.skip-a,a,!1))},paginate:function(a){this.__execute_query(this._options.range*a,this._options.range,!0)},paginate_index:function(){return this._options.range?Math.floor(this._query.options.skip/this._options.range):null},paginate_count:function(){return this._count&&this._options.range?Math.ceil(this._count/this._options.range):null},next:function(){var a=this.paginate_index();if(a){var b=this.paginate_count();(!b||a<this.paginate_count()-1)&&this.paginate(a+1)}},prev:function(){var a=this.paginate_index();a&&a>0&&this.paginate(a-1)},isComplete:function(){return null!==this._count}}),BetaJS.Collections.QueryCollection.extend("BetaJS.Collections.ActiveQueryCollection",{constructor:function(a,b,c,d){this._inherited(BetaJS.Collections.ActiveQueryCollection,"constructor",a,b,c,d),a.on("create",this.__active_create,this),a.on("remove",this.__active_remove,this),a.on("update",this.__active_update,this)},destroy:function(){this._source.off(null,null,this),this._inherited(BetaJS.Collections.ActiveQueryCollection,"destroy")},is_valid:function(a){return BetaJS.Queries.evaluate(this.query().query,a.getAll())},__active_create:function(a){this.is_valid(a)&&!this.exists(a)&&(this.add(a),this._count=this._count+1,null!==this._query.options.limit&&(this._query.options.limit=this._query.options.limit+1))},__active_remove:function(a){this.exists(a)&&(this.remove(a),this._count=this._count-1,null!==this._query.options.limit&&(this._query.options.limit=this._query.options.limit-1))},__active_update:function(a){this.is_valid(a)?this.__active_create(a):this.__active_remove(a)}}),BetaJS.Exceptions.Exception.extend("BetaJS.Stores.StoreException"),BetaJS.Class.extend("BetaJS.Stores.ListenerStore",[BetaJS.Events.EventsMixin,{constructor:function(a){this._inherited(BetaJS.Stores.ListenerStore,"constructor"),a=a||{},this._id_key=a.id_key||"id"},id_key:function(){return this._id_key},_inserted:function(a,b){this.trigger("insert",a,b)},_removed:function(a,b){this.trigger("remove",a,b)},_updated:function(a,b,c){this.trigger("update",a,b,c)}}]),BetaJS.Stores.BaseStore=BetaJS.Stores.ListenerStore.extend("BetaJS.Stores.BaseStore",[BetaJS.SyncAsync.SyncAsyncMixin,{constructor:function(a){this._inherited(BetaJS.Stores.BaseStore,"constructor",a),a=a||{},this._id_key=a.id_key||"id",this._create_ids=a.create_ids||!1,this._last_id=1,this._supportsSync=!0,this._supportsAsync=!0,this._query_model="query_model"in a?a.query_model:null},_insert:function(){throw new BetaJS.Stores.StoreException("unsupported: insert")},_remove:function(){throw new BetaJS.Stores.StoreException("unsupported: remove")},_get:function(){throw new BetaJS.Stores.StoreException("unsupported: get")},_update:function(){throw new BetaJS.Stores.StoreException("unsupported: update")},_query_capabilities:function(){return{}},_query:function(){throw new BetaJS.Stores.StoreException("unsupported: query")},_new_id:function(){},insert:function(a,b){var c=null;if(BetaJS.Types.is_array(a)&&(c=a[1],a=a[0]),this._create_ids&&!(this._id_key in a&&a[this._id_key])){for(;this.get(this._last_id);)this._last_id++;a[this._id_key]=this._last_id}return this.then(this._insert,[a],b,function(a,b){this._inserted(a,c),BetaJS.SyncAsync.callback(b,"success",a)})},insert_all:function(a,b,c){var d=null;if(arguments.length>3&&(d=arguments[3]),c&&this._query_model&&(this.trigger("query_register",c),this._query_model.register(c)),b){var e=this,f=function(c){return c>=a.length?void BetaJS.SyncAsync.callback(b,"success"):void this.insert(d?[a[c],d]:a[c],BetaJS.SyncAsync.mapSuccess(b,function(){f.call(e,c+1)}))};f.call(this,0)}else for(var g=0;g<a.length;++g)this.insert(d?[a[g],d]:a[g])},remove:function(a,b){var c=null;return BetaJS.Types.is_array(a)&&(c=a[1],a=a[0]),this.then(this._remove,[a],b,function(b,d){this._removed(a,c),BetaJS.SyncAsync.callback(d,"success",a)})},get:function(a,b){return this.delegate(this._get,[a],b)},update:function(a,b,c){var d=null;return BetaJS.Types.is_array(b)&&(d=b[1],b=b[0]),this.then(this._update,[a,b],c,function(a,c){this._updated(a,b,d),BetaJS.SyncAsync.callback(c,"success",a,b)})},query:function(a,b,c){if(b&&(b.limit&&(b.limit=parseInt(b.limit,10)),b.skip&&(b.skip=parseInt(b.skip,10))),this._query_model&&!this._query_model.executable({query:a,options:b})){this.trigger("query_miss",{query:a,options:b});var d=new BetaJS.Stores.StoreException("Cannot execute query");if(!c)throw d;return c.exception.call(c.context||this,d),null}var e=function(c){return BetaJS.Queries.Constrained.emulate(BetaJS.Queries.Constrained.make(a,b||{}),this._query_capabilities(),this._query,this,c)};return this.either(c,e,e)},_query_applies_to_id:function(a,b){var c=this.get(b);return c&&BetaJS.Queries.overloaded_evaluate(a,c)},clear:function(a){return this.then(this.query,[{},{}],a,function(a,b){for(var c=[];a.hasNext();)c.push(this.remove,[a.next().id]);return this.join(c,b)})},_ensure_index:function(){},ensure_index:function(a){this._ensure_index(a)},perform:function(a,b){var c=BetaJS.Objs.keyByIndex(a),d=BetaJS.Objs.valueByIndex(a);if("insert"==c)this.insert(d,b);else if("remove"==c)this.remove(d,b);else{if("update"!=c)throw new BetaJS.Stores.StoreException("unsupported: perform "+c);this.update(BetaJS.Objs.keyByIndex(d),BetaJS.Objs.valueByIndex(d),b)}},bulk:function(a,b,c){var d=[];if(c){var e=function(){d.length<a.length?this.perform(a[d.length],{context:this,success:function(){d.push(!0),e.apply(this)},exception:function(a){d.push(!1),b?e.apply(this):c.exception.apply(c.context||this,a)}}):c.success.call(c.context||this,d)};e.apply(this)}else for(var f=0;f<a.length;++f)try{this.perform(a[f]),d.push(!0)}catch(g){if(d.push(!1),!b)throw g}return d}}]),BetaJS.Stores.BaseStore.extend("BetaJS.Stores.AssocStore",{_read_key:function(){},_write_key:function(){},_remove_key:function(){},_iterate:function(){},constructor:function(a){a=a||{},a.create_ids=!0,this._inherited(BetaJS.Stores.AssocStore,"constructor",a),this._supportsAsync=!1},_insert:function(a){return this._write_key(a[this._id_key],a),a},_remove:function(a){var b=this._read_key(a);return b&&!this._remove_key(a)?null:b},_get:function(a){return this._read_key(a)},_update:function(a,b){var c=this._get(a);return c&&(delete b[this._id_key],BetaJS.Objs.extend(c,b),this._write_key(a,c)),c},_query:function(){return this._iterate()}}),BetaJS.Stores.AssocStore.extend("BetaJS.Stores.MemoryStore",{constructor:function(a){this._inherited(BetaJS.Stores.MemoryStore,"constructor",a),this.__data={}},_read_key:function(a){return this.__data[a]},_write_key:function(a,b){this.__data[a]=b},_remove_key:function(a){delete this.__data[a]},_iterate:function(){return new BetaJS.Iterators.ObjectValuesIterator(this.__data)}}),BetaJS.Stores.BaseStore.extend("BetaJS.Stores.DumbStore",{_read_last_id:function(){},_write_last_id:function(){},_remove_last_id:function(){},_read_first_id:function(){},_write_first_id:function(){},_remove_first_id:function(){},_read_item:function(){},_write_item:function(){},_remove_item:function(){},_read_next_id:function(){},_write_next_id:function(){},_remove_next_id:function(){},_read_prev_id:function(){},_write_prev_id:function(){},_remove_prev_id:function(){},constructor:function(a){a=a||{},a.create_ids=!0,this._inherited(BetaJS.Stores.DumbStore,"constructor",a),this._supportsAsync=!1},_insert:function(a){var b=this._read_last_id(),c=a[this._id_key];return null!==b?(this._write_next_id(b,c),this._write_prev_id(c,b)):this._write_first_id(c),this._write_last_id(c),this._write_item(c,a),a},_remove:function(a){var b=this._read_item(a);if(b){this._remove_item(a);var c=this._read_next_id(a),d=this._read_prev_id(a);null!==c?(this._remove_next_id(a),null!==d?(this._remove_prev_id(a),this._write_next_id(d,c),this._write_prev_id(c,d)):(this._remove_prev_id(c),this._write_first_id(c))):null!==d?(this._remove_next_id(d),this._write_last_id(d)):(this._remove_first_id(),this._remove_last_id())}return b},_get:function(a){return this._read_item(a)},_update:function(a,b){var c=this._get(a);return c&&(delete b[this._id_key],BetaJS.Objs.extend(c,b),this._write_item(a,c)),c},_query_capabilities:function(){return{query:!0}},_query:function(a){var b=new BetaJS.Iterators.Iterator,c=this,d=this._read_first_id();return BetaJS.Objs.extend(b,{__id:null===d?1:d,__store:c,__query:a,hasNext:function(){var b=this.__store._read_last_id();if(null===b)return!1;for(;this.__id<b&&!this.__store._read_item(this.__id);)this.__id++;for(;this.__id<=b;){if(this.__store._query_applies_to_id(a,this.__id))return!0;this.__id<b?this.__id=this.__store._read_next_id(this.__id):this.__id++}return!1},next:function(){if(this.hasNext()){var a=this.__store.get(this.__id);return this.__id==this.__store._read_last_id()?this.__id++:this.__id=this.__store._read_next_id(this.__id),a}return null}}),b}}),BetaJS.Stores.DumbStore.extend("BetaJS.Stores.AssocDumbStore",{_read_key:function(){},_write_key:function(){},_remove_key:function(){},__read_id:function(a){var b=this._read_key(a);return b?parseInt(b,10):null},_read_last_id:function(){return this.__read_id("last_id")},_write_last_id:function(a){this._write_key("last_id",a)},_remove_last_id:function(){this._remove_key("last_id")},_read_first_id:function(){return this.__read_id("first_id")},_write_first_id:function(a){this._write_key("first_id",a)},_remove_first_id:function(){this._remove_key("first_id")},_read_item:function(a){return this._read_key("item_"+a)},_write_item:function(a,b){this._write_key("item_"+a,b)},_remove_item:function(a){this._remove_key("item_"+a)},_read_next_id:function(a){return this.__read_id("next_"+a)},_write_next_id:function(a,b){this._write_key("next_"+a,b)},_remove_next_id:function(a){this._remove_key("next_"+a)},_read_prev_id:function(a){return this.__read_id("prev_"+a)},_write_prev_id:function(a,b){this._write_key("prev_"+a,b)},_remove_prev_id:function(a){this._remove_key("prev_"+a)}}),BetaJS.Stores.AssocDumbStore.extend("BetaJS.Stores.LocalStore",{constructor:function(a){this._inherited(BetaJS.Stores.LocalStore,"constructor",a),this.__prefix=a.prefix},__key:function(a){return this.__prefix+a},_read_key:function(a){var b=this.__key(a);return b in localStorage?JSON.parse(localStorage[b]):null},_write_key:function(a,b){localStorage[this.__key(a)]=JSON.stringify(b)},_remove_key:function(a){delete localStorage[this.__key(a)]}}),BetaJS.Stores.BaseStore.extend("BetaJS.Stores.DualStore",{constructor:function(a,b,c){c=BetaJS.Objs.extend({create_options:{},update_options:{},delete_options:{},get_options:{},query_options:{}},c||{}),c.id_key=a._id_key,this.__first=a,this.__second=b,this._inherited(BetaJS.Stores.DualStore,"constructor",c),this._supportsSync=a.supportsSync()&&b.supportsSync(),this._supportsAsync=a.supportsAsync()||b.supportsAsync(),this.__create_options=BetaJS.Objs.extend({start:"first",strategy:"then",auto_replicate:"first"},c.create_options),this.__update_options=BetaJS.Objs.extend({start:"first",strategy:"then",auto_replicate:"first"},c.update_options),this.__remove_options=BetaJS.Objs.extend({start:"first",strategy:"then",auto_replicate:"first"},c.delete_options),this.__get_options=BetaJS.Objs.extend({start:"first",strategy:"or",clone:!0,clone_second:!1,or_on_null:!0},c.get_options),this.__query_options=BetaJS.Objs.extend({start:"first",strategy:"or",clone:!0,clone_second:!1,or_on_null:!0},c.query_options),this.__first.on("insert",this.__inserted_first,this),this.__second.on("insert",this.__inserted_second,this),this.__first.on("update",this.__updated_first,this),this.__second.on("update",this.__updated_second,this),this.__first.on("remove",this.__removed_first,this),this.__second.on("remove",this.__removed_second,this)},__inserted_first:function(a,b){b&&b.dual_insert||(("first"==this.__create_options.auto_replicate||"both"==this.__create_options.auto_replicate)&&this.__second.insert([a,{dual_insert:!0}],{}),this._inserted(a))},__inserted_second:function(a,b){b&&b.dual_insert||(("second"==this.__create_options.auto_replicate||"both"==this.__create_options.auto_replicate)&&this.__first.insert([a,{dual_insert:!0}],{}),this._inserted(a))},__updated_first:function(a,b,c){c&&c.dual_update||(("first"==this.__update_options.auto_replicate||"both"==this.__update_options.auto_replicate)&&this.__second.update(a[this.id_key()],[b,{dual_update:!0}],{}),this._updated(a,b))},__updated_second:function(a,b,c){c&&c.dual_update||(("second"==this.__update_options.auto_replicate||"both"==this.__update_options.auto_replicate)&&this.__first.update(a[this.id_key()],[b,{dual_update:!0}],{}),this._updated(a,b))},__removed_first:function(a,b){b&&b.dual_remove||(("first"==this.__remove_options.auto_replicate||"both"==this.__remove_options.auto_replicate)&&this.__second.remove([a,{dual_remove:!0}],{}),this._removed(a))},__removed_second:function(a,b){b&&b.dual_remove||(("second"==this.__remove_options.auto_replicate||"both"==this.__remove_options.auto_replicate)&&this.__first.remove([a,{dual_remove:!0}],{}),this._removed(a))},first:function(){return this.__first},second:function(){return this.__second},_insert:function(a,b){var c=this.__first,d=this.__second;"first"!=this.__create_options.start&&(c=this.__second,d=this.__first);var e=this.__create_options.strategy;if(b)if("then"==e)c.insert([a,{dual_insert:!0}],{success:function(a){d.insert([a,{dual_insert:!0}],b)},exception:b.exception});else{if("or"==e)return c.insert([a,{dual_insert:!0}],{success:b.success,exception:function(){d.insert([a,{dual_insert:!0}],b)}});c.insert([a,{dual_insert:!0}],b)}else{if("then"==e)return d.insert([c.insert([a,{dual_insert:!0}]),{dual_insert:!0}]);if("or"!=e)return c.insert([a,{dual_insert:!0}]);try{return c.insert([a,{dual_insert:!0}])}catch(f){return d.insert([a,{dual_insert:!0}])}}return!0},_update:function(a,b,c){var d=this.__first,e=this.__second;"first"!=this.__update_options.start&&(d=this.__second,e=this.__first);var f=this.__update_options.strategy;if(c)if("then"==f)d.update(a,[b,{dual_update:!0}],{success:function(b){e.update(a,[b,{dual_update:!0}],c)},exception:c.exception});else{if("or"==f)return d.update(a,[b,{dual_update:!0}],{success:c.success,exception:function(){e.update(a,[b,{dual_update:!0}],c)}});d.update(a,[b,{dual_update:!0}],c)}else{if("then"==f)return e.update(a,[d.update(a,[b,{dual_update:!0}]),{dual_update:!0}]);if("or"!=f)return d.update(a,[b,{dual_update:!0}]);try{return d.update(a,[b,{dual_update:!0}])}catch(g){return e.update(a,[b,{dual_update:!0}])}}return!0},_remove:function(a,b){var c=this.__first,d=this.__second;"first"!=this.__remove_options.start&&(c=this.__second,d=this.__first);var e=this.__remove_options.strategy;if(b)"then"==e?c.remove([a,{dual_remove:!0}],{success:function(){d.remove([a,{dual_remove:!0}],b)},exception:b.exception}):"or"==e?c.remove([a,{dual_remove:!0}],{success:b.success,exception:function(){d.remove([a,{dual_remove:!0}],b)}}):c.remove(a,b);else if("then"==e)c.remove([a,{dual_remove:!0}]),d.remove([a,{dual_remove:!0}]);else if("or"==e)try{c.remove([a,{dual_remove:!0}])}catch(f){d.remove([a,{dual_remove:!0}])}else c.remove([a,{dual_remove:!0}])},_query_capabilities:function(){return{query:!0,sort:!0,limit:!0,skip:!0}},_get:function(a,b){var c=this.__first,d=this.__second;"first"!=this.__get_options.start&&(c=this.__second,d=this.__first);var e=this.__get_options.strategy,f=this.__get_options.clone,g=this.__get_options.clone_second,h=this.__get_options.or_on_null;if("or"==e){var i=function(b){d.get(a,BetaJS.SyncAsync.mapSuccess(b,function(a){a&&f?c.delegate(c.insert,[a],b):this.callback(b,"success",a)}))};return c.then(c.get,[a],b,function(b,c){return!b&&h?void i(c):void(g?d.get(a,{success:function(a){a?this.callback(c,"success",b):d.insert(b,c)},exception:function(){d.insert(b,c)}}):this.callback(c,"success",b))},function(a,b){i(b)})}return c.get(a,b)},_query:function(a,b,c){var d=this.__first,e=this.__second;"first"!=this.__query_options.start&&(d=this.__second,e=this.__first);var f=this.__query_options.strategy,g=this.__query_options.clone,h=this.__get_options.clone_second,i=this.__query_options.or_on_null,j=null;if("or"==f){var k=function(c){return this.trigger("query_second",a,b),e.query(a,b,BetaJS.SyncAsync.mapSuccess(c,function(e){if(e&&g){arr=e.asArray(),e=new BetaJS.Iterators.ArrayIterator(arr);var f=BetaJS.SyncAsync.mapSuccess(c,function(){BetaJS.SyncAsync.callback(c,"success",e)});d.insert_all(arr,f,{query:a,options:b},{dual_insert:!0})}else BetaJS.SyncAsync.callback(c,"success",e)})),j},l=function(c,d){arr=c.asArray(),c=new BetaJS.Iterators.ArrayIterator(arr);var f=BetaJS.SyncAsync.mapSuccess(d,function(){BetaJS.SyncAsync.callback(d,"success",c)});e.insert_all(arr,f,{query:a,options:b},{dual_insert:!0})};return this.trigger("query_first",a,b),this.then(d,d.query,[a,b],c,function(c,d){return!c&&i?void k.call(this,d):void(h?(this.trigger("query_second",a,b),e.query(a,b,{success:function(a){a?this.callback(d,"success",c):l(c,d)},exception:function(){l(c,d)}})):this.callback(d,"success",c))},function(a,b){k.call(this,b)})}return this.trigger("query_first",a,b),d.query(a,b,c)}}),BetaJS.Stores.DualStore.extend("BetaJS.Stores.CachedStore",{constructor:function(a,b){b=b||{},this._inherited(BetaJS.Stores.CachedStore,"constructor",a,new BetaJS.Stores.MemoryStore({id_key:a.id_key(),query_model:new BetaJS.Queries.DefaultQueryModel}),BetaJS.Objs.extend({get_options:{start:"second",strategy:"or"},query_options:{start:"second",strategy:"or",clone:!0,or_on_null:!1}},b))},cache:function(){return this.second()},store:function(){return this.first()}}),BetaJS.Stores.BaseStore.extend("BetaJS.Stores.ConversionStore",{constructor:function(a,b){b=b||{},b.id_key=a._id_key,this._inherited(BetaJS.Stores.ConversionStore,"constructor",b),this.__store=a,this.__key_encoding=b.key_encoding||{},this.__key_decoding=b.key_decoding||{},this.__value_encoding=b.value_encoding||{},this.__value_decoding=b.value_decoding||{}},encode_object:function(a){var b={};for(var c in a)b[this.encode_key(c)]=this.encode_value(c,a[c]);return b},decode_object:function(a){var b={};for(var c in a)b[this.decode_key(c)]=this.decode_value(c,a[c]);return b},encode_key:function(a){return a in this.__key_encoding?this.__key_encoding[a]:a},decode_key:function(a){return a in this.__key_decoding?this.__key_decoding[a]:a},encode_value:function(a,b){return a in this.__value_encoding?this.__value_encoding[a](b):b},decode_value:function(a,b){return a in this.__value_decoding?this.__value_decoding[a](b):b},_query_capabilities:function(){return this.__store._query_capabilities()},_ensure_index:function(a){return this.__store.ensure_index(a)},_insert:function(a,b){return this.then(this.__store,this.__store.insert,[this.encode_object(a)],b,function(a,b){b.success(this.decode_object(a))})},_remove:function(a,b){return this.delegate(this.__store,this.__store.remove,[this.encode_value(this._id_key,a)],b)},_get:function(a,b){return this.then(this.__store,this.__store.get,[this.encode_value(this._id_key,a)],b,function(a,b){b.success(this.decode_object(a))})},_update:function(a,b,c){return this.then(this.__store,this.__store.update,[this.encode_value(this._id_key,a),this.encode_object(b)],c,function(a,b){b.success(this.decode_object(a))})},_query:function(a,b,c){return this.then(this.__store,this.__store.query,[this.encode_object(a),b],c,function(a,b){var c=new BetaJS.Iterators.MappedIterator(a,function(a){return this.decode_object(a)},this);b.success(c)})}}),BetaJS.Stores.BaseStore.extend("BetaJS.Stores.PassthroughStore",{constructor:function(a,b){this.__store=a,b=b||{},b.id_key=a.id_key(),this._inherited(BetaJS.Stores.PassthroughStore,"constructor",b),this._supportsAsync=a.supportsAsync(),this._supportsSync=a.supportsSync()},_query_capabilities:function(){return this.__store._query_capabilities()},_insert:function(a,b){return this.__store.insert(a,b)},_remove:function(a,b){return this.__store.remove(a,b)},_get:function(a,b){return this.__store.get(a,b)},_update:function(a,b,c){return this.__store.update(a,b,c)},_query:function(a,b,c){return this.__store.query(a,b,c)},_ensure_index:function(a){return this.__store.ensure_index(a)},_store:function(){return this.__store}}),BetaJS.Stores.PassthroughStore.extend("BetaJS.Stores.ActiveStore",{constructor:function(a,b,c){this._inherited(BetaJS.Stores.ActiveStore,"constructor",a,c),this.__listener=b,this.delegateEvents(null,b)}}),BetaJS.Stores.BaseStore.extend("BetaJS.Stores.SocketStore",{constructor:function(a,b,c){this._inherited(BetaJS.Stores.SocketStore,"constructor",a),this.__socket=b,this.__prefix=c,this._supportsAsync=!1},__send:function(a,b){this.__socket.emit(this.__prefix+":"+a,b)},_insert:function(a){this.__send("insert",a)},_remove:function(a){this.__send("remove",a)},_update:function(a,b){this.__send("update",BetaJS.Objs.objectBy(a,b))},bulk:function(a){this.__send("bulk",a)}}),BetaJS.Stores.ListenerStore.extend("BetaJS.Stores.SocketListenerStore",{constructor:function(a,b,c){this._inherited(BetaJS.Stores.SocketListenerStore,"constructor",a);var d=this;this.__prefix=c,b.on(this.__prefix+":insert",function(a){d._perform("insert",a)}),b.on(this.__prefix+":remove",function(a){d._perform("remove",a)}),b.on(this.__prefix+":update",function(a){d._perform("update",a)}),b.on(this.__prefix+":bulk",function(a){for(var b=0;b<a.length;++b)d._perform(BetaJS.Objs.keyByIndex(a[b]),BetaJS.Objs.valueByIndex(a[b]))})},_perform:function(a,b){if("insert"==a)this._inserted(b);else if("remove"==a)this._removed(b);else{if("update"!=a)throw new BetaJS.Stores.StoreException("unsupported: perform "+a);this._updated(BetaJS.Objs.objectBy(this.id_key(),BetaJS.Objs.keyByIndex(b)),BetaJS.Objs.valueByIndex(b))}}}),BetaJS.Class.extend("BetaJS.Stores.StoresMonitor",[BetaJS.Events.EventsMixin,{attach:function(a,b){b.on("insert",function(c){this.trigger("insert",a,b,c),this.trigger("write","insert",a,b,c)},this),b.on("remove",function(c){this.trigger("remove",a,b,c),this.trigger("write","remove",a,b,c)},this),b.on("update",function(c,d){this.trigger("update",a,b,c,d),this.trigger("write","update",a,b,c,d)},this)}}]),BetaJS.Class.extend("BetaJS.Stores.StoreHistory",[BetaJS.Events.EventsMixin,{constructor:function(a,b){this._inherited(BetaJS.Stores.StoreHistory,"constructor"),b=b||{},this._combine_update_update=b.combine_update_update||!1,this._combine_insert_update=b.combine_insert_update||!1,this._combine_insert_remove=b.combine_insert_remove||!1,this._combine_update_remove=b.combine_update_remove||!1,this._commits={},this._revision_id=null,this._store=a,this._item_commits={},this._store.on("insert",function(a){this.__add_commit({action:"insert",id:a[this._store.id_key()],data:a})},this),this._store.on("remove",function(a){this.__add_commit({action:"remove",id:a})},this),this._store.on("update",function(a,b){this.__add_commit({action:"update",id:a,data:b})},this)},__remove_commit:function(a){this.trigger("remove",this._commits[a]);var b=this._commits[a].id;delete this._commits[a],delete this._item_commits[b],BetaJS.Objs.is_empty(this._item_commits[b])&&delete this._item_commits[b]},__add_commit:function(a){a.revision_id=this._new_revision_id();var b=!1,c=!1,d=null;for(var e in this._item_commits[a.id]){var f=this._commits[e];b=b||"insert"==f.action,c=c||"update"==f.action,d=e}if(this._revision_id=a.revision_id,this._commits[this._revision_id]=a,this._item_commits[a.id]=this._item_commits[a.id]||{},this._item_commits[a.id][a.revision_id]=!0,this.trigger("commit",a),"update"==a.action)(this._combine_insert_update&&!c&&b||this._combine_update_update&&c)&&(this.__remove_commit(a.revision_id),this._commits[d].data=BetaJS.Objs.extend(this._commits[d].data,a.data));else if("remove"==a.action)for(e in this._item_commits[a.id])f=this._commits[e],(b&&this._combine_insert_remove||"update"==f.action&&this._combine_update_remove)&&this.__remove_commit(e)},flush:function(a){a=a||this._revision_id;for(var b in this._commits){if(b>a)break;this.__remove_commit(b)}},serialize:function(a){var b=this._commits[a];return"insert"==commin.action?{insert:b.data}:"remove"==b.action?{remove:b.id}:"update"==b?{update:BetaJS.Objs.objectBy(b.id,b.data)}:null},serialize_bulk:function(a){a=a||this._revision_id;var b=[];for(var c in this._commits){if(c>a)break;b.push(this.serialize(c))}return b},revision_id:function(){return this._revision_id},_new_revision_id:function(){return this.cls.__revision_id+1}}],{__revision_id:0}),BetaJS.Net=BetaJS.Net||{},BetaJS.Net.HttpHeader={HTTP_STATUS_OK:200,HTTP_STATUS_CREATED:201,HTTP_STATUS_PAYMENT_REQUIRED:402,HTTP_STATUS_FORBIDDEN:403,HTTP_STATUS_NOT_FOUND:404,HTTP_STATUS_PRECONDITION_FAILED:412,HTTP_STATUS_INTERNAL_SERVER_ERROR:500,format:function(a,b){var c="";return c=a==this.HTTP_STATUS_OK?"OK":a==this.HTTP_STATUS_CREATED?"Created":a==this.HTTP_STATUS_PAYMENT_REQUIRED?"Payment Required":a==this.HTTP_STATUS_FORBIDDEN?"Forbidden":a==this.HTTP_STATUS_NOT_FOUND?"Not found":a==this.HTTP_STATUS_PRECONDITION_FAILED?"Precondition Failed":a==this.HTTP_STATUS_INTERNAL_SERVER_ERROR?"Internal Server Error":"Other Error",b?a+" "+c:c}},BetaJS.Exceptions.Exception.extend("BetaJS.Modelling.ModelException",{constructor:function(a,b){this._inherited(BetaJS.Modelling.ModelException,"constructor",b),this.__model=a},model:function(){return this.__model}}),BetaJS.Modelling.ModelException.extend("BetaJS.Modelling.ModelMissingIdException",{constructor:function(a){this._inherited(BetaJS.Modelling.ModelMissingIdException,"constructor",a,"No id given.")}}),BetaJS.Modelling.ModelException.extend("BetaJS.Modelling.ModelInvalidException",{constructor:function(a){var b=BetaJS.Objs.values(a.errors()).join("\n");this._inherited(BetaJS.Modelling.ModelInvalidException,"constructor",a,b)}}),BetaJS.Properties.Properties.extend("BetaJS.Modelling.SchemedProperties",{constructor:function(a,b){this._inherited(BetaJS.Modelling.SchemedProperties,"constructor");var c=this.cls.scheme();this._properties_changed={},this.__errors={},this.__unvalidated={};for(var d in c)"def"in c[d]?this.set(d,c[d].def):c[d].auto_create?this.set(d,c[d].auto_create(this)):this.set(d,null);b=b||{},this._properties_changed={},this.__errors={};for(d in a)this.set(d,a[d])},_unsetChanged:function(a){delete this._properties_changed[a]},_beforeSet:function(a,b){var c=this.cls.scheme();if(!(a in c))return b;var d=c[a];return"boolean"==d.type?BetaJS.Types.parseBool(b):(d.transform&&(b=d.transform.apply(this,[b])),b)},_afterSet:function(a,b){var c=this.cls.scheme();if(a in c&&(this._properties_changed[a]=b,this.__unvalidated[a]=!0,delete this.__errors[a],c[a].after_set)){var d=BetaJS.Types.is_string(c[a].after_set)?this[c[a].after_set]:c[a].after_set;d.apply(this,[b])}},properties_changed:function(a){return BetaJS.Types.is_boolean(a)?BetaJS.Objs.filter(this._properties_changed,function(b,c){return this.validateAttr(c)==a},this):this._properties_changed},get_all_properties:function(){var a={},b=this.cls.scheme();for(var c in b)a[c]=this.get(c);return a},properties_by:function(a){return BetaJS.Types.is_boolean(a)?BetaJS.Objs.filter(this.get_all_properties(),function(b,c){return this.validateAttr(c)==a},this):this.get_all_properties()},validate:function(){this.trigger("validate");for(var a in this.__unvalidated)this.validateAttr(a);return this._customValidate(),BetaJS.Types.is_empty(this.__errors)},_customValidate:function(){},validateAttr:function(a){if(a in this.__unvalidated){delete this.__unvalidated[a],delete this.__errors[a];var b=this.cls.scheme(),c=b[a];if("validate"in c){var d=c.validate;BetaJS.Types.is_array(d)||(d=[d]);var e=this.get(a);BetaJS.Objs.iter(d,function(b){var c=b.validate(e,this);return c&&(this.__errors[a]=c),null===c},this)}this.trigger("validate:"+a,!(a in this.__errors),this.__errors[a])}return!(a in this.__errors)},setError:function(a,b){delete this.__unvalidated[a],this.__errors[a]=b,this.trigger("validate:"+a,!(a in this.__errors),this.__errors[a])},revalidate:function(){return this.__errors={},this.__unvalidated=this.keys(!0),this.validate()},errors:function(){return this.__errors},getError:function(a){return this.__errors[a]},asRecord:function(a){var b={},c=this.cls.scheme(),d=this.get_all_properties();a=a||{};for(var e in d)if(e in c){var f=c[e].tags||[],g={};BetaJS.Objs.iter(f,function(a){g[a]=!0});var h=!0;BetaJS.Objs.iter(a,function(a){h=h&&a in g},this),h&&(b[e]=d[e])}return b},setByTags:function(a,b){var c=this.cls.scheme();b=b||{};for(var d in a)if(d in c){var e=c[d].tags||[],f={};BetaJS.Objs.iter(e,function(a){f[a]=!0});var g=!0;BetaJS.Objs.iter(b,function(a){g=g&&a in f},this),g&&this.set(d,a[d])}},validation_exception_conversion:function(a){var b=a;if(a.instance_of(BetaJS.Stores.RemoteStoreException))b=a.source();else if(!("status_code"in b&&"data"in b))return a;return b.status_code()==BetaJS.Net.HttpHeader.HTTP_STATUS_PRECONDITION_FAILED&&b.data()&&(BetaJS.Objs.iter(b.data(),function(a,b){this.setError(b,a)},this),a=new BetaJS.Modelling.ModelInvalidException(model)),a}},{_initializeScheme:function(){return{}},asRecords:function(a,b){return a.map(function(a){return a.asRecord(b)})},filterPersistent:function(a){var b={},c=this.scheme();for(var d in a)(!BetaJS.Types.is_defined(c[d].persistent)||c[d].persistent)&&(b[d]=a[d]);return b}},{scheme:function(){return this.__scheme=this.__scheme||this._initializeScheme(),this.__scheme
}}),BetaJS.Modelling.SchemedProperties.extend("BetaJS.Modelling.AssociatedProperties",{constructor:function(a,b){this._inherited(BetaJS.Modelling.AssociatedProperties,"constructor",a,b),this.assocs=this._initializeAssociations();for(var c in this.assocs)this.__addAssoc(c,this.assocs[c]);this.on("change:"+this.cls.primary_key(),function(a,b){this._change_id(a,b),this.trigger("change_id",a,b)},this)},_change_id:function(){},__addAssoc:function(a,b){this[a]=function(){return b.yield()}},_initializeAssociations:function(){return{}},destroy:function(){for(var a in this.assocs)this.assocs[a].destroy();this._inherited(BetaJS.Modelling.AssociatedProperties,"destroy")},id:function(){return this.get(this.cls.primary_key())},hasId:function(){return this.has(this.cls.primary_key())}},{primary_key:function(){return"id"},_initializeScheme:function(){var a=this._inherited(BetaJS.Modelling.AssociatedProperties,"_initializeScheme");return a[this.primary_key()]={type:"id"},a}}),BetaJS.Modelling.AssociatedProperties.extend("BetaJS.Modelling.Model",[BetaJS.SyncAsync.SyncAsyncMixin,{constructor:function(a,b){b=b||{},this._inherited(BetaJS.Modelling.Model,"constructor",a,b),this.__saved="saved"in b?b.saved:!1,this.__new="new"in b?b["new"]:!0,this.__removed=!1,this.__saved&&(this._properties_changed={}),this.__table=b.table||this.cls.defaultTable(),this.__table._model_register(this),this.__destroying=!1,this._supportsAsync=this.__table.supportsAsync(),this._supportsSync=this.__table.supportsSync()},destroy:function(){!this.__destroying&&this.__table&&(this.__destroying=!0,this.__table._model_unregister(this),this.trigger("destroy"),this._inherited(BetaJS.Modelling.Model,"destroy"))},isSaved:function(){return this.__saved},isNew:function(){return this.__new},isRemoved:function(){return this.__removed},update:function(a,b,c){this.setAll(a,{silent:!0}),this.save(c)},_afterSet:function(a,b,c,d){this._inherited(BetaJS.Modelling.Model,"_afterSet",a,b,c,d);var e=this.cls.scheme();a in e&&(d&&d.no_change?this._unsetChanged(a):this.__saved=!1,d&&d.silent||this.__table&&this.__table._model_set_value(this,a,b,d))},_after_create:function(){},_before_create:function(){},save:function(a){return this.__new&&this._before_create(),this.then(this.__table,this.__table._model_save,[this],a,function(a,b){this.trigger("save"),this.__saved=!0;var c=this.__new;this.__new=!1,c&&this._after_create(),this.callback(b,"success",a)})},remove:function(a){return this.then(this.__table,this.__table._model_remove,[this],a,function(a,b){this.trigger("remove"),this.__removed=!0,this.callback(b,"success",a)})},table:function(){return this.__table}}],{defaultTable:function(){return this.table||(this.table=new BetaJS.Modelling.Table(new BetaJS.Stores.MemoryStore,this)),this.table}}),BetaJS.Class.extend("BetaJS.Modelling.Table",[BetaJS.Events.EventsMixin,BetaJS.SyncAsync.SyncAsyncMixin,{constructor:function(a,b,c){this._inherited(BetaJS.Modelling.Table,"constructor"),this.__store=a,this.__model_type=b,this.__models_by_id={},this.__models_changed={},this.__options=BetaJS.Objs.extend({model_cache_size:null,type_column:null,auto_create:!1,store_validation_conversion:!0,auto_update:!0,auto_materialize:!1},c||{}),this.__models_by_cid=new BetaJS.Classes.ObjectCache({size:this.__options.model_cache_size}),this._auto_destroy(this.__models_by_cid),this.__models_by_cid.on("release",function(a){a.hasId()&&delete this.__models_by_id[a.id()]},this),this.__options.auto_materialize&&this.__store.on("insert",function(a,b){if(!(this.__models_by_id[a[this.primary_key()]]||b&&b.model_create)){var c=this.__materialize(a);this.trigger("create",c)}},this),this.__store.on("update",function(a,b,c){if(!(!this.__models_by_id[a[this.primary_key()]]||c&&c.model_update)){var d=this.__models_by_id[a[this.primary_key()]];d.setAll(b,{silent:!0}),this.trigger("update",d)}},this),this.__store.on("remove",function(a,b){if(!(!this.__models_by_id[a]||b&&b.model_remove)){var c=this.__models_by_id[a];this.trigger("remove",c),c.destroy()}},this),this._supportsAsync=!0,this._supportsSync=a.supportsSync()},_model_register:function(a){this.hasModel(a)||(this.trigger("register",a),this.__models_by_cid.add(a),a.hasId()&&(this.__models_by_id[a.id()]=a),a.isNew()&&this.__options.auto_create&&this._model_create(a))},_model_unregister:function(a){this.hasModel(a)&&(a.save(),this.__models_by_cid.remove(a),a.hasId()&&delete this.__models_by_id[a.id()],this.trigger("unregister",a))},hasModel:function(a){return null!==this.__models_by_cid.get(a)},_model_remove:function(a,b){return this.hasModel(a)?this.then(this.__store,this.__store.remove,[[a.id(),{model_remove:!0}]],b,function(b,c){this.trigger("remove",a),a.destroy(),this.callback(c,"success",!0)},function(a,b){this.callback(b,"exception",a)}):!1},_model_save:function(a,b){return a.isNew()?this._model_create(a,b):this._model_update(a,b)},__exception_conversion:function(a,b){return this.__options.store_validation_conversion?a.validation_exception_conversion(b):b},_model_create:function(a,b){if(!this.hasModel(a)||!a.isNew())return!1;if(!a.validate()){var c=new BetaJS.Modelling.ModelInvalidException(a);if(!b)throw c;this.callback(b,"exception",c)}var d=BetaJS.Scopes.resolve(this.__model_type).filterPersistent(a.get_all_properties());return this.__options.type_column&&(d[this.__options.type_column]=a.cls.classname),this.then(this.__store,this.__store.insert,[[d,{model_create:!0}]],b,function(b,c){return a.cls.primary_key()in b?(this.__models_by_id[b[a.cls.primary_key()]]=a,a.setAll(b,{no_change:!0,silent:!0}),delete this.__models_changed[a.cid()],this.trigger("create",a),this.trigger("save",a),this.callback(c,"success",a),!0):this.callback(c,"exception",new BetaJS.Modelling.ModelMissingIdException(a))},function(b,c){b=BetaJS.Exceptions.ensure(b),b=this.__exception_conversion(a,b),this.callback(c,"exception",b)})},_model_update:function(a,b){if(!this.hasModel(a)||a.isNew())return!1;if(!a.validate()){var c=new BetaJS.Modelling.ModelInvalidException(a);if(!b)throw c;this.callback(b,"exception",c)}var d=BetaJS.Scopes.resolve(this.__model_type).filterPersistent(a.properties_changed());return BetaJS.Types.is_empty(d)?(b&&this.callback(b,"success",d),d):this.then(this.__store,this.__store.update,[a.id(),[d,{model_update:!0}]],b,function(b,c){return a.setAll(b,{no_change:!0,silent:!0}),delete this.__models_changed[a.cid()],this.trigger("update",a),this.trigger("save",a),this.callback(c,"success",b),b},function(b,c){return b=BetaJS.Exceptions.ensure(b),b=this.__exception_conversion(a,b),this.callback(c,"exception",b),!1})},_model_set_value:function(a,b,c,d){return this.__models_changed[a.cid()]=a,this.trigger("change",a,b,c),this.trigger("change:"+b,a,c),this.__options.auto_update?a.save(d):void 0},save:function(a){if(a){var b=[];return BetaJS.Objs.iter(this.__models_changed,function(a){b.push(a.promise(a.save))},this),this.join(b,a)}var c=!0;return BetaJS.Objs.iter(this.__models_changed,function(a){c=a.save()&&c}),c},primary_key:function(){return BetaJS.Scopes.resolve(this.__model_type).primary_key()},__materialize:function(a){if(!a)return null;var b=this.__model_type;this.__options.type_column&&a[this.__options.type_column]&&(b=a[this.__options.type_column]);var c=BetaJS.Scopes.resolve(b);if(this.__models_by_id[a[this.primary_key()]])return this.__models_by_id[a[this.primary_key()]];var d=new c(a,{table:this,saved:!0,"new":!1});return d},findById:function(a,b){return this.__models_by_id[a]?(b&&this.callback(b,"success",this.__models_by_id[a]),this.__models_by_id[a]):this.then(this.__store,this.__store.get,[a],b,function(b,c){this.callback(c,"success",this.__materialize(this.__store.get(a)))})},findBy:function(a,b){return this.then(this,this.allBy,[a,{limit:1}],b,function(a,b){this.callback(b,"success",a.next())})},all:function(a,b){return this.allBy({},a,b)},allBy:function(a,b,c){var d=this;return this.__store.then(this.__store.query,[a,b],c,function(a,b){var c=new BetaJS.Iterators.MappedIterator(a,function(a){return this.__materialize(a)},d);d.callback(b,"success",c)})},query:function(){return this.allBy.apply(this,arguments)},scheme:function(){return this.__model_type.scheme()},ensure_indices:function(){if(!("ensure_index"in this.__store))return!1;var a=this.scheme();for(var b in a)a[b].index&&this.__store.ensure_index(b);return!0}}]),BetaJS.Class.extend("BetaJS.Modelling.Associations.Association",[BetaJS.SyncAsync.SyncAsyncMixin,{constructor:function(a,b){this._inherited(BetaJS.Modelling.Associations.Association,"constructor"),this._model=a,this._options=b||{},this.__cache=null,b.delete_cascade&&a.on("remove",function(){this.__delete_cascade()},this),b.ignore_change_id||a.on("change_id",function(a,b){this._change_id(a,b)},this)},_change_id:function(){},__delete_cascade:function(){this.yield({success:function(a){a=BetaJS.Iterators.ensure(a).toArray();for(var b=[];a.hasNext();){var c=a.next();b.push(c.promise(c.remove))}this.join(b,{success:function(){}})}})},"yield":function(a){return this._options.cached?this.eitherFactory("__cache",a,this._yield,this._yield):this._yield(a)},invalidate:function(){delete this.__cache}}]),BetaJS.Modelling.Associations.Association.extend("BetaJS.Modelling.Associations.TableAssociation",{constructor:function(a,b,c,d){this._inherited(BetaJS.Modelling.Associations.TableAssociation,"constructor",a,d),this._foreign_table=b,this._foreign_key=c,d.primary_key&&(this._primary_key=d.primary_key),this._options.cached&&this._foreign_table.on("create update remove",function(){this.invalidate()},this)},destroy:function(){this._foreign_table.off(null,null,this),this._inherited(BetaJS.Modelling.Associations.TableAssociation,"destroy")}}),BetaJS.Modelling.Associations.TableAssociation.extend("BetaJS.Modelling.Associations.HasManyAssociation",{_id:function(){return this._primary_key?this._model.get(this._primary_key):this._model.id()},_yield:function(a){return this.allBy({},a)},"yield":function(a){if(!this._options.cached)return this._yield(a);if(this.__cache){var b=new BetaJS.Iterators.ArrayIterator(this.__cache);return a&&this.callback(a,"success",b),b}return this.then(this._yield,a,function(a,b){this.__cache=a.asArray(),BetaJS.Objs.iter(this.__cache,function(a){a.on("destroy",function(){this.invalidate()},this)},this),this.callback(b,"success",new BetaJS.Iterators.ArrayIterator(this.__cache))})},invalidate:function(){BetaJS.Objs.iter(this.__cache,function(a){a.off(null,null,this)},this),this._inherited(BetaJS.Modelling.Associations.HasManyAssociation,"invalidate")},findBy:function(a,b){return a[this._foreign_key]=this._id(),this._foreign_table.findBy(a,b)},allBy:function(a,b,c){return a[this._foreign_key]=c?c:this._id(),this._foreign_table.allBy(a,{},b)},_change_id:function(a,b){this.allBy({},{content:this,success:function(b){for(;b.hasNext();){var c=b.next();c.set(this._foreign_key,a),c.save()}}},b)}}),BetaJS.Modelling.Associations.HasManyAssociation.extend("BetaJS.Modelling.Associations.HasManyThroughArrayAssociation",{_yield:function(a){if(a){var b=[];return BetaJS.Objs.iter(this._model.get(this._foreign_key),function(a){b.push(this._foreign_table.promise(this._foreign_table.findById,[a]))},this),this.join(b,BetaJS.SyncAsync.mapSuccess(a,function(b){this.callback(a,"success",BetaJS.Objs.filter(b,function(a){return!!a}))}))}var c=[];return BetaJS.Objs.iter(this._model.get(this._foreign_key),function(a){var b=this._foreign_table.findById(a);b&&c.push(b)},this),c},"yield":function(a){if(!this._options.cached)return new BetaJS.Iterators.ArrayIterator(this._yield(a));if(this.__cache){var b=new BetaJS.Iterators.ArrayIterator(this.__cache);return a&&this.callback(a,"success",b),b}return this.then(this._yield,a,function(a,b){this.__cache=a,BetaJS.Objs.iter(this.__cache,function(a){a.on("destroy",function(){this.invalidate()},this)},this),this.callback(b,"success",new BetaJS.Iterators.ArrayIterator(this.__cache))})}}),BetaJS.Modelling.Associations.TableAssociation.extend("BetaJS.Modelling.Associations.HasOneAssociation",{_yield:function(a,b){var c={};return c[this._foreign_key]=b?b:this._primary_key?this._model.get(this._primary_key):this._model.id(),this.then(this._foreign_table,this._foreign_table.findBy,[c],a,function(a,b){a&&a.on("destroy",function(){this.invalidate()},this),this.callback(b,"success",a)})},_change_id:function(a,b){this._yield({context:this,success:function(b){b&&(b.set(this._foreign_key,a),b.save())}},b)}}),BetaJS.Modelling.Associations.TableAssociation.extend("BetaJS.Modelling.Associations.BelongsToAssociation",{_yield:function(a){var b=function(a,b){a&&a.on("destroy",function(){this.invalidate()},this),this.callback(b,"success",a)};if(!this._primary_key)return this.then(this._foreign_table,this._foreign_table.findById,[this._model.get(this._foreign_key)],a,b);var c={};return c[this._primary_key]=this._model.get(this._foreign_key),this.then(this._foreign_table,this._foreign_table.findBy,[c],a,b)}}),BetaJS.Modelling.Associations.Association.extend("BetaJS.Modelling.Associations.ConditionalAssociation",{constructor:function(a,b){this._inherited(BetaJS.Modelling.Associations.ConditionalAssociation,"constructor"),this._model=a,this._options=b||{},this.__cache=null,b.delete_cascade&&a.on("remove",function(){this.__delete_cascade()},this),b.ignore_change_id||a.on("change_id",function(a,b){this._change_id(a,b)},this)},_yield:function(a){return this._model.assocs[this._options.conditional(this._model)].yield(a)}}),BetaJS.Modelling.Associations.Association.extend("BetaJS.Modelling.Associations.PolymorphicHasOneAssociation",{constructor:function(a,b,c,d){this._inherited(BetaJS.Modelling.Associations.PolymorphicHasOneAssociation,"constructor",a,d),this._foreign_table_key=b,this._foreign_key=c,d.primary_key&&(this._primary_key=d.primary_key)},_yield:function(a,b){var c={};c[this._foreign_key]=b?b:this._primary_key?this._model.get(this._primary_key):this._model.id();var d=BetaJS.Scopes.resolve(this._model.get(this._foreign_table_key));return this.then(d,d.findBy,[c],a,function(a,b){a&&a.on("destroy",function(){this.invalidate()},this),this.callback(b,"success",a)})},_change_id:function(a,b){this._yield({success:function(b){b&&(b.set(this._foreign_key,a),b.save())}},b)}}),BetaJS.Class.extend("BetaJS.Modelling.Validators.Validator",{validate:function(){return null}}),BetaJS.Modelling.Validators.Validator.extend("BetaJS.Modelling.Validators.PresentValidator",{constructor:function(a){this._inherited(BetaJS.Modelling.Validators.PresentValidator,"constructor"),this.__error_string=a?a:"Field is required"},validate:function(a){return BetaJS.Types.is_null(a)||""===a?this.__error_string:null}}),BetaJS.Modelling.Validators.Validator.extend("BetaJS.Modelling.Validators.EmailValidator",{constructor:function(a){this._inherited(BetaJS.Modelling.Validators.EmailValidator,"constructor"),this.__error_string=a?a:"Not a valid email address"},validate:function(a){return BetaJS.Strings.is_email_address(a)?null:this.__error_string}}),BetaJS.Modelling.Validators.Validator.extend("BetaJS.Modelling.Validators.LengthValidator",{constructor:function(a){this._inherited(BetaJS.Modelling.Validators.LengthValidator,"constructor"),this.__min_length=BetaJS.Types.is_defined(a.min_length)?a.min_length:null,this.__max_length=BetaJS.Types.is_defined(a.max_length)?a.max_length:null,this.__error_string=BetaJS.Types.is_defined(a.error_string)?a.error_string:null,this.__error_string||(null!==this.__min_length?this.__error_string=null!==this.__max_length?"Between "+this.__min_length+" and "+this.__max_length+" characters":"At least "+this.__min_length+" characters":null!==this.__max_length&&(this.__error_string="At most "+this.__max_length+" characters"))},validate:function(a){return null!==this.__min_length&&(!a||a.length<this.__min_length)?this.__error_string:null!==this.__max_length&&a.length>this.__max_length?this.__error_string:null}}),BetaJS.Modelling.Validators.Validator.extend("BetaJS.Modelling.Validators.UniqueValidator",{constructor:function(a,b){this._inherited(BetaJS.Modelling.Validators.UniqueValidator,"constructor"),this.__key=a,this.__error_string=b?b:"Key already present"},validate:function(a,b){var c={};c[this.__key]=a;var d=b.table().findBy(c);return!d||!b.isNew()&&b.id()==d.id()?null:this.__error_string}}),BetaJS.Modelling.Validators.Validator.extend("BetaJS.Modelling.Validators.ConditionalValidator",{constructor:function(a,b){this._inherited(BetaJS.Modelling.Validators.ConditionalValidator,"constructor"),this.__condition=a,this.__validator=BetaJS.Types.is_array(b)?b:[b]},validate:function(a,b){if(!this.__condition(a,b))return null;for(var c=0;c<this.__validator.length;++c){var d=this.__validator[c].validate(a,b);if(null!==d)return d}return null}});