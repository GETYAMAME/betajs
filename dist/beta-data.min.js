/*! betajs - v0.0.1 - 2013-08-29, Copyright (c) Oliver Friedmann & Victor Lingenthal, MIT Software License. */BetaJS.Class.extend("BetaJS.Net.AbstractAjax",{constructor:function(a){this._inherited(BetaJS.Net.AbstractAjax,"constructor"),this.__options=BetaJS.Objs.extend({method:"GET",data:{}},a)},syncCall:function(a){var b=BetaJS.Objs.clone(this.__options,1);b=BetaJS.Objs.extend(b,a);var c=b.success_callback;delete b.success_callback;var d=b.failure_callback;delete b.failure_callback;var e=b.complete_callback;delete b.complete_callback;try{var f=this._syncCall(b);return c&&c(f),e&&e(),f}catch(g){if(g=BetaJS.Exceptions.ensure(g),g.assert(BetaJS.Net.AjaxException),!d)throw g;d(g.status_code(),g.status_text(),g.data())}},asyncCall:function(a){var b=BetaJS.Objs.clone(this.__options,1);b=BetaJS.Objs.extend(b,a);var c=b.success_callback;delete b.success_callback;var d=b.failure_callback;delete b.failure_callback;var e=b.complete_callback;delete b.complete_callback;try{var f=this._asyncCall(BetaJS.Objs.extend({success:function(a){c&&c(a),e&&e()},failure:function(a,b,c){if(!d)throw new BetaJS.Net.AjaxException(a,b,c);d(a,b,c),e&&e()}},b));return f}catch(g){if(g=BetaJS.Exceptions.ensure(g),g.assert(BetaJS.Net.AjaxException),!d)throw g;d(g.status_code(),g.status_text(),g.data())}},call:function(a){if(!("async"in a))return!1;var b=a.async;return delete a.async,b?this.asyncCall(a):this.syncCall(a)},_syncCall:function(){},_asyncCall:function(){}}),BetaJS.Exceptions.Exception.extend("BetaJS.Net.AjaxException",{constructor:function(a,b,c){this._inherited(BetaJS.Net.AjaxException,"constructor",a+": "+b),this.__status_code=a,this.__status_text=b,this.__data=c},status_code:function(){return this.__status_code},status_text:function(){return this.__status_text},data:function(){return this.__data}}),BetaJS.Net.AbstractAjax.extend("BetaJS.Net.JQueryAjax",{_syncCall:function(a){var b;return BetaJS.$.ajax({type:a.method,async:!1,url:a.uri,dataType:a.decodeType?a.decodeType:null,data:a.encodeType&&"json"==a.encodeType?JSON.stringify(a.data):a.data,success:function(a){b=a},error:function(a,b,c){throw new BetaJS.Net.AjaxException(a.status,c,JSON.parse(a.responseText))}}),b},_asyncCall:function(a){BetaJS.$.ajax({type:a.method,async:!0,url:a.uri,dataType:a.decodeType?a.decodeType:null,data:a.encodeType&&"json"==a.encodeType?JSON.stringify(a.data):a.data,success:function(b){a.success(b)},error:function(b,c,d){a.failure(b.status,d,JSON.parse(b.responseText))}})}}),BetaJS.Queries={__increase_dependency:function(a,b){return a in b?b[a]++:b[a]=1,b},__dependencies_queries:function(a,b){return BetaJS.Objs.iter(a,function(a){b=this.__dependencies_query(a,b)},this),b},__dependencies_query:function(a,b){for(key in a)b=this.__dependencies_pair(key,a[key],b);return b},__dependencies_pair:function(a,b,c){return"$or"==a||"$and"==a?this.__dependencies_queries(b,c):this.__increase_dependency(a,c)},dependencies:function(a){return this.__dependencies_query(a,{})},__evaluate_query:function(a,b){for(key in a)if(!this.__evaluate_pair(key,a[key],b))return!1;return!0},__evaluate_pair:function(a,b,c){return"$or"==a?this.__evaluate_or(b,c):"$and"==a?this.__evaluate_and(b,c):this.__evaluate_value(b,c[a])},__evaluate_value:function(a,b){if(BetaJS.Types.is_object(a)){var c=!0;return BetaJS.Objs.iter(a,function(a,d){"$in"==d&&(c=c&&BetaJS.Objs.contains_value(a,b)),"$gt"==d&&(c=c&&b>=a),"$gtic"==d&&(c=c&&b.toLowerCase()>=a.toLowerCase()),"$lt"==d&&(c=c&&a>=b),"$ltic"==d&&(c=c&&b.toLowerCase()<=a.toLowerCase()),"$sw"==d&&(c=c&&0==b.indexOf(a)),"$swic"==d&&(c=c&&0==b.toLowerCase().indexOf(a.toLowerCase()))},this),c}return a==b},__evaluate_or:function(a,b){return BetaJS.Objs.iter(a,function(a){return this.__evaluate_query(a,b)?!0:void 0},this),!1},__evaluate_and:function(a,b){return BetaJS.Objs.iter(a,function(a){return this.__evaluate_query(a,b)?void 0:!1},this),!0},format:function(a){return BetaJS.Class.is_class_instance(a)?a.format():JSON.stringify(a)},overloaded_evaluate:function(a,b){return BetaJS.Class.is_class_instance(a)?a.evaluate(b):BetaJS.Types.is_function(a)?a(b):this.evaluate(a,b)},evaluate:function(a,b){return this.__evaluate_query(a,b)},emulate:function(a,b,c){var d=b.apply(c||this,{}),e=d;return null==d?e=BetaJS.Iterators.ArrayIterator([]):BetaJS.Types.is_array(d)&&(e=BetaJS.Iterators.ArrayIterator(d)),new BetaJS.Iterators.FilteredIterator(e,function(b){return BetaJS.Queries.evaluate(a,b)})}},BetaJS.Queries.Constrained={make:function(a,b){return{query:a,options:b||{}}},format:function(a){var b=a.query;a.query=BetaJS.Queries.format(b);var c=JSON.stringify(a);return a.query=b,c},emulate:function(a,b,c,d,e){var f=a.query,g=a.options,h={},i={};"sort"in g&&"sort"in b&&(i.sort=g.sort),h=f,("query"in b||BetaJS.Types.is_empty(f))&&(h=f,(!("sort"in g)||"sort"in b)&&("skip"in g&&"skip"in b&&(i.skip=g.skip),"limit"in g&&"limit"in b&&(i.limit=g.limit)));var j=[h,i];e&&j.push(e);var k=function(a){var c=a;return null==a?c=new BetaJS.Iterators.ArrayIterator([]):BetaJS.Types.is_array(a)&&(c=new BetaJS.Iterators.ArrayIterator(a)),"query"in b||BetaJS.Types.is_empty(f)||(c=new BetaJS.Iterators.FilteredIterator(c,function(a){return BetaJS.Queries.evaluate(f,a)})),"sort"in g&&!("sort"in i)&&(c=new BetaJS.Iterators.SortedIterator(c,BetaJS.Comparators.byObject(g.sort))),"skip"in g&&!("skip"in i)&&(c=new BetaJS.Iterators.SkipIterator(c,g.skip)),"limit"in g&&!("limit"in i)&&(c=new BetaJS.Iterators.LimitIterator(c,g.limit)),e&&e.success&&e.success(c),c},l=function(a){if(!e||!e.exception)throw a;e.exception(a)};if(e)c.apply(d||this,[h,i,{success:k,exception:l}]);else try{var m=c.apply(d||this,[h,i]);return k(m)}catch(n){l(n)}}},BetaJS.Collections.Collection.extend("BetaJS.Collections.QueryCollection",{constructor:function(a){this._inherited(BetaJS.Collections.QueryCollection,"constructor",a),this.__query=BetaJS.Objs.extend({func:null,select:{},skip:0,limit:null,forward_steps:null,backward_steps:null,range:null,count:null,sort:{}},a.query),"objects"in a||(a.objects=this.__execute_query(this.__query.skip,this.__query.limit,!0))},__execute_query:function(a,b,c){a=Math.max(a,0);var d={};if(null==this.__query.sort||BetaJS.Types.is_empty(this.__query.sort)||(d.sort=this.__query.sort),c){a>0&&(d.skip=a),null!=b&&(d.limit=b);var e=this.__query.func(this.__query.select,d),f=e.asArray();this.__query.skip=a,this.__query.limit=b,this.__query.count=null==b||f.length<b?a+f.length:null,this.clear(),this.add_objects(f)}else if(a<this.__query.skip){b=this.__query.skip-a,a>0&&(d.skip=a),d.limit=b;var e=this.__query.func(this.__query.select,d),f=e.asArray();this.__query.skip=a,this.__query.limit=null==this.__query.limit?null:this.__query.limit+f.length,this.add_objects(f)}else if(a>=this.__query.skip&&null!=this.__query.limit&&(null==b||a+b>this.__query.skip+this.__query.limit)){b=a+b-(this.__query.skip+this.__query.limit),a=this.__query.skip+this.__query.limit,a>0&&(d.skip=a),null!=b&&(d.limit=b);var e=this.__query.func(this.__query.select,d),f=e.asArray();this.__query.limit=this.__query.limit+f.length,b>f.length&&(this.__query.count=a+f.length),this.add_objects(f)}},increase_forwards:function(a){a=null==a?this.__query.forward_steps:a,null!=a&&null!=this.__query.limit&&this.__execute_query(this.__query.skip+this.__query.limit,a,!1)},increase_backwards:function(a){if(a=null==a?this.__query.backward_steps:a,null!=a&&this.__query.skip>0){var a=Math.min(a,this.__query.skip);this.__execute_query(this.__query.skip-a,a,!1)}},paginate:function(a){this.__execute_query(this.__query.range*a,this.__query.range,!0)},paginate_index:function(){return null==this.__query.range?null:Math.floor(this.__query.skip/this.__query.range)},paginate_count:function(){return null==this.__query.count||null==this.__query.range?null:Math.ceil(this.__query.count/this.__query.range)},next:function(){var a=this.paginate_index();if(null!=a){var b=this.paginate_count();(null==b||a<this.paginate_count()-1)&&this.paginate(a+1)}},prev:function(){var a=this.paginate_index();null!=a&&a>0&&this.paginate(a-1)},isComplete:function(){return null!=this.__query.count}}),BetaJS.Class.extend("BetaJS.Queries.ActiveQueryEngine",{constructor:function(){this._inherited(BetaJS.Queries.ActiveQueryEngine,"constructor"),this.__aqs={},this.__object_to_aqs={}},__valid_for_aq:function(a,b){return BetaJS.Queries.evaluate(b.query(),a)},insert:function(a){if(!this.__object_to_aqs[BetaJS.Ids.objectId(a)]){var b=a.getAll(),c={};this.__object_to_aqs[BetaJS.Ids.objectId(a)]=c,BetaJS.Objs.iter(this.__aqs,function(d){this.__valid_for_aq(b,d)&&(d._add(a),c[d.cid()]=d)},this),a.on("change",function(){this.update(a)},this)}},remove:function(a){BetaJS.Objs.iter(this.__object_to_aqs[BetaJS.Ids.objectId(a)],function(b){b._remove(a)},this),delete this.__object_to_aqs[BetaJS.Ids.objectId(a)],a.off(null,this,null)},update:function(a){var b=a.getAll(),c=this.__object_to_aqs[BetaJS.Ids.objectId(a)];BetaJS.Objs.iter(this.__object_to_aqs[BetaJS.Ids.objectId(a)],function(d){this.__valid_for_aq(b,d)||(d._remove(a),delete c[d.cid()])},this),BetaJS.Objs.iter(this.__aqs,function(d){this.__valid_for_aq(b,d)&&(d._add(a),c[d.cid()]=d)},this)},register:function(a){this.__aqs[a.cid()]=a;for(var b=a.query(),c=this._query(b);c.hasNext();){var d=c.next();this.__object_to_aqs[BetaJS.Ids.objectId(d)]?(this.__object_to_aqs[BetaJS.Ids.objectId(d)][a.cid()]=a,a._add(d)):this.insert(d)}},unregister:function(a){delete this.__aqs[a.cid()];var b=this;a.collection().iterate(function(c){delete b.__object_to_aqs[BetaJS.Ids.objectId(c)][a.cid()]})},_query:function(){}}),BetaJS.Class.extend("BetaJS.Queries.ActiveQuery",[BetaJS.Ids.ClientIdMixin,{constructor:function(a,b){this._inherited(BetaJS.Queries.ActiveQuery,"constructor"),this.__engine=a,this.__query=b,this.__collection=new BetaJS.Collections.Collection,this.__collection.on("destroy",function(){this.destroy()},this),a.register(this)},destroy:function(){this.__engine.unregister(this),this._inherited(BetaJS.Queries.ActiveQuery,"destroy")},isUniform:function(){return BetaJS.Types.is_empty(this.query())},engine:function(){return this.__engine},query:function(){return this.__query},collection:function(){return this.__collection},_add:function(a){this.__collection.add(a)},_remove:function(a){this.__collection.remove(a)},change_query:function(a){this.__engine.unregister(this),this.__query=a,this.__collection.clear(),this.__engine.register(this)}}]),BetaJS.Exceptions.Exception.extend("BetaJS.Stores.StoreException"),BetaJS.Class.extend("BetaJS.Stores.BaseStore",[BetaJS.Events.EventsMixin,{constructor:function(a){this._inherited(BetaJS.Stores.BaseStore,"constructor"),a=a||{},this._id_key=a.id_key||"id",this._create_ids=a.create_ids||!1,this._last_id=1,this._async_write="async_write"in a?a.async_write:!1,this._async_write=this._async_write&&this._supports_async_write(),this._async_read="async_read"in a?a.async_read:!1,this._async_read=this._async_read&&this._supports_async_read()},id_key:function(){return this._id_key},_supports_async_read:function(){return!1},async_read:function(){return this._async_read},_supports_async_write:function(){return!1},async_write:function(){return this._async_write},_insert:function(){},_remove:function(){},_get:function(){},_update:function(){},_query_capabilities:function(){return{}},_query:function(){},_new_id:function(){},insert:function(a,b){if(this._create_ids&&!(this._id_key in a)){if(this._async_write)throw new BetaJS.Stores.StoreException("Unsupported Creation of Ids");for(;this.get(this._last_id);)this._last_id++;a[this._id_key]=this._last_id}var c=this,d=function(a){c.trigger("insert",a),b&&b.success&&b.success(a)},e=function(a){if(!b||!b.exception)throw a;b.exception(a)};if(this._async_write)this._insert(a,{success:d,exception:e});else try{var f=this._insert(a);return d(f),f}catch(g){e(g)}},insert_all:function(a){if(!this._async_write){var b=!0;return BetaJS.Objs.iter(a,function(a){b=b&&this.insert(a)},this),b}var c=-1,d=this,e=function(){c++,c<a.length&&d.insert(a[c],{success:e})};e()},remove:function(a,b){var c=this,d=function(){c.trigger("remove",a),b&&b.success&&b.success(a)},e=function(a){if(!b||!b.exception)throw a;b.exception(a)};if(this._async_write)this._remove(a,{success:d,exception:e});else try{this._remove(a),d()}catch(f){e(f)}},get:function(a,b){var c=function(a){b&&b.success&&b.success(a)},d=function(a){if(!b||!b.exception)throw a;b.exception(a)};if(this._async_read)this._get(a,{success:c,exception:d});else try{var e=this._get(a);return c(e),e}catch(f){d(f)}},update:function(a,b,c){var d=this,e=function(a){d.trigger("update",a,b),c&&c.success&&c.success(a,b)},f=function(a){if(!c||!c.exception)throw a;c.exception(a)};if(this._async_write)this._update(a,b,{success:e,exception:f});else try{var g=this._update(a,b);return e(g),g}catch(h){f(h)}},query:function(a,b,c){return BetaJS.Queries.Constrained.emulate(BetaJS.Queries.Constrained.make(a,b||{}),this._query_capabilities(),this._query,this,c)},_query_applies_to_id:function(a,b){var c=this.get(b);return c&&BetaJS.Queries.overloaded_evaluate(a,c)},clear:function(){for(var a=this.query({});a.hasNext();)this.remove(a.next().id)}}]),BetaJS.Class.extend("BetaJS.Stores.StoresMonitor",[BetaJS.Events.EventsMixin,{attach:function(a,b){b.on("insert",function(c){this.trigger("insert",a,b,c),this.trigger("write","insert",a,b,c)},this),b.on("remove",function(c){this.trigger("remove",a,b,c),this.trigger("write","remove",a,b,c)},this),b.on("update",function(c,d){this.trigger("update",a,b,c,d),this.trigger("write","update",a,b,c,d)},this)}}]),BetaJS.Stores.BaseStore.extend("BetaJS.Stores.AssocStore",{_read_key:function(){},_write_key:function(){},_remove_key:function(){},_iterate:function(){},constructor:function(a){a=a||{},a.create_ids=!0,this._inherited(BetaJS.Stores.AssocStore,"constructor",a)},_insert:function(a){return this._write_key(a[this._id_key],a),a},_remove:function(a){var b=this._read_key(a);return b&&!this._remove_key(a)?null:b},_get:function(a){return this._read_key(a)},_update:function(a,b){var c=this._get(a);return c&&(delete b[this._id_key],BetaJS.Objs.extend(c,b),this._write_key(a,c)),c},_query:function(){return this._iterate()}}),BetaJS.Stores.AssocStore.extend("BetaJS.Stores.MemoryStore",{constructor:function(a){this._inherited(BetaJS.Stores.MemoryStore,"constructor",a),this.__data={}},_read_key:function(a){return this.__data[a]},_write_key:function(a,b){this.__data[a]=b},_remove_key:function(a){delete this.__data[a]},_iterate:function(){return new BetaJS.Iterators.ObjectValuesIterator(this.__data)}}),BetaJS.Stores.BaseStore.extend("BetaJS.Stores.DumbStore",{_read_last_id:function(){},_write_last_id:function(){},_remove_last_id:function(){},_read_first_id:function(){},_write_first_id:function(){},_remove_first_id:function(){},_read_item:function(){},_write_item:function(){},_remove_item:function(){},_read_next_id:function(){},_write_next_id:function(){},_remove_next_id:function(){},_read_prev_id:function(){},_write_prev_id:function(){},_remove_prev_id:function(){},constructor:function(a){a=a||{},a.create_ids=!0,this._inherited(BetaJS.Stores.DumbStore,"constructor",a)},_insert:function(a){var b=this._read_last_id(),c=a[this._id_key];return null!=b?(this._write_next_id(b,c),this._write_prev_id(c,b)):this._write_first_id(c),this._write_last_id(c),this._write_item(c,a),a},_remove:function(a){var b=this._read_item(a);if(b){this._remove_item(a);var c=this._read_next_id(a),d=this._read_prev_id(a);null!=c?(this._remove_next_id(a),null!=d?(this._remove_prev_id(a),this._write_next_id(d,c),this._write_prev_id(c,d)):(this._remove_prev_id(c),this._write_first_id(c))):null!=d?(this._remove_next_id(d),this._write_last_id(d)):(this._remove_first_id(),this._remove_last_id())}return b},_get:function(a){return this._read_item(a)},_update:function(a,b){var c=this._get(a);return c&&(delete b[this._id_key],BetaJS.Objs.extend(c,b),this._write_item(a,c)),c},_query_capabilities:function(){return{query:!0}},_query:function(a){var b=new BetaJS.Iterators.Iterator,c=this,d=this._read_first_id();return BetaJS.Objs.extend(b,{__id:null==d?1:d,__store:c,__query:a,hasNext:function(){var b=this.__store._read_last_id();if(null==b)return!1;for(;this.__id<b&&!this.__store._read_item(this.__id);)this.__id++;for(;this.__id<=b;){if(this.__store._query_applies_to_id(a,this.__id))return!0;this.__id<b?this.__id=this.__store._read_next_id(this.__id):this.__id++}return!1},next:function(){if(this.hasNext()){var a=this.__store.get(this.__id);return this.__id==this.__store._read_last_id()?this.__id++:this.__id=this.__store._read_next_id(this.__id),a}return null}}),b}}),BetaJS.Stores.DumbStore.extend("BetaJS.Stores.AssocDumbStore",{_read_key:function(){},_write_key:function(){},_remove_key:function(){},__read_id:function(a){var b=this._read_key(a);return b?parseInt(b):null},_read_last_id:function(){return this.__read_id("last_id")},_write_last_id:function(a){this._write_key("last_id",a)},_remove_last_id:function(){this._remove_key("last_id")},_read_first_id:function(){return this.__read_id("first_id")},_write_first_id:function(a){this._write_key("first_id",a)},_remove_first_id:function(){this._remove_key("first_id")},_read_item:function(a){return this._read_key("item_"+a)},_write_item:function(a,b){this._write_key("item_"+a,b)},_remove_item:function(a){this._remove_key("item_"+a)},_read_next_id:function(a){return this.__read_id("next_"+a)},_write_next_id:function(a,b){this._write_key("next_"+a,b)},_remove_next_id:function(a){this._remove_key("next_"+a)},_read_prev_id:function(a){return this.__read_id("prev_"+a)},_write_prev_id:function(a,b){this._write_key("prev_"+a,b)},_remove_prev_id:function(a){this._remove_key("prev_"+a)}}),BetaJS.Stores.AssocDumbStore.extend("BetaJS.Stores.LocalStore",{constructor:function(a){this._inherited(BetaJS.Stores.LocalStore,"constructor",a),this.__prefix=a.prefix},__key:function(a){return this.__prefix+a},_read_key:function(a){var b=this.__key(a);return b in localStorage?JSON.parse(localStorage[b]):null},_write_key:function(a,b){localStorage[this.__key(a)]=JSON.stringify(b)},_remove_key:function(a){delete localStorage[this.__key(a)]}}),BetaJS.Stores.BaseStore.extend("BetaJS.Stores.DualStore",{constructor:function(a,b,c){c=BetaJS.Objs.extend({create_options:{},update_options:{},delete_options:{},get_options:{},query_options:{}},c||{}),c.id_key=a._id_key,c.async_write=a.async_write(),this.__first=a,this.__second=b,this._inherited(BetaJS.Stores.DualStore,"constructor",c),this.__create_options=BetaJS.Objs.extend({start:"first",strategy:"then"},c.create_options),this.__update_options=BetaJS.Objs.extend({start:"first",strategy:"then"},c.update_options),this.__remove_options=BetaJS.Objs.extend({start:"first",strategy:"then"},c.delete_options),this.__get_options=BetaJS.Objs.extend({start:"first",strategy:"or",clone:!0,clone_second:!1,or_on_null:!0},c.get_options),this.__query_options=BetaJS.Objs.extend({start:"first",strategy:"or",clone:!0,clone_second:!1,or_on_null:!0},c.query_options)},first:function(){return this.__first},second:function(){return this.__second},_supports_async_read:function(){return!1},_supports_async_write:function(){return this.__first.async_write()},_insert:function(a,b){var c=this.__first,d=this.__second;"first"!=this.__create_options.start&&(c=this.__second,d=this.__first);var e=this.__create_options.strategy;if(this.async_write())if("then"==e)c.insert(a,{success:function(a){d.insert(a,b)},exception:b.exception});else{if("or"==e)return c.insert(a,{success:b.success,exception:function(){d.insert(a,b)}});c.insert(a,b)}else{if("then"==e)return d.insert(c.insert(a));if("or"!=e)return c.insert(a);try{return c.insert(a)}catch(f){return d.insert(a)}}},_update:function(a,b,c){var d=this.__first,e=this.__second;"first"!=this.__update_options.start&&(d=this.__second,e=this.__first);var f=this.__update_options.strategy;if(this.async_write())if("then"==f)d.update(a,b,{success:function(b){e.update(a,b,c)},exception:c.exception});else{if("or"==f)return d.update(a,b,{success:c.success,exception:function(){e.update(a,b,c)}});d.update(a,b,c)}else{if("then"==f)return e.update(a,d.update(a,b));if("or"!=f)return d.update(a,b);try{return d.update(a,b)}catch(g){return e.update(a,b)}}},_remove:function(a,b){var c=this.__first,d=this.__second;"first"!=this.__remove_options.start&&(c=this.__second,d=this.__first);var e=this.__remove_options.strategy;if(this.async_write())if("then"==e)c.remove(a,{success:function(){d.remove(a,b)},exception:b.exception});else{if("or"==e)return c.remove(a,{success:b.success,exception:function(){d.remove(a,b)}});c.remove(a,b)}else if("then"==e)c.remove(a),d.remove(a);else if("or"==e)try{c.remove(a)}catch(f){d.remove(a)}else c.remove(a)},_get:function(a){var b=this.__first,c=this.__second;"first"!=this.__get_options.start&&(b=this.__second,c=this.__first);var d=this.__get_options.strategy,e=this.__get_options.clone,f=this.__get_options.clone_second,g=this.__get_options.or_on_null;if("or"!=d)return b.get(a);try{var h=b.get(a);if(null==h&&g)throw new{};if(f){try{c.get(a)&&(f=!1)}catch(i){}f&&c.insert(h)}return h}catch(i){var h=c.get(a);return null!=h&&e&&b.insert(h),h}},_query_capabilities:function(){return{query:!0,sort:!0,limit:!0,skip:!0}},_query:function(a,b){var c=this.__first,d=this.__second;"first"!=this.__query_options.start&&(c=this.__second,d=this.__first);var e=this.__query_options.strategy,f=this.__query_options.clone,g=this.__get_options.clone_second,h=this.__query_options.or_on_null;if("or"!=e)return c.query(a,b);try{var i=c.query(a,b);if(null==i&&h)throw{};if(g){try{d.get(a,b)&&(f=!1)}catch(j){}g&&("cache_query"in d?d.cache_query(i):d.insert_all(i.asArray()))}return i}catch(j){var i=d.query(a,b);return null!=i&&f&&("cache_query"in c?c.cache_query(i):c.insert_all(i.asArray())),i}}}),BetaJS.Stores.StoreException.extend("BetaJS.Stores.StoreCacheException"),BetaJS.Stores.DualStore.extend("BetaJS.Stores.FullyCachedStore",{constructor:function(a,b){b=b||{},this._inherited(BetaJS.Stores.FullyCachedStore,"constructor",a,new BetaJS.Stores.MemoryStore({id_key:a.id_key()}),BetaJS.Objs.extend({get_options:{start:"second",strategy:"single"},query_options:{start:"second",strategy:"single"}},b))},cache:function(){return this.second()},store:function(){return this.first()}}),BetaJS.Stores.DualStore.extend("BetaJS.Stores.QueryCachedStore",{constructor:function(a,b){b=b||{},this._inherited(BetaJS.Stores.QueryCachedStore,"constructor",a,new BetaJS.Stores.QueryCachedStore.InnerStore({id_key:a.id_key()}),BetaJS.Objs.extend({get_options:{start:"second",strategy:"or"},query_options:{start:"second",strategy:"or",clone:!1,or_on_null:!1}},b))},cache:function(){return this.second()},store:function(){return this.first()}}),BetaJS.Stores.MemoryStore.extend("BetaJS.Stores.QueryCachedStore.InnerStore",{constructor:function(a){this._inherited(BetaJS.Stores.QueryCachedStore.InnerStore,"constructor",a),this.__queries={}},_query_capabilities:function(){return{query:!0,sort:!0,limit:!0,skip:!0}},_query:function(a,b){var c=BetaJS.Queries.Constrained.make(a,b),d=BetaJS.Queries.Constrained.format(c);if(d in this.__queries)return new BetaJS.Iterators.ArrayIterator(BetaJS.Objs.values(this.__queries[d]));throw new BetaJS.Stores.StoreCacheException},cache_query:function(a,b,c){var d=BetaJS.Queries.Constrained.make(a,b),e=BetaJS.Queries.Constrained.format(d);this.__queries[e]={};for(var f=0;f<c.length;++f){var g=c[f];this.insert(g),this.__queries[e][g[this.id_key()]]=g}},insert:function(a,b){return this.trigger("cache",a),this._inherited(BetaJS.Stores.QueryCachedStore.InnerStore,"insert",a,b)}}),BetaJS.Stores.StoreException.extend("BetaJS.Stores.RemoteStoreException",{constructor:function(a){a=BetaJS.Net.AjaxException.ensure(a),this._inherited(BetaJS.Stores.RemoteStoreException,"constructor",a.toString()),this.__source=a},source:function(){return this.__source}}),BetaJS.Stores.BaseStore.extend("BetaJS.Stores.RemoteStore",{constructor:function(a,b,c){this._inherited(BetaJS.Stores.RemoteStore,"constructor",c),this._uri=a,this.__ajax=b,this.__options=BetaJS.Objs.extend({update_method:"PUT",uri_mappings:{}},c||{})},_supports_async_write:function(){return!0},_supports_async_read:function(){return!1},getUri:function(){return this._uri},prepare_uri:function(a,b){return this.__options.uri_mappings[a]?this.__options.uri_mappings[a](b):"remove"==a||"get"==a||"update"==a?this.getUri()+"/"+b[this._id_key]:this.getUri()},_include_callbacks:function(a,b,c){return a.failure=function(a,c,d){b(new BetaJS.Stores.RemoteStoreException(new BetaJS.Net.AjaxException(a,c,d)))},a.success=c,a},_insert:function(a,b){try{var c={method:"POST",uri:this.prepare_uri("insert",a),data:a};if(!this._async_write)return this.__ajax.syncCall(c);this.__ajax.asyncCall(this._include_callbacks(c,b.exception,b.success))}catch(d){throw new BetaJS.Stores.RemoteStoreException(d)}},_remove:function(a,b){try{var c={};c[this._id_key]=a;var d={method:"DELETE",uri:this.prepare_uri("remove",c)};if(!this._async_write){var e=this.__ajax.syncCall(d);return e||(e={},e[this._id_key]=a),e}var f=this;d=this._include_callbacks(d,b.exception,function(c){c||(c={},c[f._id_key]=a),b.success(c)}),this.__ajax.asyncCall(d)}catch(g){throw new BetaJS.Stores.RemoteStoreException(g)}},_get:function(a,b){var c={};c[this._id_key]=a;try{var d={uri:this.prepare_uri("get",c)};if(!this._async_read)return this.__ajax.syncCall(d);this.__ajax.asyncCall(this._include_callbacks(d,b.exception,b.success))}catch(e){throw new BetaJS.Stores.RemoteStoreException(e)}},_update:function(a,b,c){var d=BetaJS.Objs.clone(b,1);d[this._id_key]=a;try{var e={method:this.__options.update_method,uri:this.prepare_uri("update",d),data:b};if(!this._async_write)return this.__ajax.syncCall(e);this.__ajax.asyncCall(this._include_callbacks(e,c.exception,c.success))}catch(f){throw new BetaJS.Stores.RemoteStoreException(f)}},_query:function(a,b,c){try{var d=this._encode_query(a,b);if(!this._async_read){var e=this.__ajax.syncCall(d);return BetaJS.Types.is_string(e)?JSON.parse(e):e}d=this._include_callbacks(d,c.exception,function(){c.success(BetaJS.Types.is_string(e)?JSON.parse(e):e)}),this.__ajax.asyncCall(d)}catch(f){throw new BetaJS.Stores.RemoteStoreException(f)}},_encode_query:function(){return{uri:this.prepare_uri("query")}}}),BetaJS.Stores.RemoteStore.extend("BetaJS.Stores.QueryGetParamsRemoteStore",{constructor:function(a,b,c,d){this._inherited(BetaJS.Stores.QueryGetParamsRemoteStore,"constructor",a,b,d),this.__capability_params=c},_query_capabilities:function(){var a={};return"skip"in this.__capability_params&&(a.skip=!0),"limit"in this.__capability_params&&(a.limit=!0),a},_encode_query:function(a,b){b=b||{};var c=this.getUri()+"?";return b.skip&&"skip"in this.__capability_params&&(c+=this.__capability_params.skip+"="+b.skip+"&"),b.limit&&"limit"in this.__capability_params&&(c+=this.__capability_params.limit+"="+b.limit+"&"),{uri:c}}}),BetaJS.Stores.BaseStore.extend("BetaJS.Stores.ConversionStore",{constructor:function(a,b){b=b||{},b.id_key=a._id_key,this._inherited(BetaJS.Stores.ConversionStore,"constructor",b),this.__store=a,this.__key_encoding=b.key_encoding||{},this.__key_decoding=b.key_decoding||{},this.__value_encoding=b.value_encoding||{},this.__value_decoding=b.value_decoding||{}},encode_object:function(a){var b={};for(var c in a)b[this.encode_key(c)]=this.encode_value(c,a[c]);return b},decode_object:function(a){var b={};for(var c in a)b[this.decode_key(c)]=this.decode_value(c,a[c]);return b},encode_key:function(a){return a in this.__key_encoding?this.__key_encoding[a]:a},decode_key:function(a){return a in this.__key_decoding?this.__key_decoding[a]:a},encode_value:function(a,b){return a in this.__value_encoding?this.__value_encoding[a](b):b},decode_value:function(a,b){return a in this.__value_decoding?this.__value_decoding[a](b):b},_insert:function(a){return this.decode_object(this.__store.insert(this.encode_object(a)))},_remove:function(a){return this.__store.remove(this.encode_value(this._id_key,a))},_get:function(a){return this.decode_object(this.__store.get(this.encode_value(this._id_key,a)))},_update:function(a,b){return this.decode_object(this.__store.update(this.encode_value(this._id_key,a),this.encode_object(b)))},_query_capabilities:function(){return this.__store._query_capabilities()},_query:function(a,b){var c=this,d=this.__store.query(this.encode_object(a),b);return new BetaJS.Iterators.MappedIterator(d,function(a){return c.decode_object(a)})}}),BetaJS.Stores.BaseStore.extend("BetaJS.Stores.PassthroughStore",{constructor:function(a,b){this.__store=a,b=b||{},b.id_key=a.id_key(),b.async_read=a.async_read,b.async_write=a.async_write,this._inherited(BetaJS.Stores.PassthroughStore,"constructor",b)},_supports_async_read:function(){return this.__store._supports_async_read()},_supports_async_write:function(){return this.__store._supports_async_read()},_query_capabilities:function(){return this.__store._query_capabilities()},_insert:function(a,b){return this.__store.insert(a,b)},_remove:function(a,b){return this.__store.remove(a,b)},_get:function(a){return this.__store.get(a)},_update:function(a,b,c){return this.__store.update(a,b,c)},_query:function(a,b){return this.__store.query(a,b)}}),BetaJS.Stores.PassthroughStore.extend("BetaJS.Stores.WriteQueueStore",{constructor:function(a,b){this._inherited(BetaJS.Stores.WriteQueueStore,"constructor",a,b),b=b||{},this.__update_queue={},this.__revision_id=1,this.__id_to_queue={},this.__combine_updates="combine_updates"in b?b.combine_updates:!0,this.__auto_clear_updates="auto_clear_updates"in b?b.auto_clear_updates:!0,this.__cache={},this.__auto_clear_updates&&this.on("remove",function(a){this.__remove_update(a)},this)},update:function(a,b,c){return this.__insert_update(a,b),c&&c.success&&c.success(a,b,b),b},__remove_update:function(a){this.__id_to_queue[a],delete this.__id_to_queue[a];for(var b in b)delete this.__update_queue[b];delete this.__cache[a]},__insert_update:function(a,b){if(this.__combine_updates&&this.__id_to_queue[a]){var c={};for(var d in this.__id_to_queue[a])c=BetaJS.Objs.extend(c,this.__update_queue[d].data),delete this.__update_queue[d];c=BetaJS.Objs.extend(c,b),this.__id_to_queue[a]={}}this.__id_to_queue[a]=this.__id_to_queue[a]||{},this.__id_to_queue[a][this.__revision_id]=!0,this.__update_queue[this.__revision_id]={id:a,data:b,revision_id:this.__revision_id},this.__cache[a]=BetaJS.Objs.extend(this.__cache[a]||{},b),this.__revision_id++,this.trigger("queue","update",a,b),this.trigger("queue:update",a,b)},flush:function(a,b){if(b||(b=this.__revision_id),this.async_write()){var c=null,d=this;for(var e in this.__update_queue){c=this.__update_queue[e];break}if(!c)return a&&a.success(),!0;if(c.revision_id>=b)return;this.__store.update(c.id,c.data,{exception:a.exception,success:function(){delete this.__update_queue[c.revision_id],delete this.__id_to_queue[c.id][c.revision_id],d.flush(a,b)}})}else try{BetaJS.Objs.iter(this.__update_queue,function(a){return a.revision_id>=b?!1:(this.__store.update(a.id,a.data),void 0)},this),a&&a.success&&a.success()}catch(f){if(!a||!a.exception)throw f;a.exception(f)}},changed:function(){return!BetaJS.Types.is_empty(this.__update_queue)},get:function(a){var b=this.__store.get(a);return b&&this.__cache[a]?BetaJS.Objs.extend(b,this.__cache[a]):b},query:function(a,b){var c=this;return new BetaJS.Iterators.MappedIterator(this.__store.query(a,b),function(a){return c.__cache[a[c.id_key()]]?BetaJS.Objs.extend(a,c.__cache[a[c.id_key()]]):a})}}),BetaJS.Class.extend("BetaJS.Stores.WriteQueueStoreManager",[BetaJS.Events.EventsMixin,{constructor:function(a){this._inherited(BetaJS.Stores.WriteQueueStoreManager,"constructor"),a=a||{},this.__stores={},this.__changed=!1,this.__min_delay=a.min_delay?a.min_delay:null,this.__max_delay=a.max_delay?a.max_delay:null,(this.__min_delay||this.__max_delay)&&this.on("changed",function(){this.flush()},this,{min_delay:this.__min_delay,max_delay:this.__max_delay})},destroy:function(){this.off(null,null,this),BetaJS.Objs.iter(this.__stores,function(a){this.unregister(a)},this),this._inherited(BetaJS.Stores.WriteQueueStoreManager,"destroy")},__get:function(a){return a
},register:function(a){a=this.__get(a),this.__stores[BetaJS.Ids.objectId(a)]=a,a.on("queue:update",function(){this.__changed=!0,this.trigger("changed")},this)},unregister:function(a){a=this.__get(a),delete this.__stores[BetaJS.Ids.objectId(a)],a.off(null,null,this)},flush:function(a){this.trigger("flush_start"),this.trigger("flush");var b=0,c=BetaJS.Objs.count(this.__stores),d=this;BetaJS.Objs.iter(this.__stores,function(e){e.flush({exception:function(b){if(d.trigger("flush_error"),!a||!a.exception)throw b;a.exception(b)},success:function(){b++,b==c&&(d.trigger("flush_end"),a&&a.success&&a.success())}})},this),this.__changed=!1,BetaJS.Objs.iter(this.__stores,function(a){this.__changed=this.__changed||a.changed()},this)}}]);