/*! betajs - v0.0.1 - 2013-08-07, Copyright (c) Oliver Friedmann & Victor Lingenthal, MIT Software License. */BetaJS.Net={},BetaJS.Net.AbstractAjax=BetaJS.Class.extend("AbstractAjax",{constructor:function(t){this._inherited(BetaJS.Net.AbstractAjax,"constructor"),this.__options=BetaJS.Objs.extend({method:"GET",data:{}},t)},syncCall:function(t){var e=BetaJS.Objs.clone(this.__options,1);e=BetaJS.Objs.extend(e,t);var i=e.success_callback;delete e.success_callback;var r=e.failure_callback;delete e.failure_callback;var n=e.complete_callback;delete e.complete_callback;try{var s=this._syncCall(e);return i&&i(s),n&&n(),s}catch(_){if(_=BetaJS.Exceptions.ensure(_),_.assert(BetaJS.Net.AjaxException),!r)throw _;r(_.status_code(),_.status_text(),_.data())}},asyncCall:function(t){var e=BetaJS.Objs.clone(this.__options,1);e=BetaJS.Objs.extend(e,t);var i=e.success_callback;delete e.success_callback;var r=e.failure_callback;delete e.failure_callback;var n=e.complete_callback;delete e.complete_callback;try{var s=this._asyncCall(BetaJS.Objs.extend({success:function(t){i&&i(t),n&&n()},failure:function(t,e,i){if(!r)throw new BetaJS.Net.AjaxException(t,e,i);r(t,e,i),n&&n()}},e));return s}catch(_){if(_=BetaJS.Exceptions.ensure(_),_.assert(BetaJS.Net.AjaxException),!r)throw _;r(_.status_code(),_.status_text(),_.data())}},call:function(t){if(!("async"in t))return!1;var e=t.async;return delete t.async,e?this.asyncCall(t):this.syncCall(t)},_syncCall:function(){},_asyncCall:function(){}}),BetaJS.Net.AjaxException=BetaJS.Exceptions.Exception.extend("AjaxException",{constructor:function(t,e,i){this._inherited(BetaJS.Net.AjaxException,"constructor",t+": "+e),this.__status_code=t,this.__status_text=e,this.__data=i},status_code:function(){return this.__status_code},status_text:function(){return this.__status_text},data:function(){return this.__data}}),BetaJS.Net.JQueryAjax=BetaJS.Net.AbstractAjax.extend("JQueryAjax",{_syncCall:function(t){var e;return BetaJS.$.ajax({type:t.method,async:!1,url:t.uri,data:JSON.stringify(t.data),success:function(t){e=t},error:function(t,e,i){throw new BetaJS.Net.AjaxException(i,e,t)}}),e},_asyncCall:function(t){BetaJS.$.ajax({type:t.method,async:!0,url:t.uri,data:JSON.stringify(t.data),success:function(e){t.success(e)},error:function(e,i,r){t.failure(r,i,e)}})}}),BetaJS.Queries={__dependencies:function(t,e){if(BetaJS.Types.is_array(t)){if(0==t.length)throw"Malformed Query";var i=t[0];if("Or"==i||"And"==i){for(var r=1;t.length>r;++r)e=this.__dependencies(t[r],e);return e}if(3!=t.length)throw"Malformed Query";var n=t[1];return n in e?e[n]++:e[n]=1,e}if(BetaJS.Types.is_object(t)){for(n in t)n in e?e[n]++:e[n]=1;return e}throw"Malformed Query"},dependencies:function(t){return this.__dependencies(t,{})},format:function(t){return BetaJS.Class.is_class_instance(t)?t.format():JSON.stringify(t)},overloaded_evaluate:function(t,e){return BetaJS.Class.is_class_instance(t)?t.evaluate(e):BetaJS.Types.is_function(t)?t(e):this.evaluate(t,e)},evaluate:function(t,e){if(null==e)return!1;if(BetaJS.Types.is_array(t)){if(0==t.length)throw"Malformed Query";var i=t[0];if("Or"==i){for(var r=1;t.length>r;++r)if(this.evaluate(t[r],e))return!0;return!1}if("And"==i){for(var r=1;t.length>r;++r)if(!this.evaluate(t[r],e))return!1;return!0}if(3!=t.length)throw"Malformed Query";var n=t[1],s=e[n],_=t[2];if("=="==i)return s==_;if("!="==i)return s!=_;if(">"==i)return s>_;if(">="==i)return s>=_;if("<"==i)return _>s;if("<="==i)return _>=s;throw"Malformed Query"}if(BetaJS.Types.is_object(t)){for(n in t)if(t[n]!=e[n])return!1;return!0}throw"Malformed Query"},__compile:function(t){if(BetaJS.Types.is_array(t)){if(0==t.length)throw"Malformed Query";var e=t[0];if("Or"==e){for(var i="false",r=1;t.length>r;++r)i+=" || ("+this.__compile(t[r])+")";return i}if("And"==e){for(var i="true",r=1;t.length>r;++r)i+=" && ("+this.__compile(t[r])+")";return i}if(3!=t.length)throw"Malformed Query";var n=t[1],s=t[2],_="object['"+n+"']",o=BetaJS.Types.is_string(s)?"'"+s+"'":s;return _+" "+e+" "+o}if(BetaJS.Types.is_object(t)){var i="true";for(n in t)i+=" && (object['"+n+"'] == "+(BetaJS.Types.is_string(t[n])?"'"+t[n]+"'":t[n])+")";return i}throw"Malformed Query"},compile:function(t){var e=this.__compile(t),i=Function("object",e),r=function(t){return i.call(this,t)};return r.source="function(object){\n return "+e+"; }",r},emulate:function(t,e,i){var r=e.apply(i||this,{}),n=r;return null==r?n=BetaJS.Iterators.ArrayIterator([]):BetaJS.Types.is_array(r)&&(n=BetaJS.Iterators.ArrayIterator(r)),new BetaJS.Iterators.FilteredIterator(n,function(e){return BetaJS.Queries.evaluate(t,e)})}},BetaJS.Queries.CompiledQuery=BetaJS.Class.extend("CompiledQuery",{constructor:function(t){this.__query=t,this.__dependencies=BetaJS.Query.dependencies(t),this.__compiled=BetaJS.Query.compile(t)},query:function(){return this.__query},dependencies:function(){return this.__dependencies},compiled:function(){return this.__compiled},evaluate:function(t){return this.__compiled(t)},format:function(){return BetaJS.Query.format(this.__query)}}),BetaJS.Queries.Constrained={make:function(t,e){return{query:t,options:e||{}}},format:function(t){var e=t.query;t.query=BetaJS.Queries.format(e);var i=JSON.stringify(t);return t.query=e,i},emulate:function(t,e,i,r){var n=t.query,s=t.options,_={},o={};"sort"in s&&"sort"in e&&(o.sort=s.sort),_=n,("query"in e||BetaJS.Types.is_empty(n))&&(_=n,(!("sort"in s)||"sort"in e)&&("skip"in s&&"skip"in e&&(o.skip=s.skip),"limit"in s&&"limit"in e&&(o.limit=s.limit)));var a=i.apply(r||this,[_,o]),c=a;return null==a?c=new BetaJS.Iterators.ArrayIterator([]):BetaJS.Types.is_array(a)&&(c=new BetaJS.Iterators.ArrayIterator(a)),"query"in e||BetaJS.Types.is_empty(n)||(c=new BetaJS.Iterators.FilteredIterator(c,function(t){return BetaJS.Queries.evaluate(n,t)})),"sort"in s&&!("sort"in o)&&(c=new BetaJS.Iterators.SortedIterator(c,BetaJS.Comparators.byObject(s.sort))),"skip"in s&&!("skip"in o)&&(c=new BetaJS.Iterators.SkipIterator(c,s.skip)),"limit"in s&&!("limit"in o)&&(c=new BetaJS.Iterators.LimitIterator(c,s.limit)),c}},BetaJS.Collections.QueryCollection=BetaJS.Collections.Collection.extend("QueryCollection",{constructor:function(t){this._inherited(BetaJS.Collections.QueryCollection,"constructor",t),this.__query=BetaJS.Objs.extend({func:null,select:{},skip:0,limit:null,forward_steps:null,backward_steps:null,range:null,count:null,sort:{}},t.query),"objects"in t||(t.objects=this.__execute_query(this.__query.skip,this.__query.limit,!0))},__execute_query:function(t,e,i){t=Math.max(t,0);var r={};if(null==this.__query.sort||BetaJS.Types.is_empty(this.__query.sort)||(r.sort=this.__query.sort),i){t>0&&(r.skip=t),null!=e&&(r.limit=e);var n=this.__query.func(this.__query.select,r),s=n.asArray();this.__query.skip=t,this.__query.limit=e,this.__query.count=null==e||e>s.length?t+s.length:null,this.clear(),this.add_objects(s)}else if(this.__query.skip>t){e=this.__query.skip-t,t>0&&(r.skip=t),r.limit=e;var n=this.__query.func(this.__query.select,r),s=n.asArray();this.__query.skip=t,this.__query.limit=null==this.__query.limit?null:this.__query.limit+s.length,this.add_objects(s)}else if(t>=this.__query.skip&&null!=this.__query.limit&&(null==e||t+e>this.__query.skip+this.__query.limit)){e=t+e-(this.__query.skip+this.__query.limit),t=this.__query.skip+this.__query.limit,t>0&&(r.skip=t),null!=e&&(r.limit=e);var n=this.__query.func(this.__query.select,r),s=n.asArray();this.__query.limit=this.__query.limit+s.length,e>s.length&&(this.__query.count=t+s.length),this.add_objects(s)}},increase_forwards:function(t){t=null==t?this.__query.forward_steps:t,null!=t&&null!=this.__query.limit&&this.__execute_query(this.__query.skip+this.__query.limit,t,!1)},increase_backwards:function(t){if(t=null==t?this.__query.backward_steps:t,null!=t&&this.__query.skip>0){var t=Math.min(t,this.__query.skip);this.__execute_query(this.__query.skip-t,t,!1)}},paginate:function(t){this.__execute_query(this.__query.range*t,this.__query.range,!0)},paginate_index:function(){return null==this.__query.range?null:Math.floor(this.__query.skip/this.__query.range)},paginate_count:function(){return null==this.__query.count||null==this.__query.range?null:Math.ceil(this.__query.count/this.__query.range)},next:function(){var t=this.paginate_index();if(null!=t){var e=this.paginate_count();(null==e||this.paginate_count()-1>t)&&this.paginate(t+1)}},prev:function(){var t=this.paginate_index();null!=t&&t>0&&this.paginate(t-1)},isComplete:function(){return null!=this.__query.count}}),BetaJS.Queries.ActiveQueryEngine=BetaJS.Class.extend("ActiveQueryEngine",{constructor:function(){this._inherited(BetaJS.Queries.ActiveQueryEngine,"constructor"),this.__aqs={},this.__object_to_aqs={},this.__match_to_aqs={},this.__uniform_aqs={}},__valid_for_aq:function(t,e){return BetaJS.Queries.evaluate(e.query(),t)},insert:function(t){if(!this.__object_to_aqs[BetaJS.Ids.objectId(t)]){var e=t.getAll(),i={};this.__object_to_aqs[BetaJS.Ids.objectId(t)]=i,BetaJS.Objs.iter(this.__uniform_aqs,function(e){e._add(t),i[BetaJS.Ids.objectId(e)]=e},this);for(var r in e){var n=r+":"+JSON.stringify(e[r]);this.__match_to_aqs[n]&&BetaJS.Objs.iter(this.__match_to_aqs[n],function(r){this.__valid_for_aq(e,r)&&(r._add(t),i[BetaJS.Ids.objectId(r)]=r)},this)}t.on("change",function(){this.update(t)},this)}},remove:function(t){BetaJS.Objs.iter(this.__object_to_aqs[BetaJS.Ids.objectId(t)],function(e){e._remove(t)},this),delete this.__object_to_aqs[BetaJS.Ids.objectId(t)],t.off(null,this,null)},update:function(t){var e=t.getAll(),i=this.__object_to_aqs[BetaJS.Ids.objectId(t)];BetaJS.Objs.iter(this.__object_to_aqs[BetaJS.Ids.objectId(t)],function(r){this.__valid_for_aq(e,r)||(r._remove(t),delete i[BetaJS.Ids.objectId(r)])},this);for(var r in e){var n=r+":"+JSON.stringify(e[r]);this.__match_to_aqs[n]&&BetaJS.Objs.iter(this.__match_to_aqs[n],function(r){BetaJS.Ids.objectId(r)in i||!this.__valid_for_aq(e,r)||(r._add(t),i[BetaJS.Ids.objectId(r)]=r)},this)}},register:function(t){t.isUniform()?this.__uniform_aqs[BetaJS.Ids.objectId(t)]=t:this.__aqs[BetaJS.Ids.objectId(t)]=t;var e=t.query();for(var i in e){var r=i+":"+JSON.stringify(e[i]);this.__match_to_aqs[r]=this.__match_to_aqs[r]||{},this.__match_to_aqs[r][BetaJS.Ids.objectId(t)]=t}for(var n=this._query(e);n.hasNext();){var s=n.next();this.__object_to_aqs[BetaJS.Ids.objectId(s)]?(this.__object_to_aqs[BetaJS.Ids.objectId(s)][BetaJS.Ids.objectId(t)]=t,t._add(s)):this.insert(s)}},unregister:function(t){t.isUniform()?delete this.__uniform_aqs[BetaJS.Ids.objectId(t)]:delete this.__aqs[BetaJS.Ids.objectId(t)];var e=this;t.collection().iterate(function(i){delete e.__object_to_aqs[BetaJS.Ids.objectId(i)][BetaJS.Ids.objectId(t)]});var i=t.query();for(var r in i){var n=r+":"+JSON.stringify(i[r]);delete this.__match_to_aqs[n][BetaJS.Ids.objectId(t)],BetaJS.Types.is_empty(this.__match_to_aqs[n])&&delete this.__match_to_aqs[n]}},_query:function(){}}),BetaJS.Queries.ActiveQuery=BetaJS.Class.extend("ActiveQuery",{constructor:function(t,e){this._inherited(BetaJS.Queries.ActiveQuery,"constructor"),this.__engine=t,this.__query=e,this.__collection=new BetaJS.Collections.Collection,t.register(this)},destroy:function(){this.__engine.unregister(this),this._inherited(BetaJS.Queries.ActiveQuery,"destroy")},isUniform:function(){return BetaJS.Types.is_empty(this.query())},engine:function(){return this.__engine},query:function(){return this.__query},collection:function(){return this.__collection},_add:function(t){this.__collection.add(t)},_remove:function(t){this.__collection.remove(t)},change_query:function(t){this.__engine.unregister(this),this.__query=t,this.__collection.clear(),this.__engine.register(this)}}),BetaJS.Stores=BetaJS.Stores||{},BetaJS.Stores.StoreException=BetaJS.Exceptions.Exception.extend("StoreException"),BetaJS.Stores.BaseStore=BetaJS.Class.extend("BaseStore",[BetaJS.Events.EventsMixin,{constructor:function(t){this._inherited(BetaJS.Stores.BaseStore,"constructor"),t=t||{},this._id_key=t.id_key||"id",this._create_ids=t.create_ids||!1,this._last_id=1},_insert:function(){},_remove:function(){},_get:function(){},_update:function(){},_query_capabilities:function(){return{}},_query:function(){},insert:function(t){if(this._create_ids)if(this._id_key in t){if(this.get(t[this._id_key]))return null}else{for(;this.get(this._last_id);)this._last_id++;t[this._id_key]=this._last_id}var e=this._insert(t);return e&&this.trigger("insert",e),e},remove:function(t){var e=this._remove(t);return e&&this.trigger("remove",t),e},get:function(t){return this._get(t)},update:function(t,e){var i=this._update(t,e);return i&&this.trigger("update",i,e),i},query:function(t,e){return BetaJS.Queries.Constrained.emulate(BetaJS.Queries.Constrained.make(t||{},e||{}),this._query_capabilities(),this._query,this)},_query_applies_to_id:function(t,e){var i=this.get(e);return i&&BetaJS.Queries.overloaded_evaluate(t,i)},clear:function(){for(var t=this.query({});t.hasNext();)this.remove(t.next().id)}}]),BetaJS.Stores.AssocStore=BetaJS.Stores.BaseStore.extend("AssocStore",{_read_key:function(){},_write_key:function(){},_remove_key:function(){},_iterate:function(){},constructor:function(t){t=t||{},t.create_ids=!0,this._inherited(BetaJS.Stores.AssocStore,"constructor",t)},_insert:function(t){return this._write_key(t[this._id_key],t),t},_remove:function(t){var e=this._read_key(t);return e&&!this._remove_key(t)?null:e},_get:function(t){return this._read_key(t)},_update:function(t,e){var i=this._get(t);return i&&(delete e[this._id_key],BetaJS.Objs.extend(i,e),this._write_key(t,i)),i},_query:function(){return this._iterate()}}),BetaJS.Stores.MemoryStore=BetaJS.Stores.AssocStore.extend("MemoryStore",{constructor:function(t){this._inherited(BetaJS.Stores.MemoryStore,"constructor",t),this.__data={}},_read_key:function(t){return this.__data[t]},_write_key:function(t,e){this.__data[t]=e},_remove_key:function(t){delete this.__data[t]},_iterate:function(){return new BetaJS.Iterators.ObjectValuesIterator(this.__data)}}),BetaJS.Stores.DumbStore=BetaJS.Stores.BaseStore.extend("DumbStore",{_read_last_id:function(){},_write_last_id:function(){},_remove_last_id:function(){},_read_first_id:function(){},_write_first_id:function(){},_remove_first_id:function(){},_read_item:function(){},_write_item:function(){},_remove_item:function(){},_read_next_id:function(){},_write_next_id:function(){},_remove_next_id:function(){},_read_prev_id:function(){},_write_prev_id:function(){},_remove_prev_id:function(){},constructor:function(t){t=t||{},t.create_ids=!0,this._inherited(BetaJS.Stores.DumbStore,"constructor",t)},_insert:function(t){var e=this._read_last_id(),i=t[this._id_key];return null!=e?(this._write_next_id(e,i),this._write_prev_id(i,e)):this._write_first_id(i),this._write_last_id(i),this._write_item(i,t),t},_remove:function(t){var e=this._read_item(t);if(e){this._remove_item(t);var i=this._read_next_id(t),r=this._read_prev_id(t);null!=i?(this._remove_next_id(t),null!=r?(this._remove_prev_id(t),this._write_next_id(r,i),this._write_prev_id(i,r)):(this._remove_prev_id(i),this._write_first_id(i))):null!=r?(this._remove_next_id(r),this._write_last_id(r)):(this._remove_first_id(),this._remove_last_id())}return e},_get:function(t){return this._read_item(t)},_update:function(t,e){var i=this._get(t);return i&&(delete e[this._id_key],BetaJS.Objs.extend(i,e),this._write_item(t,i)),i},_query_capabilities:function(){return{query:!0}},_query:function(t){var e=new BetaJS.Iterators.Iterator,i=this,r=this._read_first_id();return BetaJS.Objs.extend(e,{__id:null==r?1:r,__store:i,__query:t,hasNext:function(){var e=this.__store._read_last_id();if(null==e)return!1;for(;e>this.__id&&!this.__store._read_item(this.__id);)this.__id++;for(;e>=this.__id;){if(this.__store._query_applies_to_id(t,this.__id))return!0;e>this.__id?this.__id=this.__store._read_next_id(this.__id):this.__id++}return!1},next:function(){if(this.hasNext()){var t=this.__store.get(this.__id);return this.__id==this.__store._read_last_id()?this.__id++:this.__id=this.__store._read_next_id(this.__id),t}return null}}),e}}),BetaJS.Stores.AssocDumbStore=BetaJS.Stores.DumbStore.extend("AssocDumbStore",{_read_key:function(){},_write_key:function(){},_remove_key:function(){},__read_id:function(t){var e=this._read_key(t);return e?parseInt(e):null},_read_last_id:function(){return this.__read_id("last_id")},_write_last_id:function(t){this._write_key("last_id",t)},_remove_last_id:function(){this._remove_key("last_id")},_read_first_id:function(){return this.__read_id("first_id")},_write_first_id:function(t){this._write_key("first_id",t)},_remove_first_id:function(){this._remove_key("first_id")},_read_item:function(t){return this._read_key("item_"+t)},_write_item:function(t,e){this._write_key("item_"+t,e)},_remove_item:function(t){this._remove_key("item_"+t)},_read_next_id:function(t){return this.__read_id("next_"+t)},_write_next_id:function(t,e){this._write_key("next_"+t,e)},_remove_next_id:function(t){this._remove_key("next_"+t)},_read_prev_id:function(t){return this.__read_id("prev_"+t)},_write_prev_id:function(t,e){this._write_key("prev_"+t,e)},_remove_prev_id:function(t){this._remove_key("prev_"+t)}}),BetaJS.Stores.LocalStore=BetaJS.Stores.AssocDumbStore.extend("LocalStore",{constructor:function(t){this._inherited(BetaJS.Stores.LocalStore,"constructor",t),this.__prefix=t.prefix},__key:function(t){return this.__prefix+t},_read_key:function(t){var e=this.__key(t);return e in localStorage?JSON.parse(localStorage[e]):null},_write_key:function(t,e){localStorage[this.__key(t)]=JSON.stringify(e)},_remove_key:function(t){delete localStorage[this.__key(t)]}}),BetaJS.Stores.QueryCachedStore=BetaJS.Stores.BaseStore.extend("QueryCachedStore",{constructor:function(t,e){e=e||{},e.id_key=t._id_key,this._inherited(BetaJS.Stores.QueryCachedStore,"constructor",e),this.__parent=t,this.__cache={},this.__queries={}},invalidate:function(){this.__cache={},this.__queries={}},_insert:function(t){var e=this.__parent.insert(t);return e&&(this.__cache[t[this._id_key]]=t),e},_remove:function(t){var e=this.__parent.remove(t);return e&&delete this.__cache[t],e},_update:function(t,e){var i=this.__parent.update(t,e);return i&&(this.__cache[t]=BetaJS.Objs.extend(this.__cache[t],e)),i},_get:function(t){return t in this.__cache||(this.__cache[t]=this.__parent.get(t)),this.__cache[t]},_query_capabilities:function(){return this.__parent._query_capabilities()},_query:function(t,e){var i=BetaJS.Queries.Constrained.make(t,e),r=BetaJS.Queries.Constrained.format(i);if(r in this.__queries)return new BetaJS.Iterators.ArrayIterator(BetaJS.Objs.values(this.__queries[r]));var n=this.__parent.query(t,e).asArray();this.__queries[r]={};for(var s=0;n.length>s;++s)this.__cache_row(n[s],r);return new BetaJS.Iterators.ArrayIterator(n)},cache:function(t,e,i){var r=BetaJS.Queries.Constrained.make(t,e),n=BetaJS.Queries.Constrained.format(r);this.__queries[n]={};for(var s=0;i.length>s;++s)this.__cache_row(i[s],n)},__cache_row:function(t,e){this.trigger("cache",t),this.__cache[t[this._id_key]]=t,this.__queries[e][t[this._id_key]]=t}}),BetaJS.Stores.FullyCachedStore=BetaJS.Stores.BaseStore.extend("FullyCachedStore",{constructor:function(t,e,i){i=i||{},i.id_key=t._id_key,this._inherited(BetaJS.Stores.FullyCachedStore,"constructor",i),this.__parent=t,this.__cache={},this.__cached=!1,e&&this.invalidate(e)},invalidate:function(t){for(this.__cache={},t||(t=this.__parent.query({})),BetaJS.Types.is_array(t)&&(t=new BetaJS.Iterators.ArrayIterator(t));t.hasNext();){var e=t.next();this.cache(e)}this.__cached=!0},cache:function(t){this.trigger("cache",t),this.__cache[t[this._id_key]]=t},_insert:function(t){this.__cached||this.invalidate({});var e=this.__parent.insert(t);return e&&(this.__cache[t[this._id_key]]=t),e},_remove:function(t){this.__cached||this.invalidate({});var e=this.__parent.remove(t);return e&&delete this.__cache[t],e},_get:function(t){return this.__cached||this.invalidate({}),this.__cache[t]},_update:function(t,e){this.__cached||this.invalidate({});var i=this.__parent.update(t,e);return i&&(this.__cache[t]=BetaJS.Objs.extend(this.__cache[t],e)),i},_query:function(){return this.__cached||this.invalidate(),new BetaJS.Iterators.ArrayIterator(BetaJS.Objs.values(this.__cache))}}),BetaJS.Stores.RemoteStore=BetaJS.Stores.BaseStore.extend("RemoteStore",{constructor:function(t,e,i){this._inherited(BetaJS.Stores.RemoteStore,"constructor",i),this._uri=t,this.__ajax=e,this.__options=BetaJS.Objs.extend({update_method:"PUT",uri_mappings:{}},i||{})},getUri:function(){return this._uri},prepare_uri:function(t,e){return this.__options.uri_mappings[t]?this.__options.uri_mappings[t](e):"remove"==t||"get"==t||"update"==t?this.getUri()+"/"+e[this._id_key]:this.getUri()},_insert:function(t){try{return this.__ajax.syncCall({method:"POST",uri:this.prepare_uri("insert",t),data:t})}catch(e){throw new BetaJS.Stores.StoreException(""+BetaJS.Net.AjaxException.ensure(e))}},_remove:function(t){try{var e=this.__ajax.syncCall({method:"DELETE",uri:this.prepare_uri("remove",data)});return e?e:(e={},e[this._id_key]=t,e)}catch(i){throw new BetaJS.Stores.StoreException(""+BetaJS.Net.AjaxException.ensure(i))}},_get:function(t){var e={};e[this._id_key]=t;try{return this.__ajax.syncCall({uri:this.prepare_uri("get",e)})}catch(i){throw new BetaJS.Stores.StoreException(""+BetaJS.Net.AjaxException.ensure(i))}},_update:function(t,e){var i=BetaJS.Objs.clone(e,1);i[this._id_key]=t;try{return this.__ajax.syncCall({method:this.__options.update_method,uri:this.prepare_uri("update",i),data:e})}catch(r){throw new BetaJS.Stores.StoreException(""+BetaJS.Net.AjaxException.ensure(r))}},_query:function(t,e){try{var i=this.__ajax.syncCall(this._encode_query(t,e));return BetaJS.Types.is_string(i)?JSON.parse(i):i}catch(r){throw new BetaJS.Stores.StoreException(""+BetaJS.Net.AjaxException.ensure(r))}},_encode_query:function(){return{uri:this.prepare_uri("query")}}}),BetaJS.Stores.QueryGetParamsRemoteStore=BetaJS.Stores.RemoteStore.extend("QueryGetParamsRemoteStore",{constructor:function(t,e,i,r){this._inherited(BetaJS.Stores.QueryGetParamsRemoteStore,"constructor",t,e,r),this.__capability_params=i},_query_capabilities:function(){var t={};return"skip"in this.__capability_params&&(t.skip=!0),"limit"in this.__capability_params&&(t.limit=!0),t},_encode_query:function(t,e){e=e||{};var i=this.getUri()+"?";return e.skip&&"skip"in this.__capability_params&&(i+=this.__capability_params.skip+"="+e.skip+"&"),e.limit&&"limit"in this.__capability_params&&(i+=this.__capability_params.limit+"="+e.limit+"&"),{uri:i}}}),BetaJS.Stores.ConversionStore=BetaJS.Stores.BaseStore.extend("ConversionStore",{constructor:function(t,e){e=e||{},e.id_key=t._id_key,this._inherited(BetaJS.Stores.ConversionStore,"constructor",e),this.__store=t,this.__key_encoding=e.key_encoding||{},this.__key_decoding=e.key_decoding||{},this.__value_encoding=e.value_encoding||{},this.__value_decoding=e.value_decoding||{}},encode_object:function(t){var e={};for(var i in t)e[this.encode_key(i)]=this.encode_value(i,t[i]);return e},decode_object:function(t){var e={};for(var i in t)e[this.decode_key(i)]=this.decode_value(i,t[i]);return e},encode_key:function(t){return t in this.__key_encoding?this.__key_encoding[t]:t},decode_key:function(t){return t in this.__key_decoding?this.__key_decoding[t]:t},encode_value:function(t,e){return t in this.__value_encoding?this.__value_encoding[t](e):e},decode_value:function(t,e){return t in this.__value_decoding?this.__value_decoding[t](e):e},_insert:function(t){return this.decode_object(this.__store.insert(this.encode_object(t)))},_remove:function(t){return this.__store.remove(this.encode_value(this._id_key,t))},_get:function(t){return this.decode_object(this.__store.get(this.encode_value(this._id_key,t)))},_update:function(t,e){return this.decode_object(this.__store.update(this.encode_value(this._id_key,t),this.encode_object(e)))},_query_capabilities:function(){return this.__store._query_capabilities()},_query:function(t,e){var i=this,r=this.__store.query(this.encode_object(t),e);return new BetaJS.Iterators.MappedIterator(r,function(t){return i.decode_object(t)})}}),BetaJS.Stores.IndexedStore=BetaJS.Stores.BaseStore.extend("IndexedStore",{constructor:function(t,e,i){i=i||{},i.rebuild="rebuild"in i?i.rebuild:!0,i.id_key=t._id_key,this._inherited(BetaJS.Stores.IndexedStore,"constructor",i),this._store=t,this._indices={},BetaJS.Objs.iter(e||{},function(e,r){e.type=e.type||"StoreIndex",this._indices[r]=new BetaJS.Stores[e.type](t,r),i.rebuild&&this._indices[r].rebuild()},this)},rebuild:function(){BetaJS.Objs.iter(this._indices,function(t){t.rebuild()},this)},_query:function(t,e){var i=!1,r={};for(var n in t)if(n in this._indices){if(i){var s=this._indices[n].get(t[n]);r=BetaJS.Objs.intersect(r,s)}else i=!0,r=this._indices[n].get(t[n]);if(BetaJS.Types.is_empty(r))return{}}if(!i)return this._store.query(t,e);var _=this;return new BetaJS.Iterators.MappedIterator(new BetaJS.Iterators.FilteredIterator(new BetaJS.Iterators.ObjectKeysIterator(r),function(e){return _._query_applies_to_id(t,e)}),function(t){return _.get(t)})},_insert:function(t){return this._store.insert(t)},_remove:function(t){return this._store.remove(t)},_get:function(t){return this._store.get(t)},_update:function(t,e){return this._store.update(t,e)}}),BetaJS.Stores.StoreIndex=BetaJS.Class.extend("StoreIndex",{constructor:function(t,e){this._inherited(BetaJS.Stores.StoreIndex,"constructor"),this._base_store=t,this._index_key=e,this._id_to_key={},this._key_to_ids={},this._base_store.on("insert",function(t){this._insert(t)},this),this._base_store.on("remove",function(t){this._remove(t)},this),this._base_store.on("update",function(t){this._exists(t)||(this._remove(this._id(t)),this._insert(t))},this)},destroy:function(){this._base_store.off(null,null,this),this._inherited(BetaJS.Stores.StoreIndex,"destroy")},rebuild:function(){for(var t=this._base_store.query();t.hasNext();)this.insert(t.next())},_id:function(t){return t[this._base_store._id_key]},_key:function(t){return t[this._index_key]},_insert:function(t){var e=this._id(t),i=this._key(t);this._id_to_key[e]=i,i in this._key_to_ids||(this._key_to_ids[i]={}),this._key_to_ids[i][e]=!0},_remove:function(t){this._id_to_key[t],delete this._id_to_key[t],delete this._key_to_ids[t]},_exists:function(t){return this._id(t)in this._id_to_key},get:function(t){return t in this._key_to_ids?this._key_to_ids[t]:[]}});