/*! betajs - v0.0.1 - 2013-06-16, Copyright (c) Oliver Friedmann & Victor Lingenthal, MIT Software License. */BetaJS.Net={},BetaJS.Net.AbstractAjax=BetaJS.Class.extend("AbstractAjax",{constructor:function(t){this._inherited(BetaJS.Net.AbstractAjax,"constructor"),this.__options=BetaJS.Objs.extend({method:"GET",data:{}},t)},syncCall:function(t){var e=BetaJS.Objs.clone(this.__options,1);e=BetaJS.extend(e,t);var i=e.success_callback;delete e.success_callback;var n=e.failure_callback;delete e.failure_callback;var r=e.complete_callback;delete e.complete_callback;try{var s=this._syncCall(e);return i&&i(s),r&&r(),s}catch(_){if(_=BetaJS.Exceptions.ensure(_),_.assert(BetaJS.Net.AjaxException),!n)throw _;n(_.status_code(),_.status_text(),_.data())}},asyncCall:function(t){var e=BetaJS.Objs.clone(this.__options,1);e=BetaJS.extend(e,t);var i=e.success_callback;delete e.success_callback;var n=e.failure_callback;delete e.failure_callback;var r=e.complete_callback;delete e.complete_callback;try{var s=this._asyncCall(BetaJS.Objs.extend({success:function(t){i&&i(t),r&&r()},failure:function(t,e,i){if(!n)throw new BetaJS.Net.AjaxException(t,e,i);n(t,e,i),r&&r()}},e));return s}catch(_){if(_=BetaJS.Exceptions.ensure(_),_.assert(BetaJS.Net.AjaxException),!n)throw _;n(_.status_code(),_.status_text(),_.data())}},call:function(t){if(!("async"in t))return!1;var e=t.async;return delete t.async,e?this.asyncCall(t):this.syncCall(t)},_syncCall:function(){},_asyncCall:function(){}}),BetaJS.Net.AjaxException=BetaJS.Exceptions.Exception.extend("AjaxException",{constructor:function(t,e,i){this._inherited(BetaJS.Net.AjaxException,"constructor",t+": "+e),this.__status_code=t,this.__status_text=e,this.__data=i},status_code:function(){return this.__status_code},status_text:function(){return this.__status_text},data:function(){return this.__data}}),BetaJS.Net.JQueryAjax=BetaJS.Net.AbstractAjax.extend("JQueryAjax",{_syncCall:function(t){var e;return BetaJS.$.ajax({type:t.method,async:!1,url:t.uri,data:JSON.stringify(t.data),success:function(t){e=t},error:function(t,e,i){throw new BetaJS.Net.AjaxException(i,e,t)}}),e},_asyncCall:function(t){BetaJS.$.ajax({type:t.method,async:!0,url:t.uri,data:JSON.stringify(t.data),success:function(e){t.success(e)},error:function(e,i,n){t.failure(n,i,e)}})}}),BetaJS.Queries={__dependencies:function(t,e){if(BetaJS.Types.is_array(t)){if(0==t.length)throw"Malformed Query";var i=t[0];if("Or"==i||"And"==i){for(var n=1;t.length>n;++n)e=this.__dependencies(t[n],e);return e}if(3!=t.length)throw"Malformed Query";var r=t[1];return r in e?e[r]++:e[r]=1,e}if(BetaJS.Types.is_object(t)){for(r in t)r in e?e[r]++:e[r]=1;return e}throw"Malformed Query"},dependencies:function(t){return this.__dependencies(t,{})},evaluate:function(t,e){if(BetaJS.Types.is_array(t)){if(0==t.length)throw"Malformed Query";var i=t[0];if("Or"==i){for(var n=1;t.length>n;++n)if(this.evaluate(t[n],e))return!0;return!1}if("And"==i){for(var n=1;t.length>n;++n)if(!this.evaluate(t[n],e))return!1;return!0}if(3!=t.length)throw"Malformed Query";var r=t[1],s=e[r],_=t[2];if("=="==i)return s==_;if("!="==i)return s!=_;if(">"==i)return s>_;if(">="==i)return s>=_;if("<"==i)return _>s;if("<="==i)return _>=s;throw"Malformed Query"}if(BetaJS.Types.is_object(t)){for(r in t)if(t[r]!=e[r])return!1;return!0}throw"Malformed Query"},__compile:function(t){if(BetaJS.Types.is_array(t)){if(0==t.length)throw"Malformed Query";var e=t[0];if("Or"==e){for(var i="false",n=1;t.length>n;++n)i+=" || ("+this.__compile(t[n])+")";return i}if("And"==e){for(var i="true",n=1;t.length>n;++n)i+=" && ("+this.__compile(t[n])+")";return i}if(3!=t.length)throw"Malformed Query";var r=t[1],s=t[2],_="object['"+r+"']",o=BetaJS.Types.is_string(s)?"'"+s+"'":s;return _+" "+e+" "+o}if(BetaJS.Types.is_object(t)){var i="true";for(r in t)i+=" && (object['"+r+"'] == "+(BetaJS.Types.is_string(t[r])?"'"+t[r]+"'":t[r])+")";return i}throw"Malformed Query"},compile:function(){var t=Function("object",result),e=function(e){return t.call(this,e)};return e.source="function(object){\n"+result+"}",e}},BetaJS.Queries.CompiledQuery=BetaJS.Class.extend("CompiledQuery",{constructor:function(t){this.__query=t,this.__dependencies=BetaJS.Query.dependencies(t),this.__compiled=BetaJS.Query.compile(t)},query:function(){return this.__query},dependencies:function(){return this.__dependencies},compiled:function(){return this.__compiled},evaluate:function(t){return this.__compiled(t)}}),BetaJS.Stores=BetaJS.Stores||{},BetaJS.Stores.StoreException=BetaJS.Exceptions.Exception.extend("StoreException"),BetaJS.Stores.BaseStore=BetaJS.Class.extend("BaseStore",[BetaJS.Events.EventsMixin,{_insert:function(){},_remove:function(){},_get:function(){},_update:function(){},_query:function(){},_insertEvent:function(t,e){this.trigger("insert",t,e),this.trigger("external",t)},_updateEvent:function(t,e,i){this.trigger("update",t,e,i),this.trigger("external",t,e)},_removeEvent:function(t,e){this.trigger("remove",t,e),this.trigger("external",t)},insert:function(t){var e=this._insert(t);return e&&this._insertEvent(e,!0),e},remove:function(t){var e=this._remove(t);return e&&this._removeEvent(e,!0),e},get:function(t){return this._get(t)},update:function(t,e){var i=this._update(t,e);return i&&this._updateEvent(i,e,!0),i},query:function(t,e){return this._query(t,e)},_query_applies_to_id:function(t,e){var i=this.get(e);return i&&BetaJS.Queries.evaluate(t,i)},clear:function(){for(var t=this.query({});t.hasNext();)this.remove(t.next().id)}}]),BetaJS.Stores.DumbStore=BetaJS.Stores.BaseStore.extend("DumbStore",{_read_last_id:function(){},_write_last_id:function(){},_remove_last_id:function(){},_read_first_id:function(){},_write_first_id:function(){},_remove_first_id:function(){},_read_item:function(){},_write_item:function(){},_remove_item:function(){},_read_next_id:function(){},_write_next_id:function(){},_remove_next_id:function(){},_read_prev_id:function(){},_write_prev_id:function(){},_remove_prev_id:function(){},_insert:function(t){var e=this._read_last_id(),i=1;return null!=e?(i=e+1,this._write_next_id(e,i),this._write_prev_id(i,e)):this._write_first_id(i),t.id=i,this._write_last_id(i),this._write_item(i,t),t},_remove:function(t){var e=this._read_item(t);if(e){this._remove_item(t);var i=this._read_next_id(t),n=this._read_prev_id(t);null!=i?(this._remove_next_id(t),null!=n?(this._remove_prev_id(t),this._write_next_id(n,i),this._write_prev_id(i,n)):(this._remove_prev_id(i),this._write_first_id(i))):null!=n?(this._remove_next_id(n),this._write_last_id(n)):(this._remove_first_id(),this._remove_last_id())}return e},_get:function(t){return this._read_item(t)},_update:function(t,e){var i=this._get(t);return i&&(delete e.id,BetaJS.Objs.extend(i,e),this._write_item(t,i)),i},_query:function(t){var e=new BetaJS.Iterators.Iterator,i=this,n=this._read_first_id();return BetaJS.Objs.extend(e,{__id:null==n?1:n,__store:i,__query:t,hasNext:function(){var e=this.__store._read_last_id();if(null==e)return!1;for(;e>this.__id&&!this.__store._read_item(this.__id);)this.__id++;for(;e>=this.__id;){if(this.__store._query_applies_to_id(t,this.__id))return!0;e>this.__id?this.__id=this.__store._read_next_id(this.__id):this.__id++}return!1},next:function(){if(this.hasNext()){var t=this.__store.get(this.__id);return this.__id==this.__store._read_last_id()?this.__id++:this.__id=this.__store._read_next_id(this.__id),t}return null}}),e}}),BetaJS.Stores.AssocStore=BetaJS.Stores.DumbStore.extend("AssocStore",{_read_key:function(){},_write_key:function(){},_remove_key:function(){},__read_id:function(t){var e=this._read_key(t);return e?parseInt(e):null},_read_last_id:function(){return this.__read_id("last_id")},_write_last_id:function(t){this._write_key("last_id",t)},_remove_last_id:function(){this._remove_key("last_id")},_read_first_id:function(){return this.__read_id("first_id")},_write_first_id:function(t){this._write_key("first_id",t)},_remove_first_id:function(){this._remove_key("first_id")},_read_item:function(t){return this._read_key("item_"+t)},_write_item:function(t,e){this._write_key("item_"+t,e)},_remove_item:function(t){this._remove_key("item_"+t)},_read_next_id:function(t){return this.__read_id("next_"+t)},_write_next_id:function(t,e){this._write_key("next_"+t,e)},_remove_next_id:function(t){this._remove_key("next_"+t)},_read_prev_id:function(t){return this.__read_id("prev_"+t)},_write_prev_id:function(t,e){this._write_key("prev_"+t,e)},_remove_prev_id:function(t){this._remove_key("prev_"+t)}}),BetaJS.Stores.LocalStore=BetaJS.Stores.AssocStore.extend("LocalStore",{constructor:function(t){this._inherited(BetaJS.Stores.LocalStore,"constructor"),this.__prefix=t},__key:function(t){return this.__prefix+t},_read_key:function(t){var e=this.__key(t);return e in localStorage?JSON.parse(localStorage[e]):null},_write_key:function(t,e){localStorage[this.__key(t)]=JSON.stringify(e)},_remove_key:function(t){delete localStorage[this.__key(t)]}}),BetaJS.Stores.MemoryStore=BetaJS.Stores.AssocStore.extend("MemoryStore",{_read_key:function(t){return this[t]},_write_key:function(t,e){this[t]=e},_remove_key:function(t){delete this[t]}}),BetaJS.Stores.CachedStore=BetaJS.Stores.BaseStore.extend("CachedStore",{constructor:function(t){this._inherited(BetaJS.Stores.CachedStore,"constructor"),this.__parent=t,this.__cache=[]},_insert:function(t){var e=this.__parent._insert(t);return e&&(this.__cache[e.id]={data:e,exists:!0}),e},_remove:function(t){return t in this._cache||(this.__cache[t]={}),this.__cache[t].exists=!1,this.__parent._remove(t)},_get:function(t){if(t in this.__cache)return this.__cache[t].exists;var e=this.__parent.get(t);return this.__cache[t]=e?{exists:!0,data:e}:{exists:!1},e},_update:function(t,e){var i=this.__parent.update(t,e);return i&&(this.__cache[t]={exists:!0,data:e}),i},invalidate:function(t){delete this.__cache[t]},_query:function(t,e){return this.__parent.query(t,e)}}),BetaJS.Stores.RemoteStore=BetaJS.Stores.BaseStore.extend("RemoteStore",{constructor:function(t,e){this._inherited(BetaJS.Stores.RemoteStore,"constructor"),this.__uri=t,this.__ajax=e},_insert:function(t){try{return this.__ajax.syncCall({method:"POST",uri:this.__uri,data:t})}catch(e){throw new BetaJS.Stores.StoreException(""+BetaJS.Net.AjaxException.ensure(e))}},_remove:function(t){try{var e=this.__ajax.syncCall({method:"DELETE",uri:this.__uri+"/"+t});return e?e:{id:t}}catch(i){throw new BetaJS.Stores.StoreException(""+BetaJS.Net.AjaxException.ensure(i))}},_get:function(t){try{return this.__ajax.syncCall({uri:this.__uri+"/"+t})}catch(e){throw new BetaJS.Stores.StoreException(""+BetaJS.Net.AjaxException.ensure(e))}},_update:function(t,e){try{return this.__ajax.syncCall({method:"PUT",uri:this.__uri+"/"+t,data:e})}catch(i){throw new BetaJS.Stores.StoreException(""+BetaJS.Net.AjaxException.ensure(i))}},_query:function(t){try{var e=this.__ajax.syncCall({uri:this.__uri});return null==e?BetaJS.Iterators.ArrayIterator([]):new BetaJS.Iterators.FilteredIterator(new BetaJS.Iterators.ArrayIterator(e),function(e){return BetaJS.Queries.evaluate(t,e)})}catch(i){throw new BetaJS.Stores.StoreException(""+BetaJS.Net.AjaxException.ensure(i))}}});