/*! betajs - v0.0.2 - 2014-04-03, Copyright (c) Oliver Friedmann & Victor Lingenthal, MIT Software License. */BetaJS.Queries={__increase_dependency:function(t,e){return t in e?e[t]++:e[t]=1,e},__dependencies_queries:function(t,e){return BetaJS.Objs.iter(t,function(t){e=this.__dependencies_query(t,e)},this),e},__dependencies_query:function(t,e){for(key in t)e=this.__dependencies_pair(key,t[key],e);return e},__dependencies_pair:function(t,e,i){return"$or"==t||"$and"==t?this.__dependencies_queries(e,i):this.__increase_dependency(t,i)},dependencies:function(t){return this.__dependencies_query(t,{})},__evaluate_query:function(t,e){for(var i in t)if(!this.__evaluate_pair(i,t[i],e))return!1;return!0},__evaluate_pair:function(t,e,i){return"$or"==t?this.__evaluate_or(e,i):"$and"==t?this.__evaluate_and(e,i):this.__evaluate_value(e,i[t])},__evaluate_value:function(t,e){if(BetaJS.Types.is_object(t)){var i=!0;return BetaJS.Objs.iter(t,function(t,s){"$in"==s&&(i=i&&BetaJS.Objs.contains_value(t,e)),"$gt"==s&&(i=i&&e>=t),"$gtic"==s&&(i=i&&e.toLowerCase()>=t.toLowerCase()),"$lt"==s&&(i=i&&t>=e),"$ltic"==s&&(i=i&&e.toLowerCase()<=t.toLowerCase()),"$sw"==s&&(i=i&&0===e.indexOf(t)),"$swic"==s&&(i=i&&0===e.toLowerCase().indexOf(t.toLowerCase()))},this),i}return t==e},__evaluate_or:function(t,e){return BetaJS.Objs.iter(t,function(t){return this.__evaluate_query(t,e)?!0:void 0},this),!1},__evaluate_and:function(t,e){return BetaJS.Objs.iter(t,function(t){return this.__evaluate_query(t,e)?void 0:!1},this),!0},format:function(t){return BetaJS.Class.is_class_instance(t)?t.format():JSON.stringify(t)},overloaded_evaluate:function(t,e){return BetaJS.Class.is_class_instance(t)?t.evaluate(e):BetaJS.Types.is_function(t)?t(e):this.evaluate(t,e)},evaluate:function(t,e){return this.__evaluate_query(t,e)},emulate:function(t,e,i){var s=e.apply(i||this,{}),n=s;return s?BetaJS.Types.is_array(s)&&(n=BetaJS.Iterators.ArrayIterator(s)):n=BetaJS.Iterators.ArrayIterator([]),new BetaJS.Iterators.FilteredIterator(n,function(e){return BetaJS.Queries.evaluate(t,e)})}},BetaJS.Queries.Constrained={make:function(t,e){return{query:t,options:e||{}}},format:function(t){var e=t.query;t.query=BetaJS.Queries.format(e);var i=JSON.stringify(t);return t.query=e,i},emulate:function(t,e,i,s,n){var r=t.query,_=t.options,o={},a={};"sort"in _&&"sort"in e&&(a.sort=_.sort),o=r,("query"in e||BetaJS.Types.is_empty(r))&&(o=r,(!("sort"in _)||"sort"in e)&&("skip"in _&&"skip"in e&&(a.skip=_.skip),"limit"in _&&"limit"in e&&(a.limit=_.limit)));var c=[o,a];n&&c.push(n);var u=function(t){var i=t;return null===t?i=new BetaJS.Iterators.ArrayIterator([]):BetaJS.Types.is_array(t)&&(i=new BetaJS.Iterators.ArrayIterator(t)),"query"in e||BetaJS.Types.is_empty(r)||(i=new BetaJS.Iterators.FilteredIterator(i,function(t){return BetaJS.Queries.evaluate(r,t)})),"sort"in _&&!("sort"in a)&&(i=new BetaJS.Iterators.SortedIterator(i,BetaJS.Comparators.byObject(_.sort))),"skip"in _&&!("skip"in a)&&(i=new BetaJS.Iterators.SkipIterator(i,_.skip)),"limit"in _&&!("limit"in a)&&(i=new BetaJS.Iterators.LimitIterator(i,_.limit)),n&&n.success&&n.success(i),i},h=function(t){if(!n||!n.exception)throw t;n.exception(t)};if(n)i.apply(s||this,[o,a,{success:u,exception:h,sync:n.sync,context:n.context||this}]);else try{var l=i.apply(s||this,[o,a]);return u(l)}catch(d){h(d)}return!0}},BetaJS.Collections.Collection.extend("BetaJS.Collections.QueryCollection",{constructor:function(t){this._inherited(BetaJS.Collections.QueryCollection,"constructor",t),this.__query=BetaJS.Objs.extend({func:null,select:{},skip:0,limit:null,forward_steps:null,backward_steps:null,range:null,count:null,sort:{}},t.query),"objects"in t||(t.objects=this.__execute_query(this.__query.skip,this.__query.limit,!0))},__execute_query:function(t,e,i){t=Math.max(t,0);var s={},n=null,r=null;this.__query.sort&&!BetaJS.Types.is_empty(this.__query.sort)&&(s.sort=this.__query.sort),i?(t>0&&(s.skip=t),null!==e&&(s.limit=e),r=this.__query.func(this.__query.select,s),n=r.asArray(),this.__query.skip=t,this.__query.limit=e,this.__query.count=!e||e>n.length?t+n.length:null,this.clear(),this.add_objects(n)):this.__query.skip>t?(e=this.__query.skip-t,t>0&&(s.skip=t),s.limit=e,r=this.__query.func(this.__query.select,s),n=r.asArray(),this.__query.skip=t,this.__query.limit=this.__query.limit?this.__query.limit+n.length:null,this.add_objects(n)):t>=this.__query.skip&&this.__query.limit&&(!e||t+e>this.__query.skip+this.__query.limit)&&(e=t+e-(this.__query.skip+this.__query.limit),t=this.__query.skip+this.__query.limit,t>0&&(s.skip=t),e&&(s.limit=e),r=this.__query.func(this.__query.select,s),n=r.asArray(),this.__query.limit=this.__query.limit+n.length,e>n.length&&(this.__query.count=t+n.length),this.add_objects(n))},increase_forwards:function(t){t=t?t:this.__query.forward_steps,t&&this.__query.limit&&this.__execute_query(this.__query.skip+this.__query.limit,t,!1)},increase_backwards:function(t){t=t?t:this.__query.backward_steps,t&&this.__query.skip>0&&(t=Math.min(t,this.__query.skip),this.__execute_query(this.__query.skip-t,t,!1))},paginate:function(t){this.__execute_query(this.__query.range*t,this.__query.range,!0)},paginate_index:function(){return this.__query.range?Math.floor(this.__query.skip/this.__query.range):null},paginate_count:function(){return this.__query.count&&this.__query.range?Math.ceil(this.__query.count/this.__query.range):null},next:function(){var t=this.paginate_index();if(t){var e=this.paginate_count();(!e||this.paginate_count()-1>t)&&this.paginate(t+1)}},prev:function(){var t=this.paginate_index();t&&t>0&&this.paginate(t-1)},isComplete:function(){return null!==this.__query.count}}),BetaJS.Class.extend("BetaJS.Queries.ActiveQueryEngine",{constructor:function(){this._inherited(BetaJS.Queries.ActiveQueryEngine,"constructor"),this.__aqs={},this.__object_to_aqs={}},__valid_for_aq:function(t,e){return BetaJS.Queries.evaluate(e.query(),t)},insert:function(t){if(!this.__object_to_aqs[BetaJS.Ids.objectId(t)]){var e=t.getAll(),i={};this.__object_to_aqs[BetaJS.Ids.objectId(t)]=i,BetaJS.Objs.iter(this.__aqs,function(s){this.__valid_for_aq(e,s)&&(s._add(t),i[s.cid()]=s)},this),t.on("change",function(){this.update(t)},this)}},remove:function(t){BetaJS.Objs.iter(this.__object_to_aqs[BetaJS.Ids.objectId(t)],function(e){e._remove(t)},this),delete this.__object_to_aqs[BetaJS.Ids.objectId(t)],t.off(null,this,null)},update:function(t){var e=t.getAll(),i=this.__object_to_aqs[BetaJS.Ids.objectId(t)];BetaJS.Objs.iter(this.__object_to_aqs[BetaJS.Ids.objectId(t)],function(s){this.__valid_for_aq(e,s)||(s._remove(t),delete i[s.cid()])},this),BetaJS.Objs.iter(this.__aqs,function(s){this.__valid_for_aq(e,s)&&(s._add(t),i[s.cid()]=s)},this)},register:function(t){this.__aqs[t.cid()]=t;var e=t.query();this._query(e,{context:this,success:function(e){for(;e.hasNext();){var i=e.next();this.__object_to_aqs[BetaJS.Ids.objectId(i)]?(this.__object_to_aqs[BetaJS.Ids.objectId(i)][t.cid()]=t,t._add(i)):this.insert(i)}}})},unregister:function(t){delete this.__aqs[t.cid()];var e=this;t.collection().iterate(function(i){delete e.__object_to_aqs[BetaJS.Ids.objectId(i)][t.cid()]})},_query:function(){}}),BetaJS.Class.extend("BetaJS.Queries.ActiveQuery",{constructor:function(t,e){this._inherited(BetaJS.Queries.ActiveQuery,"constructor"),this.__engine=t,this.__query=e||{},this.__collection=new BetaJS.Collections.Collection,this.__collection.on("destroy",function(){this.destroy()},this),t.register(this)},destroy:function(){this.__engine.unregister(this),this._inherited(BetaJS.Queries.ActiveQuery,"destroy")},isUniform:function(){return BetaJS.Types.is_empty(this.query())},engine:function(){return this.__engine},query:function(){return this.__query},collection:function(){return this.__collection},_add:function(t){this.__collection.add(t)},_remove:function(t){this.__collection.remove(t)},change_query:function(t){this.__engine.unregister(this),this.__query=t,this.__collection.clear(),this.__engine.register(this)}}),BetaJS.Exceptions.Exception.extend("BetaJS.Stores.StoreException"),BetaJS.Stores.BaseStore=BetaJS.Class.extend("BetaJS.Stores.BaseStore",[BetaJS.Events.EventsMixin,BetaJS.SyncAsync.SyncAsyncMixin,{constructor:function(t){this._inherited(BetaJS.Stores.BaseStore,"constructor"),t=t||{},this._id_key=t.id_key||"id",this._create_ids=t.create_ids||!1,this._last_id=1,this._supportsSync=!0,this._supportsAsync=!0},id_key:function(){return this._id_key},_insert:function(){},_remove:function(){},_get:function(){},_update:function(){},_query_capabilities:function(){return{}},_query:function(){},_new_id:function(){},insert:function(t,e){if(this._create_ids&&!(this._id_key in t&&t[this._id_key])){for(;this.get(this._last_id);)this._last_id++;t[this._id_key]=this._last_id}return this.then(this._insert,[t],e,function(t,e){this.trigger("insert",t),BetaJS.SyncAsync.callback(e,"success",t)})},insert_all:function(t,e){var i=BetaJS.Objs.map(t,function(t){return this.promise(this.insert,[t])},this);return this.join(i,e)},remove:function(t,e){return this.then(this._remove,[t],e,function(e,i){this.trigger("remove",t),i.success(t)})},get:function(t,e){return this.delegate(this._get,[t],e)},update:function(t,e,i){return this.then(this._update,[t,e],i,function(t,i){this.trigger("update",t,e),i.success.call(i.context||this,t,e)})},query:function(t,e,i){var s=function(i){return BetaJS.Queries.Constrained.emulate(BetaJS.Queries.Constrained.make(t,e||{}),this._query_capabilities(),this._query,this,i)};return this.either(i,s,s)},_query_applies_to_id:function(t,e){var i=this.get(e);return i&&BetaJS.Queries.overloaded_evaluate(t,i)},clear:function(t){return this.then(this.query,[{},{}],t,function(t,e){for(var i=[];t.hasNext();)i.push(this.remove,[t.next().id]);return this.join(i,e)})},_ensure_index:function(){},ensure_index:function(t){this._ensure_index(t)}}]),BetaJS.Class.extend("BetaJS.Stores.StoresMonitor",[BetaJS.Events.EventsMixin,{attach:function(t,e){e.on("insert",function(i){this.trigger("insert",t,e,i),this.trigger("write","insert",t,e,i)},this),e.on("remove",function(i){this.trigger("remove",t,e,i),this.trigger("write","remove",t,e,i)},this),e.on("update",function(i,s){this.trigger("update",t,e,i,s),this.trigger("write","update",t,e,i,s)},this)}}]),BetaJS.Stores.BaseStore.extend("BetaJS.Stores.AssocStore",{_read_key:function(){},_write_key:function(){},_remove_key:function(){},_iterate:function(){},constructor:function(t){t=t||{},t.create_ids=!0,this._inherited(BetaJS.Stores.AssocStore,"constructor",t),this._supportsAsync=!1},_insert:function(t){return this._write_key(t[this._id_key],t),t},_remove:function(t){var e=this._read_key(t);return e&&!this._remove_key(t)?null:e},_get:function(t){return this._read_key(t)},_update:function(t,e){var i=this._get(t);return i&&(delete e[this._id_key],BetaJS.Objs.extend(i,e),this._write_key(t,i)),i},_query:function(){return this._iterate()}}),BetaJS.Stores.AssocStore.extend("BetaJS.Stores.MemoryStore",{constructor:function(t){this._inherited(BetaJS.Stores.MemoryStore,"constructor",t),this.__data={}},_read_key:function(t){return this.__data[t]},_write_key:function(t,e){this.__data[t]=e},_remove_key:function(t){delete this.__data[t]},_iterate:function(){return new BetaJS.Iterators.ObjectValuesIterator(this.__data)}}),BetaJS.Stores.BaseStore.extend("BetaJS.Stores.DumbStore",{_read_last_id:function(){},_write_last_id:function(){},_remove_last_id:function(){},_read_first_id:function(){},_write_first_id:function(){},_remove_first_id:function(){},_read_item:function(){},_write_item:function(){},_remove_item:function(){},_read_next_id:function(){},_write_next_id:function(){},_remove_next_id:function(){},_read_prev_id:function(){},_write_prev_id:function(){},_remove_prev_id:function(){},constructor:function(t){t=t||{},t.create_ids=!0,this._inherited(BetaJS.Stores.DumbStore,"constructor",t),this._supportsAsync=!1},_insert:function(t){var e=this._read_last_id(),i=t[this._id_key];return null!==e?(this._write_next_id(e,i),this._write_prev_id(i,e)):this._write_first_id(i),this._write_last_id(i),this._write_item(i,t),t},_remove:function(t){var e=this._read_item(t);if(e){this._remove_item(t);var i=this._read_next_id(t),s=this._read_prev_id(t);null!==i?(this._remove_next_id(t),null!==s?(this._remove_prev_id(t),this._write_next_id(s,i),this._write_prev_id(i,s)):(this._remove_prev_id(i),this._write_first_id(i))):null!==s?(this._remove_next_id(s),this._write_last_id(s)):(this._remove_first_id(),this._remove_last_id())}return e},_get:function(t){return this._read_item(t)},_update:function(t,e){var i=this._get(t);return i&&(delete e[this._id_key],BetaJS.Objs.extend(i,e),this._write_item(t,i)),i},_query_capabilities:function(){return{query:!0}},_query:function(t){var e=new BetaJS.Iterators.Iterator,i=this,s=this._read_first_id();return BetaJS.Objs.extend(e,{__id:null===s?1:s,__store:i,__query:t,hasNext:function(){var e=this.__store._read_last_id();if(null===e)return!1;for(;e>this.__id&&!this.__store._read_item(this.__id);)this.__id++;for(;e>=this.__id;){if(this.__store._query_applies_to_id(t,this.__id))return!0;e>this.__id?this.__id=this.__store._read_next_id(this.__id):this.__id++}return!1},next:function(){if(this.hasNext()){var t=this.__store.get(this.__id);return this.__id==this.__store._read_last_id()?this.__id++:this.__id=this.__store._read_next_id(this.__id),t}return null}}),e}}),BetaJS.Stores.DumbStore.extend("BetaJS.Stores.AssocDumbStore",{_read_key:function(){},_write_key:function(){},_remove_key:function(){},__read_id:function(t){var e=this._read_key(t);return e?parseInt(e,10):null},_read_last_id:function(){return this.__read_id("last_id")},_write_last_id:function(t){this._write_key("last_id",t)},_remove_last_id:function(){this._remove_key("last_id")},_read_first_id:function(){return this.__read_id("first_id")},_write_first_id:function(t){this._write_key("first_id",t)},_remove_first_id:function(){this._remove_key("first_id")},_read_item:function(t){return this._read_key("item_"+t)},_write_item:function(t,e){this._write_key("item_"+t,e)},_remove_item:function(t){this._remove_key("item_"+t)},_read_next_id:function(t){return this.__read_id("next_"+t)},_write_next_id:function(t,e){this._write_key("next_"+t,e)},_remove_next_id:function(t){this._remove_key("next_"+t)},_read_prev_id:function(t){return this.__read_id("prev_"+t)},_write_prev_id:function(t,e){this._write_key("prev_"+t,e)},_remove_prev_id:function(t){this._remove_key("prev_"+t)}}),BetaJS.Stores.AssocDumbStore.extend("BetaJS.Stores.LocalStore",{constructor:function(t){this._inherited(BetaJS.Stores.LocalStore,"constructor",t),this.__prefix=t.prefix},__key:function(t){return this.__prefix+t},_read_key:function(t){var e=this.__key(t);return e in localStorage?JSON.parse(localStorage[e]):null},_write_key:function(t,e){localStorage[this.__key(t)]=JSON.stringify(e)},_remove_key:function(t){delete localStorage[this.__key(t)]}}),BetaJS.Stores.BaseStore.extend("BetaJS.Stores.DualStore",{constructor:function(t,e,i){i=BetaJS.Objs.extend({create_options:{},update_options:{},delete_options:{},get_options:{},query_options:{}},i||{}),i.id_key=t._id_key,this.__first=t,this.__second=e,this._inherited(BetaJS.Stores.DualStore,"constructor",i),this._supportsSync=t.supportsSync()&&e.supportsSync(),this._supportsAsync=t.supportsAsync()&&e.supportsAsync()||!this._supportsSync,this.__create_options=BetaJS.Objs.extend({start:"first",strategy:"then"},i.create_options),this.__update_options=BetaJS.Objs.extend({start:"first",strategy:"then"},i.update_options),this.__remove_options=BetaJS.Objs.extend({start:"first",strategy:"then"},i.delete_options),this.__get_options=BetaJS.Objs.extend({start:"first",strategy:"or",clone:!0,clone_second:!1,or_on_null:!0},i.get_options),this.__query_options=BetaJS.Objs.extend({start:"first",strategy:"or",clone:!0,clone_second:!1,or_on_null:!0},i.query_options)},first:function(){return this.__first},second:function(){return this.__second},_insert:function(t,e){var i=this.__first,s=this.__second;"first"!=this.__create_options.start&&(i=this.__second,s=this.__first);var n=this.__create_options.strategy;if(e)if("then"==n)i.insert(t,{success:function(t){s.insert(t,e)},exception:e.exception});else{if("or"==n)return i.insert(t,{success:e.success,exception:function(){s.insert(t,e)}});i.insert(t,e)}else{if("then"==n)return s.insert(i.insert(t));if("or"!=n)return i.insert(t);try{return i.insert(t)}catch(r){return s.insert(t)}}return!0},_update:function(t,e,i){var s=this.__first,n=this.__second;"first"!=this.__update_options.start&&(s=this.__second,n=this.__first);var r=this.__update_options.strategy;if(i)if("then"==r)s.update(t,e,{success:function(e){n.update(t,e,i)},exception:i.exception});else{if("or"==r)return s.update(t,e,{success:i.success,exception:function(){n.update(t,e,i)}});s.update(t,e,i)}else{if("then"==r)return n.update(t,s.update(t,e));if("or"!=r)return s.update(t,e);try{return s.update(t,e)}catch(_){return n.update(t,e)}}return!0},_remove:function(t,e){var i=this.__first,s=this.__second;"first"!=this.__remove_options.start&&(i=this.__second,s=this.__first);var n=this.__remove_options.strategy;if(e)"then"==n?i.remove(t,{success:function(){s.remove(t,e)},exception:e.exception}):"or"==n?i.remove(t,{success:e.success,exception:function(){s.remove(t,e)}}):i.remove(t,e);else if("then"==n)i.remove(t),s.remove(t);else if("or"==n)try{i.remove(t)}catch(r){s.remove(t)}else i.remove(t)},_query_capabilities:function(){return{query:!0,sort:!0,limit:!0,skip:!0}},_get:function(t,e){var i=this.__first,s=this.__second;"first"!=this.__get_options.start&&(i=this.__second,s=this.__first);var n=this.__get_options.strategy,r=this.__get_options.clone,_=this.__get_options.clone_second,o=this.__get_options.or_on_null;if("or"==n){var a=function(e){s.get(t,BetaJS.SyncAsync.mapSuccess(e,function(t){t&&r?i.delegate(i.insert,[t],e):this.callback(e,"success",t)}))};return i.then(i.get,[t],e,function(e,i){return!e&&o?(a(i),void 0):(_?s.get(t,{success:function(t){t?this.callback(i,"success",e):s.insert(e,i)},exception:function(){s.insert(e,i)}}):this.callback(i,"success",e),void 0)},function(t,e){a(e)})}return i.get(t,e)},_query:function(t,e,i){var s=this.__first,n=this.__second;"first"!=this.__query_options.start&&(s=this.__second,n=this.__first);var r=this.__query_options.strategy,_=this.__query_options.clone,o=this.__get_options.clone_second,a=this.__query_options.or_on_null,c=null;if("or"==r){var u=function(i){return n.query(t,e,BetaJS.SyncAsync.mapSuccess(i,function(n){if(n&&_){arr=n.asArray(),n=new BetaJS.Iterators.ArrayIterator(arr);var r=BetaJS.SyncAsync.mapSuccess(i,function(){BetaJS.SyncAsync.callback(i,"success",n)});"cache_query"in s?s.cache_query(t,e,arr,r):s.insert_all(arr,r)}else i.success(n)})),c},h=function(i,s){arr=i.asArray(),i=new BetaJS.Iterators.ArrayIterator(arr);var r=BetaJS.SyncAsync.mapSuccess(s,function(){BetaJS.SyncAsync.callback(s,"success",i)});"cache_query"in n?n.cache_query(t,e,arr,r):n.insert_all(arr,r)};return s.then(s.query,[t,e],i,function(i,s){return!i&&a?(u(s),void 0):(o?n.query(t,e,{success:function(t){t?this.callback(s,"success",i):h(i,s)},exception:function(){h(i,s)}}):this.callback(s,"success",i),void 0)},function(t,e){u(e)})}return s.query(t,e,i)}}),BetaJS.Stores.StoreException.extend("BetaJS.Stores.StoreCacheException"),BetaJS.Stores.DualStore.extend("BetaJS.Stores.FullyCachedStore",{constructor:function(t,e){e=e||{},this._inherited(BetaJS.Stores.FullyCachedStore,"constructor",t,new BetaJS.Stores.FullyCachedStore.InnerStore({id_key:t.id_key()}),BetaJS.Objs.extend({get_options:{start:"second",strategy:"single"},query_options:{start:"second",strategy:"single"}},e))},cache:function(){return this.second()},store:function(){return this.first()}}),BetaJS.Stores.MemoryStore.extend("BetaJS.Stores.FullyCachedStore.InnerStore",{insert:function(t,e){return this.trigger("cache",t),this._inherited(BetaJS.Stores.FullyCachedStore.InnerStore,"insert",t,e)}}),BetaJS.Stores.DualStore.extend("BetaJS.Stores.QueryCachedStore",{constructor:function(t,e){e=e||{},this._inherited(BetaJS.Stores.QueryCachedStore,"constructor",t,new BetaJS.Stores.QueryCachedStore.InnerStore({id_key:t.id_key()}),BetaJS.Objs.extend({get_options:{start:"second",strategy:"or"},query_options:{start:"second",strategy:"or",clone:!0,or_on_null:!0}},e))},cache:function(){return this.second()},store:function(){return this.first()}}),BetaJS.Stores.MemoryStore.extend("BetaJS.Stores.QueryCachedStore.InnerStore",{constructor:function(t){this._inherited(BetaJS.Stores.QueryCachedStore.InnerStore,"constructor",t),this.__queries={}},_query_capabilities:function(){return{query:!0,sort:!0,limit:!0,skip:!0}},_query:function(t,e){var i=BetaJS.Queries.Constrained.make(t,e),s=BetaJS.Queries.Constrained.format(i);if(s in this.__queries)return new BetaJS.Iterators.ArrayIterator(BetaJS.Objs.values(this.__queries[s]));throw new BetaJS.Stores.StoreCacheException},cache_query:function(t,e,i,s){var n=BetaJS.Queries.Constrained.make(t,e),r=BetaJS.Queries.Constrained.format(n);this.__queries[r]={};for(var _=0;i.length>_;++_){var o=i[_];this.insert(o),this.__queries[r][o[this.id_key()]]=o}this.callback(s,"success",i)},insert:function(t,e){return this.trigger("cache",t),this._inherited(BetaJS.Stores.QueryCachedStore.InnerStore,"insert",t,e)}}),BetaJS.Stores.BaseStore.extend("BetaJS.Stores.ConversionStore",{constructor:function(t,e){e=e||{},e.id_key=t._id_key,this._inherited(BetaJS.Stores.ConversionStore,"constructor",e),this.__store=t,this.__key_encoding=e.key_encoding||{},this.__key_decoding=e.key_decoding||{},this.__value_encoding=e.value_encoding||{},this.__value_decoding=e.value_decoding||{}},encode_object:function(t){var e={};for(var i in t)e[this.encode_key(i)]=this.encode_value(i,t[i]);return e},decode_object:function(t){var e={};for(var i in t)e[this.decode_key(i)]=this.decode_value(i,t[i]);return e},encode_key:function(t){return t in this.__key_encoding?this.__key_encoding[t]:t},decode_key:function(t){return t in this.__key_decoding?this.__key_decoding[t]:t},encode_value:function(t,e){return t in this.__value_encoding?this.__value_encoding[t](e):e},decode_value:function(t,e){return t in this.__value_decoding?this.__value_decoding[t](e):e},_query_capabilities:function(){return this.__store._query_capabilities()},_ensure_index:function(t){return this.__store.ensure_index(t)},_insert:function(t,e){return this.then(this.__store,this.__store.insert,[this.encode_object(t)],e,function(t,e){e.success(this.decode_object(t))})},_remove:function(t,e){return this.delegate(this.__store,this.__store.remove,[this.encode_value(this._id_key,t)],e)},_get:function(t,e){return this.then(this.__store,this.__store.get,[this.encode_value(this._id_key,t)],e,function(t,e){e.success(this.decode_object(t))})},_update:function(t,e,i){return this.then(this.__store,this.__store.update,[this.encode_value(this._id_key,t),this.encode_object(e)],i,function(t,e){e.success(this.decode_object(t))})},_query:function(t,e,i){return this.then(this.__store,this.__store.query,[this.encode_object(t),e],i,function(t,e){var i=new BetaJS.Iterators.MappedIterator(t,function(t){return this.decode_object(t)},this);e.success(i)})}}),BetaJS.Stores.BaseStore.extend("BetaJS.Stores.PassthroughStore",{constructor:function(t,e){this.__store=t,e=e||{},e.id_key=t.id_key(),this._inherited(BetaJS.Stores.PassthroughStore,"constructor",e),this._supportsAsync=t.supportsAsync(),this._supportsSync=t.supportsSync()},_query_capabilities:function(){return this.__store._query_capabilities()},_insert:function(t,e){return this.__store.insert(t,e)},_remove:function(t,e){return this.__store.remove(t,e)},_get:function(t,e){return this.__store.get(t,e)},_update:function(t,e,i){return this.__store.update(t,e,i)},_query:function(t,e,i){return this.__store.query(t,e,i)},_ensure_index:function(t){return this.__store.ensure_index(t)}}),BetaJS.Stores.PassthroughStore.extend("BetaJS.Stores.WriteQueueStore",{constructor:function(t,e){this._inherited(BetaJS.Stores.WriteQueueStore,"constructor",t,e),e=e||{},this.__update_queue={},this.__revision_id=1,this.__id_to_queue={},this.__combine_updates="combine_updates"in e?e.combine_updates:!0,this.__auto_clear_updates="auto_clear_updates"in e?e.auto_clear_updates:!0,this.__flushing=!1,this.__cache={},this.__auto_clear_updates&&this.on("remove",function(t){this.__remove_update(t)},this)},update:function(t,e,i){return this.__insert_update(t,e),i&&i.success&&i.success(t,e,e),e},__remove_update:function(t){var e=this.__id_to_queue[t];delete this.__id_to_queue[t];for(var i in e)delete this.__update_queue[i];delete this.__cache[t]},__remove_revision:function(t){var e=this.__update_queue[t];delete this.__update_queue[t];var i=this.__id_to_queue[e.id];delete i[t],BetaJS.Types.is_empty(i)&&(delete this.__id_to_queue[e.id],delete this.__cache[e.id])},__insert_update:function(t,e){if(this.__combine_updates&&this.__id_to_queue[t]&&!this.__flushing){var i={};for(var s in this.__id_to_queue[t])i=BetaJS.Objs.extend(i,this.__update_queue[s].data),delete this.__update_queue[s];i=BetaJS.Objs.extend(i,e),this.__id_to_queue[t]={}}this.__id_to_queue[t]=this.__id_to_queue[t]||{},this.__id_to_queue[t][this.__revision_id]=!0,this.__update_queue[this.__revision_id]={id:t,data:e,revision_id:this.__revision_id},this.__cache[t]=BetaJS.Objs.extend(this.__cache[t]||{},e),this.__revision_id++,this.trigger("queue","update",t,e),this.trigger("queue:update",t,e)},flush:function(t){if(!this.__flushing){this.__flushing=!0;var e=this.__revision_id;if(t){var i=function(){var s=BetaJS.Objs.peek(this.__update_queue);return!s||s.revision_id>=e?(BetaJS.SyncAsync.callback(t,"success"),this.__flushing=!1,void 0):(this.__store.update(s.id,s.data,{context:this,success:function(){this.__remove_revision(s.revision_id),i.apply(this)},exception:function(e){BetaJS.SyncAsync.callback(t,"exception",e),this.__flushing=!1}}),void 0)};i.apply(this)}else{for(var s=null;;){var n=BetaJS.Objs.peek(this.__update_queue);if(!n||n.revision_id>=e)break;try{this.__store.update(n.id,n.data),this.__remove_revision(n.revision_id)}catch(r){s=r;break}}if(this.__flushing=!1,s)throw s}}},changed:function(){return!BetaJS.Types.is_empty(this.__update_queue)},get:function(t){var e=this.__store.get(t);return e&&this.__cache[t]?BetaJS.Objs.extend(e,this.__cache[t]):e},query:function(t,e){var i=this;return new BetaJS.Iterators.MappedIterator(this.__store.query(t,e),function(t){return i.__cache[t[i.id_key()]]?BetaJS.Objs.extend(t,i.__cache[t[i.id_key()]]):t})}}),BetaJS.Class.extend("BetaJS.Stores.WriteQueueStoreManager",[BetaJS.Events.EventsMixin,{constructor:function(t){this._inherited(BetaJS.Stores.WriteQueueStoreManager,"constructor"),t=t||{},this.__stores={},this.__changed=!1,this.__flushing=!1,this.__async="async"in t?t.async:!1,this.__min_delay=t.min_delay?t.min_delay:null,this.__max_delay=t.max_delay?t.max_delay:null,(this.__min_delay||this.__max_delay)&&this.on("changed",function(){this.__async?this.flush({success:function(){},exception:function(){}}):this.flush()},this,{min_delay:this.__min_delay,max_delay:this.__max_delay})},destroy:function(){this.off(null,null,this),BetaJS.Objs.iter(this.__stores,function(t){this.unregister(t)},this),this._inherited(BetaJS.Stores.WriteQueueStoreManager,"destroy")},__get:function(t){return t},register:function(t){t=this.__get(t),this.__stores[BetaJS.Ids.objectId(t)]=t,t.on("queue:update",function(){this.__changed=!0,this.trigger("changed")},this)},unregister:function(t){t=this.__get(t),delete this.__stores[BetaJS.Ids.objectId(t)],t.off(null,null,this)},flush:function(t){if(!this.__flushing)if(this.__flushing=!0,this.trigger("flush_start"),this.trigger("flush"),t){var e=[];BetaJS.Objs.iter(this.__stores,function(t){e.push(BetaJS.SyncAsync.promise(t,t.flush))}),BetaJS.SyncAsync.join(e,{context:this,success:function(){this.trigger("flush_end"),this.__flushing=!1,BetaJS.SyncAsync.callback(t,"success"),this.__changed=!1,BetaJS.Objs.iter(this.__stores,function(t){this.__changed=this.__changed||t.changed()},this)},exception:function(e){this.trigger("flush_error"),this.__flushing=!1,BetaJS.SyncAsync.callback(t,"exception",e),this.__changed=!1,BetaJS.Objs.iter(this.__stores,function(t){this.__changed=this.__changed||t.changed()},this)}})}else{var i=null;if(BetaJS.Objs.iter(this.__stores,function(t){try{t.flush()}catch(e){return i=e,!1}return!0},this),this.__flushing=!1,i)throw this.trigger("flush_error"),i;this.trigger("flush_end"),this.__changed=!1,BetaJS.Objs.iter(this.__stores,function(t){this.__changed=this.__changed||t.changed()},this)}}}]);