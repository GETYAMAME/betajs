/*! betajs - v0.0.1 - 2013-08-03, Copyright (c) Oliver Friedmann & Victor Lingenthal, MIT Software License. */BetaJS.Net={},BetaJS.Net.AbstractAjax=BetaJS.Class.extend("AbstractAjax",{constructor:function(a){this._inherited(BetaJS.Net.AbstractAjax,"constructor"),this.__options=BetaJS.Objs.extend({method:"GET",data:{}},a)},syncCall:function(a){var b=BetaJS.Objs.clone(this.__options,1);b=BetaJS.Objs.extend(b,a);var c=b.success_callback;delete b.success_callback;var d=b.failure_callback;delete b.failure_callback;var e=b.complete_callback;delete b.complete_callback;try{var f=this._syncCall(b);return c&&c(f),e&&e(),f}catch(g){if(g=BetaJS.Exceptions.ensure(g),g.assert(BetaJS.Net.AjaxException),!d)throw g;d(g.status_code(),g.status_text(),g.data())}},asyncCall:function(a){var b=BetaJS.Objs.clone(this.__options,1);b=BetaJS.Objs.extend(b,a);var c=b.success_callback;delete b.success_callback;var d=b.failure_callback;delete b.failure_callback;var e=b.complete_callback;delete b.complete_callback;try{var f=this._asyncCall(BetaJS.Objs.extend({success:function(a){c&&c(a),e&&e()},failure:function(a,b,c){if(!d)throw new BetaJS.Net.AjaxException(a,b,c);d(a,b,c),e&&e()}},b));return f}catch(g){if(g=BetaJS.Exceptions.ensure(g),g.assert(BetaJS.Net.AjaxException),!d)throw g;d(g.status_code(),g.status_text(),g.data())}},call:function(a){if(!("async"in a))return!1;var b=a.async;return delete a.async,b?this.asyncCall(a):this.syncCall(a)},_syncCall:function(){},_asyncCall:function(){}}),BetaJS.Net.AjaxException=BetaJS.Exceptions.Exception.extend("AjaxException",{constructor:function(a,b,c){this._inherited(BetaJS.Net.AjaxException,"constructor",a+": "+b),this.__status_code=a,this.__status_text=b,this.__data=c},status_code:function(){return this.__status_code},status_text:function(){return this.__status_text},data:function(){return this.__data}}),BetaJS.Net.JQueryAjax=BetaJS.Net.AbstractAjax.extend("JQueryAjax",{_syncCall:function(a){var b;return BetaJS.$.ajax({type:a.method,async:!1,url:a.uri,data:JSON.stringify(a.data),success:function(a){b=a},error:function(a,b,c){throw new BetaJS.Net.AjaxException(c,b,a)}}),b},_asyncCall:function(a){BetaJS.$.ajax({type:a.method,async:!0,url:a.uri,data:JSON.stringify(a.data),success:function(b){a.success(b)},error:function(b,c,d){a.failure(d,c,b)}})}}),BetaJS.Queries={__dependencies:function(a,b){if(BetaJS.Types.is_array(a)){if(0==a.length)throw"Malformed Query";var c=a[0];if("Or"==c||"And"==c){for(var d=1;d<a.length;++d)b=this.__dependencies(a[d],b);return b}if(3!=a.length)throw"Malformed Query";var e=a[1];return e in b?b[e]++:b[e]=1,b}if(BetaJS.Types.is_object(a)){for(e in a)e in b?b[e]++:b[e]=1;return b}throw"Malformed Query"},dependencies:function(a){return this.__dependencies(a,{})},format:function(a){return BetaJS.Class.is_class_instance(a)?a.format():JSON.stringify(a)},overloaded_evaluate:function(a,b){return BetaJS.Class.is_class_instance(a)?a.evaluate(b):BetaJS.Types.is_function(a)?a(b):this.evaluate(a,b)},evaluate:function(a,b){if(null==b)return!1;if(BetaJS.Types.is_array(a)){if(0==a.length)throw"Malformed Query";var c=a[0];if("Or"==c){for(var d=1;d<a.length;++d)if(this.evaluate(a[d],b))return!0;return!1}if("And"==c){for(var d=1;d<a.length;++d)if(!this.evaluate(a[d],b))return!1;return!0}if(3!=a.length)throw"Malformed Query";var e=a[1],f=b[e],g=a[2];if("=="==c)return f==g;if("!="==c)return f!=g;if(">"==c)return f>g;if(">="==c)return f>=g;if("<"==c)return g>f;if("<="==c)return g>=f;throw"Malformed Query"}if(BetaJS.Types.is_object(a)){for(e in a)if(a[e]!=b[e])return!1;return!0}throw"Malformed Query"},__compile:function(a){if(BetaJS.Types.is_array(a)){if(0==a.length)throw"Malformed Query";var b=a[0];if("Or"==b){for(var c="false",d=1;d<a.length;++d)c+=" || ("+this.__compile(a[d])+")";return c}if("And"==b){for(var c="true",d=1;d<a.length;++d)c+=" && ("+this.__compile(a[d])+")";return c}if(3!=a.length)throw"Malformed Query";var e=a[1],f=a[2],g="object['"+e+"']",h=BetaJS.Types.is_string(f)?"'"+f+"'":f;return g+" "+b+" "+h}if(BetaJS.Types.is_object(a)){var c="true";for(e in a)c+=" && (object['"+e+"'] == "+(BetaJS.Types.is_string(a[e])?"'"+a[e]+"'":a[e])+")";return c}throw"Malformed Query"},compile:function(a){var b=this.__compile(a),c=new Function("object",b),d=function(a){return c.call(this,a)};return d.source="function(object){\n return "+b+"; }",d},emulate:function(a,b,c){var d=b.apply(c||this,{}),e=d;return null==d?e=BetaJS.Iterators.ArrayIterator([]):BetaJS.Types.is_array(d)&&(e=BetaJS.Iterators.ArrayIterator(d)),new BetaJS.Iterators.FilteredIterator(e,function(b){return BetaJS.Queries.evaluate(a,b)})}},BetaJS.Queries.CompiledQuery=BetaJS.Class.extend("CompiledQuery",{constructor:function(a){this.__query=a,this.__dependencies=BetaJS.Query.dependencies(a),this.__compiled=BetaJS.Query.compile(a)},query:function(){return this.__query},dependencies:function(){return this.__dependencies},compiled:function(){return this.__compiled},evaluate:function(a){return this.__compiled(a)},format:function(){return BetaJS.Query.format(this.__query)}}),BetaJS.Queries.Constrained={make:function(a,b){return{query:a,options:b||{}}},format:function(a){var b=a.query;a.query=BetaJS.Queries.format(b);var c=JSON.stringify(a);return a.query=b,c},emulate:function(a,b,c,d){var e=a.query,f=a.options,g={},h={};"sort"in f&&"sort"in b&&(h.sort=f.sort),g=e,("query"in b||BetaJS.Types.is_empty(e))&&(g=e,(!("sort"in f)||"sort"in b)&&("skip"in f&&"skip"in b&&(h.skip=f.skip),"limit"in f&&"limit"in b&&(h.limit=f.limit)));var i=c.apply(d||this,[g,h]),j=i;return null==i?j=new BetaJS.Iterators.ArrayIterator([]):BetaJS.Types.is_array(i)&&(j=new BetaJS.Iterators.ArrayIterator(i)),"query"in b||BetaJS.Types.is_empty(e)||(j=new BetaJS.Iterators.FilteredIterator(j,function(a){return BetaJS.Queries.evaluate(e,a)})),"sort"in f&&!("sort"in h)&&(j=new BetaJS.Iterators.SortedIterator(j,BetaJS.Comparators.byObject(f.sort))),"skip"in f&&!("skip"in h)&&(j=new BetaJS.Iterators.SkipIterator(j,f.skip)),"limit"in f&&!("limit"in h)&&(j=new BetaJS.Iterators.LimitIterator(j,f.limit)),j}},BetaJS.Collections.QueryCollection=BetaJS.Collections.Collection.extend("QueryCollection",{constructor:function(a){this._inherited(BetaJS.Collections.QueryCollection,"constructor",a),this.__query=BetaJS.Objs.extend({func:null,select:{},skip:0,limit:null,forward_steps:null,backward_steps:null,range:null,count:null,sort:{}},a.query),"objects"in a||(a.objects=this.__execute_query(this.__query.skip,this.__query.limit,!0))},__execute_query:function(a,b,c){a=Math.max(a,0);var d={};if(null==this.__query.sort||BetaJS.Types.is_empty(this.__query.sort)||(d.sort=this.__query.sort),c){a>0&&(d.skip=a),null!=b&&(d.limit=b);var e=this.__query.func(this.__query.select,d),f=e.asArray();this.__query.skip=a,this.__query.limit=b,this.__query.count=null==b||f.length<b?a+f.length:null,this.clear(),this.add_objects(f)}else if(a<this.__query.skip){b=this.__query.skip-a,a>0&&(d.skip=a),d.limit=b;var e=this.__query.func(this.__query.select,d),f=e.asArray();this.__query.skip=a,this.__query.limit=null==this.__query.limit?null:this.__query.limit+f.length,this.add_objects(f)}else if(a>=this.__query.skip&&null!=this.__query.limit&&(null==b||a+b>this.__query.skip+this.__query.limit)){b=a+b-(this.__query.skip+this.__query.limit),a=this.__query.skip+this.__query.limit,a>0&&(d.skip=a),null!=b&&(d.limit=b);var e=this.__query.func(this.__query.select,d),f=e.asArray();this.__query.limit=this.__query.limit+f.length,b>f.length&&(this.__query.count=a+f.length),this.add_objects(f)}},increase_forwards:function(a){a=null==a?this.__query.forward_steps:a,null!=a&&null!=this.__query.limit&&this.__execute_query(this.__query.skip+this.__query.limit,a,!1)},increase_backwards:function(a){if(a=null==a?this.__query.backward_steps:a,null!=a&&this.__query.skip>0){var a=Math.min(a,this.__query.skip);this.__execute_query(this.__query.skip-a,a,!1)}},paginate:function(a){this.__execute_query(this.__query.range*a,this.__query.range,!0)},paginate_index:function(){return null==this.__query.range?null:Math.floor(this.__query.skip/this.__query.range)},paginate_count:function(){return null==this.__query.count||null==this.__query.range?null:Math.ceil(this.__query.count/this.__query.range)},next:function(){var a=this.paginate_index();if(null!=a){var b=this.paginate_count();(null==b||a<this.paginate_count()-1)&&this.paginate(a+1)}},prev:function(){var a=this.paginate_index();null!=a&&a>0&&this.paginate(a-1)},isComplete:function(){return null!=this.__query.count}}),BetaJS.Queries.ActiveQueryEngine=BetaJS.Class.extend("ActiveQueryEngine",{constructor:function(){this._inherited(BetaJS.Queries.ActiveQueryEngine,"constructor"),this.__aqs={},this.__object_to_aqs={},this.__match_to_aqs={},this.__uniform_aqs={}},__valid_for_aq:function(a,b){return BetaJS.Queries.evaluate(b.query(),a)},insert:function(a){if(!this.__object_to_aqs[BetaJS.Ids.objectId(a)]){var b=a.getAll(),c={};this.__object_to_aqs[BetaJS.Ids.objectId(a)]=c,BetaJS.Objs.iter(this.__uniform_aqs,function(b){b._add(a),c[BetaJS.Ids.objectId(b)]=b},this);for(var d in b){var e=d+":"+JSON.stringify(b[d]);this.__match_to_aqs[e]&&BetaJS.Objs.iter(this.__match_to_aqs[e],function(d){this.__valid_for_aq(b,d)&&(d._add(a),c[BetaJS.Ids.objectId(d)]=d)},this)}a.on("change",function(){this.update(a)},this)}},remove:function(a){BetaJS.Objs.iter(this.__object_to_aqs[BetaJS.Ids.objectId(a)],function(b){b._remove(a)},this),delete this.__object_to_aqs[BetaJS.Ids.objectId(a)],a.off(null,this,null)},update:function(a){var b=a.getAll(),c=this.__object_to_aqs[BetaJS.Ids.objectId(a)];BetaJS.Objs.iter(this.__object_to_aqs[BetaJS.Ids.objectId(a)],function(d){this.__valid_for_aq(b,d)||(d._remove(a),delete c[BetaJS.Ids.objectId(d)])},this);for(var d in b){var e=d+":"+JSON.stringify(b[d]);this.__match_to_aqs[e]&&BetaJS.Objs.iter(this.__match_to_aqs[e],function(d){BetaJS.Ids.objectId(d)in c||!this.__valid_for_aq(b,d)||(d._add(a),c[BetaJS.Ids.objectId(d)]=d)},this)}},register:function(a){a.isUniform()?this.__uniform_aqs[BetaJS.Ids.objectId(a)]=a:this.__aqs[BetaJS.Ids.objectId(a)]=a;var b=a.query();for(var c in b){var d=c+":"+JSON.stringify(b[c]);this.__match_to_aqs[d]=this.__match_to_aqs[d]||{},this.__match_to_aqs[d][BetaJS.Ids.objectId(a)]=a}for(var e=this._query(b);e.hasNext();){var f=e.next();this.__object_to_aqs[BetaJS.Ids.objectId(f)]?(this.__object_to_aqs[BetaJS.Ids.objectId(f)][BetaJS.Ids.objectId(a)]=a,a._add(f)):this.insert(f)}},unregister:function(a){a.isUniform()?delete this.__uniform_aqs[BetaJS.Ids.objectId(a)]:delete this.__aqs[BetaJS.Ids.objectId(a)];var b=this;a.collection().iterate(function(c){delete b.__object_to_aqs[BetaJS.Ids.objectId(c)][BetaJS.Ids.objectId(a)]});var c=a.query();for(var d in c){var e=d+":"+JSON.stringify(c[d]);delete this.__match_to_aqs[e][BetaJS.Ids.objectId(a)],BetaJS.Types.is_empty(this.__match_to_aqs[e])&&delete this.__match_to_aqs[e]}},_query:function(){}}),BetaJS.Queries.ActiveQuery=BetaJS.Class.extend("ActiveQuery",{constructor:function(a,b){this._inherited(BetaJS.Queries.ActiveQuery,"constructor"),this.__engine=a,this.__query=b,this.__collection=new BetaJS.Collections.Collection,a.register(this)},destroy:function(){this.__engine.unregister(this),this._inherited(BetaJS.Queries.ActiveQuery,"destroy")},isUniform:function(){return BetaJS.Types.is_empty(this.query())},engine:function(){return this.__engine},query:function(){return this.__query},collection:function(){return this.__collection},_add:function(a){this.__collection.add(a)},_remove:function(a){this.__collection.remove(a)},change_query:function(a){this.__engine.unregister(this),this.__query=a,this.__collection.clear(),this.__engine.register(this)}}),BetaJS.Stores=BetaJS.Stores||{},BetaJS.Stores.StoreException=BetaJS.Exceptions.Exception.extend("StoreException"),BetaJS.Stores.BaseStore=BetaJS.Class.extend("BaseStore",[BetaJS.Events.EventsMixin,{constructor:function(a){this._inherited(BetaJS.Stores.BaseStore,"constructor"),a=a||{},this._id_key=a.id_key||"id",this._create_ids=a.create_ids||!1,this._last_id=1},_insert:function(){},_remove:function(){},_get:function(){},_update:function(){},_query_capabilities:function(){return{}},_query:function(){},insert:function(a){if(this._create_ids)if(this._id_key in a){if(this.get(a[this._id_key]))return null}else{for(;this.get(this._last_id);)this._last_id++;a[this._id_key]=this._last_id}var b=this._insert(a);return b&&this.trigger("insert",b),b},remove:function(a){var b=this._remove(a);return b&&this.trigger("remove",a),b},get:function(a){return this._get(a)},update:function(a,b){var c=this._update(a,b);return c&&this.trigger("update",c,b),c},query:function(a,b){return BetaJS.Queries.Constrained.emulate(BetaJS.Queries.Constrained.make(a||{},b||{}),this._query_capabilities(),this._query,this)},_query_applies_to_id:function(a,b){var c=this.get(b);return c&&BetaJS.Queries.overloaded_evaluate(a,c)},clear:function(){for(var a=this.query({});a.hasNext();)this.remove(a.next().id)}}]),BetaJS.Stores.AssocStore=BetaJS.Stores.BaseStore.extend("AssocStore",{_read_key:function(){},_write_key:function(){},_remove_key:function(){},_iterate:function(){},constructor:function(a){a=a||{},a.create_ids=!0,this._inherited(BetaJS.Stores.AssocStore,"constructor",a)},_insert:function(a){return this._write_key(a[this._id_key],a),a},_remove:function(a){var b=this._read_key(a);return b&&!this._remove_key(a)?null:b},_get:function(a){return this._read_key(a)},_update:function(a,b){var c=this._get(a);return c&&(delete b[this._id_key],BetaJS.Objs.extend(c,b),this._write_key(a,c)),c},_query:function(){return this._iterate()}}),BetaJS.Stores.MemoryStore=BetaJS.Stores.AssocStore.extend("MemoryStore",{constructor:function(a){this._inherited(BetaJS.Stores.MemoryStore,"constructor",a),this.__data={}},_read_key:function(a){return this.__data[a]},_write_key:function(a,b){this.__data[a]=b},_remove_key:function(a){delete this.__data[a]},_iterate:function(){return new BetaJS.Iterators.ObjectValuesIterator(this.__data)}}),BetaJS.Stores.DumbStore=BetaJS.Stores.BaseStore.extend("DumbStore",{_read_last_id:function(){},_write_last_id:function(){},_remove_last_id:function(){},_read_first_id:function(){},_write_first_id:function(){},_remove_first_id:function(){},_read_item:function(){},_write_item:function(){},_remove_item:function(){},_read_next_id:function(){},_write_next_id:function(){},_remove_next_id:function(){},_read_prev_id:function(){},_write_prev_id:function(){},_remove_prev_id:function(){},constructor:function(a){a=a||{},a.create_ids=!0,this._inherited(BetaJS.Stores.DumbStore,"constructor",a)},_insert:function(a){var b=this._read_last_id(),c=a[this._id_key];return null!=b?(this._write_next_id(b,c),this._write_prev_id(c,b)):this._write_first_id(c),this._write_last_id(c),this._write_item(c,a),a},_remove:function(a){var b=this._read_item(a);if(b){this._remove_item(a);var c=this._read_next_id(a),d=this._read_prev_id(a);null!=c?(this._remove_next_id(a),null!=d?(this._remove_prev_id(a),this._write_next_id(d,c),this._write_prev_id(c,d)):(this._remove_prev_id(c),this._write_first_id(c))):null!=d?(this._remove_next_id(d),this._write_last_id(d)):(this._remove_first_id(),this._remove_last_id())}return b},_get:function(a){return this._read_item(a)},_update:function(a,b){var c=this._get(a);return c&&(delete b[this._id_key],BetaJS.Objs.extend(c,b),this._write_item(a,c)),c},_query_capabilities:function(){return{query:!0}},_query:function(a){var b=new BetaJS.Iterators.Iterator,c=this,d=this._read_first_id();return BetaJS.Objs.extend(b,{__id:null==d?1:d,__store:c,__query:a,hasNext:function(){var b=this.__store._read_last_id();if(null==b)return!1;for(;this.__id<b&&!this.__store._read_item(this.__id);)this.__id++;for(;this.__id<=b;){if(this.__store._query_applies_to_id(a,this.__id))return!0;this.__id<b?this.__id=this.__store._read_next_id(this.__id):this.__id++}return!1},next:function(){if(this.hasNext()){var a=this.__store.get(this.__id);return this.__id==this.__store._read_last_id()?this.__id++:this.__id=this.__store._read_next_id(this.__id),a}return null}}),b}}),BetaJS.Stores.AssocDumbStore=BetaJS.Stores.DumbStore.extend("AssocDumbStore",{_read_key:function(){},_write_key:function(){},_remove_key:function(){},__read_id:function(a){var b=this._read_key(a);return b?parseInt(b):null},_read_last_id:function(){return this.__read_id("last_id")},_write_last_id:function(a){this._write_key("last_id",a)},_remove_last_id:function(){this._remove_key("last_id")},_read_first_id:function(){return this.__read_id("first_id")},_write_first_id:function(a){this._write_key("first_id",a)},_remove_first_id:function(){this._remove_key("first_id")},_read_item:function(a){return this._read_key("item_"+a)},_write_item:function(a,b){this._write_key("item_"+a,b)},_remove_item:function(a){this._remove_key("item_"+a)},_read_next_id:function(a){return this.__read_id("next_"+a)},_write_next_id:function(a,b){this._write_key("next_"+a,b)},_remove_next_id:function(a){this._remove_key("next_"+a)},_read_prev_id:function(a){return this.__read_id("prev_"+a)},_write_prev_id:function(a,b){this._write_key("prev_"+a,b)},_remove_prev_id:function(a){this._remove_key("prev_"+a)}}),BetaJS.Stores.LocalStore=BetaJS.Stores.AssocDumbStore.extend("LocalStore",{constructor:function(a){this._inherited(BetaJS.Stores.LocalStore,"constructor",a),this.__prefix=a.prefix},__key:function(a){return this.__prefix+a},_read_key:function(a){var b=this.__key(a);return b in localStorage?JSON.parse(localStorage[b]):null},_write_key:function(a,b){localStorage[this.__key(a)]=JSON.stringify(b)},_remove_key:function(a){delete localStorage[this.__key(a)]}}),BetaJS.Stores.QueryCachedStore=BetaJS.Stores.BaseStore.extend("QueryCachedStore",{constructor:function(a,b){b=b||{},b.id_key=a._id_key,this._inherited(BetaJS.Stores.QueryCachedStore,"constructor",b),this.__parent=a,this.__cache={},this.__queries={}},invalidate:function(){this.__cache={},this.__queries={}},_insert:function(a){var b=this.__parent.insert(a);return b&&(this.__cache[a[this._id_key]]=a),b},_remove:function(a){var b=this.__parent.remove(a);return b&&delete this.__cache[a],b},_update:function(a,b){var c=this.__parent.update(a,b);return c&&(this.__cache[a]=BetaJS.Objs.extend(this.__cache[a],b)),c},_get:function(a){return a in this.__cache||(this.__cache[a]=this.__parent.get(a)),this.__cache[a]},_query_capabilities:function(){return this.__parent._query_capabilities()},_query:function(a,b){var c=BetaJS.Queries.Constrained.make(a,b),d=BetaJS.Queries.Constrained.format(c);if(d in this.__queries)return new BetaJS.Iterators.ArrayIterator(BetaJS.Objs.values(this.__queries[d]));var e=this.__parent.query(a,b).asArray();this.__queries[d]={};for(var f=0;f<e.length;++f)this.__cache_row(e[f],d);return new BetaJS.Iterators.ArrayIterator(e)},cache:function(a,b,c){var d=BetaJS.Queries.Constrained.make(a,b),e=BetaJS.Queries.Constrained.format(d);this.__queries[e]={};for(var f=0;f<c.length;++f)this.__cache_row(c[f],e)},__cache_row:function(a,b){this.trigger("cache",a),this.__cache[a[this._id_key]]=a,this.__queries[b][a[this._id_key]]=a}}),BetaJS.Stores.FullyCachedStore=BetaJS.Stores.BaseStore.extend("FullyCachedStore",{constructor:function(a,b,c){c=c||{},c.id_key=a._id_key,this._inherited(BetaJS.Stores.FullyCachedStore,"constructor",c),this.__parent=a,this.__cache={},this.__cached=!1,b&&this.invalidate(b)},invalidate:function(a){for(this.__cache={},a||(a=this.__parent.query({})),BetaJS.Types.is_array(a)&&(a=new BetaJS.Iterators.ArrayIterator(a));a.hasNext();){var b=a.next();this.cache(b)}this.__cached=!0},cache:function(a){this.trigger("cache",a),this.__cache[a[this._id_key]]=a},_insert:function(a){this.__cached||this.invalidate({});var b=this.__parent.insert(a);return b&&(this.__cache[a[this._id_key]]=a),b},_remove:function(a){this.__cached||this.invalidate({});var b=this.__parent.remove(a);return b&&delete this.__cache[a],b},_get:function(a){return this.__cached||this.invalidate({}),this.__cache[a]},_update:function(a,b){this.__cached||this.invalidate({});var c=this.__parent.update(a,b);return c&&(this.__cache[a]=BetaJS.Objs.extend(this.__cache[a],b)),c},_query:function(){return this.__cached||this.invalidate(),new BetaJS.Iterators.ArrayIterator(BetaJS.Objs.values(this.__cache))}}),BetaJS.Stores.RemoteStore=BetaJS.Stores.BaseStore.extend("RemoteStore",{constructor:function(a,b,c){this._inherited(BetaJS.Stores.RemoteStore,"constructor",c),this._uri=a,this.__ajax=b,this.__options=BetaJS.Objs.extend({update_method:"PUT",uri_mappings:{}},c||{})},getUri:function(){return this._uri},prepare_uri:function(a,b){return this.__options.uri_mappings[a]?this.__options.uri_mappings[a](b):"remove"==a||"get"==a||"update"==a?this.getUri()+"/"+b[this._id_key]:this.getUri()},_insert:function(a){try{return this.__ajax.syncCall({method:"POST",uri:this.prepare_uri("insert",a),data:a})}catch(b){throw new BetaJS.Stores.StoreException(BetaJS.Net.AjaxException.ensure(b).toString())}},_remove:function(a){try{var b=this.__ajax.syncCall({method:"DELETE",uri:this.prepare_uri("remove",data)});return b?b:(b={},b[this._id_key]=a,b)}catch(c){throw new BetaJS.Stores.StoreException(BetaJS.Net.AjaxException.ensure(c).toString())}},_get:function(a){var b={};b[this._id_key]=a;try{return this.__ajax.syncCall({uri:this.prepare_uri("get",b)})}catch(c){throw new BetaJS.Stores.StoreException(BetaJS.Net.AjaxException.ensure(c).toString())}},_update:function(a,b){var c=BetaJS.Objs.clone(b,1);c[this._id_key]=a;try{return this.__ajax.syncCall({method:this.__options.update_method,uri:this.prepare_uri("update",c),data:b})}catch(d){throw new BetaJS.Stores.StoreException(BetaJS.Net.AjaxException.ensure(d).toString())}},_query:function(a,b){try{var c=this.__ajax.syncCall(this._encode_query(a,b));return BetaJS.Types.is_string(c)?JSON.parse(c):c}catch(d){throw new BetaJS.Stores.StoreException(BetaJS.Net.AjaxException.ensure(d).toString())}},_encode_query:function(){return{uri:this.prepare_uri("query")}}}),BetaJS.Stores.QueryGetParamsRemoteStore=BetaJS.Stores.RemoteStore.extend("QueryGetParamsRemoteStore",{constructor:function(a,b,c,d){this._inherited(BetaJS.Stores.QueryGetParamsRemoteStore,"constructor",a,b,d),this.__capability_params=c},_query_capabilities:function(){var a={};return"skip"in this.__capability_params&&(a.skip=!0),"limit"in this.__capability_params&&(a.limit=!0),a},_encode_query:function(a,b){b=b||{};var c=this.getUri()+"?";return b.skip&&"skip"in this.__capability_params&&(c+=this.__capability_params.skip+"="+b.skip+"&"),b.limit&&"limit"in this.__capability_params&&(c+=this.__capability_params.limit+"="+b.limit+"&"),{uri:c}}}),BetaJS.Stores.ConversionStore=BetaJS.Stores.BaseStore.extend("ConversionStore",{constructor:function(a,b){b=b||{},b.id_key=a._id_key,this._inherited(BetaJS.Stores.ConversionStore,"constructor",b),this.__store=a,this.__key_encoding=b.key_encoding||{},this.__key_decoding=b.key_decoding||{},this.__value_encoding=b.value_encoding||{},this.__value_decoding=b.value_decoding||{}},encode_object:function(a){var b={};for(var c in a)b[this.encode_key(c)]=this.encode_value(c,a[c]);return b},decode_object:function(a){var b={};for(var c in a)b[this.decode_key(c)]=this.decode_value(c,a[c]);return b},encode_key:function(a){return a in this.__key_encoding?this.__key_encoding[a]:a},decode_key:function(a){return a in this.__key_decoding?this.__key_decoding[a]:a},encode_value:function(a,b){return a in this.__value_encoding?this.__value_encoding[a](b):b},decode_value:function(a,b){return a in this.__value_decoding?this.__value_decoding[a](b):b},_insert:function(a){return this.decode_object(this.__store.insert(this.encode_object(a)))},_remove:function(a){return this.__store.remove(this.encode_value(this._id_key,a))},_get:function(a){return this.decode_object(this.__store.get(this.encode_value(this._id_key,a)))},_update:function(a,b){return this.decode_object(this.__store.update(this.encode_value(this._id_key,a),this.encode_object(b)))},_query_capabilities:function(){return this.__store._query_capabilities()},_query:function(a,b){var c=this,d=this.__store.query(this.encode_object(a),b);return new BetaJS.Iterators.MappedIterator(d,function(a){return c.decode_object(a)})}}),BetaJS.Stores.IndexedStore=BetaJS.Stores.BaseStore.extend("IndexedStore",{constructor:function(a,b,c){c=c||{},c.rebuild="rebuild"in c?c.rebuild:!0,c.id_key=a._id_key,this._inherited(BetaJS.Stores.IndexedStore,"constructor",c),this._store=a,this._indices={},BetaJS.Objs.iter(b||{},function(b,d){b.type=b.type||"StoreIndex",this._indices[d]=new BetaJS.Stores[b.type](a,d),c.rebuild&&this._indices[d].rebuild()},this)},rebuild:function(){BetaJS.Objs.iter(this._indices,function(a){a.rebuild()},this)},_query:function(a,b){var c=!1,d={};for(var e in a)if(e in this._indices){if(c){var f=this._indices[e].get(a[e]);d=BetaJS.Objs.intersect(d,f)}else c=!0,d=this._indices[e].get(a[e]);if(BetaJS.Types.is_empty(d))return{}}if(!c)return this._store.query(a,b);var g=this;return new BetaJS.Iterators.MappedIterator(new BetaJS.Iterators.FilteredIterator(new BetaJS.Iterators.ObjectKeysIterator(d),function(b){return g._query_applies_to_id(a,b)}),function(a){return g.get(a)})},_insert:function(a){return this._store.insert(a)},_remove:function(a){return this._store.remove(a)},_get:function(a){return this._store.get(a)},_update:function(a,b){return this._store.update(a,b)}}),BetaJS.Stores.StoreIndex=BetaJS.Class.extend("StoreIndex",{constructor:function(a,b){this._inherited(BetaJS.Stores.StoreIndex,"constructor"),this._base_store=a,this._index_key=b,this._id_to_key={},this._key_to_ids={},this._base_store.on("insert",function(a){this._insert(a)},this),this._base_store.on("remove",function(a){this._remove(a)},this),this._base_store.on("update",function(a){this._exists(a)||(this._remove(this._id(a)),this._insert(a))},this)},destroy:function(){this._base_store.off(null,null,this),this._inherited(BetaJS.Stores.StoreIndex,"destroy")},rebuild:function(){for(var a=this._base_store.query();a.hasNext();)this.insert(a.next())},_id:function(a){return a[this._base_store._id_key]},_key:function(a){return a[this._index_key]},_insert:function(a){var b=this._id(a),c=this._key(a);this._id_to_key[b]=c,c in this._key_to_ids||(this._key_to_ids[c]={}),this._key_to_ids[c][b]=!0},_remove:function(a){this._id_to_key[a],delete this._id_to_key[a],delete this._key_to_ids[a]},_exists:function(a){return this._id(a)in this._id_to_key},get:function(a){return a in this._key_to_ids?this._key_to_ids[a]:[]}});