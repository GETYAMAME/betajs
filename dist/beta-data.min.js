/*! betajs - v0.0.1 - 2013-06-16, Copyright (c) Oliver Friedmann & Victor Lingenthal, MIT Software License. */BetaJS.Net={},BetaJS.Net.AbstractAjax=BetaJS.Class.extend("AbstractAjax",{constructor:function(a){this._inherited(BetaJS.Net.AbstractAjax,"constructor"),this.__options=BetaJS.Objs.extend({method:"GET",data:{}},a)},syncCall:function(a){var b=BetaJS.Objs.clone(this.__options,1);b=BetaJS.Objs.extend(b,a);var c=b.success_callback;delete b.success_callback;var d=b.failure_callback;delete b.failure_callback;var e=b.complete_callback;delete b.complete_callback;try{var f=this._syncCall(b);return c&&c(f),e&&e(),f}catch(g){if(g=BetaJS.Exceptions.ensure(g),g.assert(BetaJS.Net.AjaxException),!d)throw g;d(g.status_code(),g.status_text(),g.data())}},asyncCall:function(a){var b=BetaJS.Objs.clone(this.__options,1);b=BetaJS.Objs.extend(b,a);var c=b.success_callback;delete b.success_callback;var d=b.failure_callback;delete b.failure_callback;var e=b.complete_callback;delete b.complete_callback;try{var f=this._asyncCall(BetaJS.Objs.extend({success:function(a){c&&c(a),e&&e()},failure:function(a,b,c){if(!d)throw new BetaJS.Net.AjaxException(a,b,c);d(a,b,c),e&&e()}},b));return f}catch(g){if(g=BetaJS.Exceptions.ensure(g),g.assert(BetaJS.Net.AjaxException),!d)throw g;d(g.status_code(),g.status_text(),g.data())}},call:function(a){if(!("async"in a))return!1;var b=a.async;return delete a.async,b?this.asyncCall(a):this.syncCall(a)},_syncCall:function(){},_asyncCall:function(){}}),BetaJS.Net.AjaxException=BetaJS.Exceptions.Exception.extend("AjaxException",{constructor:function(a,b,c){this._inherited(BetaJS.Net.AjaxException,"constructor",a+": "+b),this.__status_code=a,this.__status_text=b,this.__data=c},status_code:function(){return this.__status_code},status_text:function(){return this.__status_text},data:function(){return this.__data}}),BetaJS.Net.JQueryAjax=BetaJS.Net.AbstractAjax.extend("JQueryAjax",{_syncCall:function(a){var b;return BetaJS.$.ajax({type:a.method,async:!1,url:a.uri,data:JSON.stringify(a.data),success:function(a){b=a},error:function(a,b,c){throw new BetaJS.Net.AjaxException(c,b,a)}}),b},_asyncCall:function(a){BetaJS.$.ajax({type:a.method,async:!0,url:a.uri,data:JSON.stringify(a.data),success:function(b){a.success(b)},error:function(b,c,d){a.failure(d,c,b)}})}}),BetaJS.Queries={__dependencies:function(a,b){if(BetaJS.Types.is_array(a)){if(0==a.length)throw"Malformed Query";var c=a[0];if("Or"==c||"And"==c){for(var d=1;d<a.length;++d)b=this.__dependencies(a[d],b);return b}if(3!=a.length)throw"Malformed Query";var e=a[1];return e in b?b[e]++:b[e]=1,b}if(BetaJS.Types.is_object(a)){for(e in a)e in b?b[e]++:b[e]=1;return b}if(BetaJS.Types.is_boolean(a))return b;throw"Malformed Query"},dependencies:function(a){return this.__dependencies(a,{})},overloaded_evaluate:function(a,b){return BetaJS.Class.is_class_instance(a)?a.evaluate(b):BetaJS.Types.is_function(a)?a(b):this.evaluate(a,b)},evaluate:function(a,b){if(null==b)return!1;if(BetaJS.Types.is_array(a)){if(0==a.length)throw"Malformed Query";var c=a[0];if("Or"==c){for(var d=1;d<a.length;++d)if(this.evaluate(a[d],b))return!0;return!1}if("And"==c){for(var d=1;d<a.length;++d)if(!this.evaluate(a[d],b))return!1;return!0}if(3!=a.length)throw"Malformed Query";var e=a[1],f=b[e],g=a[2];if("=="==c)return f==g;if("!="==c)return f!=g;if(">"==c)return f>g;if(">="==c)return f>=g;if("<"==c)return g>f;if("<="==c)return g>=f;throw"Malformed Query"}if(BetaJS.Types.is_object(a)){for(e in a)if(a[e]!=b[e])return!1;return!0}if(BetaJS.Types.is_boolean(a))return a;throw"Malformed Query"},__compile:function(a){if(BetaJS.Types.is_array(a)){if(0==a.length)throw"Malformed Query";var b=a[0];if("Or"==b){for(var c="false",d=1;d<a.length;++d)c+=" || ("+this.__compile(a[d])+")";return c}if("And"==b){for(var c="true",d=1;d<a.length;++d)c+=" && ("+this.__compile(a[d])+")";return c}if(3!=a.length)throw"Malformed Query";var e=a[1],f=a[2],g="object['"+e+"']",h=BetaJS.Types.is_string(f)?"'"+f+"'":f;return g+" "+b+" "+h}if(BetaJS.Types.is_object(a)){var c="true";for(e in a)c+=" && (object['"+e+"'] == "+(BetaJS.Types.is_string(a[e])?"'"+a[e]+"'":a[e])+")";return c}if(BetaJS.Types.is_boolean(a))return a?"true":"false";throw"Malformed Query"},compile:function(a){var b=this.__compile(a),c=new Function("object",b),d=function(a){return c.call(this,a)};return d.source="function(object){\n return "+b+"; }",d}},BetaJS.Queries.CompiledQuery=BetaJS.Class.extend("CompiledQuery",{constructor:function(a){this.__query=a,this.__dependencies=BetaJS.Query.dependencies(a),this.__compiled=BetaJS.Query.compile(a)},query:function(){return this.__query},dependencies:function(){return this.__dependencies},compiled:function(){return this.__compiled},evaluate:function(a){return this.__compiled(a)}}),BetaJS.Stores=BetaJS.Stores||{},BetaJS.Stores.StoreException=BetaJS.Exceptions.Exception.extend("StoreException"),BetaJS.Stores.BaseStore=BetaJS.Class.extend("BaseStore",[BetaJS.Events.EventsMixin,{_insert:function(){},_remove:function(){},_get:function(){},_update:function(){},_query:function(){},_insertEvent:function(a,b){this.trigger("insert",a,b),this.trigger("external",a)},_updateEvent:function(a,b,c){this.trigger("update",a,b,c),this.trigger("external",a,b)},_removeEvent:function(a,b){this.trigger("remove",a,b),this.trigger("external",a)},insert:function(a){var b=this._insert(a);return b&&this._insertEvent(b,!0),b},remove:function(a){var b=this._remove(a);return b&&this._removeEvent(b,!0),b},get:function(a){return this._get(a)},update:function(a,b){var c=this._update(a,b);return c&&this._updateEvent(c,b,!0),c},query:function(a,b){return this._query(a,b)},_query_applies_to_id:function(a,b){var c=this.get(b);return c&&BetaJS.Queries.overloaded_evaluate(a,c)},clear:function(){for(var a=this.query({});a.hasNext();)this.remove(a.next().id)}}]),BetaJS.Stores.DumbStore=BetaJS.Stores.BaseStore.extend("DumbStore",{_read_last_id:function(){},_write_last_id:function(){},_remove_last_id:function(){},_read_first_id:function(){},_write_first_id:function(){},_remove_first_id:function(){},_read_item:function(){},_write_item:function(){},_remove_item:function(){},_read_next_id:function(){},_write_next_id:function(){},_remove_next_id:function(){},_read_prev_id:function(){},_write_prev_id:function(){},_remove_prev_id:function(){},_insert:function(a){var b=this._read_last_id(),c=1;return null!=b?(c=b+1,this._write_next_id(b,c),this._write_prev_id(c,b)):this._write_first_id(c),a.id=c,this._write_last_id(c),this._write_item(c,a),a},_remove:function(a){var b=this._read_item(a);if(b){this._remove_item(a);var c=this._read_next_id(a),d=this._read_prev_id(a);null!=c?(this._remove_next_id(a),null!=d?(this._remove_prev_id(a),this._write_next_id(d,c),this._write_prev_id(c,d)):(this._remove_prev_id(c),this._write_first_id(c))):null!=d?(this._remove_next_id(d),this._write_last_id(d)):(this._remove_first_id(),this._remove_last_id())}return b},_get:function(a){return this._read_item(a)},_update:function(a,b){var c=this._get(a);return c&&(delete b.id,BetaJS.Objs.extend(c,b),this._write_item(a,c)),c},_query:function(a){var b=new BetaJS.Iterators.Iterator,c=this,d=this._read_first_id();return BetaJS.Objs.extend(b,{__id:null==d?1:d,__store:c,__query:a,hasNext:function(){var b=this.__store._read_last_id();if(null==b)return!1;for(;this.__id<b&&!this.__store._read_item(this.__id);)this.__id++;for(;this.__id<=b;){if(this.__store._query_applies_to_id(a,this.__id))return!0;this.__id<b?this.__id=this.__store._read_next_id(this.__id):this.__id++}return!1},next:function(){if(this.hasNext()){var a=this.__store.get(this.__id);return this.__id==this.__store._read_last_id()?this.__id++:this.__id=this.__store._read_next_id(this.__id),a}return null}}),b}}),BetaJS.Stores.AssocStore=BetaJS.Stores.DumbStore.extend("AssocStore",{_read_key:function(){},_write_key:function(){},_remove_key:function(){},__read_id:function(a){var b=this._read_key(a);return b?parseInt(b):null},_read_last_id:function(){return this.__read_id("last_id")},_write_last_id:function(a){this._write_key("last_id",a)},_remove_last_id:function(){this._remove_key("last_id")},_read_first_id:function(){return this.__read_id("first_id")},_write_first_id:function(a){this._write_key("first_id",a)},_remove_first_id:function(){this._remove_key("first_id")},_read_item:function(a){return this._read_key("item_"+a)},_write_item:function(a,b){this._write_key("item_"+a,b)},_remove_item:function(a){this._remove_key("item_"+a)},_read_next_id:function(a){return this.__read_id("next_"+a)},_write_next_id:function(a,b){this._write_key("next_"+a,b)},_remove_next_id:function(a){this._remove_key("next_"+a)},_read_prev_id:function(a){return this.__read_id("prev_"+a)},_write_prev_id:function(a,b){this._write_key("prev_"+a,b)},_remove_prev_id:function(a){this._remove_key("prev_"+a)}}),BetaJS.Stores.LocalStore=BetaJS.Stores.AssocStore.extend("LocalStore",{constructor:function(a){this._inherited(BetaJS.Stores.LocalStore,"constructor"),this.__prefix=a},__key:function(a){return this.__prefix+a},_read_key:function(a){var b=this.__key(a);return b in localStorage?JSON.parse(localStorage[b]):null},_write_key:function(a,b){localStorage[this.__key(a)]=JSON.stringify(b)},_remove_key:function(a){delete localStorage[this.__key(a)]}}),BetaJS.Stores.MemoryStore=BetaJS.Stores.AssocStore.extend("MemoryStore",{_read_key:function(a){return this[a]},_write_key:function(a,b){this[a]=b},_remove_key:function(a){delete this[a]}}),BetaJS.Stores.CachedStore=BetaJS.Stores.BaseStore.extend("CachedStore",{constructor:function(a){this._inherited(BetaJS.Stores.CachedStore,"constructor"),this.__parent=a,this.__cache=[]},_insert:function(a){var b=this.__parent._insert(a);return b&&(this.__cache[b.id]={data:b,exists:!0}),b},_remove:function(a){return a in this._cache||(this.__cache[a]={}),this.__cache[a].exists=!1,this.__parent._remove(a)},_get:function(a){if(a in this.__cache)return this.__cache[a].exists;var b=this.__parent.get(a);return this.__cache[a]=b?{exists:!0,data:b}:{exists:!1},b},_update:function(a,b){var c=this.__parent.update(a,b);return c&&(this.__cache[a]={exists:!0,data:b}),c},invalidate:function(a){delete this.__cache[a]},_query:function(a,b){return this.__parent.query(a,b)}}),BetaJS.Stores.RemoteStore=BetaJS.Stores.BaseStore.extend("RemoteStore",{constructor:function(a,b){this._inherited(BetaJS.Stores.RemoteStore,"constructor"),this.__uri=a,this.__ajax=b},_insert:function(a){try{return this.__ajax.syncCall({method:"POST",uri:this.__uri,data:a})}catch(b){throw new BetaJS.Stores.StoreException(BetaJS.Net.AjaxException.ensure(b).toString())}},_remove:function(a){try{var b=this.__ajax.syncCall({method:"DELETE",uri:this.__uri+"/"+a});return b?b:{id:a}}catch(c){throw new BetaJS.Stores.StoreException(BetaJS.Net.AjaxException.ensure(c).toString())}},_get:function(a){try{return this.__ajax.syncCall({uri:this.__uri+"/"+a})}catch(b){throw new BetaJS.Stores.StoreException(BetaJS.Net.AjaxException.ensure(b).toString())}},_update:function(a,b){try{return this.__ajax.syncCall({method:"PUT",uri:this.__uri+"/"+a,data:b})}catch(c){throw new BetaJS.Stores.StoreException(BetaJS.Net.AjaxException.ensure(c).toString())}},_query:function(a){try{var b=this.__ajax.syncCall({uri:this.__uri});return null==b?BetaJS.Iterators.ArrayIterator([]):new BetaJS.Iterators.FilteredIterator(new BetaJS.Iterators.ArrayIterator(b),function(b){return BetaJS.Queries.evaluate(a,b)})}catch(c){throw new BetaJS.Stores.StoreException(BetaJS.Net.AjaxException.ensure(c).toString())}}});