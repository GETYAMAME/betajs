/*! betajs - v0.0.1 - 2013-08-26, Copyright (c) Oliver Friedmann & Victor Lingenthal, MIT Software License. */BetaJS.Class.extend("BetaJS.Net.AbstractAjax",{constructor:function(t){this._inherited(BetaJS.Net.AbstractAjax,"constructor"),this.__options=BetaJS.Objs.extend({method:"GET",data:{}},t)},syncCall:function(t){var e=BetaJS.Objs.clone(this.__options,1);e=BetaJS.Objs.extend(e,t);var i=e.success_callback;delete e.success_callback;var r=e.failure_callback;delete e.failure_callback;var n=e.complete_callback;delete e.complete_callback;try{var s=this._syncCall(e);return i&&i(s),n&&n(),s}catch(_){if(_=BetaJS.Exceptions.ensure(_),_.assert(BetaJS.Net.AjaxException),!r)throw _;r(_.status_code(),_.status_text(),_.data())}},asyncCall:function(t){var e=BetaJS.Objs.clone(this.__options,1);e=BetaJS.Objs.extend(e,t);var i=e.success_callback;delete e.success_callback;var r=e.failure_callback;delete e.failure_callback;var n=e.complete_callback;delete e.complete_callback;try{var s=this._asyncCall(BetaJS.Objs.extend({success:function(t){i&&i(t),n&&n()},failure:function(t,e,i){if(!r)throw new BetaJS.Net.AjaxException(t,e,i);r(t,e,i),n&&n()}},e));return s}catch(_){if(_=BetaJS.Exceptions.ensure(_),_.assert(BetaJS.Net.AjaxException),!r)throw _;r(_.status_code(),_.status_text(),_.data())}},call:function(t){if(!("async"in t))return!1;var e=t.async;return delete t.async,e?this.asyncCall(t):this.syncCall(t)},_syncCall:function(){},_asyncCall:function(){}}),BetaJS.Exceptions.Exception.extend("BetaJS.Net.AjaxException",{constructor:function(t,e,i){this._inherited(BetaJS.Net.AjaxException,"constructor",t+": "+e),this.__status_code=t,this.__status_text=e,this.__data=i},status_code:function(){return this.__status_code},status_text:function(){return this.__status_text},data:function(){return this.__data}}),BetaJS.Net.AbstractAjax.extend("BetaJS.Net.JQueryAjax",{_syncCall:function(t){var e;return BetaJS.$.ajax({type:t.method,async:!1,url:t.uri,dataType:t.decodeType?t.decodeType:null,data:t.encodeType&&"json"==t.encodeType?JSON.stringify(t.data):t.data,success:function(t){e=t},error:function(t,e,i){throw new BetaJS.Net.AjaxException(t.status,i,JSON.parse(t.responseText))}}),e},_asyncCall:function(t){BetaJS.$.ajax({type:t.method,async:!0,url:t.uri,dataType:t.decodeType?t.decodeType:null,data:t.encodeType&&"json"==t.encodeType?JSON.stringify(t.data):t.data,success:function(e){t.success(e)},error:function(e,i,r){t.failure(e.status,r,JSON.parse(e.responseText))}})}}),BetaJS.Queries={__increase_dependency:function(t,e){return t in e?e[t]++:e[t]=1,e},__dependencies_queries:function(t,e){return BetaJS.Objs.iter(t,function(t){e=this.__dependencies_query(t,e)},this),e},__dependencies_query:function(t,e){for(key in t)e=this.__dependencies_pair(key,t[key],e);return e},__dependencies_pair:function(t,e,i){return"$or"==t||"$and"==t?this.__dependencies_queries(e,i):this.__increase_dependency(t,i)},dependencies:function(t){return this.__dependencies_query(t,{})},__evaluate_query:function(t,e){for(key in t)if(!this.__evaluate_pair(key,t[key],e))return!1;return!0},__evaluate_pair:function(t,e,i){return"$or"==t?this.__evaluate_or(e,i):"$and"==t?this.__evaluate_and(e,i):this.__evaluate_value(e,i[t])},__evaluate_value:function(t,e){if(BetaJS.Types.is_object(t)){var i=!0;return BetaJS.Objs.iter(t,function(t,r){"$in"==r&&(i=i&&BetaJS.Objs.contains_value(t,e)),"$gt"==r&&(i=i&&e>=t),"$gtic"==r&&(i=i&&e.toLowerCase()>=t.toLowerCase()),"$lt"==r&&(i=i&&t>=e),"$ltic"==r&&(i=i&&e.toLowerCase()<=t.toLowerCase()),"$sw"==r&&(i=i&&0==e.indexOf(t)),"$swic"==r&&(i=i&&0==e.toLowerCase().indexOf(t.toLowerCase()))},this),i}return t==e},__evaluate_or:function(t,e){return BetaJS.Objs.iter(t,function(t){return this.__evaluate_query(t,e)?!0:void 0},this),!1},__evaluate_and:function(t,e){return BetaJS.Objs.iter(t,function(t){return this.__evaluate_query(t,e)?void 0:!1},this),!0},format:function(t){return BetaJS.Class.is_class_instance(t)?t.format():JSON.stringify(t)},overloaded_evaluate:function(t,e){return BetaJS.Class.is_class_instance(t)?t.evaluate(e):BetaJS.Types.is_function(t)?t(e):this.evaluate(t,e)},evaluate:function(t,e){return this.__evaluate_query(t,e)},emulate:function(t,e,i){var r=e.apply(i||this,{}),n=r;return null==r?n=BetaJS.Iterators.ArrayIterator([]):BetaJS.Types.is_array(r)&&(n=BetaJS.Iterators.ArrayIterator(r)),new BetaJS.Iterators.FilteredIterator(n,function(e){return BetaJS.Queries.evaluate(t,e)})}},BetaJS.Queries.Constrained={make:function(t,e){return{query:t,options:e||{}}},format:function(t){var e=t.query;t.query=BetaJS.Queries.format(e);var i=JSON.stringify(t);return t.query=e,i},emulate:function(t,e,i,r,n){var s=t.query,_=t.options,o={},a={};"sort"in _&&"sort"in e&&(a.sort=_.sort),o=s,("query"in e||BetaJS.Types.is_empty(s))&&(o=s,(!("sort"in _)||"sort"in e)&&("skip"in _&&"skip"in e&&(a.skip=_.skip),"limit"in _&&"limit"in e&&(a.limit=_.limit)));var c=[o,a];n&&c.push(n);var u=function(t){var i=t;return null==t?i=new BetaJS.Iterators.ArrayIterator([]):BetaJS.Types.is_array(t)&&(i=new BetaJS.Iterators.ArrayIterator(t)),"query"in e||BetaJS.Types.is_empty(s)||(i=new BetaJS.Iterators.FilteredIterator(i,function(t){return BetaJS.Queries.evaluate(s,t)})),"sort"in _&&!("sort"in a)&&(i=new BetaJS.Iterators.SortedIterator(i,BetaJS.Comparators.byObject(_.sort))),"skip"in _&&!("skip"in a)&&(i=new BetaJS.Iterators.SkipIterator(i,_.skip)),"limit"in _&&!("limit"in a)&&(i=new BetaJS.Iterators.LimitIterator(i,_.limit)),n&&n.success&&n.success(i),i},h=function(t){if(!n||!n.exception)throw t;n.exception(t)};if(n)i.apply(r||this,[o,a,{success:u,exception:h}]);else try{var d=i.apply(r||this,[o,a]);return u(d)}catch(l){h(l)}}},BetaJS.Collections.Collection.extend("BetaJS.Collections.QueryCollection",{constructor:function(t){this._inherited(BetaJS.Collections.QueryCollection,"constructor",t),this.__query=BetaJS.Objs.extend({func:null,select:{},skip:0,limit:null,forward_steps:null,backward_steps:null,range:null,count:null,sort:{}},t.query),"objects"in t||(t.objects=this.__execute_query(this.__query.skip,this.__query.limit,!0))},__execute_query:function(t,e,i){t=Math.max(t,0);var r={};if(null==this.__query.sort||BetaJS.Types.is_empty(this.__query.sort)||(r.sort=this.__query.sort),i){t>0&&(r.skip=t),null!=e&&(r.limit=e);var n=this.__query.func(this.__query.select,r),s=n.asArray();this.__query.skip=t,this.__query.limit=e,this.__query.count=null==e||e>s.length?t+s.length:null,this.clear(),this.add_objects(s)}else if(this.__query.skip>t){e=this.__query.skip-t,t>0&&(r.skip=t),r.limit=e;var n=this.__query.func(this.__query.select,r),s=n.asArray();this.__query.skip=t,this.__query.limit=null==this.__query.limit?null:this.__query.limit+s.length,this.add_objects(s)}else if(t>=this.__query.skip&&null!=this.__query.limit&&(null==e||t+e>this.__query.skip+this.__query.limit)){e=t+e-(this.__query.skip+this.__query.limit),t=this.__query.skip+this.__query.limit,t>0&&(r.skip=t),null!=e&&(r.limit=e);var n=this.__query.func(this.__query.select,r),s=n.asArray();this.__query.limit=this.__query.limit+s.length,e>s.length&&(this.__query.count=t+s.length),this.add_objects(s)}},increase_forwards:function(t){t=null==t?this.__query.forward_steps:t,null!=t&&null!=this.__query.limit&&this.__execute_query(this.__query.skip+this.__query.limit,t,!1)},increase_backwards:function(t){if(t=null==t?this.__query.backward_steps:t,null!=t&&this.__query.skip>0){var t=Math.min(t,this.__query.skip);this.__execute_query(this.__query.skip-t,t,!1)}},paginate:function(t){this.__execute_query(this.__query.range*t,this.__query.range,!0)},paginate_index:function(){return null==this.__query.range?null:Math.floor(this.__query.skip/this.__query.range)},paginate_count:function(){return null==this.__query.count||null==this.__query.range?null:Math.ceil(this.__query.count/this.__query.range)},next:function(){var t=this.paginate_index();if(null!=t){var e=this.paginate_count();(null==e||this.paginate_count()-1>t)&&this.paginate(t+1)}},prev:function(){var t=this.paginate_index();null!=t&&t>0&&this.paginate(t-1)},isComplete:function(){return null!=this.__query.count}}),BetaJS.Class.extend("BetaJS.Queries.ActiveQueryEngine",{constructor:function(){this._inherited(BetaJS.Queries.ActiveQueryEngine,"constructor"),this.__aqs={},this.__object_to_aqs={}},__valid_for_aq:function(t,e){return BetaJS.Queries.evaluate(e.query(),t)},insert:function(t){if(!this.__object_to_aqs[BetaJS.Ids.objectId(t)]){var e=t.getAll(),i={};this.__object_to_aqs[BetaJS.Ids.objectId(t)]=i,BetaJS.Objs.iter(this.__aqs,function(r){this.__valid_for_aq(e,r)&&(r._add(t),i[r.cid()]=r)},this),t.on("change",function(){this.update(t)},this)}},remove:function(t){BetaJS.Objs.iter(this.__object_to_aqs[BetaJS.Ids.objectId(t)],function(e){e._remove(t)},this),delete this.__object_to_aqs[BetaJS.Ids.objectId(t)],t.off(null,this,null)},update:function(t){var e=t.getAll(),i=this.__object_to_aqs[BetaJS.Ids.objectId(t)];BetaJS.Objs.iter(this.__object_to_aqs[BetaJS.Ids.objectId(t)],function(r){this.__valid_for_aq(e,r)||(r._remove(t),delete i[r.cid()])},this),BetaJS.Objs.iter(this.__aqs,function(r){this.__valid_for_aq(e,r)&&(r._add(t),i[r.cid()]=r)},this)},register:function(t){this.__aqs[t.cid()]=t;for(var e=t.query(),i=this._query(e);i.hasNext();){var r=i.next();this.__object_to_aqs[BetaJS.Ids.objectId(r)]?(this.__object_to_aqs[BetaJS.Ids.objectId(r)][t.cid()]=t,t._add(r)):this.insert(r)}},unregister:function(t){delete this.__aqs[t.cid()];var e=this;t.collection().iterate(function(i){delete e.__object_to_aqs[BetaJS.Ids.objectId(i)][t.cid()]})},_query:function(){}}),BetaJS.Class.extend("BetaJS.Queries.ActiveQuery",[BetaJS.Ids.ClientIdMixin,{constructor:function(t,e){this._inherited(BetaJS.Queries.ActiveQuery,"constructor"),this.__engine=t,this.__query=e,this.__collection=new BetaJS.Collections.Collection,this.__collection.on("destroy",function(){this.destroy()},this),t.register(this)},destroy:function(){this.__engine.unregister(this),this._inherited(BetaJS.Queries.ActiveQuery,"destroy")},isUniform:function(){return BetaJS.Types.is_empty(this.query())},engine:function(){return this.__engine},query:function(){return this.__query},collection:function(){return this.__collection},_add:function(t){this.__collection.add(t)},_remove:function(t){this.__collection.remove(t)},change_query:function(t){this.__engine.unregister(this),this.__query=t,this.__collection.clear(),this.__engine.register(this)}}]),BetaJS.Exceptions.Exception.extend("BetaJS.Stores.StoreException"),BetaJS.Class.extend("BetaJS.Stores.BaseStore",[BetaJS.Events.EventsMixin,{constructor:function(t){this._inherited(BetaJS.Stores.BaseStore,"constructor"),t=t||{},this._id_key=t.id_key||"id",this._create_ids=t.create_ids||!1,this._last_id=1,this._async_write="async_write"in t?t.async_write:!1,this._async_write=this._async_write&&this._supports_async_write(),this._async_read="async_read"in t?t.async_read:!1,this._async_read=this._async_read&&this._supports_async_read()},id_key:function(){return this._id_key},_supports_async_read:function(){return!1},async_read:function(){return this._async_read},_supports_async_write:function(){return!1},async_write:function(){return this._async_write},_insert:function(){},_remove:function(){},_get:function(){},_update:function(){},_query_capabilities:function(){return{}},_query:function(){},_new_id:function(){},insert:function(t,e){if(this._create_ids&&!(this._id_key in t)){if(this._async_write)throw new BetaJS.Stores.StoreException("Unsupported Creation of Ids");for(;this.get(this._last_id);)this._last_id++;t[this._id_key]=this._last_id}var i=this,r=function(t){i.trigger("insert",t),e&&e.success&&e.success(t)},n=function(t){if(!e||!e.exception)throw t;e.exception(t)};if(this._async_write)this._insert(t,{success:r,exception:n});else try{var s=this._insert(t);return r(s),s}catch(_){n(_)}},insert_all:function(t){if(!this._async_write){var e=!0;return BetaJS.Objs.iter(t,function(t){e=e&&this.insert(t,callbacks)},this),e}var i=-1,r=this,n=function(){i++,t.length>i&&r.insert(t[i],{success:n})};n()},remove:function(t,e){var i=this,r=function(){i.trigger("remove",t),e&&e.success&&e.success(t)},n=function(t){if(!e||!e.exception)throw t;e.exception(t)};if(this._async_write)this._remove(t,{success:r,exception:n});else try{this._remove(t),r()}catch(s){n(s)}},get:function(t,e){var i=function(t){e&&e.success&&e.success(t)},r=function(t){if(!e||!e.exception)throw t;e.exception(t)};if(this._async_read)this._get(t,{success:i,exception:r});else try{var n=this._get(t);return i(n),n}catch(s){r(s)}},update:function(t,e,i){var r=this,n=function(t){r.trigger("update",t,e),i&&i.success&&i.success(t,e)},s=function(t){if(!i||!i.exception)throw t;i.exception(t)};if(this._async_write)this._update(t,e,{success:n,exception:s});else try{var _=this._update(t,e);return n(_),_}catch(o){s(o)}},query:function(t,e,i){return BetaJS.Queries.Constrained.emulate(BetaJS.Queries.Constrained.make(t,e||{}),this._query_capabilities(),this._query,this,i)},_query_applies_to_id:function(t,e){var i=this.get(e);return i&&BetaJS.Queries.overloaded_evaluate(t,i)},clear:function(){for(var t=this.query({});t.hasNext();)this.remove(t.next().id)}}]),BetaJS.Class.extend("BetaJS.Stores.StoresMonitor",[BetaJS.Events.EventsMixin,{attach:function(t,e){e.on("insert",function(i){this.trigger("insert",t,e,i),this.trigger("write","insert",t,e,i)},this),e.on("remove",function(i){this.trigger("remove",t,e,i),this.trigger("write","remove",t,e,i)},this),e.on("update",function(i,r){this.trigger("update",t,e,i,r),this.trigger("write","update",t,e,i,r)},this)}}]),BetaJS.Stores.BaseStore.extend("BetaJS.Stores.AssocStore",{_read_key:function(){},_write_key:function(){},_remove_key:function(){},_iterate:function(){},constructor:function(t){t=t||{},t.create_ids=!0,this._inherited(BetaJS.Stores.AssocStore,"constructor",t)},_insert:function(t){return this._write_key(t[this._id_key],t),t},_remove:function(t){var e=this._read_key(t);return e&&!this._remove_key(t)?null:e},_get:function(t){return this._read_key(t)},_update:function(t,e){var i=this._get(t);return i&&(delete e[this._id_key],BetaJS.Objs.extend(i,e),this._write_key(t,i)),i},_query:function(){return this._iterate()}}),BetaJS.Stores.AssocStore.extend("BetaJS.Stores.MemoryStore",{constructor:function(t){this._inherited(BetaJS.Stores.MemoryStore,"constructor",t),this.__data={}},_read_key:function(t){return this.__data[t]},_write_key:function(t,e){this.__data[t]=e},_remove_key:function(t){delete this.__data[t]},_iterate:function(){return new BetaJS.Iterators.ObjectValuesIterator(this.__data)}}),BetaJS.Stores.BaseStore.extend("BetaJS.Stores.DumbStore",{_read_last_id:function(){},_write_last_id:function(){},_remove_last_id:function(){},_read_first_id:function(){},_write_first_id:function(){},_remove_first_id:function(){},_read_item:function(){},_write_item:function(){},_remove_item:function(){},_read_next_id:function(){},_write_next_id:function(){},_remove_next_id:function(){},_read_prev_id:function(){},_write_prev_id:function(){},_remove_prev_id:function(){},constructor:function(t){t=t||{},t.create_ids=!0,this._inherited(BetaJS.Stores.DumbStore,"constructor",t)},_insert:function(t){var e=this._read_last_id(),i=t[this._id_key];return null!=e?(this._write_next_id(e,i),this._write_prev_id(i,e)):this._write_first_id(i),this._write_last_id(i),this._write_item(i,t),t},_remove:function(t){var e=this._read_item(t);if(e){this._remove_item(t);var i=this._read_next_id(t),r=this._read_prev_id(t);null!=i?(this._remove_next_id(t),null!=r?(this._remove_prev_id(t),this._write_next_id(r,i),this._write_prev_id(i,r)):(this._remove_prev_id(i),this._write_first_id(i))):null!=r?(this._remove_next_id(r),this._write_last_id(r)):(this._remove_first_id(),this._remove_last_id())}return e},_get:function(t){return this._read_item(t)},_update:function(t,e){var i=this._get(t);return i&&(delete e[this._id_key],BetaJS.Objs.extend(i,e),this._write_item(t,i)),i},_query_capabilities:function(){return{query:!0}},_query:function(t){var e=new BetaJS.Iterators.Iterator,i=this,r=this._read_first_id();return BetaJS.Objs.extend(e,{__id:null==r?1:r,__store:i,__query:t,hasNext:function(){var e=this.__store._read_last_id();if(null==e)return!1;for(;e>this.__id&&!this.__store._read_item(this.__id);)this.__id++;for(;e>=this.__id;){if(this.__store._query_applies_to_id(t,this.__id))return!0;e>this.__id?this.__id=this.__store._read_next_id(this.__id):this.__id++}return!1},next:function(){if(this.hasNext()){var t=this.__store.get(this.__id);return this.__id==this.__store._read_last_id()?this.__id++:this.__id=this.__store._read_next_id(this.__id),t}return null}}),e}}),BetaJS.Stores.DumbStore.extend("BetaJS.Stores.AssocDumbStore",{_read_key:function(){},_write_key:function(){},_remove_key:function(){},__read_id:function(t){var e=this._read_key(t);return e?parseInt(e):null},_read_last_id:function(){return this.__read_id("last_id")},_write_last_id:function(t){this._write_key("last_id",t)},_remove_last_id:function(){this._remove_key("last_id")},_read_first_id:function(){return this.__read_id("first_id")},_write_first_id:function(t){this._write_key("first_id",t)},_remove_first_id:function(){this._remove_key("first_id")},_read_item:function(t){return this._read_key("item_"+t)},_write_item:function(t,e){this._write_key("item_"+t,e)},_remove_item:function(t){this._remove_key("item_"+t)},_read_next_id:function(t){return this.__read_id("next_"+t)},_write_next_id:function(t,e){this._write_key("next_"+t,e)},_remove_next_id:function(t){this._remove_key("next_"+t)},_read_prev_id:function(t){return this.__read_id("prev_"+t)},_write_prev_id:function(t,e){this._write_key("prev_"+t,e)},_remove_prev_id:function(t){this._remove_key("prev_"+t)}}),BetaJS.Stores.AssocDumbStore.extend("BetaJS.Stores.LocalStore",{constructor:function(t){this._inherited(BetaJS.Stores.LocalStore,"constructor",t),this.__prefix=t.prefix},__key:function(t){return this.__prefix+t},_read_key:function(t){var e=this.__key(t);return e in localStorage?JSON.parse(localStorage[e]):null},_write_key:function(t,e){localStorage[this.__key(t)]=JSON.stringify(e)},_remove_key:function(t){delete localStorage[this.__key(t)]}}),BetaJS.Stores.BaseStore.extend("BetaJS.Stores.DualStore",{constructor:function(t,e,i){i=BetaJS.Objs.extend({create_options:{},update_options:{},delete_options:{},get_options:{},query_options:{}},i||{}),i.id_key=t._id_key,i.async_write=t.async_write(),this.__first=t,this.__second=e,this._inherited(BetaJS.Stores.DualStore,"constructor",i),this.__create_options=BetaJS.Objs.extend({start:"first",strategy:"then"},i.create_options),this.__update_options=BetaJS.Objs.extend({start:"first",strategy:"then"},i.update_options),this.__remove_options=BetaJS.Objs.extend({start:"first",strategy:"then"},i.delete_options),this.__get_options=BetaJS.Objs.extend({start:"first",strategy:"or",clone:!0,clone_second:!1,or_on_null:!0},i.get_options),this.__query_options=BetaJS.Objs.extend({start:"first",strategy:"or",clone:!0,clone_second:!1,or_on_null:!0},i.query_options)},first:function(){return this.__first},second:function(){return this.__second},_supports_async_read:function(){return!1},_supports_async_write:function(){return this.__first.async_write()},_insert:function(t,e){var i=this.__first,r=this.__second;"first"!=this.__create_options.start&&(i=this.__second,r=this.__first);var n=this.__create_options.strategy;if(this.async_write())if("then"==n)i.insert(t,{success:function(t){r.insert(t,e)},exception:e.exception});else{if("or"==n)return i.insert(t,{success:e.success,exception:function(){r.insert(t,e)}});i.insert(t,e)}else{if("then"==n)return r.insert(i.insert(t));if("or"!=n)return i.insert(t);try{return i.insert(t)}catch(s){return r.insert(t)}}},_update:function(t,e,i){var r=this.__first,n=this.__second;"first"!=this.__update_options.start&&(r=this.__second,n=this.__first);var s=this.__update_options.strategy;if(this.async_write())if("then"==s)r.update(t,e,{success:function(e){n.update(t,e,i)},exception:i.exception});else{if("or"==s)return r.update(t,e,{success:i.success,exception:function(){n.update(t,e,i)}});r.update(t,e,i)}else{if("then"==s)return n.update(t,r.update(t,e));if("or"!=s)return r.update(t,e);try{return r.update(t,e)}catch(_){return n.update(t,e)}}},_remove:function(t,e){var i=this.__first,r=this.__second;"first"!=this.__remove_options.start&&(i=this.__second,r=this.__first);var n=this.__remove_options.strategy;if(this.async_write())if("then"==n)i.remove(t,{success:function(){r.remove(t,e)},exception:e.exception});else{if("or"==n)return i.remove(t,{success:e.success,exception:function(){r.remove(t,e)}});i.remove(t,e)}else if("then"==n)i.remove(t),r.remove(t);else if("or"==n)try{i.remove(t)}catch(s){r.remove(t)}else i.remove(t)},_get:function(t){var e=this.__first,i=this.__second;"first"!=this.__get_options.start&&(e=this.__second,i=this.__first);var r=this.__get_options.strategy,n=this.__get_options.clone,s=this.__get_options.clone_second,_=this.__get_options.or_on_null;if("or"!=r)return e.get(t);try{var o=e.get(t);if(null==o&&_)throw new{};if(s){try{i.get(t)&&(s=!1)}catch(a){}s&&i.insert(o)}return o}catch(a){var o=i.get(t);return null!=o&&n&&e.insert(o),o}},_query_capabilities:function(){return{query:!0,sort:!0,limit:!0,skip:!0}},_query:function(t,e){var i=this.__first,r=this.__second;"first"!=this.__query_options.start&&(i=this.__second,r=this.__first);var n=this.__query_options.strategy,s=this.__query_options.clone,_=this.__get_options.clone_second,o=this.__query_options.or_on_null;if("or"!=n)return i.query(t,e);try{var a=i.query(t,e);if(null==a&&o)throw{};if(_){try{r.get(t,e)&&(s=!1)}catch(c){}_&&("cache_query"in r?r.cache_query(a):r.insert_all(a.asArray()))}return a}catch(c){var a=r.query(t,e);return null!=a&&s&&("cache_query"in i?i.cache_query(a):i.insert_all(a.asArray())),a}}}),BetaJS.Stores.StoreException.extend("BetaJS.Stores.StoreCacheException"),BetaJS.Stores.DualStore.extend("BetaJS.Stores.FullyCachedStore",{constructor:function(t,e){e=e||{},this._inherited(BetaJS.Stores.FullyCachedStore,"constructor",t,new BetaJS.Stores.MemoryStore({id_key:t.id_key()}),BetaJS.Objs.extend({get_options:{start:"second",strategy:"single"},query_options:{start:"second",strategy:"single"}},e))},cache:function(){return this.second()},store:function(){return this.first()}}),BetaJS.Stores.MemoryStore.extend("BetaJS.Stores.QueryCachedStore.InnerStore",{constructor:function(t){this._inherited(BetaJS.Stores.QueryCachedStore.InnerStore,"constructor",t),this.__queries={}},_query_capabilities:function(){return{query:!0,sort:!0,limit:!0,skip:!0}},_query:function(t,e){var i=BetaJS.Queries.Constrained.make(t,e),r=BetaJS.Queries.Constrained.format(i);if(r in this.__queries)return new BetaJS.Iterators.ArrayIterator(BetaJS.Objs.values(this.__queries[r]));throw new BetaJS.Stores.StoreCacheException},cache_query:function(t,e,i){var r=BetaJS.Queries.Constrained.make(t,e),n=BetaJS.Queries.Constrained.format(r);this.__queries[n]={};for(var s=0;i.length>s;++s){var _=i[s];this.insert(_),this.__queries[n][_[this.id_key()]]=_}},insert:function(t,e){return this.trigger("cache",t),this._inherited(BetaJS.Stores.QueryCachedStore.InnerStore,"insert",t,e)}}),BetaJS.Stores.DualStore.extend("BetaJS.Stores.QueryCachedStore",{constructor:function(t,e){e=e||{},this._inherited(BetaJS.Stores.QueryCachedStore,"constructor",t,new BetaJS.Stores.QueryCachedStore.InnerStore({id_key:t.id_key()}),BetaJS.Objs.extend({get_options:{start:"second",strategy:"or"},query_options:{start:"second",strategy:"or",clone:!1,or_on_null:!1}},e))},cache:function(){return this.second()},store:function(){return this.first()}}),BetaJS.Stores.StoreException.extend("BetaJS.Stores.RemoteStoreException",{constructor:function(t){t=BetaJS.Net.AjaxException.ensure(t),this._inherited(BetaJS.Stores.RemoteStoreException,"constructor",""+t),this.__source=t},source:function(){return this.__source}}),BetaJS.Stores.BaseStore.extend("BetaJS.Stores.RemoteStore",{constructor:function(t,e,i){this._inherited(BetaJS.Stores.RemoteStore,"constructor",i),this._uri=t,this.__ajax=e,this.__options=BetaJS.Objs.extend({update_method:"PUT",uri_mappings:{}},i||{})},_supports_async_write:function(){return!0},_supports_async_read:function(){return!1},getUri:function(){return this._uri},prepare_uri:function(t,e){return this.__options.uri_mappings[t]?this.__options.uri_mappings[t](e):"remove"==t||"get"==t||"update"==t?this.getUri()+"/"+e[this._id_key]:this.getUri()},_include_callbacks:function(t,e,i){return t.failure=function(t,i,r){e(new BetaJS.Stores.RemoteStoreException(new BetaJS.Net.AjaxException(t,i,r)))},t.success=i,t},_insert:function(t,e){try{var i={method:"POST",uri:this.prepare_uri("insert",t),data:t};if(!this._async_write)return this.__ajax.syncCall(i);this.__ajax.asyncCall(this._include_callbacks(i,e.exception,e.success))}catch(r){throw new BetaJS.Stores.RemoteStoreException(r)}},_remove:function(t,e){try{var i={method:"DELETE",uri:this.prepare_uri("remove",data)};if(!this._async_write){var r=this.__ajax.syncCall(i);return r||(r={},r[this._id_key]=t),r}var n=this;i=this._include_callbacks(i,e.exception,function(i){i||(i={},i[n._id_key]=t),e.success(i)}),this.__ajax.asyncCall(i)}catch(s){throw new BetaJS.Stores.RemoteStoreException(s)}},_get:function(t,e){var i={};i[this._id_key]=t;try{var r={uri:this.prepare_uri("get",i)};if(!this._async_read)return this.__ajax.syncCall(r);this.__ajax.asyncCall(this._include_callbacks(r,e.exception,e.success))}catch(n){throw new BetaJS.Stores.RemoteStoreException(n)}},_update:function(t,e,i){var r=BetaJS.Objs.clone(e,1);r[this._id_key]=t;try{var n={method:this.__options.update_method,uri:this.prepare_uri("update",r),data:e};if(!this._async_write)return this.__ajax.syncCall(n);this.__ajax.asyncCall(this._include_callbacks(n,i.exception,i.success))}catch(s){throw new BetaJS.Stores.RemoteStoreException(s)}},_query:function(t,e,i){try{var r=this._encode_query(t,e);if(!this._async_read){var n=this.__ajax.syncCall(r);return BetaJS.Types.is_string(n)?JSON.parse(n):n}r=this._include_callbacks(r,i.exception,function(){i.success(BetaJS.Types.is_string(n)?JSON.parse(n):n)}),this.__ajax.asyncCall(r)}catch(s){throw new BetaJS.Stores.RemoteStoreException(s)}},_encode_query:function(){return{uri:this.prepare_uri("query")}}}),BetaJS.Stores.RemoteStore.extend("BetaJS.Stores.QueryGetParamsRemoteStore",{constructor:function(t,e,i,r){this._inherited(BetaJS.Stores.QueryGetParamsRemoteStore,"constructor",t,e,r),this.__capability_params=i},_query_capabilities:function(){var t={};return"skip"in this.__capability_params&&(t.skip=!0),"limit"in this.__capability_params&&(t.limit=!0),t},_encode_query:function(t,e){e=e||{};var i=this.getUri()+"?";return e.skip&&"skip"in this.__capability_params&&(i+=this.__capability_params.skip+"="+e.skip+"&"),e.limit&&"limit"in this.__capability_params&&(i+=this.__capability_params.limit+"="+e.limit+"&"),{uri:i}}}),BetaJS.Stores.BaseStore.extend("BetaJS.Stores.ConversionStore",{constructor:function(t,e){e=e||{},e.id_key=t._id_key,this._inherited(BetaJS.Stores.ConversionStore,"constructor",e),this.__store=t,this.__key_encoding=e.key_encoding||{},this.__key_decoding=e.key_decoding||{},this.__value_encoding=e.value_encoding||{},this.__value_decoding=e.value_decoding||{}},encode_object:function(t){var e={};for(var i in t)e[this.encode_key(i)]=this.encode_value(i,t[i]);return e},decode_object:function(t){var e={};for(var i in t)e[this.decode_key(i)]=this.decode_value(i,t[i]);return e},encode_key:function(t){return t in this.__key_encoding?this.__key_encoding[t]:t},decode_key:function(t){return t in this.__key_decoding?this.__key_decoding[t]:t},encode_value:function(t,e){return t in this.__value_encoding?this.__value_encoding[t](e):e},decode_value:function(t,e){return t in this.__value_decoding?this.__value_decoding[t](e):e},_insert:function(t){return this.decode_object(this.__store.insert(this.encode_object(t)))},_remove:function(t){return this.__store.remove(this.encode_value(this._id_key,t))},_get:function(t){return this.decode_object(this.__store.get(this.encode_value(this._id_key,t)))},_update:function(t,e){return this.decode_object(this.__store.update(this.encode_value(this._id_key,t),this.encode_object(e)))},_query_capabilities:function(){return this.__store._query_capabilities()},_query:function(t,e){var i=this,r=this.__store.query(this.encode_object(t),e);return new BetaJS.Iterators.MappedIterator(r,function(t){return i.decode_object(t)})}}),BetaJS.Stores.BaseStore.extend("BetaJS.Stores.PassthroughStore",{constructor:function(t,e){this.__store=t,e=e||{},e.id_key=t.id_key(),e.async_read=t.async_read,e.async_write=t.async_write,this._inherited(BetaJS.Stores.PassthroughStore,"constructor",e)},_supports_async_read:function(){return this.__store._supports_async_read()},_supports_async_write:function(){return this.__store._supports_async_read()},_query_capabilities:function(){return this.__store._query_capabilities()},_insert:function(t,e){return this.__store.insert(t,e)},_remove:function(t,e){return this.__store.remove(t,e)},_get:function(t){return this.__store.get(t)},_update:function(t,e,i){return this.__store.update(t,e,i)},_query:function(t,e){return this.__store.query(t,e)}}),BetaJS.Stores.PassthroughStore.extend("BetaJS.Stores.WriteQueueStore",{constructor:function(t,e){this._inherited(BetaJS.Stores.WriteQueueStore,"constructor",t,e),e=e||{},this.__update_queue={},this.__revision_id=1,this.__id_to_queue={},this.__combine_updates="combine_updates"in e?e.combine_updates:!0,this.__auto_clear_updates="auto_clear_updates"in e?e.auto_clear_updates:!0,this.__cache={},this.__auto_clear_updates&&this.on("remove",function(t){this.__remove_update(t)},this)},update:function(t,e,i){return this.__insert_update(t,e),i&&i.success&&i.success(t,e,e),e},__remove_update:function(t){this.__id_to_queue[t],delete this.__id_to_queue[t];for(var e in e)delete this.__update_queue[e];delete this.__cache[t]},__insert_update:function(t,e){if(this.__combine_updates&&this.__id_to_queue[t]){var i={};for(var r in this.__id_to_queue[t])i=BetaJS.Objs.extend(i,this.__update_queue[r].data),delete this.__update_queue[r];i=BetaJS.Objs.extend(i,e),this.__id_to_queue[t]={}}this.__id_to_queue[t]=this.__id_to_queue[t]||{},this.__id_to_queue[t][this.__revision_id]=!0,this.__update_queue[this.__revision_id]={id:t,data:e,revision_id:this.__revision_id},this.__cache[t]=BetaJS.Objs.extend(this.__cache[t]||{},e),this.__revision_id++,this.trigger("queue","update",t,e),this.trigger("queue:update",t,e)},flush:function(t,e){if(e||(e=this.__revision_id),this.async_write()){var i=null,r=this;for(var n in this.__update_queue){i=this.__update_queue[n];break}if(!i)return t&&t.success(),!0;if(i.revision_id>=e)return;this.__store.update(i.id,i.data,{exception:t.exception,success:function(){delete this.__update_queue[i.revision_id],delete this.__id_to_queue[i.id][i.revision_id],r.flush(t,e)}})}else try{BetaJS.Objs.iter(this.__update_queue,function(t){return t.revision_id>=e?!1:(this.__store.update(t.id,t.data),void 0)},this),t&&t.success&&t.success()}catch(s){if(!t||!t.exception)throw s;t.exception(s)}},changed:function(){return!BetaJS.Types.is_empty(this.__update_queue)},get:function(t){var e=this.__store.get(t);return e&&this.__cache[t]?BetaJS.Objs.extend(e,this.__cache[t]):e},query:function(t,e){var i=this;return new BetaJS.Iterators.MappedIterator(this.__store.query(t,e),function(t){return i.__cache[t[i.id_key()]]?BetaJS.Objs.extend(t,i.__cache[t[i.id_key()]]):t})}}),BetaJS.Class.extend("BetaJS.Stores.WriteQueueStoreManager",[BetaJS.Events.EventsMixin,{constructor:function(t){this._inherited(BetaJS.Stores.WriteQueueStoreManager,"constructor"),t=t||{},this.__stores={},this.__changed=!1,this.__min_delay=t.min_delay?t.min_delay:null,this.__max_delay=t.max_delay?t.max_delay:null,(this.__min_delay||this.__max_delay)&&this.on("changed",function(){this.flush()},this,{min_delay:this.__min_delay,max_delay:this.__max_delay})},destroy:function(){this.off(null,null,this),BetaJS.Objs.iter(this.__stores,function(t){this.unregister(t)},this),this._inherited(BetaJS.Stores.WriteQueueStoreManager,"destroy")},__get:function(t){return t},register:function(t){t=this.__get(t),this.__stores[BetaJS.Ids.objectId(t)]=t,t.on("queue:update",function(){this.__changed=!0,this.trigger("changed")
},this)},unregister:function(t){t=this.__get(t),delete this.__stores[BetaJS.Ids.objectId(t)],t.off(null,null,this)},flush:function(t){this.trigger("flush_start"),this.trigger("flush");var e=0,i=BetaJS.Objs.count(this.__stores),r=this;BetaJS.Objs.iter(this.__stores,function(n){n.flush({exception:function(e){if(r.trigger("flush_error"),!t||!t.exception)throw e;t.exception(e)},success:function(){e++,e==i&&(r.trigger("flush_end"),t&&t.success&&t.success())}})},this),this.__changed=!1,BetaJS.Objs.iter(this.__stores,function(t){this.__changed=this.__changed||t.changed()},this)}}]);