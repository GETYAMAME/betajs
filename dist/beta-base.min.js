/*! betajs - v0.0.2 - 2014-09-25, Copyright (c) Oliver Friedmann & Victor Lingenthal, MIT Software License. */var BetaJS=BetaJS||{};"undefined"!=typeof module&&"exports"in module&&(module.exports=BetaJS),BetaJS.Types={is_object:function(t){return"object"==typeof t},is_array:function(t){return"[object Array]"===Object.prototype.toString.call(t)},is_undefined:function(t){return t===void 0},is_null:function(t){return null===t},is_none:function(t){return this.is_undefined(t)||this.is_null(t)},is_defined:function(t){return t!==void 0},is_empty:function(t){if(this.is_none(t))return!0;if(this.is_array(t))return 0===t.length;if(this.is_object(t)){for(var e in t)return!1;return!0}return!1},is_string:function(t){return"string"==typeof t},is_function:function(t){return"function"==typeof t},is_boolean:function(t){return"boolean"==typeof t},compare:function(t,e){if(BetaJS.Types.is_boolean(t)&&BetaJS.Types.is_boolean(e))return t==e?0:t?1:-1;if(BetaJS.Types.is_array(t)&&BetaJS.Types.is_array(e)){for(var s=t.length,i=e.length,n=Math.min(s,i),r=0;n>r;++r){var a=this.compare(t[r],e[r]);if(0!==a)return a}return s==i?0:s>i?1:-1}return t.localeCompare(e)},parseBool:function(t){return this.is_boolean(t)?t:"true"==t?!0:"false"==t?!1:null},type_of:function(t){return this.is_array(t)?"array":typeof t}},BetaJS.Strings={nl2br:function(t){return(t+"").replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,"$1<br />$2")},htmlentities:function(t){return(t+"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;")},JS_ESCAPES:{"'":"'","\\":"\\","\r":"r","\n":"n","	":"t","\u2028":"u2028","\u2029":"u2029"},JS_ESCAPER_REGEX:function(){return this.JS_ESCAPER_REGEX_CACHED||(this.JS_ESCAPER_REGEX_CACHED=RegExp(BetaJS.Objs.keys(this.JS_ESCAPES).join("|"),"g")),this.JS_ESCAPER_REGEX_CACHED},js_escape:function(t){var e=this;return t.replace(this.JS_ESCAPER_REGEX(),function(t){return"\\"+e.JS_ESCAPES[t]})},starts_with:function(t,e){return t.substring(0,e.length)==e},ends_with:function(t,e){return-1!==t.indexOf(e,t.length-e.length)},strip_start:function(t,e){return this.starts_with(t,e)?t.substring(e.length):t},last_after:function(t,e){return t.substring(t.lastIndexOf(e)+e.length,t.length)},EMAIL_ADDRESS_REGEX:/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/,is_email_address:function(t){return this.EMAIL_ADDRESS_REGEX.test(t)},STRIP_HTML_TAGS:["script","style","head"],STRIP_HTML_REGEX:/<\/?([a-z][a-z0-9]*)\b[^>]*>?/gi,STRIP_HTML_COMMENT_REGEX:/<![^>]*>/gi,strip_html:function(t){var e=t;for(i=0;this.STRIP_HTML_TAGS.length>i;++i)e=e.replace(RegExp("<"+this.STRIP_HTML_TAGS[i]+".*</"+this.STRIP_HTML_TAGS[i]+">","i"),"");return e=e.replace(this.STRIP_HTML_REGEX,"").replace(this.STRIP_HTML_COMMENT_REGEX,"")},nltrim:function(t){var e=t.replace(/\t/g,"  ").split("\n"),s=null,i=0;for(i=0;e.length>i;++i){for(var n=0;e[i].length>n&&" "==e[i].charAt(n);)++n;e[i].length>n&&(s=null===s?n:Math.min(n,s))}for(i=0;e.length>i;++i)e[i]=e[i].substring(s);return e.join("\n").trim()},read_cookie_string:function(t,e){var s="; "+t,i=s.split("; "+e+"=");return 2==i.length?i.pop().split(";").shift():null},write_cookie_string:function(t,e,s){var i="; "+t,n=i.split("; "+e+"=");return 2==n.length&&(i=n[0]+n[1].substring(n[1].indexOf(";"))),e+"="+s+i},capitalize:function(t){return t.replace(/\w\S*/g,function(t){return t.charAt(0).toUpperCase()+t.substr(1).toLowerCase()})},email_get_name:function(t){t=t||"";var e=t.split("<");return t=e[0].trim(),!t&&e.length>1&&(e=e[1].split(">"),t=e[0].trim()),t=t.replace(/['"]/g,"").replace(/[\\._@]/g," "),this.capitalize(t)},email_get_email:function(t){t=t||"";var e=t.split("<");return t=e[0].trim(),e.length>1&&(e=e[1].split(">"),t=e[0].trim()),t=t.replace(/'/g,"").replace(/"/g,"").trim()},email_get_salutatory_name:function(t){return t=t||"",this.email_get_name(t).split(" ")[0]}},BetaJS.Functions={as_method:function(t,e){return function(){return t.apply(e,arguments)}},once:function(t){var e=!1,s=!1;return function(){return s?e:(s=!0,e=t.apply(this,arguments),t=null,e)}},getArguments:function(t,e){return Array.prototype.slice.call(t,e||0)},matchArgs:function(t,e){var s=0,i={};for(var n in e)(e[n]===!0||BetaJS.Types.type_of(t[s])==e[n])&&(i[n]=t[s],s++);return i}},BetaJS.SyncAsync={eventually:function(t,e,s){var i=setTimeout(function(){clearTimeout(i),BetaJS.Types.is_array(e)||(s=e,e=[]),t.apply(s||this,e||[])},0)},syncToAsync:function(t,e){var s=BetaJS.Functions.matchArgs(BetaJS.Functions.getArguments(arguments,2),{params:"array",context:"object"});try{t&&t.success&&t.success.call(t.context||this,e.apply(s.context||this,s.params||[]))}catch(i){t&&t.exception&&t.exception.call(t.context||this,i)}},either:function(t,e,s,i){var n=BetaJS.Functions.matchArgs(BetaJS.Functions.getArguments(arguments,4),{params:"array",context:"object"});if(!t||e||t.sync)return this.eitherSync(t,s,n.params,n.context);var r=n.params||[];return r.push(t),i.apply(n.context||this,r),null},eitherSync:function(t,e){var s=BetaJS.Functions.matchArgs(BetaJS.Functions.getArguments(arguments,2),{params:"array",context:"object"}),i=s.context||this,n=s.params||[];return t?(this.syncToAsync(t,e,n,i),null):e.apply(i,n)},SYNC:1,ASYNC:2,ASYNCSINGLE:3,toCallbackType:function(t,e){return e==this.ASYNCSINGLE?function(e,s){var i=e?"exception":"success";i in t&&t[i].call(t.context||this,e?e:s)}:t},then:function(){var t=BetaJS.Functions.matchArgs(arguments,{func_ctx:"object",func:!0,params:"array",type:"number",callbacks:!0,success_ctx:"object",success:"function",exception:"function"}),e=t.func_ctx||this,s=t.func,i=t.params||[],n=t.callbacks,r=t.type||(!n||n.sync?this.SYNC:this.ASYNC),a=t.success_ctx||e,o=t.success,_=t.exception;if(r!=this.SYNC)i.push(this.toCallbackType({context:n.context,success:o?function(t){o.call(a,t,n)}:n.success,exception:_?function(t){_.call(a,t,n)}:n.exception},r)),s.apply(e,i);else if(n)try{o?o.call(a,s.apply(e,i),n):n.success.call(n.context||this,s.apply(e,i))}catch(c){if(_)_.call(a,c,n);else{if(!n.exception)throw c;n.exception.call(n.context||this,c)}}else try{var h=s.apply(e,i);return o&&o.call(a,h,{sync:!0,success:function(t){h=t},exception:function(t){throw t}}),h}catch(c){if(_)return _.call(a,c,{sync:!0,success:function(t){h=t},exception:function(t){throw t}}),h;throw c}return null},PROMISE_LAZY:1,PROMISE_ACTIVE:2,PROMISE_SUCCESS:3,PROMISE_EXCEPTION:4,lazy:function(){var t=BetaJS.Functions.matchArgs(arguments,{func_ctx:"object",func:!0,params:"array",type:"number"});return{state:this.PROMISE_LAZY,func_ctx:t.func_ctx||this,func:t.func,params:t.params||[],type:t.type||this.ASYNC}},promise:function(){var t=BetaJS.Functions.matchArgs(arguments,{func_ctx:"object",func:!0,params:"array",type:"number"}),e=t.func_ctx||this,s=t.func,i=t.params||[],n=t.type||this.ASYNC;if(n!=this.SYNC){var r={state:this.PROMISE_ACTIVE,listeners:[]};return i.push({context:r,success:function(t){this.state=BetaJS.SyncAsync.PROMISE_SUCCESS,this.result=t;for(var e=0;this.listeners.length>e;++e)this.listeners[e].success.call(this.listeners[e].context||this,t)},exception:function(t){this.state=BetaJS.SyncAsync.PROMISE_EXCEPTION,this.exception=t;for(var e=0;this.listeners.length>e;++e)this.listeners[e].exception.call(this.listeners[e].context||this,t)}}),s.apply(e,i),r}try{return{state:this.PROMISE_SUCCESS,result:s.apply(e,i)}}catch(a){return{state:this.PROMISE_EXCEPTION,exception:a}}},reveal:function(t,e){if(t.state==this.PROMISE_LAZY){var s=this.promise(t.func_ctx,t.func,t.params,t.type);for(var i in s)t[i]=s[i]}t.state==this.PROMISE_ACTIVE?t.listeners.push(e):t.state==this.PROMISE_SUCCESS?e.success.call(e.context||this,t.result):t.state==this.PROMISE_EXCEPTION&&e.exception.call(e.context||this,t.exception)},join:function(t,e){for(var s={count:t.length,exception:!1,results:[]},i=0;t.length>i;++i)s.results.push(null),this.reveal(t[i],{context:{monitor:s,index:i},sync:e&&e.sync,success:function(t){this.monitor.count=this.monitor.count-1,this.monitor.exception||(this.monitor.results[this.index]=t,0>=this.monitor.count&&e&&e.success.apply(e.context||this,this.monitor.results))},exception:function(t){if(this.monitor.count=this.monitor.count-1,!this.monitor.exception){if(this.monitor.exception=!0,!e)throw t;e.exception.apply(e.context||this,t)}}});return s.results},mapSuccess:function(t,e){var s=BetaJS.Objs.clone(t,1);return s.success=e,s},mapException:function(t,e){var s=BetaJS.Objs.clone(t,1);return s.exception=e,s},callback:function(t,e){if(t&&("success"==e||"exception"==e)){var s=t.context||this,i=BetaJS.Functions.getArguments(arguments,2);e in t&&t[e].apply(s,i),"complete"in t&&t.complete.apply(s)}}},BetaJS.SyncAsync.SyncAsyncMixin={supportsSync:function(){return this._supportsSync},supportsAsync:function(){return this._supportsAsync},eitherSync:function(t,e,s){return BetaJS.SyncAsync.eitherSync(t,e,s||[],this)},either:function(t,e,s,i,n){return BetaJS.Types.is_undefined(i)&&(i=!this.supportsAsync()),BetaJS.SyncAsync.either(t,i,e,s,n||[],this)},eitherSyncFactory:function(t,e,s,i){return BetaJS.SyncAsync.eitherSync(e,function(){return this[t]||(this[t]=s.apply(this,i)),this[t]},this)},eitherAsyncFactory:function(t,e,s){var i=this;return this.either(e,function(){return i[t]},function(){s.call(this,BetaJS.SyncAsync.mapSuccess(e,function(s){i[t]=s,i.callback(e,"success",s)}))},t in this,this)},eitherFactory:function(t,e,s,i,n){var r=this;return this.either(e,function(){return this[t]||(this[t]=s.apply(this,n)),this[t]},function(){i.call(this,BetaJS.SyncAsync.mapSuccess(e,function(s){r[t]=s,e.success.call(this,s)}))},this[t]||!this.supportsAsync())},then:function(){var t=BetaJS.Functions.matchArgs(arguments,{func_ctx:"object",func:!0,params:"array",type:"number",callbacks:!0,success_ctx:"object",success:!0,exception:"function"}),e=t.func_ctx||this,s=t.func,i=t.params||[],n=t.callbacks,r=t.type||(n&&this.supportsAsync()?BetaJS.SyncAsync.ASYNC:BetaJS.SyncAsync.SYNC),a=t.success_ctx||this;return BetaJS.SyncAsync.then(e,s,i,r,n,a,t.success,t.exception)},thenSingle:function(){var t=BetaJS.Functions.matchArgs(arguments,{func_ctx:"object",func:!0,params:"array",type:"number",callbacks:!0,success_ctx:"object",success:!0}),e=t.func_ctx||this,s=t.func,i=t.params||[],n=t.callbacks,r=t.type||(n&&this.supportsAsync()?BetaJS.SyncAsync.ASYNCSINGLE:BetaJS.SyncAsync.SYNC),a=t.success_ctx||this,o=t.success;return BetaJS.SyncAsync.then(e,s,i,r,n,a,o)},promise:function(){var t=BetaJS.Functions.matchArgs(arguments,{func_ctx:"object",func:!0,params:"array",type:"number"});return BetaJS.SyncAsync.promise(t.func_ctx||this,t.func,t.params||[],t.type)},join:function(t,e){return BetaJS.SyncAsync.join(t,e)},delegate:function(){var t=BetaJS.Functions.matchArgs(arguments,{func_ctx:"object",func:!0,params:"array",callbacks:"object"}),e=t.func_ctx||this,s=t.params||[];return t.callbacks?this.supportsAsync()&&!t.callbacks.sync?(s.push(t.callbacks),t.func.apply(e,s)):BetaJS.SyncAsync.syncToAsync(t.callbacks,t.func,s,e):t.func.apply(e,s)},callback:function(){return BetaJS.SyncAsync.callback.apply(this,arguments)}},BetaJS.Scopes={base:function(t,e,s){if(!BetaJS.Types.is_string(t))return t;if(e)return e[t];try{if(window&&window[t])return window[t]}catch(i){}try{if(global&&global[t])return global[t]}catch(i){}try{if(module&&module.exports)return module.exports}catch(i){}if(!s)return null;try{if(window)return window[t]={},window[t]}catch(i){}try{if(global)return global[t]={},global[t]}catch(i){}try{if(module&&module.exports)return module.exports={},module.exports}catch(i){}return null},resolve:function(t,e){if(!BetaJS.Types.is_string(t))return t;for(var s=t.split("."),i=this.base(s[0],e),n=1;s.length>n;++n)i=i[s[n]];return i},touch:function(t,e){if(!BetaJS.Types.is_string(t))return t;for(var s=t.split("."),i=this.base(s[0],e,!0),n=1;s.length>n;++n)s[n]in i||(i[s[n]]={}),i=i[s[n]];return i},set:function(t,e,s){if(!BetaJS.Types.is_string(e))return e;for(var i=e.split("."),n=this.base(i[0],s,!0),r=1;i.length-1>r;++r)i[r]in n||(n[i[r]]={}),n=n[i[r]];return i.length>1&&(n[i[i.length-1]]=t),t}},BetaJS.Ids={__uniqueId:0,uniqueId:function(t){return(t||"")+this.__uniqueId++},objectId:function(t,e){return e!==void 0?t.__cid=e:t.__cid||(t.__cid=this.uniqueId("cid_")),t.__cid}},BetaJS.Tokens={generate_token:function(t){t=t||16;for(var e="";t>e.length;)e+=Math.random().toString(36).substr(2);return e.substr(0,t)}},BetaJS.Objs={count:function(t){if(BetaJS.Types.is_array(t))return t.length;var e=0;for(var s in t)e++;return e},clone:function(t,e){return!e||0>=e?t:BetaJS.Types.is_array(t)?t.slice(0):BetaJS.Types.is_object(t)?this.extend({},t,e-1):t},acyclic_clone:function(t,e){if(null===t||!BetaJS.Types.is_object(t))return t;var s="__acyclic_cloned";if(t[s])return e||"CYCLE";t[s]=!0;var i={};for(var n in t)n!=s&&(i[n]=this.acyclic_clone(t[n],e));return delete t[s],i},extend:function(t,e,s){if(t=t||{},e)for(var i in e)t[i]=this.clone(e[i],s);return t},tree_extend:function(t,e,s){if(t=t||{},e)for(var i in e)t[i]=i in t&&BetaJS.Types.is_object(t[i])&&BetaJS.Types.is_object(e[i])?this.tree_extend(t[i],e[i],s):this.clone(e[i],s);return t},merge:function(t,e,s){t=t||{},e=e||{};var i={},n=BetaJS.Objs.extend(BetaJS.Objs.keys(t,!0),BetaJS.Objs.keys(e,!0));for(var r in n){var a=r in s?s[r]:"primary";"primary"==a||"secondary"==a?(r in e||r in t)&&(i[r]="primary"==a?r in e?e[r]:t[r]:r in t?t[r]:e[r]):BetaJS.Types.is_function(a)?i[r]=a(t[r],e[r]):BetaJS.Types.is_object(a)&&(i[r]=BetaJS.Objs.merge(t[r],e[r],a))}return i},tree_merge:function(t,e){t=t||{},e=e||{};var s={},i=BetaJS.Objs.extend(BetaJS.Objs.keys(t,!0),BetaJS.Objs.keys(e,!0));for(var n in i)s[n]=BetaJS.Types.is_object(e[n])&&t[n]?BetaJS.Objs.tree_merge(t[n],e[n]):n in e?e[n]:t[n];return s},keys:function(t,e){var s=null,i=null;if(BetaJS.Types.is_undefined(e)){s=[];for(i in t)s.push(i);return s}s={};for(i in t)s[i]=e;return s},map:function(t,e,s){var i=null;if(BetaJS.Types.is_array(t)){i=[];for(var n=0;t.length>n;++n)i.push(s?e.apply(s,[t[n],n]):e(t[n],n));return i}i={};for(var r in t)i[r]=s?e.apply(s,[t[r],r]):e(t[r],r);return i},values:function(t){var e=[];for(var s in t)e.push(t[s]);return e},filter:function(t,e,s){var i=null;if(BetaJS.Types.is_array(t)){i=[];for(var n=0;t.length>n;++n)(s?e.apply(s,[t[n],n]):e(t[n],n))&&i.push(t[n]);return i}i={};for(var r in t)(s?e.apply(s,[t[r],r]):e(t[r],r))&&(i[r]=t[r]);return i},equals:function(t,e,s){var i=null;if(s&&s>0){for(i in t)if(!i in e||!this.equals(t[i],e[i],s-1))return!1;for(i in e)if(!i in t)return!1;return!0}return t==e},iter:function(t,e,s){var i=null;if(BetaJS.Types.is_array(t)){for(var n=0;t.length>n;++n)if(i=s?e.apply(s,[t[n],n]):e(t[n],n),BetaJS.Types.is_defined(i)&&!i)return!1}else for(var r in t)if(i=s?e.apply(s,[t[r],r]):e(t[r],r),BetaJS.Types.is_defined(i)&&!i)return!1;return!0},intersect:function(t,e){var s={};for(var i in t)i in e&&(s[i]=t[i]);return s},contains_key:function(t,e){return BetaJS.Types.is_array(t)?BetaJS.Types.is_defined(t[e]):e in t},contains_value:function(t,e){if(BetaJS.Types.is_array(t)){for(var s=0;t.length>s;++s)if(t[s]===e)return!0}else for(var i in t)if(t[i]===e)return!0;return!1},exists:function(t,e,s){var i=!1;return BetaJS.Objs.iter(t,function(){return i=i||e.apply(this,arguments),!i},s),i},all:function(t,e,s){var i=!0;return BetaJS.Objs.iter(t,function(){return i=i&&e.apply(this,arguments)},s),i},objectify:function(t,e,s){var i={},n=BetaJS.Types.is_function(e);BetaJS.Types.is_undefined(e)&&(e=!0);for(var r=0;t.length>r;++r)i[t[r]]=n?e.apply(s||this,[t[r],r]):e;return i},peek:function(t){if(BetaJS.Types.is_array(t))return t.length>0?t[0]:null;for(var e in t)return t[e];return null},poll:function(t){if(BetaJS.Types.is_array(t))return t.shift();for(var e in t){var s=t[e];return delete t[e],s}return null},objectBy:function(){for(var t={},e=arguments.length/2,s=0;e>s;++s)t[arguments[2*s]]=arguments[2*s+1];return t},valueByIndex:function(t,e){if(e=e||0,BetaJS.Types.is_array(t))return t[e];for(var s in t){if(0===e)return t[s];e--}return null},keyByIndex:function(t,e){if(e=e||0,BetaJS.Types.is_array(t))return e;for(var s in t){if(0===e)return s;e--}return null}},BetaJS.Class=function(){},BetaJS.Class.classname="Class",BetaJS.Class.extend=function(t,e,s,i){e=e||[],BetaJS.Types.is_array(e)||(e=[e]),s=s||[],BetaJS.Types.is_array(s)||(s=[s]),i=i||[],BetaJS.Types.is_array(i)||(i=[i]);var n,r=this;BetaJS.Objs.iter(e,function(t){t.hasOwnProperty("constructor")&&(n=t.constructor)});var a=BetaJS.Types.is_defined(n);BetaJS.Types.is_defined(n)||(n=function(){r.apply(this,arguments)}),BetaJS.Objs.extend(n,r),BetaJS.Objs.iter(s,function(t){BetaJS.Objs.extend(n,t)});var o={};if(r.__class_statics_keys)for(var _ in r.__class_statics_keys)n[_]=BetaJS.Objs.clone(r[_],1);BetaJS.Objs.iter(i,function(t){BetaJS.Objs.extend(n,t),BetaJS.Objs.extend(o,BetaJS.Objs.keys(t,!0))}),r.__class_statics_keys&&BetaJS.Objs.extend(o,r.__class_statics_keys),n.__class_statics_keys=o,n.parent=r,n.children=[],n.extend=this.extend,r.children||(r.children=[]),r.children.push(n);var c=function(){};return c.prototype=r.prototype,n.prototype=new c,n.prototype.cls=n,n.classname=t,t&&BetaJS.Scopes.set(n,t),n.__notifications={},r.__notifications&&BetaJS.Objs.extend(n.__notifications,r.__notifications,1),BetaJS.Objs.iter(e,function(t){if(BetaJS.Objs.extend(n.prototype,t),"constructor"in t&&(n.prototype.constructor=t.constructor),t._notifications)for(var e in t._notifications)n.__notifications[e]||(n.__notifications[e]=[]),n.__notifications[e].push(t._notifications[e])}),delete n.prototype._notifications,a||(n.prototype.constructor=r.prototype.constructor),n},BetaJS.Class.prototype.constructor=function(){this._notify("construct")},BetaJS.Class.prototype.as_method=function(t){return BetaJS.Functions.as_method(this[t],this)},BetaJS.Class.prototype._auto_destroy=function(t){this.__auto_destroy_list||(this.__auto_destroy_list=[]);var e=t;BetaJS.Types.is_array(e)||(e=[e]);for(var s=0;e.length>s;++s)this.__auto_destroy_list.push(e[s]);return t},BetaJS.Class.prototype._notify=function(t){if(this.cls.__notifications){var e=Array.prototype.slice.call(arguments,1),s=this.cls.__notifications[t];if(s)for(var i in s){var n=BetaJS.Types.is_function(s[i])?s[i]:this[s[i]];if(!n)throw this.cls.classname+": Could not find "+t+" notification handler "+s[i];n.apply(this,e)}}},BetaJS.Class.prototype.destroy=function(){if(this._notify("destroy"),this.__auto_destroy_list)for(var t=0;this.__auto_destroy_list.length>t;++t)"destroy"in this.__auto_destroy_list[t]&&this.__auto_destroy_list[t].destroy();for(var e in this)delete this[e]},BetaJS.Class.prototype._inherited=function(t,e){return t.parent.prototype[e].apply(this,Array.prototype.slice.apply(arguments,[2]))},BetaJS.Class._inherited=function(t,e){return t.parent[e].apply(this,Array.prototype.slice.apply(arguments,[2]))},BetaJS.Class.prototype.instance_of=function(t){return this.cls.ancestor_of(t)},BetaJS.Class.ancestor_of=function(t){return this==t||this!=BetaJS.Class&&this.parent.ancestor_of(t)},BetaJS.Class.prototype.cid=function(){return BetaJS.Ids.objectId(this)},BetaJS.Class.prototype.cls=BetaJS.Class,BetaJS.Class.__notifications={},BetaJS.Class.is_class_instance=function(t){return t&&BetaJS.Types.is_object(t)&&"_inherited"in t&&"cls"in t},BetaJS.Exceptions={ensure:function(t){return t&&BetaJS.Types.is_object(t)&&"instance_of"in t&&t.instance_of(BetaJS.Exceptions.Exception)?t:new BetaJS.Exceptions.NativeException(t)}},BetaJS.Class.extend("BetaJS.Exceptions.Exception",{constructor:function(t){this._inherited(BetaJS.Exceptions.Exception,"constructor"),this.__message=t},assert:function(t){if(!this.instance_of(t))throw this;return this},callstack:function(){for(var t=[],e=arguments.callee.caller;e;)t.push(""+e),e=e.caller;return t},callstack_to_string:function(){return this.callstack().join("\n")},message:function(){return this.__message},toString:function(){return this.message()},format:function(){return this.cls.classname+": "+(""+this)+"\n\nCall Stack:\n"+this.callstack_to_string()},json:function(){return{classname:this.cls.classname,message:this.message()}}},{ensure:function(t){return t=BetaJS.Exceptions.ensure(t),t.assert(this),t}}),BetaJS.Exceptions.Exception.extend("BetaJS.Exceptions.NativeException",{constructor:function(t){this._inherited(BetaJS.Exceptions.NativeException,"constructor",t?"toString"in t?""+t:t:"null"),this.__object=t},object:function(){return this.__object}}),BetaJS.Class.extend("BetaJS.Lists.AbstractList",{_add:function(){},_remove:function(){},_get:function(){},_iterate:function(){},get_ident:function(t){var e=null;return this._iterate(function(s,i){return s==t?(e=i,!1):!0}),e},exists:function(t){return t&&null!==this.get_ident(t)},_ident_changed:function(){},constructor:function(t){this._inherited(BetaJS.Lists.AbstractList,"constructor"),this.__count=0,t&&BetaJS.Objs.iter(t,function(t){this.add(t)},this)},add:function(t){var e=this._add(t);return BetaJS.Types.is_defined(e)&&this.__count++,e},count:function(){return this.__count},clear:function(){this._iterate(function(t,e){return this.remove_by_ident(e),!0},this)},remove_by_ident:function(t){var e=this._remove(t);return BetaJS.Types.is_defined(e)&&this.__count--,e},remove:function(t){return this.remove_by_ident(this.get_ident(t))},remove_by_filter:function(t){this._iterate(function(e,s){return t(e)&&this.remove_by_ident(s),!0},this)},get:function(t){return this._get(t)},iterate:function(t,e){this._iterate(function(e,s){var i=t.apply(this,[e,s]);return BetaJS.Types.is_defined(i)?i:!0},e)},iterator:function(){return BetaJS.Iterators.ArrayIterator.byIterate(this.iterate,this)}}),BetaJS.Lists.AbstractList.extend("BetaJS.Lists.LinkedList",{constructor:function(t){this.__first=null,this.__last=null,this._inherited(BetaJS.Lists.LinkedList,"constructor",t)},_add:function(t){return this.__last={obj:t,prev:this.__last,next:null},this.__first?this.__last.prev.next=this.__last:this.__first=this.__last,this.__last},_remove:function(t){return t.next?t.next.prev=t.prev:this.__last=t.prev,t.prev?t.prev.next=t.next:this.__first=t.next,t.obj},_get:function(t){return t.obj},_iterate:function(t,e){for(var s=this.__first;s;){var i=s;if(s=s.next,!t.apply(e||this,[i.obj,i]))return}}}),BetaJS.Lists.AbstractList.extend("BetaJS.Lists.ObjectIdList",{constructor:function(t,e){this.__map={},this.__id_generator=e,this._inherited(BetaJS.Lists.ObjectIdList,"constructor",t)},_add:function(t){for(;;){var e=t.__cid;if(e||(e=this.__id_generator?BetaJS.Ids.objectId(t,this.__id_generator()):BetaJS.Ids.objectId(t),!this.__map[e]||!this.__id_generator))return this.__map[e]=t,e}return null},_remove:function(t){var e=this.__map[t];return delete this.__map[t],e},_get:function(t){return this.__map[t]},_iterate:function(t,e){for(var s in this.__map)t.apply(e||this,[this.__map[s],s])},get_ident:function(t){var e=BetaJS.Ids.objectId(t);return this.__map[e]?e:null}}),BetaJS.Lists.AbstractList.extend("BetaJS.Lists.ArrayList",{constructor:function(t,e){this.__idToIndex={},this.__items=[],e=e||{},"compare"in e&&(this._compare=e.compare),this._inherited(BetaJS.Lists.ArrayList,"constructor",t)},set_compare:function(t){this._compare=t,t&&this.sort()},get_compare:function(){return this._compare},sort:function(t){if(t=t||this._compare){this.__items.sort(t);for(var e=0;this.__items.length>e;++e)this.__ident_changed(this.__items[e],e);this._sorted()}},_sorted:function(){},re_index:function(t){if(!this._compare)return t;for(var e=this.__items.length-1,s=this.__items[t],i=t;e>i&&this._compare(this.__items[i],this.__items[i+1])>0;)this.__items[i]=this.__items[i+1],this.__ident_changed(this.__items[i],i),this.__items[i+1]=s,++i;if(i==t)for(;i>0&&0>this._compare(this.__items[i],this.__items[i-1]);)this.__items[i]=this.__items[i-1],this.__ident_changed(this.__items[i],i),this.__items[i-1]=s,--i;return i!=t&&(this.__ident_changed(s,i),this._re_indexed(s)),i},_re_indexed:function(){},_add:function(t){var e=this.__items.length;this.__items.push(t);var s=this.re_index(e);return this.__idToIndex[BetaJS.Ids.objectId(t)]=s,s},_remove:function(t){for(var e=this.__items[t],s=t+1;this.__items.length>s;++s)this.__items[s-1]=this.__items[s],this.__ident_changed(this.__items[s-1],s-1);return this.__items.pop(),delete this.__idToIndex[BetaJS.Ids.objectId(e)],e},_get:function(t){return this.__items[t]},_iterate:function(t,e){for(var s=BetaJS.Objs.clone(this.__items,1),i=0;s.length>i;++i)t.apply(e||this,[s[i],this.get_ident(s[i])])},__ident_changed:function(t,e){this.__idToIndex[BetaJS.Ids.objectId(t)]=e,this._ident_changed(t,e)},get_ident:function(t){var e=BetaJS.Ids.objectId(t);return e in this.__idToIndex?this.__idToIndex[e]:null},ident_by_id:function(t){return this.__idToIndex[t]}}),BetaJS.Iterators={ensure:function(t){return null===t?new BetaJS.Iterators.ArrayIterator([]):t.instance_of(BetaJS.Iterators.Iterator)?t:BetaJS.Types.is_array(t)?new BetaJS.Iterators.ArrayIterator(t):new BetaJS.Iterators.ArrayIterator([t])}},BetaJS.Class.extend("BetaJS.Iterators.Iterator",{asArray:function(){for(var t=[];this.hasNext();)t.push(this.next());return t},asArrayDelegate:function(t){for(var e=[];this.hasNext();){var s=this.next();e.push(s[t].apply(s,BetaJS.Functions.getArguments(arguments,1)))}return e},iterate:function(t,e){for(;this.hasNext();)t.call(e||this,this.next())}}),BetaJS.Iterators.Iterator.extend("BetaJS.Iterators.ArrayIterator",{constructor:function(t){this._inherited(BetaJS.Iterators.ArrayIterator,"constructor"),this.__array=t,this.__i=0},hasNext:function(){return this.__i<this.__array.length},next:function(){var t=this.__array[this.__i];return this.__i++,t}},{byIterate:function(t,e){var s=[];return t.call(e||this,function(t){s.push(t)},this),new this(s)}}),BetaJS.Iterators.ArrayIterator.extend("BetaJS.Iterators.ObjectKeysIterator",{constructor:function(t){this._inherited(BetaJS.Iterators.ObjectKeysIterator,"constructor",BetaJS.Objs.keys(t))}}),BetaJS.Iterators.ArrayIterator.extend("BetaJS.Iterators.ObjectValuesIterator",{constructor:function(t){this._inherited(BetaJS.Iterators.ObjectValuesIterator,"constructor",BetaJS.Objs.values(t))}}),BetaJS.Iterators.Iterator.extend("BetaJS.Iterators.MappedIterator",{constructor:function(t,e,s){this._inherited(BetaJS.Iterators.MappedIterator,"constructor"),this.__iterator=t,this.__map=e,this.__context=s||this},hasNext:function(){return this.__iterator.hasNext()},next:function(){return this.hasNext()?this.__map.call(this.__context,this.__iterator.next()):null}}),BetaJS.Iterators.Iterator.extend("BetaJS.Iterators.FilteredIterator",{constructor:function(t,e,s){this._inherited(BetaJS.Iterators.FilteredIterator,"constructor"),this.__iterator=t,this.__filter=e,this.__context=s||this,this.__next=null},hasNext:function(){return this.__crawl(),null!==this.__next},next:function(){this.__crawl();var t=this.__next;return this.__next=null,t},__crawl:function(){for(;!this.__next&&this.__iterator.hasNext();){var t=this.__iterator.next();this.__filter_func(t)&&(this.__next=t)}},__filter_func:function(t){return this.__filter.apply(this.__context,[t])}}),BetaJS.Iterators.Iterator.extend("BetaJS.Iterators.SkipIterator",{constructor:function(t,e){for(this._inherited(BetaJS.Iterators.SkipIterator,"constructor"),this.__iterator=t;e>0;)t.next(),e--},hasNext:function(){return this.__iterator.hasNext()},next:function(){return this.__iterator.next()}}),BetaJS.Iterators.Iterator.extend("BetaJS.Iterators.LimitIterator",{constructor:function(t,e){this._inherited(BetaJS.Iterators.LimitIterator,"constructor"),this.__iterator=t,this.__limit=e},hasNext:function(){return this.__limit>0&&this.__iterator.hasNext()},next:function(){return 0>=this.__limit?null:(this.__limit--,this.__iterator.next())}}),BetaJS.Iterators.Iterator.extend("BetaJS.Iterators.SortedIterator",{constructor:function(t,e){this._inherited(BetaJS.Iterators.SortedIterator,"constructor"),this.__array=t.asArray(),this.__array.sort(e),this.__i=0},hasNext:function(){return this.__i<this.__array.length},next:function(){var t=this.__array[this.__i];return this.__i++,t}}),BetaJS.Events={},BetaJS.Events.EVENT_SPLITTER=/\s+/,BetaJS.Events.EventsMixin={__create_event_object:function(t,e,s){s=s||{};var i={callback:t,context:e};return s.eventually&&(i.eventually=s.eventually),s.min_delay&&(i.min_delay=new BetaJS.Timers.Timer({delay:s.min_delay,once:!0,start:!1,context:this,fire:function(){i.max_delay&&i.max_delay.stop(),i.callback.apply(i.context||this,i.params)}})),s.max_delay&&(i.max_delay=new BetaJS.Timers.Timer({delay:s.max_delay,once:!0,start:!1,context:this,fire:function(){i.min_delay&&i.min_delay.stop(),i.callback.apply(i.context||this,i.params)}})),i},__destroy_event_object:function(t){t.min_delay&&t.min_delay.destroy(),t.max_delay&&t.max_delay.destroy()},__call_event_object:function(t,e){t.min_delay&&t.min_delay.restart(),t.max_delay&&t.max_delay.start(),t.min_delay||t.max_delay?t.params=e:t.eventually?BetaJS.SyncAsync.eventually(t.callback,e,t.context||this):t.callback.apply(t.context||this,e)},on:function(t,e,s,i){this.__events_mixin_events=this.__events_mixin_events||{},t=t.split(BetaJS.Events.EVENT_SPLITTER);for(var n;;){if(n=t.shift(),!n)break;this.__events_mixin_events[n]=this.__events_mixin_events[n]||new BetaJS.Lists.LinkedList,this.__events_mixin_events[n].add(this.__create_event_object(e,s,i))}return this},off:function(t,e,s){if(this.__events_mixin_events=this.__events_mixin_events||{},t){t=t.split(BetaJS.Events.EVENT_SPLITTER);for(var i;;){if(i=t.shift(),!i)break;this.__events_mixin_events[i]&&(this.__events_mixin_events[i].remove_by_filter(function(t){var i=!(e&&t.callback!=e||s&&t.context!=s);return i&&this.__destroy_event_object&&this.__destroy_event_object(t),i}),0===this.__events_mixin_events[i].count()&&(this.__events_mixin_events[i].destroy(),delete this.__events_mixin_events[i]))}}else for(i in this.__events_mixin_events)this.__events_mixin_events[i].remove_by_filter(function(t){var i=!(e&&t.callback!=e||s&&t.context!=s);return i&&this.__destroy_event_object&&this.__destroy_event_object(t),i}),0===this.__events_mixin_events[i].count()&&(this.__events_mixin_events[i].destroy(),delete this.__events_mixin_events[i]);return this},triggerAsync:function(){var t=this,e=BetaJS.Functions.getArguments(arguments),s=setTimeout(function(){clearTimeout(s),t.trigger.apply(t,e)},0)},trigger:function(t){var e=this;t=t.split(BetaJS.Events.EVENT_SPLITTER);var s,i=BetaJS.Functions.getArguments(arguments,1);if(!this.__events_mixin_events)return this;for(;;){if(s=t.shift(),!s)break;this.__events_mixin_events[s]&&this.__events_mixin_events[s].iterate(function(t){e.__call_event_object(t,i)}),this.__events_mixin_events&&"all"in this.__events_mixin_events&&this.__events_mixin_events.all.iterate(function(t){e.__call_event_object(t,[s].concat(i))})}return this},once:function(t,e,s,i){var n=this,r=BetaJS.Functions.once(function(){n.off(t,r),e.apply(this,arguments)});return r._callback=e,this.on(name,r,s,i)},delegateEvents:function(t,e,s,i){i=i||[],s=s?s+":":"",null===t?e.on("all",function(t){var e=BetaJS.Functions.getArguments(arguments,1);this.trigger.apply(this,[s+t].concat(i).concat(e))},this):(BetaJS.Types.is_array(t)||(t=[t]),BetaJS.Objs.iter(t,function(t){e.on(t,function(){var e=BetaJS.Functions.getArguments(arguments);this.trigger.apply(this,[s+t].concat(i).concat(e))},this)},this))}},BetaJS.Class.extend("BetaJS.Events.Events",BetaJS.Events.EventsMixin),BetaJS.Events.ListenMixin={_notifications:{destroy:"listenOff"},listenOn:function(t,e,s,i){this.__listen_mixin_listen||(this.__listen_mixin_listen={}),this.__listen_mixin_listen[BetaJS.Ids.objectId(t)]=t,t.on(e,s,this,i)},listenOnce:function(t,e,s,i){this.__listen_mixin_listen||(this.__listen_mixin_listen={}),this.__listen_mixin_listen[BetaJS.Ids.objectId(t)]=t,t.once(e,s,this,i)},listenOff:function(t,e,s){this.__listen_mixin_listen&&(t?(t.off(e,s,this),e||s||delete this.__listen_mixin_listen[BetaJS.Ids.objectId(t)]):BetaJS.Objs.iter(this.__listen_mixin_listen,function(t){t.off(e,s,this),e||s||delete this.__listen_mixin_listen[BetaJS.Ids.objectId(t)]
},this))}},BetaJS.Class.extend("BetaJS.Events.Listen",BetaJS.Events.ListenMixin),BetaJS.Classes={},BetaJS.Classes.InvokerMixin={invoke_delegate:function(t,e){BetaJS.Types.is_array(e)||(e=[e]),t=this[t];for(var s=this,i=0;e.length>i;++i){var n=e[i];this[n]=function(e){return function(){var i=BetaJS.Functions.getArguments(arguments);return i.unshift(e),t.apply(s,i)}}.call(s,n)}}},BetaJS.Classes.AutoDestroyMixin={_notifications:{construct:"__initialize_auto_destroy",destroy:"__finalize_auto_destroy"},__initialize_auto_destroy:function(){this.__auto_destroy={}},__finalize_auto_destroy:function(){var t=this.__auto_destroy;this.__auto_destroy={},BetaJS.Objs.iter(t,function(t){t.unregister(this)},this)},register_auto_destroy:function(t){t.cid()in this.__auto_destroy||(this.__auto_destroy[t.cid()]=t,t.register(this),this._notify("register_auto_destroy",t))},unregister_auto_destroy:function(t){t.cid()in this.__auto_destroy&&(this._notify("unregister_auto_destroy",t),delete this.__auto_destroy[t.cid()],t.unregister(this),BetaJS.Types.is_empty(this.__auto_destroy)&&this.destroy())}},BetaJS.Class.extend("BetaJS.Classes.AutoDestroyObject",{constructor:function(){this._inherited(BetaJS.Classes.AutoDestroyObject,"constructor"),this.__objects={}},register:function(t){var e=BetaJS.Ids.objectId(t);e in this.__objects||(this.__objects[e]=t,t.register_auto_destroy(this))},unregister:function(t){var e=BetaJS.Ids.objectId(t);e in this.__objects&&(delete this.__objects[e],t.unregister_auto_destroy(this))},clear:function(){BetaJS.Objs.iter(this.__objects,function(t){this.unregister(t)},this)}}),BetaJS.Class.extend("BetaJS.Classes.ObjectCache",[BetaJS.Events.EventsMixin,{constructor:function(t){this._inherited(BetaJS.Classes.ObjectCache,"constructor"),this.__size="size"in t?t.size:null,this.__destroy_on_remove="destroy_on_remove"in t?t.destroy_on_remove:!0,this.__id_to_container={},this.__first=null,this.__last=null,this.__count=0},destroy:function(){this.clear(),this._inherited(BetaJS.Classes.ObjectCache,"destroy")},add:function(t){if(!this.get(t)){null!==this.__size&&this.__count>=this.__size&&this.__first&&this.remove(this.__first.object);var e={object:t,prev:this.__last,next:null};this.__id_to_container[BetaJS.Ids.objectId(t)]=e,this.__first?this.__last.next=e:this.__first=e,this.__last=e,this.__count++,this.trigger("cache",t)}},remove:function(t){BetaJS.Class.is_class_instance(t)&&(t=BetaJS.Ids.objectId(t));var e=this.__id_to_container[t];e&&(delete this.__id_to_container[t],e.next?e.next.prev=e.prev:this.__last=e.prev,e.prev?e.prev.next=e.next:this.__first=e.next,this.__count--,this.trigger("release",e.object),this.__destroy_on_remove&&e.object.destroy())},get:function(t){return BetaJS.Class.is_class_instance(t)&&(t=BetaJS.Ids.objectId(t)),this.__id_to_container[t]?this.__id_to_container[t].object:null},clear:function(){BetaJS.Objs.iter(this.__id_to_container,function(t){this.remove(t.object)},this)}}]),BetaJS.Classes.ModuleMixin={_notifications:{construct:function(){this.__modules={}},destroy:function(){BetaJS.Objs.iter(this.__modules,this.remove_module,this)}},add_module:function(t){t.cid()in this.__modules||(this.__modules[t.cid()]=t,t.register(this),this._notify("add_module",t))},remove_module:function(t){t.cid()in this.__modules&&(delete this.__modules[t.cid()],t.unregister(this),this._notify("remove_module",t))}},BetaJS.Class.extend("BetaJS.Classes.Module",{constructor:function(t){this._inherited(BetaJS.Classes.Module,"constructor"),this._objects={},this.__auto_destroy="auto_destroy"in t?t.auto_destroy:!0},destroy:function(){BetaJS.Objs.iter(this._objects,this.unregister,this),this._inherited(BetaJS.Classes.Module,"destroy")},register:function(t){var e=BetaJS.Ids.objectId(t);if(!(e in this._objects)){var s={};this._objects[e]={object:t,data:s},t.add_module(this),this._register(t,s)}},_register:function(){},unregister:function(t){var e=BetaJS.Ids.objectId(t);if(e in this._objects){var s=this._objects[e].data;this._unregister(t,s),delete this._objects[e],t.remove_module(this),"off"in t&&t.off(null,null,this),this.__auto_destroy&&BetaJS.Types.is_empty(this._objects)&&this.destroy()}},_unregister:function(){},_data:function(t){return this._objects[BetaJS.Ids.objectId(t)].data}},{__instance:null,singleton:function(){return this.__instance||(this.__instance=new this({auto_destroy:!1})),this.__instance}}),BetaJS.Classes.ObjectIdMixin={_notifications:{construct:"__register_object_id",destroy:"__unregister_object_id"},__object_id_scope:function(){return this.object_id_scope?this.object_id_scope:(BetaJS.Classes.ObjectIdScope||(BetaJS.Classes.ObjectIdScope=BetaJS.Objs.clone(BetaJS.Classes.ObjectIdScopeMixin,1)),BetaJS.Classes.ObjectIdScope)},__register_object_id:function(){var t=this.__object_id_scope();t.__objects[BetaJS.Ids.objectId(this)]=this},__unregister_object_id:function(){var t=this.__object_id_scope();delete t.__objects[BetaJS.Ids.objectId(this)]}},BetaJS.Classes.ObjectIdScopeMixin={__objects:{},get:function(t){return this.__objects[t]}},BetaJS.Classes.HelperClassMixin={addHelper:function(t,e){var s=new t(this,e);this.__helpers=this.__helpers||[],this.__helpers.push(this._auto_destroy(s))},_helper:function(t){function e(a){if(a>=n.__helpers.length)return BetaJS.SyncAsync.callback(t.callbacks,"success",i),void 0;if(t.method in n.__helpers[a]){var o=this.__helpers[a];-1==r?(o[t.method].apply(o,s),e(a+1)):(s[r]={context:t.callbacks.context,success:function(s){i=t.fold(i,s),e(a+1)},failure:t.callbacks.failure},o[t.method].apply(o,s))}else e(a+1)}BetaJS.Types.is_string(t)&&(t={method:t}),t=BetaJS.Objs.extend({fold_start:null,fold:function(t,e){return t||e}},t);var s=BetaJS.Functions.getArguments(arguments,1),i=t.fold_start;if(t.callbacks){var n=this,r=-1;for(j=0;s.length>j;++j)s[j]==t.callback&&(r=j);e(0)}else for(var a=0;this.__helpers.length>a;++a){var o=this.__helpers[a];if(t.method in o){var _=o[t.method].apply(o,s);i=t.fold(i,_)}}return i}},BetaJS.Properties={},BetaJS.Properties.TYPE_VALUE=0,BetaJS.Properties.TYPE_BINDING=1,BetaJS.Properties.TYPE_COMPUTED=2,BetaJS.Properties.PropertiesMixin={raw_get:function(t){return t in this.__properties?this.__properties[t].value:null},get:function(t){keys=t.split(".");for(var e=this.raw_get(keys[0]),s=1;keys.length>s;++s){if(!e||!BetaJS.Types.is_object(e))return null;e=e[keys[s]]}return e},_canSet:function(){return!0},_beforeSet:function(t,e){return e},_afterSet:function(){},has:function(t){return t in this.__properties},setAll:function(t,e){for(var s in t)this.set(s,t[s],e)},keys:function(t){return BetaJS.Objs.keys(this.__properties,t)},binding:function(t){return{type:BetaJS.Properties.TYPE_BINDING,bindee:this,property:t}},computed:function(t,e){return{type:BetaJS.Properties.TYPE_COMPUTED,func:t,dependencies:e||[]}},_isBinding:function(t){return BetaJS.Types.is_object(t)&&t&&t.type&&t.type==BetaJS.Properties.TYPE_BINDING&&t.bindee&&t.property},_isComputed:function(t){return BetaJS.Types.is_object(t)&&t&&t.type&&t.type==BetaJS.Properties.TYPE_COMPUTED&&t.func&&t.dependencies},getAll:function(){var t={};for(var e in this.__properties)t[e]=this.get(e);return t},unset:function(t){if(t in this.__properties){var e=this.__properties[t];if(e.type==BetaJS.Properties.TYPE_BINDING)e.bindee.off("change:"+e.property,null,this.__properties[t]);else if(e.type==BetaJS.Properties.TYPE_COMPUTED){var s=this;BetaJS.Objs.iter(e.dependencies,function(i){this._isBinding(i)?i.bindee.off("change:"+i.property,null,this.__properties[t]):this._isTimer(i)?e.timers[i].destroy():s.off("change:"+i,null,this.__properties[t])},this)}this.trigger("unset",t),this.trigger("unset:"+t),delete this.__properties[t]}},_set_changed:function(t,e,s){this._afterSet(t,this.get(t),e,s),this.trigger("change",t,this.get(t),e,s),this.trigger("change:"+t,this.get(t),e,s)},_isTimer:function(){return BetaJS.Strings.starts_with("dep","timer:")},_parseTimer:function(){return parseInt(BetaJS.Strings.strip_start("timer:"),10)},set:function(t,e,s){var i=t.split(".");if(2>i.length)this.raw_set(t,e,s);else{var n=this.raw_get(t,n);n||(n={},this.raw_set(t,n,s));for(var r=2;i.length-1>r;++r)n[i[r]]=n[i[r]]||{},n=n[i[r]];var a=n[i[i.length-1]];n[i[i.length-1]]=e,a!=e&&(this.trigger("change",t,e,a),this.trigger("change:"+t.replace(".","->"),e,a))}},raw_set:function(t,e,s){var i=this.get(t);if(i!=e){var n=this;this.__properties[t],this._isBinding(e)?(this.unset(t),this.__properties[t]={type:BetaJS.Properties.TYPE_BINDING,bindee:e.bindee,property:e.property,value:e.bindee.get(e.property)},e.bindee.on("change:"+e.property,function(){var s=n.__properties[t].value;n.__properties[t].value=e.bindee.get(e.property),n._set_changed(t,s)},this.__properties[t]),this._set_changed(t,i,s)):this._isComputed(e)?(this.unset(t),this.__properties[t]={type:BetaJS.Properties.TYPE_COMPUTED,func:e.func,dependencies:e.dependencies,value:e.func.apply(n),timers:{}},BetaJS.Objs.iter(e.dependencies,function(s){this._isBinding(s)?s.bindee.on("change:"+s.property,function(){var s=n.__properties[t].value;n.__properties[t].value=e.func.apply(n),n._set_changed(t,s)},this.__properties[t]):this._isTimer(s)?this.__properties[t].timers[s]=new BetaJS.Timers.Timer({delay:this._parseTimer(s),fire:function(){var s=n.__properties[t].value;n.__properties[t].value=e.func.apply(n),n._set_changed(t,s)}}):n.on("change:"+s,function(){var s=n.__properties[t].value;n.__properties[t].value=e.func.apply(n),n._set_changed(t,s)},this.__properties[t])},this),this._set_changed(t,i)):(e=this._beforeSet(t,e),this._canSet(t,e)&&(this.__properties[t]&&this.__properties[t].type==BetaJS.Properties.TYPE_BINDING?this.__properties[t].bindee.set(this.__properties[t].property,e):(this.unset(t),this.__properties[t]={type:BetaJS.Properties.TYPE_VALUE,value:e},this._set_changed(t,i,s))))}},_notifications:{construct:"__properties_construct",destroy:"__properties_destroy"},__properties_construct:function(){this.__properties={}},__properties_destroy:function(){for(var t in this.__properties)this.unset(t);this.trigger("destroy")}},BetaJS.Class.extend("BetaJS.Properties.Properties",[BetaJS.Events.EventsMixin,BetaJS.Properties.PropertiesMixin,{constructor:function(t){this._inherited(BetaJS.Properties.Properties,"constructor"),t&&this.setAll(t)}}]),BetaJS.Class.extend("BetaJS.Properties.PropertiesData",{constructor:function(t){this._inherited(BetaJS.Properties.PropertiesData,"constructor"),this.__properties=t,this.data=this.__properties.getAll(),this.__properties.on("change",function(t,e){this.data[t]=e},this),this.__properties.on("unset",function(t){delete this.data[t]},this),this.__properties.on("destroy",function(){this.destroy()},this)},properties:function(){return this.__properties}}),BetaJS.Class.extend("BetaJS.Collections.Collection",[BetaJS.Events.EventsMixin,{constructor:function(t){this._inherited(BetaJS.Collections.Collection,"constructor"),t=t||{};var e={};"compare"in t&&(e.compare=t.compare),this.__data=new BetaJS.Lists.ArrayList([],e);var s=this;this.__data._ident_changed=function(t,e){s._index_changed(t,e)},this.__data._re_indexed=function(t){s._re_indexed(t)},this.__data._sorted=function(){s._sorted()},"objects"in t&&this.add_objects(t.objects)},set_compare:function(t){this.__data.set_compare(t)},get_compare:function(){this.__data.get_compare()},destroy:function(){this.__data.iterate(function(t){"off"in t&&t.off(null,null,this)},this),this.__data.destroy(),this.trigger("destroy"),this._inherited(BetaJS.Collections.Collection,"destroy")},count:function(){return this.__data.count()},_index_changed:function(t,e){this.trigger("index",t,e)},_re_indexed:function(t){this.trigger("reindexed",t)},_sorted:function(){this.trigger("sorted")},_object_changed:function(t,e,s){this.trigger("update"),this.trigger("change",t,e,s),this.trigger("change:"+e,t,s),this.__data.re_index(this.getIndex(t))},add:function(t){if(BetaJS.Class.is_class_instance(t)||(t=new BetaJS.Properties.Properties(t)),this.exists(t))return null;var e=this.__data.add(t);return null!==e&&(this.trigger("add",t),this.trigger("update"),"on"in t&&t.on("change",function(e,s){this._object_changed(t,e,s)},this)),e},add_objects:function(t){var e=0;return BetaJS.Objs.iter(t,function(t){this.add(t)&&e++},this),e},exists:function(t){return this.__data.exists(t)},remove:function(t){if(!this.exists(t))return null;this.trigger("remove",t),this.trigger("update");var e=this.__data.remove(t);return"off"in t&&t.off(null,null,this),e},getByIndex:function(t){return this.__data.get(t)},getById:function(t){return this.__data.get(this.__data.ident_by_id(t))},getIndex:function(t){return this.__data.get_ident(t)},iterate:function(t,e){this.__data.iterate(t,e)},iterator:function(){return BetaJS.Iterators.ArrayIterator.byIterate(this.iterate,this)},clear:function(){this.iterate(function(t){this.remove(t)},this)}}]),BetaJS.Class.extend("BetaJS.Collections.CollectionData",{constructor:function(t){this._inherited(BetaJS.Collections.CollectionData,"constructor"),this.__collection=t,this.__properties_data={},this.data={},this.__collection.iterate(this.__insert,this),this.__collection.on("add",this.__insert,this),this.__collection.on("remove",this.__remove,this),this.__collection.on("destroy",function(){this.destroy()},this)},collection:function(){return this.__collection},__insert:function(t){var e=BetaJS.Ids.objectId(t);this.__properties_data[e]=new BetaJS.Properties.PropertiesData(t),this.data[e]=this.__properties_data[e].data},__remove:function(t){var e=BetaJS.Ids.objectId(t);this.__properties_data[e].destroy(),delete this.__properties_data[e],delete this.data[e]}}),BetaJS.Collections.Collection.extend("BetaJS.Collections.FilteredCollection",{constructor:function(t,e){this.__parent=t,e=e||{},delete e.objects,e.compare=e.compare||t.get_compare(),this._inherited(BetaJS.Collections.FilteredCollection,"constructor",e),"filter"in e&&(this.filter=e.filter),this.__parent.iterate(function(t){return this.add(t),!0},this),this.__parent.on("add",this.add,this),this.__parent.on("remove",this.remove,this)},filter:function(){return!0},_object_changed:function(t,e,s){this._inherited(BetaJS.Collections.FilteredCollection,"_object_changed",t,e,s),this.filter(t)||this.__selfRemove(t)},destroy:function(){this.__parent.off(null,null,this),this._inherited(BetaJS.Collections.FilteredCollection,"destroy")},__selfAdd:function(t){return this._inherited(BetaJS.Collections.FilteredCollection,"add",t)},add:function(t){if(this.exists(t)||!this.filter(t))return null;var e=this.__selfAdd(t);return this.__parent.add(t),e},__selfRemove:function(t){return this._inherited(BetaJS.Collections.FilteredCollection,"remove",t)},remove:function(t){if(!this.exists(t))return null;var e=this.__selfRemove(t);return e?this.__parent.remove(t):null}}),BetaJS.Comparators={byObject:function(t){return function(e,s){for(key in t){var i=0;if(i=BetaJS.Properties.Properties.is_class_instance(e)&&BetaJS.Properties.Properties.is_class_instance(s)?BetaJS.Comparators.byValue(e.get(key)||null,s.get(key)||null):BetaJS.Comparators.byValue(e[key]||null,s[key]||null),0!==i)return i*t[key]}return 0}},byValue:function(t,e){return BetaJS.Types.is_string(t)?t.localeCompare(e):e>t?-1:t>e?1:0}},BetaJS.Sort={sort_object:function(t,e){var s=[];for(var i in t)s.push({key:i,value:t[i]});s.sort(function(t,s){return e(t.key,s.key,t.value,s.value)});for(var n={},r=0;s.length>r;++r)n[s[r].key]=s[r].value;return n},deep_sort:function(t,e){if(e=e||BetaJS.Comparators.byValue,BetaJS.Types.is_array(t)){for(var s=0;t.length>s;++s)t[s]=this.deep_sort(t[s],e);return t.sort(e)}if(BetaJS.Types.is_object(t)){for(var i in t)t[i]=this.deep_sort(t[i],e);return this.sort_object(t,e)}return e},dependency_sort:function(t,e,s,i){var n=BetaJS.Types.is_string(e)?function(t){return t[e]}:e,r=BetaJS.Types.is_string(s)?function(t){return t[s]}:s,a=BetaJS.Types.is_string(i)?function(t){return t[i]}:i,o=t.length,_=[],c={},h={},u=null;for(u=0;o>u;++u){h[u]=!0;var l=n(t[u],u);c[l]=u,_.push({before:{},after:{}})}for(u=0;o>u;++u)BetaJS.Objs.iter(r(t[u],u)||[],function(t){var e=c[t];BetaJS.Types.is_defined(e)&&(_[u].before[e]=!0,_[e].after[u]=!0)}),BetaJS.Objs.iter(a(t[u])||[],function(t){var e=c[t];BetaJS.Types.is_defined(e)&&(_[u].after[e]=!0,_[e].before[u]=!0)});for(var f=[];!BetaJS.Types.is_empty(h);)for(u in h)if(BetaJS.Types.is_empty(_[u].after)){delete h[u],f.push(t[u]);for(bef in _[u].before)delete _[bef].after[u]}return f}},BetaJS.Locales={__data:{},language:null,get:function(t){return this.language&&this.language+"."+t in this.__data?this.__data[this.language+"."+t]:t in this.__data?this.__data[t]:t},register:function(t,e){e=e?e+".":"";for(var s in t)this.__data[e+s]=t[s]},view:function(t){return{context:this,base:t,get:function(t){return this.context.get(this.base+"."+t)},base:function(t){return this.context.base(this.base+"."+t)}}}},BetaJS.Time={format_time:function(t,e){var s=this.seconds(t),i=this.minutes(t),n=this.hours(t),r={hh:10>n?"0"+n:n,h:n,mm:10>i?"0"+i:i,m:i,ss:10>s?"0"+s:s,s:s};for(var a in r)e=e.replace(a,r[a]);return e},make:function(t){var e=0,s={hours:60,minutes:60,seconds:60,milliseconds:1e3};for(var i in s)e*=s[i],i in t&&(e+=t[i]);return e},seconds:function(t){return Math.floor(t/1e3)%60},minutes:function(t){return Math.floor(t/60/1e3)%60},hours:function(t){return Math.floor(t/60/60/1e3)%24},days:function(t){return Math.floor(t/24/60/60/1e3)},now:function(){var t=new Date;return t.getTime()},ago:function(t){return this.now()-t},days_ago:function(t){return this.days(this.ago(t))},format_ago:function(t){return this.days_ago(t)>1?this.format(t,{time:!1}):this.format_period(Math.max(this.ago(t),0))+" ago"},format_period:function(t){return t=Math.round(t/1e3),60>t?t+" "+BetaJS.Locales.get(1==t?"second":"seconds"):(t=Math.round(t/60),60>t?t+" "+BetaJS.Locales.get(1==t?"minute":"minutes"):(t=Math.round(t/60),24>t?t+" "+BetaJS.Locales.get(1==t?"hour":"hours"):(t=Math.round(t/24),t+" "+BetaJS.Locales.get(1==t?"day":"days"))))},format:function(t,e){e=BetaJS.Objs.extend({time:!0,date:!0,locale:!0},e||{});var s=new Date(t);return e.locale?e.date?e.time?s.toLocaleString():s.toLocaleDateString():s.toLocaleTimeString():e.date?e.time?""+s:s.toDateString():s.toTimeString()}},BetaJS.Class.extend("BetaJS.Timers.Timer",{constructor:function(t){this._inherited(BetaJS.Timers.Timer,"constructor"),t=BetaJS.Objs.extend({once:!1,start:!0,fire:null,context:this,destroy_on_fire:!1},t),this.__delay=t.delay,this.__destroy_on_fire=t.destroy_on_fire,this.__once=t.once,this.__fire=t.fire,this.__context=t.context,this.__started=!1,t.start&&this.start()},destroy:function(){this.stop(),this._inherited(BetaJS.Timers.Timer,"destroy")},fire:function(){this.__once&&(this.__started=!1),this.__fire&&this.__fire.apply(this.__context,[this]),this.__destroy_on_fire&&this.destroy()},stop:function(){this.__started&&(this.__once?clearTimeout(this.__timer):clearInterval(this.__timer),this.__started=!1)},start:function(){if(!this.__started){var t=this;this.__timer=this.__once?setTimeout(function(){t.fire()},this.__delay):setInterval(function(){t.fire()},this.__delay),this.__started=!0}},restart:function(){this.stop(),this.start()}}),BetaJS.Templates={tokenize:function(t){if(BetaJS.Types.is_array(t))return t;var e=[],s=0;return t.replace(BetaJS.Templates.SYNTAX_REGEX(),function(i,n,r,a,o){return o>s&&e.push({type:BetaJS.Templates.TOKEN_STRING,data:BetaJS.Strings.js_escape(t.slice(s,o))}),a&&e.push({type:BetaJS.Templates.TOKEN_CODE,data:a}),n&&e.push({type:BetaJS.Templates.TOKEN_EXPR,data:n}),r&&e.push({type:BetaJS.Templates.TOKEN_ESC,data:r}),s=o+i.length,i}),e},compile:function(t,e){BetaJS.Types.is_string(t)&&(t=this.tokenize(t)),e=e||{};for(var s=e.start_index||0,i=e.end_index||t.length,n="__p+='",r=s;i>r;++r)switch(t[r].type){case BetaJS.Templates.TOKEN_STRING:n+=t[r].data;break;case BetaJS.Templates.TOKEN_CODE:n+="';\n"+t[r].data+"\n__p+='";break;case BetaJS.Templates.TOKEN_EXPR:n+="'+\n((__t=("+t[r].data+"))==null?'':__t)+\n'";break;case BetaJS.Templates.TOKEN_ESC:n+="'+\n((__t=("+t[r].data+"))==null?'':BetaJS.Strings.htmlentities(__t))+\n'";break;default:}n+="';\n",n="with(obj||{}){\n"+n+"}\n",n="var __t,__p='',__j=Array.prototype.join,echo=function(){__p+=__j.call(arguments,'');};\n"+n+"return __p;\n";var a=Function("obj",n),o=function(t){return a.call(this,t)};return o.source="function(obj){\n"+n+"}",o}},BetaJS.Templates.SYNTAX={OPEN:"{%",CLOSE:"%}",MODIFIER_CODE:"",MODIFIER_EXPR:"=",MODIFIER_ESC:"-"},BetaJS.Templates.SYNTAX_REGEX=function(){var t=BetaJS.Templates.SYNTAX;return BetaJS.Templates.SYNTAX_REGEX_CACHED||(BetaJS.Templates.SYNTAX_REGEX_CACHED=RegExp(t.OPEN+t.MODIFIER_EXPR+"([\\s\\S]+?)"+t.CLOSE+"|"+t.OPEN+t.MODIFIER_ESC+"([\\s\\S]+?)"+t.CLOSE+"|"+t.OPEN+t.MODIFIER_CODE+"([\\s\\S]+?)"+t.CLOSE+"|"+"$","g")),BetaJS.Templates.SYNTAX_REGEX_CACHED},BetaJS.Templates.TOKEN_STRING=1,BetaJS.Templates.TOKEN_CODE=2,BetaJS.Templates.TOKEN_EXPR=3,BetaJS.Templates.TOKEN_ESC=4,BetaJS.Class.extend("BetaJS.Templates.Template",{constructor:function(t){this._inherited(BetaJS.Templates.Template,"constructor"),this.__tokens=BetaJS.Templates.tokenize(t),this.__compiled=BetaJS.Templates.compile(this.__tokens)},evaluate:function(t){return this.__compiled.apply(this,[t])}},{bySelector:function(t){return new this(BetaJS.$(t).html())}}),BetaJS.Class.extend("BetaJS.States.Host",[BetaJS.Events.EventsMixin,{initialize:function(t,e){var s=BetaJS.Scopes.resolve(t),i=new s(this,e,{});i.start()},finalize:function(){this._state&&this._state.destroy(),this._state=null},destroy:function(){this.finalize(),this._inherited(BetaJS.States.Host,"destroy")},state:function(){return this._state},_start:function(t){this._stateEvent(t,"before_start"),this._state=t},_afterStart:function(t){this._stateEvent(t,"start")},_end:function(t){this._stateEvent(t,"end"),this._state=null},_afterEnd:function(t){this._stateEvent(t,"after_end")},_next:function(t){this._stateEvent(t,"next")},_afterNext:function(t){this._stateEvent(t,"after_next")},_can_transition_to:function(){return!0},_stateEvent:function(t,e){this.trigger("event",e,t.state_name(),t.description()),this.trigger(e,t.state_name(),t.description()),this.trigger(e+":"+t.state_name(),t.description())}}]),BetaJS.Class.extend("BetaJS.States.State",{_locals:[],_persistents:[],_white_list:null,constructor:function(t,e,s){this._inherited(BetaJS.States.State,"constructor"),this.host=t,this.transitionals=s,this._starting=!1,this._started=!1,this._stopped=!1,this.__next_state=null,this.__suspended=0,e=e||{},this._locals=BetaJS.Types.is_function(this._locals)?this._locals():this._locals;for(var i=0;this._locals.length>i;++i)this["_"+this._locals[i]]=e[this._locals[i]];for(this._persistents=BetaJS.Types.is_function(this._persistents)?this._persistents():this._persistents,i=0;this._persistents.length>i;++i)this["_"+this._persistents[i]]=e[this._persistents[i]]},state_name:function(){return BetaJS.Strings.last_after(this.cls.classname,".")},description:function(){return this.state_name()},start:function(){this._starting||(this._starting=!0,this.host._start(this),this._start(),this.host&&(this.host._afterStart(this),this._started=!0))},end:function(){this._stopped||(this._stopped=!0,this._end(),this.host._end(this),this.host._afterEnd(this),this.destroy())},next:function(t,e,s){if(this._starting&&!this._stopped&&!this.__next_state){var i=this.cls.classname,n=BetaJS.Scopes.resolve(i.substring(0,i.lastIndexOf("."))),r=n[t];e=e||{};for(var a=0;this._persistents.length>a;++a)this._persistents[a]in e||(e[this._persistents[a]]=this["_"+this._persistents[a]]);var o=new r(this.host,e,s);if(!this.can_transition_to(o))return o.destroy(),void 0;this._started||(this.host._afterStart(this),this._started=!0),this.__next_state=o,0>=this.__suspended&&this.__next()}},__next:function(){var t=this.host,e=this.__next_state;t._next(e),this.end(),e.start(),t._afterNext(e)},suspend:function(){this.__suspended++},resume:function(){this.__suspended--,0===this.__suspended&&!this._stopped&&this.__next_state&&this.__next()},can_transition_to:function(t){return this.host&&this.host._can_transition_to(t)&&this._can_transition_to(t)},_start:function(){},_end:function(){},_can_transition_to:function(t){return!BetaJS.Types.is_array(this._white_list)||BetaJS.Objs.contains_value(this._white_list,t.state_name())}}),BetaJS.Class.extend("BetaJS.States.CompetingComposite",{_register_host:function(t){this._hosts=this._hosts||[],this._hosts.push(this._auto_destroy(t))},other_hosts:function(t){return BetaJS.Objs.filter(this._hosts||[],function(e){return e!=t},this)},_next:function(t,e){for(var s=this.other_hosts(t),i=0;s.length>i;++i){var n=s[i],r=n.state();r.can_coexist_with(e)||r.retreat_against(e)}}}),BetaJS.States.Host.extend("BetaJS.States.CompetingHost",{constructor:function(t){this._inherited(BetaJS.States.CompetingHost,"constructor"),this._composite=t,t&&t._register_host(this)},composite:function(){return this._composite},_can_transition_to:function(t){if(!this._composite)return!0;for(var e=this._composite.other_hosts(this),s=0;e.length>s;++s){var i=e[s],n=i.state();if(!t.can_coexist_with(n)&&!t.can_prevail_against(n))return!1}return!0},_next:function(t){this._composite&&this._composite._next(this,t),this._inherited(BetaJS.States.CompetingHost,"_next",t)}}),BetaJS.States.State.extend("BetaJS.States.CompetingState",{can_coexist_with:function(){return!0},can_prevail_against:function(){return!1},retreat_against:function(){}}),BetaJS.Class.extend("BetaJS.Channels.Sender",[BetaJS.Events.EventsMixin,{send:function(t,e){this.trigger("send",t,e),this._send(t,e)},_send:function(){}}]),BetaJS.Class.extend("BetaJS.Channels.Receiver",[BetaJS.Events.EventsMixin,{_receive:function(t,e){this.trigger("receive",t,e),this.trigger("receive:"+t,e)}}]),BetaJS.Channels.Sender.extend("BetaJS.Channels.ReveiverSender",{constructor:function(t){this._inherited(BetaJS.Channels.ReveiverSender,"constructor"),this.__receiver=t},_send:function(t,e){this.__receiver._receive(t,e)}}),BetaJS.Channels.Sender.extend("BetaJS.Channels.SenderMultiplexer",{constructor:function(t,e){this._inherited(BetaJS.Channels.SenderMultiplexer,"constructor"),this.__sender=t,this.__prefix=e},_send:function(t,e){this.__sender.send(this.__prefix+":"+t,e)}}),BetaJS.Channels.Receiver.extend("BetaJS.Channels.ReceiverMultiplexer",{constructor:function(t,e){this._inherited(BetaJS.Channels.ReceiverMultiplexer,"constructor"),this.__receiver=t,this.__prefix=e,this.__receiver.on("receive",function(t,e){BetaJS.Strings.starts_with(t,this.__prefix+":")&&this._receive(BetaJS.Strings.strip_start(t,this.__prefix+":"),e)},this)}}),BetaJS.Class.extend("BetaJS.Channels.TransportChannel",{constructor:function(t,e,s){this._inherited(BetaJS.Channels.TransportChannel,"constructor"),this.__sender=t,this.__receiver=e,this.__options=BetaJS.Objs.extend(s,{timeout:1e4,tries:1,timer:500}),this.__receiver.on("receive:send",function(t){this.__reply(t)},this),this.__receiver.on("receive:reply",function(t){this.__complete(t)},this),this.__sent_id=0,this.__sent={},this.__received={},this.__timer=this._auto_destroy(new BetaJS.Timers.Timer({delay:this.__options.timer,context:this,fire:this.__maintenance}))},_reply:function(){},send:function(t,e,s,i){i=i||{},i.stateless?this.__sender.send("send",{message:t,data:e,stateless:!0}):(this.__sent_id++,this.__sent[this.__sent_id]={message:t,data:e,tries:1,time:BetaJS.Time.now(),id:this.__sent_id,callbacks:s},this.__sender.send("send",{message:t,data:e,id:this.__sent_id}))},__reply:function(t){return t.stateless?(this._reply(t.message,t.data),void 0):(this.__received[t.id]?this.__received[t.id].returned&&this.__sender.send("reply",{id:t.id,reply:t.reply,success:t.success}):(this.__received[t.id]=t,this.__received[t.id].time=BetaJS.Time.now(),this.__received[t.id].returned=!1,this.__received[t.id].success=!1,this._reply(t.message,t.data,{context:this,success:function(e){this.__received[t.id].reply=e,this.__received[t.id].success=!0},complete:function(){this.__received[t.id].returned=!0,this.__sender.send("reply",{id:t.id,reply:t.reply,success:t.success})}})),void 0)},__complete:function(t){this.__sent[t.id]&&(BetaJS.SyncAsync.callback(this.__sent[t.id].callbacks,"success",t.reply),delete this.__sent[t.id])},__maintenance:function(){var t=BetaJS.Time.now();for(var e in this.__received){var s=this.__received[e];t>=s.time+this.__options.tries*this.__options.timeout&&delete this.__received[e]}for(var i in this.__sent){var n=this.__sent[i];t>=n.time+n.tries*this.__options.timeout&&(n.tries<this.__options.tries?(n.tries++,this.__sender.send("send",{message:n.message,data:n.data,id:n.id})):(BetaJS.SyncAsync.callback(n.callbacks,"failure",{message:n.message,data:n.data}),delete this.__sent[i]))}}}),BetaJS.Class.extend("BetaJS.RMI.Stub",[BetaJS.Classes.InvokerMixin,BetaJS.Events.EventsMixin,{intf:[],constructor:function(){this._inherited(BetaJS.RMI.Stub,"constructor"),this.invoke_delegate("invoke",this.intf)},destroy:function(){this.invoke("_destroy"),this.trigger("destroy"),this._inherited(BetaJS.RMI.Stub,"destroy")},_new_promise:function(){return{context:this,success:function(t){return this.__success=t,this.is_complete&&this.is_success&&this.__success.call(this.context,this.result),this},failure:function(t){return this.__failure=t,this.is_complete&&this.is_failure&&this.__failure.call(this.context),this},callbacks:function(t){return t=t.callbacks?t.callbacks:t,this.context=t.context||this,t.success&&this.success(t.success),t.failure&&this.failure(t.failure),t.exception&&this.failure(t.exception),this}}},_promise_success:function(t,e){t.result=e,t.is_complete=!0,t.is_success=!0,t.__success&&t.__success.call(t.context,e)},_promise_failure:function(t){t.is_complete=!0,t.is_failure=!0,t.__failure&&t.__failure.call(t.context)},invoke:function(t){var e=this._new_promise();return this.trigger("send",t,BetaJS.Functions.getArguments(arguments,1),{context:this,success:function(t){return this._promise_success(e,t)},failure:function(){return this._promise_failure(e)}}),e}}]),BetaJS.Class.extend("BetaJS.RMI.StubSyncer",[BetaJS.Classes.InvokerMixin,{constructor:function(t){this._inherited(BetaJS.RMI.StubSyncer,"constructor"),this.__stub=t,this.__current=null,this.__queue=[],this.invoke_delegate("invoke",this.__stub.intf)},invoke:function(){var t={args:BetaJS.Functions.getArguments(arguments),promise:this.__stub._new_promise()};return this.__queue.push(t),this.__current||this.__next(),t.promise},__next:function(){0!==this.__queue.length&&(this.__current=this.__queue.shift(),this.__stub.invoke.apply(this.__stub,this.__current.args).callbacks({context:this,success:function(t){this.__stub._promise_success(this.__current.promise,t),this.__next()},failure:function(){this.__stub._promise_failure(this.__current.promise),this.__next()}}))}}]),BetaJS.Class.extend("BetaJS.RMI.Skeleton",[BetaJS.Events.EventsMixin,{_stub:null,intf:[],intfSync:[],_intf:{},_intfSync:{},__superIntf:[],__superIntfSync:["_destroy"],constructor:function(t){this._options=BetaJS.Objs.extend({destroyable:!1},t),this._inherited(BetaJS.RMI.Skeleton,"constructor"),this.intf=this.intf.concat(this.__superIntf),this.intfSync=this.intfSync.concat(this.__superIntfSync);for(var e=0;this.intf.length>e;++e)this._intf[this.intf[e]]=!0;for(e=0;this.intfSync.length>e;++e)this._intfSync[this.intfSync[e]]=!0},_destroy:function(){this._options.destroyable&&this.destroy()},destroy:function(){this.trigger("destroy"),this._inherited(BetaJS.RMI.Skeleton,"destroy")},invoke:function(t,e,s,i){if(!this._intf[t]&&!this._intfSync[t])return this._failure(s),void 0;var n={callbacks:s,caller:i};if(this._intf[t])e.unshift(n),this[t].apply(this,e);else try{this._success(n,this[t].apply(this,e))}catch(r){this._failure(n,r)}},_success:function(t,e){t=t.callbacks?t.callbacks:t,BetaJS.SyncAsync.callback(t,"success",e)},_failure:function(t){t=t.callbacks?t.callbacks:t,BetaJS.SyncAsync.callback(t,"failure")},stub:function(){if(this._stub)return this._stub;var t=this.cls.classname;return t.indexOf("Skeleton")>=0?t.replace("Skeleton","Stub"):t}}]),BetaJS.Class.extend("BetaJS.RMI.Server",[BetaJS.Events.EventsMixin,{constructor:function(t,e){if(this._inherited(BetaJS.RMI.Server,"constructor"),this.__channels=new BetaJS.Lists.ObjectIdList,this.__instances={},t){var s=t;
e&&(s=this._auto_destroy(new BetaJS.Channels.TransportChannel(t,e))),this.registerClient(s)}},destroy:function(){this.__channels.iterate(this.unregisterClient,this),BetaJS.Objs.iter(this.__instances,function(t){this.unregisterInstance(t.instance)},this),this.__channels.destroy(),this._inherited(BetaJS.RMI.Server,"destroy")},registerInstance:function(t,e){return e=e||{},this.__instances[BetaJS.Ids.objectId(t,e.name)]={instance:t,options:e},t},unregisterInstance:function(t){delete this.__instances[BetaJS.Ids.objectId(t)],t.destroy()},registerClient:function(t){var e=this;this.__channels.add(t),t._reply=function(s,i,n){var r=s.split(":");2==r.length?e._invoke(t,r[0],r[1],i,n):BetaJS.SyncAsync.callback(n,"failure")}},unregisterClient:function(t){this.__channels.remove(t),t._reply=null},_invoke:function(t,e,s,i,n){var r=this.__instances[e];if(r||(this.trigger("loadInstance",t,e),r=this.__instances[e]),!r)return BetaJS.SyncAsync.callback(n,"failure"),void 0;r=r.instance;var a=this;r.invoke(s,i,BetaJS.SyncAsync.mapSuccess(n,function(t){BetaJS.RMI.Skeleton.is_class_instance(t)&&t.instance_of(BetaJS.RMI.Skeleton)?(a.registerInstance(t),BetaJS.SyncAsync.callback(n,"success",{__rmi_meta:!0,__rmi_stub:t.stub(),__rmi_stub_id:BetaJS.Ids.objectId(t)})):BetaJS.SyncAsync.callback(n,"success",t)}),t)}}]),BetaJS.Class.extend("BetaJS.RMI.Client",{constructor:function(t,e){if(this._inherited(BetaJS.RMI.Client,"constructor"),this.__channel=null,this.__instances={},t){var s=t;e&&(s=this._auto_destroy(new BetaJS.Channels.TransportChannel(t,e))),this.__channel=s}},destroy:function(){this.__channel&&this.disconnect(),this._inherited(BetaJS.RMI.Client,"destroy")},connect:function(t){this.__channel||(this.__channel=t)},disconnect:function(){this.__channel&&(this.__channel=null,BetaJS.Objs.iter(this.__instances,function(t){this.release(t)},this))},acquire:function(t,e){if(this.__instances[e])return this.__instances[e];if(BetaJS.Types.is_string(t)&&(t=BetaJS.Scopes.resolve(t)),!t||!t.ancestor_of(BetaJS.RMI.Stub))return null;var s=new t;this.__instances[BetaJS.Ids.objectId(s,e)]=s;var i=this;return s.on("send",function(t,s,n){this.__channel.send(e+":"+t,s,BetaJS.SyncAsync.mapSuccess(n,function(t){BetaJS.Types.is_object(t)&&t.__rmi_meta?BetaJS.SyncAsync.callback(n,"success",i.acquire(t.__rmi_stub,t.__rmi_stub_id)):BetaJS.SyncAsync.callback(n,"success",t)}))},this),s},release:function(t){var e=BetaJS.Ids.objectId(t);this.__instances[e]&&(t.off(null,null,this),t.destroy(),delete this.__instances[e])}}),BetaJS.Class.extend("BetaJS.RMI.Peer",{constructor:function(t,e){this._inherited(BetaJS.RMI.Peer,"constructor"),this.__sender=t,this.__receiver=e,this.__client_sender=this._auto_destroy(new BetaJS.Channels.SenderMultiplexer(t,"client")),this.__server_sender=this._auto_destroy(new BetaJS.Channels.SenderMultiplexer(t,"server")),this.__client_receiver=this._auto_destroy(new BetaJS.Channels.ReceiverMultiplexer(e,"server")),this.__server_receiver=this._auto_destroy(new BetaJS.Channels.ReceiverMultiplexer(e,"client")),this.client=this._auto_destroy(new BetaJS.RMI.Client(this.__client_sender,this.__client_receiver)),this.server=this._auto_destroy(new BetaJS.RMI.Server(this.__server_sender,this.__server_receiver))},acquire:function(t,e){return this.client.acquire(t,e)},release:function(t){this.client.release(t)},registerInstance:function(t,e){return this.server.registerInstance(t,e)},unregisterInstance:function(t){this.server.unregisterInstance(t)}}),BetaJS.Structures={},BetaJS.Structures.AvlTree={empty:function(){return null},singleton:function(t){return{data:t,left:null,right:null,height:1}},min:function(t){return t.left?this.min(t.left):t.data},max:function(t){return t.right?this.max(t.right):t.data},height:function(t){return t?t.height:0},height_join:function(t,e){return 1+Math.max(this.height(t),this.height(e))},create:function(t,e,s){return{data:t,left:e,right:s,height:this.height_join(e,s)}},balance:function(t,e,s){return this.height(e)>this.height(s)+2?this.height(e.left)>=this.height(e.right)?this.create(e.data,e.left,this.create(t,e.right,s)):this.create(e.right.data,this.create(e.data,e.left,e.right.left),this.create(t,e.right.right,s)):this.height(s)>this.height(e)+2?this.height(s.right)>=this.height(s.left)?this.create(s.data,this.create(t,e,s.left),s.right):this.create(s.left.data,this.create(t,e,s.left.left),this.create(s.data,s.left.right,s.right)):this.create(t,e,s)},__add_left:function(t,e){return e?this.balance(e.data,this.__add_left(t,e.left),e.right):this.singleton(t)},__add_right:function(t,e){return e?this.balance(e.data,e.data,this.__add_right(t,e.right)):this.singleton(t)},join:function(t,e,s){return e?s?this.height(e)>this.height(s)+2?this.balance(e.data,e.left,this.join(t,e.right,s)):this.height(s)>this.height(e)+2?this.balance(s.data,this.join(t,e,s.left),s.right):this.create(t,e,s):this.__add_right(t,e):this.__add_left(t,s)},take_min:function(t){if(!t.left)return[t.data,t.right];var e=this.take_min(t.left);return[e[0],this.join(t.data,e[1],t.right)]},take_max:function(t){if(!t.right)return[t.data,t.left];var e=this.take_max(t.right);return[e[0],this.join(t.data,t.left,e[1])]},rereoot:function(t,e){if(!t||!e)return t||e;if(this.height(t)>this.height(e)){var s=this.take_max(t);return this.join(s[0],s[1],e)}var i=this.take_min(e);return this.join(i[0],t,i[1])},take_min_iter:function(t){return t?t.left?this.take_min_iter(this.create(t.left.data,t.left.left,this.create(t.data,t.left.right,t.right))):[t.data,t.left]:null},take_max_iter:function(t){return t?t.right?this.take_max_iter(this.create(t.right.data,this.create(t.data,t.left,t.right.left),t.right.right)):[t.data,t.right]:null}},BetaJS.Structures.TreeMap={empty:function(t){return{root:null,length:0,compare:t||function(t,e){return t>e?1:e>t?-1:0}}},is_empty:function(t){return!t.root},length:function(t){return t.length},__add:function(t,e,s,i){var n={key:t,value:e};if(!i)return s.length++,BetaJS.Data.AvlTree.singleton(n);var r=s.compare(t,i.data.key);return 0===r?(i.data=n,i):0>r?BetaJS.Data.AvlTree.balance(i.data,this.__add(t,e,s,i.left),i.right):BetaJS.Data.AvlTree.balance(i.data,i.left,this.__add(t,e,s,i.right))},add:function(t,e,s){return s.root=this.__add(t,e,s,s.root),s},singleton:function(t,e,s){return this.add(t,e,this.empty(s))},__find:function(t,e,s){if(!s)return null;var i=e.compare(t,s.data.key);return 0===i?s.data.value:this.__find(t,e,0>i?s.left:s.right)},find:function(t,e){return this.__find(t,e,e.root)},__iterate:function(t,e,s,i){return e?this.__iterate(t,e.left,s,i)&&s.call(i,e.data.key,e.data.value)!==!1&&this.__iterate(t,e.right,s,i):!0},iterate:function(t,e,s){this.__iterate(t,t.root,e,s)},__iterate_from:function(t,e,s,i,n){if(!s)return!0;var r=e.compare(t,s.data.key);return 0>r&&!this.__iterate_from(t,e,s.left,i,n)?!1:0>=r&&i.call(n,s.data.key,s.data.value)===!1?!1:this.__iterate_from(t,e,s.right,i,n)},iterate_from:function(t,e,s,i){this.__iterate_from(t,e,e.root,s,i)},iterate_range:function(t,e,s,i,n){this.iterate_from(t,s,function(t,r){return 0>=s.compare(t,e)&&i.call(n,t,r)!==!1},this)}},BetaJS.Class.extend("BetaJS.Net.AbstractAjax",{constructor:function(t){this._inherited(BetaJS.Net.AbstractAjax,"constructor"),this.__options=BetaJS.Objs.extend({method:"GET",data:{}},t)},syncCall:function(t){try{return this._syncCall(BetaJS.Objs.extend(BetaJS.Objs.clone(this.__options,1),t))}catch(e){throw e=BetaJS.Exceptions.ensure(e),e.assert(BetaJS.Net.AjaxException),e}},asyncCall:function(t,e){this._asyncCall(BetaJS.Objs.extend(BetaJS.Objs.clone(this.__options,1),t),e)},call:function(t,e){return e?this.asyncCall(t,e):this.syncCall(t)},_syncCall:function(){},_asyncCall:function(){}}),BetaJS.Exceptions.Exception.extend("BetaJS.Net.AjaxException",{constructor:function(t,e,s){this._inherited(BetaJS.Net.AjaxException,"constructor",t+": "+e),this.__status_code=t,this.__status_text=e,this.__data=s},status_code:function(){return this.__status_code},status_text:function(){return this.__status_text},data:function(){return this.__data},json:function(){var t=this._inherited(BetaJS.Net.AjaxException,"json");return t.data=this.data(),t}}),BetaJS.Channels.Sender.extend("BetaJS.Net.SocketSenderChannel",{constructor:function(t,e,s){this._inherited(BetaJS.Net.SocketSenderChannel,"constructor"),this.__socket=t,this.__message=e,this.__ready=BetaJS.Types.is_defined(s)?s:!0,this.__cache=[]},_send:function(t,e){this.__ready?this.__socket.emit(this.__message,{message:t,data:e}):this.__cache.push({message:t,data:e})},ready:function(){this.__ready=!0;for(var t=0;this.__cache.length>t;++t)this._send(this.__cache[t].message,this.__cache[t].data);this.__cache=[]},unready:function(){this.__ready=!1},socket:function(){return arguments.length>0&&(this.__socket=arguments[0]),this.__socket}}),BetaJS.Channels.Receiver.extend("BetaJS.Net.SocketReceiverChannel",{constructor:function(t,e){this._inherited(BetaJS.Net.SocketReceiverChannel,"constructor"),this.__message=e,this.socket(t)},socket:function(){if(arguments.length>0&&(this.__socket=arguments[0],this.__socket)){var t=this;this.__socket.on(this.__message,function(e){t._receive(e.message,e.data)})}return this.__socket}}),BetaJS.Net=BetaJS.Net||{},BetaJS.Net.HttpHeader={HTTP_STATUS_OK:200,HTTP_STATUS_CREATED:201,HTTP_STATUS_PAYMENT_REQUIRED:402,HTTP_STATUS_FORBIDDEN:403,HTTP_STATUS_NOT_FOUND:404,HTTP_STATUS_PRECONDITION_FAILED:412,HTTP_STATUS_INTERNAL_SERVER_ERROR:500,format:function(t,e){var s="";return s=t==this.HTTP_STATUS_OK?"OK":t==this.HTTP_STATUS_CREATED?"Created":t==this.HTTP_STATUS_PAYMENT_REQUIRED?"Payment Required":t==this.HTTP_STATUS_FORBIDDEN?"Forbidden":t==this.HTTP_STATUS_NOT_FOUND?"Not found":t==this.HTTP_STATUS_PRECONDITION_FAILED?"Precondition Failed":t==this.HTTP_STATUS_INTERNAL_SERVER_ERROR?"Internal Server Error":"Other Error",e?t+" "+s:s}},BetaJS.Net=BetaJS.Net||{},BetaJS.Net.Uri={build:function(t){var e="";return t.username&&(e+=t.username+":"),t.password&&(e+=t.password+"@"),e+=t.server,t.port&&(e+=":"+t.port),t.path&&(e+="/"+t.path),e},encodeUriParams:function(t,e){e=e||"";var s=[];return BetaJS.Objs.iter(t,function(t,i){BetaJS.Types.is_object(t)?s=s.concat(this.encodeUriParams(t,e+i+"_")):s.push(e+i+"="+encodeURI(t))},this),s.join("&")},appendUriParams:function(t,e,s){return BetaJS.Types.is_empty(e)?t:t+(-1!=t.indexOf("?")?"&":"?")+this.encodeUriParams(e,s)},parse:function(t,e){for(var s=e?this.__parse_strict_regex:this.__parse_loose_regex,i=s.exec(t),n={},r=0;this.__parse_key.length>r;++r)n[this.__parse_key[r]]=i[r]||"";return n.queryKey={},n[this.__parse_key[12]].replace(this.__parse_key_parser,function(t,e,s){e&&(n.queryKey[e]=s)}),n},__parse_strict_regex:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,__parse_loose_regex:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,__parse_key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],__parse_key_parser:/(?:^|&)([^&=]*)=?([^&]*)/g};